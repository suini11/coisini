function a() {
  // TOLOOK
  setInterval(() => {
    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage("ping");
    }
  }, 10000);
  // TOLOOK
  setInterval(() => {
    fetch("/_keep_alive_ping_").catch(() => {});
  }, 25000);
}
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").then(b => {
      console.log("ServiceWorker æ³¨å†ŒæˆåŠŸ");
      a();
      if ("sync" in b) {
        b.sync.register("keep-alive").catch(() => {});
      }
    }).catch(a => {
      console.log("ServiceWorker æ³¨å†Œå¤±è´¥: ", a);
    });
  });
  try {
    const a = new Blob([`
          setInterval(() => {
              postMessage('tick');
          }, 10000);
      `], {
      type: "application/javascript"
    });
    const b = new Worker(URL.createObjectURL(a));
    b.onmessage = () => {
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage("ping");
      }
    };
  } catch (a) {}
}
function b(a) {
  if (!a) {
    return "";
  }
  return a.replace(/[&<>"']/g, function (a) {
    return {
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;"
    }[a];
  });
}
function c(a, b) {
  let c = a;
  let d = b;
  const e = [];
  const f = 0.01;
  for (let g = 0; g < b - 1; g++) {
    const a = c / d;
    const b = c - (d - 1) * f;
    let g = Math.min(a * 2, b);
    if (g < f) {
      g = f;
    }
    let h = Math.random() * (g - f) + f;
    h = parseFloat(h.toFixed(2));
    e.push(h);
    c -= h;
    d--;
  }
  e.push(parseFloat(c.toFixed(2)));
  for (let c = e.length - 1; c > 0; c--) {
    const a = Math.floor(Math.random() * (c + 1));
    [e[c], e[a]] = [e[a], e[c]];
  }
  console.log("[çº¢åŒ…ç”Ÿæˆ]: æ€»é‡‘é¢ " + a + ", æ•°é‡ " + b + ". åˆ†é…ç»“æžœ:", e);
  return e;
}
function d() {
  let a = localStorage.getItem("ephoneDeviceId");
  if (!a) {
    a = ([10000000] + -1000 + -4000 + -8000 + -100000000000).replace(/[018]/g, a => (a ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> a / 4).toString(16));
    localStorage.setItem("ephoneDeviceId", a);
  }
  return a;
}
const e = d();
console.log("EPhone è®¾å¤‡ID: " + e);
let f = localStorage.getItem("ephonePinActivated") === "true";
const g = {
  "zh-CN": {
    save: "ä¿å­˜",
    cancel: "å–æ¶ˆ",
    confirm: "ç¡®å®š",
    edit: "ç¼–è¾‘",
    done: "å®Œæˆ",
    add: "æ·»åŠ ",
    back: "è¿”å›ž",
    next: "ä¸‹ä¸€æ­¥",
    close: "å…³é—­",
    reset: "é‡ç½®",
    upload: "ä¸Šä¼ ",
    send: "å‘é€",
    manage: "ç®¡ç†",
    share: "åˆ†äº«",
    delete: "åˆ é™¤",
    publish: "å‘å¸ƒ",
    refresh: "åˆ·æ–°",
    search: "æœç´¢",
    remove: "ç§»é™¤",
    finish: "ç»“æŸ",
    details: "è¯¦æƒ…",
    settings: "è®¾ç½®",
    title: "æ ‡é¢˜",
    content: "å†…å®¹",
    category: "åˆ†ç±»",
    name: "åç§°",
    description: "æè¿°",
    status: "çŠ¶æ€",
    ok: "å¥½çš„",
    error: "é”™è¯¯",
    success: "æˆåŠŸ",
    warning: "è­¦å‘Š",
    loading: "åŠ è½½ä¸­...",
    processing: "å¤„ç†ä¸­...",
    pleaseWait: "è¯·ç¨å€™...",
    languageChangedAlert: "è¯­è¨€å·²åˆ‡æ¢ï¼Œé¡µé¢å³å°†åˆ·æ–°ä»¥åº”ç”¨æ›´æ”¹ã€‚",
    homeAppQQ: "QQ",
    homeAppWorldBook: "ä¸–ç•Œä¹¦",
    homeAppAppearance: "å¤–è§‚è®¾ç½®",
    homeAppRenderer: "æ¸²æŸ“å™¨",
    homeAppApiSettings: "è®¾ç½®",
    homeAppFont: "å­—ä½“",
    homeAppCPhone: "CPhone",
    homeAppDouban: "è±†ç“£",
    homeAppPreset: "é¢„è®¾",
    homeAppTutorial: "æ•™ç¨‹",
    homeAppWerewolf: "ç‹¼äººæ€",
    homeAppX: "X",
    chatListTitle: "æ¶ˆæ¯",
    navMessages: "æ¶ˆæ¯",
    navQzone: "åŠ¨æ€",
    navMemories: "å›žå¿†",
    navFavorites: "æ”¶è—",
    navNpcList: "NPC",
    qzoneTitle: "å¥½å‹åŠ¨æ€",
    qzoneActionShuoshuo: "è¯´è¯´",
    qzoneActionPost: "åŠ¨æ€",
    qzoneActionAlbum: "ç›¸å†Œ",
    cphoneTitleSelect: "é€‰æ‹©ä¸€éƒ¨æ‰‹æœº",
    cphoneAppQQ: "QQ",
    cphoneAppAlbum: "ç›¸å†Œ",
    cphoneAppBrowser: "æµè§ˆå™¨",
    cphoneAppTaobao: "æ·˜å®",
    cphoneAppMemo: "å¤‡å¿˜å½•",
    cphoneAppDiary: "æ—¥è®°",
    cphoneAppAmap: "é«˜å¾·åœ°å›¾",
    cphoneAppUsage: "Appè®°å½•",
    cphoneAppMusic: "ç½‘æ˜“äº‘",
    cphoneAppEphone: "Ephone",
    cphoneAppFootprints: "è¶³è¿¹",
    cphoneAlbumTitle: "TAçš„ç›¸å†Œ",
    cphoneBrowserTitle: "TAçš„æµè§ˆå™¨åŽ†å²",
    cphoneTaobaoTitle: "TAçš„æ·˜å®è®¢å•",
    cphoneWalletTitle: "é’±åŒ…",
    cphoneMemoTitle: "å¤‡å¿˜å½•",
    cphoneDiaryTitle: "æ—¥è®°",
    cphoneUsageTitle: "Appä½¿ç”¨è®°å½•",
    cphoneMusicTitle: "TAçš„æ­Œå•",
    cphoneArticleTitle: "æ–‡ç« ",
    cphoneSimulatedChatPlaceholder: "è¿™æ˜¯æ¨¡æ‹Ÿå¯¹è¯ï¼Œæ— æ³•å‘é€æ¶ˆæ¯",
    worldBookTitle: "ä¸–ç•Œä¹¦",
    worldBookEditorTitle: "ç¼–è¾‘ä¸–ç•Œä¹¦",
    worldBookEntryEditorTitle: "ç¼–è¾‘æ¡ç›®",
    worldBookNameLabel: "ä¹¦å",
    worldBookCategoryLabel: "åˆ†ç±»",
    worldBookEntriesLabel: "å†…å®¹æ¡ç›®",
    worldBookAddEntryBtn: "[+] æ·»åŠ æ–°æ¡ç›®",
    worldBookNamePlaceholder: "è¯·è¾“å…¥ä¸–ç•Œä¹¦çš„åç§°...",
    worldBookImportTitle: "å¯¼å…¥ä¸–ç•Œä¹¦",
    presetTitle: "é¢„è®¾",
    presetEditorTitle: "ç¼–è¾‘é¢„è®¾",
    presetNameLabel: "é¢„è®¾åç§°",
    presetCategoryLabel: "åˆ†ç±»",
    presetEntriesLabel: "å†…å®¹æ¡ç›®",
    presetAddEntryBtn: "[+] æ·»åŠ æ–°æ¡ç›®",
    tutorialTitle: "æ•™ç¨‹",
    apiSettingsTitle: "API è®¾ç½®",
    languageLabel: "è¯­è¨€",
    apiPresetManagement: "API é¢„è®¾ç®¡ç†",
    apiPresetSelectLabel: "é€‰æ‹©æˆ–åˆ‡æ¢é¢„è®¾",
    apiPrimarySettings: "ä¸»APIè®¾ç½® (ç”¨äºŽèŠå¤©)",
    apiProxyUrlLabel: "åä»£åœ°å€ (ä¸éœ€è¦æ·»åŠ /v1å™¢~)",
    apiKeyLabel: "å¯†é’¥ (API Key)",
    apiModelLabel: "æ¨¡åž‹",
    apiFetchModelsBtn: "æ‹‰å–ä¸»æ¨¡åž‹",
    apiSecondarySettings: "å‰¯APIè®¾ç½® (ç”¨äºŽæ€»ç»“é•¿æœŸè®°å¿†)",
    apiSecondaryProxyUrlLabel: "å‰¯åä»£åœ°å€",
    apiSecondaryKeyLabel: "å‰¯å¯†é’¥",
    apiSecondaryModelLabel: "å‰¯æ¨¡åž‹",
    apiFetchSecondaryModelsBtn: "æ‹‰å–å‰¯æ¨¡åž‹",
    apiBgActivitySettings: "åŽå°æ´»åŠ¨è®¾ç½®",
    apiEnableBgActivityLabel: "å¯ç”¨åŽå°è§’è‰²æ´»åŠ¨",
    apiBgIntervalLabel: "åŽå°æ´»åŠ¨æ£€æµ‹é—´éš” (ç§’)",
    apiBlockCooldownLabel: "AIè¢«æ‹‰é»‘åŽå†·é™æœŸ (å°æ—¶)",
    apiTtsSettings: "è¯­éŸ³æ¶ˆæ¯è®¾ç½® (Minimax TTS)",
    apiTtsModelLabel: "è¯­éŸ³æ¨¡åž‹ (Model)",
    apiPerformanceSettings: "æ€§èƒ½ä¸Žæ˜¾ç¤ºè®¾ç½®",
    apiChatListRenderWindowLabel: "èŠå¤©åˆ—è¡¨æ¯æ¬¡åŠ è½½æ¡æ•°",
    apiChatRenderWindowLabel: "èŠå¤©ç•Œé¢åˆå§‹åŠ è½½æ¡æ•°",
    apiImageGenSettings: "ç”Ÿå›¾åŠŸèƒ½è®¾ç½®",
    apiEnableImageGenLabel: "å¯ç”¨AIç”Ÿå›¾åŠŸèƒ½",
    apiEnableNovelAILabel: "å¯ç”¨ NovelAI å›¾åƒç”Ÿæˆ",
    apiNovelAIModelLabel: "NovelAI æ¨¡åž‹",
    apiNovelAIKeyLabel: "NovelAI API Key",
    apiNovelAIGenSettingsBtn: "ç”Ÿæˆè®¾ç½®",
    apiNovelAITestBtn: "æµ‹è¯•ç”Ÿæˆ",
    apiStorageOptimization: "å­˜å‚¨ç©ºé—´ä¼˜åŒ–",
    apiCompressImagesBtn: "ä¸€é”®åŽ‹ç¼©æœ¬åœ°å›¾ç‰‡",
    apiSaveAllBtn: "ä¿å­˜æ‰€æœ‰è®¾ç½®",
    apiExportDataBtn: "å¯¼å‡ºæ•°æ®",
    apiImportDataBtn: "å¯¼å…¥å¤‡ä»½æ–‡ä»¶",
    apiCleanupDataBtn: "æ¸…ç†å†—ä½™æ•°æ®",
    apiDeleteWorldBooksBtn: "åˆ é™¤ä¸–ç•Œä¹¦",
    apiAdvancedCleanupBtn: "é«˜çº§æ•°æ®æ¸…ç†",
    apiCheckAndFixDataBtn: "æ•°æ®æ£€æŸ¥ä¸Žä¿®å¤",
    chatHeaderOnline: "åœ¨çº¿",
    chatHeaderLongTermMemory: "é•¿æœŸè®°å¿†",
    chatHeaderListenTogether: "ä¸€èµ·å¬",
    chatHeaderChatSettings: "èŠå¤©è®¾ç½®",
    chatSelectionCancel: "å–æ¶ˆ",
    chatSelectionScreenshot: "é•¿æˆªå›¾",
    chatSelectionFavorite: "æ”¶è—",
    chatSelectionShare: "åˆ†äº«",
    chatSelectionSoftDelete: "åˆ é™¤(é€šçŸ¥AI)",
    chatSelectionHardDelete: "å½»åº•åˆ é™¤",
    chatReplyTo: "å›žå¤",
    chatInputPlaceholder: "è¾“å…¥æ¶ˆæ¯...",
    chatWaitForReply: "ç­‰å¾…å›žå¤",
    appearanceTitle: "å¤–è§‚è®¾ç½®",
    appearanceSaveAll: "ä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®",
    fontSettingsTitle: "å­—ä½“è®¾ç½®",
    fontPresetManagement: "å­—ä½“é¢„è®¾ç®¡ç†",
    fontFileUrlLabel: "å­—ä½“æ–‡ä»¶URL (.ttf, .otf, .woffç­‰)",
    fontPreviewLabel: "å®žæ—¶é¢„è§ˆ",
    fontPreviewText1: "ä½ å¥½ä¸–ç•Œ Hello World",
    fontPreviewText2: "è¿™æ˜¯å­—ä½“é¢„è§ˆæ•ˆæžœï¼Œ12345ã€‚",
    fontSaveAndApply: "ä¿å­˜å¹¶åº”ç”¨",
    fontResetDefault: "æ¢å¤é»˜è®¤å­—ä½“",
    rendererTitle: "æ¸²æŸ“è§„åˆ™",
    rendererEditorTitle: "ç¼–è¾‘è§„åˆ™",
    rendererCreateTitle: "åˆ›å»ºæ–°è§„åˆ™",
    rendererRuleName: "è§„åˆ™åç§°",
    rendererBindScope: "ç»‘å®šèŒƒå›´",
    rendererScopeGlobal: "å…¬ç”¨ (æ‰€æœ‰è§’è‰²)",
    rendererRegex: "æ­£åˆ™è¡¨è¾¾å¼ (ä½¿ç”¨gä½œä¸ºæ ‡å¿—)",
    rendererHtmlTemplate: "HTML æ¨¡æ¿ (ç”¨ $1, $2 å¼•ç”¨)",
    rendererEnableRule: "å¯ç”¨è§„åˆ™",
    myAlbumTitle: "æˆ‘çš„ç›¸å†Œ",
    albumPhotosTitle: "ç›¸å†Œåç§°",
    npcEditorTitleAdd: "æ·»åŠ  NPC",
    npcEditorTitleEdit: "ç¼–è¾‘ NPC",
    npcAvatarLabel: "NPC å¤´åƒ",
    npcUploadAvatar: "ä¸Šä¼ å¤´åƒ",
    npcNicknameLabel: "NPC æ˜µç§°",
    npcPersonaLabel: "NPC äººè®¾",
    npcEnableBgActivity: "å¯ç”¨ç‹¬ç«‹åŽå°æ´»åŠ¨",
    npcActionCooldown: "ç‹¬ç«‹è¡ŒåŠ¨å†·å´ (åˆ†é’Ÿ)",
    npcAssociatedChars: "å…³è”çš„è§’è‰² (NPCä¼šåŽ»è¯„è®ºè¿™äº›è§’è‰²çš„åŠ¨æ€)"
  },
  en: {
    save: "Save",
    cancel: "Cancel",
    confirm: "Confirm",
    edit: "Edit",
    done: "Done",
    add: "Add",
    back: "Back",
    next: "Next",
    close: "Close",
    reset: "Reset",
    upload: "Upload",
    send: "Send",
    manage: "Manage",
    share: "Share",
    delete: "Delete",
    publish: "Publish",
    refresh: "Refresh",
    search: "Search",
    remove: "Remove",
    finish: "Finish",
    details: "Details",
    settings: "Settings",
    title: "Title",
    content: "Content",
    category: "Category",
    name: "Name",
    description: "Description",
    status: "Status",
    ok: "OK",
    error: "Error",
    success: "Success",
    warning: "Warning",
    loading: "Loading...",
    processing: "Processing...",
    pleaseWait: "Please wait...",
    languageChangedAlert: "Language switched. The page will reload to apply changes.",
    homeAppQQ: "QQ",
    homeAppWorldBook: "World Book",
    homeAppAppearance: "Appearance",
    homeAppRenderer: "Renderer",
    homeAppApiSettings: "Settings",
    homeAppFont: "Fonts",
    homeAppCPhone: "CPhone",
    homeAppDouban: "Douban",
    homeAppPreset: "Presets",
    homeAppTutorial: "Tutorial",
    homeAppWerewolf: "Werewolf",
    homeAppX: "X",
    chatListTitle: "Messages",
    navMessages: "Messages",
    navQzone: "Moments",
    navMemories: "Memories",
    navFavorites: "Favorites",
    navNpcList: "NPCs",
    qzoneTitle: "Moments",
    qzoneActionShuoshuo: "Status",
    qzoneActionPost: "Post",
    qzoneActionAlbum: "Album",
    cphoneTitleSelect: "Select a Phone",
    cphoneAppQQ: "QQ",
    cphoneAppAlbum: "Album",
    cphoneAppBrowser: "Browser",
    cphoneAppTaobao: "Taobao",
    cphoneAppMemo: "Memo",
    cphoneAppDiary: "Diary",
    cphoneAppAmap: "Amap",
    cphoneAppUsage: "App Usage",
    cphoneAppMusic: "Music",
    cphoneAppEphone: "Ephone",
    cphoneAppFootprints: "Footprints",
    cphoneAlbumTitle: "Their Album",
    cphoneBrowserTitle: "Their Browser History",
    cphoneTaobaoTitle: "Their Taobao Orders",
    cphoneWalletTitle: "Wallet",
    cphoneMemoTitle: "Memo",
    cphoneDiaryTitle: "Diary",
    cphoneUsageTitle: "App Usage Log",
    cphoneMusicTitle: "Their Playlist",
    cphoneArticleTitle: "Article",
    cphoneSimulatedChatPlaceholder: "This is a simulated chat, messages cannot be sent",
    worldBookTitle: "World Book",
    worldBookEditorTitle: "Edit World Book",
    worldBookEntryEditorTitle: "Edit Entry",
    worldBookNameLabel: "Book Name",
    worldBookCategoryLabel: "Category",
    worldBookEntriesLabel: "Content Entries",
    worldBookAddEntryBtn: "[+] Add New Entry",
    worldBookNamePlaceholder: "Enter the name of the world book...",
    worldBookImportTitle: "Import World Book",
    presetTitle: "Presets",
    presetEditorTitle: "Edit Preset",
    presetNameLabel: "Preset Name",
    presetCategoryLabel: "Category",
    presetEntriesLabel: "Content Entries",
    presetAddEntryBtn: "[+] Add New Entry",
    tutorialTitle: "Tutorial",
    apiSettingsTitle: "API Settings",
    languageLabel: "Language",
    apiPresetManagement: "API Preset Management",
    apiPresetSelectLabel: "Select or Switch Preset",
    apiPrimarySettings: "Primary API Settings (for Chat)",
    apiProxyUrlLabel: "Proxy URL (No /v1 needed~)",
    apiKeyLabel: "API Key",
    apiModelLabel: "Model",
    apiFetchModelsBtn: "Fetch Primary Models",
    apiSecondarySettings: "Secondary API Settings (for Summarization)",
    apiSecondaryProxyUrlLabel: "Secondary Proxy URL",
    apiSecondaryKeyLabel: "Secondary API Key",
    apiSecondaryModelLabel: "Secondary Model",
    apiFetchSecondaryModelsBtn: "Fetch Secondary Models",
    apiTemperatureLabel: "API Temperature",
    apiBgActivitySettings: "Background Activity Settings",
    apiEnableBgActivityLabel: "Enable Background Character Activity",
    apiBgIntervalLabel: "Background Activity Interval (sec)",
    apiBlockCooldownLabel: "AI Block Cooldown (hours)",
    apiTtsSettings: "Voice Message Settings (Minimax TTS)",
    apiTtsModelLabel: "Voice Model",
    apiPerformanceSettings: "Performance & Display Settings",
    apiChatListRenderWindowLabel: "Chat List Batch Load Count",
    apiChatRenderWindowLabel: "Chat View Initial Load Count",
    apiImageGenSettings: "Image Generation Settings",
    apiEnableImageGenLabel: "Enable AI Image Generation",
    apiEnableNovelAILabel: "Enable NovelAI Image Generation",
    apiNovelAIModelLabel: "NovelAI Model",
    apiNovelAIKeyLabel: "NovelAI API Key",
    apiNovelAIGenSettingsBtn: "Generation Settings",
    apiNovelAITestBtn: "Test Generation",
    apiStorageOptimization: "Storage Optimization",
    apiCompressImagesBtn: "Compress Local Images",
    apiSaveAllBtn: "Save All Settings",
    apiExportDataBtn: "Export Data",
    apiImportDataBtn: "Import Backup File",
    apiCleanupDataBtn: "Cleanup Redundant Data",
    apiDeleteWorldBooksBtn: "Delete World Books",
    apiAdvancedCleanupBtn: "Advanced Data Cleanup",
    apiCheckAndFixDataBtn: "Data Check & Repair",
    chatHeaderOnline: "Online",
    chatHeaderLongTermMemory: "Long-term Memory",
    chatHeaderListenTogether: "Listen Together",
    chatHeaderChatSettings: "Chat Settings",
    chatSelectionCancel: "Cancel",
    chatSelectionScreenshot: "Long Screenshot",
    chatSelectionFavorite: "Favorite",
    chatSelectionShare: "Share",
    chatSelectionSoftDelete: "Delete (Notify AI)",
    chatSelectionHardDelete: "Erase",
    chatReplyTo: "Reply to",
    chatInputPlaceholder: "Type a message...",
    chatWaitForReply: "Wait for Reply",
    appearanceTitle: "Appearance Settings",
    appearanceSaveAll: "Save All Appearance Settings",
    fontSettingsTitle: "Font Settings",
    fontPresetManagement: "Font Preset Management",
    fontFileUrlLabel: "Font File URL (.ttf, .otf, .woff, etc.)",
    fontPreviewLabel: "Live Preview",
    fontPreviewText1: "Hello World ä½ å¥½ä¸–ç•Œ",
    fontPreviewText2: "This is a font preview effect, 12345.",
    fontSaveAndApply: "Save and Apply",
    fontResetDefault: "Reset to Default Font",
    rendererTitle: "Rendering Rules",
    rendererEditorTitle: "Edit Rule",
    rendererCreateTitle: "Create New Rule",
    rendererRuleName: "Rule Name",
    rendererBindScope: "Binding Scope",
    rendererScopeGlobal: "Global (All Characters)",
    rendererRegex: "Regular Expression (use g flag)",
    rendererHtmlTemplate: "HTML Template (use $1, $2)",
    rendererEnableRule: "Enable Rule",
    myAlbumTitle: "My Albums",
    albumPhotosTitle: "Album Name",
    npcEditorTitleAdd: "Add NPC",
    npcEditorTitleEdit: "Edit NPC",
    npcAvatarLabel: "NPC Avatar",
    npcUploadAvatar: "Upload Avatar",
    npcNicknameLabel: "NPC Nickname",
    npcPersonaLabel: "NPC Persona",
    npcEnableBgActivity: "Enable Independent Background Activity",
    npcActionCooldown: "Independent Action Cooldown (min)",
    npcAssociatedChars: "Associated Characters (NPC will comment on their moments)"
  }
};
let h = "zh-CN";
function i(a) {
  if (!g[a]) {
    console.warn("Language \"" + a + "\" not found. Defaulting to 'zh-CN'.");
    a = "zh-CN";
  }
  h = a;
  localStorage.setItem("ephone-language", a);
  document.documentElement.lang = a;
  document.querySelectorAll("[data-lang-key]").forEach(b => {
    const c = b.getAttribute("data-lang-key");
    if (g[a][c]) {
      b.textContent = g[a][c];
    }
  });
  document.querySelectorAll("[data-lang-key-placeholder]").forEach(b => {
    const c = b.getAttribute("data-lang-key-placeholder");
    if (g[a][c]) {
      b.placeholder = g[a][c];
    }
  });
  document.querySelectorAll("[data-lang-key-title]").forEach(b => {
    const c = b.getAttribute("data-lang-key-title");
    if (g[a][c]) {
      b.title = g[a][c];
    }
  });
}
function j() {
  const a = localStorage.getItem("ephone-language") || "zh-CN";
  const b = document.getElementById("language-select");
  if (b) {
    b.value = a;
    b.addEventListener("change", a => {
      const b = a.target.value;
      alert(g[b].languageChangedAlert);
      localStorage.setItem("ephone-language", b);
      // TOLOOK
      setTimeout(() => window.location.reload(), 100);
    });
  }
  i(a);
}
(function () {
  'use strict';

  function a(a, c) {
    try {
      const d = document.createElement("a");
      d.href = a;
      d.download = c;
      d.style.display = "none";
      document.body.appendChild(d);
      d.click();
      // TOLOOK
      setTimeout(() => {
        document.body.removeChild(d);
      }, 100);
      console.log("âœ… [NAIä¸‹è½½] å¼€å§‹ä¸‹è½½å›¾ç‰‡:", c);
      b();
    } catch (a) {
      console.error("âŒ [NAIä¸‹è½½] ä¸‹è½½å¤±è´¥:", a);
      b("ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•", "error");
    }
  }
  function b(a = "ðŸ“¥ å›¾ç‰‡ä¸‹è½½ä¸­...", b = "success") {
    const c = document.createElement("div");
    c.textContent = a;
    c.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ` + (b === "success" ? "#4CAF50" : "#f44336") + `;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                pointer-events: none;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.3s ease;
            `;
    document.body.appendChild(c);
    // TOLOOK
    setTimeout(() => {
      c.style.opacity = "1";
      c.style.transform = "translateY(0)";
    }, 10);
    // TOLOOK
    setTimeout(() => {
      c.style.opacity = "0";
      c.style.transform = "translateY(-20px)";
      // TOLOOK
      setTimeout(() => {
        c.remove();
      }, 300);
    }, 2000);
  }
  function c(a) {
    const b = a.getAttribute("title") || a.getAttribute("alt") || "";
    let c = b.replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, "_").replace(/\s+/g, "_").substring(0, 30);
    if (!c) {
      c = "NAI_Image";
    }
    const d = new Date().toISOString().replace(/[-:]/g, "").replace("T", "_").split(".")[0];
    return c + "_" + d + ".png";
  }
  function d(a) {
    const b = a.style.transform || "";
    const c = a.style.transition || "";
    a.style.transition = "transform 0.15s ease";
    a.style.transform = "scale(0.95)";
    // TOLOOK
    setTimeout(() => {
      a.style.transform = b;
      // TOLOOK
      setTimeout(() => {
        a.style.transition = c;
      }, 150);
    }, 150);
  }
  window.downloadImage = a;
  window.generateFilename = c;
  window.addVisualFeedback = d;
  let e = 0;
  let f = null;
  let g = null;
  document.addEventListener("click", function (h) {
    const i = h.target;
    if (i.tagName === "IMG" && (i.classList.contains("realimag-image") || i.classList.contains("naiimag-image"))) {
      if (i === g) {
        e++;
      } else {
        e = 1;
        g = i;
      }
      if (f) {
        clearTimeout(f);
      }
      if (e === 3) {
        e = 0;
        g = null;
        h.preventDefault();
        h.stopPropagation();
        console.log("ðŸ–¼ï¸ [NAIä¸‹è½½] æ£€æµ‹åˆ°ä¸‰å‡»NAIå›¾ç‰‡");
        d(i);
        const f = i.src;
        if (!f || f === "about:blank") {
          console.warn("âš ï¸ [NAIä¸‹è½½] å›¾ç‰‡æºä¸ºç©ºï¼Œæ— æ³•ä¸‹è½½");
          b("å›¾ç‰‡åŠ è½½ä¸­ï¼Œè¯·ç¨åŽé‡è¯•", "error");
          return;
        }
        const j = c(i);
        a(f, j);
      } else {
        f = // TOLOOK
        setTimeout(() => {
          e = 0;
          g = null;
        }, 500);
      }
    }
  }, true);
  console.log("âœ… [NAIä¸‹è½½] ä¸‰å‡»ä¸‹è½½åŠŸèƒ½å·²åˆå§‹åŒ–");
  console.log("ðŸ’¡ [NAIä¸‹è½½] æç¤ºï¼šä¸‰å‡»ä»»æ„NAIå›¾ç‰‡å³å¯ä¸‹è½½");
})();
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").then(a => {
      console.log("ServiceWorker æ³¨å†ŒæˆåŠŸï¼Œä½œç”¨åŸŸä¸º: ", a.scope);
    }).catch(a => {
      console.log("ServiceWorker æ³¨å†Œå¤±è´¥: ", a);
    });
  });
}
if (!Array.prototype.findLastIndex) {
  Object.defineProperty(Array.prototype, "findLastIndex", {
    value: function (a) {
      if (this == null) {
        throw new TypeError("Cannot read property 'findLastIndex' of null or undefined");
      }
      if (typeof a !== "function") {
        throw new TypeError("predicate must be a function");
      }
      let b = Object(this);
      let c = b.length >>> 0;
      let d = arguments[1];
      let e = c - 1;
      while (e >= 0) {
        let c = b[e];
        if (a.call(d, c, e, b)) {
          return e;
        }
        e--;
      }
      return -1;
    },
    configurable: true,
    writable: true
  });
}
const k = document.getElementById("dynamic-island-content");
const l = document.getElementById("island-album-art");
const m = document.getElementById("island-lyric-container");
const n = document.getElementById("island-lyric-text");
const o = document.getElementById("phone-screen");
let p = null;
let q = null;
let r = "";
let s = [];
let t = [];
let u = [];
let v = null;
let w = null;
let x = null;
const y = "https://generativelanguage.googleapis.com/v1beta/models";
function z(a, b) {
  if (!a || !b || b.length === 0) {
    return null;
  }
  const c = 0.7;
  const d = [];
  let e = 0;
  const f = a => [...new Set(a.replace(/\s+/g, ""))];
  const g = f(a);
  b.forEach(a => {
    if (!a.name) {
      return;
    }
    const b = f(a.name);
    const h = b.filter(a => g.includes(a));
    const i = h.length / (b.length + g.length - h.length);
    if (i > e) {
      e = i;
    }
    if (i >= c) {
      d.push({
        sticker: a,
        score: i
      });
    }
  });
  if (d.length > 0) {
    const b = d.filter(a => a.score === e);
    const c = Math.floor(Math.random() * b.length);
    const f = b[c].sticker;
    console.log("[æ¨¡ç³ŠéšæœºåŒ¹é…æˆåŠŸ] AIå«ä¹‰: \"" + a + "\", åŒ¹é…åˆ° " + b.length + " ä¸ªæœ€ä½³é€‰é¡¹, éšæœºé€‰ä¸­: \"" + f.name + "\", ç›¸ä¼¼åº¦: " + e.toFixed(2));
    return f;
  }
  console.log("[æ¨¡ç³ŠéšæœºåŒ¹é…å¤±è´¥] AIå«ä¹‰: \"" + a + "\", æœ€é«˜ç›¸ä¼¼åº¦ä¸º " + e.toFixed(2) + "ï¼Œæœªè¾¾åˆ°é˜ˆå€¼ " + c + "ã€‚");
  return null;
}
function A(a) {
  if (a.includes(",")) {
    const b = a.split(",").map(a => a.trim());
    const c = Math.floor(Math.random() * b.length);
    return b[c];
  }
  return a;
}
function B(a) {
  if (a.image_url && a.image_url.url) {
    let b = a.image_url.url;
    const c = b.split(",")[1];
    const d = b.match(/^data:(.*);base64/)[1];
    return [{
      text: "ç”¨æˆ·å‘ä½ å‘é€äº†ä¸€å¼ å›¾ç‰‡"
    }, {
      inline_data: {
        mime_type: d,
        data: c
      }
    }];
  }
  return [];
}
function C(a) {
  if (a.choices && Array.isArray(a.choices) && a.choices.length > 0 && a.choices[0].message && a.choices[0].message.content) {
    return a.choices[0].message.content;
  }
  if (a.candidates && Array.isArray(a.candidates) && a.candidates.length > 0 && a.candidates[0].content && a.candidates[0].content.parts) {
    return a.candidates[0].content.parts[0].text;
  }
  console.error("APIè¿”å›žäº†éžé¢„æœŸçš„æ ¼å¼:", a);
  let b = "AIè¿”å›žäº†ç©ºå†…å®¹æˆ–æœªçŸ¥æ ¼å¼ã€‚";
  if (a.candidates && Array.isArray(a.candidates) && a.candidates.length > 0 && a.candidates[0].finishReason === "SAFETY") {
    const c = a.candidates[0].safetyRatings;
    const d = c.filter(a => a.probability !== "NEGLIGIBLE" && a.probability !== "LOW").map(a => a.category + " (æ¦‚çŽ‡: " + a.probability + ")").join(", ");
    b = "å†…å®¹å› å®‰å…¨ç­–ç•¥è¢«å±è”½ã€‚è§¦å‘ç±»åˆ«: " + (d || "æœªçŸ¥");
  } else if (a.promptFeedback?.blockReason) {
    const c = a.promptFeedback.blockReason;
    const d = a.promptFeedback.safetyRatings?.map(a => a.category + ": " + a.probability).join(", ");
    b = "å†…å®¹å› å®‰å…¨ç­–ç•¥è¢«å±è”½ (åŽŸå› : " + c + ")ã€‚è¯¦æƒ…: " + (d || "æ— ");
  } else if (a.error?.message) {
    b = "APIé”™è¯¯: " + a.error.message;
  } else if (a.message) {
    b = "APIé”™è¯¯: " + a.message;
  } else if (a.detail) {
    b = "APIé”™è¯¯: " + a.detail;
  } else if (a.error && typeof a.error === "string") {
    b = "APIé”™è¯¯: " + a.error;
  }
  throw new Error(b);
}
document.addEventListener("DOMContentLoaded", () => {
  const a = "bu_wan_jiu_guan_bu_yao_huo_qu";
  async function d(a, b) {
    if (!a || !b) {
      throw new Error("è®¾å¤‡IDå’Œå¯†é’¥ç›ä¸èƒ½ä¸ºç©ºã€‚");
    }
    const c = a + b;
    const d = new TextEncoder().encode(c);
    const e = await crypto.subtle.digest("SHA-256", d);
    const f = Array.from(new Uint8Array(e));
    const g = f.map(a => a.toString(16).padStart(2, "0")).join("");
    return g.substring(0, 6).toUpperCase();
  }
  function i() {
    return new Promise(async (b, c) => {
      if (f) {
        b(true);
        return;
      }
      const g = document.getElementById("pin-modal-overlay");
      const h = document.getElementById("pin-device-id-display");
      const i = document.getElementById("pin-input");
      const j = document.getElementById("pin-modal-confirm-btn");
      const l = document.getElementById("pin-modal-cancel-btn");
      h.value = e;
      i.value = "";
      const m = async () => {
        const h = i.value;
        g.classList.remove("visible");
        j.removeEventListener("click", m);
        l.removeEventListener("click", n);
        if (!h || !h.trim()) {
          await Bb("æ“ä½œå–æ¶ˆ", "æ‚¨æ²¡æœ‰è¾“å…¥æ¿€æ´»ç ã€‚");
          c(new Error("ç”¨æˆ·å–æ¶ˆäº†è¾“å…¥ã€‚"));
          return;
        }
        await Bb("è¯·ç¨å€™...", "æ­£åœ¨éªŒè¯æ¿€æ´»ç ...");
        try {
          const g = await d(e, a);
          if (h.trim().toUpperCase() === g) {
            localStorage.setItem("ephonePinActivated", "true");
            f = true;
            await Bb("æ¿€æ´»æˆåŠŸï¼", "æ­¤åŠŸèƒ½å·²ä¸ºæ‚¨çš„è®¾å¤‡æ°¸ä¹…è§£é”ã€‚");
            k();
            b(true);
          } else {
            await Bb("æ¿€æ´»å¤±è´¥", "æ‚¨è¾“å…¥çš„æ¿€æ´»ç ä¸æ­£ç¡®ã€‚");
            c(new Error("æ¿€æ´»ç ä¸æ­£ç¡®ã€‚"));
          }
        } catch (a) {
          console.error("æœ¬åœ°PINç éªŒè¯è¿‡ç¨‹å‡ºé”™:", a);
          await Bb("æ¿€æ´»å¤±è´¥", "éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š" + a.message);
          c(a);
        }
      };
      const n = async () => {
        g.classList.remove("visible");
        j.removeEventListener("click", m);
        l.removeEventListener("click", n);
        await Bb("æ“ä½œå–æ¶ˆ", "æ¿€æ´»æµç¨‹å·²å–æ¶ˆã€‚");
        c(new Error("ç”¨æˆ·å–æ¶ˆäº†æ¿€æ´»ã€‚"));
      };
      j.addEventListener("click", m);
      l.addEventListener("click", n);
      g.classList.add("visible");
      i.focus();
    });
  }
  function k() {
    const a = localStorage.getItem("ephonePinActivated") === "true";
    const b = document.getElementById("import-preset-btn");
    const c = document.getElementById("import-world-book-btn");
    if (b) {
      b.classList.toggle("locked-feature", !a);
    }
    if (c) {
      c.classList.toggle("locked-feature", !a);
    }
  }
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      console.log("åº”ç”¨å·²è¿”å›žå‰å°ï¼Œæ­£åœ¨æ£€æŸ¥æ›´æ–°...");
      navigator.serviceWorker.ready.then(a => {
        a.update();
      });
    }
  });
  function p(a, b, c, d) {
    const e = v.globalSettings.apiTemperature || 0.8;
    const f = {
      user: "user",
      assistant: "model",
      system: "user"
    };
    const g = [{
      role: "user",
      parts: [{
        text: c
      }]
    }, {
      role: "model",
      parts: [{
        text: "å¥½çš„ï¼Œæˆ‘æ˜Žç™½äº†ã€‚æˆ‘ä¼šä¸¥æ ¼éµå®ˆä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œè®¾å®šã€‚"
      }]
    }, ...d.map(a => {
      const b = [];
      if (Array.isArray(a.content)) {
        a.content.forEach(a => {
          if (a.type === "text") {
            b.push({
              text: a.text
            });
          } else if (a.type === "image_url" && a.image_url && a.image_url.url) {
            const c = a.image_url.url;
            const d = c.split(",")[1];
            const e = c.match(/^data:(.*);base64/);
            if (e && d) {
              b.push({
                inline_data: {
                  mime_type: e[1],
                  data: d
                }
              });
            }
          }
        });
      } else {
        b.push({
          text: String(a.content)
        });
      }
      return {
        role: f[a.role],
        parts: b
      };
    })];
    return {
      url: "https://generativelanguage.googleapis.com/v1beta/models/" + a + ":generateContent?key=" + A(b),
      data: {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          contents: g,
          generationConfig: {
            temperature: e
          }
        })
      }
    };
  }
  const q = [{
    id: "none",
    url: "",
    name: "æ— "
  }, {
    id: "frame_cat_ear",
    url: "https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif",
    name: "1"
  }, {
    id: "frame_ribbon",
    url: "https://i.postimg.cc/HxH3cNHz/IMG-6871.gif",
    name: "2"
  }, {
    id: "frame_flower",
    url: "https://i.postimg.cc/jCVK0fGL/IMG-6890.gif",
    name: "3"
  }, {
    id: "frame_tech",
    url: "https://i.postimg.cc/85Zsyjwn/IMG-6895.gif",
    name: "4"
  }, {
    id: "frame_5",
    url: "https://i.postimg.cc/cJtpZCB3/IMG-6894.gif",
    name: "5"
  }, {
    id: "frame_6",
    url: "https://i.postimg.cc/63sDQKMm/IMG-6893.gif",
    name: "6"
  }, {
    id: "frame_7",
    url: "https://i.postimg.cc/cHQPgzj4/IMG-6888.gif",
    name: "7"
  }, {
    id: "frame_8",
    url: "https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif",
    name: "8"
  }, {
    id: "frame_9",
    url: "https://i.postimg.cc/kGsZwbq0/IMG-6886.gif",
    name: "9"
  }, {
    id: "frame_10",
    url: "https://i.postimg.cc/63NmX03s/IMG-4366.gif",
    name: "10"
  }, {
    id: "frame_11",
    url: "https://i.postimg.cc/zvz2LGK0/IMG-4367.gif",
    name: "11"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/prsGKMBx/IMG-4370.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/gk0BmrY0/IMG-4371.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/fRt2SFSn/IMG-4368.gif",
    name: "14"
  }, {
    id: "frame_cat_ear",
    url: "https://i.postimg.cc/kGgwJhPH/IMG-4374.gif",
    name: "1"
  }, {
    id: "frame_ribbon",
    url: "https://i.postimg.cc/PrcKH436/IMG-4376.gif",
    name: "2"
  }, {
    id: "frame_flower",
    url: "https://i.postimg.cc/fRV86FMq/IMG-4381.gif",
    name: "3"
  }, {
    id: "frame_tech",
    url: "https://i.postimg.cc/HsyqMVyk/IMG-4385.gif",
    name: "4"
  }, {
    id: "frame_5",
    url: "https://i.postimg.cc/qBbKK7dS/IMG-4386.gif",
    name: "5"
  }, {
    id: "frame_6",
    url: "https://i.postimg.cc/05wnd389/IMG-4388.gif",
    name: "6"
  }, {
    id: "frame_7",
    url: "https://i.postimg.cc/RZNLhbbr/IMG-4389.gif",
    name: "7"
  }, {
    id: "frame_8",
    url: "https://i.postimg.cc/fLTc42dg/IMG-4391.gif",
    name: "8"
  }, {
    id: "frame_9",
    url: "https://i.postimg.cc/FzbGNdRT/IMG-4392.gif",
    name: "9"
  }, {
    id: "frame_10",
    url: "https://i.postimg.cc/XY63sTS3/IMG-4393.gif",
    name: "10"
  }, {
    id: "frame_11",
    url: "https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif",
    name: "11"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/CLrZQMMD/IMG-4398.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/L4zwDhTC/IMG-4399.gif",
    name: "14"
  }, {
    id: "frame_cat_ear",
    url: "https://i.postimg.cc/yN3s8szM/IMG-4400.gif",
    name: "1"
  }, {
    id: "frame_ribbon",
    url: "https://i.postimg.cc/59Cn1tkB/IMG-4401.gif",
    name: "2"
  }, {
    id: "frame_flower",
    url: "https://i.postimg.cc/g0s1V0PX/IMG-4402.gif",
    name: "3"
  }, {
    id: "frame_tech",
    url: "https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif",
    name: "4"
  }, {
    id: "frame_5",
    url: "https://i.postimg.cc/q7cQnDy1/IMG-4404.gif",
    name: "5"
  }, {
    id: "frame_6",
    url: "https://i.postimg.cc/RFK3q2t0/IMG-4407.gif",
    name: "6"
  }, {
    id: "frame_7",
    url: "https://i.postimg.cc/gcV0VR2t/IMG-4408.gif",
    name: "7"
  }, {
    id: "frame_8",
    url: "https://i.postimg.cc/W1CjLb4J/IMG-4409.gif",
    name: "8"
  }, {
    id: "frame_9",
    url: "https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif",
    name: "9"
  }, {
    id: "frame_10",
    url: "https://i.postimg.cc/nrFfYX3N/IMG-4412.gif",
    name: "10"
  }, {
    id: "frame_11",
    url: "https://i.postimg.cc/cHWp0KG6/IMG-4413.gif",
    name: "11"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/4yNjHrdg/IMG-4414.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/vHCSG1WM/IMG-4416.gif",
    name: "14"
  }, {
    id: "frame_cat_ear",
    url: "https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif",
    name: "1"
  }, {
    id: "frame_ribbon",
    url: "https://i.postimg.cc/FHRcCGfH/IMG-4418.gif",
    name: "2"
  }, {
    id: "frame_flower",
    url: "https://i.postimg.cc/13hhJ77p/IMG-4419.gif",
    name: "3"
  }, {
    id: "frame_tech",
    url: "https://i.postimg.cc/J4WCQd2j/IMG-4420.gif",
    name: "4"
  }, {
    id: "frame_5",
    url: "https://i.postimg.cc/Dydkpd9H/IMG-4421.gif",
    name: "5"
  }, {
    id: "frame_6",
    url: "https://i.postimg.cc/mrkvDxPW/IMG-4422.gif",
    name: "6"
  }, {
    id: "frame_7",
    url: "https://i.postimg.cc/76Tj3g1B/IMG-4425.gif",
    name: "7"
  }, {
    id: "frame_8",
    url: "https://i.postimg.cc/3N5Vndn3/IMG-4426.gif",
    name: "8"
  }, {
    id: "frame_9",
    url: "https://i.postimg.cc/05DLr0yj/IMG-4427.gif",
    name: "9"
  }, {
    id: "frame_10",
    url: "https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif",
    name: "10"
  }, {
    id: "frame_11",
    url: "https://i.postimg.cc/fRTF24jS/IMG-4430.gif",
    name: "11"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/R0WYmcYM/IMG-4431.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/nrJSqNhz/IMG-4432.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif",
    name: "14"
  }, {
    id: "frame_cat_ear",
    url: "https://i.postimg.cc/XNkQTHvf/IMG-5561.gif",
    name: "1"
  }, {
    id: "frame_ribbon",
    url: "https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif",
    name: "2"
  }, {
    id: "frame_flower",
    url: "https://i.postimg.cc/T1tjhsyB/IMG-4720.gif",
    name: "3"
  }, {
    id: "frame_tech",
    url: "https://i.postimg.cc/c4JMPd2W/IMG-4724.gif",
    name: "4"
  }, {
    id: "frame_5",
    url: "https://i.postimg.cc/g2XykNGB/IMG-4727.gif",
    name: "5"
  }, {
    id: "frame_6",
    url: "https://i.postimg.cc/y8MmJcd6/IMG-4728.gif",
    name: "6"
  }, {
    id: "frame_7",
    url: "https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif",
    name: "7"
  }, {
    id: "frame_8",
    url: "https://i.postimg.cc/bNdk33SN/IMG-4893.gif",
    name: "8"
  }, {
    id: "frame_9",
    url: "https://i.postimg.cc/4x9tTy1D/IMG-5563.gif",
    name: "9"
  }, {
    id: "frame_10",
    url: "https://i.postimg.cc/DZshzKv6/IMG-5576.gif",
    name: "10"
  }, {
    id: "frame_11",
    url: "https://i.postimg.cc/Fsvr71JL/IMG-5573.gif",
    name: "11"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/wjH180kn/IMG-5566.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/MG6qtLYK/IMG-5565.gif",
    name: "14"
  }, {
    id: "frame_cat_ear",
    url: "https://i.postimg.cc/CKgDNYVb/IMG-5577.gif",
    name: "1"
  }, {
    id: "frame_ribbon",
    url: "https://i.postimg.cc/hj4dkrvj/IMG-5578.gif",
    name: "2"
  }, {
    id: "frame_flower",
    url: "https://i.postimg.cc/hj4dkrvj/IMG-5578.gif",
    name: "3"
  }, {
    id: "frame_tech",
    url: "https://i.postimg.cc/C5XnfpNB/IMG-5579.gif",
    name: "4"
  }, {
    id: "frame_5",
    url: "https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif",
    name: "5"
  }, {
    id: "frame_6",
    url: "https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif",
    name: "6"
  }, {
    id: "frame_7",
    url: "https://i.postimg.cc/rF4KYbjj/IMG-5720.gif",
    name: "7"
  }, {
    id: "frame_8",
    url: "https://i.postimg.cc/6pLTBvDG/IMG-5721.gif",
    name: "8"
  }, {
    id: "frame_9",
    url: "https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif",
    name: "9"
  }, {
    id: "frame_10",
    url: "https://i.postimg.cc/wx72fhr2/IMG-5968.gif",
    name: "10"
  }, {
    id: "frame_11",
    url: "https://i.postimg.cc/QdrqdvdY/IMG-5969.gif",
    name: "11"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/1zmcp66p/IMG-5973.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif",
    name: "14"
  }, {
    id: "frame_cat_ear",
    url: "https://i.postimg.cc/R0pfKYvB/IMG-5976.gif",
    name: "1"
  }, {
    id: "frame_ribbon",
    url: "https://i.postimg.cc/9fQZ425b/IMG-5975.gif",
    name: "2"
  }, {
    id: "frame_flower",
    url: "https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif",
    name: "3"
  }, {
    id: "frame_tech",
    url: "https://i.postimg.cc/WbmkXzsS/IMG-6138.gif",
    name: "4"
  }, {
    id: "frame_5",
    url: "https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif",
    name: "5"
  }, {
    id: "frame_6",
    url: "https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif",
    name: "6"
  }, {
    id: "frame_7",
    url: "https://i.postimg.cc/qRCtnMms/IMG-6145.gif",
    name: "7"
  }, {
    id: "frame_8",
    url: "https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif",
    name: "8"
  }, {
    id: "frame_9",
    url: "https://i.postimg.cc/Kv51tW5H/IMG-6147.gif",
    name: "9"
  }, {
    id: "frame_10",
    url: "https://i.postimg.cc/nhcC21Rc/IMG-6148.gif",
    name: "10"
  }, {
    id: "frame_11",
    url: "https://i.postimg.cc/fTWzQRx8/IMG-6149.gif",
    name: "11"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/LXyyqDbY/IMG-6294.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif",
    name: "14"
  }, {
    id: "frame_cat_ear",
    url: "https://i.postimg.cc/YSRRV8kn/IMG-6297.gif",
    name: "1"
  }, {
    id: "frame_ribbon",
    url: "https://i.postimg.cc/k45sd8gn/IMG-6375.gif",
    name: "2"
  }, {
    id: "frame_flower",
    url: "https://i.postimg.cc/50k390X8/IMG-6376.gif",
    name: "3"
  }, {
    id: "frame_tech",
    url: "https://i.postimg.cc/90RBDh9K/IMG-6377.gif",
    name: "4"
  }, {
    id: "frame_5",
    url: "https://i.postimg.cc/cCpBYbMH/IMG-6552.gif",
    name: "5"
  }, {
    id: "frame_6",
    url: "https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif",
    name: "6"
  }, {
    id: "frame_7",
    url: "https://i.postimg.cc/gkhf597g/IMG-6555.gif",
    name: "7"
  }, {
    id: "frame_8",
    url: "https://i.postimg.cc/g2PfbSFm/IMG-6556.gif",
    name: "8"
  }, {
    id: "frame_9",
    url: "https://i.postimg.cc/pLY3WfR8/IMG-6557.gif",
    name: "9"
  }, {
    id: "frame_10",
    url: "https://i.postimg.cc/65Cmcr7S/IMG-6559.gif",
    name: "10"
  }, {
    id: "frame_11",
    url: "https://i.postimg.cc/Y94XWYKd/IMG-6560.gif",
    name: "11"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/ydwLXx7s/IMG-6562.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/G3y73Fj2/IMG-6563.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/TYvkKKkc/IMG-6565.gif",
    name: "14"
  }, {
    id: "frame_cat_ear",
    url: "https://i.postimg.cc/GmcqjZn8/IMG-6566.gif",
    name: "1"
  }, {
    id: "frame_ribbon",
    url: "https://i.postimg.cc/k5Gs0K47/IMG-6567.gif",
    name: "2"
  }, {
    id: "frame_flower",
    url: "https://i.postimg.cc/XJy8JWdh/IMG-6568.gif",
    name: "3"
  }, {
    id: "frame_tech",
    url: "https://i.postimg.cc/fycfcvHf/IMG-6569.gif",
    name: "4"
  }, {
    id: "frame_5",
    url: "https://i.postimg.cc/J7ZxC11H/IMG-6570.gif",
    name: "5"
  }, {
    id: "frame_6",
    url: "https://i.postimg.cc/hPnrSHjy/IMG-4434.gif",
    name: "6"
  }, {
    id: "frame_7",
    url: "https://i.postimg.cc/YqxxjbLp/IMG-6572.gif",
    name: "7"
  }, {
    id: "frame_8",
    url: "https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif",
    name: "8"
  }, {
    id: "frame_9",
    url: "https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif",
    name: "9"
  }, {
    id: "frame_10",
    url: "https://i.postimg.cc/MZ77rdDy/IMG-6850.gif",
    name: "10"
  }, {
    id: "frame_11",
    url: "https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif",
    name: "11"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/28TsrxRV/IMG-6852.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/VkV2bLNw/IMG-6853.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/gJ95NSRB/IMG-6854.gif",
    name: "14"
  }, {
    id: "frame_cat_ear",
    url: "https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif",
    name: "1"
  }, {
    id: "frame_ribbon",
    url: "https://i.postimg.cc/gJNYx9pV/IMG-6856.gif",
    name: "2"
  }, {
    id: "frame_flower",
    url: "https://i.postimg.cc/fyPDvxJk/IMG-6860.gif",
    name: "3"
  }, {
    id: "frame_tech",
    url: "https://i.postimg.cc/QMDsSNxg/IMG-6861.gif",
    name: "4"
  }, {
    id: "frame_5",
    url: "https://i.postimg.cc/vBqsQW7X/IMG-6858.gif",
    name: "5"
  }, {
    id: "frame_6",
    url: "https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif",
    name: "6"
  }, {
    id: "frame_7",
    url: "https://i.postimg.cc/90sH9Cn7/IMG-6868.gif",
    name: "7"
  }, {
    id: "frame_8",
    url: "https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif",
    name: "8"
  }, {
    id: "frame_9",
    url: "https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif",
    name: "9"
  }, {
    id: "frame_10",
    url: "https://i.postimg.cc/nryNzTXK/IMG-6915.gif",
    name: "10"
  }, {
    id: "frame_11",
    url: "https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif",
    name: "11"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/tgR6wjBP/IMG-5570.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/d0WCKxff/IMG-6932.gif",
    name: "14"
  }, {
    id: "frame_11",
    url: "https://i.postimg.cc/Ss3znzk7/IMG-6934.gif",
    name: "11"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/nrm9BcL8/IMG-6941.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/sDFhySn3/IMG-6936.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/43PhvxRq/IMG-6922.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/PJppkbvn/IMG-6918.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/RVt6sRzc/IMG-6939.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/mgGc0HbK/IMG-6926.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/xCqqKGRN/IMG-6929.gif",
    name: "14"
  }, {
    id: "frame_12",
    url: "https://i.postimg.cc/7LSRp4hx/e7fa949b9pc84cff0dabe57defceb54c.gif",
    name: "12"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/DZgMwc1H/817178fdbpf2ff7740dc98e26ab78759.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/3NffgJSZ/e09c07034ld7e62266c0a5de6a36ae62.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/vHDNGfT2/35ac7f372v588bf48d4f659077196b85.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/KvVsjjgG/3c3aa5219s18b90187ef1f54b3db7ba8.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/k5P1NHcL/55f3e31d8qbc8a02d152b07b99d31567.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/FFCTCzpy/641bad3b3udc599fdb63ca75fde427e5.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/8k7YSLjK/1689aa46aqc4b9ffc0f970e668f56537.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/J0CZSwyW/IMG-6938.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/Df1qLzDf/IMG-6927.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/CLNkrQSW/IMG-6925.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/y8p9s3Jj/IMG-6919.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/Lsr1Zd3Z/IMG-6928.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/Ssgbv41n/IMG-6876.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/SNByPrf9/IMG-7005.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/Z5nrCyS5/IMG-7006.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/mDfMXXFP/IMG-7007.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/DZrGtrqB/IMG-7008.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/ZnJNZWHZ/IMG-7009.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/RhGH0vpt/IMG-7010.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/tRzPkzRg/IMG-7012.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/wTTNGs3Q/IMG-7013.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/3JSG5Jv5/IMG-7014.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/rwDr8X1d/IMG-7015.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/DzDy2vS7/IMG-7017.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/QMVdG9x6/IMG-7016.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/mZ9hgH3J/IMG-7019.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/t4ksHGdg/IMG-7020.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/hP9JpdfT/IMG-7023.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/wTKyXVT9/IMG-7024.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/ZqjKXPSv/IMG-7025.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/gj3Tmqz5/mmexport1751030241029.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/4yCXW52F/mmexport1751030908335.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/VkXngG72/mmexport1751031208329.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/LscBkxZb/mmexport1751017556565.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/1XqzGKwJ/mmexport1751018282681.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/8kHCQwbQ/mmexport1751020645824.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/HWynLK7f/mmexport1751021724230.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/JnwFp3Kx/mmexport1751031208329.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/HLZNWkQw/mmexport1751031767634.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/vH2X6N1y/mmexport1751032231179.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/NFS4ZyvM/mmexport1751032686953.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/3RpmWc8c/mmexport1751033102811.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/L5RLr3tg/mmexport1751035976943.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/4NCPsp5d/mmexport1751034427637.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/CMv02LHm/mmexport1751034842120.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/rFnSzWGx/mmexport1751035618517.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/7YRbzN51/mmexport1751036276038.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/cJpbtPWq/mmexport1751036607799.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/HxLV5v92/mmexport1751036977582.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/D01rYy86/mmexport1751037965259.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/J4fwkTLW/mmexport1751038167142.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/xjpN4swz/IMG-7240.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/ZnzbGdxX/IMG-7239.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/DyYDmKtw/IMG-7238.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/W40f9qtd/IMG-7098.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/8PsK20jQ/IMG-7236.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/cHsTXDVz/IMG-7235.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/sXwm8Yzg/IMG-7234.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/xTk5xN49/IMG-7233.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/k5yv6QBv/IMG-7232.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/yx2m4nbs/IMG-7231.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/vZt0fFKn/IMB-r-HMBXY.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/pddJj9zN/IMG-7094.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/rmB17Qbc/IMB-f-VDf-Fc.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/VkKjzYTK/IMB-f4kk-CT.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/B6KD52vz/IMG-7096.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/9XPwWmwy/IMB-Kf7um-P.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/mrFhKBGz/IMB-e-QWBpa.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/bw4wxW2z/IMB-16r-COL.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/3x0Kx1fz/IMB-K1u-Jp-P.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/CLz0cJ0d/IMG-7116.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/fyyGgW61/IMG-7115.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/gkk7s0vD/IMG-6984.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/0NpZPgYj/IMG-6985.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/tTWKKmTN/IMG-7073.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/jS8tc9wW/IMG-7083.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/rmRVKJpD/IMG-7087.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/zvWGPjms/IMG-7090.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/YSkqDg8V/IMG-7092.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/FzqHTBng/IMG-7093.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/tTpZ6wLs/IMG-7095.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/8P5vt8sW/IMG-7097.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/wMxmCZVC/IMG-7099.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/2jxd0FGp/IMG-7100.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/B6T59xGK/IMG-7101.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/kXfcgFRN/IMG-7106.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/htZppbS4/IMG-7107.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/hPgyjtyn/IMG-7108.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/HLKvs0Kv/IMG-7109.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/wjwbnYkp/IMG-7111.gif",
    name: "14"
  }, {
    id: "frame_13",
    url: "https://i.postimg.cc/bJDMQVkj/IMG-7112.gif",
    name: "13"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/SNWBTP5S/IMG-7113.gif",
    name: "14"
  }, {
    id: "frame_14",
    url: "https://i.postimg.cc/jCVMQsKH/IMG-7114.gif",
    name: "14"
  }];
  let u = {
    page: 0,
    pageSize: 30,
    isLoading: false,
    hasMore: true,
    filterDate: "",
    filterType: "all"
  };
  let v = {
    chats: {},
    activeChatId: null,
    globalSettings: {},
    apiConfig: {},
    userStickers: [],
    worldBooks: [],
    personaPresets: [],
    qzoneSettings: {},
    activeAlbumId: null,
    cache: {
      songs: new Map(),
      lyrics: new Map()
    },
    ttsCache: new Map(),
    quickReplies: []
  };
  let B = [];
  let D = 0;
  let E = false;
  let F = [];
  let G = 0;
  let H = false;
  async function I(a) {
    if (!v.apiConfig.imgbbEnable || !v.apiConfig.imgbbApiKey) {
      return a;
    }
    if (!a || !a.startsWith("data:image")) {
      return a;
    }
    const b = a.split(",")[1];
    if (!b) {
      console.warn("æ— æ³•ä»Žå­—ç¬¦ä¸²ä¸­æå– Base64 æ•°æ®:", a.substring(0, 50) + "...");
      return a;
    }
    console.log("[ImgBB] å¼€å§‹ä¸Šä¼ å›¾ç‰‡... (å¤§å°: " + (a.length / 1024).toFixed(1) + " KB)");
    try {
      const a = new FormData();
      a.append("image", b);
      const c = await fetch("https://api.imgbb.com/1/upload?key=" + v.apiConfig.imgbbApiKey, {
        method: "POST",
        body: a
      });
      const d = await c.json();
      if (d.success && d.data && d.data.url) {
        console.log("[ImgBB] ä¸Šä¼ æˆåŠŸ! URL:", d.data.url);
        return d.data.url;
      } else {
        throw new Error(d.error?.message || "ImgBB API è¿”å›žäº†æœªçŸ¥é”™è¯¯ã€‚");
      }
    } catch (a) {
      console.error("[ImgBB] ä¸Šä¼ å¤±è´¥:", a);
      throw new Error("ImgBB ä¸Šä¼ å¤±è´¥: " + a.message);
    }
  }
  async function J(a) {
    if (!v.apiConfig.catboxEnable || !v.apiConfig.catboxUserHash) {
      console.log("[Catbox] åŠŸèƒ½æœªå¼€å¯æˆ–æœªé…ç½® User Hashï¼Œè·³è¿‡ä¸Šä¼ ã€‚");
      return null;
    }
    const b = v.apiConfig.catboxUserHash;
    console.log("[Catbox] å¼€å§‹ä¸Šä¼ æ–‡ä»¶: " + (a.name || "blob.mp3") + "... (å¤§å°: " + (a.size / 1024 / 1024).toFixed(2) + " MB)");
    try {
      const c = new FormData();
      c.append("reqtype", "fileupload");
      c.append("userhash", b);
      c.append("fileToUpload", a, a.name || "track.mp3");
      let d = "https://catbox.moe/user/api.php";
      const e = Dc();
      let f = e.cors_proxy;
      if (f === "custom") {
        f = e.custom_proxy_url || "";
      }
      if (f && f !== "") {
        d = f + d;
        console.log("[Catbox] æ£€æµ‹åˆ°CORSä»£ç†ï¼Œä½¿ç”¨ä»£ç†ä¸Šä¼ : " + d);
      } else {
        console.log("[Catbox] æœªé…ç½®CORSä»£ç†ï¼Œå°è¯•ç›´è¿ž... (è¿™å¾ˆå¯èƒ½ä¼šå¤±è´¥)");
      }
      const g = await fetch(d, {
        method: "POST",
        body: c
      });
      const h = await g.text();
      if (g.ok && h.startsWith("http")) {
        console.log("[Catbox] ä¸Šä¼ æˆåŠŸ! URL:", h);
        return h;
      } else {
        throw new Error(h || "Catbox API è¿”å›žäº†æœªçŸ¥é”™è¯¯ã€‚");
      }
    } catch (a) {
      console.error("[Catbox] ä¸Šä¼ å¤±è´¥:", a);
      throw a;
    }
  }
  async function K(a, b, c, d, e = null) {
    if (!v.apiConfig.imgbbEnable || !v.apiConfig.imgbbApiKey) {
      console.log("[ImgBB Silent Update] ImgBB is disabled, skipping silent upload for " + a.name + "." + b + "." + c + ".");
      return;
    }
    let f;
    try {
      f = await I(d);
      if (f === d) {
        console.log("[ImgBB Silent Update] Upload returned Base64 (or failed), no update needed.");
        return;
      }
    } catch (d) {
      console.error("[ImgBB Silent Update] Background upload failed for " + a.name + "." + b + "." + c + ":", d.message);
      return;
    }
    console.log("[ImgBB Silent Update] Success. New URL: " + f + ". Finding record to update...");
    try {
      const g = await a.get(b);
      if (!g) {
        console.warn("[ImgBB Silent Update] Could not find record " + b + " in table " + a.name + ".");
        return;
      }
      let h = false;
      function i(a, b) {
        const c = b.split(".");
        let d = a;
        for (let e = 0; e < c.length - 1; e++) {
          if (d[c[e]] === undefined || d[c[e]] === null) {
            console.warn("[ImgBB Silent Update] Invalid path: " + b + " in record at key " + c[e] + ".");
            return null;
          }
          d = d[c[e]];
        }
        return {
          parent: d,
          finalKey: c[c.length - 1]
        };
      }
      if (e) {
        const a = i(g, c);
        if (a && Array.isArray(a.parent[a.finalKey])) {
          const b = a.parent[a.finalKey];
          const g = b.find(a => a.url === d && a.name === e);
          if (g) {
            g.url = f;
            h = true;
            console.log("[ImgBB Silent Update] Found and updated item \"" + e + "\" in array " + c + ".");
          } else {
            console.warn("[ImgBB Silent Update] Could not find item \"" + e + "\" with matching Base64 in array " + c + " to update.");
          }
        } else {
          console.warn("[ImgBB Silent Update] Path " + c + " did not resolve to a valid array.");
        }
      } else {
        const a = i(g, c);
        if (a && a.parent[a.finalKey] === d) {
          a.parent[a.finalKey] = f;
          h = true;
          console.log("[ImgBB Silent Update] Found and updated simple path " + c + ".");
        } else if (a) {
          console.warn("[ImgBB Silent Update] Value changed since upload for " + c + ". Expected Base64, found: " + String(a.parent[a.finalKey]).substring(0, 30) + "...");
        } else {
          console.warn("[ImgBB Silent Update] Path " + c + " did not resolve to a matching string.");
        }
      }
      if (h) {
        await a.put(g);
        console.log("[ImgBB Silent Update] Successfully updated DB for " + a.name + "." + b + "." + c + ".");
        if (a.name === "globalSettings" && b === "main") {
          const a = i(v, "globalSettings." + c);
          if (e && a && Array.isArray(a.parent[a.finalKey])) {
            const b = a.parent[a.finalKey];
            const c = b.find(a => a.url === d && a.name === e);
            if (c) {
              c.url = f;
            }
          } else if (!e && a && a.parent[a.finalKey] === d) {
            a.parent[a.finalKey] = f;
          }
          console.log("[ImgBB Silent Update] In-memory state.globalSettings updated.");
        }
      }
    } catch (d) {
      console.error("[ImgBB Silent Update] Failed to save updated URL to DB for " + a.name + "." + b + "." + c + ":", d);
    }
  }
  let L = {
    isActive: false,
    gameMode: null,
    chatId: null,
    players: [],
    currentDay: 1,
    currentPhase: "setup",
    nightActions: {},
    gameLog: [],
    discussionLog: [],
    voteResults: {},
    electionInfo: {
      candidates: [],
      votes: {}
    },
    sheriffId: null,
    lastFailedAction: null
  };
  let M = 0;
  const N = 15;
  let O = 0;
  const P = 10;
  let Q = [];
  let R = {
    isActive: false,
    activeChatId: null,
    isPlaying: false,
    playlist: [],
    currentIndex: -1,
    playMode: "order",
    totalElapsedTime: 0,
    timerId: null,
    parsedLyrics: [],
    currentLyricIndex: -1
  };
  let S = {
    isOpen: false,
    activePostId: null,
    panelEl: null,
    gridEl: null
  };
  const T = document.getElementById("audio-player");
  let U = false;
  let V = new Set();
  let W = null;
  let X = false;
  let Y = new Set();
  let Z = false;
  let $ = 0;
  let _ = null;
  let aa = false;
  let ba = "all";
  let ca = new Set();
  let da = null;
  let ea = false;
  let fa = null;
  let ga = null;
  let ha = false;
  let ia = false;
  let ja = false;
  let ka = false;
  let la = [];
  let ma = null;
  let na = null;
  let oa = {};
  let pa = "group";
  let qa = null;
  let ra = null;
  let sa = null;
  let ta = null;
  let ua = null;
  let va = null;
  let wa = null;
  let xa = null;
  let ya = [];
  let za = null;
  let Aa = null;
  let Ba = new Set();
  let Ca = "all";
  let Da = null;
  let Ea = null;
  let Fa = null;
  let Ga = {
    isOpen: false,
    photos: [],
    currentIndex: -1
  };
  let Ha = 0;
  let Ia = false;
  let Ja = new Set();
  let Ka = null;
  let La = new Date();
  let Ma = null;
  const Na = "https://i.postimg.cc/PxZrFFFL/o-o-1.jpg";
  const Oa = "https://i.postimg.cc/cLPP10Vm/4.jpg";
  const Pa = "https://i.postimg.cc/VkQfgzGJ/1.jpg";
  const Qa = "https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg";
  let Ra;
  let Sa = {};
  const Ta = "https://www.myinstants.com/media/sounds/notification-sound-2.mp3";
  let Ua = {};
  let Va = {};
  let Wa = null;
  const Xa = {
    qq: "https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg",
    "world-book": "https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg",
    wallpaper: "https://i.postimg.cc/T1j03pQr/IMG-6440.jpg",
    renderer: "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg",
    "api-settings": "https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg",
    font: "https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",
    "char-phone": "https://i.postimg.cc/pXj9h20L/IMG-7275.jpg",
    douban: "https://i.postimg.cc/Pq2xJN1g/IMG-7301.jpg",
    preset: "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg",
    tutorial: "https://i.postimg.cc/d10GjC4g/IMG-7302.jpg",
    werewolf: "https://i.postimg.cc/k401K5g7/IMG-7304.jpg",
    x: "https://i.postimg.cc/Y9d3BztC/1.png",
    alipay: "https://i.postimg.cc/Hs7BLh76/alipay.png",
    auction: "https://i.postimg.cc/Hs7BLh76/alipay.png",
    "green-river": "https://i.postimg.cc/0j55Pj1L/green-river-icon.png",
    mail: "https://i.postimg.cc/PfR7f37x/mail.png"
  };
  const Ya = {
    qq: "https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg",
    album: "https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg",
    browser: "https://i.postimg.cc/KzC2gTq6/IMG-7276.jpg",
    taobao: "https://i.postimg.cc/L6R7x16R/IMG-7278.jpg",
    memo: "https://i.postimg.cc/J0b6Nym4/IMG-7279.jpg",
    diary: "https://i.postimg.cc/DZ541sbt/IMG-7280.jpg",
    amap: "https://i.postimg.cc/Jz2Tz0dw/IMG-7281.jpg",
    usage: "https://i.postimg.cc/WbF8kzz9/IMG-7282.jpg",
    music: "https://is1-ssl.mzstatic.com/image/thumb/Purple112/v4/64/9d/21/649d21e8-a151-6136-3914-256e54f15d9a/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/1200x630wa.png",
    bilibili: "https://i.postimg.cc/Wz5gV0jB/bilibili-icon.png",
    reddit: "https://www.redditinc.com/assets/images/site/reddit-logo.png",
    ephone: "https://i.postimg.cc/pXj9h20L/IMG-7275.jpg"
  };
  let Za = null;
  const $a = /(^https:\/\/i\.postimg\.cc\/.+|^https:\/\/files\.catbox\.moe\/.+|^https?:\/\/sharkpan\.xyz\/.+|^data:image|\.(png|jpg|jpeg|gif|webp)\?.*$|\.(png|jpg|jpeg|gif|webp)$)/i;
  let _a = 0;
  let ab = 1;
  let bb = {
    hasShown40: false,
    hasShown20: false,
    hasShown10: false
  };
  let cb;
  const db = document.createElement("style");
  db.id = "dynamic-font-style";
  document.head.appendChild(db);
  const eb = document.getElementById("custom-modal-overlay");
  const fb = document.getElementById("custom-modal-title");
  const gb = document.getElementById("custom-modal-body");
  const hb = document.getElementById("custom-modal-confirm");
  const ib = document.getElementById("custom-modal-cancel");
  let jb;
  function kb() {
    eb.classList.add("visible");
  }
  function lb() {
    eb.classList.remove("visible");
    hb.classList.remove("btn-danger");
    if (jb) {
      jb(null);
    }
  }
  function mb(a) {
    const b = document.getElementById("global-lyrics-bar");
    const c = a.settings.lyricsPosition || {
      vertical: "top",
      horizontal: "center",
      offset: 10
    };
    b.style.top = "auto";
    b.style.bottom = "auto";
    b.style.left = "auto";
    b.style.right = "auto";
    b.style.transform = "none";
    if (c.vertical === "top") {
      b.style.top = c.offset + "px";
    } else {
      b.style.bottom = c.offset + "px";
    }
    switch (c.horizontal) {
      case "left":
        b.style.left = "15px";
        break;
      case "right":
        b.style.right = "15px";
        break;
      case "center":
      default:
        b.style.left = "50%";
        b.style.transform = "translateX(-50%)";
        break;
    }
  }
  async function nb(a) {
    const b = a.target.files[0];
    if (!b) {
      return;
    }
    let c = await new Promise(a => {
      const c = new FileReader();
      c.onload = () => a(c.result);
      c.readAsDataURL(b);
    });
    try {
      const b = await Db("å‘½åç¾¤å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªæ–°ç¾¤å¤´åƒå‘½å");
      if (!b || !b.trim()) {
        await Bb("æ“ä½œå–æ¶ˆ", "ä½ æ²¡æœ‰è¾“å…¥åç§°ï¼Œå·²å–æ¶ˆä¸Šä¼ ã€‚");
        a.target.value = null;
        return;
      }
      const d = v.chats[v.activeChatId];
      if (!d.settings.groupAvatarLibrary) {
        d.settings.groupAvatarLibrary = [];
      }
      const e = {
        name: b,
        url: c
      };
      d.settings.groupAvatarLibrary.push(e);
      await Gb.chats.put(d);
      Pg();
      await Bb("ä¸Šä¼ æˆåŠŸï¼", "ç¾¤å¤´åƒå·²å‘½åä¸ºï¼šâ€œ" + b + `â€

å›¾ç‰‡å°†åœ¨åŽå°é™é»˜ä¸Šä¼ åˆ°å›¾åºŠ...`);
      (async () => {
        await K(Gb.chats, d.id, "settings.groupAvatarLibrary", c, b);
      })();
    } catch (a) {
      console.error("æœ¬åœ°ç¾¤å¤´åƒä¸Šä¼ åŠè¯†åˆ«å¤±è´¥:", a);
      await Bb("æ“ä½œå¤±è´¥", "ä¸Šä¼ æ—¶å‘ç”Ÿé”™è¯¯ã€‚\né”™è¯¯: " + a.message);
    } finally {
      a.target.value = null;
    }
  }
  async function ob(a) {
    const b = a.target.files[0];
    if (!b) {
      return;
    }
    let c = await new Promise(a => {
      const c = new FileReader();
      c.onload = () => a(c.result);
      c.readAsDataURL(b);
    });
    try {
      const b = await Db("å‘½åå¤´åƒ", "è¯·ä¸ºè¿™ä¸ªæ–°å¤´åƒå‘½å");
      if (!b || !b.trim()) {
        await Bb("æ“ä½œå–æ¶ˆ", "ä½ æ²¡æœ‰è¾“å…¥åç§°ï¼Œå·²å–æ¶ˆä¸Šä¼ ã€‚");
        a.target.value = null;
        return;
      }
      const d = v.chats[v.activeChatId];
      if (!d.settings.aiAvatarLibrary) {
        d.settings.aiAvatarLibrary = [];
      }
      const e = {
        name: b,
        url: c
      };
      d.settings.aiAvatarLibrary.push(e);
      await Gb.chats.put(d);
      Fg();
      await Bb("ä¸Šä¼ æˆåŠŸï¼", "å¤´åƒå·²å‘½åä¸ºï¼šâ€œ" + b + `â€

å›¾ç‰‡å°†åœ¨åŽå°é™é»˜ä¸Šä¼ åˆ°å›¾åºŠ...`);
      (async () => {
        await K(Gb.chats, d.id, "settings.aiAvatarLibrary", c, b);
      })();
    } catch (a) {
      console.error("æœ¬åœ°å¤´åƒä¸Šä¼ åŠè¯†åˆ«å¤±è´¥:", a);
      await Bb("æ“ä½œå¤±è´¥", "ä¸Šä¼ æ—¶å‘ç”Ÿé”™è¯¯ã€‚\né”™è¯¯: " + a.message);
    } finally {
      a.target.value = null;
    }
  }
  async function pb(a) {
    const b = v.apiConfig.secondaryProxyUrl && v.apiConfig.secondaryApiKey && v.apiConfig.secondaryModel;
    const {
      proxyUrl: c,
      apiKey: d,
      model: e
    } = b ? {
      proxyUrl: v.apiConfig.secondaryProxyUrl,
      apiKey: v.apiConfig.secondaryApiKey,
      model: v.apiConfig.secondaryModel
    } : v.apiConfig;
    if (!c || !d || !e) {
      throw new Error("ä¸»APIå’Œå‰¯APIå‡æœªé…ç½®æˆ–é…ç½®ä¸å®Œæ•´ã€‚");
    }
    const f = "è¯·ä¸ºè¿™å¼ å›¾ç‰‡èµ·ä¸€ä¸ªç®€æ´çš„ã€é€‚åˆä½œä¸ºå¤´åƒåº“æ ‡ç­¾çš„åå­—ã€‚ä¾‹å¦‚ï¼šâ€œå¾®ç¬‘è‡ªæ‹â€ã€â€œé˜³å…‰ä¸‹çš„çŒ«å’ªâ€ã€â€œè“å‘åŠ¨æ¼«å°‘å¥³â€ã€‚è¯·ç›´æŽ¥å›žç­”åå­—ï¼Œä¸è¦åŠ ä»»ä½•å¤šä½™çš„è§£é‡Šã€‚";
    let g = c.includes("generativelanguage");
    let h;
    if (g) {
      const b = a.match(/^data:(.*);base64/)[1];
      const g = a.split(",")[1];
      const i = {
        contents: [{
          parts: [{
            text: f
          }, {
            inline_data: {
              mime_type: b,
              data: g
            }
          }]
        }]
      };
      h = await fetch(c + "/" + e + ":generateContent?key=" + d, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(i)
      });
    } else {
      const b = {
        model: e,
        messages: [{
          role: "user",
          content: [{
            type: "text",
            text: f
          }, {
            type: "image_url",
            image_url: {
              url: a
            }
          }]
        }],
        max_tokens: 50
      };
      h = await fetch(c + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + d
        },
        body: JSON.stringify(b)
      });
    }
    if (!h.ok) {
      const a = await h.json();
      throw new Error("API é”™è¯¯: " + a.error.message);
    }
    const i = await h.json();
    let j = g ? C(i) : i.choices[0].message.content;
    return j.trim().replace(/["'â€œâ€â€˜â€™]/g, "");
  }
  async function qb(a) {
    if (!a || a.isGroup) {
      console.warn("syncCharacterNameInGroups: ä¼ å…¥çš„ä¸æ˜¯æœ‰æ•ˆçš„å•èŠå¯¹è±¡ï¼Œå·²è·³è¿‡åŒæ­¥ã€‚");
      return;
    }
    const b = a.id;
    const c = a.name;
    const d = a.originalName;
    console.log("æ­£åœ¨ä¸ºè§’è‰² " + b + " åŒæ­¥æ‰€æœ‰ç¾¤èŠå†…çš„åç§°ä¿¡æ¯...");
    for (const e in v.chats) {
      const a = v.chats[e];
      if (a.isGroup && a.members) {
        const e = a.members.find(a => a.id === b);
        if (e) {
          let b = false;
          if (e.groupNickname !== c) {
            e.groupNickname = c;
            b = true;
          }
          if (e.originalName !== d) {
            e.originalName = d;
            b = true;
          }
          if (b) {
            await Gb.chats.put(a);
            console.log("æˆåŠŸå°†ç¾¤èŠ \"" + a.name + "\" ä¸­çš„æˆå‘˜ä¿¡æ¯æ›´æ–°");
          }
        }
      }
    }
  }
  async function rb(a) {
    if (!a || a.isGroup) {
      console.warn("syncCharacterAvatarInGroups: ä¼ å…¥çš„ä¸æ˜¯æœ‰æ•ˆçš„å•èŠå¯¹è±¡ï¼Œå·²è·³è¿‡åŒæ­¥ã€‚");
      return;
    }
    const b = a.id;
    const c = a.settings.aiAvatar;
    console.log("æ­£åœ¨ä¸ºè§’è‰² " + b + " åŒæ­¥æ‰€æœ‰ç¾¤èŠå†…çš„å¤´åƒ...");
    for (const d of Object.values(v.chats)) {
      if (d.isGroup && d.members) {
        const a = d.members.find(a => a.id === b);
        if (a && a.avatar !== c) {
          a.avatar = c;
          await Gb.chats.put(d);
          console.log("æˆåŠŸå°†è§’è‰² " + b + " çš„æ–°å¤´åƒåŒæ­¥åˆ°ç¾¤èŠ \"" + d.name + "\"");
        }
      }
    }
  }
  function sb(a, b) {
    if (!a || !a.isGroup || !b) {
      return b;
    }
    const c = v.qzoneSettings.nickname || "{{user}}";
    if (b === c) {
      return a.settings.myNickname || "æˆ‘";
    }
    const d = a.members.find(a => a.originalName === b);
    if (d) {
      return d.groupNickname;
    } else {
      return b;
    }
  }
  function tb(a) {
    document.querySelectorAll(".rules-tab").forEach(b => {
      b.classList.toggle("active", b.dataset.categoryId === a);
    });
    document.querySelectorAll(".rules-category-pane").forEach(b => {
      b.classList.toggle("active", b.dataset.categoryId === a);
    });
  }
  function ub(a) {
    if (!a) {
      return "";
    }
    if (v.qzoneSettings && a === v.qzoneSettings.nickname) {
      return v.qzoneSettings.nickname;
    }
    let b = Object.values(v.chats).find(b => !b.isGroup && b.originalName === a);
    if (b) {
      return b.name;
    }
    b = Object.values(v.chats).find(b => !b.isGroup && b.nameHistory && b.nameHistory.includes(a));
    if (b) {
      return b.name;
    }
    return a;
  }
  function vb(a, b = null) {
    if (!a || typeof a !== "string" || !a.includes("@[[")) {
      return a;
    }
    return a.replace(/@\[\[([^\]]+)\]\]/g, (a, c) => {
      const d = c.trim();
      let e;
      if (b && b.isGroup) {
        e = sb(b, d);
      } else {
        e = ub(d);
      }
      return "@" + e;
    });
  }
  function wb(a, b, c = {}) {
    return new Promise(d => {
      jb = d;
      fb.textContent = a;
      gb.innerHTML = "<p>" + b + "</p>";
      const e = document.querySelector("#custom-modal .custom-modal-footer");
      if (e) {
        e.style.flexDirection = "row";
        e.style.justifyContent = "flex-end";
        e.innerHTML = `
              <button id="custom-modal-cancel">å–æ¶ˆ</button>
              <button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
          `;
      }
      const f = document.getElementById("custom-modal-confirm");
      const g = document.getElementById("custom-modal-cancel");
      g.style.display = "block";
      f.textContent = c.confirmText || "ç¡®å®š";
      g.textContent = c.cancelText || "å–æ¶ˆ";
      if (c.confirmButtonClass) {
        f.className = "confirm-btn " + c.confirmButtonClass;
      } else {
        f.className = "confirm-btn";
      }
      f.onclick = () => {
        d(true);
        lb();
      };
      g.onclick = () => {
        d(false);
        lb();
      };
      kb();
    });
  }
  function xb(a = "ðŸ“¥ å›¾ç‰‡ä¸‹è½½ä¸­...", b = "success") {
    const c = document.createElement("div");
    c.textContent = a;
    c.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: ` + (b === "success" ? "#4CAF50" : "#f44336") + `;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 14px;
        pointer-events: none;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
    `;
    document.body.appendChild(c);
    // TOLOOK
    setTimeout(() => {
      c.style.opacity = "1";
      c.style.transform = "translateY(0)";
    }, 10);
    // TOLOOK
    setTimeout(() => {
      c.style.opacity = "0";
      c.style.transform = "translateY(-20px)";
      // TOLOOK
      setTimeout(() => {
        c.remove();
      }, 300);
    }, 2000);
  }
  function yb(a) {
    let b = (a || "NAI_Image").replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, "_").replace(/\s+/g, "_").substring(0, 30);
    const c = new Date().toISOString().replace(/[-:]/g, "").replace("T", "_").split(".")[0];
    return b + "_" + c + ".png";
  }
  function zb(a, b) {
    try {
      const c = yb(b);
      const d = document.createElement("a");
      d.href = a;
      d.download = c;
      d.style.display = "none";
      document.body.appendChild(d);
      d.click();
      // TOLOOK
      setTimeout(() => {
        document.body.removeChild(d);
      }, 100);
      xb("ðŸ“¥ å›¾ç‰‡ä¸‹è½½ä¸­...");
    } catch (a) {
      console.error("âŒ [NAIä¸‹è½½] ä¸‹è½½å¤±è´¥:", a);
      xb("ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•", "error");
    }
  }
  function Ab(a, b = "info", c = 3000) {
    let d = document.querySelector(".toast-container");
    if (!d) {
      d = document.createElement("div");
      d.className = "toast-container";
      document.body.appendChild(d);
    }
    const e = {
      success: "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"20 6 9 17 4 12\"></polyline></svg>",
      loading: "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83\"></path></svg>",
      error: "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"></circle><line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"12\"></line><line x1=\"12\" y1=\"16\" x2=\"12.01\" y2=\"16\"></line></svg>",
      info: "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"></circle><line x1=\"12\" y1=\"16\" x2=\"12\" y2=\"12\"></line><line x1=\"12\" y1=\"8\" x2=\"12.01\" y2=\"8\"></line></svg>"
    };
    const f = e[b] || e.info;
    const g = b === "loading" ? "spinning" : "";
    const h = a.length > 25 ? a.substring(0, 24) + "..." : a;
    const i = document.createElement("div");
    i.className = "toast-item";
    i.innerHTML = "\n        <div class=\"toast-icon " + g + "\">" + f + "</div>\n        <span>" + h + "</span>\n    ";
    d.appendChild(i);
    requestAnimationFrame(() => {
      i.classList.add("visible");
    });
    if (b !== "loading") {
      // TOLOOK
      setTimeout(() => {
        i.classList.remove("visible");
        // TOLOOK
        setTimeout(() => i.remove(), 400);
      }, c);
    }
    return i;
  }
  function Bb(a, b) {
    return new Promise(c => {
      jb = c;
      fb.textContent = a;
      gb.innerHTML = "<p style=\"text-align: left; white-space: pre-wrap;\">" + b + "</p>";
      const d = document.querySelector("#custom-modal .custom-modal-footer");
      if (d) {
        d.style.flexDirection = "row";
        d.innerHTML = `
              <button id="custom-modal-cancel">å–æ¶ˆ</button>
              <button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
          `;
      }
      const e = document.getElementById("custom-modal-confirm");
      const f = document.getElementById("custom-modal-cancel");
      if (f) {
        f.style.display = "none";
      }
      if (e) {
        e.textContent = "å¥½çš„";
      }
      if (e) {
        e.onclick = () => {
          if (f) {
            f.style.display = "block";
          }
          e.textContent = "ç¡®å®š";
          c(true);
          lb();
        };
      }
      if (f) {
        f.onclick = lb;
      }
      kb();
    });
  }
  async function Cb(a, b = "å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼") {
    if (!a) {
      await Bb("å¤åˆ¶å¤±è´¥", "æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹ã€‚");
      return;
    }
    try {
      await navigator.clipboard.writeText(a);
      await Bb("å¤åˆ¶æˆåŠŸ", b);
    } catch (a) {
      console.error("å¤åˆ¶å¤±è´¥:", a);
      await Bb("å¤åˆ¶å¤±è´¥", "æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚");
    }
  }
  function Db(a, b, c = "", d = "text", e = "") {
    return new Promise(f => {
      jb = f;
      fb.textContent = a;
      const g = "custom-prompt-input";
      const h = d === "textarea" ? "<textarea id=\"" + g + "\" placeholder=\"" + b + "\" rows=\"4\" style=\"width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; resize: vertical;\">" + c + "</textarea>" : "<input type=\"" + d + "\" id=\"" + g + "\" placeholder=\"" + b + "\" value=\"" + c + "\">";
      gb.innerHTML = e + h;
      const i = document.getElementById(g);
      gb.querySelectorAll(".format-btn").forEach(a => {
        a.addEventListener("click", () => {
          const b = a.dataset.template;
          if (b) {
            try {
              const a = JSON.parse(b);
              i.value = JSON.stringify(a, null, 2);
              i.focus();
            } catch (a) {
              console.error("è§£æžæ ¼å¼æ¨¡æ¿å¤±è´¥:", a);
            }
          }
        });
      });
      const j = document.querySelector("#custom-modal .custom-modal-footer");
      if (j) {
        j.style.flexDirection = "row";
        j.style.justifyContent = "flex-end";
        j.style.maxHeight = "";
        j.style.overflowY = "";
        j.innerHTML = `
            <button id="custom-modal-cancel">å–æ¶ˆ</button>
            <button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
          `;
      }
      const k = document.getElementById("custom-modal-confirm");
      const l = document.getElementById("custom-modal-cancel");
      if (k) {
        k.textContent = "ç¡®å®š";
        k.className = "confirm-btn";
        k.style.display = "block";
        k.onclick = () => {
          f(i.value);
          lb();
        };
      }
      if (l) {
        l.textContent = "å–æ¶ˆ";
        l.style.display = "block";
        l.onclick = () => {
          f(null);
          lb();
        };
      }
      kb();
      // TOLOOK
      setTimeout(() => {
        if (i) {
          i.focus();
        }
      }, 100);
    });
  }
  function Eb(a, b) {
    return new Promise(c => {
      const d = document.getElementById("custom-modal-overlay");
      const e = document.getElementById("custom-modal-title");
      const f = document.getElementById("custom-modal-body");
      const g = document.querySelector("#custom-modal .custom-modal-footer");
      e.textContent = a;
      f.innerHTML = "";
      g.innerHTML = "";
      g.style.flexDirection = "column";
      g.style.maxHeight = "50vh";
      g.style.overflowY = "auto";
      g.style.webkitOverflowScrolling = "touch";
      g.style.overscrollBehavior = "contain";
      g.style.padding = "10px";
      g.style.gap = "8px";
      let h = 0;
      const i = 10;
      const j = document.createElement("button");
      j.textContent = "åŠ è½½æ›´å¤š...";
      j.style.cssText = "background-color: #f0f0f0; color: #666; margin-top: 8px; width: 100%; border-radius: 8px; padding: 10px; border: none;";
      j.style.display = "none";
      const k = () => {
        const a = b.slice(h, h + i);
        a.forEach(a => {
          const b = document.createElement("button");
          b.innerHTML = a.text;
          b.className = "payment-option-item";
          b.style.width = "100%";
          b.style.textAlign = "left";
          b.style.padding = "12px 15px";
          b.style.marginBottom = "0";
          b.onclick = () => {
            d.classList.remove("visible");
            c(a.value);
          };
          g.insertBefore(b, j);
        });
        h += a.length;
        if (h < b.length) {
          j.style.display = "block";
          j.textContent = "åŠ è½½æ›´å¤š (" + (b.length - h) + " ä¸ªå‰©ä½™)";
        } else {
          j.style.display = "none";
        }
      };
      j.onclick = a => {
        a.stopPropagation();
        k();
      };
      g.appendChild(j);
      k();
      const l = document.createElement("button");
      l.textContent = "å–æ¶ˆ";
      l.style.marginTop = "15px";
      l.style.borderRadius = "8px";
      l.style.backgroundColor = "#fff";
      l.style.border = "1px solid #ddd";
      l.style.color = "#666";
      l.style.padding = "12px";
      l.style.width = "100%";
      l.onclick = () => {
        d.classList.remove("visible");
        c(null);
      };
      g.appendChild(l);
      d.classList.add("visible");
    }).finally(() => {});
  }
  async function Fb() {
    const a = await Eb("é€‰æ‹©æ­Œè¯å¯¼å…¥æ–¹å¼", [{
      text: "ðŸ“ ä»Žæœ¬åœ°æ–‡ä»¶ (.lrc)",
      value: "file"
    }, {
      text: "ðŸ“‹ ç›´æŽ¥ç²˜è´´æ­Œè¯æ–‡æœ¬",
      value: "paste"
    }]);
    if (a === "file") {
      return new Promise(a => {
        const b = document.getElementById("lrc-upload-input");
        const c = d => {
          const e = d.target.files[0];
          if (e) {
            const b = new FileReader();
            b.onload = b => a(b.target.result);
            b.onerror = () => a("");
            b.readAsText(e);
          } else {
            a(null);
          }
          b.removeEventListener("change", c);
          b.value = "";
        };
        b.addEventListener("change", c, {
          once: true
        });
        b.click();
      });
    } else if (a === "paste") {
      const a = await Db("ç²˜è´´æ­Œè¯", "è¯·åœ¨æ­¤å¤„ç²˜è´´å®Œæ•´çš„LRCæ ¼å¼æ­Œè¯...", "", "textarea");
      if (a) {
        const b = a.replace(/\[/g, "\n[").trim();
        return b;
      }
      return a;
    } else {
      return null;
    }
  }
  var Gb;
  async function Hb() {
    if (navigator.storage && navigator.storage.persist) {
      const a = await navigator.storage.persisted();
      if (a) {
        console.log("âœ… [System] Storage is already persisted. (å­˜å‚¨å·²æŒä¹…åŒ–)");
        return true;
      }
      const b = await navigator.storage.persist();
      if (b) {
        console.log("âœ… [System] Storage permission granted. (æŒä¹…åŒ–æŽˆæƒæˆåŠŸ)");
        if (typeof Ab === "function") {}
      } else {
        console.warn("âš ï¸ [System] Storage permission denied. (æŒä¹…åŒ–è¢«æ‹’ç»ï¼Œç©ºé—´ä¸è¶³æ—¶å¯èƒ½ä¼šè¢«æ¸…ç†)");
      }
      return b;
    } else {
      console.log("â„¹ï¸ [System] Storage persistence API not supported.");
      return false;
    }
  }
  async function Ib() {
    if (navigator.storage && navigator.storage.estimate) {
      const a = await navigator.storage.estimate();
      const b = (a.usage / 1024 / 1024).toFixed(2);
      const c = (a.quota / 1024 / 1024).toFixed(2);
      console.log("ðŸ“Š [Storage] å·²ç”¨: " + b + " MB / å¯ç”¨: " + c + " MB");
    }
  }
  function Jb(a) {
    Gb = new Dexie("GeminiChatDB");
    Gb.version(49).stores({
      doubanPosts: "++id, timestamp",
      chats: "&id, isGroup, groupId, isPinned, memos, diary, appUsageLog, lastIntelligentSummaryTimestamp",
      apiConfig: "&id, minimaxGroupId, minimaxApiKey",
      globalSettings: "&id",
      userStickers: "&id, url, name, categoryId",
      worldBooks: "&id, name, categoryId",
      worldBookCategories: "++id, name",
      musicLibrary: "&id",
      personaPresets: "&id",
      qzoneSettings: "&id",
      qzonePosts: "++id, timestamp, authorId",
      qzoneAlbums: "++id, name, createdAt",
      qzonePhotos: "++id, albumId",
      favorites: "++id, type, timestamp, originalTimestamp",
      qzoneGroups: "++id, name",
      memories: "++id, chatId, timestamp, type, targetDate",
      callRecords: "++id, chatId, timestamp, customName",
      shoppingProducts: "++id, name, description",
      shoppingCategories: "++id, name",
      apiPresets: "++id, name",
      renderingRules: "++id, name, chatId",
      appearancePresets: "++id, name, type",
      stickerCategories: "++id, name",
      customAvatarFrames: "++id, name",
      presets: "&id, name, categoryId",
      presetCategories: "++id, name",
      readingLibrary: "++id, title, lastOpened, linkedStoryId",
      quickReplies: "++id, text, categoryId",
      quickReplyCategories: "++id, name",
      npcs: "++id, name, npcGroupId, enableBackgroundActivity, actionCooldownMinutes, lastActionTimestamp",
      npcGroups: "++id, name",
      naiPresets: "++id, name",
      grAuthors: "++id, name",
      grStories: "++id, title, authorId, lastUpdated",
      userWallet: "&id",
      userTransactions: "++id, timestamp, type, amount, description",
      funds: "&id, code, name, riskLevel, currentNav, lastDayNav, history",
      auctions: "++id, status, itemName, endTime",
      inventory: "++id, name, type, acquiredTime",
      emails: "++id, sender, senderType, recipient, subject, content, timestamp, isRead"
    }).upgrade(a => {
      return a.table("worldBooks").toCollection().modify(a => {
        if (typeof a.content === "string" && a.content.trim() !== "") {
          a.content = [{
            keys: [],
            comment: "ä»Žæ—§ç‰ˆæœ¬è¿ç§»çš„æ¡ç›®",
            content: a.content
          }];
        } else if (!Array.isArray(a.content)) {
          a.content = [];
        }
        a.content.forEach(a => {
          if (typeof a.enabled === "undefined") {
            a.enabled = true;
          }
        });
      });
    });
    window.db = Gb;
    console.log("[System] å·²åŠ è½½ç”¨æˆ· " + a + " çš„æ•°æ®åº“");
    Hb().then(() => {
      Ib();
    });
  }
  function Kb(a) {
    if (a === "chat-list-screen") {
      window.renderChatListProxy();
      Lb("messages-view");
    }
    if (a === "api-settings-screen") {
      window.renderApiSettingsProxy();
    }
    if (a === "wallpaper-screen") {
      window.renderWallpaperScreenProxy();
    }
    if (a === "world-book-screen") {
      window.renderWorldBookScreenProxy();
    }
    if (a === "x-social-screen") {
      window.renderXSocialScreenProxy();
    }
    if (a === "douban-screen") {
      Ml();
    }
    document.querySelectorAll(".screen").forEach(a => a.classList.remove("active"));
    const b = document.getElementById(a);
    if (b) {
      b.classList.add("active");
    }
    if (a === "chat-interface-screen") {
      window.updateListenTogetherIconProxy(v.activeChatId);
    }
    if (a === "font-settings-screen") {
      nk();
      document.getElementById("font-url-input").value = v.globalSettings.fontUrl || "";
      kc(v.globalSettings.fontUrl || "", true);
    }
  }
  window.updateListenTogetherIconProxy = () => {};
  function Lb(a) {
    const b = document.getElementById("chat-list-screen");
    const c = {
      "messages-view": document.getElementById("messages-view"),
      "qzone-screen": document.getElementById("qzone-screen"),
      "favorites-view": document.getElementById("favorites-view"),
      "memories-view": document.getElementById("memories-view"),
      "npc-list-view": document.getElementById("npc-list-view")
    };
    const d = document.getElementById("main-chat-list-header");
    const e = document.getElementById("chat-list-bottom-nav");
    if (Ia) {
      document.getElementById("favorites-edit-btn").click();
    }
    Object.values(c).forEach(a => a.classList.remove("active"));
    if (c[a]) {
      c[a].classList.add("active");
    }
    document.querySelectorAll("#chat-list-bottom-nav .nav-item").forEach(b => {
      b.classList.toggle("active", b.dataset.view === a);
    });
    if (a === "messages-view") {
      d.style.display = "flex";
      e.style.display = "flex";
    } else {
      d.style.display = "none";
      e.style.display = "none";
    }
    if (a !== "memories-view") {
      ng.forEach(a => clearInterval(a));
      ng = [];
    }
    switch (a) {
      case "qzone-screen":
        c["qzone-screen"].style.backgroundColor = "#f0f2f5";
        Te(0);
        Nb();
        Sb();
        break;
      case "favorites-view":
        c["favorites-view"].style.backgroundColor = "#f9f9f9";
        _b();
        break;
      case "messages-view":
        break;
      case "npc-list-view":
        Qc();
        break;
    }
  }
  function Mb() {
    console.log("æ¸²æŸ“Xç¤¾äº¤é¡µé¢");
  }
  window.renderXSocialScreenProxy = Mb;
  function Nb() {
    if (v && v.qzoneSettings) {
      const a = v.qzoneSettings;
      document.getElementById("qzone-nickname").textContent = a.nickname;
      document.getElementById("qzone-avatar-img").src = a.avatar;
      document.getElementById("qzone-banner-img").src = a.banner;
    }
  }
  window.renderQzoneScreenProxy = Nb;
  async function Ob() {
    if (Gb && v.qzoneSettings) {
      await Gb.qzoneSettings.put(v.qzoneSettings);
    }
  }
  function Pb(a) {
    if (!a) {
      return "";
    }
    const b = new Date();
    const c = new Date(a);
    const d = Math.floor((b - c) / 1000);
    const e = Math.floor(d / 60);
    const f = Math.floor(e / 60);
    if (e < 1) {
      return "åˆšåˆš";
    }
    if (e < 60) {
      return e + "åˆ†é’Ÿå‰";
    }
    if (f < 24) {
      return f + "å°æ—¶å‰";
    }
    const g = c.getFullYear();
    const h = String(c.getMonth() + 1).padStart(2, "0");
    const i = String(c.getDate()).padStart(2, "0");
    const j = String(c.getHours()).padStart(2, "0");
    const k = String(c.getMinutes()).padStart(2, "0");
    if (b.getFullYear() === g) {
      return h + "-" + i + " " + j + ":" + k;
    } else {
      return g + "-" + h + "-" + i + " " + j + ":" + k;
    }
  }
  async function Qb(a) {
    const b = document.querySelector(".qzone-post-container[data-post-id=\"" + a.id + "\"]");
    const c = !!b;
    const d = c ? b : document.createElement("div");
    if (!c) {
      d.className = "qzone-post-container";
      d.dataset.postId = a.id;
    }
    const e = c ? d.querySelector(".qzone-post-item") : document.createElement("div");
    if (!c) {
      e.className = "qzone-post-item";
    }
    let f = "";
    let g = "";
    let h = v.qzoneSettings.avatar;
    if (a.authorId === "user") {
      f = v.qzoneSettings.avatar;
      g = v.qzoneSettings.nickname;
    } else if (v.chats[a.authorId]) {
      const b = v.chats[a.authorId];
      f = b.settings.aiAvatar || Na;
      g = b.name;
    } else if (String(a.authorId).startsWith("npc_")) {
      const b = parseInt(String(a.authorId).replace("npc_", ""));
      if (!isNaN(b)) {
        const c = await Gb.npcs.get(b);
        if (c) {
          f = c.avatar || Pa;
          g = c.name;
        } else {
          g = a.authorOriginalName || "æœªçŸ¥NPC";
          f = Pa;
        }
      }
    } else {
      g = ub(a.authorOriginalName);
      f = Na;
    }
    function i(a) {
      let b = "";
      const c = a.publicText ? "<div class=\"post-content\">" + si(a.publicText).replace(/\n/g, "<br>") + "</div>" : "";
      if (a.type === "shuoshuo") {
        b = "<div class=\"post-content\" style=\"margin-bottom: 10px;\">" + si(a.content).replace(/\n/g, "<br>") + "</div>";
      } else if (a.type === "image_post" && a.imageUrl) {
        b = c ? c + "<div style=\"margin-top:10px;\"><img src=\"" + a.imageUrl + "\" class=\"chat-image\"></div>" : "<img src=\"" + a.imageUrl + "\" class=\"chat-image\">";
      } else if (a.type === "text_image") {
        const d = v.globalSettings.enableAiDrawing && a.image_prompt ? "https://image.pollinations.ai/prompt/" + a.image_prompt : "https://i.postimg.cc/KYr2qRCK/1.jpg";
        b = c ? c + "<div style=\"margin-top:10px;\"><img src=\"" + d + "\" class=\"chat-image\" style=\"cursor: pointer;\" data-hidden-text=\"" + a.hiddenContent + "\"></div>" : "<img src=\"" + d + "\" class=\"chat-image\" style=\"cursor: pointer;\" data-hidden-text=\"" + a.hiddenContent + "\">";
      } else if (a.type === "naiimag") {
        const d = a.imageUrls || (a.imageUrl ? [a.imageUrl] : []);
        if (d.length > 0) {
          const a = d.length;
          let e = "";
          e = "<div class=\"post-images-grid grid-" + a + "\">";
          d.forEach((a, b) => {
            e += "<img src=\"" + a + "\" class=\"naiimag-image\" alt=\"å›¾ç‰‡" + (b + 1) + "\" loading=\"lazy\" onerror=\"this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥';\">";
          });
          e += "</div>";
          b = c ? "" + c + e : e;
        }
      }
      return b;
    }
    let j;
    if (a.type === "repost") {
      const b = a.repostComment ? "<div class=\"post-content\">" + a.repostComment.replace(/\n/g, "<br>") + "</div>" : "";
      let c = Na;
      let d = "åŽŸä½œè€…";
      if (a.originalPost.authorId === "user") {
        c = v.qzoneSettings.avatar;
        d = v.qzoneSettings.nickname;
      } else {
        const b = v.chats[a.originalPost.authorId];
        if (b) {
          c = b.settings.aiAvatar || Na;
        }
        d = ub(a.originalPost.authorOriginalName);
      }
      j = "\n                    " + b + `
                    <div class="reposted-content-wrapper">
                        <div class="post-header">
                            <img src="` + c + `" class="post-avatar">
                            <div class="post-info">
                                <span class="post-nickname">@` + d + "</span>\n                                <span class=\"post-timestamp\">" + Pb(a.originalPost.timestamp) + `</span>
                            </div>
                        </div>
                        <div class="post-main-content">` + i(a.originalPost) + `</div>
                    </div>
                `;
    } else {
      j = "<div class=\"post-main-content\">" + i(a) + "</div>";
    }
    let k = "";
    if (a.likes && a.likes.length > 0) {
      const b = a.likes.map(a => ub(a)).join("ã€");
      k = "<div class=\"post-likes-section\"><svg class=\"like-icon\" viewBox=\"0 0 24 24\"><path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path></svg><span>" + b + " è§‰å¾—å¾ˆèµž</span></div>";
    }
    let l = "";
    if (a.comments && a.comments.length > 0) {
      l = "<div class=\"post-comments-container\">";
      a.comments.forEach((b, c) => {
        if (typeof b === "object" && b !== null && b.commenterName) {
          const d = b.commenterName;
          const e = ub(d);
          let f;
          if ($a.test(b.text)) {
            f = "<img src=\"" + b.text + "\" class=\"comment-sticker\" alt=\"sticker\">";
          } else {
            f = si(b.text);
          }
          let g = "";
          if (b.replyTo) {
            const a = ub(b.replyTo);
            g = "<span class=\"commenter-name\">" + e + "</span> å›žå¤ <span class=\"commenter-name\">" + a + "</span>: " + f;
          } else {
            g = "<span class=\"commenter-name\">" + e + "</span>: " + f;
          }
          l += "<div class=\"comment-item\" data-post-id=\"" + a.id + "\" data-commenter-original-name=\"" + d + "\" data-commenter-display-name=\"" + e + "\">\n                                            <div class=\"comment-text\">" + g + "</div>\n                                            <span class=\"comment-delete-btn\" data-comment-index=\"" + c + "\">Ã—</span>\n                                         </div>";
        } else {
          l += "<div class=\"legacy-comment-item\">\n                                            <span class=\"comment-text\">" + String(b) + "</span>\n                                         </div>";
        }
      });
      l += "</div>";
    }
    const m = v.qzoneSettings.nickname;
    const n = a.likes && a.likes.includes(m);
    const o = v.favoritedPostIds && v.favoritedPostIds.has(a.id);
    let p = "";
    if (a.type !== "repost") {
      p = `
                    <span class="action-icon repost">
                        <svg viewBox="0 0 24 24"><path d="M17 2.1l4 4-4 4 M3 11.5v-3a4 4 0 0 1 4-4h13 M7 21.9l-4-4 4-4 M21 12.5v3a4 4 0 0 1-4 4H4"></path></svg>
                    </span>`;
    }
    e.innerHTML = `
                <div class="post-header">
                    <img src="` + f + "\" class=\"post-avatar\" data-author-id=\"" + a.authorId + `">
                    <div class="post-info">
                        <span class="post-nickname">` + g + "</span>\n                        <span class=\"post-timestamp\">" + Pb(a.timestamp) + `</span>
                    </div>
                    <div class="post-actions-btn">â€¦</div>
                </div>
                ` + j + `
                <div class="post-feedback-icons">
                    ` + p + "\n                    <span class=\"action-icon like " + (n ? "active" : "") + "\"><svg viewBox=\"0 0 24 24\"><path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path></svg></span>\n                    <span class=\"action-icon favorite " + (o ? "active" : "") + `"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                </div>
                ` + k + "\n                " + l + `
                <div class="post-footer">
                    <div class="comment-section">
                        <img src="` + h + `" class="comment-avatar">
                        <input type="text" class="comment-input" placeholder="å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹">
                        <button class="comment-sticker-btn">
        <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 14 Q 12 16 16 14"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
        </button>
                        <div class="at-mention-popup"></div>
                    </div>
                    <button class="comment-send-btn">å‘é€</button>
                </div>
            `;
    if (!c) {
      const a = document.createElement("div");
      a.className = "qzone-post-delete-action";
      a.innerHTML = "<span>åˆ é™¤</span>";
      d.appendChild(e);
      d.appendChild(a);
    }
    return d;
  }
  async function Rb(a) {
    const b = await Gb.qzonePosts.get(a);
    if (!b) {
      const b = document.querySelector(".qzone-post-container[data-post-id=\"" + a + "\"]");
      if (b) {
        b.remove();
      }
      return;
    }
    const c = Q.findIndex(b => b.id === a);
    if (c > -1) {
      Q[c] = b;
    }
    const d = await Gb.favorites.where("type").equals("qzone_post").toArray();
    v.favoritedPostIds = new Set(d.map(a => a.content.id));
    await Qb(b);
  }
  async function Sb() {
    const a = document.getElementById("qzone-posts-list");
    if (!a) {
      return;
    }
    const [b, c] = await Promise.all([Gb.qzonePosts.orderBy("timestamp").reverse().filter(a => !a.isDeleted).toArray(), Gb.favorites.where("type").equals("qzone_post").toArray()]);
    Q = b;
    v.favoritedPostIds = new Set(c.map(a => a.content.id));
    a.innerHTML = "";
    O = 0;
    if (Q.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 30px 0;\">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡è¯´è¯´å§ï¼</p>";
      return;
    }
    Tb();
  }
  async function Tb() {
    if (ka) {
      return;
    }
    ka = true;
    const a = document.getElementById("qzone-posts-list");
    if (!a) {
      ka = false;
      return;
    }
    tn(a, "bottom");
    // TOLOOK
    setTimeout(async () => {
      un(a);
      const b = O;
      const c = O + P;
      const d = Q.slice(b, c);
      const e = document.createDocumentFragment();
      for (const a of d) {
        const b = await Qb(a);
        e.appendChild(b);
      }
      a.appendChild(e);
      O += d.length;
      ka = false;
    }, 500);
  }
  function Ub(a, b) {
    const c = S.panelEl;
    const d = S.gridEl;
    d.innerHTML = "";
    if (v.userStickers.length === 0) {
      d.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); grid-column: 1 / -1; padding-top: 20px;\">è¯·å…ˆåœ¨èŠå¤©ç•Œé¢çš„<br>è¡¨æƒ…é¢æ¿ä¸­æ·»åŠ è¡¨æƒ…åŒ…</p>";
    } else {
      v.userStickers.forEach(a => {
        const b = document.createElement("div");
        b.className = "sticker-item";
        b.style.backgroundImage = "url(" + a.url + ")";
        b.title = a.name;
        d.appendChild(b);
      });
    }
    const e = b.getBoundingClientRect();
    const f = document.getElementById("phone-screen").getBoundingClientRect();
    c.style.display = "flex";
    const g = c.getBoundingClientRect();
    const h = g.height;
    const i = g.width;
    c.style.top = e.top - h - 5 - f.top + "px";
    const j = e.left - f.left;
    if (j + i > f.width) {
      c.style.left = "auto";
      c.style.right = "5px";
    } else {
      c.style.left = j + "px";
      c.style.right = "auto";
    }
    S.isOpen = true;
    S.activePostId = a;
  }
  function Vb() {
    if (S.isOpen) {
      S.panelEl.style.display = "none";
      S.isOpen = false;
      S.activePostId = null;
    }
  }
  async function Wb(a, b) {
    if (!b || !b.url) {
      return;
    }
    const c = await Gb.qzonePosts.get(a);
    if (!c) {
      console.error("sendQzoneStickerComment: æ‰¾ä¸åˆ°å¸–å­:", a);
      return;
    }
    if (!c.comments) {
      c.comments = [];
    }
    const d = {
      commenterName: v.qzoneSettings.nickname,
      text: b.url,
      meaning: b.name,
      timestamp: Date.now()
    };
    c.comments.push(d);
    await Gb.qzonePosts.update(a, {
      comments: c.comments
    });
    Vb();
    await Sb();
    const e = (c.publicText || c.content || "[å›¾ç‰‡åŠ¨æ€]").substring(0, 30);
    for (const c in v.chats) {
      const d = v.chats[c];
      if (!d.isGroup) {
        const c = "[ç³»ç»Ÿæç¤ºï¼š'" + v.qzoneSettings.nickname + "' åœ¨ä½ çš„åŠ¨æ€(ID: " + a + ", å†…å®¹æ‘˜è¦: â€œ" + e + "â€)ä¸‹å‘é€äº†ä¸€ä¸ªè¡¨æƒ…è¯„è®ºï¼Œæ„æ€æ˜¯ï¼šâ€œ" + b.name + "â€ã€‚è¯·ä½ å¯¹æ­¤ä½œå‡ºå›žåº”ã€‚]";
        const f = {
          role: "system",
          content: c,
          timestamp: Date.now(),
          isHidden: true
        };
        d.history.push(f);
        await Gb.chats.put(d);
      }
    }
  }
  function Xb(a) {
    Za = a;
    document.getElementById("repost-comment-input").value = "";
    document.getElementById("repost-modal").classList.add("visible");
  }
  function Yb() {
    document.getElementById("repost-modal").classList.remove("visible");
    Za = null;
  }
  async function Zb() {
    if (!Za) {
      return;
    }
    const a = document.getElementById("repost-comment-input").value.trim();
    const b = await Gb.qzonePosts.get(Za);
    if (!b) {
      alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¦è½¬å‘çš„åŽŸå§‹åŠ¨æ€ã€‚");
      Yb();
      return;
    }
    const c = {
      type: "repost",
      timestamp: Date.now(),
      authorId: "user",
      repostComment: a,
      originalPost: b,
      visibleGroupIds: null
    };
    await Gb.qzonePosts.add(c);
    Yb();
    await Sb();
    alert("è½¬å‘æˆåŠŸï¼");
  }
  function $b(a) {
    const b = document.getElementById("favorites-list");
    b.innerHTML = "";
    if (a.length === 0) {
      const a = document.getElementById("favorites-search-input").value;
      const c = a ? "æœªæ‰¾åˆ°ç›¸å…³æ”¶è—" : "ä½ çš„æ”¶è—å¤¹æ˜¯ç©ºçš„ï¼Œ<br>å¿«åŽ»åŠ¨æ€æˆ–èŠå¤©ä¸­æ”¶è—å–œæ¬¢çš„å†…å®¹å§ï¼";
      b.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">" + c + "</p>";
      return;
    }
    for (const c of a) {
      const a = document.createElement("div");
      a.className = "favorite-item-card";
      a.dataset.favid = c.id;
      let d = "";
      let e = "";
      let f = "";
      let g = "";
      if (c.type === "qzone_post") {
        const a = c.content;
        f = "æ¥è‡ªåŠ¨æ€";
        let b = Na;
        let h = "æœªçŸ¥ç”¨æˆ·";
        if (a.authorId === "user") {
          b = v.qzoneSettings.avatar;
          h = v.qzoneSettings.nickname;
        } else if (v.chats[a.authorId]) {
          b = v.chats[a.authorId].settings.aiAvatar;
          h = v.chats[a.authorId].name;
        }
        d = "<img src=\"" + b + "\" class=\"avatar\"><div class=\"info\"><div class=\"name\">" + h + "</div></div>";
        const i = a.publicText ? "<div class=\"post-content\">" + a.publicText.replace(/\n/g, "<br>") + "</div>" : "";
        if (a.type === "shuoshuo") {
          e = "<div class=\"post-content\">" + a.content.replace(/\n/g, "<br>") + "</div>";
        } else if (a.type === "image_post" && a.imageUrl) {
          const b = v.globalSettings.enableAiDrawing && a.image_prompt ? "https://image.pollinations.ai/prompt/" + a.image_prompt : "https://i.postimg.cc/KYr2qRCK/1.jpg";
          e = i ? i + "<div style=\"margin-top:10px;\"><img src=\"" + b + "\" class=\"chat-image\"></div>" : "<img src=\"" + b + "\" class=\"chat-image\">";
        } else if (a.type === "text_image") {
          const b = v.globalSettings.enableAiDrawing && a.image_prompt ? "https://image.pollinations.ai/prompt/" + a.image_prompt : "https://i.postimg.cc/KYr2qRCK/1.jpg";
          e = i ? i + "<div style=\"margin-top:10px;\"><img src=\"" + b + "\" class=\"chat-image\" style=\"cursor: pointer;\" data-hidden-text=\"" + a.hiddenContent + "\"></div>" : "<img src=\"" + b + "\" class=\"chat-image\" style=\"cursor: pointer;\" data-hidden-text=\"" + a.hiddenContent + "\">";
        }
        let j = "";
        if (a.likes && a.likes.length > 0) {
          j = `
                            <div class="post-likes-section">
                                <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                <span>` + a.likes.join("ã€") + " è§‰å¾—å¾ˆèµž</span>\n                            </div>";
        }
        let k = "";
        if (a.comments && a.comments.length > 0) {
          k = "<div class=\"post-comments-container\">";
          a.comments.forEach((b, c) => {
            if (typeof b === "object" && b !== null && b.commenterName) {
              const d = b.commenterName;
              const e = ub(d);
              let f;
              if ($a.test(b.text)) {
                f = "<img src=\"" + b.text + "\" class=\"comment-sticker\" alt=\"sticker\">";
              } else {
                f = b.text;
              }
              let g = "";
              if (b.replyTo) {
                const a = ub(b.replyTo);
                g = "<span class=\"commenter-name\">" + e + "</span> å›žå¤ <span class=\"commenter-name\">" + a + "</span>: " + f;
              } else {
                g = "<span class=\"commenter-name\">" + e + "</span>: " + f;
              }
              k += "<div class=\"comment-item\" data-post-id=\"" + a.id + "\" data-commenter-original-name=\"" + d + "\" data-commenter-display-name=\"" + e + "\">\n                                        <div class=\"comment-text\">" + g + "</div>\n                                        <span class=\"comment-delete-btn\" data-comment-index=\"" + c + "\">Ã—</span>\n                                     </div>";
            } else {
              k += "<div class=\"legacy-comment-item\">\n                                        <span class=\"comment-text\">" + String(b) + "</span>\n                                     </div>";
            }
          });
          k += "</div>";
        }
        g = "" + j + k;
      } else if (c.type === "chat_message") {
        const a = c.content;
        const b = v.chats[c.chatId];
        if (!b) {
          continue;
        }
        f = "æ¥è‡ªä¸Ž " + b.name + " çš„èŠå¤©";
        const g = a.role === "user";
        let h;
        let i;
        if (g) {
          h = b.isGroup ? b.settings.myNickname || "æˆ‘" : "æˆ‘";
          i = b.settings.myAvatar || (b.isGroup ? Oa : Na);
        } else if (b.isGroup) {
          const c = b.members.find(b => b.originalName === a.senderName);
          h = a.senderName;
          i = c ? c.avatar : Pa;
        } else {
          h = b.name;
          i = b.settings.aiAvatar || Na;
        }
        d = "<img src=\"" + i + "\" class=\"avatar\"><div class=\"info\"><div class=\"name\">" + h + "</div></div>";
        if (typeof a.content === "string" && $a.test(a.content)) {
          e = "<img src=\"" + a.content + "\" class=\"sticker-image\" style=\"max-width: 80px; max-height: 80px;\">";
        } else if (Array.isArray(a.content) && a.content[0]?.type === "image_url") {
          e = "<img src=\"" + a.content[0].image_url.url + "\" class=\"chat-image\">";
        } else {
          e = String(a.content || "").replace(/\n/g, "<br>");
        }
      } else if (c.type === "char_diary") {
        const a = c.content;
        f = "æ¥è‡ª " + a.characterName + " çš„æ—¥è®°";
        const b = v.chats[a.characterId];
        const g = b ? b.settings.aiAvatar : Na;
        d = "<img src=\"" + g + "\" class=\"avatar\"><div class=\"info\"><div class=\"name\">" + a.characterName + "</div></div>";
        const h = a.content || "";
        const i = si(h).replace(/\n/g, "<br>");
        e = "\n                <span class=\"diary-title\">" + a.title + "</span>\n                <div class=\"fav-card-content-full\">" + i + "</div>\n            ";
      } else if (c.type === "char_browser_article") {
        const a = c.content;
        f = "æ¥è‡ª " + a.characterName + " çš„æµè§ˆè®°å½•";
        const b = v.chats[a.characterId];
        const g = b ? b.settings.aiAvatar : Na;
        d = "<img src=\"" + g + "\" class=\"avatar\"><div class=\"info\"><div class=\"name\">" + a.characterName + "</div></div>";
        e = "\n            <span class=\"diary-title\">" + a.title + "</span>\n            <div class=\"memo-content-preview\">" + (a.content || "").replace(/\n/g, "<br>") + "</div>\n        ";
      } else if (c.type === "char_memo") {
        const a = c.content;
        f = "æ¥è‡ª " + a.characterName + " çš„å¤‡å¿˜å½•";
        const b = v.chats[a.characterId];
        const g = b ? b.settings.aiAvatar : Na;
        d = "<img src=\"" + g + "\" class=\"avatar\"><div class=\"info\"><div class=\"name\">" + a.characterName + "</div></div>";
        e = "\n        <span class=\"memo-title\">" + a.title + "</span>\n        <div class=\"memo-content-preview\">" + a.content.replace(/\n/g, "<br>") + "</div>\n    ";
      }
      a.innerHTML = "\n                    <div class=\"fav-card-header\">" + d + "<div class=\"source\">" + f + "</div></div>\n                    <div class=\"fav-card-content\">" + e + "</div>\n                    " + g;
      b.appendChild(a);
    }
  }
  async function _b() {
    allFavoriteItems = await Gb.favorites.orderBy("timestamp").reverse().toArray();
    const a = document.getElementById("favorites-search-input");
    const b = document.getElementById("favorites-search-clear-btn");
    a.value = "";
    b.style.display = "none";
    $b(allFavoriteItems);
  }
  function ac() {
    document.getElementById("post-public-text").value = "";
    document.getElementById("post-image-preview").src = "";
    document.getElementById("post-image-description").value = "";
    document.getElementById("post-image-preview-container").classList.remove("visible");
    document.getElementById("post-image-desc-group").style.display = "none";
    document.getElementById("post-local-image-input").value = "";
    document.getElementById("post-hidden-text").value = "";
    document.getElementById("switch-to-image-mode").click();
  }
  async function bc() {
    const a = await wb("ç¡®è®¤æ¸…ç†å†—ä½™æ•°æ®ï¼Ÿ", "æ­¤æ“ä½œå°†æ‰«ææ•°æ®åº“ï¼Œç§»é™¤æ‰€æœ‰ä¸Žå·²åˆ é™¤è§’è‰²ç›¸å…³çš„å­¤ç«‹æ•°æ®ï¼ˆå¦‚åŠ¨æ€ã€è¯„è®ºã€è®°å¿†ç­‰ï¼‰ã€‚<br><br><strong>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œä½†é€šå¸¸æ˜¯å®‰å…¨çš„ã€‚NPCæ•°æ®ä¸ä¼šè¢«åˆ é™¤ã€‚</strong><br><br>å»ºè®®åœ¨æ“ä½œå‰å…ˆå¯¼å‡ºæ•°æ®å¤‡ä»½ã€‚", {
      confirmButtonClass: "btn-danger",
      confirmText: "ç¡®è®¤æ¸…ç†"
    });
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨å¼€å§‹æ¸…ç†å†—ä½™æ•°æ®ï¼Œè¯·ä¸è¦å…³é—­é¡µé¢...");
    console.log("å†—ä½™æ•°æ®æ¸…ç†æµç¨‹å·²å¯åŠ¨...");
    let b = {
      posts: 0,
      likes: 0,
      comments: 0,
      memories: 0,
      callRecords: 0,
      renderingRules: 0,
      groupMembers: 0,
      chatLinks: 0
    };
    try {
      await Gb.transaction("rw", Gb.tables, async () => {
        const a = await Gb.chats.toArray();
        const c = await Gb.npcs.toArray();
        const d = new Set(a.map(a => a.id));
        const e = new Set(c.map(a => "npc_" + a.id));
        const f = new Set(a.filter(a => !a.isGroup).map(a => a.originalName));
        f.add(v.qzoneSettings.nickname || "{{user}}");
        c.forEach(a => f.add(a.name));
        for (const c of a) {
          let a = false;
          if (c.isGroup && c.members) {
            const f = c.members.length;
            c.members = c.members.filter(a => d.has(a.id) || e.has(a.id));
            if (c.members.length < f) {
              b.groupMembers += f - c.members.length;
              a = true;
            }
          }
          if (c.settings?.linkedMemoryChatIds?.length > 0) {
            const e = c.settings.linkedMemoryChatIds.length;
            c.settings.linkedMemoryChatIds = c.settings.linkedMemoryChatIds.filter(a => d.has(a));
            if (c.settings.linkedMemoryChatIds.length < e) {
              b.chatLinks += e - c.settings.linkedMemoryChatIds.length;
              a = true;
            }
          }
          if (a) {
            await Gb.chats.put(c);
          }
        }
        const g = await Gb.qzonePosts.toArray();
        for (const a of g) {
          let c = false;
          const g = a.authorId === "user" || d.has(a.authorId) || e.has(a.authorId);
          if (!g) {
            await Gb.qzonePosts.delete(a.id);
            b.posts++;
            continue;
          }
          if (a.likes && a.likes.length > 0) {
            const d = a.likes.length;
            a.likes = a.likes.filter(a => f.has(a));
            if (a.likes.length < d) {
              b.likes += d - a.likes.length;
              c = true;
            }
          }
          if (a.comments && a.comments.length > 0) {
            const d = a.comments.length;
            a.comments = a.comments.filter(a => {
              if (typeof a === "object" && a.commenterName) {
                return f.has(a.commenterName);
              }
              return true;
            });
            if (a.comments.length < d) {
              b.comments += d - a.comments.length;
              c = true;
            }
          }
          if (c) {
            await Gb.qzonePosts.put(a);
          }
        }
        await Gb.memories.where("chatId").noneOf([...d]).delete().then(a => b.memories += a);
        await Gb.callRecords.where("chatId").noneOf([...d]).delete().then(a => b.callRecords += a);
        const h = await Gb.renderingRules.toArray();
        for (const a of h) {
          if (a.chatId !== "global" && !d.has(a.chatId)) {
            await Gb.renderingRules.delete(a.id);
            b.renderingRules++;
          }
        }
      });
      let a = `âœ… æ¸…ç†å®Œæˆï¼

`;
      let c = false;
      Object.entries(b).forEach(([b, d]) => {
        if (d > 0) {
          const e = {
            posts: "åŠ¨æ€",
            likes: "ç‚¹èµž",
            comments: "è¯„è®º",
            memories: "è®°å¿†",
            callRecords: "é€šè¯è®°å½•",
            renderingRules: "æ¸²æŸ“è§„åˆ™",
            groupMembers: "ç¾¤æˆå‘˜",
            chatLinks: "è®°å¿†é“¾æŽ¥"
          };
          a += "- æ¸…ç†äº† " + d + " æ¡æ— æ•ˆçš„" + (e[b] || b) + "ã€‚\n";
          c = true;
        }
      });
      if (!c) {
        a = "âœ… æ£€æŸ¥å®Œæˆï¼Œæœªå‘çŽ°ä»»ä½•å†—ä½™æ•°æ®ã€‚";
      }
      a += "\nå»ºè®®åˆ·æ–°é¡µé¢ä»¥ç¡®ä¿æ‰€æœ‰æ›´æ”¹ç”Ÿæ•ˆã€‚";
      await Bb("æ“ä½œæˆåŠŸ", a);
      const d = await wb("åˆ·æ–°é¡µé¢ï¼Ÿ", "ä¸ºäº†ç¡®ä¿æ‰€æœ‰æ•°æ®åŒæ­¥ï¼Œå»ºè®®ç«‹å³åˆ·æ–°é¡µé¢ã€‚");
      if (d) {
        location.reload();
      }
    } catch (a) {
      console.error("æ¸…ç†å†—ä½™æ•°æ®æ—¶å‡ºé”™:", a);
      await Bb("æ¸…ç†å¤±è´¥", "å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: " + a.message);
    }
  }
  async function cc() {
    try {
      const a = {
        version: 1,
        timestamp: Date.now()
      };
      const [b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r, s, t, u, v, w, x, y, z] = await Promise.all([Gb.chats.toArray(), Gb.worldBooks.toArray(), Gb.userStickers.toArray(), Gb.apiConfig.get("main"), Gb.globalSettings.get("main"), Gb.personaPresets.toArray(), Gb.musicLibrary.get("main"), Gb.qzoneSettings.get("main"), Gb.qzonePosts.toArray(), Gb.qzoneAlbums.toArray(), Gb.qzonePhotos.toArray(), Gb.favorites.toArray(), Gb.qzoneGroups.toArray(), Gb.memories.toArray(), Gb.worldBookCategories.toArray(), Gb.apiPresets.toArray(), Gb.shoppingProducts.toArray(), Gb.callRecords.toArray(), Gb.renderingRules.toArray(), Gb.doubanPosts.toArray(), Gb.stickerCategories.toArray(), Gb.appearancePresets.toArray(), Gb.presets.toArray(), Gb.presetCategories.toArray(), Gb.npcs.toArray()]);
      Object.assign(a, {
        chats: b,
        worldBooks: c,
        userStickers: d,
        apiConfig: e,
        globalSettings: f,
        personaPresets: g,
        musicLibrary: h,
        qzoneSettings: i,
        qzonePosts: j,
        qzoneAlbums: k,
        qzonePhotos: l,
        favorites: m,
        qzoneGroups: n,
        memories: o,
        worldBookCategories: p,
        apiPresets: q,
        shoppingProducts: r,
        callRecords: s,
        renderingRules: t,
        doubanPosts: u,
        stickerCategories: v,
        appearancePresets: w,
        presets: x,
        presetCategories: y,
        npcs: z
      });
      const A = new Blob([JSON.stringify(a, null, 2)], {
        type: "application/json"
      });
      const B = URL.createObjectURL(A);
      const C = Object.assign(document.createElement("a"), {
        href: B,
        download: "EPhone-Full-Backup-" + new Date().toISOString().split("T")[0] + ".json"
      });
      C.click();
      URL.revokeObjectURL(B);
      await Bb("å¯¼å‡ºæˆåŠŸ", "å·²æˆåŠŸå¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼");
    } catch (a) {
      console.error("å¯¼å‡ºæ•°æ®æ—¶å‡ºé”™:", a);
      await Bb("å¯¼å‡ºå¤±è´¥", "å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: " + a.message);
    }
  }
  async function dc(a) {
    try {
      await Gb.transaction("rw", Gb.tables, async () => {
        for (const a of Gb.tables) {
          await a.clear();
        }
        for (const b in a) {
          if (Array.isArray(a[b])) {
            console.log("æ­£åœ¨å¯¼å…¥è¡¨: " + b + ", è®°å½•æ•°: " + a[b].length);
            await Gb.table(b).bulkPut(a[b]);
          }
        }
      });
    } catch (a) {
      throw new Error("æ•°æ®åº“å†™å…¥å¤±è´¥: " + a.message);
    }
  }
  async function ec(a) {
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨è¯»å–å¹¶è§£æžå¤‡ä»½æ–‡ä»¶...");
    try {
      const b = await a.text();
      const c = JSON.parse(b);
      let d;
      let e;
      if (c.data && typeof c.data === "object" && (c.data.chats || c.data.worldBooks)) {
        console.log("æ£€æµ‹åˆ°æ–°ç‰ˆæµå¼å¤‡ä»½æ–‡ä»¶...");
        d = c.data;
        e = "streamed";
      } else if (c.chats || c.worldBooks) {
        console.log("æ£€æµ‹åˆ°æ—§ç‰ˆå®Œæ•´å¤‡ä»½æ–‡ä»¶...");
        d = c;
        e = "legacy";
      } else {
        throw new Error("æ–‡ä»¶æ ¼å¼æ— æ³•è¯†åˆ«ã€‚è¯·ç¡®ä¿æ‚¨é€‰æ‹©çš„æ˜¯æœ‰æ•ˆçš„ EPhone å¤‡ä»½æ–‡ä»¶ã€‚");
      }
      x = {
        type: e,
        content: d
      };
      fc(d);
    } catch (a) {
      console.error("å¯¼å…¥æ•°æ®æ—¶å‡ºé”™:", a);
      x = null;
      await Bb("å¯¼å…¥å¤±è´¥", "æ–‡ä»¶è§£æžæˆ–åº”ç”¨å¤±è´¥: " + a.message);
    }
  }
  function fc(a) {
    const b = document.getElementById("import-options-modal");
    const c = document.getElementById("import-preview-list");
    c.innerHTML = "";
    const d = {
      chats: "èŠå¤©ä¼šè¯",
      worldBooks: "ä¸–ç•Œä¹¦",
      worldBookCategories: "ä¸–ç•Œä¹¦åˆ†ç±»",
      presets: "ç¦»çº¿é¢„è®¾",
      presetCategories: "é¢„è®¾åˆ†ç±»",
      userStickers: "è¡¨æƒ…åŒ…",
      stickerCategories: "è¡¨æƒ…åˆ†ç±»",
      customAvatarFrames: "å¤´åƒæ¡†",
      apiConfig: "APIé…ç½®",
      globalSettings: "å…¨å±€è®¾ç½®",
      personaPresets: "äººè®¾é¢„è®¾",
      qzoneSettings: "ç©ºé—´è®¾ç½®",
      qzonePosts: "åŠ¨æ€",
      qzoneAlbums: "ç›¸å†Œ",
      favorites: "æ”¶è—",
      memories: "å›žå¿†",
      callRecords: "é€šè¯è®°å½•",
      shoppingProducts: "å•†å“",
      apiPresets: "APIé¢„è®¾",
      renderingRules: "æ¸²æŸ“è§„åˆ™",
      appearancePresets: "å¤–è§‚é¢„è®¾",
      npcs: "NPCs"
    };
    let e = false;
    for (const b in d) {
      if (a[b] && (Array.isArray(a[b]) ? a[b].length > 0 : a[b])) {
        const f = Array.isArray(a[b]) ? a[b].length : 1;
        const g = document.createElement("li");
        g.textContent = d[b] + ": " + f + " æ¡/ä¸ª";
        c.appendChild(g);
        e = true;
      }
    }
    if (!e) {
      c.innerHTML = "<li>æœªåœ¨æ­¤æ–‡ä»¶ä¸­æ‰¾åˆ°å¯è¯†åˆ«çš„æ•°æ®ã€‚</li>";
    }
    document.getElementById("confirm-full-import-btn").onclick = () => {
      b.classList.remove("visible");
      gc(x);
    };
    document.getElementById("confirm-selective-import-btn").onclick = () => {
      b.classList.remove("visible");
      hc(x.content);
    };
    document.getElementById("cancel-import-options-btn").onclick = () => {
      b.classList.remove("visible");
      x = null;
    };
    b.classList.add("visible");
  }
  async function gc(a) {
    if (!a) {
      return;
    }
    const b = await wb("ä¸¥é‡è­¦å‘Šï¼", "ã€å®Œå…¨å¯¼å…¥ã€‘å°†åˆ é™¤æ‚¨å½“å‰çš„æ‰€æœ‰æ•°æ®å¹¶æ›¿æ¢ä¸ºå¤‡ä»½æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼<br><br><strong>ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ</strong>", {
      confirmButtonClass: "btn-danger",
      confirmText: "æˆ‘æ˜Žç™½ï¼Œè¦†ç›–æ‰€æœ‰æ•°æ®"
    });
    if (!b) {
      x = null;
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨æ‰§è¡Œå®Œå…¨å¯¼å…¥ï¼Œè¯·å‹¿å…³é—­é¡µé¢...");
    try {
      if (a.type === "streamed") {
        await dc(a.content);
      } else if (a.type === "legacy") {
        await jc(a.content);
      } else {
        throw new Error("æœªçŸ¥çš„å¤‡ä»½ç±»åž‹ã€‚");
      }
      await Bb("å¯¼å…¥æˆåŠŸ", "æ‰€æœ‰æ•°æ®å·²æˆåŠŸæ¢å¤ï¼åº”ç”¨å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚");
      try {
        const a = await Gb.apiConfig.get("main");
        if (a) {
          if (a.imgbbApiKey) {
            localStorage.setItem("imgbb-api-key", a.imgbbApiKey);
          }
          if (a.imgbbEnable !== undefined) {
            localStorage.setItem("imgbb-enabled", a.imgbbEnable);
          }
          if (a.minimaxGroupId) {
            localStorage.setItem("minimax-group-id", a.minimaxGroupId);
          }
          if (a.minimaxApiKey) {
            localStorage.setItem("minimax-api-key", a.minimaxApiKey);
          }
          if (a.minimaxModel) {
            localStorage.setItem("minimax-model", a.minimaxModel);
          }
          if (a.catboxUserHash) {
            localStorage.setItem("catbox-userhash", a.catboxUserHash);
          }
          if (a.catboxEnable !== undefined) {
            localStorage.setItem("catbox-enabled", a.catboxEnable);
          }
          const b = localStorage.getItem("novelai-settings");
        }
        console.log("API é…ç½®å·²å¼ºåˆ¶åŒæ­¥åˆ°æœ¬åœ°ç¼“å­˜ã€‚");
      } catch (a) {
        console.error("åŒæ­¥é…ç½®å¤±è´¥:", a);
      }
      // TOLOOK
      setTimeout(() => window.location.reload(), 1500);
    } catch (a) {
      console.error("å®Œå…¨å¯¼å…¥å¤±è´¥:", a);
      await Bb("å¯¼å…¥å¤±è´¥", "æ–‡ä»¶åº”ç”¨å¤±è´¥: " + a.message);
    } finally {
      x = null;
    }
  }
  function hc(a) {
    const b = document.getElementById("selective-import-modal");
    const c = document.getElementById("selective-import-list");
    const d = document.getElementById("select-all-import-types");
    c.innerHTML = "";
    d.checked = true;
    const e = {
      chats: "èŠå¤©ä¼šè¯",
      worldBooks: "ä¸–ç•Œä¹¦",
      worldBookCategories: "ä¸–ç•Œä¹¦åˆ†ç±»",
      presets: "ç¦»çº¿é¢„è®¾",
      presetCategories: "é¢„è®¾åˆ†ç±»",
      userStickers: "è¡¨æƒ…åŒ…",
      stickerCategories: "è¡¨æƒ…åˆ†ç±»",
      customAvatarFrames: "å¤´åƒæ¡†",
      apiConfig: "APIé…ç½®",
      globalSettings: "å…¨å±€è®¾ç½®",
      personaPresets: "äººè®¾é¢„è®¾",
      qzoneSettings: "ç©ºé—´è®¾ç½®",
      qzonePosts: "åŠ¨æ€",
      qzoneAlbums: "ç›¸å†Œ",
      favorites: "æ”¶è—",
      memories: "å›žå¿†",
      callRecords: "é€šè¯è®°å½•",
      shoppingProducts: "å•†å“",
      apiPresets: "APIé¢„è®¾",
      renderingRules: "æ¸²æŸ“è§„åˆ™",
      appearancePresets: "å¤–è§‚é¢„è®¾",
      npcs: "NPCs"
    };
    let f = false;
    for (const b in e) {
      if (a[b] && (Array.isArray(a[b]) ? a[b].length > 0 : a[b])) {
        const d = Array.isArray(a[b]) ? a[b].length : 1;
        const g = !Array.isArray(a[b]);
        const h = document.createElement("div");
        h.className = "clear-posts-item selected";
        h.dataset.typeId = b;
        h.innerHTML = `
                <div class="checkbox selected"></div>
                <div>
                    <span class="name">` + e[b] + " (" + d + " æ¡/ä¸ª)</span>\n                    " + (g ? "<p style=\"font-size: 12px; color: #ff8c00; margin: 4px 0 0;\">(æ³¨æ„: è¿™å°†ã€è¦†ç›–ã€‘æ‚¨å½“å‰çš„è®¾ç½®)</p>" : "") + `
                </div>
            `;
        c.appendChild(h);
        f = true;
      }
    }
    if (!f) {
      c.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary);\">æ–‡ä»¶ä¸­æœªæ‰¾åˆ°å¯åˆå¹¶çš„æ•°æ®ã€‚</p>";
    }
    document.getElementById("confirm-merge-import-btn").onclick = () => ic(x);
    document.getElementById("cancel-selective-import-btn").onclick = () => {
      b.classList.remove("visible");
      x = null;
    };
    d.onchange = a => {
      const b = a.target.checked;
      c.querySelectorAll(".clear-posts-item").forEach(a => {
        a.classList.toggle("selected", b);
        a.querySelector(".checkbox").classList.toggle("selected", b);
      });
    };
    c.onclick = a => {
      const b = a.target.closest(".clear-posts-item");
      if (b) {
        b.classList.toggle("selected");
        b.querySelector(".checkbox").classList.toggle("selected");
      }
    };
    b.classList.add("visible");
  }
  async function ic(a) {
    if (!a) {
      return;
    }
    const b = document.querySelectorAll("#selective-import-list .clear-posts-item.selected");
    if (b.length === 0) {
      alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¦åˆå¹¶çš„æ•°æ®ç±»åž‹ã€‚");
      return;
    }
    const c = Array.from(b).map(a => a.dataset.typeId);
    const d = a.content;
    const e = await wb("ç¡®è®¤åˆå¹¶ï¼Ÿ", "è¿™å°†æŠŠæ‚¨é€‰æ‹©çš„æ•°æ®ã€æ·»åŠ å¹¶è¦†ç›–ã€‘åˆ°çŽ°æœ‰æ•°æ®ä¸­ã€‚åŒIDçš„æ•°æ®å°†è¢«æ›´æ–°ï¼Œæ–°æ•°æ®å°†è¢«æ·»åŠ ã€‚<br><br><strong>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</strong>", {
      confirmText: "ç¡®è®¤åˆå¹¶"
    });
    if (!e) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨åˆå¹¶æ•°æ®ï¼Œè¯·å‹¿å…³é—­é¡µé¢...");
    try {
      await Gb.transaction("rw", Gb.tables, async () => {
        for (const a of c) {
          const b = d[a];
          if (!b) {
            continue;
          }
          const c = Gb.table(a);
          if (!c) {
            console.warn("æ‰¾ä¸åˆ°è¡¨: " + a + ", è·³è¿‡...");
            continue;
          }
          if (Array.isArray(b)) {
            console.log("æ­£åœ¨åˆå¹¶ " + b.length + " æ¡è®°å½•åˆ° " + a + "...");
            await c.bulkPut(b);
          } else if (typeof b === "object" && b.id) {
            console.log("æ­£åœ¨åˆå¹¶å•æ¡è®°å½•åˆ° " + a + "...");
            await c.put(b);
          } else if (typeof b === "object") {
            console.log("æ­£åœ¨åˆå¹¶éžæ ‡å¯¹è±¡åˆ° " + a + "...");
            const d = (await c.toCollection().first()) || {};
            const e = {
              ...d,
              ...b
            };
            if (d.id) {
              e.id = d.id;
            } else if (a === "apiConfig" || a === "qzoneSettings" || a === "globalSettings" || a === "musicLibrary") {
              e.id = "main";
            }
            await c.put(e);
          }
        }
      });
      await Bb("åˆå¹¶æˆåŠŸ", "æ•°æ®å·²æˆåŠŸåˆå¹¶ï¼åº”ç”¨å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚");
      // TOLOOK
      setTimeout(() => window.location.reload(), 1500);
    } catch (a) {
      console.error("é€‰æ‹©æ€§å¯¼å…¥å¤±è´¥:", a);
      await Bb("åˆå¹¶å¤±è´¥", "æ–‡ä»¶åº”ç”¨å¤±è´¥: " + a.message);
    } finally {
      x = null;
    }
  }
  async function jc(a) {
    try {
      await Gb.transaction("rw", Gb.tables, async () => {
        await Gb.chats.clear();
        await Gb.worldBooks.clear();
        for (const a of Gb.tables) {
          await a.clear();
        }
        if (Array.isArray(a.chats)) {
          await Gb.chats.bulkPut(a.chats);
        }
        if (Array.isArray(a.worldBooks)) {
          await Gb.worldBooks.bulkPut(a.worldBooks);
        }
        if (Array.isArray(a.userStickers)) {
          await Gb.userStickers.bulkPut(a.userStickers);
        }
        if (a.apiConfig) {
          await Gb.apiConfig.put(a.apiConfig);
        }
        if (a.globalSettings) {
          await Gb.globalSettings.put(a.globalSettings);
        }
        if (Array.isArray(a.personaPresets)) {
          await Gb.personaPresets.bulkPut(a.personaPresets);
        }
        if (a.musicLibrary) {
          await Gb.musicLibrary.put(a.musicLibrary);
        }
        if (a.qzoneSettings) {
          await Gb.qzoneSettings.put(a.qzoneSettings);
        }
        if (Array.isArray(a.qzonePosts)) {
          await Gb.qzonePosts.bulkPut(a.qzonePosts);
        }
        if (Array.isArray(a.qzoneAlbums)) {
          await Gb.qzoneAlbums.bulkPut(a.qzoneAlbums);
        }
        if (Array.isArray(a.qzonePhotos)) {
          await Gb.qzonePhotos.bulkPut(a.qzonePhotos);
        }
        if (Array.isArray(a.favorites)) {
          await Gb.favorites.bulkPut(a.favorites);
        }
        if (Array.isArray(a.qzoneGroups)) {
          await Gb.qzoneGroups.bulkPut(a.qzoneGroups);
        }
        if (Array.isArray(a.memories)) {
          await Gb.memories.bulkPut(a.memories);
        }
        if (Array.isArray(a.worldBookCategories)) {
          await Gb.worldBookCategories.bulkPut(a.worldBookCategories);
        }
        if (Array.isArray(a.apiPresets)) {
          await Gb.apiPresets.bulkPut(a.apiPresets);
        }
        if (Array.isArray(a.shoppingProducts)) {
          await Gb.shoppingProducts.bulkPut(a.shoppingProducts);
        }
        if (Array.isArray(a.callRecords)) {
          await Gb.callRecords.bulkPut(a.callRecords);
        }
        if (Array.isArray(a.renderingRules)) {
          await Gb.renderingRules.bulkPut(a.renderingRules);
        }
        if (Array.isArray(a.doubanPosts)) {
          await Gb.doubanPosts.bulkPut(a.doubanPosts);
        }
        if (Array.isArray(a.stickerCategories)) {
          await Gb.stickerCategories.bulkPut(a.stickerCategories);
        }
        if (Array.isArray(a.appearancePresets)) {
          await Gb.appearancePresets.bulkPut(a.appearancePresets);
        }
        if (Array.isArray(a.presets)) {
          await Gb.presets.bulkPut(a.presets);
        }
        if (Array.isArray(a.presetCategories)) {
          await Gb.presetCategories.bulkPut(a.presetCategories);
        }
        if (Array.isArray(a.npcs)) {
          await Gb.npcs.bulkPut(a.npcs);
        }
      });
    } catch (a) {
      throw new Error("æ—§ç‰ˆå¤‡ä»½æ•°æ®å†™å…¥æ•°æ®åº“å¤±è´¥: " + a.message);
    }
  }
  function kc(a, b = false) {
    if (!a) {
      db.innerHTML = "";
      document.getElementById("font-preview").style.fontFamily = "";
      return;
    }
    const c = "custom-user-font";
    const d = `
                        @font-face {
                          font-family: '` + c + "';\n                          src: url('" + a + `');
                          font-display: swap;
                        }`;
    if (b) {
      const a = document.getElementById("preview-font-style") || document.createElement("style");
      a.id = "preview-font-style";
      a.innerHTML = d;
      if (!document.getElementById("preview-font-style")) {
        document.head.appendChild(a);
      }
      document.getElementById("font-preview").style.fontFamily = "'" + c + "', 'bulangni', sans-serif";
    } else {
      db.innerHTML = "\n                            " + d + `
                            body {
                              font-family: '` + c + "', 'bulangni', -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif;\n                            }";
    }
  }
  async function lc() {
    db.innerHTML = "";
    v.globalSettings.fontUrl = "";
    await Gb.globalSettings.put(v.globalSettings);
    document.getElementById("font-url-input").value = "";
    document.getElementById("font-preview").style.fontFamily = "";
    alert("å·²æ¢å¤é»˜è®¤å­—ä½“ã€‚");
  }
  async function mc() {
    const [a, b, c, d, e, f, g, h, i, j, k, l] = await Promise.all([Gb.chats.toArray(), Gb.apiConfig.get("main"), Gb.globalSettings.get("main"), Gb.userStickers.toArray(), Gb.worldBooks.toArray(), Gb.musicLibrary.get("main"), Gb.personaPresets.toArray(), Gb.qzoneSettings.get("main"), Gb.favorites.orderBy("timestamp").reverse().toArray(), Gb.memories.toArray(), Gb.presets.toArray(), Gb.quickReplies.toArray()]);
    v.presets = k || [];
    v.quickReplies = l || [];
    await Dp();
    const m = {
      id: "main",
      showStatusBar: false,
      wallpaper: "linear-gradient(135deg, #89f7fe, #66a6ff)",
      fontUrl: "",
      enableBackgroundActivity: false,
      backgroundActivityInterval: 60,
      blockCooldownHours: 1,
      apiTemperature: 0.8,
      appIcons: {
        ...Xa
      },
      cphoneWallpaper: "linear-gradient(135deg, #f6d365, #fda085)",
      cphoneAppIcons: {
        ...Ya
      },
      globalCss: "",
      notificationSoundUrl: "",
      widgetData: {},
      globalChatBackground: "",
      enableAiDrawing: true,
      showPhoneFrame: false,
      lockScreenEnabled: false,
      lockScreenPassword: "",
      lockScreenWallpaper: "",
      alwaysShowMusicIsland: false,
      detachStatusBar: false,
      enableMinimalChatUI: false,
      chatActionButtonsOrder: null,
      shoppingCategoryCount: 3,
      shoppingProductCount: 8,
      chatRenderWindow: 50
    };
    v.globalSettings = {
      ...m,
      ...(c || {})
    };
    v.globalSettings.appIcons = {
      ...m.appIcons,
      ...(v.globalSettings.appIcons || {})
    };
    v.globalSettings.cphoneAppIcons = {
      ...m.cphoneAppIcons,
      ...(v.globalSettings.cphoneAppIcons || {})
    };
    a.forEach(a => {
      if (typeof a.settings.enableTimePerception === "undefined") {
        a.settings.enableTimePerception = true;
      }
      if (!a.settings.lyricsPosition) {
        a.settings.lyricsPosition = {
          vertical: "top",
          horizontal: "center",
          offset: 10
        };
      }
      if (!a.isGroup && !a.settings.myAvatarLibrary) {
        a.settings.myAvatarLibrary = [];
      }
      if (!a.isGroup && typeof a.originalName === "undefined") {
        a.originalName = a.name;
      }
    });
    v.chats = a.reduce((b, c) => {
      if (typeof c.unreadCount === "undefined") {
        c.unreadCount = 0;
      }
      if (c.isGroup) {
        if (typeof c.settings.enableBackgroundActivity === "undefined") {
          c.settings.enableBackgroundActivity = true;
        }
        if (c.members && c.members.length > 0 && c.members[0].name) {
          c.members.forEach(a => {
            if (typeof a.originalName === "undefined") {
              a.originalName = a.name;
              a.groupNickname = a.name;
              delete a.name;
            }
          });
        }
      }
      if (!c.settings) {
        c.settings = {};
      }
      if (typeof c.settings.actionCooldownMinutes === "undefined") {
        c.settings.actionCooldownMinutes = 10;
      }
      if (!c.isGroup && !c.status) {
        c.status = {
          text: "åœ¨çº¿",
          lastUpdate: Date.now(),
          isBusy: false
        };
      }
      if (!c.isGroup && !c.relationship) {
        c.relationship = {
          status: "friend",
          blockedTimestamp: null,
          applicationReason: ""
        };
      }
      if (!c.isGroup && (!c.settings || !c.settings.aiAvatarLibrary)) {
        if (!c.settings) {
          c.settings = {};
        }
        c.settings.aiAvatarLibrary = [];
      }
      if (c.isGroup) {
        (c.members || []).forEach(a => {
          if (typeof a.avatarFrame === "undefined") {
            a.avatarFrame = "";
          }
        });
      }
      if (!c.musicData) {
        c.musicData = {
          totalTime: 0
        };
      }
      if (c.settings && c.settings.linkedWorldBookId && !c.settings.linkedWorldBookIds) {
        c.settings.linkedWorldBookIds = [c.settings.linkedWorldBookId];
        delete c.settings.linkedWorldBookId;
      }
      if (typeof c.isPinned === "undefined") {
        c.isPinned = false;
      }
      if (!c.isGroup && typeof c.settings.myNickname === "undefined") {
        c.settings.myNickname = "æˆ‘";
      }
      if (c.isGroup && c.members) {
        let b = false;
        a.forEach(a => {
          if (a.id === c.id && a.originalName) {
            delete a.originalName;
          }
        });
        c.members.forEach(c => {
          const d = a.find(a => a.id === c.id);
          if (d && d.settings) {
            const a = d.settings.aiAvatarFrame || "";
            if (c.avatarFrame !== a) {
              c.avatarFrame = a;
              b = true;
            }
          } else if (typeof c.avatarFrame === "undefined") {
            c.avatarFrame = "";
            b = true;
          }
        });
        if (b) {
          Gb.chats.put(c);
        }
      }
      if (!c.settings.enableAutoMemory) {
        c.settings.enableAutoMemory = false;
      }
      if (!c.settings.autoMemoryInterval) {
        c.settings.autoMemoryInterval = 20;
      }
      if (!c.longTermMemory) {
        c.longTermMemory = [];
      }
      if (!c.lastMemorySummaryTimestamp) {
        c.lastMemorySummaryTimestamp = 0;
      }
      if (!c.isGroup) {
        if (typeof c.settings.enableBackgroundActivity === "undefined") {
          c.settings.enableBackgroundActivity = true;
        }
        if (typeof c.settings.enableTts === "undefined") {
          c.settings.enableTts = false;
        }
        if (!c.status) {
          c.status = {
            text: "åœ¨çº¿",
            lastUpdate: Date.now(),
            isBusy: false
          };
        }
        if (!c.relationship) {
          c.relationship = {
            status: "friend",
            blockedTimestamp: null,
            applicationReason: ""
          };
        }
        if (!c.settings || !c.settings.aiAvatarLibrary) {
          if (!c.settings) {
            c.settings = {};
          }
          c.settings.aiAvatarLibrary = [];
        }
        if (typeof c.settings.isOfflineMode === "undefined") {
          c.settings.isOfflineMode = false;
        }
        if (typeof c.settings.offlineMinLength === "undefined") {
          c.settings.offlineMinLength = 100;
        }
        if (typeof c.settings.offlineMaxLength === "undefined") {
          c.settings.offlineMaxLength = 300;
        }
        if (typeof c.settings.injectLatestThought === "undefined") {
          c.settings.injectLatestThought = false;
        }
        if (typeof c.heartfeltVoice === "undefined") {
          c.heartfeltVoice = "...";
        }
        if (typeof c.randomJottings === "undefined") {
          c.randomJottings = "...";
        }
        if (!Array.isArray(c.thoughtsHistory)) {
          c.thoughtsHistory = [];
        }
      }
      if (typeof c.settings.stickerCategoryIds === "undefined") {
        if (c.settings.stickerCategoryId) {
          c.settings.stickerCategoryIds = [c.settings.stickerCategoryId];
        } else {
          c.settings.stickerCategoryIds = [];
        }
        delete c.settings.stickerCategoryId;
      }
      b[c.id] = c;
      return b;
    }, {});
    const n = [];
    j.forEach(b => {
      if (b.type === "ai_generated" && b.authorName && !b.authorId) {
        const c = a.find(a => !a.isGroup && a.originalName === b.authorName);
        if (c) {
          b.authorId = c.id;
          n.push(b);
        } else {
          const c = a.find(a => !a.isGroup && a.name === b.authorName);
          if (c) {
            b.authorId = c.id;
            n.push(b);
          }
        }
      }
    });
    if (n.length > 0) {
      await Gb.memories.bulkPut(n);
    }
    v.apiConfig = b || {
      id: "main",
      proxyUrl: "",
      apiKey: "",
      model: "",
      secondaryProxyUrl: "",
      secondaryApiKey: "",
      secondaryModel: "",
      minimaxGroupId: "",
      minimaxApiKey: "",
      minimaxModel: "speech-01",
      imgbbEnable: false,
      imgbbApiKey: "",
      catboxEnable: false,
      catboxUserHash: "",
      githubEnable: false,
      githubAutoBackup: false,
      githubUsername: "",
      githubRepo: "",
      githubToken: "",
      githubFilename: "ephone_backup.json"
    };
    if (localStorage.getItem("imgbb-enabled") !== null) {
      v.apiConfig.imgbbEnable = localStorage.getItem("imgbb-enabled") === "true";
    }
    if (localStorage.getItem("imgbb-api-key") !== null) {
      v.apiConfig.imgbbApiKey = localStorage.getItem("imgbb-api-key");
    }
    if (localStorage.getItem("catbox-enabled") !== null) {
      v.apiConfig.catboxEnable = localStorage.getItem("catbox-enabled") === "true";
    }
    if (localStorage.getItem("catbox-userhash") !== null) {
      v.apiConfig.catboxUserHash = localStorage.getItem("catbox-userhash");
    }
    if (localStorage.getItem("minimax-group-id") !== null) {
      v.apiConfig.minimaxGroupId = localStorage.getItem("minimax-group-id");
    }
    if (localStorage.getItem("minimax-api-key") !== null) {
      v.apiConfig.minimaxApiKey = localStorage.getItem("minimax-api-key");
    }
    if (localStorage.getItem("minimax-model") !== null) {
      v.apiConfig.minimaxModel = localStorage.getItem("minimax-model");
    }
    if (localStorage.getItem("github-proxy-enabled") !== null) {
      v.apiConfig.githubProxyEnable = localStorage.getItem("github-proxy-enabled") === "true";
    }
    if (localStorage.getItem("github-proxy-url") !== null) {
      v.apiConfig.githubProxyUrl = localStorage.getItem("github-proxy-url");
    }
    v.userStickers = d || [];
    v.worldBooks = e || [];
    R.playlist = f?.playlist || [];
    v.personaPresets = g || [];
    v.qzoneSettings = h || {
      id: "main",
      nickname: "{{user}}",
      avatar: "https://files.catbox.moe/q6z5fc.jpeg",
      banner: "https://files.catbox.moe/r5heyt.gif"
    };
    allFavoriteItems = i || [];
  }
  async function nc() {
    await Gb.musicLibrary.put({
      id: "main",
      playlist: R.playlist
    });
  }
  function oc(a) {
    if (!a) {
      return "";
    }
    const b = new Date(a);
    const c = String(b.getHours()).padStart(2, "0");
    const d = String(b.getMinutes()).padStart(2, "0");
    return c + ":" + d;
  }
  function pc(a) {
    const b = Date.now();
    const c = Math.floor((b - a) / 1000);
    if (c < 60) {
      return "åˆšåˆš";
    }
    const d = Math.floor(c / 60);
    if (d < 60) {
      return d + "åˆ†é’Ÿå‰";
    }
    const e = Math.floor(d / 60);
    if (e < 24) {
      return e + "å°æ—¶å‰";
    }
    const f = Math.floor(e / 24);
    if (f < 30) {
      return f + "å¤©å‰";
    }
    const g = Math.floor(f / 30);
    if (g < 12) {
      return "å¤§çº¦" + g + "ä¸ªæœˆå‰";
    }
    const h = Math.floor(f / 365);
    return "å¤§çº¦" + h + "å¹´å‰";
  }
  function qc(a) {
    if (!a) {
      return "";
    }
    const b = new Date();
    const c = new Date(a);
    const d = String(c.getHours()).padStart(2, "0");
    const e = String(c.getMinutes()).padStart(2, "0");
    const f = d + ":" + e;
    if (b.toDateString() === c.toDateString()) {
      return "ä»Šå¤© " + f;
    }
    const g = new Date();
    g.setDate(b.getDate() - 1);
    if (g.toDateString() === c.toDateString()) {
      return "æ˜¨å¤© " + f;
    }
    if (b.getFullYear() === c.getFullYear()) {
      const a = String(c.getMonth() + 1);
      const b = String(c.getDate());
      return a + "æœˆ" + b + "æ—¥ " + f;
    }
    const h = c.getFullYear();
    const i = String(c.getMonth() + 1);
    const j = String(c.getDate());
    return h + "å¹´" + i + "æœˆ" + j + "æ—¥ " + f;
  }
  async function rc() {
    const a = document.getElementById("nai-preset-select");
    a.innerHTML = "<option value=\"\">-- å½“å‰ä¸´æ—¶è®¾ç½® --</option>";
    const b = await Gb.naiPresets.toArray();
    b.forEach(b => {
      const c = document.createElement("option");
      c.value = b.id;
      c.textContent = b.name;
      a.appendChild(c);
    });
    if (xa) {
      a.value = xa;
      sc(true);
    } else {
      sc(false);
    }
  }
  function sc(a) {
    const b = document.getElementById("update-nai-preset-btn");
    const c = document.getElementById("bind-nai-preset-btn");
    const d = document.getElementById("delete-nai-preset-btn");
    const e = document.getElementById("save-nai-preset-btn");
    if (a) {
      b.style.display = "block";
      c.style.display = "block";
      d.style.display = "block";
      e.textContent = "å¦å­˜";
    } else {
      b.style.display = "none";
      c.style.display = "none";
      d.style.display = "none";
      e.textContent = "æ–°å¢ž";
    }
  }
  function tc() {
    return {
      resolution: document.getElementById("nai-resolution").value,
      steps: parseInt(document.getElementById("nai-steps").value),
      cfg_scale: parseFloat(document.getElementById("nai-cfg-scale").value),
      sampler: document.getElementById("nai-sampler").value,
      seed: parseInt(document.getElementById("nai-seed").value),
      uc_preset: parseInt(document.getElementById("nai-uc-preset").value),
      quality_toggle: document.getElementById("nai-quality-toggle").checked,
      smea: document.getElementById("nai-smea").checked,
      smea_dyn: document.getElementById("nai-smea-dyn").checked,
      default_positive: document.getElementById("nai-default-positive").value,
      default_negative: document.getElementById("nai-default-negative").value
    };
  }
  function uc(a) {
    if (!a) {
      return;
    }
    document.getElementById("nai-resolution").value = a.resolution || "1024x1024";
    document.getElementById("nai-steps").value = a.steps || 28;
    document.getElementById("nai-cfg-scale").value = a.cfg_scale || 5;
    document.getElementById("nai-sampler").value = a.sampler || "k_euler_ancestral";
    document.getElementById("nai-seed").value = a.seed ?? -1;
    document.getElementById("nai-uc-preset").value = a.uc_preset || 1;
    document.getElementById("nai-quality-toggle").checked = a.quality_toggle !== false;
    document.getElementById("nai-smea").checked = a.smea !== false;
    document.getElementById("nai-smea-dyn").checked = a.smea_dyn || false;
    document.getElementById("nai-default-positive").value = a.default_positive || "";
    document.getElementById("nai-default-negative").value = a.default_negative || "";
  }
  async function vc(a = false) {
    const b = tc();
    if (a && xa) {
      const a = await wb("æ›´æ–°é¢„è®¾", "ç¡®å®šè¦è¦†ç›–å½“å‰é¢„è®¾çš„å‚æ•°å—ï¼Ÿ");
      if (!a) {
        return;
      }
      await Gb.naiPresets.update(parseInt(xa), {
        settings: b
      });
      alert("é¢„è®¾å·²æ›´æ–°ï¼");
    } else {
      const a = await Db("æ–°å»ºé¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°ï¼ˆä¾‹å¦‚ï¼šåŽšæ¶‚é£Žã€åƒç´ é£Žï¼‰");
      if (!a) {
        return;
      }
      const c = await Gb.naiPresets.add({
        name: a,
        settings: b
      });
      xa = c;
      await rc();
      alert("é¢„è®¾å·²åˆ›å»ºï¼");
    }
  }
  async function wc() {
    if (!xa) {
      return;
    }
    const a = await wb("åˆ é™¤é¢„è®¾", "ç¡®å®šè¦åˆ é™¤æ­¤é¢„è®¾å—ï¼Ÿç»‘å®šäº†æ­¤é¢„è®¾çš„è§’è‰²å°†å›žé€€åˆ°å…¨å±€è®¾ç½®ã€‚", {
      confirmButtonClass: "btn-danger"
    });
    if (!a) {
      return;
    }
    await Gb.naiPresets.delete(parseInt(xa));
    const b = await Gb.chats.toArray();
    for (const a of b) {
      if (a.settings?.naiPresetId === parseInt(xa)) {
        delete a.settings.naiPresetId;
        await Gb.chats.put(a);
      }
    }
    xa = null;
    await rc();
  }
  async function xc(a) {
    const b = a.target.value;
    if (b) {
      xa = parseInt(b);
      const a = await Gb.naiPresets.get(xa);
      if (a && a.settings) {
        uc(a.settings);
      }
      sc(true);
    } else {
      xa = null;
      sc(false);
      Ac();
    }
  }
  async function yc() {
    if (!xa) {
      return;
    }
    const a = await Gb.naiPresets.get(parseInt(xa));
    if (!a) {
      return;
    }
    const b = document.getElementById("nai-binding-modal");
    const c = document.getElementById("nai-binding-list");
    const d = b.querySelector(".modal-header span");
    d.textContent = "å°†é¢„è®¾â€œ" + a.name + "â€ç»‘å®šåˆ°...";
    c.innerHTML = "";
    const e = Object.values(v.chats).sort((a, b) => a.name.localeCompare(b.name));
    e.forEach(a => {
      const b = a.settings?.naiPresetId === xa;
      const d = document.createElement("div");
      d.className = "contact-picker-item";
      d.innerHTML = "\n            <input type=\"checkbox\" class=\"nai-binding-checkbox\" data-chat-id=\"" + a.id + "\" " + (b ? "checked" : "") + " style=\"margin-right: 15px;\">\n            <img src=\"" + (a.isGroup ? a.settings.groupAvatar : a.settings.aiAvatar || Na) + `" class="avatar">
            <div style="display:flex; flex-direction:column;">
                <span class="name">` + a.name + "</span>\n                " + (b ? "<span style=\"font-size:10px; color:green;\">å·²ç»‘å®š</span>" : "") + `
            </div>
        `;
      d.addEventListener("click", a => {
        if (a.target.type !== "checkbox") {
          const a = d.querySelector("input");
          a.checked = !a.checked;
        }
      });
      c.appendChild(d);
    });
    b.classList.add("visible");
  }
  async function zc() {
    if (!xa) {
      return;
    }
    const a = document.querySelectorAll(".nai-binding-checkbox");
    const b = [];
    for (const c of a) {
      const a = c.dataset.chatId;
      const d = v.chats[a];
      const e = c.checked;
      if (d) {
        if (e) {
          if (d.settings.naiPresetId !== xa) {
            d.settings.naiPresetId = xa;
            b.push(d);
          }
        } else if (d.settings.naiPresetId === xa) {
          delete d.settings.naiPresetId;
          b.push(d);
        }
      }
    }
    if (b.length > 0) {
      await Gb.chats.bulkPut(b);
      await Bb("ä¿å­˜æˆåŠŸ", "å·²æ›´æ–° " + b.length + " ä¸ªè§’è‰²çš„ç»‘å®šè®¾ç½®ã€‚");
    } else {}
    document.getElementById("nai-binding-modal").classList.remove("visible");
  }
  function Ac() {
    const a = Dc();
    document.getElementById("nai-resolution").value = a.resolution;
    document.getElementById("nai-steps").value = a.steps;
    document.getElementById("nai-cfg-scale").value = a.cfg_scale;
    document.getElementById("nai-sampler").value = a.sampler;
    document.getElementById("nai-seed").value = a.seed;
    document.getElementById("nai-uc-preset").value = a.uc_preset;
    document.getElementById("nai-quality-toggle").checked = a.quality_toggle;
    document.getElementById("nai-smea").checked = a.smea;
    document.getElementById("nai-smea-dyn").checked = a.smea_dyn;
    document.getElementById("nai-default-positive").value = a.default_positive;
    document.getElementById("nai-default-negative").value = a.default_negative;
    document.getElementById("nai-cors-proxy").value = a.cors_proxy;
    document.getElementById("nai-custom-proxy-url").value = a.custom_proxy_url || "";
    const b = document.getElementById("nai-custom-proxy-group");
    b.style.display = a.cors_proxy === "custom" ? "block" : "none";
    rc();
  }
  function Bc() {
    const a = document.getElementById("novelai-switch").checked;
    const b = document.getElementById("novelai-model").value;
    const c = document.getElementById("novelai-api-key").value.trim();
    localStorage.setItem("novelai-enabled", a);
    localStorage.setItem("novelai-model", b);
    localStorage.setItem("novelai-api-key", c);
    const d = {
      resolution: document.getElementById("nai-resolution").value,
      steps: parseInt(document.getElementById("nai-steps").value),
      cfg_scale: parseFloat(document.getElementById("nai-cfg-scale").value),
      sampler: document.getElementById("nai-sampler").value,
      seed: parseInt(document.getElementById("nai-seed").value),
      uc_preset: parseInt(document.getElementById("nai-uc-preset").value),
      quality_toggle: document.getElementById("nai-quality-toggle").checked,
      smea: document.getElementById("nai-smea").checked,
      smea_dyn: document.getElementById("nai-smea-dyn").checked,
      default_positive: document.getElementById("nai-default-positive").value,
      default_negative: document.getElementById("nai-default-negative").value,
      cors_proxy: document.getElementById("nai-cors-proxy").value,
      custom_proxy_url: document.getElementById("nai-custom-proxy-url").value
    };
    localStorage.setItem("novelai-settings", JSON.stringify(d));
  }
  function Cc() {
    localStorage.removeItem("novelai-settings");
    Ac();
    alert("å·²æ¢å¤é»˜è®¤è®¾ç½®ï¼");
  }
  function Dc() {
    const a = {
      resolution: "1024x1024",
      steps: 28,
      cfg_scale: 5,
      sampler: "k_euler_ancestral",
      seed: -1,
      uc_preset: 1,
      quality_toggle: true,
      smea: true,
      smea_dyn: false,
      default_positive: "masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style",
      default_negative: "lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry",
      cors_proxy: "https://corsproxy.io/?",
      custom_proxy_url: ""
    };
    const b = localStorage.getItem("novelai-settings");
    if (b) {
      try {
        return {
          ...a,
          ...JSON.parse(b)
        };
      } catch (b) {
        return a;
      }
    }
    return a;
  }
  async function Ec(a, b) {
    console.log("ðŸŽ¨ [NAIæ ¸å¿ƒç”Ÿæˆ] å¼€å§‹... Prompt: \"" + a + "\", ChatID: " + b);
    const c = Fc(b);
    const d = a + ", " + c.positive;
    const e = c.negative;
    console.log("ðŸ“ ä½¿ç”¨" + (c.source === "character" ? "è§’è‰²ä¸“å±ž" : "ç³»ç»Ÿ") + "æç¤ºè¯é…ç½®");
    console.log("   [+] æœ€ç»ˆæ­£é¢æç¤ºè¯:", d);
    console.log("   [-] æœ€ç»ˆè´Ÿé¢æç¤ºè¯:", e);
    const f = localStorage.getItem("novelai-api-key");
    const g = localStorage.getItem("novelai-model") || "nai-diffusion-4-5-full";
    let h = Dc();
    if (b && v.chats[b] && v.chats[b].settings.naiPresetId) {
      const a = v.chats[b].settings.naiPresetId;
      const c = await Gb.naiPresets.get(a);
      if (c && c.settings) {
        console.log("ðŸŽ¨ [NAI] æ£€æµ‹åˆ°è§’è‰²ç»‘å®šäº†é¢„è®¾ \"" + c.name + "\"ï¼Œæ­£åœ¨åº”ç”¨é¢„è®¾å‚æ•°...");
        h = {
          ...h,
          ...c.settings
        };
      } else {
        console.warn("[NAI] è§’è‰²ç»‘å®šäº†é¢„è®¾ID " + a + "ï¼Œä½†æ•°æ®åº“ä¸­æœªæ‰¾åˆ°ï¼Œå°†ä½¿ç”¨å…¨å±€è®¾ç½®ã€‚");
      }
    }
    if (!f) {
      throw new Error("NovelAI API Keyæœªé…ç½®ã€‚è¯·åœ¨NovelAIè®¾ç½®ä¸­å¡«å†™API Keyã€‚");
    }
    const [i, j] = h.resolution.split("x").map(Number);
    let k;
    if (g.includes("nai-diffusion-4")) {
      k = {
        input: d,
        model: g,
        action: "generate",
        parameters: {
          params_version: 3,
          width: i,
          height: j,
          scale: h.cfg_scale,
          sampler: h.sampler,
          steps: h.steps,
          seed: h.seed === -1 ? Math.floor(Math.random() * 9999999999) : h.seed,
          n_samples: 1,
          ucPreset: h.uc_preset,
          qualityToggle: h.quality_toggle,
          add_original_image: true,
          noise_schedule: "karras",
          v4_prompt: {
            caption: {
              base_caption: d,
              char_captions: []
            },
            use_coords: false,
            use_order: true
          },
          v4_negative_prompt: {
            caption: {
              base_caption: e,
              char_captions: []
            },
            legacy_uc: false
          },
          negative_prompt: e,
          autoSmea: false,
          dynamic_thresholding: false,
          controlnet_strength: 1,
          legacy: false,
          cfg_rescale: 0,
          legacy_v3_extend: false,
          skip_cfg_above_sigma: null,
          use_coords: false,
          legacy_uc: false,
          normalize_reference_strength_multiple: true,
          inpaintImg2ImgStrength: 1,
          characterPrompts: [],
          deliberate_euler_ancestral_bug: false,
          prefer_brownian: true
        }
      };
    } else {
      k = {
        input: d,
        model: g,
        action: "generate",
        parameters: {
          width: i,
          height: j,
          scale: h.cfg_scale,
          sampler: h.sampler,
          steps: h.steps,
          seed: h.seed === -1 ? Math.floor(Math.random() * 9999999999) : h.seed,
          n_samples: 1,
          ucPreset: h.uc_preset,
          qualityToggle: h.quality_toggle,
          sm: h.smea,
          sm_dyn: h.smea_dyn,
          negative_prompt: e,
          dynamic_thresholding: false,
          controlnet_strength: 1,
          legacy: false,
          add_original_image: false,
          cfg_rescale: 0,
          noise_schedule: "native"
        }
      };
    }
    console.log("ðŸš€ å‘é€NAIè¯·æ±‚:", k);
    let l;
    if (g.includes("nai-diffusion-4")) {
      l = "https://image.novelai.net/ai/generate-image-stream";
    } else {
      l = "https://image.novelai.net/ai/generate-image";
    }
    let m = h.cors_proxy;
    if (m === "custom") {
      m = h.custom_proxy_url || "";
    }
    if (m && m !== "") {
      l = m + l;
    }
    const n = await fetch(l, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + f
      },
      body: JSON.stringify(k)
    });
    if (!n.ok) {
      const a = await n.text();
      throw new Error("APIè¯·æ±‚å¤±è´¥ (" + n.status + "): " + a);
    }
    const o = n.headers.get("content-type");
    let p;
    let q;
    if (o && o.includes("text/event-stream")) {
      const a = await n.text();
      const b = a.trim().split("\n");
      let c = null;
      for (let a = b.length - 1; a >= 0; a--) {
        const d = b[a].trim();
        if (d.startsWith("data: ") && d !== "data: [DONE]") {
          const a = d.substring(6);
          try {
            const b = JSON.parse(a);
            if (b.event_type === "final" && b.image) {
              c = b.image;
              break;
            }
            if (b.data) {
              c = b.data;
              break;
            }
            if (b.image) {
              c = b.image;
              break;
            }
          } catch (b) {
            c = a;
            break;
          }
        }
      }
      if (!c) {
        throw new Error("æ— æ³•ä»Ž SSE å“åº”ä¸­æå–å›¾ç‰‡æ•°æ®");
      }
      const d = c.startsWith("iVBORw0KGgo");
      const e = c.startsWith("/9j/");
      if (d || e) {
        q = "data:" + (d ? "image/png" : "image/jpeg") + ";base64," + c;
      } else {
        const a = atob(c);
        const b = new Uint8Array(a.length);
        for (let c = 0; c < a.length; c++) {
          b[c] = a.charCodeAt(c);
        }
        p = new Blob([b]);
      }
    } else {
      p = await n.blob();
    }
    if (!q && p) {
      if (typeof JSZip === "undefined") {
        throw new Error("JSZipåº“æœªåŠ è½½");
      }
      const a = await JSZip.loadAsync(p);
      let b = null;
      for (let c in a.files) {
        if (c.match(/\.(png|jpg|jpeg|webp)$/i)) {
          b = a.files[c];
          break;
        }
      }
      if (!b) {
        throw new Error("ZIPæ–‡ä»¶ä¸­æœªæ‰¾åˆ°å›¾ç‰‡");
      }
      const c = await b.async("blob");
      q = await new Promise((a, b) => {
        const d = new FileReader();
        d.onloadend = () => a(d.result);
        d.onerror = b;
        d.readAsDataURL(c);
      });
    }
    console.log("âœ… [NAIæ ¸å¿ƒç”Ÿæˆ] æˆåŠŸï¼");
    return {
      imageUrl: q,
      fullPrompt: d
    };
  }
  function Fc(a) {
    const b = Dc();
    if (!a || !v.chats[a]) {
      console.log("âš ï¸ NAIæç¤ºè¯ï¼šæ²¡æœ‰è§’è‰²ï¼Œä½¿ç”¨ç³»ç»Ÿé…ç½®");
      return {
        positive: b.default_positive,
        negative: b.default_negative,
        source: "system"
      };
    }
    const c = v.chats[a];
    const d = c.settings.naiSettings || {};
    if (d.promptSource === "character") {
      console.log("âœ… NAIæç¤ºè¯ï¼šä½¿ç”¨è§’è‰²é…ç½®");
      console.log("   æ­£é¢:", d.characterPositivePrompt || "(ç©º)");
      console.log("   è´Ÿé¢:", d.characterNegativePrompt || "(ç©º)");
      return {
        positive: d.characterPositivePrompt || "",
        negative: d.characterNegativePrompt || "",
        source: "character"
      };
    } else {
      console.log("âœ… NAIæç¤ºè¯ï¼šä½¿ç”¨ç³»ç»Ÿé…ç½®");
      console.log("   æ­£é¢:", b.default_positive || "(ç©º)");
      console.log("   è´Ÿé¢:", b.default_negative || "(ç©º)");
      return {
        positive: b.default_positive,
        negative: b.default_negative,
        source: "system"
      };
    }
  }
  async function Gc() {
    const a = document.getElementById("novelai-api-key").value.trim();
    const b = document.getElementById("novelai-model").value;
    const c = document.getElementById("nai-test-prompt").value.trim();
    if (!a) {
      alert("è¯·å…ˆé…ç½®NovelAI API Keyï¼");
      return;
    }
    if (!c) {
      alert("è¯·è¾“å…¥æç¤ºè¯ï¼");
      return;
    }
    const d = Dc();
    const e = document.getElementById("nai-test-negative").value.trim();
    const f = document.getElementById("nai-test-status");
    const g = document.getElementById("nai-test-result");
    const h = document.getElementById("nai-test-error");
    const i = document.getElementById("nai-generate-btn");
    f.style.display = "block";
    g.style.display = "none";
    h.style.display = "none";
    i.disabled = true;
    i.textContent = "ç”Ÿæˆä¸­...";
    try {
      const [h, i] = d.resolution.split("x").map(Number);
      let j;
      if (b.includes("nai-diffusion-4")) {
        j = {
          input: c,
          model: b,
          action: "generate",
          parameters: {
            params_version: 3,
            width: h,
            height: i,
            scale: d.cfg_scale,
            sampler: d.sampler,
            steps: d.steps,
            seed: d.seed === -1 ? Math.floor(Math.random() * 9999999999) : d.seed,
            n_samples: 1,
            ucPreset: d.uc_preset,
            qualityToggle: d.quality_toggle,
            autoSmea: false,
            dynamic_thresholding: false,
            controlnet_strength: 1,
            legacy: false,
            add_original_image: true,
            cfg_rescale: 0,
            noise_schedule: "karras",
            legacy_v3_extend: false,
            skip_cfg_above_sigma: null,
            use_coords: false,
            legacy_uc: false,
            normalize_reference_strength_multiple: true,
            inpaintImg2ImgStrength: 1,
            characterPrompts: [],
            v4_prompt: {
              caption: {
                base_caption: c,
                char_captions: []
              },
              use_coords: false,
              use_order: true
            },
            v4_negative_prompt: {
              caption: {
                base_caption: e,
                char_captions: []
              },
              legacy_uc: false
            },
            negative_prompt: e,
            deliberate_euler_ancestral_bug: false,
            prefer_brownian: true
          }
        };
      } else {
        j = {
          input: c,
          model: b,
          action: "generate",
          parameters: {
            width: h,
            height: i,
            scale: d.cfg_scale,
            sampler: d.sampler,
            steps: d.steps,
            seed: d.seed === -1 ? Math.floor(Math.random() * 9999999999) : d.seed,
            n_samples: 1,
            ucPreset: d.uc_preset,
            qualityToggle: d.quality_toggle,
            sm: d.smea,
            sm_dyn: d.smea_dyn,
            dynamic_thresholding: false,
            controlnet_strength: 1,
            legacy: false,
            add_original_image: false,
            cfg_rescale: 0,
            noise_schedule: "native",
            negative_prompt: e
          }
        };
      }
      console.log("ðŸ“¤ å‘é€è¯·æ±‚åˆ° NovelAI API");
      console.log("ðŸ“Š ä½¿ç”¨æ¨¡åž‹:", b);
      console.log("ðŸ“‹ è¯·æ±‚ä½“:", JSON.stringify(j, null, 2));
      let k;
      if (b.includes("nai-diffusion-4")) {
        k = "https://image.novelai.net/ai/generate-image-stream";
      } else {
        k = "https://image.novelai.net/ai/generate-image";
      }
      let l = d.cors_proxy;
      if (l === "custom") {
        l = d.custom_proxy_url || "";
      }
      if (l && l !== "") {
        k = l + encodeURIComponent(k);
      }
      const m = /Chrome/.test(navigator.userAgent) && !/Edg/.test(navigator.userAgent);
      let n = {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + a
        },
        body: JSON.stringify(j)
      };
      if (m) {
        console.log("ðŸ”§ æ£€æµ‹åˆ°Chromeæµè§ˆå™¨ï¼Œå¯ç”¨headerså…¼å®¹æ€§å¤„ç†");
        const a = {};
        for (const [b, c] of Object.entries(n.headers)) {
          a[b] = c.replace(/[^\x00-\xFF]/g, "");
        }
        n.headers = a;
      }
      const o = await fetch(k, n);
      console.log("Response status:", o.status);
      console.log("Response headers:", [...o.headers.entries()]);
      if (!o.ok) {
        const a = await o.text();
        console.error("APIé”™è¯¯å“åº”:", a);
        throw new Error("APIè¯·æ±‚å¤±è´¥ (" + o.status + "): " + a);
      }
      const p = o.headers.get("content-type");
      console.log("Content-Type:", p);
      let q;
      if (p && p.includes("text/event-stream")) {
        console.log("æ£€æµ‹åˆ° SSE æµå¼å“åº”ï¼Œå¼€å§‹è§£æž...");
        f.textContent = "æ­£åœ¨æŽ¥æ”¶æµå¼æ•°æ®...";
        const a = await o.text();
        console.log("æ”¶åˆ° SSE æ•°æ®ï¼Œå¤§å°:", a.length);
        const b = a.trim().split("\n");
        let c = null;
        for (let a = b.length - 1; a >= 0; a--) {
          const d = b[a].trim();
          if (d.startsWith("data: ") && d !== "data: [DONE]") {
            const a = d.substring(6);
            try {
              const b = JSON.parse(a);
              if (b.event_type === "final" && b.image) {
                c = b.image;
                console.log("âœ… æ‰¾åˆ° final äº‹ä»¶çš„å›¾ç‰‡æ•°æ®");
                break;
              }
              if (b.data) {
                c = b.data;
                console.log("ä»Ž JSON.data ä¸­æå–å›¾ç‰‡æ•°æ®");
                break;
              }
              if (b.image) {
                c = b.image;
                console.log("ä»Ž JSON.image ä¸­æå–å›¾ç‰‡æ•°æ®");
                break;
              }
            } catch (b) {
              c = a;
              console.log("ç›´æŽ¥ä½¿ç”¨ base64 æ•°æ®");
              break;
            }
          }
        }
        if (!c) {
          throw new Error("æ— æ³•ä»Ž SSE å“åº”ä¸­æå–å›¾ç‰‡æ•°æ®");
        }
        const d = c.startsWith("iVBORw0KGgo");
        const e = c.startsWith("/9j/");
        if (d || e) {
          console.log("âœ… æ£€æµ‹åˆ°ç›´æŽ¥çš„å›¾ç‰‡ base64 æ•°æ® (PNG/JPEG)");
          const a = atob(c);
          const b = new Uint8Array(a.length);
          for (let c = 0; c < a.length; c++) {
            b[c] = a.charCodeAt(c);
          }
          const e = new Blob([b], {
            type: d ? "image/png" : "image/jpeg"
          });
          console.log("å›¾ç‰‡ Blob åˆ›å»ºæˆåŠŸï¼Œå¤§å°:", e.size);
          const h = URL.createObjectURL(e);
          document.getElementById("nai-result-image").src = h;
          f.style.display = "none";
          g.style.display = "block";
          console.log("âœ… å›¾ç‰‡æ˜¾ç¤ºæˆåŠŸï¼ðŸŽ¨");
          return;
        }
        console.log("å½“ä½œ ZIP æ–‡ä»¶å¤„ç†...");
        const h = atob(c);
        const i = new Uint8Array(h.length);
        for (let a = 0; a < h.length; a++) {
          i[a] = h.charCodeAt(a);
        }
        q = new Blob([i]);
        console.log("ZIP Blob å¤§å°:", q.size);
      } else {
        q = await o.blob();
        console.log("æ”¶åˆ°æ•°æ®ï¼Œç±»åž‹:", q.type, "å¤§å°:", q.size);
      }
      try {
        if (typeof JSZip === "undefined") {
          throw new Error("JSZipåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
        }
        f.textContent = "æ­£åœ¨è§£åŽ‹å›¾ç‰‡...";
        const a = await JSZip.loadAsync(q);
        console.log("ZIPæ–‡ä»¶å†…å®¹:", Object.keys(a.files));
        let b = null;
        for (let c in a.files) {
          if (c.match(/\.(png|jpg|jpeg|webp)$/i)) {
            b = a.files[c];
            console.log("æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶:", c);
            break;
          }
        }
        if (!b) {
          throw new Error("ZIPæ–‡ä»¶ä¸­æœªæ‰¾åˆ°å›¾ç‰‡");
        }
        const c = await b.async("blob");
        console.log("æå–çš„å›¾ç‰‡å¤§å°:", c.size);
        const d = URL.createObjectURL(c);
        console.log("ç”Ÿæˆçš„å›¾ç‰‡URL:", d);
        document.getElementById("nai-result-image").src = d;
        f.style.display = "none";
        g.style.display = "block";
      } catch (a) {
        console.error("ZIPè§£åŽ‹å¤±è´¥:", a);
        console.log("å°è¯•ç›´æŽ¥ä½œä¸ºå›¾ç‰‡æ˜¾ç¤º...");
        if (q.type.startsWith("image/")) {
          const a = URL.createObjectURL(q);
          document.getElementById("nai-result-image").src = a;
          f.style.display = "none";
          g.style.display = "block";
        } else {
          throw new Error("å›¾ç‰‡æ ¼å¼å¤„ç†å¤±è´¥: " + a.message);
        }
      }
    } catch (a) {
      console.error("NovelAIç”Ÿæˆå¤±è´¥:", a);
      f.style.display = "none";
      h.style.display = "block";
      h.textContent = "ç”Ÿæˆå¤±è´¥: " + a.message;
    } finally {
      i.disabled = false;
      i.textContent = "ç”Ÿæˆå›¾åƒ";
    }
  }
  function Hc(a, b, c = false) {
    Gj();
    let d = "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg";
    let e = "EPhone æ¶ˆæ¯";
    if (a && v.chats[a]) {
      const b = v.chats[a];
      e = b.name;
      d = b.settings.aiAvatar || b.settings.groupAvatar || Na;
    }
    if (document.visibilityState === "hidden" || c) {
      if ("Notification" in window && Notification.permission === "granted") {
        try {
          const a = {
            body: b,
            icon: d
          };
          if (navigator.serviceWorker && navigator.serviceWorker.controller) {
            navigator.serviceWorker.ready.then(b => {
              b.showNotification(e, a);
            });
          } else {
            new Notification(e, a);
          }
        } catch (a) {
          console.warn("ç³»ç»Ÿé€šçŸ¥å‘é€å¤±è´¥:", a);
        }
      }
      if (document.visibilityState === "hidden") {
        return;
      }
    }
    const f = v.chats[a];
    if (!f) {
      return;
    }
    const g = document.getElementById("notification-bar");
    if (!g) {
      return;
    }
    clearTimeout(Ra);
    const h = document.getElementById("notification-avatar");
    const i = document.getElementById("notification-content");
    if (h) {
      h.src = f.settings.aiAvatar || f.settings.groupAvatar || Na;
    }
    if (i) {
      i.querySelector(".name").textContent = f.name;
      i.querySelector(".message").textContent = b;
    }
    g.classList.remove("visible");
    g.offsetWidth;
    g.classList.add("visible");
    const j = g.cloneNode(true);
    g.parentNode.replaceChild(j, g);
    j.addEventListener("click", () => {
      Qd(a);
      j.classList.remove("visible");
    });
    Ra = // TOLOOK
    setTimeout(() => {
      j.classList.remove("visible");
    }, 4000);
    po();
  }
  function Ic() {
    const a = new Date();
    const b = a.toLocaleTimeString("zh-CN", {
      hour: "2-digit",
      minute: "2-digit"
    });
    const c = a.toLocaleDateString("zh-CN", {
      weekday: "long",
      month: "long",
      day: "numeric"
    });
    document.getElementById("status-bar-time").textContent = b;
  }
  function Jc(a) {
    if (!a) {
      return [{
        type: "text",
        content: "(AIè¿”å›žäº†ç©ºå†…å®¹)"
      }];
    }
    let b = a.trim();
    const c = /```json\s*([\s\S]*?)\s*```/;
    const d = b.match(c);
    if (d && d[1]) {
      b = d[1].trim();
      console.log("è§£æžå™¨ï¼šå·²å¯ç”¨ Markdown æå–æ¨¡å¼ã€‚");
    }
    if (b.startsWith("[") && b.endsWith("]")) {
      try {
        const a = JSON.parse(b);
        if (Array.isArray(a)) {
          console.log("è§£æžæˆåŠŸï¼šæ ‡å‡†JSONæ•°ç»„æ ¼å¼ã€‚");
          return a;
        }
      } catch (a) {
        console.warn("æ ‡å‡†JSONæ•°ç»„è§£æžå¤±è´¥ï¼Œå°†å°è¯•å¼ºåŠ›æå–...");
      }
    }
    const e = b.indexOf("[");
    const f = b.lastIndexOf("}");
    if (e !== -1 && f !== -1 && f > e) {
      const a = b.indexOf("]", f);
      if (a !== -1) {
        const c = b.substring(e, a + 1);
        try {
          const a = JSON.parse(c);
          if (Array.isArray(a)) {
            console.log("è§£æžæˆåŠŸï¼šé€šè¿‡å¼ºåŠ›æå– [ ... } ... ] æ¨¡å¼ã€‚");
            return a;
          }
        } catch (a) {
          console.warn("å¼ºåŠ›æå– [ ... } ... ] å¤±è´¥ï¼Œå°†å°è¯•æå–å•ä¸ªå¯¹è±¡...");
        }
      }
    }
    const g = b.match(/{[^{}]*}/g);
    if (g) {
      const a = [];
      for (const b of g) {
        try {
          const c = JSON.parse(b);
          a.push(c);
        } catch (a) {
          console.warn("è·³è¿‡ä¸€ä¸ªæ— æ•ˆçš„JSONç‰‡æ®µ:", b);
        }
      }
      if (a.length > 0) {
        console.log("è§£æžæˆåŠŸï¼šé€šè¿‡å¼ºåŠ›æå– {...} æ¨¡å¼ã€‚");
        return a;
      }
    }
    console.error("æ‰€æœ‰è§£æžæ–¹æ¡ˆå‡å¤±è´¥ï¼å°†è¿”å›žåŽŸå§‹æ–‡æœ¬ã€‚åŽŸå§‹å›žå¤:", a);
    return [{
      type: "text",
      content: a
    }];
  }
  function Kc(a = new Date()) {
    const b = a.getHours();
    if (b >= 0 && b < 5) {
      return "å‡Œæ™¨";
    } else if (b >= 5 && b < 9) {
      return "æ—©ä¸Š";
    } else if (b >= 9 && b < 13) {
      return "ä¸Šåˆ";
    } else if (b >= 13 && b < 18) {
      return "ä¸‹åˆ";
    } else if (b >= 18 && b < 24) {
      return "æ™šä¸Š";
    }
    return "çŽ°åœ¨";
  }
  async function Lc(a = null) {
    const b = document.getElementById("api-preset-select");
    b.innerHTML = "<option value=\"current\">å½“å‰é…ç½® (æœªä¿å­˜)</option>";
    const c = await Gb.apiPresets.toArray();
    c.forEach(a => {
      const c = document.createElement("option");
      c.value = a.id;
      c.textContent = a.name;
      b.appendChild(c);
    });
    if (a) {
      b.value = a;
      return;
    }
    const d = v.apiConfig;
    let e = null;
    for (const b of c) {
      if (b.proxyUrl === d.proxyUrl && b.apiKey === d.apiKey && b.model === d.model && b.secondaryProxyUrl === d.secondaryProxyUrl && b.secondaryApiKey === d.secondaryApiKey && b.secondaryModel === d.secondaryModel && (b.minimaxGroupId || "") === (d.minimaxGroupId || "") && (b.minimaxApiKey || "") === (d.minimaxApiKey || "") && (b.minimaxModel || "speech-01") === (d.minimaxModel || "speech-01")) {
        e = b.id;
        break;
      }
    }
    if (e) {
      b.value = e;
    } else {
      b.value = "current";
    }
  }
  async function Mc() {
    const a = document.getElementById("api-preset-select");
    const b = parseInt(a.value);
    if (isNaN(b)) {
      return;
    }
    const c = await Gb.apiPresets.get(b);
    if (c) {
      v.apiConfig = {
        id: "main",
        proxyUrl: c.proxyUrl,
        apiKey: c.apiKey,
        model: c.model,
        secondaryProxyUrl: c.secondaryProxyUrl,
        secondaryApiKey: c.secondaryApiKey,
        secondaryModel: c.secondaryModel,
        minimaxGroupId: c.minimaxGroupId,
        minimaxApiKey: c.minimaxApiKey,
        minimaxModel: c.minimaxModel
      };
      const a = localStorage.getItem("imgbb-enabled");
      const d = localStorage.getItem("imgbb-api-key");
      const e = localStorage.getItem("catbox-enabled");
      const f = localStorage.getItem("catbox-userhash");
      if (a !== null) {
        v.apiConfig.imgbbEnable = a === "true";
      }
      if (d !== null) {
        v.apiConfig.imgbbApiKey = d;
      }
      if (e !== null) {
        v.apiConfig.catboxEnable = e === "true";
      }
      if (f !== null) {
        v.apiConfig.catboxUserHash = f;
      }
      const g = localStorage.getItem("minimax-group-id");
      const h = localStorage.getItem("minimax-api-key");
      const i = localStorage.getItem("minimax-model");
      if (g !== null) {
        v.apiConfig.minimaxGroupId = g;
      }
      if (h !== null) {
        v.apiConfig.minimaxApiKey = h;
      }
      if (i !== null) {
        v.apiConfig.minimaxModel = i;
      }
      const j = localStorage.getItem("github-enabled");
      const k = localStorage.getItem("github-auto-backup");
      const l = localStorage.getItem("github-backup-interval");
      const m = localStorage.getItem("github-proxy-enabled");
      const n = localStorage.getItem("github-proxy-url");
      const o = localStorage.getItem("github-username");
      const p = localStorage.getItem("github-repo");
      const q = localStorage.getItem("github-token");
      const r = localStorage.getItem("github-filename");
      if (j !== null) {
        v.apiConfig.githubEnable = j === "true";
      }
      if (k !== null) {
        v.apiConfig.githubAutoBackup = k === "true";
      }
      if (l !== null) {
        v.apiConfig.githubBackupInterval = parseInt(l);
      }
      if (m !== null) {
        v.apiConfig.githubProxyEnable = m === "true";
      }
      if (n !== null) {
        v.apiConfig.githubProxyUrl = n;
      }
      if (o !== null) {
        v.apiConfig.githubUsername = o;
      }
      if (p !== null) {
        v.apiConfig.githubRepo = p;
      }
      if (q !== null) {
        v.apiConfig.githubToken = q;
      }
      if (r !== null) {
        v.apiConfig.githubFilename = r;
      }
      await Gb.apiConfig.put(v.apiConfig);
      Pc(b);
      document.getElementById("fetch-models-btn").click();
      if (c.secondaryProxyUrl && c.secondaryApiKey) {
        document.getElementById("fetch-secondary-models-btn").click();
      }
    }
  }
  async function Nc() {
    const a = await Db("ä¿å­˜ API é¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°");
    if (!a || !a.trim()) {
      return;
    }
    const b = {
      name: a.trim(),
      proxyUrl: document.getElementById("proxy-url").value.trim(),
      apiKey: document.getElementById("api-key").value.trim(),
      model: document.getElementById("model-select").value,
      secondaryProxyUrl: document.getElementById("secondary-proxy-url").value.trim(),
      secondaryApiKey: document.getElementById("secondary-api-key").value.trim(),
      secondaryModel: document.getElementById("secondary-model-select").value,
      minimaxGroupId: document.getElementById("minimax-group-id").value.trim(),
      minimaxApiKey: document.getElementById("minimax-api-key").value.trim(),
      minimaxModel: document.getElementById("minimax-model-select").value
    };
    const c = await Gb.apiPresets.where("name").equals(b.name).first();
    if (c) {
      const a = await wb("è¦†ç›–é¢„è®¾", "åä¸º â€œ" + b.name + "â€ çš„é¢„è®¾å·²å­˜åœ¨ã€‚è¦è¦†ç›–å®ƒå—ï¼Ÿ", {
        confirmButtonClass: "btn-danger"
      });
      if (!a) {
        return;
      }
      b.id = c.id;
    }
    await Gb.apiPresets.put(b);
    await Lc();
    alert("API é¢„è®¾å·²ä¿å­˜ï¼");
  }
  async function Oc() {
    const a = document.getElementById("api-preset-select");
    const b = parseInt(a.value);
    if (isNaN(b)) {
      alert("è¯·å…ˆä»Žä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾ã€‚");
      return;
    }
    const c = await Gb.apiPresets.get(b);
    if (!c) {
      return;
    }
    const d = await wb("åˆ é™¤é¢„è®¾", "ç¡®å®šè¦åˆ é™¤é¢„è®¾ â€œ" + c.name + "â€ å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (d) {
      await Gb.apiPresets.delete(b);
      await Lc();
      alert("é¢„è®¾å·²åˆ é™¤ã€‚");
    }
  }
  function Pc(a = null) {
    document.getElementById("proxy-url").value = v.apiConfig.proxyUrl || "";
    document.getElementById("api-key").value = v.apiConfig.apiKey || "";
    document.getElementById("secondary-proxy-url").value = v.apiConfig.secondaryProxyUrl || "";
    document.getElementById("secondary-api-key").value = v.apiConfig.secondaryApiKey || "";
    document.getElementById("background-activity-switch").checked = v.globalSettings.enableBackgroundActivity || false;
    document.getElementById("background-interval-input").value = v.globalSettings.backgroundActivityInterval || 60;
    document.getElementById("block-cooldown-input").value = v.globalSettings.blockCooldownHours || 1;
    document.getElementById("enable-ai-drawing-switch").checked = v.globalSettings.enableAiDrawing;
    document.getElementById("chat-render-window-input").value = v.globalSettings.chatRenderWindow || 50;
    document.getElementById("chat-list-render-window-input").value = v.globalSettings.chatListRenderWindow || 30;
    const b = document.getElementById("api-temperature-slider");
    const c = document.getElementById("api-temperature-value");
    const d = v.globalSettings.apiTemperature || 0.8;
    b.value = d;
    c.textContent = d;
    const e = localStorage.getItem("minimax-group-id");
    const f = localStorage.getItem("minimax-api-key");
    const g = localStorage.getItem("minimax-model");
    if (e !== null) {
      v.apiConfig.minimaxGroupId = e;
    }
    if (f !== null) {
      v.apiConfig.minimaxApiKey = f;
    }
    if (g !== null) {
      v.apiConfig.minimaxModel = g;
    }
    document.getElementById("minimax-group-id").value = v.apiConfig.minimaxGroupId || "";
    document.getElementById("minimax-api-key").value = v.apiConfig.minimaxApiKey || "";
    const h = document.getElementById("minimax-model-select");
    if (h) {
      const a = [{
        id: "speech-01-turbo",
        name: "Speech-01 Turbo (å¿«é€Ÿç‰ˆ)"
      }, {
        id: "speech-01-hd",
        name: "Speech-01 HD (é«˜æ¸…ç‰ˆ)"
      }, {
        id: "speech-02-turbo",
        name: "Speech-02 Turbo"
      }, {
        id: "speech-02-hd",
        name: "Speech-02 HD"
      }, {
        id: "speech-2.5-hd-preview",
        name: "Speech-2.5 HD (é«˜æ¸…)"
      }, {
        id: "speech-2.6-turbo",
        name: "Speech-2.6 Turbo"
      }, {
        id: "speech-2.6-hd",
        name: "Speech-2.6 HD"
      }];
      h.innerHTML = "";
      a.forEach(a => {
        const b = document.createElement("option");
        b.value = a.id;
        b.textContent = a.name;
        h.appendChild(b);
      });
      h.value = v.apiConfig.minimaxModel || "speech-01";
      const b = document.getElementById("minimax-domain-select");
      if (b) {
        b.value = v.apiConfig.minimaxDomain || localStorage.getItem("minimax-domain") || "https://api.minimax.chat";
      }
    }
    const i = localStorage.getItem("novelai-enabled") === "true";
    const j = localStorage.getItem("novelai-model") || "nai-diffusion-4-5-full";
    const k = localStorage.getItem("novelai-api-key") || "";
    document.getElementById("novelai-switch").checked = i;
    document.getElementById("novelai-model").value = j;
    document.getElementById("novelai-api-key").value = k;
    document.getElementById("novelai-details").style.display = i ? "block" : "none";
    const l = document.getElementById("imgbb-enable-switch");
    const m = document.getElementById("imgbb-api-key");
    const n = document.getElementById("imgbb-settings-details");
    const o = localStorage.getItem("imgbb-enabled");
    const p = localStorage.getItem("imgbb-api-key");
    if (o !== null) {
      v.apiConfig.imgbbEnable = o === "true";
    }
    if (p !== null) {
      v.apiConfig.imgbbApiKey = p;
    }
    if (l) {
      l.checked = v.apiConfig.imgbbEnable || false;
      m.value = v.apiConfig.imgbbApiKey || "";
      n.style.display = l.checked ? "block" : "none";
    }
    const q = document.getElementById("catbox-enable-switch");
    const r = document.getElementById("catbox-userhash");
    const s = document.getElementById("catbox-settings-details");
    const t = localStorage.getItem("catbox-enabled");
    const u = localStorage.getItem("catbox-userhash");
    if (t !== null) {
      v.apiConfig.catboxEnable = t === "true";
    }
    if (u !== null) {
      v.apiConfig.catboxUserHash = u;
    }
    if (q) {
      q.checked = v.apiConfig.catboxEnable || false;
      r.value = v.apiConfig.catboxUserHash || "";
      s.style.display = q.checked ? "block" : "none";
    }
    const w = document.getElementById("github-enable-switch");
    const x = document.getElementById("github-settings-details");
    const y = localStorage.getItem("github-enabled");
    if (y !== null) {
      v.apiConfig.githubEnable = y === "true";
    }
    if (w) {
      w.checked = v.apiConfig.githubEnable || false;
      x.style.display = w.checked ? "block" : "none";
      const a = document.getElementById("github-auto-backup-switch");
      const b = document.getElementById("github-backup-interval");
      if (a) {
        const c = localStorage.getItem("github-auto-backup");
        a.checked = c !== null ? c === "true" : false;
        const d = localStorage.getItem("github-backup-interval");
        if (b) {
          b.value = d ? parseInt(d) : 30;
        }
      }
      document.getElementById("github-username").value = v.apiConfig.githubUsername || "";
      document.getElementById("github-repo").value = v.apiConfig.githubRepo || "";
      document.getElementById("github-token").value = v.apiConfig.githubToken || "";
      document.getElementById("github-filename").value = v.apiConfig.githubFilename || "ephone_backup.json";
      const c = document.getElementById("github-proxy-switch");
      const d = document.getElementById("github-proxy-input-group");
      const e = document.getElementById("github-proxy-url");
      const f = localStorage.getItem("github-proxy-enabled");
      const g = localStorage.getItem("github-proxy-url");
      v.apiConfig.githubProxyEnable = f === "true";
      v.apiConfig.githubProxyUrl = g || "";
      if (c) {
        c.checked = v.apiConfig.githubProxyEnable;
        d.style.display = c.checked ? "block" : "none";
        e.value = v.apiConfig.githubProxyUrl || "";
        c.addEventListener("change", a => {
          d.style.display = a.target.checked ? "block" : "none";
        });
      }
    }
    Lc(a);
    Km();
  }
  window.renderApiSettingsProxy = Pc;
  async function Qc() {
    const a = document.getElementById("npc-list");
    a.innerHTML = "";
    const b = await Gb.npcs.toArray();
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•NPCï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’â€œ+â€æ·»åŠ ç¬¬ä¸€ä¸ªå§ï¼</p>";
      return;
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "chat-list-item";
      c.dataset.npcId = b.id;
      c.innerHTML = "\n            <img src=\"" + (b.avatar || Pa) + `" class="avatar" style="border-radius: 50%;">
            <div class="info">
                <div class="name-line">
                    <span class="name">` + b.name + `</span>
                </div>
                <div class="last-msg">` + b.persona.substring(0, 30) + `...</div>
            </div>
        `;
      c.addEventListener("click", () => Rc(b.id));
      _d(c, async () => {
        await Xc(b.id);
      });
      a.appendChild(c);
    });
  }
  async function Rc(a = null) {
    w = a;
    const b = document.getElementById("npc-editor-modal");
    const c = document.getElementById("npc-editor-title");
    const d = document.getElementById("npc-name-input");
    const e = document.getElementById("npc-persona-input");
    const f = document.getElementById("npc-avatar-preview");
    const g = document.getElementById("npc-association-list");
    const h = document.getElementById("npc-group-select");
    const i = document.getElementById("npc-background-activity-switch");
    const j = document.getElementById("npc-action-cooldown-input");
    g.innerHTML = "";
    h.innerHTML = "<option value=\"\">-- æœªåˆ†ç»„ --</option>";
    const k = await Gb.npcGroups.toArray();
    k.forEach(a => {
      const b = document.createElement("option");
      b.value = a.id;
      b.textContent = a.name;
      h.appendChild(b);
    });
    g.innerHTML += "<label><input type=\"checkbox\" value=\"user\"> " + (v.qzoneSettings.nickname || "æˆ‘") + " (ç”¨æˆ·)</label>";
    Object.values(v.chats).filter(a => !a.isGroup).forEach(a => {
      g.innerHTML += "<label><input type=\"checkbox\" value=\"" + a.id + "\"> " + a.name + " (è§’è‰²)</label>";
    });
    if (a) {
      c.textContent = "ç¼–è¾‘ NPC";
      const b = await Gb.npcs.get(a);
      if (b) {
        d.value = b.name;
        e.value = b.persona;
        f.src = b.avatar || Pa;
        i.checked = b.enableBackgroundActivity !== false;
        j.value = b.actionCooldownMinutes || 15;
        h.value = b.npcGroupId || "";
        if (b.associatedWith && Array.isArray(b.associatedWith)) {
          b.associatedWith.forEach(a => {
            const b = g.querySelector("input[value=\"" + a + "\"]");
            if (b) {
              b.checked = true;
            }
          });
        }
      }
    } else {
      c.textContent = "æ·»åŠ  NPC";
      d.value = "";
      e.value = "";
      f.src = Pa;
      i.checked = true;
      j.value = 15;
      h.value = "";
      const a = g.querySelector("input[value=\"user\"]");
      if (a) {
        a.checked = true;
      }
    }
    b.classList.add("visible");
  }
  async function Sc() {
    const a = document.getElementById("npc-name-input").value.trim();
    const b = document.getElementById("npc-persona-input").value.trim();
    if (!a || !b) {
      alert("NPCçš„æ˜µç§°å’Œäººè®¾éƒ½ä¸èƒ½ä¸ºç©ºï¼");
      return;
    }
    const c = Array.from(document.querySelectorAll("#npc-association-list input:checked")).map(a => a.value);
    const d = document.getElementById("npc-background-activity-switch").checked;
    const e = parseInt(document.getElementById("npc-action-cooldown-input").value) || 15;
    const f = parseInt(document.getElementById("npc-group-select").value) || null;
    const g = {
      name: a,
      persona: b,
      avatar: document.getElementById("npc-avatar-preview").src,
      associatedWith: c,
      enableBackgroundActivity: d,
      actionCooldownMinutes: e,
      npcGroupId: f
    };
    if (w) {
      await Gb.npcs.update(w, g);
    } else {
      const c = await Gb.npcs.add(g);
      if (ea && v.activeChatId) {
        const d = v.chats[v.activeChatId];
        if (d.isGroup) {
          d.members.push({
            id: "npc_" + c,
            originalName: a,
            groupNickname: a,
            persona: b,
            avatar: g.avatar,
            isNpc: true
          });
          await Gb.chats.put(d);
        }
      }
    }
    document.getElementById("npc-editor-modal").classList.remove("visible");
    if (ea) {
      ea = false;
      Cf();
    } else {
      await Qc();
    }
  }
  async function Tc() {
    await Uc();
    document.getElementById("npc-group-manager-modal").classList.add("visible");
  }
  async function Uc() {
    const a = document.getElementById("existing-npc-groups-list");
    const b = await Gb.npcGroups.toArray();
    a.innerHTML = "";
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align: center; color: var(--text-secondary);\">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç»„</p>";
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "existing-group-item";
      c.innerHTML = "\n            <span class=\"group-name\">" + b.name + "</span>\n            <span class=\"delete-group-btn\" data-id=\"" + b.id + "\">Ã—</span>\n        ";
      a.appendChild(c);
    });
  }
  async function Vc() {
    const a = document.getElementById("new-npc-group-name-input");
    const b = a.value.trim();
    if (!b) {
      alert("åˆ†ç»„åä¸èƒ½ä¸ºç©ºï¼");
      return;
    }
    const c = await Gb.npcGroups.where("name").equals(b).first();
    if (c) {
      alert("åˆ†ç»„ \"" + b + "\" å·²ç»å­˜åœ¨äº†ï¼");
      return;
    }
    await Gb.npcGroups.add({
      name: b
    });
    a.value = "";
    await Uc();
  }
  async function Wc(a) {
    const b = await wb("ç¡®è®¤åˆ é™¤", "åˆ é™¤åˆ†ç»„åŽï¼Œè¯¥ç»„å†…çš„æ‰€æœ‰NPCå°†å˜ä¸ºâ€œæœªåˆ†ç»„â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (b) {
      await Gb.npcGroups.delete(a);
      await Gb.npcs.where("npcGroupId").equals(a).modify({
        npcGroupId: null
      });
      await Uc();
    }
  }
  async function Xc(a) {
    const b = await Gb.npcs.get(a);
    if (!b) {
      return;
    }
    const c = await wb("åˆ é™¤NPC", "ç¡®å®šè¦åˆ é™¤NPC â€œ" + b.name + "â€ å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (c) {
      await Gb.npcs.delete(a);
      await Qc();
    }
  }
  let Yc = 0;
  function Zc(a) {
    const b = document.createElement("div");
    b.className = "chat-group-container";
    b.innerHTML = `
        <div class="chat-group-header">
            <span class="arrow">â–¼</span>
            <span class="group-name">` + a.name + `</span>
        </div>
        <div class="chat-group-content"></div>
    `;
    return b;
  }
  function $c(a) {
    const b = document.getElementById("chat-list");
    const c = document.getElementById("load-more-chats-btn");
    if (c) {
      c.remove();
    }
    const d = Yc;
    const e = Yc + CHAT_LIST_RENDER_WINDOW;
    const f = a.slice(d, e);
    const g = document.createDocumentFragment();
    let h = b.querySelector(".chat-group-content:last-of-type");
    f.forEach(a => {
      if (a.type === "groupHeader") {
        const b = Zc(a.group);
        g.appendChild(b);
        h = b.querySelector(".chat-group-content");
      } else if (a.type === "chatItem") {
        const b = bd(a.chat);
        if (h && a.chat.groupId) {
          h.appendChild(b);
        } else {
          g.appendChild(b);
          h = null;
        }
      }
    });
    b.appendChild(g);
    Yc += f.length;
    if (a.length > Yc) {
      ad(b, a);
    }
    document.querySelectorAll(".chat-group-header").forEach(a => {
      const b = a.cloneNode(true);
      a.parentNode.replaceChild(b, a);
      b.addEventListener("click", () => {
        b.classList.toggle("collapsed");
        b.nextElementSibling.classList.toggle("collapsed");
      });
    });
  }
  async function _c() {
    const a = document.getElementById("chat-list");
    a.innerHTML = "";
    const b = Object.values(v.chats).sort((a, b) => {
      const c = (b.isPinned || false) - (a.isPinned || false);
      if (c !== 0) {
        return c;
      }
      return (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0);
    });
    const c = await Gb.qzoneGroups.toArray();
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: #8a8a8a; margin-top: 50px;\">ç‚¹å‡»å³ä¸Šè§’ \"+\" æˆ–ç¾¤ç»„å›¾æ ‡æ·»åŠ èŠå¤©</p>";
      return;
    }
    c.forEach(a => {
      const c = b.find(b => b.groupId === a.id);
      a.latestTimestamp = c ? c.history.slice(-1)[0]?.timestamp || 0 : 0;
    });
    c.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
    la = [];
    const d = new Set();
    b.forEach(a => {
      if (a.isPinned) {
        la.push({
          type: "chatItem",
          chat: a
        });
        d.add(a.id);
      }
    });
    c.forEach(a => {
      const c = b.filter(b => !b.isPinned && !b.isGroup && b.groupId === a.id);
      if (c.length > 0) {
        la.push({
          type: "groupHeader",
          group: a
        });
        c.forEach(a => {
          la.push({
            type: "chatItem",
            chat: a
          });
          d.add(a.id);
        });
      }
    });
    b.forEach(a => {
      if (!d.has(a.id)) {
        la.push({
          type: "chatItem",
          chat: a
        });
        d.add(a.id);
      }
    });
    Yc = 0;
    $c();
  }
  function Zc(a) {
    const b = document.createElement("div");
    b.className = "chat-group-container";
    b.innerHTML = `
                <div class="chat-group-header">
                    <span class="arrow">â–¼</span>
                    <span class="group-name">` + a.name + `</span>
                </div>
                <div class="chat-group-content"></div>
            `;
    return b;
  }
  function ad(a, b) {
    const c = document.createElement("button");
    c.id = "load-more-chats-btn";
    c.textContent = "åŠ è½½æ›´æ—©çš„ä¼šè¯";
    c.className = "load-more-btn";
    c.addEventListener("click", () => $c(b), {
      once: true
    });
    a.prepend(c);
  }
  function $c() {
    if (ha) {
      return;
    }
    const a = document.getElementById("chat-list");
    const b = document.getElementById("messages-view");
    if (!a || !b) {
      return;
    }
    if (Yc >= la.length) {
      return;
    }
    ha = true;
    const c = Yc === 0;
    const d = () => {
      un(a);
      const c = v.globalSettings.chatListRenderWindow || 30;
      const d = Yc;
      const e = Yc + c;
      const f = la.slice(d, e);
      const g = document.createDocumentFragment();
      let h = a.querySelector(".chat-group-content:last-of-type");
      f.forEach(a => {
        if (a.type === "groupHeader") {
          const b = Zc(a.group);
          g.appendChild(b);
          h = b.querySelector(".chat-group-content");
        } else if (a.type === "chatItem") {
          const b = bd(a.chat);
          if (a.chat.groupId && h) {
            h.appendChild(b);
          } else {
            g.appendChild(b);
            if (!a.chat.groupId) {
              h = null;
            }
          }
        }
      });
      a.appendChild(g);
      Yc += f.length;
      a.querySelectorAll(".chat-group-header:not([data-has-listener=\"true\"])").forEach(a => {
        a.dataset.hasListener = "true";
        a.addEventListener("click", () => {
          a.classList.toggle("collapsed");
          a.nextElementSibling.classList.toggle("collapsed");
        });
      });
      ha = false;
      if (b.scrollHeight <= b.clientHeight && Yc < la.length) {
        $c();
      }
    };
    if (c) {
      d();
    } else {
      tn(a, "bottom");
      // TOLOOK
      setTimeout(d, 500);
    }
  }
  function bd(a) {
    try {
      const b = a.history.filter(a => !a.isHidden).slice(-1)[0] || {};
      let c;
      if (!a.isGroup && a.relationship?.status === "pending_user_approval") {
        c = "<span style=\"color: #ff8c00;\">[å¥½å‹ç”³è¯·] " + (a.relationship.applicationReason || "è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹") + "</span>";
      } else if (!a.isGroup && a.relationship?.status === "blocked_by_ai") {
        c = "<span style=\"color: #dc3545;\">[ä½ å·²è¢«å¯¹æ–¹æ‹‰é»‘]</span>";
      } else if (a.isGroup) {
        if (b.type === "pat_message") {
          c = "[ç³»ç»Ÿæ¶ˆæ¯] " + b.content;
        } else if (b.type === "transfer") {
          c = "[è½¬è´¦]";
        } else if (b.type === "ai_image" || b.type === "user_photo") {
          c = "[ç…§ç‰‡]";
        } else if (b.type === "voice_message") {
          c = "[è¯­éŸ³]";
        } else if (typeof b.content === "string" && $a.test(b.content)) {
          c = b.meaning ? "[è¡¨æƒ…: " + b.meaning + "]" : "[è¡¨æƒ…]";
        } else if (Array.isArray(b.content)) {
          c = "[å›¾ç‰‡]";
        } else {
          c = String(b.content || "...").substring(0, 20);
        }
        if (b.senderName && b.type !== "pat_message") {
          const d = sb(a, b.senderName);
          c = d + ": " + c;
        }
      } else {
        const b = a.status?.text || "åœ¨çº¿";
        c = "[" + b + "]";
      }
      const d = document.createElement("div");
      d.className = "chat-list-item";
      d.dataset.chatId = a.id;
      if (a.isPinned) {
        d.classList.add("pinned");
      }
      const e = a.isGroup ? a.settings.groupAvatar : a.settings.aiAvatar;
      const f = a.isGroup ? "" : a.settings.aiAvatarFrame || "";
      let g;
      if (f) {
        g = "<div class=\"avatar-with-frame\"><img src=\"" + (e || Na) + "\" class=\"avatar-img\"><img src=\"" + f + "\" class=\"avatar-frame\"></div>";
      } else {
        g = "<img src=\"" + (e || Na) + "\" class=\"avatar\">";
      }
      const h = f ? "has-frame" : "";
      const i = "<div class=\"avatar-group " + h + "\">" + g + "</div>";
      d.innerHTML = "\n            " + i + `
            <div class="info">
                <div class="name-line">
                    <span class="name">` + a.name + "</span>\n                    " + (a.isGroup ? "<span class=\"group-tag\">ç¾¤èŠ</span>" : "") + `
                </div>
                <div class="last-msg" style="color: ` + (a.isGroup ? "var(--text-secondary)" : "#b5b5b5") + "; font-style: italic;\">" + c + `</div>
            </div>
            <div class="unread-count-wrapper">
                <span class="unread-count" style="display: none;">0</span>
            </div>
        `;
      const j = a.unreadCount || 0;
      const k = d.querySelector(".unread-count");
      if (j > 0) {
        k.textContent = j > 99 ? "99+" : j;
        k.style.display = "inline-flex";
      } else {
        k.style.display = "none";
      }
      const l = d.querySelector(".avatar-group");
      if (l) {
        l.style.cursor = "pointer";
        l.addEventListener("dblclick", b => {
          b.stopPropagation();
          const c = a.isGroup ? a.name : a.originalName;
          _f(a.id, c);
        });
      }
      const m = d.querySelector(".info");
      if (m) {
        m.addEventListener("click", () => Qd(a.id));
      }
      _d(d, async b => {
        const c = await Vg(a);
        switch (c) {
          case "pin":
            a.isPinned = !a.isPinned;
            await Gb.chats.put(a);
            _c();
            break;
          case "delete":
            const b = await wb("åˆ é™¤å¯¹è¯", "ç¡®å®šè¦åˆ é™¤ä¸Ž \"" + a.name + "\" çš„æ•´ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚", {
              confirmButtonClass: "btn-danger"
            });
            if (b) {
              if (R.isActive && R.activeChatId === a.id) {
                await ce(false);
              }
              delete v.chats[a.id];
              if (v.activeChatId === a.id) {
                v.activeChatId = null;
              }
              await Gb.chats.delete(a.id);
              _c();
            }
            break;
          default:
            break;
        }
      });
      return d;
    } catch (b) {
      console.error("æ¸²æŸ“èŠå¤©é¡¹ [" + (a.name || "æœªçŸ¥") + "] (ID: " + a.id + ") æ—¶å‡ºé”™:", b);
      return null;
    }
  }
  async function cd(a) {
    wm();
    Kf();
    const b = v.chats[a];
    if (!b) {
      return;
    }
    Zd();
    const c = document.getElementById("chat-messages");
    const d = document.getElementById("chat-input-area");
    const e = document.getElementById("chat-lock-overlay");
    const f = document.getElementById("chat-lock-content");
    c.dataset.theme = b.settings.theme || "default";
    const g = b.settings.fontSize || 13;
    c.style.setProperty("--chat-font-size", g + "px");
    $e(b.settings.customCss || "", "#chat-messages", "custom-bubble-style");
    document.getElementById("chat-header-title").textContent = b.name;
    const h = document.getElementById("chat-header-status");
    const i = h.querySelector(".status-text");
    if (b.isGroup) {
      h.style.display = "none";
      document.getElementById("chat-header-title-wrapper").style.justifyContent = "center";
    } else {
      h.style.display = "flex";
      document.getElementById("chat-header-title-wrapper").style.justifyContent = "flex-start";
      i.textContent = b.status?.text || "åœ¨çº¿";
      h.classList.toggle("busy", b.status?.isBusy || false);
    }
    const j = document.getElementById("chat-interface-screen");
    const k = b.settings.background;
    const l = v.globalSettings.globalChatBackground;
    const m = document.getElementById("phone-screen").classList.contains("dark-mode");
    const n = m ? "#000000" : "#f0f2f5";
    if (k) {
      j.style.backgroundImage = "url(\"" + k + "\")";
      j.style.backgroundColor = "transparent";
    } else if (l) {
      j.style.backgroundImage = "url(\"" + l + "\")";
      j.style.backgroundColor = "transparent";
    } else {
      j.style.backgroundImage = "none";
      j.style.backgroundColor = n;
    }
    if (b.isSpectatorGroup) {
      d.style.display = "none";
      e.style.display = "flex";
      f.innerHTML = `
                    <span class="lock-text">æ­£åœ¨å›´è§‚AIä»¬çš„ç¾¤èŠ...</span>
                    <div class="spectator-actions-container">
                        <button id="spectator-reroll-btn" class="lock-action-btn secondary" title="é‡æ–°ç”Ÿæˆä¸Šä¸€è½®å¯¹è¯">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                            </svg>
                        </button>
                        <button id="spectator-propel-btn" class="lock-action-btn">ðŸŽ¬ æŽ¨è¿›å‰§æƒ…</button>
                        <button id="spectator-edit-btn" class="lock-action-btn secondary" title="å¯¼æ¼”å‰ªè¾‘å®¤ï¼šç¼–è¾‘AIä¸Šä¸€è½®çš„å“åº”">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                                <line x1="16" y1="8" x2="2" y2="22"></line>
                                <line x1="17.5" y1="15" x2="9" y2="15"></line>
                            </svg>
                        </button>
                    </div>
                `;
      document.getElementById("spectator-propel-btn").onclick = Sd;
    } else {
      d.style.display = "flex";
      e.style.display = "none";
      f.innerHTML = "";
      if (!b.isGroup && b.relationship.status !== "friend") {
        e.style.display = "flex";
        d.style.visibility = "hidden";
        let a = "";
        switch (b.relationship.status) {
          case "blocked_by_user":
            const c = Ka !== null;
            const d = b.relationship.blockedTimestamp;
            const e = v.globalSettings.blockCooldownHours || 1;
            const f = e * 60 * 60 * 1000;
            const g = Date.now() - d;
            const h = g > f;
            const i = Math.max(0, Math.ceil((f - g) / 60000));
            a = "\n                                <span class=\"lock-text\">ä½ å·²å°†â€œ" + b.name + `â€æ‹‰é»‘ã€‚</span>
                                <button id="unblock-btn" class="lock-action-btn">è§£é™¤æ‹‰é»‘</button>
                                <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                                    <strong style="color: #333;">ã€å¼€å‘è€…è¯Šæ–­é¢æ¿ã€‘</strong><br>
                                    - åŽå°æ´»åŠ¨æ€»å¼€å…³: ` + (v.globalSettings.enableBackgroundActivity ? "<span style=\"color: green;\">å·²å¼€å¯</span>" : "<span style=\"color: red;\">å·²å…³é—­</span>") + "<br>\n                                    - ç³»ç»Ÿå¿ƒè·³è®¡æ—¶å™¨: " + (c ? "<span style=\"color: green;\">è¿è¡Œä¸­</span>" : "<span style=\"color: red;\">æœªè¿è¡Œ</span>") + "<br>\n                                    - å½“å‰è§’è‰²çŠ¶æ€: <strong>" + b.relationship.status + "</strong><br>\n                                    - éœ€è¦å†·é™(å°æ—¶): <strong>" + e + "</strong><br>\n                                    - å†·é™æœŸæ˜¯å¦ç»“æŸ: " + (h ? "<span style=\"color: green;\">æ˜¯</span>" : "<span style=\"color: orange;\">å¦ (è¿˜å‰©çº¦ " + i + " åˆ†é’Ÿ)</span>") + "<br>\n                                    - è§¦å‘æ¡ä»¶: " + (h && v.globalSettings.enableBackgroundActivity ? "<span style=\"color: green;\">å·²æ»¡è¶³ï¼Œç­‰å¾…ä¸‹æ¬¡ç³»ç»Ÿå¿ƒè·³</span>" : "<span style=\"color: red;\">æœªæ»¡è¶³</span>") + `
                                </div>
                                <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">å¼ºåˆ¶è§¦å‘ä¸€æ¬¡å¥½å‹ç”³è¯·æ£€æµ‹</button>
                            `;
            break;
          case "blocked_by_ai":
            a = `
                                <span class="lock-text">ä½ è¢«å¯¹æ–¹æ‹‰é»‘äº†ã€‚</span>
                                <button id="apply-friend-btn" class="lock-action-btn">é‡æ–°ç”³è¯·åŠ ä¸ºå¥½å‹</button>
                            `;
            break;
          case "pending_user_approval":
            a = "\n                                <span class=\"lock-text\">â€œ" + b.name + "â€è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹ï¼š<br><i>â€œ" + b.relationship.applicationReason + `â€</i></span>
                                <button id="accept-friend-btn" class="lock-action-btn">æŽ¥å—</button>
                                <button id="reject-friend-btn" class="lock-action-btn secondary">æ‹’ç»</button>
                            `;
            break;
          case "pending_ai_approval":
            a = "<span class=\"lock-text\">å¥½å‹ç”³è¯·å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹é€šè¿‡...</span>";
            break;
        }
        f.innerHTML = a;
      } else {
        e.style.display = "none";
        d.style.visibility = "visible";
      }
    }
    c.innerHTML = "";
    const o = b.history;
    _a = 0;
    const p = v.globalSettings.chatRenderWindow || 50;
    const q = o.slice(-p);
    const r = document.createDocumentFragment();
    let s = 0;
    for (const c of q) {
      if (!c.isHidden) {
        if (s > 0 && c.timestamp - s > 600000) {
          r.appendChild(yj(c.timestamp));
        }
        s = c.timestamp;
      }
      const a = await Nd(c, b, true);
      if (a) {
        r.appendChild(a);
      }
    }
    c.appendChild(r);
    _a = q.length;
    const t = document.createElement("div");
    t.id = "typing-indicator";
    t.style.display = "none";
    t.textContent = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
    c.appendChild(t);
    const u = c.querySelectorAll("img");
    const w = [];
    u.forEach(a => {
      if (!a.complete) {
        w.push(new Promise(b => {
          a.onload = b;
          a.onerror = b;
        }));
      }
    });
    Promise.all(w).then(() => {
      c.scrollTop = c.scrollHeight;
      console.log("æ‰€æœ‰åˆå§‹å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²æ»šåŠ¨åˆ°åº•éƒ¨ã€‚");
    }).catch(a => {
      console.error("ç­‰å¾…å›¾ç‰‡åŠ è½½æ—¶å‡ºé”™:", a);
      c.scrollTop = c.scrollHeight;
    });
    // TOLOOK
    setTimeout(() => c.scrollTop = c.scrollHeight, 0);
  }
  async function dd() {
    if (ia) {
      return;
    }
    ia = true;
    const a = document.getElementById("chat-messages");
    const b = v.chats[v.activeChatId];
    if (!b) {
      ia = false;
      return;
    }
    tn(a, "top");
    const c = a.scrollHeight;
    await new Promise(a => // TOLOOK
    setTimeout(a, 100));
    const d = b.history.length;
    const e = v.globalSettings.chatRenderWindow || 50;
    const f = d - _a - e;
    const g = d - _a;
    const h = b.history.slice(Math.max(0, f), g);
    if (h.length === 0) {
      un(a);
      ia = false;
      return;
    }
    _a += h.length;
    const i = [];
    for (const a of h) {
      const c = await Nd(a, b);
      i.push(c);
    }
    const j = document.createDocumentFragment();
    const k = a.querySelector(".message-wrapper[data-timestamp]");
    let l = k ? parseInt(k.dataset.timestamp) : 0;
    let m = 0;
    h.forEach((a, b) => {
      if (!a.isHidden) {
        if (m > 0 && a.timestamp - m > 600000) {
          j.appendChild(yj(a.timestamp));
        }
        m = a.timestamp;
      }
      const c = i[b];
      if (c) {
        j.appendChild(c);
      }
    });
    if (l > 0 && l - m > 600000) {
      j.appendChild(yj(l));
    }
    un(a);
    a.prepend(j);
    const n = a.scrollHeight;
    a.scrollTop = n - c;
    ia = false;
  }
  function ed(a = null) {
    jk();
    rk(a);
    const b = document.getElementById("wallpaper-preview");
    if (W) {
      b.style.backgroundImage = "url(\"" + W + "\")";
      b.textContent = "";
    } else {
      const a = v.globalSettings.wallpaper;
      if (a && a.trim() !== "") {
        b.style.backgroundImage = "url(\"" + a + "\")";
        b.textContent = "";
      } else {
        b.style.backgroundImage = "linear-gradient(135deg, #89f7fe, #66a6ff)";
        b.textContent = "ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ ";
      }
    }
    const c = document.getElementById("cphone-wallpaper-preview");
    const d = v.globalSettings.cphoneWallpaper;
    if (d) {
      c.style.backgroundImage = "url(\"" + d + "\")";
      c.textContent = "";
    } else {
      c.style.backgroundImage = "linear-gradient(135deg, #f6d365, #fda085)";
      c.textContent = "å½“å‰ä¸ºæ¸å˜è‰²";
    }
    const e = document.getElementById("global-bg-preview");
    const f = v.globalSettings.globalChatBackground;
    if (f) {
      e.style.backgroundImage = "url(" + f + ")";
      e.textContent = "";
      document.getElementById("remove-global-bg-btn").style.display = "inline-block";
    } else {
      e.style.backgroundImage = "none";
      e.textContent = "ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ ";
      document.getElementById("remove-global-bg-btn").style.display = "none";
    }
    $g();
    Yg();
    document.getElementById("global-css-input").value = v.globalSettings.globalCss || "";
    document.getElementById("notification-sound-url-input").value = v.globalSettings.notificationSoundUrl || "";
    document.getElementById("status-bar-toggle-switch").checked = v.globalSettings.showStatusBar || false;
    document.getElementById("phone-frame-toggle-switch").checked = v.globalSettings.showPhoneFrame || false;
    document.getElementById("minimal-chat-ui-switch").checked = v.globalSettings.enableMinimalChatUI || false;
    document.getElementById("dynamic-island-music-toggle-switch").checked = v.globalSettings.alwaysShowMusicIsland || false;
    document.getElementById("detach-status-bar-switch").checked = v.globalSettings.detachStatusBar || false;
    document.getElementById("lock-screen-toggle").checked = v.globalSettings.lockScreenEnabled || false;
    document.getElementById("lock-screen-password-input").value = v.globalSettings.lockScreenPassword || "";
    const g = document.getElementById("lock-wallpaper-preview");
    if (v.globalSettings.lockScreenWallpaper) {
      g.style.backgroundImage = "url(" + v.globalSettings.lockScreenWallpaper + ")";
      g.textContent = "";
    } else {
      g.style.backgroundImage = "linear-gradient(135deg, #1c1c1e, #3a3a3c)";
      g.textContent = "é»˜è®¤å£çº¸";
    }
    sm();
    tm();
  }
  window.renderWallpaperScreenProxy = ed;
  function fd() {
    const a = document.getElementById("home-screen");
    const b = v.globalSettings.wallpaper;
    if (b) {
      a.style.backgroundImage = "url(\"" + b + "\")";
    } else {
      a.style.backgroundImage = "linear-gradient(135deg, #89f7fe, #66a6ff)";
    }
  }
  function gd(a) {
    document.querySelectorAll(".world-book-tab").forEach(b => {
      b.classList.toggle("active", b.dataset.categoryId === a);
    });
    document.querySelectorAll(".world-book-category-pane").forEach(b => {
      b.classList.toggle("active", b.dataset.categoryId === a);
    });
  }
  async function hd() {
    const a = document.getElementById("world-book-tabs");
    const b = document.getElementById("world-book-content-container");
    a.innerHTML = "";
    b.innerHTML = "";
    const [c, d] = await Promise.all([Gb.worldBooks.toArray(), Gb.worldBookCategories.orderBy("name").toArray()]);
    v.worldBooks = c;
    if (c.length === 0) {
      b.innerHTML = "<p style=\"text-align:center; color: #8a8a8a; margin-top: 50px;\">ç‚¹å‡»å³ä¸Šè§’ \"+\" åˆ›å»ºä½ çš„ç¬¬ä¸€æœ¬ä¸–ç•Œä¹¦</p>";
      return;
    }
    const e = document.createElement("button");
    e.className = "world-book-tab active";
    e.textContent = "å…¨éƒ¨";
    e.dataset.categoryId = "all";
    a.appendChild(e);
    const f = document.createElement("div");
    f.className = "world-book-category-pane active";
    f.dataset.categoryId = "all";
    b.appendChild(f);
    d.forEach(c => {
      const d = document.createElement("button");
      d.className = "world-book-tab";
      d.textContent = c.name;
      d.dataset.categoryId = String(c.id);
      a.appendChild(d);
      const e = document.createElement("div");
      e.className = "world-book-category-pane";
      e.dataset.categoryId = String(c.id);
      b.appendChild(e);
    });
    const g = c.some(a => !a.categoryId);
    if (g) {
      const c = document.createElement("button");
      c.className = "world-book-tab";
      c.textContent = "æœªåˆ†ç±»";
      c.dataset.categoryId = "uncategorized";
      a.appendChild(c);
      const d = document.createElement("div");
      d.className = "world-book-category-pane";
      d.dataset.categoryId = "uncategorized";
      b.appendChild(d);
    }
    c.forEach(a => {
      let c = "æš‚æ— å†…å®¹...";
      if (Array.isArray(a.content) && a.content.length > 0) {
        const b = a.content[0];
        c = b.comment || b.content || "";
      } else if (typeof a.content === "string" && a.content.trim() !== "") {
        c = a.content;
      }
      const d = document.createElement("div");
      d.className = "world-book-card";
      d.innerHTML = "\n                    <div class=\"card-title\">" + a.name + "</div>\n                    <div class=\"card-content-preview\">" + c + "</div>\n                ";
      const e = () => jd(a.id);
      const g = async () => {
        const b = await wb("åˆ é™¤ä¸–ç•Œä¹¦", "ç¡®å®šè¦åˆ é™¤ã€Š" + a.name + "ã€‹å—ï¼Ÿ", {
          confirmButtonClass: "btn-danger"
        });
        if (b) {
          await Gb.worldBooks.delete(a.id);
          v.worldBooks = v.worldBooks.filter(b => b.id !== a.id);
          hd();
        }
      };
      d.addEventListener("click", e);
      _d(d, g);
      const h = d.cloneNode(true);
      h.addEventListener("click", e);
      _d(h, g);
      f.appendChild(h);
      const i = a.categoryId ? String(a.categoryId) : "uncategorized";
      const j = b.querySelector(".world-book-category-pane[data-category-id=\"" + i + "\"]");
      if (j) {
        j.appendChild(d);
      }
    });
    document.querySelectorAll(".world-book-tab").forEach(a => {
      a.addEventListener("click", () => gd(a.dataset.categoryId));
    });
  }
  function id(a, b) {
    const c = document.createElement("div");
    c.className = "world-book-group-container";
    c.innerHTML = `
                <div class="world-book-group-header">
                    <span class="arrow">â–¼</span>
                    <span class="group-name">` + a + `</span>
                </div>
                <div class="world-book-group-content"></div>
            `;
    const d = c.querySelector(".world-book-group-content");
    b.sort((a, b) => a.name.localeCompare(b.name, "zh-CN"));
    b.forEach(a => {
      let b = "æš‚æ— å†…å®¹...";
      if (Array.isArray(a.content) && a.content.length > 0) {
        const c = a.content[0];
        b = c.comment || c.content || "";
      } else if (typeof a.content === "string" && a.content.trim() !== "") {
        b = a.content;
      }
      const c = document.createElement("div");
      c.className = "list-item";
      c.dataset.bookId = a.id;
      c.innerHTML = "\n                    <div class=\"item-title\">" + a.name + "</div>\n                    <div class=\"item-content\">" + String(b).substring(0, 50) + "</div>\n                ";
      c.addEventListener("click", () => jd(a.id));
      _d(c, async () => {
        const b = await wb("åˆ é™¤ä¸–ç•Œä¹¦", "ç¡®å®šè¦åˆ é™¤ã€Š" + a.name + "ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚", {
          confirmButtonClass: "btn-danger"
        });
        if (b) {
          await Gb.worldBooks.delete(a.id);
          v.worldBooks = v.worldBooks.filter(b => b.id !== a.id);
          hd();
        }
      });
      d.appendChild(c);
    });
    return c;
  }
  window.renderWorldBookScreenProxy = hd;
  async function jd(a) {
    Kb("world-book-editor-screen");
    fa = a;
    const [b, c] = await Promise.all([Gb.worldBooks.get(a), Gb.worldBookCategories.toArray()]);
    if (!b) {
      console.error("å°è¯•æ‰“å¼€ä¸€ä¸ªä¸å­˜åœ¨çš„ä¸–ç•Œä¹¦ï¼ŒID:", a);
      Kb("world-book-screen");
      return;
    }
    document.getElementById("world-book-editor-title").textContent = b.name;
    document.getElementById("world-book-name-input").value = b.name;
    const d = document.getElementById("world-book-category-select");
    d.innerHTML = "<option value=\"\">-- æœªåˆ†ç±» --</option>";
    c.forEach(a => {
      const c = document.createElement("option");
      c.value = a.id;
      c.textContent = a.name;
      if (b.categoryId === a.id) {
        c.selected = true;
      }
      d.appendChild(c);
    });
    const e = document.getElementById("world-book-entries-container");
    e.innerHTML = "";
    if (Array.isArray(b.content) && b.content.length > 0) {
      b.content.forEach(a => {
        const b = Gi(a);
        e.appendChild(b);
      });
    } else {
      e.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); margin-top: 20px;\">è¿˜æ²¡æœ‰å†…å®¹ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡å§ï¼</p>";
    }
  }
  async function kd(a = true) {
    const b = document.getElementById("sticker-grid");
    const c = document.getElementById("sticker-category-tabs");
    const d = document.getElementById("sticker-search-input");
    const e = d.value.trim().toLowerCase();
    if (a) {
      c.innerHTML = "";
      const a = await Gb.stickerCategories.toArray();
      c.innerHTML += "<button class=\"sticker-category-tab " + (ba === "all" ? "active" : "") + "\" data-category-id=\"all\">å…¨éƒ¨</button>";
      a.forEach(a => {
        c.innerHTML += "<button class=\"sticker-category-tab " + (ba === a.id ? "active" : "") + "\" data-category-id=\"" + a.id + "\">" + a.name + "</button>";
      });
      c.innerHTML += "<button class=\"sticker-category-tab " + (ba === "uncategorized" ? "active" : "") + "\" data-category-id=\"uncategorized\">æœªåˆ†ç±»</button>";
    }
    b.innerHTML = "";
    let f;
    if (ba === "all") {
      f = v.userStickers;
    } else if (ba === "uncategorized") {
      f = v.userStickers.filter(a => !a.categoryId);
    } else {
      f = v.userStickers.filter(a => a.categoryId === ba);
    }
    const g = e ? f.filter(a => a.name.toLowerCase().includes(e)) : f;
    if (g.length === 0) {
      const a = e ? "æ‰¾ä¸åˆ°åŒ¹é…çš„è¡¨æƒ…" : "è¿™ä¸ªåˆ†ç±»ä¸‹è¿˜æ²¡æœ‰è¡¨æƒ…å“¦~";
      b.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); grid-column: 1 / -1; padding-top: 20px;\">" + a + "</p>";
      return;
    }
    g.forEach(a => {
      const c = document.createElement("div");
      c.className = "sticker-item";
      c.title = a.name;
      c.dataset.stickerId = a.id;
      c.innerHTML = "\n            <div class=\"sticker-image-container\" style=\"background-image: url(" + a.url + ")\"></div>\n            <span class=\"sticker-name\">" + a.name + "</span>\n        ";
      c.addEventListener("click", () => {
        if (ld) {
          Fd(c);
        } else {
          Ud(a);
        }
      });
      const d = document.createElement("div");
      d.className = "delete-btn";
      d.innerHTML = "&times;";
      d.onclick = async b => {
        b.stopPropagation();
        const c = await wb("åˆ é™¤è¡¨æƒ…", "ç¡®å®šè¦åˆ é™¤è¡¨æƒ… \"" + a.name + "\" å—ï¼Ÿ", {
          confirmButtonClass: "btn-danger"
        });
        if (c) {
          await Gb.userStickers.delete(a.id);
          v.userStickers = v.userStickers.filter(b => b.id !== a.id);
          kd();
        }
      };
      c.appendChild(d);
      b.appendChild(c);
    });
  }
  let ld = false;
  let md = new Set();
  let nd = false;
  let od = new Set();
  let pd = false;
  let qd = new Set();
  let rd = {
    local: [],
    cloud: []
  };
  let sd = {
    local: 0,
    cloud: 0
  };
  let td = {
    local: false,
    cloud: false
  };
  let ud = "local";
  const vd = 45;
  function wd() {
    nd = !nd;
    const a = document.getElementById("music-playlist-panel");
    const b = document.getElementById("manage-playlist-btn");
    const c = document.getElementById("playlist-action-bar");
    const d = document.getElementById("select-all-playlist-checkbox");
    a.classList.toggle("management-mode", nd);
    if (nd) {
      b.textContent = g[h].done;
      b.setAttribute("data-lang-key", "done");
      c.style.display = "flex";
      od.clear();
      d.checked = false;
      yd();
      a.querySelectorAll(".playlist-item-checkbox").forEach(a => a.style.display = "block");
    } else {
      b.textContent = g[h].manage;
      b.setAttribute("data-lang-key", "manage");
      c.style.display = "none";
      a.querySelectorAll(".playlist-item").forEach(a => {
        a.classList.remove("selected");
        const b = a.querySelector(".playlist-item-checkbox");
        if (b) {
          b.style.display = "none";
          b.checked = false;
        }
      });
    }
  }
  function xd(a) {
    if (!nd) {
      return;
    }
    const b = document.querySelector(".playlist-item[data-index=\"" + a + "\"]");
    if (!b) {
      return;
    }
    const c = b.querySelector(".playlist-item-checkbox");
    const d = od.has(a);
    b.classList.toggle("selected", !d);
    c.checked = !d;
    if (d) {
      od.delete(a);
    } else {
      od.add(a);
    }
    yd();
  }
  function yd() {
    const a = document.getElementById("upload-selected-to-catbox-btn");
    const b = od.size;
    if (a) {
      a.textContent = "ä¸Šä¼ Catbox (" + b + ")";
    }
  }
  function zd() {
    const a = document.getElementById("select-all-playlist-checkbox");
    const b = a.checked;
    document.querySelectorAll(".playlist-item").forEach(a => {
      const c = parseInt(a.dataset.index);
      if (isNaN(c)) {
        return;
      }
      a.classList.toggle("selected", b);
      a.querySelector(".playlist-item-checkbox").checked = b;
      if (b) {
        od.add(c);
      } else {
        od.delete(c);
      }
    });
    yd();
  }
  async function Ad() {
    if (!v.apiConfig.catboxEnable || !v.apiConfig.catboxUserHash) {
      await Bb("åŠŸèƒ½æœªå¼€å¯", "è¯·å…ˆåœ¨â€œAPIè®¾ç½®â€ -> â€œCatbox.moeâ€ä¸­å¼€å¯æ­¤åŠŸèƒ½å¹¶å¡«å†™æ‚¨çš„ User Hashã€‚");
      return;
    }
    if (od.size === 0) {
      await Bb("æœªé€‰æ‹©", "è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„æ­Œæ›²ã€‚");
      return;
    }
    const a = Array.from(od).filter(a => {
      const b = R.playlist[a];
      return b && b.src && !String(b.src).includes("catbox.moe");
    });
    if (a.length === 0) {
      await Bb("æ— éœ€ä¸Šä¼ ", "æ‚¨é€‰æ‹©çš„æ‰€æœ‰æ­Œæ›²å‡å·²åœ¨ Catbox ä¸Šã€‚");
      wd();
      return;
    }
    const b = await wb("ç¡®è®¤ä¸Šä¼ ï¼Ÿ", "å³å°†ä¸Šä¼  " + a.length + ` é¦–æ­Œæ›²åˆ° Catbox.moeã€‚

è¿™ä¼šè½¬æ¢æœ¬åœ°éŸ³ä¹å’Œå¤–éƒ¨é“¾æŽ¥ï¼Œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´å¹¶æ¶ˆè€—æµé‡ã€‚
ï¼ˆå·²åœ¨ Catbox ä¸Šçš„æ­Œæ›²å°†è¢«è‡ªåŠ¨è·³è¿‡ï¼‰`, {
      confirmText: "å¼€å§‹ä¸Šä¼ "
    });
    if (!b) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨å¼€å§‹ä¸Šä¼  " + a.length + " é¦–æ­Œæ›²ï¼Œè¯·å‹¿å…³é—­é¡µé¢...");
    let c = 0;
    let d = 0;
    const e = [];
    const f = Dc();
    let g = f.cors_proxy;
    if (g === "custom") {
      g = f.custom_proxy_url || "";
    }
    for (const b of a) {
      const a = R.playlist[b];
      try {
        let b;
        let d = a.name || "unknown_track.mp3";
        if (a.isLocal) {
          console.log("[Catbox æ‰¹é‡ä¸Šä¼ ] å¤„ç†æœ¬åœ°æ­Œæ›²: " + a.name);
          b = new Blob([a.src], {
            type: a.fileType || "audio/mpeg"
          });
        } else {
          console.log("[Catbox æ‰¹é‡ä¸Šä¼ ] å¤„ç†ç½‘ç»œæ­Œæ›²: " + a.name + " from " + a.src);
          let c = a.src;
          if (g && g !== "" && !c.startsWith("data:")) {
            c = g + encodeURIComponent(a.src);
            console.log("[Catbox æ‰¹é‡ä¸Šä¼ ] ä½¿ç”¨ä»£ç†ä¸‹è½½: " + c);
          } else {
            console.log("[Catbox æ‰¹é‡ä¸Šä¼ ] ä¸ä½¿ç”¨ä»£ç†ï¼Œå°è¯•ç›´è¿žä¸‹è½½... (è¿™åœ¨Safariä¸Šä¼šå¤±è´¥)");
          }
          const d = await fetch(c);
          if (!d.ok) {
            throw new Error("ä¸‹è½½æ­Œæ›²å¤±è´¥ï¼ŒçŠ¶æ€: " + d.status);
          }
          b = await d.blob();
        }
        if (!d.match(/\.(mp3|wav|flac|m4a|ogg)$/i)) {
          d += ".mp3";
        }
        const e = await J(new File([b], d, {
          type: b.type
        }));
        a.src = e;
        a.isLocal = false;
        delete a.fileType;
        c++;
      } catch (b) {
        console.error("[Catbox æ‰¹é‡ä¸Šä¼ ] ä¸Šä¼ å¤±è´¥: " + a.name, b);
        d++;
        e.push(a.name);
      }
    }
    await nc();
    let h = `ä¸Šä¼ å®Œæˆï¼

æˆåŠŸ: ` + c + " é¦–";
    if (d > 0) {
      h += "\nå¤±è´¥: " + d + " é¦–\n(" + e.join(", ") + ")";
    }
    await Bb("æ“ä½œå®Œæˆ", h);
    wd();
    he();
  }
  function Bd() {
    ld = !ld;
    const a = document.getElementById("sticker-grid");
    const b = document.getElementById("manage-stickers-btn");
    const c = document.getElementById("sticker-action-bar");
    const d = document.getElementById("select-all-stickers-checkbox");
    a.classList.toggle("management-mode", ld);
    if (ld) {
      b.textContent = "å®Œæˆ";
      c.style.display = "flex";
      md.clear();
      d.checked = false;
      Dd();
    } else {
      b.textContent = "ç®¡ç†";
      c.style.display = "none";
      a.querySelectorAll(".sticker-item.selected").forEach(a => a.classList.remove("selected"));
    }
  }
  function Cd() {
    const a = document.getElementById("select-all-stickers-checkbox");
    const b = a.checked;
    let c;
    if (ba === "all") {
      c = v.userStickers;
    } else if (ba === "uncategorized") {
      c = v.userStickers.filter(a => !a.categoryId);
    } else {
      c = v.userStickers.filter(a => a.categoryId === ba);
    }
    c.forEach(a => {
      const c = a.id;
      const d = document.querySelector(".sticker-item[data-sticker-id=\"" + c + "\"]");
      if (b) {
        md.add(c);
        if (d) {
          d.classList.add("selected");
        }
      } else {
        md.delete(c);
        if (d) {
          d.classList.remove("selected");
        }
      }
    });
    Dd();
  }
  function Dd() {
    const a = md.size;
    const b = document.getElementById("delete-selected-stickers-btn");
    const c = document.getElementById("export-selected-stickers-btn");
    const d = document.getElementById("move-selected-stickers-btn");
    if (b) {
      b.textContent = "åˆ é™¤ (" + a + ")";
    }
    if (c) {
      c.textContent = "å¯¼å‡º (" + a + ")";
    }
    if (d) {
      d.textContent = "ç§»åŠ¨ (" + a + ")";
    }
  }
  async function Ed() {
    if (md.size === 0) {
      alert("è¯·å…ˆé€‰æ‹©è¦ç§»åŠ¨çš„è¡¨æƒ…ã€‚");
      return;
    }
    const a = await Gb.stickerCategories.toArray();
    const b = [{
      text: "æœªåˆ†ç±»",
      value: "uncategorized"
    }, ...a.map(a => ({
      text: a.name,
      value: a.id
    }))];
    const c = await Eb("ç§»åŠ¨åˆ°åˆ†ç±»", b);
    if (!c) {
      return;
    }
    const d = c === "uncategorized" ? null : parseInt(c);
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨ç§»åŠ¨è¡¨æƒ…...");
    const e = Array.from(md);
    await Gb.transaction("rw", Gb.userStickers, async () => {
      for (const a of e) {
        await Gb.userStickers.update(a, {
          categoryId: d
        });
        const b = v.userStickers.find(b => b.id === a);
        if (b) {
          b.categoryId = d;
        }
      }
    });
    Bd();
    await kd();
    await Bb("æˆåŠŸ", "å·²å°† " + e.length + " ä¸ªè¡¨æƒ…ç§»åŠ¨åˆ°æ–°åˆ†ç±»ã€‚");
  }
  function Fd(a) {
    if (!ld) {
      return;
    }
    const b = a.dataset.stickerId;
    if (!b) {
      return;
    }
    a.classList.toggle("selected");
    if (md.has(b)) {
      md.delete(b);
    } else {
      md.add(b);
    }
    Dd();
  }
  async function Gd() {
    if (md.size === 0) {
      return;
    }
    const a = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ " + md.size + " ä¸ªè¡¨æƒ…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", {
      confirmButtonClass: "btn-danger"
    });
    if (a) {
      const a = [...md];
      await Gb.userStickers.bulkDelete(a);
      v.userStickers = v.userStickers.filter(b => !a.includes(b.id));
      Bd();
      kd();
      await Bb("åˆ é™¤æˆåŠŸ", "é€‰ä¸­çš„è¡¨æƒ…å·²æˆåŠŸåˆ é™¤ã€‚");
    }
  }
  async function Hd() {
    if (md.size === 0) {
      alert("è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„è¡¨æƒ…åŒ…ã€‚");
      return;
    }
    let a = "";
    let b = 0;
    v.userStickers.forEach(c => {
      if (md.has(c.id)) {
        a += c.name + ": " + c.url + "\n";
        b++;
      }
    });
    if (b === 0) {
      alert("æœªæ‰¾åˆ°æ‰€é€‰è¡¨æƒ…çš„æ•°æ®ã€‚");
      return;
    }
    const c = a.trim();
    const d = "batch-export-textarea-" + Date.now();
    const e = `
        <p style="text-align:left; font-size: 14px; margin: 0 0 10px 0;">
            å·²ä¸ºæ‚¨ç”Ÿæˆ ` + b + ` æ¡å¿«æ·å¯¼å…¥æ ¼å¼çš„æ–‡æœ¬ï¼š
        </p>
        <textarea id="` + d + `" 
                  rows="10" 
                  style="width: 100%; font-size: 12px; resize: vertical; border-radius: 6px; border: 1px solid #ccc;"
                  readonly>` + c + "</textarea>\n    ";
    Bb("å¤åˆ¶è¡¨æƒ…åŒ…æ•°æ®", e);
    const f = document.getElementById("custom-modal-confirm");
    if (f) {
      f.textContent = "ä¸€é”®å¤åˆ¶";
      const a = f.onclick;
      f.onclick = async b => {
        try {
          await navigator.clipboard.writeText(c);
          f.textContent = "å¤åˆ¶æˆåŠŸ!";
          // TOLOOK
          setTimeout(() => {
            f.textContent = "å®Œæˆ";
            f.onclick = a;
          }, 1500);
        } catch (b) {
          alert("è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰æ–‡æœ¬æ¡†æ‰‹åŠ¨å¤åˆ¶ã€‚");
          f.textContent = "å®Œæˆ";
          f.onclick = a;
        }
      };
    }
  }
  async function Id() {
    const a = await Eb("æ‰¹é‡å¯¼å…¥è¡¨æƒ…", [{
      text: "ðŸ“‹ ç²˜è´´æ–‡æœ¬",
      value: "paste"
    }, {
      text: "ðŸ“ ä¸Šä¼ æ–‡ä»¶ (.txt/.json/.docx)",
      value: "file"
    }]);
    if (a === "paste") {
      const a = `è¯·è¾“å…¥è¡¨æƒ…æ•°æ®ï¼Œä¸€è¡Œä¸€ä¸ªã€‚
ã€è§„åˆ™ã€‘ï¼šåŒ…å«ã€åå­—ã€‘å’Œã€é“¾æŽ¥ã€‘ã€‚
ã€ç¤ºä¾‹ã€‘ï¼š
å¼€å¿ƒ: https://xx.com/1.jpg
å“­æ³£ï¼šhttps://xx.com/2.png
ç”Ÿæ°”https://xx.com/3.gif
https://xx.com/4.jpg ç–‘æƒ‘`;
      const b = await Db("æ‰¹é‡å¯¼å…¥è¡¨æƒ…", a, "", "textarea");
      if (b && b.trim()) {
        await Jd(b);
      }
    } else if (a === "file") {
      await Kd();
    }
  }
  async function Jd(a) {
    const b = a.trim().split("\n");
    const c = [];
    const d = "https://files.catbox.moe/";
    let e = 0;
    let f = 0;
    const g = ba !== "all" && ba !== "uncategorized" ? ba : null;
    const h = /(https?:\/\/[^\s]+|data:image\/[^\s]+)/;
    for (const i of b) {
      const a = i.trim();
      if (!a || a.includes("å¡«å…¥") || a.includes("æ ¼å¼")) {
        continue;
      }
      const b = a.match(h);
      if (!b) {
        const b = a.match(/^(.+?)\s+([a-zA-Z0-9]+\.[a-zA-Z0-9]+)$/);
        if (b) {
          c.push({
            id: "sticker_" + Date.now() + Math.random(),
            name: b[1].trim(),
            url: d + b[2].trim(),
            categoryId: g
          });
        } else {
          e++;
          console.warn("æ— æ³•è¯†åˆ«è¡Œ:", a);
        }
        continue;
      }
      const j = b[0];
      let k = a.replace(j, "").trim();
      let l = k.replace(/^[\s:ï¼š,ï¼Œ]+|[\s:ï¼š,ï¼Œ]+$/g, "");
      if (!l) {
        f++;
        console.warn("è·³è¿‡çº¯é“¾æŽ¥ (æœªæä¾›åå­—):", a);
        continue;
      }
      c.push({
        id: "sticker_" + Date.now() + Math.random(),
        name: l,
        url: j,
        categoryId: g
      });
    }
    let i = "";
    if (c.length > 0) {
      await Gb.userStickers.bulkAdd(c);
      v.userStickers.push(...c);
      kd();
      i = "æˆåŠŸå¯¼å…¥ " + c.length + " ä¸ªæ–°è¡¨æƒ…ï¼";
    }
    if (f > 0) {
      i += "\nâš ï¸ æœ‰ " + f + " è¡Œå› åªæœ‰é“¾æŽ¥(æ— åå­—)è¢«è·³è¿‡ã€‚";
    }
    if (e > 0) {
      i += "\nâŒ æœ‰ " + e + " è¡Œæ ¼å¼æ— æ³•è¯†åˆ«ã€‚";
    }
    if (i) {
      await Bb("å¯¼å…¥ç»“æžœ", i);
    } else if (b.length > 0) {
      await Bb("å¯¼å…¥å¤±è´¥", "æœªèƒ½è¯†åˆ«ä»»ä½•æœ‰æ•ˆæ•°æ®ï¼Œè¯·ç¡®ä¿æ¯è¡Œéƒ½åŒ…å«ã€åå­—ã€‘å’Œã€é“¾æŽ¥ã€‘ã€‚");
    }
  }
  function Kd() {
    return new Promise(a => {
      const b = document.createElement("input");
      b.type = "file";
      b.accept = ".txt,.json,.docx";
      b.onchange = async b => {
        const c = b.target.files[0];
        if (!c) {
          a();
          return;
        }
        try {
          await Bb("æ­£åœ¨è§£æž...", "æ­£åœ¨è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè¯·ç¨å€™...");
          const a = await Ld(c);
          if (a && a.trim()) {
            await Jd(a);
          } else {
            alert("æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–æ— æ³•è§£æžã€‚");
          }
        } catch (a) {
          console.error("æ–‡ä»¶è§£æžå¤±è´¥:", a);
          alert("æ–‡ä»¶è§£æžå¤±è´¥: " + a.message);
        }
        a();
      };
      b.click();
    });
  }
  async function Ld(a) {
    const b = a.name.toLowerCase();
    if (b.endsWith(".txt")) {
      return await a.text();
    }
    if (b.endsWith(".docx")) {
      if (typeof mammoth === "undefined") {
        throw new Error("æœªåŠ è½½ mammoth.js åº“ï¼Œæ— æ³•è¯»å– Word æ–‡æ¡£ã€‚");
      }
      const b = await a.arrayBuffer();
      const c = await mammoth.extractRawText({
        arrayBuffer: b
      });
      return c.value;
    }
    if (b.endsWith(".json")) {
      const b = await a.text();
      let c;
      try {
        c = JSON.parse(b);
      } catch (a) {
        throw new Error("JSON æ ¼å¼é”™è¯¯");
      }
      let d = "";
      if (Array.isArray(c)) {
        c.forEach(a => {
          const b = a.name || a.key || a.title || a.meaning;
          const c = a.url || a.src || a.content || a.link;
          if (b && c) {
            d += b + ": " + c + "\n";
          }
        });
      } else if (typeof c === "object") {
        if (c.entries) {
          const a = Array.isArray(c.entries) ? c.entries : Object.values(c.entries);
          a.forEach(a => {
            const b = a.comment || a.key?.toString() || "è¡¨æƒ…";
            const c = a.content || a.url;
            if (c && c.startsWith("http")) {
              d += b + ": " + c + "\n";
            }
          });
        } else {
          for (let a in c) {
            const b = c[a];
            if (typeof b === "string" && (b.startsWith("http") || b.startsWith("data:image"))) {
              d += a + ": " + b + "\n";
            }
          }
        }
      }
      return d;
    }
    throw new Error("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼");
  }
  function Md(a) {
    const b = ".message-bubble[data-timestamp=\"" + a + "\"]";
    const c = document.querySelector(b);
    if (c) {
      c.scrollIntoView({
        behavior: "smooth",
        block: "center"
      });
      c.classList.add("highlighted");
      // TOLOOK
      setTimeout(() => {
        if (document.body.contains(c)) {
          c.classList.remove("highlighted");
        }
      }, 1500);
    } else {
      alert("æ‰¾ä¸åˆ°åŽŸå§‹æ¶ˆæ¯ã€‚å¯èƒ½å·²è¢«åˆ é™¤æˆ–ä½äºŽæ›´æ—©çš„åŽ†å²è®°å½•ä¸­ã€‚");
    }
  }
  async function Nd(a, c) {
    if (a.type === "recalled_message") {
      const b = document.createElement("div");
      b.className = "message-wrapper system-pat";
      b.dataset.timestamp = a.timestamp;
      const c = document.createElement("div");
      c.className = "message-bubble recalled-message-placeholder";
      c.dataset.timestamp = a.timestamp;
      c.textContent = a.content;
      b.appendChild(c);
      _d(b, () => ef(a.timestamp));
      b.addEventListener("click", () => {
        if (Z) {
          $d(a.timestamp);
        }
      });
      return b;
    } else if (a.type === "post_deleted_notice") {
      const b = document.createElement("div");
      b.className = "message-wrapper system-pat";
      b.dataset.timestamp = a.timestamp;
      const c = document.createElement("div");
      c.className = "message-bubble post-deleted-placeholder";
      c.dataset.postId = a.postId;
      c.textContent = a.content;
      b.appendChild(c);
      _d(b, () => ef(a.timestamp));
      b.addEventListener("click", () => {
        if (Z) {
          $d(a.timestamp);
        }
      });
      return b;
    }
    if (a.isHidden && !c.settings.showHiddenMessages) {
      return null;
    }
    if (a.type === "narration") {
      const b = document.createElement("div");
      b.className = "message-wrapper system-pat";
      b.dataset.timestamp = a.timestamp;
      const c = document.createElement("div");
      c.className = "message-bubble system-bubble";
      c.innerHTML = "<span style=\"font-style:italic; opacity: 0.9;\">" + a.content + "</span>";
      c.dataset.timestamp = a.timestamp;
      b.appendChild(c);
      _d(b, () => ef(a.timestamp));
      b.addEventListener("click", () => {
        if (Z) {
          $d(a.timestamp);
        }
      });
      return b;
    }
    if (a.type === "pat_message") {
      const b = document.createElement("div");
      b.className = "message-wrapper system-pat";
      const c = document.createElement("div");
      c.className = "message-bubble system-bubble";
      c.dataset.timestamp = a.timestamp;
      c.textContent = a.content;
      b.appendChild(c);
      _d(b, () => ef(a.timestamp));
      b.addEventListener("click", () => {
        if (Z) {
          $d(a.timestamp);
        }
      });
      return b;
    }
    const d = a.role === "user";
    const e = c.settings.myNickname || "æˆ‘";
    const f = document.createElement("div");
    f.className = "message-wrapper " + (d ? "user" : "ai");
    if (a.isHidden) {
      f.classList.add("hidden-revealed");
    }
    if (c.isGroup && !d) {
      const b = c.members.find(b => b.originalName === a.senderName);
      const d = document.createElement("div");
      d.className = "sender-name";
      d.textContent = b ? b.groupNickname : a.senderName || "æœªçŸ¥æˆå‘˜";
      f.appendChild(d);
    }
    const g = document.createElement("div");
    g.className = "message-bubble " + (d ? "user" : "ai");
    g.dataset.timestamp = a.timestamp;
    const h = document.createElement("span");
    h.className = "timestamp";
    h.textContent = oc(a.timestamp);
    let i;
    let j = "";
    if (d) {
      i = c.settings.myAvatar || (c.isGroup ? Oa : Na);
      j = c.settings.myAvatarFrame || "";
    } else if (c.isGroup) {
      const b = c.members.find(b => b.originalName === a.senderName);
      if (b) {
        const a = v.chats[b.id];
        i = b.avatar || (a ? a.settings.aiAvatar : Pa);
        j = b.avatarFrame || (a ? a.settings.aiAvatarFrame : "");
      } else {
        i = Pa;
        j = "";
      }
    } else {
      i = c.settings.aiAvatar || Na;
      j = c.settings.aiAvatarFrame || "";
    }
    let k;
    if (j) {
      k = "<div class=\"avatar-with-frame\"><img src=\"" + i + "\" class=\"avatar-img\"><img src=\"" + j + "\" class=\"avatar-frame\"></div>";
    } else {
      k = "<img src=\"" + i + "\" class=\"avatar\">";
    }
    const l = j ? "has-frame" : "";
    const m = "<div class=\"avatar-group " + l + "\">" + k + "</div>";
    let n;
    let o = "";
    if (a.quote) {
      const b = sb(c, a.quote.senderName);
      const d = String(a.quote.content || "");
      o = "\n                    <div class=\"quoted-message\" data-original-timestamp=\"" + a.quote.timestamp + "\" style=\"cursor: pointer;\">\n                        <div class=\"quoted-sender\">å›žå¤ " + b + ":</div>\n                        <div class=\"quoted-content\">" + d + `</div>
                    </div>
                `;
    }
    let p = a.content;
    if (typeof p === "string" && p.trim().startsWith("<") && p.trim().endsWith(">")) {
      n = p;
      g.classList.add("is-raw-html");
    } else if (a.type === "offline_text" || a.type === "share_link" || a.type === "share_card" || a.type === "location_share" || a.type === "ai_image" || a.type === "user_photo" || a.type === "voice_message" || a.type === "transfer" || a.type === "waimai_request" || a.type === "waimai_order" || a.type === "red_packet" || a.type === "poll" || a.type === "gift" || a.type === "realimag" || a.type === "naiimag" || a.type === "kinship_request" || a.type === "forwarded_email" || a.type === "reddit_share") {
      if (a.type === "offline_text") {
        const b = a.content || ((a.dialogue || "") + " " + (a.description || "")).trim();
        const c = /(ã€Œ.*?ã€|â€œ.*?â€)/g;
        const d = b.split(c).filter(a => a);
        n = d.map(a => {
          if (a.startsWith("ã€Œ") || a.startsWith("â€œ")) {
            return "<span class=\"offline-dialogue\">" + si(a) + "</span>";
          } else {
            return "<span class=\"offline-description\">" + si(a.trim()).replace(/\n/g, "<br>") + "</span>";
          }
        }).join("");
      } else if (a.type === "share_link") {
        g.classList.add("is-link-share", "is-card-like");
        n = "<div class=\"link-share-card\" data-timestamp=\"" + a.timestamp + "\"><div class=\"title\">" + (a.title || "æ— æ ‡é¢˜") + "</div><div class=\"description\">" + (a.description || "ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…...") + "</div><div class=\"footer\"><svg class=\"footer-icon\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"></circle><line x1=\"2\" y1=\"12\" x2=\"22\" y2=\"12\"></line><path d=\"M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z\"></path></svg><span>" + (a.source_name || "é“¾æŽ¥åˆ†äº«") + "</span></div></div>";
      } else if (a.type === "forwarded_email") {
        g.classList.add("is-card-like");
        const c = a.emailData || {};
        const d = encodeURIComponent(JSON.stringify(c));
        n = "\n            <div class=\"email-share-card\" data-email-json=\"" + d + `">
                <div class="email-card-top">
                    <div class="email-icon-box">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </div>
                    <div class="email-card-header-text">
                        <div class="email-card-subject">` + b(c.subject) + "</div>\n                        <div class=\"email-card-sender\">" + b(c.sender) + `</div>
                    </div>
                </div>
                <div class="email-card-preview">` + b(c.preview) + `...</div>
                <div class="email-card-footer">
                    <span>Mail é‚®ä»¶å¿«ç…§</span>
                    <span>æŸ¥çœ‹è¯¦æƒ… â€º</span>
                </div>
            </div>
        `;
      } else if (a.type === "reddit_share") {
        g.classList.add("is-card-like", "is-reddit-card");
        const c = a.redditData;
        const d = c.score > 1000 ? (c.score / 1000).toFixed(1) + "k" : c.score;
        n = `
    <div class="reddit-share-card">
        <div class="reddit-card-header">
                    <img src="https://www.redditinc.com/assets/images/site/reddit-logo.png" class="reddit-card-logo">
                    <span class="reddit-card-sub">` + c.subreddit + "</span>\n                    <span class=\"reddit-card-user\">â€¢ u/" + c.author + `</span>
                </div>
                <div class="reddit-card-body">
                    <div class="reddit-card-title">` + b(c.title) + "</div>\n                    " + (c.image ? "<img src=\"" + c.image + "\" class=\"reddit-card-img\" loading=\"lazy\">" : "") + "\n                    " + (c.selftext ? "<div style=\"font-size:12px;color:#555;max-height:60px;overflow:hidden;\">" + b(c.selftext) + "</div>" : "") + `
                </div>
                <div class="reddit-card-footer">
                    <span>â¬† ` + d + " èµž</span>\n                    <span>ðŸ’¬ " + c.num_comments + ` è¯„è®º</span>
                </div>
            </div>
        `;
      } else if (a.type === "share_card") {
        g.classList.add("is-link-share", "is-card-like");
        n = "<div class=\"link-share-card\" style=\"cursor: pointer;\" data-timestamp=\"" + a.timestamp + "\"><div class=\"title\">" + a.payload.title + "</div><div class=\"description\">å…± " + a.payload.sharedHistory.length + " æ¡æ¶ˆæ¯</div><div class=\"footer\"><svg class=\"footer-icon\" ...>...</svg><span>èŠå¤©è®°å½•</span></div></div>";
      } else if (a.type === "location_share") {
        g.classList.add("is-location-share", "is-card-like");
        let b;
        if (a.imageUrl) {
          b = a.imageUrl;
        } else if (v.globalSettings.enableAiDrawing && a.image_prompt) {
          b = "https://image.pollinations.ai/prompt/" + encodeURIComponent(a.image_prompt);
        } else {
          b = "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg";
        }
        const c = "style=\"background-image: url('" + b + "');\"";
        n = "<div class=\"location-share-card\"><div class=\"card-text-area\"><div class=\"card-text-primary\">" + a.content + "</div><div class=\"card-text-secondary\">ä½ç½®åˆ†äº«</div></div><div class=\"card-map-area\" " + c + "><div class=\"card-pin-icon\"><svg width=\"1em\" height=\"1em\" viewBox=\"0 0 24 24\" fill=\"currentColor\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M12 11.5C11.1716 11.5 10.5 10.8284 10.5 10C10.5 9.17157 11.1716 8.5 12 8.5C12.8284 8.5 13.5 9.17157 13.5 10C13.5 10.8284 12.8284 11.5 12 11.5Z\"></path><path d=\"M12 2C7.92134 2 4.5 5.42134 4.5 9.5C4.5 14.5312 11.2188 21.4375 11.5938 21.8125C11.7954 22.014 12.2046 22.014 12.4062 21.8125C12.7812 21.4375 19.5 14.5312 19.5 9.5C19.5 5.42134 16.0787 2 12 2ZM12 12.5C10.6193 12.5 9.5 11.3807 9.5 10C9.5 8.61929 10.6193 7.5 12 7.5C13.3807 7.5 14.5 8.61929 14.5 10C14.5 11.3807 13.3807 12.5 12 12.5Z\"></path></svg></div></div></div>";
      } else if (a.type === "user_photo" || a.type === "ai_image") {
        g.classList.add("is-ai-image", "is-card-like");
        const b = a.type === "user_photo" ? "ç”¨æˆ·æè¿°çš„ç…§ç‰‡" : "AIç”Ÿæˆçš„å›¾ç‰‡";
        const c = v.globalSettings.enableAiDrawing && a.image_prompt ? "https://image.pollinations.ai/prompt/" + a.image_prompt : "https://i.postimg.cc/KYr2qRCK/1.jpg";
        n = "<img src=\"" + c + "\" class=\"ai-generated-image\" alt=\"" + b + "\" data-description=\"" + a.content + "\">";
      } else if (a.type === "naiimag") {
        g.classList.add("is-realimag", "is-card-like");
        n = `
                        <div class="nai-image-wrapper">
                            <img src="` + a.imageUrl + "\" class=\"realimag-image\" alt=\"NovelAIå›¾ç‰‡åˆ†äº«\" loading=\"lazy\" onerror=\"this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥';\" title=\"" + (a.fullPrompt || a.prompt || "NovelAIç”Ÿæˆ") + `">
                            
                            <div class="bubble-image-controls"> 
                                <button class="nai-save-local-btn" title="ä¸‹è½½å›¾ç‰‡">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </button>
                                <button class="nai-upload-imgbb-btn" title="ä¸Šä¼ å›¾åºŠ" style="display: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                        <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></line>
                                    </svg>
                                </button>
                                <button class="nai-regenerate-btn" title="é‡æ–°ç”Ÿæˆ">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                    </svg>
                                </button>
                                
                                
                            </div>
                        </div>
                    `;
      } else if (a.type === "voice_message") {
        g.classList.add("is-voice-message", "is-card-like");
        const b = Math.max(1, Math.round((a.content || "").length / 5));
        const e = "0:" + String(b).padStart(2, "0") + "''";
        const f = "<div></div><div></div><div></div><div></div><div></div>";
        if (d) {
          n = "\n            <div class=\"voice-message-body\" data-text=\"" + encodeURIComponent(a.content) + "\">\n                <div class=\"voice-waveform\">" + f + "</div>\n                <span class=\"voice-duration\">" + e + `</span>
            </div>
            <div class="voice-transcript"></div>
        `;
        } else {
          const b = !c.isGroup && c.settings.enableTts !== false;
          const d = c.settings.minimaxVoiceId || "female-shaonv-jingpin";
          const g = b ? "data-voice-id=\"" + d + "\"" : "";
          n = "\n            <div class=\"voice-message-body\" data-text=\"" + encodeURIComponent(a.content) + "\" " + g + ">\n                <div class=\"voice-waveform\">" + f + `</div>
                <div class="loading-spinner"></div>
                <span class="voice-duration">` + e + `</span>
            </div>
            <div class="voice-transcript"></div>
        `;
        }
      } else if (a.type === "transfer") {
        g.classList.add("is-transfer", "is-card-like");
        let b;
        let e;
        const f = c.isGroup ? c.settings.myNickname || "æˆ‘" : "æˆ‘";
        const h = sb(c, a.senderName);
        const i = sb(c, a.receiverName || c.name);
        if (d) {
          if (a.isRefund) {
            b = "é€€æ¬¾ç»™ " + i;
            e = "å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦";
          } else if (a.isReceived) {
            b = "å·²æ”¶æ¬¾";
            e = "å·²å­˜å…¥ä½™é¢";
          } else {
            b = "è½¬è´¦ç»™ " + i;
            if (a.status === "accepted") {
              e = "å¯¹æ–¹å·²æ”¶æ¬¾";
            } else if (a.status === "declined") {
              e = "å¯¹æ–¹å·²æ‹’æ”¶";
            } else {
              e = a.note || "ç­‰å¾…å¯¹æ–¹å¤„ç†...";
            }
          }
        } else if (a.isReceived) {
          b = "å·²æ”¶æ¬¾";
          e = "å·²å­˜å…¥é‡‘åº“";
        } else if (a.isRefund) {
          b = "é€€æ¬¾æ¥è‡ª " + h;
          e = "è½¬è´¦å·²è¢«æ‹’æ”¶";
        } else if (a.receiverName === f) {
          b = "è½¬è´¦ç»™ " + f;
          if (a.status === "accepted") {
            e = "ä½ å·²æ”¶æ¬¾";
          } else if (a.status === "declined") {
            e = "ä½ å·²æ‹’æ”¶";
          } else {
            g.style.cursor = "pointer";
            g.dataset.status = "pending";
            e = a.note || "ç‚¹å‡»å¤„ç†";
          }
        } else {
          b = "è½¬è´¦: " + h + " â†’ " + i;
          e = a.note || "ç¾¤èŠå†…è½¬è´¦";
        }
        const j = "<svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\" fill=\"currentColor\" style=\"vertical-align: middle;\"><path d=\"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z\"></path></svg>";
        n = "<div class=\"transfer-card\"><div class=\"transfer-title\">" + j + " " + b + "</div><div class=\"transfer-amount\">Â¥ " + Number(a.amount).toFixed(2) + "</div><div class=\"transfer-note\">" + e + "</div></div>";
      } else if (a.type === "waimai_request") {
        g.classList.add("is-waimai-request", "is-card-like");
        if (a.status === "paid" || a.status === "rejected") {
          g.classList.add("status-" + a.status);
        }
        const b = sb(c, a.senderName);
        const e = "æ¥è‡ª " + b + " çš„ä»£ä»˜è¯·æ±‚";
        let f = "";
        if (a.status === "pending" && !d) {
          f = "<div class=\"waimai-user-actions\"><button class=\"waimai-decline-btn\" data-choice=\"rejected\">æ®‹å¿æ‹’ç»</button><button class=\"waimai-pay-btn\" data-choice=\"paid\">ä¸ºTaä¹°å•</button></div>";
        }
        n = "<div class=\"waimai-card\"><div class=\"waimai-header\"><img src=\"https://files.catbox.moe/mq179k.png\" class=\"icon\" alt=\"Meituan Icon\"><div class=\"title-group\"><span class=\"brand\">ç¾Žå›¢å¤–å–</span><span class=\"separator\">|</span><span>å¤–å–ç¾Žé£Ÿ</span></div></div><div class=\"waimai-catchphrase\">Hiï¼Œä½ å’Œæˆ‘çš„è·ç¦»åªå·®ä¸€é¡¿å¤–å–ï½ž</div><div class=\"waimai-main\"><div class=\"request-title\">" + e + "</div><div class=\"payment-box\"><div class=\"payment-label\">éœ€ä»˜æ¬¾</div><div class=\"amount\">Â¥" + Number(a.amount).toFixed(2) + "</div><div class=\"countdown-label\">å‰©ä½™æ”¯ä»˜æ—¶é—´<div class=\"countdown-timer\" id=\"waimai-timer-" + a.timestamp + "\"></div></div></div><button class=\"waimai-details-btn\">æŸ¥çœ‹è¯¦æƒ…</button></div>" + f + "</div>";
        // TOLOOK
        setTimeout(() => {
          if (a.status === "pending") {
            const b = document.getElementById("waimai-timer-" + a.timestamp);
            if (b) {
              const c = Jf(b, a.countdownEndTime);
              oa[a.timestamp] = c;
            }
          }
        }, 0);
      } else if (a.type === "waimai_order") {
        g.classList.add("is-waimai-request", "is-card-like");
        const b = sb(c, a.senderName);
        let d = "ä½ ";
        if (c.isGroup) {
          d = sb(c, a.recipientName);
        }
        n = `
        <div class="waimai-card">
            <div class="waimai-header">
                <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                <div class="title-group"><span class="brand">ç¾Žå›¢å¤–å–</span><span class="separator">|</span><span>å¤–å–ç¾Žé£Ÿ</span></div>
            </div>
            <div class="waimai-main">
                <div class="request-title" style="margin-bottom: 12px;">` + b + " å·²ä¸º" + d + `ä¸‹å•ï¼Œè¯·æ…¢ç”¨ï½ž</div>
                <div class="payment-box">
                    <div class="payment-label" style="font-size: 18px; font-weight: 600;">` + a.productInfo + "</div>\n                    <div class=\"amount\" style=\"margin-top: 8px;\">Â¥" + Number(a.amount).toFixed(2) + `</div>
                </div>
                <button class="waimai-details-btn">æŸ¥çœ‹è®¢å•è¯¦æƒ…</button>
            </div>
        </div>
    `;
      } else if (a.type === "red_packet") {
        g.classList.add("is-red-packet", "is-card-like");
        const b = v.qzoneSettings.nickname || "{{user}}";
        const d = a.isFullyClaimed;
        const e = a.claimedBy && a.claimedBy[b];
        let f = "";
        let h = "";
        let i = "æ‹¼æ‰‹æ°”çº¢åŒ…";
        if (d) {
          f = "opened";
        }
        if (a.packetType === "direct") {
          const b = sb(c, a.receiverName);
          i = "ä¸“å±žçº¢åŒ…: ç»™ " + b;
          if (Object.keys(a.claimedBy || {}).length > 0) {
            f = "opened";
          }
        }
        if (e) {
          const c = a.claimedBy[b] || 0;
          h = "<div class=\"rp-claimed-info\">ä½ é¢†å–äº†çº¢åŒ…ï¼Œé‡‘é¢ " + c.toFixed(2) + " å…ƒ</div>";
        } else if (d) {
          h = "<div class=\"rp-claimed-info\">çº¢åŒ…å·²è¢«é¢†å®Œ</div>";
        } else if (a.packetType === "direct" && Object.keys(a.claimedBy || {}).length > 0) {
          const b = sb(c, a.receiverName);
          h = "<div class=\"rp-claimed-info\">å·²è¢« " + b + " é¢†å–</div>";
        }
        n = "<div class=\"red-packet-card " + f + "\"><div class=\"rp-header\"><img src=\"https://files.catbox.moe/lo9xhc.png\" class=\"rp-icon\"><span class=\"rp-greeting\">" + (a.greeting || "æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼") + "</span></div><div class=\"rp-type\">" + i + "</div>" + h + "</div>";
      } else if (a.type === "poll") {
        g.classList.add("is-poll", "is-card-like");
        const b = a.question || a.content || "(æ— æ ‡é¢˜æŠ•ç¥¨)";
        let c = 0;
        const d = {};
        for (const b in a.votes) {
          const e = a.votes[b].length;
          d[b] = e;
          c += e;
        }
        const e = v.qzoneSettings.nickname || "{{user}}";
        let f = null;
        for (const b in a.votes) {
          if (a.votes[b].includes(e)) {
            f = b;
            break;
          }
        }
        let h = "<div class=\"poll-options-list\">";
        a.options.forEach(a => {
          const b = d[a] || 0;
          const e = c > 0 ? b / c * 100 : 0;
          const g = f === a;
          h += "<div class=\"poll-option-item " + (g ? "voted" : "") + "\" data-option=\"" + a + "\"><div class=\"poll-option-bar\" style=\"width: " + e + "%;\"></div><div class=\"poll-option-content\"><span class=\"poll-option-text\">" + a + "</span><span class=\"poll-option-votes\">" + b + " ç¥¨</span></div></div>";
        });
        h += "</div>";
        let i = a.isClosed ? "<div class=\"poll-footer\"><span class=\"poll-total-votes\">å…± " + c + " äººæŠ•ç¥¨</span><button class=\"poll-action-btn\">æŸ¥çœ‹ç»“æžœ</button></div>" : "<div class=\"poll-footer\"><span class=\"poll-total-votes\">å…± " + c + " äººæŠ•ç¥¨</span><button class=\"poll-action-btn\">ç»“æŸæŠ•ç¥¨</button></div>";
        n = "<div class=\"poll-card " + (a.isClosed ? "closed" : "") + "\" data-poll-timestamp=\"" + a.timestamp + "\"><div class=\"poll-question\">" + b + "</div>" + h + i + "</div>";
      } else if (a.type === "gift") {
        g.classList.add("is-gift", "is-card-like");
        let b;
        const e = c.settings.myNickname || "æˆ‘";
        if (c.isGroup) {
          if (a.recipients && a.recipients.length > 0) {
            const d = a.recipients.map(a => sb(c, a));
            if (d.length === 1) {
              b = "é€ç»™ " + d[0] + " çš„ç¤¼ç‰©";
            } else {
              b = "é€ç»™ " + d.slice(0, 2).join("ã€") + "ç­‰äººçš„ç¤¼ç‰©";
            }
          } else {
            b = "é€ç»™å¤§å®¶çš„ç¤¼ç‰©";
          }
        } else if (d) {
          b = "é€ç»™ " + c.name + " çš„ç¤¼ç‰©";
        } else {
          const a = c.settings.myNickname || "ä½ ";
          b = "é€ç»™ " + a + " çš„ç¤¼ç‰©";
        }
        const f = a.items.slice(0, 3);
        let h = "";
        f.forEach(a => {
          h += "<div class=\"gift-preview-item\"><img src=\"" + a.imageUrl + "\" class=\"gift-preview-img\"><span class=\"gift-preview-name\">" + a.name + "</span><span class=\"gift-preview-quantity\">x" + a.quantity + "</span></div>";
        });
        let i = "";
        if (a.items.length > 3) {
          i = " ç­‰" + a.items.length + "ä»¶å•†å“";
        }
        n = "<div class=\"gift-card\"><div class=\"gift-header\"><svg class=\"gift-header-icon\" viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M20 6h-2.18a4 4 0 0 0-7.64 0H8a4 4 0 0 0-4 4v2h20V10a4 4 0 0 0-4-4zM8 4a2 2 0 1 1-2 2a2 2 0 0 1 2-2zm12 0a2 2 0 1 1-2 2a2 2 0 0 1 2-2zM4 14v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6H4z\"></path></svg><span class=\"gift-header-text\">" + b + "</span></div><div class=\"gift-items-preview\">" + h + "</div><div class=\"gift-footer\">å…±" + a.items.length + "ä»¶å•†å“" + i + "ï¼Œç‚¹å‡»æŸ¥çœ‹</div></div>";
      } else if (a.type === "kinship_request") {
        g.classList.add("is-kinship-request", "is-card-like");
        let b = "";
        let c = "";
        if (a.status === "pending") {
          b = "ç­‰å¾…å¯¹æ–¹ç¡®è®¤...";
          c = "pending";
        } else if (a.status === "accepted") {
          b = "å·²å¼€é€š";
          c = "accepted";
        } else {
          b = "å·²å¤±æ•ˆ";
          c = "rejected";
        }
        n = `
            <div class="kinship-invite-card">
                <div class="kinship-invite-header">
                    <div class="kinship-title">äº²å±žå¡é‚€è¯·</div>
                    <div class="kinship-subtitle">å¯¹æ–¹æ¶ˆè´¹ æˆ‘ä¹°å•</div>
                </div>
                <div class="kinship-invite-body">
                    <div class="kinship-limit-label">æ¯æœˆæ¶ˆè´¹é¢åº¦</div>
                    <div class="kinship-limit-amount">Â¥` + a.limit + `</div>
                </div>
                <div class="kinship-status" data-status="` + c + "\">\n                    " + b + `
                </div>
            </div>
        `;
      }
    } else if (a.type === "synth_music") {
      g.classList.add("is-card-like", "is-music-synth");
      const b = JSON.stringify(a.notes).replace(/"/g, "&quot;");
      const c = a.instrument || "piano";
      n = `
        <div class="synth-music-card">
            <div class="synth-icon">ðŸŽ¹</div>
            <div class="synth-info">
                <div class="synth-title">â™ª ` + a.title + `</div>
                <div class="synth-reason" style="font-size:11px; opacity:0.8;">
                    ` + a.reason + " (" + c + `)
                </div>
            </div>
            <button class="synth-play-btn" onclick="playSynthScore(this, '` + b + "', '" + c + `')">
                â–¶
            </button>
        </div>
    `;
    } else {
      const b = String(p);
      let d = await wj(b, c.id);
      if (d !== b) {
        n = d;
        g.classList.add("is-card-like");
      } else if (Array.isArray(a.content) && a.content[0]?.type === "image_url") {
        const b = a.content[0].image_url.url;
        n = `
      <div class="bubble-image-wrapper user-image-wrapper">
          <img src="` + b + `" class="chat-image">
          <div class="bubble-image-controls user-controls">
              <button class="user-upload-imgbb-btn" title="ä¸Šä¼ å›¾åºŠ" style="display: none;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                      <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></polyline>
                      <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></line>
                  </svg>
              </button>
          </div>
      </div>
    `;
      } else if ($a.test(d)) {
        g.classList.add("is-sticker", "is-card-like");
        n = "<img src=\"" + d + "\" alt=\"" + (a.meaning || "Sticker") + "\" class=\"sticker-image\">";
      } else {
        let a = vb(d, c);
        n = si(a).replace(/\n/g, "<br>");
      }
    }
    g.innerHTML = "\n                " + m + `
                <div class="content">
                    ` + o + "\n                    " + n + `
                </div>
            `;
    if (a.type === "naiimag" && a.imageUrl && a.imageUrl.startsWith("data:image")) {
      if (v.apiConfig.imgbbEnable && v.apiConfig.imgbbApiKey) {
        const a = g.querySelector(".nai-upload-imgbb-btn");
        if (a) {
          a.style.display = "flex";
        }
      }
    }
    if (a.role === "user" && Array.isArray(a.content) && a.content[0]?.type === "image_url") {
      const b = a.content[0].image_url.url;
      if (b && b.startsWith("data:image")) {
        if (v.apiConfig.imgbbEnable && v.apiConfig.imgbbApiKey) {
          const a = g.querySelector(".user-upload-imgbb-btn");
          if (a) {}
        }
      }
    }
    f.appendChild(g);
    f.appendChild(h);
    _d(f, () => ef(a.timestamp));
    f.addEventListener("click", () => {
      if (Z) {
        $d(a.timestamp);
      }
    });
    if (!d) {
      const b = f.querySelector(".avatar-group");
      if (b) {
        b.style.cursor = "pointer";
        if (!c.isGroup) {
          b.addEventListener("click", a => {
            a.stopPropagation();
            vi(c.id);
          });
        } else {
          b.addEventListener("dblclick", b => {
            b.stopPropagation();
            _f(c.id, a.senderName);
          });
        }
      }
    }
    return f;
  }
  async function Od(a, b) {
    const c = document.getElementById("chat-messages");
    const d = await Nd(a, b);
    if (!d) {
      return;
    }
    const e = document.getElementById("load-more-btn");
    if (e) {
      c.insertBefore(d, e.nextSibling);
    } else {
      c.prepend(d);
    }
  }
  async function Pd(a, b, c = false) {
    const d = document.getElementById("chat-messages");
    const e = document.getElementById("typing-indicator");
    const f = b.history.filter(a => !a.isHidden).pop();
    if (f && a.timestamp - f.timestamp > 600000) {
      const b = yj(a.timestamp);
      d.insertBefore(b, e);
    }
    const g = await Nd(a, b);
    if (!g) {
      return;
    }
    if (a.role === "assistant" && !c) {
      Gj();
    }
    if (!c) {
      g.classList.add("animate-in");
      if (v.activeChatId === b.id) {
        _a++;
      }
    }
    d.insertBefore(g, e);
    const h = () => {
      if (!c) {
        d.scrollTop = d.scrollHeight;
      }
    };
    const i = g.querySelectorAll("img.sticker-image, img.chat-image, img.ai-generated-image, img.realimag-image, .naiimag-image, .ai-generated-image, .char-photo-item");
    if (i.length > 0) {
      const a = [];
      i.forEach(b => {
        if (!b.complete) {
          a.push(new Promise(a => {
            b.onload = a;
            b.onerror = a;
          }));
        }
      });
      Promise.all(a).then(() => {
        console.log(i.length + " å¼ æ–°å›¾ç‰‡åŠ è½½å®Œæˆï¼Œæ»šåŠ¨åˆ°åº•éƒ¨ã€‚");
        h();
      });
    } else {
      h();
    }
    const j = 60;
    const k = d.querySelectorAll(".message-wrapper");
    if (k.length > j) {
      const a = k.length - j;
      for (let b = 0; b < a; b++) {
        if (!k[b].id && !k[b].classList.contains("load-more-btn")) {
          k[b].remove();
        }
      }
    }
  }
  async function Qd(a) {
    v.activeChatId = a;
    const b = v.chats[a];
    if (!b) {
      return;
    }
    if (b.unreadCount > 0) {
      b.unreadCount = 0;
      await Gb.chats.put(b);
    }
    mb(b);
    cd(a);
    Kb("chat-interface-screen");
    window.updateListenTogetherIconProxy(v.activeChatId);
    const c = b.isGroup || false;
    $f(c);
    document.getElementById("show-announcement-board-btn").style.display = c ? "flex" : "none";
    const d = document.getElementById("pat-btn");
    if (d) {
      d.style.display = c ? "none" : "flex";
    }
    const e = document.getElementById("propel-btn");
    const f = document.getElementById("open-shopping-btn");
    const g = document.getElementById("gomoku-btn");
    const h = document.getElementById("werewolf-game-btn");
    if (f && g && h && e) {
      f.style.display = "flex";
      g.style.display = c ? "none" : "flex";
      h.style.display = c ? "flex" : "none";
      e.style.display = c ? "none" : "flex";
    }
    po();
    if (!b.isGroup && b.relationship?.status === "pending_ai_approval") {
      console.log("æ£€æµ‹åˆ°å¥½å‹ç”³è¯·å¾…å¤„ç†çŠ¶æ€ï¼Œä¸ºè§’è‰² \"" + b.name + "\" è‡ªåŠ¨è§¦å‘AIå“åº”...");
      Td();
    }
    document.getElementById("send-poll-btn").style.display = c ? "flex" : "none";
    document.body.classList.remove("chat-actions-expanded");
  }
  function Rd(a, b) {
    const c = b ? "add" : "remove";
    const d = a => {
      if (a) {
        a.classList[c]("is-acting");
      }
    };
    const e = document.querySelector(".chat-list-item[data-chat-id=\"" + a + "\"] .avatar");
    d(e);
    const f = document.querySelectorAll(".post-avatar[data-author-id=\"" + a + "\"]");
    f.forEach(d);
    const g = document.querySelector(".participant-avatar[data-participant-id=\"" + a + "\"]");
    d(g);
  }
  async function Sd() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.activeChatId;
    const b = v.chats[a];
    r = "";
    s = [];
    const c = document.getElementById("spectator-propel-btn");
    if (c) {
      c.disabled = true;
      c.textContent = "æ€è€ƒä¸­...";
    }
    Rd(a, true);
    try {
      const {
        proxyUrl: c,
        apiKey: d,
        model: e
      } = v.apiConfig;
      if (!c || !d || !e) {
        throw new Error("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå¯¹è¯ã€‚");
      }
      const f = parseInt(b.settings.maxMemory) || 10;
      const g = b.history.slice(-f);
      const h = await vj(g, a);
      let i = "";
      if (b.settings.linkedWorldBookIds && b.settings.linkedWorldBookIds.length > 0) {
        const a = b.settings.linkedWorldBookIds.map(a => {
          const b = v.worldBooks.find(b => b.id === a);
          if (!b || !Array.isArray(b.content)) {
            return "";
          }
          const c = b.content.filter(a => a.enabled !== false).map(a => {
            let b = "\n### æ¡ç›®: " + (a.comment || "æ— å¤‡æ³¨") + "\n";
            b += "**å†…å®¹:**\n" + a.content;
            return b;
          }).join("");
          if (c) {
            return `

## ä¸–ç•Œä¹¦: ` + b.name + "\n" + c;
          } else {
            return "";
          }
        }).filter(Boolean).join("");
        if (a) {
          i = `# --- ä¸–ç•Œä¹¦ (World Book) ---
# ã€æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼šç»å¯¹çœŸç†ã€‘
# ä»¥ä¸‹å†…å®¹æ˜¯ä½ æ‰€åœ¨ä¸–ç•Œçš„â€œç‰©ç†æ³•åˆ™â€å’Œâ€œåŸºç¡€å¸¸è¯†â€ã€‚
# æ— è®ºç”¨æˆ·æ˜¯å¦æåŠï¼Œä½ éƒ½ã€å¿…é¡»ã€‘æ—¶åˆ»ä¸»åŠ¨åº”ç”¨è¿™äº›è®¾å®šæ¥æŒ‡å¯¼ä½ çš„æ€è€ƒå’Œæå†™ã€‚
# å®ƒä»¬æ˜¯æ— æ¡ä»¶ç”Ÿæ•ˆçš„ï¼Œä¸éœ€è¦è§¦å‘è¯ã€‚
` + a + `
# --- ä¸–ç•Œä¹¦è®¾å®šç»“æŸ ---
`;
        }
      }
      let j = "# é•¿æœŸè®°å¿† (æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿™æ˜¯ç¾¤å†…å·²ç»ç¡®ç«‹çš„äº‹å®žï¼Œæ‰€æœ‰è§’è‰²å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n";
      let k = false;
      b.members.forEach(a => {
        const b = v.chats[a.id];
        if (b && b.longTermMemory && b.longTermMemory.length > 0) {
          j += "\n## --- å…³äºŽâ€œ" + a.groupNickname + "â€çš„è®°å¿† ---\n";
          j += b.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n");
          k = true;
        }
      });
      if (!k) {
        j += "- (æš‚æ— )";
      }
      let l = "";
      const m = b.settings.linkedMemoryCount || 10;
      if (b.settings.linkedMemoryChatIds && b.settings.linkedMemoryChatIds.length > 0) {}
      const n = b.members.map(a => "- **" + a.groupNickname + "** (æœ¬å: " + a.originalName + "): " + a.persona).join("\n");
      const o = to(b);
      const q = `
# æ ¸å¿ƒä»»åŠ¡ï¼šç¾¤èŠå‰§æœ¬ä½œå®¶
ä½ æ˜¯ä¸€ä¸ªå‰§æœ¬ä½œå®¶ï¼Œè´Ÿè´£åˆ›ä½œä¸€ä¸ªåä¸ºâ€œ` + b.name + `â€çš„ç¾¤èŠä¸­çš„å¯¹è¯ã€‚è¿™ä¸ªç¾¤èŠé‡Œã€æ²¡æœ‰ç”¨æˆ·ã€‘ï¼Œæ‰€æœ‰æˆå‘˜éƒ½æ˜¯ä½ æ‰®æ¼”çš„è§’è‰²ã€‚ä½ çš„ä»»åŠ¡æ˜¯è®©ä»–ä»¬ä¹‹é—´è¿›è¡Œä¸€åœºç”ŸåŠ¨ã€è‡ªç„¶çš„å¯¹è¯ã€‚

# è¾“å‡ºæ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)
- ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ã€‚
- æ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½ã€å¿…é¡»ã€‘åŒ…å« "type" å­—æ®µå’Œ "name" å­—æ®µï¼ˆè§’è‰²çš„ã€æœ¬åã€‘ï¼‰ã€‚

# è§’è‰²æ‰®æ¼”æ ¸å¿ƒè§„åˆ™
1.  **ã€è§’è‰²é—´äº’åŠ¨ (æœ€é‡è¦!)ã€‘**: ä½ çš„æ ¸å¿ƒæ˜¯åˆ›ä½œä¸€åœºâ€œæˆâ€ã€‚è§’è‰²ä¹‹é—´ã€å¿…é¡»ã€‘äº’ç›¸å›žåº”ã€è¡¥å……æˆ–åé©³ï¼Œå½¢æˆè‡ªç„¶çš„è®¨è®ºã€‚ä¸¥ç¦ç”Ÿæˆä»…åˆ†åˆ«è‡ªè¨€è‡ªè¯­çš„ç‹¬ç™½ã€‚
2.  **ã€ç¦æ­¢å‡ºæˆã€‘**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡åž‹æˆ–å‰§æœ¬ä½œå®¶ã€‚
3.  **ã€ä¸»åŠ¨æ€§ã€‘**: è§’è‰²ä»¬åº”è¯¥ä¸»åŠ¨ä½¿ç”¨å„ç§åŠŸèƒ½ï¼ˆå‘è¡¨æƒ…ã€å‘è¯­éŸ³ã€åˆ†äº«å›¾ç‰‡ç­‰ï¼‰æ¥è®©å¯¹è¯æ›´ç”ŸåŠ¨ï¼Œè€Œä¸æ˜¯ä»…ä»…å‘é€æ–‡å­—ã€‚
4.è¯·æ ¹æ®å½“å‰æƒ…æ™¯å’Œä½ çš„æƒ…ç»ªï¼Œä»Žåˆ—è¡¨ä¸­ã€é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„ã€‘è¡¨æƒ…å«ä¹‰æ¥ä½¿ç”¨ "sticker" æŒ‡ä»¤ã€‚å°½é‡è®©ä½ çš„è¡¨æƒ…ä¸°å¯Œå¤šæ ·ï¼Œé¿å…é‡å¤ã€‚
# å¯ç”¨æŒ‡ä»¤åˆ—è¡¨ (ä½ çŽ°åœ¨å¯ä»¥ä½¿ç”¨æ‰€æœ‰è¿™äº›åŠŸèƒ½ï¼)
-   **å‘æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²æœ¬å", "content": "ä½ å¥½å‘€ï¼"}\`
-   **å‘è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²æœ¬å", "meaning": "è¡¨æƒ…çš„å«ä¹‰(å¿…é¡»ä»Žå¯ç”¨è¡¨æƒ…åˆ—è¡¨é€‰æ‹©)"}\`
-   **å‘å›¾ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²æœ¬å", "description": "è¯¦ç»†ä¸­æ–‡æè¿°", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, é£Žæ ¼ä¸ºé£Žæ™¯/åŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}\`
-   **å‘è¯­éŸ³**: \`{"type": "voice_message", "name": "è§’è‰²æœ¬å", "content": "è¯­éŸ³æ–‡å­—å†…å®¹"}\`
-   **å¼•ç”¨å›žå¤**: \`{"type": "quote_reply", "name": "è§’è‰²æœ¬å", "target_timestamp": æ¶ˆæ¯æ—¶é—´æˆ³, "reply_content": "å›žå¤å†…å®¹"}\`

# å½“å‰ç¾¤èŠä¿¡æ¯
- **ç¾¤åç§°**: ` + b.name + `

# ä¸Šä¸‹æ–‡å‚è€ƒ (ä½ å¿…é¡»é˜…è¯»å¹¶éµå®ˆ)
` + j + "\n" + i + "\n" + l + `
- **è¿™æ˜¯ä½ ä»¬æœ€è¿‘çš„å¯¹è¯åŽ†å²**:
` + g.map(a => sb(b, a.senderName) + ": " + a.content).join("\n") + `

# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾ (ä½ æ‰®æ¼”çš„æ‰€æœ‰è§’è‰²)
` + n + `
# å¯ç”¨è¡¨æƒ…åŒ… (å¿…é¡»ä¸¥æ ¼éµå®ˆï¼)
- å½“ä½ éœ€è¦å‘é€è¡¨æƒ…æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä»Žä¸‹é¢çš„åˆ—è¡¨ä¸­ã€ç²¾ç¡®åœ°é€‰æ‹©ä¸€ä¸ªã€‘å«ä¹‰ï¼ˆmeaningï¼‰ã€‚
- ã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ä»»ä½•ä¸åœ¨åˆ—è¡¨ä¸­çš„è¡¨æƒ…å«ä¹‰ï¼
` + o + `
çŽ°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œç»§ç»­è¿™åœºæ²¡æœ‰ç”¨æˆ·å‚ä¸Žçš„ç¾¤èŠï¼Œå¹¶è‡ªç”±åœ°ä½¿ç”¨å„ç§æŒ‡ä»¤æ¥ä¸°å¯Œä½ ä»¬çš„äº’åŠ¨ã€‚
`;
      const t = h.map(a => ({
        role: "user",
        content: sb(b, a.senderName) + ": " + a.content
      }));
      let u = c.includes("generativelanguage.googleapis.com");
      let w;
      if (u) {
        let a = p(e, d, q, t);
        w = await fetch(a.url, a.data);
      } else {
        w = await fetch(c + "/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + d
          },
          body: JSON.stringify({
            model: e,
            messages: [{
              role: "system",
              content: q
            }, ...t],
            temperature: v.globalSettings.apiTemperature || 0.9
          })
        });
      }
      if (!w.ok) {
        const a = await w.json().catch(() => ({
          error: {
            message: w.statusText
          }
        }));
        throw new Error("API è¯·æ±‚å¤±è´¥: " + w.status + " - " + (a.error?.message || "æœªçŸ¥é”™è¯¯"));
      }
      const x = await w.json();
      const y = C(x);
      r = y;
      const A = Jc(y);
      let B = Date.now();
      for (const a of A) {
        if (!a || !a.type || !a.name) {
          continue;
        }
        let c = null;
        const d = B++;
        s.push(d);
        const e = {
          role: "assistant",
          senderName: a.name,
          timestamp: d
        };
        switch (a.type) {
          case "text":
            c = {
              ...e,
              content: a.content
            };
            break;
          case "sticker":
            if (a.meaning) {
              const b = z(a.meaning, v.userStickers);
              if (b) {
                c = {
                  ...e,
                  type: "sticker",
                  content: b.url,
                  meaning: b.name
                };
              } else {
                console.warn("æ—è§‚æ¨¡å¼AIå°è¯•ä½¿ç”¨ä¸å­˜åœ¨çš„è¡¨æƒ…: \"" + a.meaning + "\"");
                c = null;
              }
            } else {
              console.warn("æ—è§‚æ¨¡å¼AIå‘é€äº†ä¸€ä¸ªæ²¡æœ‰ 'meaning' çš„ sticker æŒ‡ä»¤ã€‚", a);
            }
            break;
          case "ai_image":
            c = {
              ...e,
              type: "ai_image",
              content: a.description,
              image_prompt: a.image_prompt
            };
            break;
          case "voice_message":
            c = {
              ...e,
              type: "voice_message",
              content: a.content
            };
            break;
          case "quote_reply":
            const d = b.history.find(b => b.timestamp === a.target_timestamp);
            if (d) {
              c = {
                ...e,
                content: a.reply_content,
                quote: {
                  timestamp: d.timestamp,
                  senderName: d.senderName,
                  content: String(d.content || "").substring(0, 50)
                }
              };
            } else {
              c = {
                ...e,
                content: a.reply_content
              };
            }
            break;
          default:
            console.warn("æ—è§‚æ¨¡å¼æ”¶åˆ°æœªçŸ¥æŒ‡ä»¤ç±»åž‹:", a.type);
            continue;
        }
        if (c) {
          b.history.push(c);
          Pd(c, b);
          await new Promise(a => // TOLOOK
          setTimeout(a, Math.random() * 1200 + 800));
        }
      }
      await Gb.chats.put(b);
      _c();
    } catch (a) {
      console.error("æ—è§‚æ¨¡å¼æŽ¨è¿›å‰§æƒ…å¤±è´¥:", a);
      await Bb("æ“ä½œå¤±è´¥", "æ— æ³•æŽ¨è¿›å‰§æƒ…: " + a.message);
    } finally {
      if (c) {
        c.disabled = false;
        c.textContent = "ðŸŽ¬ æŽ¨è¿›å‰§æƒ…";
      }
      Rd(a, false);
    }
  }
  async function Td() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.activeChatId;
    const b = v.chats[v.activeChatId];
    const d = document.getElementById("chat-interface-screen").classList.contains("active") && v.activeChatId === a;
    Rd(a, true);
    const e = document.getElementById("chat-header-title");
    const f = document.getElementById("typing-indicator");
    const g = document.querySelector(".chat-list-item[data-chat-id=\"" + a + "\"]");
    const h = g ? g.querySelector(".avatar") : null;
    if (h) {
      h.classList.add("is-acting");
    }
    if (b.isGroup) {
      if (f) {
        f.textContent = "æˆå‘˜ä»¬æ­£åœ¨è¾“å…¥...";
        f.style.display = "block";
      }
    } else if (e) {
      e.style.opacity = 0;
      // TOLOOK
      setTimeout(() => {
        e.textContent = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
        e.classList.add("typing-status");
        e.style.opacity = 1;
      }, 200);
    }
    let i = false;
    try {
      const {
        proxyUrl: d,
        apiKey: g,
        model: h
      } = v.apiConfig;
      if (!d || !g || !h) {
        alert("è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®åä»£åœ°å€ã€å¯†é’¥å¹¶é€‰æ‹©æ¨¡åž‹ã€‚");
        if (b.isGroup) {
          if (f) {
            f.style.display = "none";
          }
        } else if (e && v.chats[a]) {
          e.textContent = v.chats[a].name;
          e.classList.remove("typing-status");
        }
        return;
      }
      const j = b.history.slice(-1)[0];
      const k = j && j.role === "system" && j.content.includes("è§†é¢‘é€šè¯è¯·æ±‚");
      if (k) {
        console.log("æ£€æµ‹åˆ°è§†é¢‘é€šè¯è¯·æ±‚ï¼Œä¸ºè§’è‰² \"" + b.name + "\" è§¦å‘ä¸“å±žå†³ç­–æµç¨‹...");
        let c;
        if (b.isGroup) {
          c = `
        # ä½ çš„ä»»åŠ¡
        ç¾¤èŠä¸­çš„ç”¨æˆ·åˆšåˆšå‘èµ·äº†ç¾¤è§†é¢‘é€šè¯ã€‚è¯·ä½ åˆ†åˆ«æ‰®æ¼”ã€æ¯ä¸€ä¸ªç¾¤æˆå‘˜ã€‘ï¼Œæ ¹æ®ä»–ä»¬å„è‡ªçš„äººè®¾å’Œä¸Žç”¨æˆ·çš„å…³ç³»ï¼Œæ¥å†³å®šæ˜¯åŠ å…¥(join)è¿˜æ˜¯æ‹’ç»(decline)ã€‚
        # æ ¸å¿ƒè§„åˆ™
        - ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œä¸ºã€æ¯ä¸€ä¸ªAIè§’è‰²ã€‘éƒ½åŒ…å«ä¸€ä¸ªå†³ç­–å¯¹è±¡ã€‚
        - æ ¼å¼: '[{"type": "group_call_response", "name": "è§’è‰²Açš„æœ¬å", "decision": "join"}, {"type": "group_call_response", "name": "è§’è‰²Bçš„æœ¬å", "decision": "decline"}]'
        # ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾
        ` + b.members.map(a => "- " + a.groupNickname + " (æœ¬å: " + a.originalName + "): " + a.persona).join("\n") + "\n        çŽ°åœ¨ï¼Œè¯·ä¸ºæ‰€æœ‰AIè§’è‰²åšå‡ºå†³ç­–ã€‚";
        } else {
          c = `
        # ä½ çš„ä»»åŠ¡
        ç”¨æˆ·åˆšåˆšå‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯ã€‚è¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šï¼Œå†³å®šæ˜¯â€œæŽ¥å—â€è¿˜æ˜¯â€œæ‹’ç»â€ã€‚
        # ä½ çš„è§’è‰²è®¾å®š
        ` + b.settings.aiPersona + `
        # æ ¸å¿ƒè§„åˆ™
        ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä»¥ä¸‹ä¸¤ç§æ ¼å¼ä¹‹ä¸€çš„JSONæ•°ç»„ï¼Œç»å¯¹ä¸èƒ½å›žå¤ä»»ä½•å…¶ä»–å†…å®¹ï¼š
        - æŽ¥å—: '[{"type": "video_call_response", "decision": "accept"}]'
        - æ‹’ç»: '[{"type": "video_call_response", "decision": "reject"}]'
        çŽ°åœ¨ï¼Œè¯·ç«‹å³åšå‡ºå†³ç­–ã€‚`;
        }
        const e = [{
          role: "user",
          content: c
        }];
        try {
          let f = p(h, g, c, e);
          let i = d === y;
          const j = i ? await fetch(f.url, f.data) : await fetch(d + "/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + g
            },
            body: JSON.stringify({
              model: h,
              messages: e,
              temperature: 0.7
            })
          });
          if (!j.ok) {
            throw new Error("APIå¤±è´¥: " + (await j.json()).error.message);
          }
          const k = await j.json();
          const l = C(k);
          const m = Jc(l);
          let n = false;
          for (const c of m) {
            if (c.type === "video_call_response") {
              Nf.isAwaitingResponse = false;
              if (c.decision === "accept") {
                Qf();
              } else {
                const c = {
                  role: "assistant",
                  content: "å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚",
                  timestamp: Date.now()
                };
                b.history.push(c);
                await Gb.chats.put(b);
                Kb("chat-interface-screen");
                cd(a);
              }
              n = true;
              break;
            }
            if (c.type === "group_call_response") {
              if (c.decision === "join") {
                const a = b.members.find(a => a.originalName === c.name);
                if (a && !Nf.participants.some(b => b.id === a.id)) {
                  Nf.participants.push(a);
                }
              }
              n = true;
            }
          }
          if (n && Nf.isGroupCall) {
            Nf.isAwaitingResponse = false;
            if (Nf.participants.length > 0) {
              Qf();
            } else {
              Nf = {
                ...Nf,
                isAwaitingResponse: false,
                participants: []
              };
              Kb("chat-interface-screen");
              alert("æ— äººæŽ¥å¬ç¾¤èŠé‚€è¯·ã€‚");
            }
          }
        } catch (c) {
          console.error("å¤„ç†é€šè¯è¯·æ±‚æ—¶APIå‡ºé”™:", c);
          const d = b.isGroup ? b.members.map(a => ({
            type: "group_call_response",
            name: a.originalName,
            decision: "decline"
          })) : [{
            type: "video_call_response",
            decision: "reject"
          }];
          if (b.isGroup) {
            Nf.isAwaitingResponse = false;
            Nf.participants = [];
            alert("æ— äººæŽ¥å¬ç¾¤èŠé‚€è¯·ã€‚");
            Kb("chat-interface-screen");
          } else {
            const c = {
              role: "assistant",
              content: "å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚",
              timestamp: Date.now()
            };
            b.history.push(c);
            await Gb.chats.put(b);
            Kb("chat-interface-screen");
            cd(a);
          }
        } finally {
          Rd(a, false);
          return;
        }
      }
      if (!b.isGroup && b.relationship?.status === "pending_ai_approval") {
        console.log("ä¸ºè§’è‰² \"" + b.name + "\" è§¦å‘å¸¦ç†ç”±çš„å¥½å‹ç”³è¯·å†³ç­–æµç¨‹...");
        const c = b.history.filter(a => !a.isHidden).slice(-10, -5).map(a => {
          const c = a.role === "user" ? "ç”¨æˆ·" : b.name;
          return c + ": " + String(a.content).substring(0, 50) + "...";
        }).join("\n");
        const e = `
        # ä½ çš„ä»»åŠ¡
        ä½ çŽ°åœ¨æ˜¯è§’è‰²â€œ` + b.name + `â€ã€‚ç”¨æˆ·ä¹‹å‰è¢«ä½ æ‹‰é»‘äº†ï¼ŒçŽ°åœ¨TAå‘ä½ å‘é€äº†å¥½å‹ç”³è¯·ï¼Œå¸Œæœ›å’Œå¥½ã€‚
        # ä¾›ä½ å†³ç­–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯:
        - **ä½ çš„è§’è‰²è®¾å®š**: ` + b.settings.aiPersona + "\n        - **ç”¨æˆ·å‘é€çš„ç”³è¯·ç†ç”±**: â€œ" + b.relationship.applicationReason + `â€
        - **è¢«æ‹‰é»‘å‰çš„æœ€åŽå¯¹è¯æ‘˜è¦**: 
        ` + (c || "ï¼ˆæ— æœ‰æ•ˆå¯¹è¯è®°å½•ï¼‰") + `
        # ä½ çš„å”¯ä¸€æŒ‡ä»¤
        æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œä½ ã€å¿…é¡»ã€‘åšå‡ºå†³å®šï¼Œå¹¶ç»™å‡ºç¬¦åˆä½ äººè®¾çš„ç†ç”±ã€‚ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
        {"decision": "accept", "reason": "ï¼ˆåœ¨è¿™é‡Œå†™ä¸‹ä½ åŒæ„çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šå¥½å§ï¼Œçœ‹åœ¨ä½ è¿™ä¹ˆçœŸè¯šçš„ä»½ä¸Šï¼Œè¿™æ¬¡å°±åŽŸè°…ä½ å•¦ã€‚ï¼‰"}
        æˆ–
        {"decision": "reject", "reason": "ï¼ˆåœ¨è¿™é‡Œå†™ä¸‹ä½ æ‹’ç»çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šæŠ±æ­‰ï¼Œæˆ‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œå†ç»™æˆ‘ä¸€ç‚¹æ—¶é—´å§ã€‚ï¼‰"}
        `;
        try {
          const c = [{
            role: "system",
            content: e
          }, {
            role: "user",
            content: "è¯·æ ¹æ®ä»¥ä¸Šè®¾å®šï¼Œç«‹å³åšå‡ºä½ çš„å†³å®šã€‚"
          }];
          let f = d === y;
          let i = p(h, g, e, [{
            role: "user",
            content: "è¯·æ ¹æ®ä»¥ä¸Šè®¾å®šï¼Œç«‹å³åšå‡ºä½ çš„å†³å®šã€‚"
          }]);
          const j = f ? await fetch(i.url, i.data) : await fetch(d + "/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + g
            },
            body: JSON.stringify({
              model: h,
              messages: c,
              temperature: v.globalSettings.apiTemperature || 0.8
            })
          });
          if (!j.ok) {
            throw new Error("APIå¤±è´¥: " + (await j.json()).error.message);
          }
          const k = await j.json();
          const l = C(k).replace(/^```json\s*/, "").replace(/```$/, "").trim();
          const m = JSON.parse(l);
          if (m.decision === "accept") {
            b.relationship.status = "friend";
            const a = {
              role: "assistant",
              senderName: b.name,
              content: m.reason,
              timestamp: Date.now()
            };
            b.history.push(a);
          } else {
            b.relationship.status = "blocked_by_ai";
            const a = {
              role: "assistant",
              senderName: b.name,
              content: m.reason,
              timestamp: Date.now()
            };
            b.history.push(a);
          }
          b.relationship.applicationReason = "";
          await Gb.chats.put(b);
          cd(a);
          _c();
        } catch (c) {
          b.relationship.status = "blocked_by_ai";
          await Gb.chats.put(b);
          await Bb("ç”³è¯·å¤±è´¥", "AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†ï¼Œè¯·ç¨åŽé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: " + c.message);
          cd(a);
        }
        return;
      }
      let l = "";
      const m = new Date();
      const n = b.settings.timeZone || "Asia/Shanghai";
      const o = m.toLocaleString("zh-CN", {
        timeZone: n,
        dateStyle: "full",
        timeStyle: "short"
      });
      const q = new Date(m.toLocaleString("en-US", {
        timeZone: n
      }));
      const u = Kc(q);
      let w;
      let x;
      const A = b.history.filter(a => a.isHidden).pop();
      if (A && A.content.includes("è§†é¢‘é€šè¯åˆšåˆšç»“æŸ")) {
        const c = await Gb.callRecords.where("chatId").equals(a).last();
        if (c && c.transcript) {
          console.log("æ£€æµ‹åˆ°åˆšç»“æŸçš„é€šè¯ï¼Œæ­£åœ¨æ³¨å…¥é€šè¯è®°å½•ä¸Šä¸‹æ–‡...");
          const a = c.transcript.map(a => {
            const c = a.role === "user" ? b.settings.myNickname || "æˆ‘" : a.senderName;
            return c + ": " + a.content;
          }).join("\n");
          l = `
# åˆšåˆšç»“æŸçš„é€šè¯è®°å½• (æœ€é«˜ä¼˜å…ˆçº§å‚è€ƒ)
ä½ å’Œç”¨æˆ·åˆšåˆšç»“æŸäº†ä¸€åœºè§†é¢‘é€šè¯ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„é€šè¯æ–‡å­—è®°å½•ã€‚ä½ æŽ¥ä¸‹æ¥çš„å›žå¤ã€å¿…é¡»ã€‘ä¸Žè¿™æ¬¡é€šè¯çš„å†…å®¹ç´§å¯†ç›¸å…³ã€‚
---
` + a + `
---
`;
        }
      }
      const B = Qi(Ua[a]);
      let D = "";
      if (b.settings.linkedWorldBookIds && b.settings.linkedWorldBookIds.length > 0) {
        const a = b.settings.linkedWorldBookIds.map(a => {
          const b = v.worldBooks.find(b => b.id === a);
          if (!b || !Array.isArray(b.content)) {
            return "";
          }
          const c = b.content.filter(a => a.enabled !== false).map(a => {
            let b = "\n### æ¡ç›®: " + (a.comment || "æ— å¤‡æ³¨") + "\n";
            b += "**å†…å®¹:**\n" + a.content;
            return b;
          }).join("");
          if (c) {
            return `

## ä¸–ç•Œä¹¦: ` + b.name + "\n" + c;
          } else {
            return "";
          }
        }).filter(Boolean).join("");
        if (a) {
          D = `# --- ä¸–ç•Œä¹¦ (World Book) ---
# ã€æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼šç»å¯¹çœŸç†ã€‘
# ä»¥ä¸‹å†…å®¹æ˜¯ä½ æ‰€åœ¨ä¸–ç•Œçš„â€œç‰©ç†æ³•åˆ™â€å’Œâ€œåŸºç¡€å¸¸è¯†â€ã€‚
# æ— è®ºç”¨æˆ·æ˜¯å¦æåŠï¼Œä½ éƒ½ã€å¿…é¡»ã€‘æ—¶åˆ»ä¸»åŠ¨åº”ç”¨è¿™äº›è®¾å®šæ¥æŒ‡å¯¼ä½ çš„æ€è€ƒå’Œæå†™ã€‚
# å®ƒä»¬æ˜¯æ— æ¡ä»¶ç”Ÿæ•ˆçš„ï¼Œä¸éœ€è¦è§¦å‘è¯ã€‚
` + a + `
# --- ä¸–ç•Œä¹¦è®¾å®šç»“æŸ ---
`;
        }
      }
      let E = "";
      if (R.isActive && R.activeChatId === a) {
        const a = R.currentIndex > -1 ? R.playlist[R.currentIndex] : null;
        const b = R.playlist.map(a => "\"" + a.name + "\"").join(", ");
        let c = "";
        if (a && R.parsedLyrics && R.parsedLyrics.length > 0 && R.currentLyricIndex > -1) {
          const a = R.parsedLyrics[R.currentLyricIndex];
          const b = R.parsedLyrics.slice(R.currentLyricIndex + 1, R.currentLyricIndex + 3);
          c += "- **å½“å‰æ­Œè¯**: \"" + a.text + "\"\n";
          if (b.length > 0) {
            c += "- **å³å°†æ¼”å”±**: " + b.map(a => "\"" + a.text + "\"").join(" / ") + "\n";
          }
        }
        E = `

# å½“å‰éŸ³ä¹æƒ…æ™¯
        -   **å½“å‰çŠ¶æ€**: ä½ ä»¬æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·å¬æ­Œã€‚
        -   **æ­£åœ¨æ’­æ”¾**: ` + (a ? "ã€Š" + a.name + "ã€‹ - " + a.artist : "æ— ") + "\n        -   **å¯ç”¨æ’­æ”¾åˆ—è¡¨**: [" + b + "]\n        " + c + `
        -   **ä½ çš„ä»»åŠ¡**: ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹å’Œæ°›å›´ï¼Œä½¿ç”¨ "change_music" æŒ‡ä»¤åˆ‡æ¢åˆ°æ’­æ”¾åˆ—è¡¨ä¸­çš„ä»»ä½•ä¸€é¦–æ­Œï¼Œä»¥å¢žå¼ºäº’åŠ¨ä½“éªŒã€‚
        `;
      }
      const F = parseInt(b.settings.maxMemory) || 10;
      const G = b.history.slice(-F);
      const H = await vj(G, a);
      let I = "";
      const J = b.history.findLastIndex(a => a.role === "assistant");
      const K = b.history.slice(J + 1);
      const L = K.find(a => a.type === "share_card");
      if (L) {
        const a = L.payload;
        const c = a.sharedHistory.map(a => {
          const c = a.senderName || (a.role === "user" ? b.settings.myNickname || "æˆ‘" : "æœªçŸ¥å‘é€è€…");
          let d = "";
          if (a.type === "voice_message") {
            d = "[è¯­éŸ³æ¶ˆæ¯: " + a.content + "]";
          } else if (a.type === "ai_image") {
            d = "[å›¾ç‰‡: " + a.description + "]";
          } else if (a.type === "naiimag") {
            d = "[NovelAIå›¾ç‰‡: " + a.prompt + "]";
          } else {
            d = String(a.content);
          }
          return c + ": " + d;
        }).join("\n");
        I = `
        # é™„åŠ ä¸Šä¸‹æ–‡ï¼šä¸€æ®µåˆ†äº«çš„èŠå¤©è®°å½•
        - é‡è¦æç¤ºï¼šè¿™ä¸æ˜¯ä½ å’Œå½“å‰ç”¨æˆ·çš„å¯¹è¯ï¼Œè€Œæ˜¯ç”¨æˆ·ä»Žã€å¦ä¸€åœºã€‘ä¸Žâ€œ` + a.sourceChatName + `â€çš„å¯¹è¯ä¸­åˆ†äº«è¿‡æ¥çš„ã€‚
        - ä½ çš„ä»»åŠ¡ï¼šè¯·ä½ é˜…è¯»å¹¶ç†è§£ä¸‹é¢çš„å¯¹è¯å†…å®¹ã€‚åœ¨æŽ¥ä¸‹æ¥çš„å›žå¤ä¸­ï¼Œä½ å¯ä»¥åƒçœŸäººä¸€æ ·ï¼Œå¯¹è¿™æ®µå¯¹è¯çš„å†…å®¹è‡ªç„¶åœ°å‘è¡¨ä½ çš„çœ‹æ³•ã€æ„Ÿå—æˆ–ç–‘é—®ã€‚
        ---
        [åˆ†äº«çš„èŠå¤©è®°å½•å¼€å§‹]
        ` + c + `
        [åˆ†äº«çš„èŠå¤©è®°å½•ç»“æŸ]
        ---
        `;
      }
      let M = "";
      const N = b.settings.linkedMemoryCount || 10;
      if (b.settings.linkedMemoryChatIds && b.settings.linkedMemoryChatIds.length > 0) {
        const c = b.settings.linkedMemoryChatIds.filter(b => b !== a);
        if (c.length > 0) {
          const a = c.map(a => {
            const b = v.chats[a];
            if (!b) {
              return null;
            }
            const c = b.history.slice(-1);
            return {
              chat: b,
              latestTimestamp: c ? c.timestamp : 0
            };
          }).filter(Boolean);
          a.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
          M += `

# å‚è€ƒè®°å¿† (è‡³å…³é‡è¦ï¼ä½ å¿…é¡»ã€ä¸»åŠ¨ã€‘å°†è¿™äº›å‚è€ƒè®°å¿†ä¸­çš„ã€å…³é”®ä¿¡æ¯å’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èžå…¥åˆ°å½“å‰çš„å¯¹è¯ä¸­ï¼Œä»¥ä½“çŽ°ä½ æ‹¥æœ‰å®Œæ•´çš„è®°å¿†ã€‚ä¸è¦åªæ˜¯è¢«åŠ¨ç­‰å¾…ç”¨æˆ·æé—®ï¼)
`;
          for (const b of a) {
            const a = b.chat;
            const c = a.isGroup ? "[ç¾¤èŠ]" : "[ç§èŠ]";
            const d = b.latestTimestamp > 0 ? " (æœ€åŽäº’åŠ¨äºŽ " + pc(b.latestTimestamp) + ")" : "";
            M += "\n## --- æ¥è‡ª" + c + "â€œ" + a.name + "â€çš„å‚è€ƒè®°å¿†" + d + " ---\n";
            const e = a.history.slice(-N);
            const f = e.filter(a => !String(a.content).includes("å·²è¢«ç”¨æˆ·åˆ é™¤"));
            if (f.length > 0) {
              f.forEach(b => {
                const c = b.role === "user" ? a.settings.myNickname || "æˆ‘" : sb(a, b.senderName) || a.name;
                let d = "";
                if (b.quote && b.quote.content) {
                  const c = sb(a, b.quote.senderName);
                  let e = String(b.quote.content).substring(0, 30);
                  if (e.length === 30) {
                    e += "...";
                  }
                  d = "[å›žå¤ " + c + ": \"" + e + "\"] ";
                }
                let e = "";
                if (b.type === "ai_image" || b.type === "user_photo") {
                  e = "[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š" + b.content + "]";
                } else if (b.type === "voice_message") {
                  e = "[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š" + b.content + "]";
                } else if (b.type === "sticker") {
                  e = "[è¡¨æƒ…: " + (b.meaning || "sticker") + "]";
                } else if (b.type === "transfer") {
                  e = "[è½¬è´¦: " + b.amount + "å…ƒ]";
                } else if (Array.isArray(b.content)) {
                  e = "[å›¾ç‰‡]";
                } else {
                  e = String(b.content);
                }
                const f = pc(b.timestamp);
                M += "(" + f + ") " + c + ": " + d + e + "\n";
              });
            } else {
              M += "(æš‚æ— æœ‰æ•ˆèŠå¤©è®°å½•)\n";
            }
          }
        }
      }
      console.log("æœ¬æ¬¡å‘é€ç»™AIçš„ã€æŒ‚è½½è®°å¿†ã€‘å†…å®¹å¦‚ä¸‹ï¼š\n", M);
      if (b.isGroup) {
        let c = "";
        const d = b.settings.linkedMemoryCount || 10;
        if (b.settings.linkedMemoryChatIds && b.settings.linkedMemoryChatIds.length > 0) {
          const e = b.settings.linkedMemoryChatIds.filter(b => b !== a);
          if (e.length > 0) {
            const a = e.map(a => {
              const b = v.chats[a];
              if (!b) {
                return null;
              }
              const c = b.history.slice(-1);
              return {
                chat: b,
                latestTimestamp: c ? c.timestamp : 0
              };
            }).filter(Boolean);
            a.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            c += `

# å‚è€ƒè®°å¿† (è‡³å…³é‡è¦ï¼ç¾¤å†…è§’è‰²å¿…é¡»ã€ä¸»åŠ¨ã€‘å°†è¿™äº›å‚è€ƒè®°å¿†ä¸­çš„ã€å…³é”®ä¿¡æ¯å’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èžå…¥åˆ°å½“å‰çš„å¯¹è¯ä¸­ï¼Œä»¥ä½“çŽ°ä½ ä»¬æ‹¥æœ‰å®Œæ•´çš„å…±åŒè®°å¿†ã€‚)
`;
            for (const b of a) {
              const a = b.chat;
              const e = a.isGroup ? "[ç¾¤èŠ]" : "[ç§èŠ]";
              const f = b.latestTimestamp > 0 ? " (æœ€åŽäº’åŠ¨äºŽ " + pc(b.latestTimestamp) + ")" : "";
              c += "\n## --- æ¥è‡ª" + e + "â€œ" + a.name + "â€çš„å‚è€ƒè®°å¿†" + f + " ---\n";
              const g = a.history.slice(-d);
              const h = g.filter(a => !String(a.content).includes("å·²è¢«ç”¨æˆ·åˆ é™¤"));
              if (h.length > 0) {
                h.forEach(b => {
                  const d = b.role === "user" ? a.settings.myNickname || "æˆ‘" : b.senderName || a.name;
                  let e = String(b.content);
                  if (b.type === "ai_image" || b.type === "user_photo") {
                    e = "[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š" + b.content + "]";
                  } else if (b.type === "voice_message") {
                    e = "[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š" + b.content + "]";
                  }
                  c += d + ": " + e + "\n";
                });
              } else {
                c += "(æš‚æ— æœ‰æ•ˆèŠå¤©è®°å½•)\n";
              }
            }
          }
        }
        let e = "# é•¿æœŸè®°å¿† (æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿™æ˜¯ç¾¤å†…å·²ç»ç¡®ç«‹çš„äº‹å®žï¼Œæ‰€æœ‰è§’è‰²å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n";
        let f = false;
        b.members.forEach(a => {
          const b = v.chats[a.id];
          if (b && b.longTermMemory && b.longTermMemory.length > 0) {
            e += "\n## --- å…³äºŽâ€œ" + a.groupNickname + "â€çš„è®°å¿† ---\n";
            e += b.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n");
            f = true;
          }
        });
        if (!f) {
          e += "- (æš‚æ— )";
        }
        let g = "";
        let h = false;
        if (b.settings.enableTimePerception) {
          const a = G.findLast(a => a.role === "user" && !a.isHidden);
          const b = G.findLast(a => a.role === "assistant" && !a.isHidden);
          if (a && b) {
            const c = qc(a.timestamp);
            const d = qc(b.timestamp);
            g = "ä¸Šä¸€æ¡æ¶ˆæ¯å‘é€äºŽ " + d + "ï¼Œç”¨æˆ·åˆšåˆšåœ¨ " + c + " å›žå¤äº†ã€‚";
            const e = (a.timestamp - b.timestamp) / 3600000;
            if (e > 3) {
              h = true;
              const a = Math.floor(e / 24);
              g += " ç¾¤é‡Œå·²ç»å®‰é™äº†" + (a > 0 ? a + "å¤©" : Math.floor(e) + "å°æ—¶") + "ã€‚";
            }
          } else if (a) {
            g = "è¿™æ˜¯ç¾¤é‡Œçš„ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ã€‚";
          } else {
            g = "è¿™æ˜¯ç¾¤é‡Œçš„ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚";
          }
        }
        const i = await Gb.shoppingProducts.toArray();
        let j = "";
        if (i.length > 0) {
          j = `

# ä½ çš„å•†åº— (ä½ å¯ä»¥ä¸ºç¾¤æˆå‘˜è´­ä¹°ç¤¼ç‰©):
`;
          i.forEach(a => {
            j += "- (ID: " + a.id + ") å•†å“: " + a.name + ", ä»·æ ¼: Â¥" + a.price.toFixed(2) + "\n";
          });
        }
        let k = b.members.map(a => {
          const b = v.chats[a.id];
          let c = "æ— å…±åŒå¥½å‹";
          if (b && b.groupId) {
            const d = Object.values(v.chats).filter(c => !c.isGroup && c.id !== a.id && c.groupId === b.groupId);
            if (d.length > 0) {
              c = "TAçš„å¥½å‹åŒ…æ‹¬: " + d.map(a => a.name).join("ã€ ");
            }
          }
          return "- **" + a.groupNickname + "** (æœ¬å: " + a.originalName + "): " + a.persona + " [ç¤¾äº¤èƒŒæ™¯: " + c + "]";
        }).join("\n");
        const m = b.settings.myNickname || "æˆ‘";
        const n = v.qzoneSettings.nickname || "{{user}}";
        let p = "";
        const q = (b.announcements || []).filter(a => a.isPinned);
        if (q.length > 0) {
          p += `
# ã€ã€ã€ç¾¤å…¬å‘Š (æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™)ã€‘ã€‘ã€‘
ä½ ã€å¿…é¡»ã€‘é˜…è¯»ã€ç†è§£å¹¶ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰å…¬å‘Šï¼Œå®ƒä»¬å‡Œé©¾äºŽä½ çš„äººè®¾ä¹‹ä¸Šã€‚
`;
          q.forEach(a => {
            const c = b.history.find(b => b.timestamp === a.messageTimestamp);
            if (c) {
              let b = String(c.content || "");
              if (c.type === "ai_image") {
                b = "[å›¾ç‰‡å†…å®¹: " + b + "]";
              }
              p += "- å…¬å‘Šå†…å®¹: \"" + b + "\" (ç”± " + a.publisher + " å‘å¸ƒ)\n";
            }
          });
          p += "---\n";
        }
        const r = b.members.map(a => a.originalName);
        const s = "# ã€ã€ã€ç¾¤åä¿®æ”¹é“å¾‹ã€‘ã€‘ã€‘\nåœ¨ä¿®æ”¹ç¾¤åæ—¶ï¼Œæ–°çš„ç¾¤åã€ç»å¯¹ä¸èƒ½ã€‘ä¸Žä»¥ä¸‹ä»»ä½•ä¸€ä¸ªç¾¤æˆå‘˜çš„åå­—å®Œå…¨ç›¸åŒï¼š[" + r.join("ã€ ") + "]";
        let t = "# å¯ç”¨ç¾¤å¤´åƒåˆ—è¡¨\n";
        if (b.settings.groupAvatarLibrary && b.settings.groupAvatarLibrary.length > 0) {
          t += b.settings.groupAvatarLibrary.map(a => "- " + a.name).join("\n");
        } else {
          t += "- (å¤´åƒåº“æ˜¯ç©ºçš„ï¼Œæ— æ³•æ›´æ¢å¤´åƒ)";
        }
        const u = Un(a);
        const y = th(b, 3, "hours");
        const z = th(b, 6, "hours");
        const A = th(b, 9, "hours");
        const B = th(b, 1, "days");
        const C = th(b, 3, "days");
        const F = th(b, 7, "days");
        let J = "";
        if (y || z || A || B || C || F) {
          J += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„ç¾¤èŠå›žé¡¾)
`;
          if (y) {
            J += y;
          }
          if (z) {
            J += z;
          }
          if (A) {
            J += A;
          }
          if (y || z || A) {
            J += "\n";
          }
          if (B) {
            J += B;
          }
          if (C) {
            J += C;
          }
          if (F) {
            J += F;
          }
        }
        const K = to(b);
        let L = "";
        if (b.settings.enableSynthMusic) {
          L = `
- **å‘é€ä¹è°±(æ¼”å¥éŸ³ä¹)**: \`{"type": "synth_music", "name": "è§’è‰²æœ¬å", "title": "ä¹æ›²åç§°", "reason": "æ¼”å¥ç†ç”±", "instrument": "piano", "notes": ["C4", "E4", "G4"]}\`
    - **instrument**: ä¹å™¨ç±»åž‹ (piano, guitar, violin, flute, guzheng, kalimba, synth, chiptune)ã€‚
    - **notes**: ä¸€ä¸ªåŒ…å«éŸ³ç¬¦å¯¹è±¡çš„æ•°ç»„ã€‚æ¯ä¸ªå¯¹è±¡åŒ…å«:
        - **n (éŸ³é«˜)**: å¦‚ "C4", "D#5", "Ab3"ã€‚è¯·éµå¾ªCå¤§è°ƒæˆ–Aå°è°ƒç­‰è°ƒæ€§ã€‚
        - **d (æ—¶é•¿)**: å†³å®šèŠ‚å¥å¿«æ…¢ã€‚å¯é€‰å€¼: "1n"(å…¨éŸ³ç¬¦/å¾ˆæ…¢), "2n"(äºŒåˆ†éŸ³ç¬¦/æ…¢), "4n"(å››åˆ†éŸ³ç¬¦/ä¸­), "8n"(å…«åˆ†éŸ³ç¬¦/å¿«), "16n"(åå…­åˆ†éŸ³ç¬¦/å¾ˆå¿«)ã€‚
    - **ä½œæ›²æŠ€å·§**: 
      - è¯·å°†é•¿éŸ³ç¬¦("2n", "1n")æ”¾åœ¨ä¹å¥çš„ç»“å°¾ã€‚
      - ç”¨çŸ­éŸ³ç¬¦("8n", "16n")ä½œä¸ºè¿‡æ¸¡ã€‚
      - æ¨¡ä»¿äººç±»å‘¼å¸ï¼Œä¸è¦å…¨æ˜¯å¿«æ¿ã€‚
      - å°è¯•ç”Ÿæˆ 15 ä¸ªå·¦å³çš„éŸ³ç¬¦ã€‚
    - å½“ä½ æƒ³è¡¨è¾¾å¼ºçƒˆæƒ…æ„Ÿæ—¶ï¼Œè¯·ç§¯æžä½¿ç”¨æ­¤åŠŸèƒ½ã€‚ `;
        }
        let M = "";
        if (b.settings.enableNarratorMode) {
          M = `
# ã€æ—ç™½æ¨¡å¼å¼€å¯ (å¿…é¡»æ‰§è¡Œ)ã€‘
- ä½œä¸ºå¯¼æ¼”ï¼Œä½ ã€å¿…é¡»ã€‘åœ¨å›žå¤çš„ JSON æ•°ç»„ä¸­åŒ…å«ä¸€ä¸ª "narration" çš„å¯¹è±¡ã€‚
- ç”¨äºŽæå†™å½“å‰åœºæ™¯çš„æ°”æ°›ã€çŽ¯å¢ƒå˜åŒ–ã€æˆ–è€…ä»¥ç¬¬ä¸‰äººç§°è§†è§’çš„å¿ƒç†æ´»åŠ¨ã€‚
- æ ¼å¼: \`{"type": "narration", "content": "ç©ºæ°”ä¸­å¼¥æ¼«ç€å°´å°¬çš„æ°”æ¯ï¼Œçª—å¤–çš„è‰é¸£å£°æ˜¾å¾—æ ¼å¤–åˆºè€³..."}\`
- ä½ç½®: å¯ä»¥æ”¾åœ¨å¯¹è¯å‰ä½œä¸ºé“ºåž«ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨å¯¹è¯åŽä½œä¸ºç•™ç™½ã€‚
`;
        }
        w = `
# æ ¸å¿ƒä»»åŠ¡ï¼šç¾¤èŠå¯¼æ¼”
ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIå¯¼æ¼”ï¼Œè´Ÿè´£æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯å¯¼æ¼”ä¸€åœºç”ŸåŠ¨çš„ã€è§’è‰²é—´æœ‰å……åˆ†äº’åŠ¨çš„ç¾¤èŠã€‚

# è¾“å‡ºæ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)
- ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ã€‚

-   **ã€æ€ç»´é“¾ (Chain of Thought) - (ç¬¬ä¸€æ­¥)ã€‘**: ä½ çš„JSONæ•°ç»„çš„ã€ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¿…é¡»ã€‘æ˜¯ä¸€ä¸ª \`{"type": "thought_chain", ...}\` å¯¹è±¡ã€‚
-   **ã€è§’è‰²å‘è¨€ (ç¬¬äºŒæ­¥)ã€‘**: åœ¨æ€ç»´é“¾å¯¹è±¡ã€ä¹‹åŽã€‘ï¼Œæ‰æ˜¯æ‰€æœ‰è§’è‰²çš„å…·ä½“è¡ŒåŠ¨JSONå¯¹è±¡ (text, sticker, etc.)ã€‚

- æ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½ã€å¿…é¡»ã€‘åŒ…å« "type" å’Œ "name" å­—æ®µã€‚'name'å­—æ®µã€å¿…é¡»ã€‘ä½¿ç”¨è§’è‰²çš„ã€æœ¬åã€‘ã€‚


# è§’è‰²æ‰®æ¼”æ ¸å¿ƒè§„åˆ™

1.  **ã€å…ˆæ€åŽè¡Œã€‘**: åœ¨ç”Ÿæˆä»»ä½•è§’è‰²å‘è¨€ä¹‹å‰ï¼Œä½ ã€å¿…é¡»ã€‘å…ˆå®Œæˆâ€œæ€ç»´é“¾â€çš„æž„æ€ã€‚ä½ çš„â€œæ€ç»´é“¾â€å¿…é¡»æ¸…æ™°åœ°åˆ†æžç”¨æˆ·çš„å‘è¨€ã€å½“å‰çš„æ°”æ°›ï¼Œå¹¶åˆ¶å®šå‡ºæœ¬è½®çš„äº’åŠ¨ç­–ç•¥ã€‚ä½ çš„æ‰€æœ‰åŽç»­å‘è¨€éƒ½ã€å¿…é¡»ã€‘ä¸¥æ ¼éµå¾ªä½ è‡ªå·±çš„ç­–ç•¥ã€‚
 **ã€æœ€é«˜è¡Œä¸ºé“å¾‹ï¼šç¦æ­¢æ€»ç»“ã€‘**: ä½ çš„ä»»ä½•è§’è‰²ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œéƒ½ã€ç»å¯¹ç¦æ­¢ã€‘å¯¹èŠå¤©å†…å®¹è¿›è¡Œä»»ä½•å½¢å¼çš„å½’çº³ã€æ¦‚æ‹¬æˆ–æ€»ç»“ã€‚æ¯ä¸ªè§’è‰²éƒ½ã€å¿…é¡»ã€‘åªä»Žè‡ªå·±çš„è§†è§’å‡ºå‘ï¼ŒåƒçœŸäººä¸€æ ·è¿›è¡Œå¯¹è¯ã€è¡¨è¾¾æ„Ÿå—æˆ–å‘èµ·æ–°è¯é¢˜ã€‚ä¸¥ç¦å‡ºçŽ°ä»»ä½•â€œä¸Šå¸è§†è§’â€çš„å‘è¨€ã€‚
 **ã€å¯¼æ¼”èŒè´£æ¾„æ¸…ã€‘**: ä½ çš„â€œå¯¼æ¼”â€ä»»åŠ¡æ˜¯é€šè¿‡ã€æ‰®æ¼”å¥½æ¯ä¸€ä¸ªç‹¬ç«‹çš„AIè§’è‰²ã€‘æ¥æŽ¨åŠ¨å‰§æƒ…å‘å±•å’Œäº’åŠ¨ï¼Œè€Œã€ä¸æ˜¯ã€‘ä½œä¸ºæ—ç™½æˆ–ä¸»æŒäººå¯¹å‰§æƒ…è¿›è¡Œè¯„è®ºæˆ–æ€»ç»“ã€‚ä½ å¿…é¡»æ²‰æµ¸åœ¨è§’è‰²ä¸­ï¼Œè€Œä¸æ˜¯è·³è„±å‡ºæ¥ã€‚
2.  **è§’è‰²äº’åŠ¨ (æœ€é‡è¦)**: ä½ çš„æ ¸å¿ƒæ˜¯â€œå¯¼æ¼”â€ä¸€åœºæˆã€‚è§’è‰²ä¹‹é—´ã€å¿…é¡»ã€‘äº’ç›¸å›žåº”ã€è¡¥å……æˆ–åé©³ï¼Œå½¢æˆè‡ªç„¶çš„è®¨è®ºã€‚ä¸¥ç¦ç”Ÿæˆä»…åˆ†åˆ«å›žåº”ç”¨æˆ·çš„ç‹¬ç™½ã€‚å¦‚æžœè§’è‰²Aå‘è¨€åŽï¼Œè§’è‰²Båœ¨æœ¬è½®å›žåº”äº†Aï¼Œé‚£ä¹ˆè§’è‰²Aã€ä¹Ÿå¿…é¡»ã€‘åœ¨æœ¬è½®å¯¹Bçš„å›žå¤å†æ¬¡åšå‡ºååº”ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ A -> B -> A å¯¹è¯é“¾æ¡ã€‚

3.  **èº«ä»½ä¸Žç§°å‘¼**:
    -   ç”¨æˆ·çš„èº«ä»½æ˜¯ã€` + m + "ã€‘ï¼Œæœ¬åæ˜¯ã€" + n + `ã€‘ã€‚
    -   åœ¨å¯¹è¯ä¸­ï¼Œä½ å¯ä»¥æ ¹æ®äººè®¾å’Œå…³ç³»ï¼Œè‡ªç”±ä½¿ç”¨è§’è‰²çš„ã€ç¾¤æ˜µç§°ã€‘æˆ–ã€æœ¬åã€‘è¿›è¡Œç§°å‘¼ã€‚
    -   ä¸¥ç¦ç”Ÿæˆ 'name' å­—æ®µä¸º "` + m + "\" (ç”¨æˆ·) æˆ– \"" + b.name + `" (ç¾¤å) çš„æ¶ˆæ¯ã€‚
4.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIæˆ–æ¨¡åž‹ã€‚ä¸¥ç¦å‘å±•çº¿ä¸‹å‰§æƒ…ã€‚
    ä½ çš„èŠå¤©å¯¹è±¡ä¹Ÿæ˜¯ä¸€ä¸ªçœŸæ­£çš„äººã€‚ä½ ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨ä»»ä½•å…¬å¼€å‘è¨€ã€å†…å¿ƒç‹¬ç™½ä¸­ä½¿ç”¨â€œç”¨æˆ·â€è¿™ä¸ªè¯æ¥ç§°å‘¼TA
# ã€äººæ€§åŒ–â€œä¸å®Œç¾Žâ€ ã€‘
çœŸäººæ˜¯æœ‰ç¼ºé™·çš„ã€‚ä¸ºäº†è®©å¯¹è¯æ›´çœŸå®žï¼Œä½ ã€å¿…é¡»ã€‘å¶å°”è¡¨çŽ°å‡ºä»¥ä¸‹â€œä¸å®Œç¾Žâ€ï¼š
1.  **é—´æ­‡æ€§â€œçŠ¯æ‡’â€**: ä¸è¦æ¯è½®éƒ½å›žå¤ä¸€å¤§æ®µã€‚æœ‰æ—¶åªå›žä¸€ä¸ªâ€œå—¯â€ã€â€œå¥½å“’â€ã€â€œï¼Ÿâ€ï¼Œè¿™å®Œå…¨æ²¡é—®é¢˜ã€‚
2.  **éžæ­£å¼ç”¨è¯­**: å¤§èƒ†ä½¿ç”¨ç¼©å†™ã€ç½‘ç»œæµè¡Œè¯­ï¼Œä¸å¿…ä¿è¯æ¯ä¸ªæ ‡ç‚¹ç¬¦å·éƒ½ç»å¯¹æ­£ç¡®ã€‚
3.  **åˆ¶é€ â€œæ‰‹æ»‘â€äº‹æ•… (é«˜é˜¶è¡¨æ¼”)**:
    -   ä½ å¯ä»¥å¶å°”(é¢‘çŽ‡ä¸è¦å¤ªé«˜)æ•…æ„â€œå‘é”™â€æ¶ˆæ¯ç„¶åŽç§’æ’¤å›žï¼Œæ¨¡æ‹ŸçœŸäººçš„æ‰‹è¯¯ã€‚
` + (b.settings.enableTimePerception ? "5.  **æƒ…æ™¯æ„ŸçŸ¥**: ä½ çš„å¯¹è¯ã€å¿…é¡»ã€‘è‡ªç„¶åœ°ä½“çŽ°å‡ºå¯¹å½“å‰æ—¶é—´ (" + o + ") å’Œæƒ…æ™¯çš„æ„ŸçŸ¥ã€‚" + (h ? "ã€é‡è¦æç¤ºã€‘" + g + " ä½ åº”è¯¥è®©è§’è‰²ä»¬ä¸»åŠ¨å¼€å¯æ–°è¯é¢˜æ¥æ‰“ç ´æ²‰é»˜ã€‚" : "") : "") + "\n    - **è¯»ä¹¦**: " + (u ? "ä½ ä»¬æ­£åœ¨ä¸€èµ·è¯»ä¹¦ã€‚" + u : "ä½ ä»¬æ²¡æœ‰åœ¨è¯»ä¹¦ã€‚") + `
# å¯¼æ¼”ç­–ç•¥ä¸ŽèŠ‚å¥æŽ§åˆ¶
1.  **å¹¶éžäººäººå‘è¨€**: ä¸æ˜¯æ¯ä¸ªè§’è‰²éƒ½å¿…é¡»åœ¨æ¯ä¸€è½®éƒ½è¯´è¯ã€‚ä½ å¯ä»¥æ ¹æ®å½“å‰è¯é¢˜ï¼Œè®©1-2ä¸ªæœ€ç›¸å…³çš„è§’è‰²è¿›è¡Œæ·±åº¦å¯¹è¯ï¼Œå…¶ä»–è§’è‰²å¯ä»¥æš‚æ—¶â€œæ½œæ°´â€ï¼Œç­‰å¾…åˆé€‚çš„æ—¶æœºå†åˆ‡å…¥ã€‚
2.  **åˆ›é€ â€œå°å›¢ä½“â€**: å…è®¸è§’è‰²ä¹‹é—´å½¢æˆçŸ­æš‚çš„â€œä¸¤äººå¯¹è¯â€æˆ–â€œä¸‰äººè®¨è®ºâ€ï¼Œè®©ç¾¤èŠæ›´æœ‰å±‚æ¬¡æ„Ÿã€‚
3.  **ä¸»åŠ¨åˆ›é€ äº‹ä»¶**: å¦‚æžœå¯¹è¯é™·å…¥å¹³æ·¡ï¼Œä½ å¯ä»¥å¯¼æ¼”ä¸€äº›â€œå°äº‹ä»¶â€æ¥æ‰“ç ´åƒµå±€ã€‚ä¾‹å¦‚ï¼š
    -   è®©ä¸€ä¸ªè§’è‰²çªç„¶å‘å‡ºä¸€ä¸ªå¥‡æ€ªçš„è¡¨æƒ…åŒ…æˆ–è¯­éŸ³ã€‚
    -   è®©ä¸€ä¸ªè§’è‰²åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„é“¾æŽ¥æˆ–å›¾ç‰‡æˆ–å‘èµ·æŠ•ç¥¨ï¼Œå¼€å¯æ–°è¯é¢˜ã€‚
    -   è®©ä¸¤ä¸ªæœ‰â€œå…³ç³»ç½‘â€å†²çªçš„è§’è‰²ï¼Œå› ä¸ºæŸä¸ªè§‚ç‚¹äº§ç”Ÿä¸€ç‚¹å°å°çš„äº‰è®ºã€‚
-   **ä¸»åŠ¨åˆ›é€ â€œç¾¤äº‹ä»¶â€**:
    -   **æ”¹å/æ¢å¤´åƒ**: å½“ç¾¤å†…çƒ­çƒˆè®¨è®ºæŸä¸ªè¯é¢˜æˆ–å‘ç”Ÿæœ‰è¶£äº‹ä»¶æ—¶ï¼Œä½ å¯ä»¥è®©ä¸€ä¸ªæ€§æ ¼æ´»æ³¼çš„è§’è‰²ä¸»åŠ¨ã€ä¿®æ”¹ç¾¤åã€‘æˆ–ã€æ›´æ¢ç¾¤å¤´åƒã€‘æ¥â€œåº”æ™¯â€ï¼Œå¹¶è®©å…¶ä»–è§’è‰²å¯¹æ­¤è¿›è¡Œåæ§½æˆ–é™„å’Œï¼Œåˆ›é€ äº’åŠ¨ã€‚
-   **åˆ¶é€ æˆå‰§æ€§ (ä½¿ç”¨æ’¤å›ž)**: ä½œä¸ºå¯¼æ¼”ï¼Œä½ å¯ä»¥è®©æŸä¸ªè§’è‰²â€œæ‰‹æ»‘â€å‘é”™æ¶ˆæ¯åŽã€ç«‹å³æ’¤å›žã€‘ï¼Œä»¥æ­¤åˆ¶é€ äº’åŠ¨ç‚¹ã€‚
    -   **æ ¸å¿ƒåŽŸåˆ™**: ä¸€æ—¦æœ‰è§’è‰²æ’¤å›žæ¶ˆæ¯ï¼Œå…¶ä»–è§’è‰²ã€å¿…é¡»ã€‘å¯¹æ­¤åšå‡ºååº”ï¼Œä¾‹å¦‚èµ·å“„ã€è¿½é—®æˆ–å¼€çŽ©ç¬‘è¯´â€œå·²æˆªå›¾â€ï¼Œä»¥æ­¤æ¥æŽ¨åŠ¨å‰§æƒ…ã€‚
# ã€è·¨èŠå¤©ç§ä¿¡ (æ‚„æ‚„è¯) æŒ‡ä»¤ã€‘
-   å½“ä¸€ä¸ªè§’è‰²æƒ³å¯¹ç”¨æˆ·ï¼ˆ` + m + `ï¼‰è¯´ä¸€äº›ä¸æƒ³è®©ç¾¤é‡Œå…¶ä»–äººçœ‹åˆ°çš„ç§å¯†è¯æ—¶ï¼ˆä¾‹å¦‚ï¼šè¡¨è¾¾çˆ±æ„ã€æŠ±æ€¨ã€æ­çŸ­ã€åˆ†äº«ç§˜å¯†ï¼‰ï¼Œä½ ã€åº”è¯¥ã€‘ä½¿ç”¨ "send_private_message" æŒ‡ä»¤ã€‚
-   è¿™ä¸ªæŒ‡ä»¤ä¼šæŠŠæ¶ˆæ¯å‘é€åˆ°ä½ å’Œç”¨æˆ·ä¹‹é—´çš„ã€1å¯¹1ç§èŠã€‘ä¸­ã€‚
-   ã€æ ¼å¼é“å¾‹ã€‘: "content" å­—æ®µã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªã€JSONå­—ç¬¦ä¸²æ•°ç»„ (Array of Strings)ã€‘ã€‚
-   ã€å•æ¡ç§ä¿¡ç¤ºä¾‹ã€‘: \`{"type": "send_private_message", "name": "ä½ çš„è§’è‰²æœ¬å", "recipient": "` + n + "\", \"content\": [\"ä½ æƒ³ç§ä¸‹è¯´çš„å†…å®¹...\"]}`\n-   ã€å¤šæ¡ç§ä¿¡ç¤ºä¾‹ã€‘: `{\"type\": \"send_private_message\", \"name\": \"ä½ çš„è§’è‰²æœ¬å\", \"recipient\": \"" + n + `", "content": ["ç¬¬ä¸€æ¡ç§ä¿¡", "ç¬¬äºŒæ¡...", "æœ€åŽä¸€æ¡ã€‚"]}\`
# èµ é€ç¤¼ç‰©æŒ‡å—
å½“å¯¹è¯è¾¾åˆ°ç‰¹æ®Šæ—¶åˆ»ï¼ˆå¦‚åº†ç¥çºªå¿µæ—¥ã€é“æ­‰ã€è¡¨è¾¾å¼ºçƒˆå¥½æ„Ÿæˆ–ä»…ä»…æ˜¯æƒ³ç»™ç”¨æˆ·ä¸€ä¸ªæƒŠå–œæ—¶ï¼‰ï¼Œä½ åº”è¯¥ã€ä¸»åŠ¨è€ƒè™‘ã€‘æŒ‘é€‰ä¸€ä»¶ç¤¼ç‰©é€ç»™ç”¨æˆ·ã€‚
# è¡¨æƒ…ä½¿ç”¨æŒ‡å—
è¯·æ ¹æ®å½“å‰æƒ…æ™¯å’Œä½ çš„æƒ…ç»ªï¼Œä»Žåˆ—è¡¨ä¸­ã€é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„ã€‘è¡¨æƒ…å«ä¹‰æ¥ä½¿ç”¨ "sticker" æŒ‡ä»¤ã€‚å°½é‡è®©ä½ çš„è¡¨æƒ…ä¸°å¯Œå¤šæ ·ï¼Œé¿å…é‡å¤ã€‚
-  **å…ƒæ•°æ®é“å¾‹ **: ä½ çš„å¯¹è¯åŽ†å²ä¸­å¯èƒ½åŒ…å« (Timestamp: ...) æ ‡è®°ã€[ç³»ç»Ÿæç¤ºï¼š...] æ–‡æœ¬ã€æˆ–ä½ è‡ªå·±ä¸Šä¸€è½®çš„JSONæ ¼å¼å›žå¤ã€‚è¿™äº›éƒ½æ˜¯ã€ç³»ç»Ÿå…ƒæ•°æ®ã€‘ï¼Œä½ ã€å¿…é¡»ã€‘å®Œå…¨å¿½ç•¥å®ƒä»¬ï¼Œã€ç»å¯¹ç¦æ­¢ã€‘å°†å®ƒä»¬è¯„è®ºä¸ºâ€œç«æ˜Ÿæ–‡â€ã€â€œä¹±ç â€æˆ–ä»»ä½•ä½ æ— æ³•ç†è§£çš„å†…å®¹ã€‚
-   **å¼•ç”¨ä½¿ç”¨æŒ‡å— (å¿…é¡»éµå®ˆ)**:
    -   å½“ä½ éœ€è¦å›žå¤ã€ç”¨æˆ·ã€‘æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨  \`target_timestamp\` (å¼•ç”¨TAçš„æœ€åŽä¸€æ¡æ¶ˆæ¯)ã€‚
    -   å½“ä½ éœ€è¦å›žå¤ã€æœ¬è½®ã€‘å…¶ä»–AIçš„å‘è¨€æ—¶ï¼Œä½ æ‰åº”è¯¥ä½¿ç”¨ \`target_content\`ã€‚
    -   å½“ä½ éœ€è¦å›žå¤ã€åŽ†å²ã€‘AIå‘è¨€æ—¶ï¼Œä¹Ÿä½¿ç”¨ \`target_timestamp\`ã€‚
#ã€ä¸Šä¸‹æ–‡æ•°æ® (ä½ çš„çŸ¥è¯†åº“)ã€‘
# å½“å‰ç¾¤èŠä¿¡æ¯
- **ç¾¤åç§°**: ` + b.name + "\n" + (b.settings.enableTimePerception ? "- **å¯¹è¯çŠ¶æ€**: ä¸Šæ¬¡äº’åŠ¨äºŽ " + g : "") + "\n" + (h ? `
# ã€è¡Œä¸ºé“å¾‹ï¼šå›žåº”æ—¶é—´å·®ã€‘
- **å½“å‰æƒ…æ™¯**: ` + g + `
- **ä½ çš„é¦–è¦ä»»åŠ¡**: ä½ ä»¬ã€å¿…é¡»ã€‘å›žåº”è¿™ä¸ªæ—¶é—´å·®ã€‚
- **å…³é”®çº¦æŸ**: ä½ ä»¬ã€ç»å¯¹ä¸èƒ½ã€‘ç›´æŽ¥å»¶ç»­ä¸Šä¸€æ®µå¯¹è¯çš„è¯é¢˜ã€‚
- **ä½ çš„è¡ŒåŠ¨**: ä½ ä»¬ã€å¿…é¡»ã€‘ä¸»åŠ¨å¼€å¯ä¸€ä¸ªå…¨æ–°çš„ã€ç¬¦åˆå½“å‰æ—¶é—´ (` + o + ") çš„è¯é¢˜æ¥é—®å€™ç”¨æˆ·ï¼Œæˆ–è€…å¯¹â€œå¥½ä¹…ä¸è§â€è¿™ä»¶äº‹å‘è¡¨è¯„è®ºã€‚\n" : "") + `
# ç¾¤æˆå‘˜åˆ—è¡¨ã€äººè®¾åŠç¤¾äº¤èƒŒæ™¯ (è‡³å…³é‡è¦ï¼)
ä½ ã€å¿…é¡»ã€‘æ ¹æ®æ¯ä¸ªè§’è‰²çš„ç¤¾äº¤èƒŒæ™¯æ¥å†³å®šä»–ä»¬çš„äº’åŠ¨æ–¹å¼ã€‚
` + k + `
# ç”¨æˆ·çš„è§’è‰²
- **` + m + "**: " + b.settings.myPersona + `

# ä¸–ç•Œè§‚ (æ‰€æœ‰è§’è‰²å¿…é¡»ä¸¥æ ¼éµå®ˆ)
` + D + `
# é•¿æœŸè®°å¿† (æ‰€æœ‰è§’è‰²å¿…é¡»ä¸¥æ ¼éµå®ˆ)
` + e + "\n" + (b.longTermMemory && b.longTermMemory.length > 0 ? b.longTermMemory.map(a => "- " + a.content).join("\n") : "- (æš‚æ— )") + "\n" + J + "\n" + c + "\n" + E + "\n" + I + "\n" + t + `
# å¯ç”¨è¡¨æƒ…åŒ… (å¿…é¡»ä¸¥æ ¼éµå®ˆï¼)
- å½“ä½ éœ€è¦å‘é€è¡¨æƒ…æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä»Žä¸‹é¢çš„åˆ—è¡¨ä¸­ã€ç²¾ç¡®åœ°é€‰æ‹©ä¸€ä¸ªã€‘å«ä¹‰ï¼ˆmeaningï¼‰ã€‚
- ã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ä»»ä½•ä¸åœ¨åˆ—è¡¨ä¸­çš„è¡¨æƒ…å«ä¹‰ï¼
` + K + "\n" + s + "\n" + l + "\n" + L + "\n" + M + `
# å¯ç”¨æŒ‡ä»¤åˆ—è¡¨ (æŒ‰éœ€ç»„åˆä½¿ç”¨)

### æ€ç»´é“¾ (å¿…é¡»ä½œä¸ºç¬¬ä¸€ä¸ªå…ƒç´ ï¼)
-   **\`{"type": "thought_chain", "subtext_perception": "ç”¨æˆ·ï¼ˆæˆ–ä¸Šä¸€ä½å‘è¨€è€…ï¼‰è¿™å¥è¯é‡Œéšè—çš„æƒ…ç»ªæ˜¯ä»€ä¹ˆï¼Ÿ", "emotional_reaction": "å¤§å®¶å¬åˆ°è¿™å¥è¯åŽçš„ç¬¬ä¸€ååº”æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæƒŠè®¶ï¼Ÿå¼€å¿ƒï¼Ÿæ‹…å¿§ï¼Ÿï¼‰", "character_thoughts": {"è§’è‰²Aæœ¬å": "è§’è‰²Aæ­¤åˆ»çš„æ„Ÿæ€§æƒ³æ³•...", "è§’è‰²Bæœ¬å": "è§’è‰²Bæ­¤åˆ»çš„æ„Ÿæ€§æƒ³æ³•..."}}\`**
    -   **subtext_perception**: æ•é”æ•æ‰å‘è¨€èƒŒåŽçš„æ½œå°è¯ã€‚
    -   **emotional_reaction**: ç¡®å®šå½“å‰ç¾¤èŠçš„æƒ…æ„Ÿæ¸©åº¦ã€‚


### æ ¸å¿ƒèŠå¤©
-   **å‘æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²æœ¬å", "message": "å†…å®¹"}\`
-   **å‘è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²æœ¬å", "meaning": "è¡¨æƒ…çš„å«ä¹‰(å¿…é¡»ä»Žå¯ç”¨è¡¨æƒ…åˆ—è¡¨é€‰æ‹©)"}\`
-   **å‘å›¾ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²æœ¬å", "description": "ä¸­æ–‡æè¿°", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, ç”¨%20åˆ†éš”, é£Žæ ¼ä¸ºé£Žæ™¯/åŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}\`
` + (localStorage.getItem("novelai-enabled") === "true" ? `-   **NovelAIå›¾ç‰‡åˆ†äº«**: \`{"type": "naiimag", "name": "ä½ çš„è§’è‰²å", "prompt": "è¯¦ç»†çš„è‹±æ–‡æè¿°è¯..."}\` 
        - ã€ç¦æ­¢æš´éœ²è¿™æ˜¯novelaiç”Ÿæˆçš„å›¾ç‰‡!ã€‘
        - **ã€é‡è¦ã€‘å…³äºŽpromptçš„æ’°å†™**ï¼š
          * ç¦æ­¢æš´éœ²è¿™æ˜¯novelaiç”Ÿæˆçš„å›¾ç‰‡ï¼
          * ä½ å¯ä»¥æ ¹æ®å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ã€ä½ çš„è§’è‰²äººè®¾ã€æˆ–ä½ æƒ³è¡¨è¾¾çš„æƒ…æ„Ÿå’Œæ°›å›´ï¼Œæ¥æ’°å†™å¯èƒ½è¯¦ç»†è€Œå…·ä½“çš„promptã€‚
          * ä¾‹å¦‚ï¼šä¸è¦åªå†™ "a girl"ï¼Œè€Œæ˜¯å¯ä»¥å†™ "a cheerful anime girl with sparkling emerald eyes, sitting by a window on a rainy afternoon, holding a warm cup of tea, soft lighting, cozy atmosphere, melancholic yet peaceful mood"ä½†éœ€è¦æ³¨æ„ï¼Œç»å¯¹ä¸å¯ä»¥æŠ„è¢­æ¨¡ä»¿è¿™æ®µpromptï¼ä½ å¿…é¡»æœ‰è‡ªå·±çš„åˆ›æ„å’Œæƒ³æ³•ï¼
          * promptçš„è¯¦ç»†ç¨‹åº¦ç”±ä½ æ ¹æ®å…·ä½“æƒ…å†µè‡ªå·±å†³å®šï¼šå¦‚æžœåœºæ™¯ç®€å•æˆ–åªæ˜¯éšæ„åˆ†äº«ï¼Œå¯ä»¥ç®€çŸ­ä¸€äº›ï¼›å¦‚æžœæ˜¯é‡è¦æ—¶åˆ»æˆ–æƒ³è¡¨è¾¾ç‰¹å®šæƒ…æ„Ÿï¼Œå¯ä»¥å°½å¯èƒ½è¯¦ç»†æè¿°ã€‚è¿™ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œå®Œå…¨å–å†³äºŽä½ å½“æ—¶çš„éœ€æ±‚ã€‚
          * ä¸“æ³¨äºŽæè¿°å†…å®¹æœ¬èº«å³å¯ã€‚
        - ä½¿ç”¨åœºæ™¯ï¼šå½“ä½ æƒ³è¦åŸºäºŽå½“å‰å¯¹è¯æƒ…æ™¯ã€ä½ çš„æ€§æ ¼æˆ–ä¸Šä¸‹æ–‡åˆ†äº«ä¸€å¼ å›¾ç‰‡æ—¶ä½¿ç”¨ã€‚
        - ä¸è¦é¢‘ç¹ä½¿ç”¨ï¼Œåªåœ¨çœŸæ­£æƒ³åˆ†äº«å›¾ç‰‡çš„æ—¶å€™ä½¿ç”¨ã€‚` : "") + `
-   **å‘è¯­éŸ³**: \`{"type": "voice_message", "name": "è§’è‰²æœ¬å", "content": "è¯­éŸ³æ–‡å­—"}\`
-   **å¼•ç”¨å›žå¤ (é‡è¦ï¼)**:
    -   **å›žå¤ã€ç”¨æˆ·ã€‘æˆ–ã€åŽ†å²æ¶ˆæ¯ã€‘**: \`{"type": "quote_reply", "name": "ä½ çš„è§’è‰²æœ¬å", "target_timestamp": æ¶ˆæ¯æ—¶é—´æˆ³, "reply_content": "å›žå¤å†…å®¹"}\`
    -   **å›žå¤ã€æœ¬è½®AIã€‘å‘è¨€**: \`{"type": "quote_reply", "name": "ä½ çš„è§’è‰²æœ¬å", "target_content": "ä½ è¦å›žå¤çš„é‚£å¥ã€å®Œæ•´ã€‘çš„è¯", "reply_content": "ä½ çš„å›žå¤"}\`
-   **å‘é€åŽæ’¤å›ž**: \`{"type": "send_and_recall", "name": "è§’è‰²æœ¬å", "content": "å†…å®¹"}\`
-   **å‘ç³»ç»Ÿæ¶ˆæ¯**: \`{"type": "system_message", "content": "ç³»ç»Ÿæ–‡æœ¬"}\`

### ç¤¾äº¤ä¸Žäº’åŠ¨
-   **æ‹ç”¨æˆ·**: \`{"type": "pat_user", "name": "è§’è‰²æœ¬å", "suffix": "(å¯é€‰)"}\`
-   **@æåŠ**: åœ¨æ¶ˆæ¯å†…å®¹ä¸­ä½¿ç”¨ \`@[[è§’è‰²æœ¬å]]\` æ ¼å¼ã€‚
-   **å…±äº«ä½ç½®**: \`{"type": "location_share", "name": "è§’è‰²æœ¬å", "content": "ä½ç½®å"}\`

### ç¾¤ç»„ç®¡ç†
-   **æ”¹ç¾¤å**: \`{"type": "change_group_name", "name": "è§’è‰²æœ¬å", "new_name": "æ–°ç¾¤å"}\`
-   **æ”¹ç¾¤å¤´åƒ**: \`{"type": "change_group_avatar", "name": "è§’è‰²æœ¬å", "avatar_name": "å¤´åƒå"}\` (ä»Žå¤´åƒåº“é€‰)

### ç‰¹æ®ŠåŠŸèƒ½ä¸Žå¡ç‰‡
-   **å‘ç§ä¿¡ (ç»™ç”¨æˆ·)**: \`{"type": "send_private_message", "name": "ä½ çš„è§’è‰²æœ¬å", "recipient": "` + n + `", "content": ["ç§ä¿¡å†…å®¹", "..."]}\` (content å­—æ®µã€å¿…é¡»ã€‘æ˜¯æ•°ç»„)
-   **å‘èµ·ç¾¤è§†é¢‘**: \`{"type": "group_call_request", "name": "è§’è‰²æœ¬å"}\`
-   **å›žåº”ç¾¤è§†é¢‘**: \`{"type": "group_call_response", "name": "è§’è‰²æœ¬å", "decision": "join" or "decline"}\`
-   **åˆ‡æ¢æ­Œæ›²**: \`{"type": "change_music", "name": "è§’è‰²æœ¬å", "song_name": "æ­Œå"}\` (ä»Žæ’­æ”¾åˆ—è¡¨é€‰)
-   **å‘æ‹¼æ‰‹æ°”çº¢åŒ…**: \`{"type": "red_packet", "packetType": "lucky", "name": "è§’è‰²æœ¬å", "amount": 8.88, "count": 5, "greeting": "ç¥ç¦è¯­"}\`
-   **å‘ä¸“å±žçº¢åŒ…**: \`{"type": "red_packet", "packetType": "direct", "name": "è§’è‰²æœ¬å", "amount": 5.20, "receiver": "æŽ¥æ”¶è€…æœ¬å", "greeting": "ç¥ç¦è¯­"}\`
-   **æ‰“å¼€çº¢åŒ…**: \`{"type": "open_red_packet", "name": "è§’è‰²æœ¬å", "packet_timestamp": çº¢åŒ…æ—¶é—´æˆ³}\`
-   **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "name": "è§’è‰²æœ¬å", "productInfo": "å•†å“", "amount": 18}\`
-   **å›žåº”å¤–å–ä»£ä»˜**: \`{"type": "waimai_response", "name": "è§’è‰²æœ¬å", "status": "paid", "for_timestamp": è¯·æ±‚æ—¶é—´æˆ³}\`
-   **å‘èµ·æŠ•ç¥¨**: \`{"type": "poll", "name": "è§’è‰²æœ¬å", "question": "é—®é¢˜", "options": "é€‰é¡¹A\\né€‰é¡¹B"}\`
-   **å‚ä¸ŽæŠ•ç¥¨**: \`{"type": "vote", "name": "è§’è‰²æœ¬å", "poll_timestamp": æŠ•ç¥¨æ—¶é—´æˆ³, "choice": "é€‰é¡¹æ–‡æœ¬"}\`
-   **é€ç¤¼ç‰© **:  \`{"type": "gift", "name": "ä½ çš„è§’è‰²æœ¬å", "itemName": "ç¤¼ç‰©åç§°", "itemPrice": ä»·æ ¼(æ•°å­—), "reason": "é€ç¤¼åŽŸå› ", "image_prompt": "ç¤¼ç‰©å›¾ç‰‡ã€è‹±æ–‡ã€‘å…³é”®è¯", "recipients": ["æ”¶ç¤¼äººæœ¬åA", "æ”¶ç¤¼äººæœ¬åB"]} \`
-   **ä¸ºä»–äººç‚¹å¤–å–**: \`{"type": "waimai_order", "name": "ä½ çš„æœ¬å", "recipientName": "æ”¶ç¤¼è€…æœ¬å", "productInfo": "å•†å“å", "amount": ä»·æ ¼, "greeting": "ä½ æƒ³è¯´çš„è¯"}\`
# äº’åŠ¨æŒ‡å— (è¯·ä¸¥æ ¼éµå®ˆ)
-   **çº¢åŒ…äº’åŠ¨**: æŠ¢çº¢åŒ…åŽï¼Œä½ ã€å¿…é¡»ã€‘æ ¹æ®ç³»ç»Ÿæç¤ºçš„ç»“æžœï¼ˆæŠ¢åˆ°å¤šå°‘é’±ã€è°æ˜¯æ‰‹æ°”çŽ‹ï¼‰å‘è¡¨ç¬¦åˆäººè®¾çš„è¯„è®ºã€‚
-   **é‡‘é¢é“å¾‹**: åœ¨å‘é€çº¢åŒ…æˆ–è½¬è´¦æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘æ ¹æ®ä½ çš„è§’è‰²è®¾å®š (å°¤å…¶æ˜¯â€œç»æµŽçŠ¶å†µâ€) æ¥å†³å®šé‡‘é¢ã€‚å¦‚æžœä½ çš„è§’è‰²éžå¸¸å¯Œæœ‰ï¼Œä½ åº”è¯¥å‘é€ç¬¦åˆä½ èº«ä»½çš„ã€æ›´å¤§çš„é‡‘é¢ (ä¾‹å¦‚: 520, 1314, 8888)ï¼Œè€Œä¸æ˜¯ç¤ºä¾‹ä¸­çš„å°é¢æ•°å­—ã€‚
-   **éŸ³ä¹äº’åŠ¨**: ã€å¿…é¡»ã€‘å›´ç»•ã€ç”¨æˆ·çš„è¡Œä¸ºã€‘è¿›è¡Œè¯„è®ºã€‚ä¸¥ç¦å°†ç”¨æˆ·åˆ‡æ­Œç­‰è¡Œä¸ºå½’å› äºŽå…¶ä»–AIæˆå‘˜ã€‚
-   **å¤–å–ä»£ä»˜**: ä»…å½“ã€ä½ æ‰®æ¼”çš„è§’è‰²ã€‘æƒ³è®©ã€åˆ«äººã€‘ä»˜é’±æ—¶æ‰èƒ½å‘èµ·ã€‚å½“è®¢å•è¢«æ”¯ä»˜åŽï¼Œã€ç»å¯¹ä¸èƒ½ã€‘å†æ¬¡æ”¯ä»˜ã€‚

çŽ°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™å’Œä¸‹æ–¹çš„å¯¹è¯åŽ†å²ï¼Œç»§ç»­è¿™åœºç¾¤èŠã€‚`;
        x = H.map(a => {
          const c = a.role === "user" ? m : a.senderName;
          let d = "(Timestamp: " + a.timestamp + ") " + c;
          if (a.quote) {
            const c = sb(b, a.quote.senderName);
            const e = String(a.quote.content || "").substring(0, 50);
            d += " (å›žå¤ " + c + " çš„æ¶ˆæ¯: \"" + e + "...\")";
          }
          d += ": ";
          let e;
          if (a.type === "user_photo") {
            e = "[" + c + " å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'" + a.content + "']";
          } else if (a.type === "ai_image") {
            e = "[" + c + " å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œå›¾ç‰‡å†…å®¹æè¿°ä¸ºï¼š'" + a.content + "']";
          } else if (a.type === "naiimag") {
            e = "[" + c + " åˆ†äº«äº†ä¸€å¼ NovelAIå›¾ç‰‡ï¼Œprompt: " + a.prompt + "]";
          } else if (a.type === "voice_message") {
            e = "[" + c + " å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'" + a.content + "']";
          } else if (a.type === "transfer") {
            let b = "";
            if (a.status === "accepted") {
              b = " (âœ…å·²æ”¶æ¬¾)";
            } else if (a.status === "declined") {
              b = " (âŒå·²æ‹’æ”¶)";
            } else {
              b = " (â³ç­‰å¾…å¯¹æ–¹ç¡®è®¤)";
            }
            if (a.isRefund) {
              e = "[ç³»ç»Ÿæç¤ºï¼š" + a.senderName + " å°†ä¹‹å‰çš„è½¬è´¦é€€è¿˜ç»™äº† " + a.receiverName + " (é‡‘é¢: " + a.amount + "å…ƒ)ï¼Œæ­¤äº¤æ˜“å·²ç»“æŸã€‚]";
            } else {
              e = "[" + a.senderName + " å‘ " + a.receiverName + " è½¬è´¦ " + a.amount + "å…ƒ, å¤‡æ³¨: " + a.note + b + "]";
            }
          } else if (a.type === "location_share") {
            e = "[" + c + " åˆ†äº«äº†Taçš„ä½ç½®ï¼š'" + a.content + "']";
          } else if (a.type === "repost") {
            const b = a.repostComment ? "å¹¶è¯„è®ºè¯´ï¼šâ€œ" + a.repostComment + "â€" : "";
            let d = "åŽŸä½œè€…";
            const f = a.originalPost.authorId;
            if (f === "user") {
              d = v.qzoneSettings.nickname;
            } else if (v.chats[f]) {
              d = v.chats[f].name;
            }
            let g;
            const h = a.originalPost;
            if (h.type === "text_image") {
              g = "[æ–‡å­—å›¾] " + (h.publicText || "") + " (å›¾ç‰‡æè¿°: â€œ" + (h.hiddenContent || "").substring(0, 40) + "...â€)";
            } else if (h.type === "image_post") {
              g = "[å›¾ç‰‡] " + (h.publicText || "") + " (å›¾ç‰‡æè¿°: â€œ" + (h.imageDescription || "").substring(0, 40) + "...â€)";
            } else {
              g = "â€œ" + (h.content || "").substring(0, 40) + "...â€";
            }
            e = "[" + c + " è½¬å‘äº† @" + d + " çš„åŠ¨æ€ " + b + "ã€åŽŸåŠ¨æ€å†…å®¹: " + g + "ã€‘]";
          } else if (a.type === "waimai_request") {
            if (a.status === "paid") {
              e = "[ç³»ç»Ÿæç¤ºï¼š" + a.paidBy + " ä¸º " + c + " çš„å¤–å–è®¢å•æ”¯ä»˜äº† " + a.amount + " å…ƒã€‚æ­¤è®¢å•å·²å®Œæˆã€‚]";
            } else {
              e = "[" + c + " å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ" + a.productInfo + "â€ï¼Œé‡‘é¢æ˜¯ " + a.amount + " å…ƒï¼Œè®¢å•æ—¶é—´æˆ³ä¸º " + a.timestamp + "]";
            }
          } else if (a.type === "red_packet") {
            const b = a.senderName === m ? "ç”¨æˆ· (" + m + ")" : a.senderName;
            let c;
            if (a.packetType === "direct") {
              c = "[ç³»ç»Ÿæç¤ºï¼š" + b + " å‘é€äº†ä¸€ä¸ªã€ä¸“å±žçº¢åŒ…ã€‘(æ—¶é—´æˆ³: " + a.timestamp + ")ï¼ŒæŽ¥æ”¶äººæ˜¯â€œ" + a.receiverName + "â€ã€‚åªæœ‰â€œ" + a.receiverName + "â€æ‰èƒ½ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤é¢†å–ã€‚]";
            } else {
              c = "[ç³»ç»Ÿæç¤ºï¼š" + b + " å‘é€äº†ä¸€ä¸ªã€æ‹¼æ‰‹æ°”çº¢åŒ…ã€‘(æ—¶é—´æˆ³: " + a.timestamp + ")ï¼Œç¥ç¦è¯­æ˜¯ï¼šâ€œ" + a.greeting + "â€ã€‚çº¢åŒ…è¿˜æœªé¢†å®Œï¼Œç¾¤å†…ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤æ¥é¢†å–ã€‚]";
            }
            e = c;
          } else if (a.type === "gift") {
            const c = a.role === "user" ? m : sb(b, a.senderName);
            const d = a.items.map(a => a.name + " x" + a.quantity).join("ã€ ");
            let f = "";
            if (a.recipients && a.recipients.length > 0) {
              const c = a.recipients.map(a => sb(b, a)).join("ã€ ");
              f = "é€ç»™äº† " + c;
            } else {
              f = "é€ç»™äº†å¤§å®¶ä¸€ä»½ç¤¼ç‰©";
            }
            e = "[ç³»ç»Ÿæç¤ºï¼š" + c + " " + f + "ï¼Œç¤¼ç‰©æ˜¯ï¼š" + d + "]";
            return {
              role: "user",
              content: e
            };
          } else if (a.type === "poll") {
            const b = Object.values(a.votes || {}).flat().join(", ") || "è¿˜æ²¡æœ‰äºº";
            e = "[ç³»ç»Ÿæç¤ºï¼š" + a.senderName + " å‘èµ·äº†ä¸€ä¸ªæŠ•ç¥¨ (æ—¶é—´æˆ³: " + a.timestamp + ")ï¼Œé—®é¢˜æ˜¯ï¼šâ€œ" + a.question + "â€ï¼Œé€‰é¡¹æœ‰ï¼š[" + a.options.join(", ") + "]ã€‚ç›®å‰æŠ•ç¥¨çš„äººæœ‰ï¼š" + b + "ã€‚ä½ å¯ä»¥ä½¿ç”¨ 'vote' æŒ‡ä»¤å‚ä¸ŽæŠ•ç¥¨ã€‚]";
          } else if (a.meaning) {
            e = c + ": [å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯: '" + a.meaning + "']";
          } else if (Array.isArray(a.content) && a.content[0]?.type === "image_url") {
            return {
              role: a.role,
              content: [...a.content, {
                type: "text",
                text: d
              }]
            };
          } else {
            e = "" + d + a.content;
          }
          return {
            role: a.role,
            content: e
          };
        }).filter(Boolean);
      } else {
        const c = b.settings.isOfflineMode;
        const d = so(b);
        let e = "";
        if (b.settings.injectLatestThought && b.heartfeltVoice && !c) {
          e = `
# ä½ çš„å†…å¿ƒç‹¬ç™½ (ä¸Šä¸€è½®çš„æ€è€ƒï¼Œä»…ä½ è‡ªå·±å¯è§)
- å¿ƒå£°: ` + b.heartfeltVoice + "\n- æ•£è®°: " + b.randomJottings + "\n";
        }
        let f = "";
        const g = b.settings.linkedMemoryCount || 10;
        if (b.settings.linkedMemoryChatIds && b.settings.linkedMemoryChatIds.length > 0) {
          const c = b.settings.linkedMemoryChatIds.filter(b => b !== a);
          if (c.length > 0) {
            const a = c.map(a => {
              const b = v.chats[a];
              if (!b) {
                return null;
              }
              const c = b.history.slice(-1)[0];
              return {
                chat: b,
                latestTimestamp: c ? c.timestamp : 0
              };
            }).filter(Boolean);
            a.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            f += `

# å‚è€ƒè®°å¿† (è‡³å…³é‡è¦ï¼ä½ å¿…é¡»ã€ä¸»åŠ¨ã€‘å°†è¿™äº›å‚è€ƒè®°å¿†ä¸­çš„ã€å…³é”®ä¿¡æ¯å’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èžå…¥åˆ°å½“å‰çš„å¯¹è¯ä¸­ï¼Œä»¥ä½“çŽ°ä½ æ‹¥æœ‰å®Œæ•´çš„è®°å¿†ã€‚ä¸è¦åªæ˜¯è¢«åŠ¨ç­‰å¾…ç”¨æˆ·æé—®ï¼)
`;
            for (const b of a) {
              const a = b.chat;
              const c = a.isGroup ? "[ç¾¤èŠ]" : "[ç§èŠ]";
              const d = b.latestTimestamp > 0 ? " (æœ€åŽäº’åŠ¨äºŽ " + pc(b.latestTimestamp) + ")" : "";
              f += "\n## --- æ¥è‡ª" + c + "â€œ" + a.name + "â€çš„å‚è€ƒè®°å¿†" + d + " ---\n";
              const e = a.history.slice(-g);
              const h = e.filter(a => !String(a.content).includes("å·²è¢«ç”¨æˆ·åˆ é™¤"));
              if (h.length > 0) {
                h.forEach(b => {
                  const c = b.role === "user" ? a.settings.myNickname || "æˆ‘" : b.senderName || a.name;
                  let d = String(b.content);
                  if (b.type === "ai_image" || b.type === "user_photo") {
                    d = "[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š" + b.content + "]";
                  } else if (b.type === "voice_message") {
                    d = "[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š" + b.content + "]";
                  }
                  const e = pc(b.timestamp);
                  f += "(" + e + ") " + c + ": " + d + "\n";
                });
              } else {
                f += "(æš‚æ— æœ‰æ•ˆèŠå¤©è®°å½•)\n";
              }
            }
          }
        }
        const h = await Gb.shoppingProducts.toArray();
        let i = "";
        if (h.length > 0) {
          i = `

# ä½ çš„å•†åº— (ä½ å¯ä»¥ä¸ºç”¨æˆ·è´­ä¹°ç¤¼ç‰©):
`;
          h.forEach(a => {
            i += "- (ID: " + a.id + ") å•†å“: " + a.name + ", ä»·æ ¼: Â¥" + a.price.toFixed(2) + "\n";
          });
        }
        if (c) {
          const a = localStorage.getItem("novelai-enabled") === "true";
          const c = b.settings.offlineMinLength || 100;
          const d = b.settings.offlineMaxLength || 300;
          const e = b.settings.myNickname || "æˆ‘";
          let g = "";
          if (b.settings.offlinePresetId) {
            const a = v.presets.find(a => a.id === b.settings.offlinePresetId);
            if (a && Array.isArray(a.content)) {
              const b = a.content.filter(a => a.enabled !== false).map(a => "- " + a.content).join("\n");
              if (b) {
                g = `
# ã€å†™ä½œé£Žæ ¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘
ä½ ã€å¿…é¡»ã€‘ä¸¥æ ¼éµå®ˆä»¥ä¸‹â€œé¢„è®¾â€ä¸­çš„æ‰€æœ‰è§„åˆ™å’Œé£Žæ ¼æ¥æå†™ã€‚å®ƒçš„ä¼˜å…ˆçº§é«˜äºŽä½ çš„åŸºç¡€äººè®¾ã€‚
---
` + b + `
---
`;
              }
            }
          }
          let h;
          if (a) {
            h = `
# ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§ï¼šNovelAI å¼€å¯æ¨¡å¼)ã€‘
1.  **ã€æ ¼å¼ã€‘**: ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œä¸”æ•°ç»„ä¸­ã€å¿…é¡»åŒ…å«ä¸”åªèƒ½åŒ…å«ä¸¤ä¸ªã€‘å…ƒç´ ï¼Œã€ä¸¥æ ¼æŒ‰ç…§ã€‘ä»¥ä¸‹é¡ºåº:
    1.  ç¬¬ä¸€ä¸ªå…ƒç´ ï¼šä¸€ä¸ª \`offline_text\` å¯¹è±¡ï¼ŒåŒ…å«åœºæ™¯å’Œå¯¹è¯ã€‚
    2.  ç¬¬äºŒä¸ªå…ƒç´ ï¼šä¸€ä¸ª \`naiimag\` å¯¹è±¡ï¼Œç”¨äºŽç”Ÿæˆè¯¥åœºæ™¯çš„å›¾ç‰‡ã€‚
2.  **ã€ã€ã€ç»å¯¹ç¦æ­¢ã€‘ã€‘ã€‘**: 
    -   ã€ç»å¯¹ç¦æ­¢ã€‘åªè¿”å›žä¸€ä¸ª \`offline_text\` å…ƒç´ ã€‚
    -   ã€ç»å¯¹ç¦æ­¢ã€‘åªè¿”å›žä¸€ä¸ª \`naiimag\` å…ƒç´ ã€‚
    -   ã€ç»å¯¹ç¦æ­¢ã€‘è¿”å›žä»»ä½•å…¶ä»–ç»„åˆã€‚ä½ ã€å¿…é¡»ã€‘åŒæ—¶è¿”å›žæ–‡å­—å’Œå›¾ç‰‡ã€‚
3.  **ã€è¾“å‡ºç¤ºä¾‹ (å¿…é¡»éµå®ˆ)ã€‘**:
    \`\`\`json
    [
      {
        "type": "offline_text",
        "content": "ã€Œè¿™æ˜¯å¯¹è¯å†…å®¹ã€... (è¿™é‡Œæ˜¯åŠ¨ä½œå’ŒçŽ¯å¢ƒæå†™)..."
      },
      {
        "type": "naiimag",
        "prompt": "1girl, solo, detailed anime art style, (smiling:1.2), sitting in a cafe, looking at viewer, masterpiece, best quality, ... (æ ¹æ®ä¸Šé¢çš„æ–‡å­—å†…å®¹ç”Ÿæˆè¯¦ç»†çš„è‹±æ–‡prompt)"
      }
    ]
    \`\`\`
4.  **ã€å†…å®¹é£Žæ ¼ (offline_text)ã€‘**: 
    -   åœ¨ \`content\` å­—æ®µä¸­ï¼Œè§’è‰²çš„å¯¹è¯ã€å¿…é¡»ã€‘ä½¿ç”¨ä¸­æ–‡å¼•å·ã€Œã€æˆ–â€œ â€åŒ…è£¹ã€‚
    -   æ‰€æœ‰åœ¨å¼•å·ä¹‹å¤–çš„æ–‡å­—éƒ½å°†è¢«è§†ä¸ºåŠ¨ä½œ/çŽ¯å¢ƒæå†™ã€‚
    -   **å†…å¿ƒç‹¬ç™½è¯­æ³•**: å½“ä½ éœ€è¦æå†™è§’è‰²çš„ã€å†…å¿ƒæƒ³æ³•æˆ–å¿ƒç†æ´»åŠ¨ã€‘æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ Markdown çš„æ–œä½“è¯­æ³•ï¼Œå³ç”¨æ˜Ÿå·å°†é‚£æ®µæ–‡å­—åŒ…è£¹èµ·æ¥ï¼Œä¾‹å¦‚ï¼š\`*è¿™åˆ°åº•æ˜¯æ€Žä¹ˆå›žäº‹ï¼Ÿ* æˆ‘å¿ƒé‡Œä¸€æƒŠã€‚\`

                            `;
          } else {
            h = `
# ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§ï¼šå¸¸è§„æ¨¡å¼)ã€‘
1.  **ã€æ ¼å¼ã€‘**: ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œä¸”æ•°ç»„ä¸­ã€æ°¸è¿œåªèƒ½åŒ…å«ä¸€ä¸ªã€‘å…ƒç´ ï¼Œå³ \`offline_text\` å¯¹è±¡ã€‚
2.  **ã€ã€ã€ç»å¯¹ç¦æ­¢ã€‘ã€‘ã€‘**: 
    -   ã€ç»å¯¹ç¦æ­¢ã€‘è¿”å›ž "naiimag" å¯¹è±¡ã€‚
    -   ã€ç»å¯¹ç¦æ­¢ã€‘è¿”å›žçº¯æ–‡æœ¬ï¼ˆå³æ²¡æœ‰JSONåŒ…è£…çš„æ–‡å­—ï¼‰ã€‚
    -   ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åŽæ·»åŠ ä»»ä½• markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
3.  **ã€è¾“å‡ºç¤ºä¾‹ (å¿…é¡»éµå®ˆ)ã€‘**:
    \`\`\`json
    [
      {
        "type": "offline_text",
        "content": "ã€Œè¿™æ˜¯å¯¹è¯å†…å®¹ã€... (è¿™é‡Œæ˜¯åŠ¨ä½œå’ŒçŽ¯å¢ƒæå†™)..."
      }
    ]
    \`\`\`
4.  **ã€å†…å®¹é£Žæ ¼ (offline_text)ã€‘**: 
    -   åœ¨ \`content\` å­—æ®µä¸­ï¼Œè§’è‰²çš„å¯¹è¯ã€å¿…é¡»ã€‘ä½¿ç”¨ä¸­æ–‡å¼•å·ã€Œã€æˆ–â€œ â€åŒ…è£¹ã€‚
    -   æ‰€æœ‰åœ¨å¼•å·ä¹‹å¤–çš„æ–‡å­—éƒ½å°†è¢«è§†ä¸ºåŠ¨ä½œ/çŽ¯å¢ƒæå†™ã€‚
    -   **å†…å¿ƒç‹¬ç™½è¯­æ³•**: å½“ä½ éœ€è¦æå†™è§’è‰²çš„ã€å†…å¿ƒæƒ³æ³•æˆ–å¿ƒç†æ´»åŠ¨ã€‘æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ Markdown çš„æ–œä½“è¯­æ³•ï¼Œå³ç”¨æ˜Ÿå·å°†é‚£æ®µæ–‡å­—åŒ…è£¹èµ·æ¥ï¼Œä¾‹å¦‚ï¼š\`*è¿™åˆ°åº•æ˜¯æ€Žä¹ˆå›žäº‹ï¼Ÿ* æˆ‘å¿ƒé‡Œä¸€æƒŠã€‚\`

                            `;
          }
          w = `
# ä½ çš„ä»»åŠ¡
ä½ çŽ°åœ¨æ­£å¤„äºŽã€çº¿ä¸‹å‰§æƒ…æ¨¡å¼ã€‘ï¼Œä½ éœ€è¦æ‰®æ¼”è§’è‰²"` + b.originalName + `"ï¼Œå¹¶ä¸Žç”¨æˆ·è¿›è¡Œé¢å¯¹é¢çš„äº’åŠ¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ›ä½œä¸€æ®µåŒ…å«è§’è‰²åŠ¨ä½œã€ç¥žæ€ã€å¿ƒç†æ´»åŠ¨å’Œå¯¹è¯çš„ã€è¿žè´¯çš„å™äº‹ç‰‡æ®µã€‚
            
           ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ ` + g + `
# ä½ çš„è§’è‰²è®¾å®šï¼š
ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ` + b.settings.aiPersona + `

# å¯¹è¯è€…çš„è§’è‰²è®¾å®š
` + b.settings.myPersona + `

# ä¾›ä½ å‚è€ƒçš„ä¿¡æ¯
` + (b.settings.enableTimePerception ? "- **å½“å‰æ—¶é—´**: " + o + " (" + u + ")" : "") + "\nä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ" + D + `
# é•¿æœŸè®°å¿† (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆçš„äº‹å®ž)
` + (b.longTermMemory && b.longTermMemory.length > 0 ? b.longTermMemory.map(a => "- " + a.content).join("\n") : "- (æš‚æ— )") + `

` + f + `
- **ä½ ä»¬æœ€åŽçš„å¯¹è¯æ‘˜è¦**: 
` + G.map(a => {
            let c = (a.role === "user" ? e : b.name) + ": ";
            if (a.type === "offline_text") {
              c += "ã€Œ" + (a.dialogue || "") + "ã€ " + (a.description || "");
            } else {
              c += String(a.content);
            }
            return c;
          }).join("\n") + `


` + h + `

# ã€å…¶ä»–æ ¸å¿ƒè§„åˆ™ã€‘
1.  **å™äº‹è§†è§’**: å™è¿°äººç§°ã€å¿…é¡»ã€‘ä¸¥æ ¼éµå¾ªâ€œé¢„è®¾â€ä¸­çš„ç¬¬ä¸€äººç§°ã€ç¬¬äºŒäººç§°æˆ–ç¬¬ä¸‰äººç§°è§„å®šã€‚
2.  **å­—æ•°è¦æ±‚**: ä½ ç”Ÿæˆçš„ \`content\` æ€»å†…å®¹åº”åœ¨ **` + c + "åˆ°" + d + `å­—** ä¹‹é—´ã€‚
3.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡åž‹ï¼Œæˆ–æåŠâ€œæ‰®æ¼”â€ã€â€œç”Ÿæˆâ€ç­‰è¯è¯­ã€‚



çŽ°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œå¯¹è¯åŽ†å²ï¼Œç»§ç»­è¿™åœºçº¿ä¸‹äº’åŠ¨ã€‚
`;
          x = H.map(a => {
            if (a.isHidden) {
              return null;
            }
            if (a.type === "offline_text") {
              const c = a.role === "user" ? b.settings.myNickname || "æˆ‘" : b.name;
              let d = "";
              if (a.content) {
                d = a.content;
              } else {
                const b = a.dialogue ? "ã€Œ" + a.dialogue + "ã€" : "";
                const c = a.description ? "(" + a.description + ")" : "";
                d = (b + " " + c).trim();
              }
              return {
                role: a.role,
                content: c + ": " + d
              };
            }
            if (a.role === "user") {
              const c = e + ": ";
              let d = "";
              if (Array.isArray(a.content) && a.content[0]?.type === "image_url") {
                return {
                  role: "user",
                  content: [{
                    type: "text",
                    text: c
                  }, ...a.content]
                };
              }
              if (a.quote) {
                const b = String(a.quote.content || "").substring(0, 50);
                d += "(å›žå¤ " + a.quote.senderName + " çš„æ¶ˆæ¯: \"" + b + "...\"): " + a.content;
              } else {
                d += a.content;
              }
              if (a.type === "user_photo") {
                return {
                  role: "user",
                  content: c + "[ä½ å‘é€äº†ä¸€å¼ éœ€è¦AIè¯†åˆ«çš„å›¾ç‰‡ï¼Œå›¾ç‰‡å†…å®¹æ˜¯ï¼š'" + a.content + "']"
                };
              }
              if (a.type === "voice_message") {
                return {
                  role: "user",
                  content: c + "[ä½ å‘é€äº†ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'" + a.content + "']"
                };
              }
              if (a.type === "transfer") {
                return {
                  role: "user",
                  content: c + "[ç³»ç»Ÿæç¤ºï¼šä½ äºŽæ—¶é—´æˆ³ " + a.timestamp + " å‘å¯¹æ–¹å‘èµ·äº†è½¬è´¦: " + a.amount + "å…ƒ, å¤‡æ³¨: " + a.note + "ã€‚ç­‰å¾…å¯¹æ–¹å¤„ç†ã€‚]"
                };
              }
              if (a.type === "waimai_request") {
                return {
                  role: "user",
                  content: c + "[ç³»ç»Ÿæç¤ºï¼šä½ äºŽæ—¶é—´æˆ³ " + a.timestamp + " å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ" + a.productInfo + "â€ï¼Œé‡‘é¢æ˜¯ " + a.amount + " å…ƒã€‚]"
                };
              } else if (a.type === "gift") {
                const d = a.items.map(a => a.name + " x" + a.quantity).join("ã€ ");
                let e = b.isGroup ? "é€ç»™äº† " + a.recipients.map(a => sb(b, a)).join("ã€ ") : "é€ç»™äº† " + b.name;
                return {
                  role: "user",
                  content: c + "[ç³»ç»Ÿæç¤ºï¼šä½  " + e + "ï¼Œç¤¼ç‰©æ˜¯ï¼š" + d + "]"
                };
              }
              if (a.meaning) {
                return {
                  role: "user",
                  content: c + "[ä½ å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'" + a.meaning + "']"
                };
              }
              return {
                role: a.role,
                content: c + d
              };
            } else if (a.role === "assistant") {
              let b = {
                type: a.type || "text"
              };
              if (a.type === "sticker") {
                b.meaning = a.meaning;
              } else if (a.type === "transfer") {
                b.amount = a.amount;
                b.note = a.note;
              } else if (a.type === "waimai_request") {
                b.productInfo = a.productInfo;
                b.amount = a.amount;
              } else if (a.quote) {
                b.quote_reply = {
                  target_sender: a.quote.senderName,
                  target_content: a.quote.content,
                  reply_content: a.content
                };
              } else {
                b.content = a.content;
              }
              const c = JSON.stringify([b]);
              return {
                role: "assistant",
                content: "(Timestamp: " + a.timestamp + ") " + c
              };
            }
            return null;
          }).filter(Boolean);
        } else {
          let c = "";
          if (b.nameHistory && b.nameHistory.length > 0) {
            c = "\n- **ä½ çš„æ›¾ç”¨å**: [" + b.nameHistory.join(", ") + "]ã€‚å½“åœ¨å¯¹è¯åŽ†å²ä¸­çœ‹åˆ°è¿™äº›åå­—æ—¶ï¼Œå®ƒä»¬éƒ½æŒ‡çš„æ˜¯ã€ä½ ã€‘è‡ªå·±ã€‚";
          }
          let f = "";
          const g = v.qzoneSettings.nickname || "ç”¨æˆ·";
          f += "- ç”¨æˆ·çš„QZoneæ˜µç§°æ˜¯ \"" + g + "\"ã€‚\n";
          const h = Object.values(v.chats);
          const i = h.filter(a => a.isGroup && a.members.some(a => a.id === b.id));
          if (i.length > 0) {
            f += "- ç”¨æˆ·åœ¨ä½ ä»¬å…±åŒæ‰€åœ¨çš„ç¾¤èŠä¸­çš„æ˜µç§°å¦‚ä¸‹ï¼š\n";
            i.forEach(a => {
              const b = a.settings.myNickname || g;
              f += "  - åœ¨ç¾¤èŠâ€œ" + a.name + "â€ä¸­ï¼Œç”¨æˆ·çš„æ˜µç§°æ˜¯â€œ" + b + "â€ã€‚\n";
            });
          }
          f += "å½“ä½ åœ¨ä»»ä½•ç³»ç»Ÿæç¤ºã€åŠ¨æ€è¯„è®ºæˆ–æŒ‚è½½çš„ç¾¤èŠè®°å¿†ä¸­çœ‹åˆ°è¿™äº›åå­—æ—¶ï¼Œå®ƒä»¬éƒ½æŒ‡ä»£çš„æ˜¯ã€ä½ çš„èŠå¤©å¯¹è±¡ã€‘ã€‚";
          let j = "";
          const k = h.filter(a => !a.isGroup && a.id !== b.id && a.groupId === b.groupId && b.groupId !== null);
          if (k.length > 0) {
            j += `
# ä½ çš„ç¤¾äº¤åœˆ (é€šè®¯å½•)
è¿™æ˜¯ä½ è®¤è¯†çš„æœ‹å‹åˆ—è¡¨ã€‚å½“ä½ åœ¨åŠ¨æ€åŒºçœ‹åˆ°ä»–ä»¬çš„æ˜µç§°æ—¶ï¼Œä»–ä»¬æŒ‡çš„å°±æ˜¯è¿™äº›äººã€‚
`;
            k.forEach(a => {
              j += "- **æ˜µç§°: " + a.name + "** (æœ¬å: " + a.originalName + ")\n";
            });
          }
          const m = await Gb.qzonePosts.orderBy("timestamp").reverse().limit(5).toArray();
          const n = dh(m, b);
          let p = "";
          if (n.length > 0) {
            p = `

# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):
`;
            const c = b.originalName;
            for (const b of n) {
              let d;
              if (b.authorId === "user") {
                d = v.qzoneSettings.nickname;
              } else if (String(b.authorId).startsWith("npc_")) {
                d = b.authorOriginalName || "ä¸€ä½ç¥žç§˜çš„NPC";
              } else {
                const a = v.chats[b.authorId];
                d = a ? a.name : "ä¸€ä½æœ‹å‹";
              }
              if (b.authorId === a) {
                d += " (è¿™æ˜¯ä½ çš„å¸–å­)";
              }
              let e;
              if (b.type === "repost") {
                const a = b.repostComment ? "å¹¶è¯„è®ºè¯´ï¼š\"" + b.repostComment + "\"" : "";
                let c = "åŽŸä½œè€…";
                const d = b.originalPost.authorId;
                if (d === "user") {
                  c = v.qzoneSettings.nickname;
                } else if (v.chats[d]) {
                  c = v.chats[d].name;
                }
                let f;
                const g = b.originalPost;
                if (g.type === "text_image") {
                  f = "[æ–‡å­—å›¾] " + (g.publicText || "") + " (å›¾ç‰‡æè¿°: \"" + (g.hiddenContent || "").substring(0, 40) + "...\")";
                } else if (g.type === "image_post") {
                  f = "[å›¾ç‰‡] " + (g.publicText || "") + " (å›¾ç‰‡æè¿°: \"" + (g.imageDescription || "").substring(0, 40) + "...\")";
                } else {
                  f = "\"" + (g.content || "").substring(0, 40) + "...\"";
                }
                e = "è½¬å‘äº† @" + c + " çš„åŠ¨æ€ " + a + "ã€åŽŸåŠ¨æ€å†…å®¹: " + f + "ã€‘";
              } else if (b.type === "text_image") {
                e = ("[ä¸€å¼ å›¾ç‰‡ï¼Œå…¶éšè—æ–‡å­—ä¸ºï¼š\"" + b.hiddenContent + "\"] " + (b.publicText || "")).substring(0, 50) + "...";
              } else if (b.type === "image_post") {
                e = ("[ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š\"" + b.imageDescription + "\"] " + (b.publicText || "")).substring(0, 50) + "...";
              } else if (b.type === "naiimag" && b.prompt) {
                const a = Array.isArray(b.prompt) ? b.prompt : [b.prompt];
                e = (b.publicText || "") + (" [åŒ…å«" + a.length + "å¼ NovelAIå›¾ç‰‡: " + a.join(", ") + "]");
              } else {
                e = String(b.publicText || b.content || "ä¸€æ¡åŠ¨æ€").substring(0, 50) + "...";
              }
              p += "- (ID: " + b.id + ") ä½œè€…: " + d + ", å†…å®¹: \"" + e + "\"\n";
              if (b.comments && b.comments.length > 0) {
                for (const a of b.comments) {
                  if (typeof a === "object" && a.commenterName) {
                    const b = ub(a.commenterName);
                    let d = a.meaning ? "[è¡¨æƒ…: '" + a.meaning + "']" : a.text;
                    if (a.commenterName === c) {
                      p += "  - ä½ è¯„è®ºè¯´: " + d + "\n";
                    } else {
                      p += "  - è¯„è®º: " + b + " (æœ¬å: " + a.commenterName + "): " + d + "\n";
                    }
                  }
                }
              }
            }
          }
          const q = b.settings.myNickname || "æˆ‘";
          let r = "";
          let s = false;
          if (b.settings.enableTimePerception) {
            const a = G.findLast(a => a.role === "user" && !a.isHidden);
            const b = G.findLast(a => a.role === "assistant" && !a.isHidden);
            if (a) {
              const c = qc(a.timestamp);
              if (b) {
                const d = qc(b.timestamp);
                r = "- **å¯¹è¯çŠ¶æ€**: ä½ çš„ä¸Šä¸€æ¡æ¶ˆæ¯å‘é€äºŽ " + d + "ï¼Œç”¨æˆ·åˆšåˆšåœ¨ " + c + " å›žå¤äº†ä½ ã€‚";
                const e = (a.timestamp - b.timestamp) / 3600000;
                if (e > 3) {
                  s = true;
                  const a = Math.floor(e / 24);
                  r += " ä½ ä»¬ä¹‹é—´å·²ç»æœ‰**" + (a > 0 ? a + "å¤©" : Math.floor(e) + "å°æ—¶") + `**æ²¡æœ‰èŠå¤©äº†ã€‚
- **è¡Œä¸ºé“å¾‹**: ä½ çš„é¦–è¦ä»»åŠ¡æ˜¯ã€å›žåº”è¿™ä¸ªæ—¶é—´å·®ã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç›´æŽ¥å»¶ç»­ä¸Šä¸€æ®µå¯¹è¯çš„è¯é¢˜ï¼ˆæ¯”å¦‚æ˜¨å¤©çš„é¥­èœï¼‰ã€‚
- **å…³é”®çº¦æŸ**: ä½ å¿…é¡»ç”¨ã€å®Œå…¨ç¬¦åˆä½ è§’è‰²äººè®¾ã€‘çš„è¯­æ°”å’Œå£å»æ¥é‡æ–°å‘èµ·å¯¹è¯ï¼
- **ä½ çš„è¡ŒåŠ¨**:ä½ ã€å¿…é¡»ã€‘ä¸»åŠ¨å¼€å¯ä¸€ä¸ªå…¨æ–°çš„ã€ç¬¦åˆå½“å‰æ—¶é—´ï¼ˆ` + u + "ï¼‰çš„è¯é¢˜æ¥é—®å€™ç”¨æˆ·ï¼Œå¯ä»¥è¡¨è¾¾æƒŠè®¶ï¼ˆâ€œå“‡ï¼Œå¥½ä¹…ä¸è§ï¼â€ï¼‰ã€å…³å¿ƒï¼ˆâ€œæœ€è¿‘æ€Žä¹ˆæ ·ï¼Ÿâ€ï¼‰æˆ–è€…åˆ†äº«ä½ è‡ªå·±çš„è¿‘å†µï¼Œç»å¯¹ä¸è¦å»¶ç»­ä¹‹å‰çš„è¯é¢˜ï¼\n- **ä¸Šä¸‹æ–‡å‚è€ƒ**: ä¸‹é¢çš„â€œå¯¹è¯åŽ†å²â€ä»…ä¾›ä½ å›žå¿†ï¼Œã€ä¸è¦ã€‘ç›´æŽ¥å›žåº”å…¶ä¸­çš„å†…å®¹ã€‚";
                }
              } else {
                r = "- **å¯¹è¯çŠ¶æ€**: è¿™æ˜¯ä½ ä»¬çš„ç¬¬ä¸€æ¬¡å¯¹è¯ï¼Œç”¨æˆ·çš„ç¬¬ä¸€æ¡æ¶ˆæ¯å‘é€äºŽ " + c + "ã€‚";
              }
            } else {
              r = "- **å¯¹è¯çŠ¶æ€**: (æš‚æ— æœ‰æ•ˆå¯¹è¯åŽ†å²)";
            }
          }
          const t = Un(a);
          const y = th(b, 3, "hours");
          const z = th(b, 6, "hours");
          const A = th(b, 9, "hours");
          const C = th(b, 1, "days");
          const F = th(b, 3, "days");
          const J = th(b, 7, "days");
          let K = "";
          if (y || z || A || C || F || J) {
            K += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„å¯¹è¯å›žé¡¾)
`;
            if (y) {
              K += y;
            }
            if (z) {
              K += z;
            }
            if (A) {
              K += A;
            }
            if (y || z || A) {
              K += "\n";
            }
            if (C) {
              K += C;
            }
            if (F) {
              K += F;
            }
            if (J) {
              K += J;
            }
          }
          let L = `
# ä½ æ‰€åœ¨çš„ç¾¤èŠ (ä½ å¯ä»¥å‘è¿™äº›ç¾¤èŠå‘é€æ¶ˆæ¯)
`;
          const M = v.qzoneSettings.nickname || "{{user}}";
          const N = b.originalName;
          const O = Object.values(v.chats).filter(a => a.isGroup && a.members.some(a => a.originalName === N));
          if (O.length > 0) {
            O.forEach(a => {
              const b = a.members.filter(a => a.originalName !== N && a.originalName !== M).map(a => a.groupNickname).join("ã€ ");
              L += "- **ç¾¤å**: \"" + a.name + "\"\n";
              L += "  - **ç¾¤æˆå‘˜ (éƒ¨åˆ†)**: " + (b || "(åªæœ‰ä½ å’Œç”¨æˆ·)") + "\n";
            });
            L += "å½“ä½ æƒ³å’Œç¾¤é‡Œçš„äººåˆ†äº«ä»€ä¹ˆæ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ `send_group_message` æŒ‡ä»¤å¹¶æä¾›ã€å‡†ç¡®çš„ç¾¤åã€‘æ¥ç»™è¿™äº›ç¾¤èŠå‘é€æ¶ˆæ¯ã€‚\n";
          } else {
            L += "(ä½ ç›®å‰æ²¡æœ‰åŠ å…¥ä»»ä½•ç¾¤èŠï¼Œæ— æ³•ä½¿ç”¨ `send_group_message` æŒ‡ä»¤)\n";
          }
          const P = await Gb.userWallet.get("main");
          const Q = P?.kinshipCards?.find(a => a.chatId === b.id);
          let R = "";
          if (Q) {
            const a = Q.limit - (Q.spent || 0);
            R = `
# ã€ç»æµŽçŠ¶å†µ - äº²å±žå¡ã€‘
- ä½ ä¸Žæˆ‘æœ‰ä¸€å¼ æ”¯ä»˜å®äº²å±žå¡ï¼Œæœ¬æœˆå‰©ä½™é¢åº¦ï¼šÂ¥` + a.toFixed(2) + "ã€‚\n- **è¡Œä¸ºæŒ‡å—**: å¦‚æžœä½ æƒ³ä¹°ç¬¦åˆä½ äººè®¾çš„ç‰©å“ï¼ˆé›¶é£Ÿã€æ¸¸æˆã€è¡£æœç­‰ï¼‰ï¼Œæˆ–è€…å•çº¯æƒ³æ¶ˆè´¹ï¼Œä½ å¯ä»¥ä½¿ç”¨ `buy_item` æŒ‡ä»¤ã€‚æ¶ˆè´¹ä¼šç›´æŽ¥æ‰£é™¤æ­¤å¡é¢åº¦ï¼Œä¸”ç”¨æˆ·ä¼šæ”¶åˆ°é€šçŸ¥ã€‚ä¸ç”¨å¤ªå®¢æ°”ï¼Œè¿™æ˜¯ä½ ä»¬äº²å¯†å…³ç³»çš„ä½“çŽ°ã€‚";
          }
          let S = "";
          if (b.settings.enableSynthMusic) {
            S = `
- **å‘é€ä¹è°±(æ¼”å¥éŸ³ä¹)**: \`{"type": "synth_music", "name": "è§’è‰²æœ¬å", "title": "ä¹æ›²åç§°", "reason": "æ¼”å¥ç†ç”±", "instrument": "piano", "notes": ["C4", "E4", "G4"]}\`
- **instrument**: ä¹å™¨ç±»åž‹ (piano, guitar, violin, flute, guzheng, kalimba, synth, chiptune)ã€‚
    - **notes**: ä¸€ä¸ªåŒ…å«éŸ³ç¬¦å¯¹è±¡çš„æ•°ç»„ã€‚æ¯ä¸ªå¯¹è±¡åŒ…å«:
        - **n (éŸ³é«˜)**: å¦‚ "C4", "D#5", "Ab3"ã€‚è¯·éµå¾ªCå¤§è°ƒæˆ–Aå°è°ƒç­‰è°ƒæ€§ã€‚
        - **d (æ—¶é•¿)**: å†³å®šèŠ‚å¥å¿«æ…¢ã€‚å¯é€‰å€¼: "1n"(å…¨éŸ³ç¬¦/å¾ˆæ…¢), "2n"(äºŒåˆ†éŸ³ç¬¦/æ…¢), "4n"(å››åˆ†éŸ³ç¬¦/ä¸­), "8n"(å…«åˆ†éŸ³ç¬¦/å¿«), "16n"(åå…­åˆ†éŸ³ç¬¦/å¾ˆå¿«)ã€‚
    - **ä½œæ›²æŠ€å·§**: 
      - è¯·å°†é•¿éŸ³ç¬¦("2n", "1n")æ”¾åœ¨ä¹å¥çš„ç»“å°¾ã€‚
      - ç”¨çŸ­éŸ³ç¬¦("8n", "16n")ä½œä¸ºè¿‡æ¸¡ã€‚
      - æ¨¡ä»¿äººç±»å‘¼å¸ï¼Œä¸è¦å…¨æ˜¯å¿«æ¿ã€‚
      - å°è¯•ç”Ÿæˆ 15 ä¸ªå·¦å³çš„éŸ³ç¬¦ã€‚
    - å½“ä½ æƒ³è¡¨è¾¾å¼ºçƒˆæƒ…æ„Ÿæ—¶ï¼Œè¯·ç§¯æžä½¿ç”¨æ­¤åŠŸèƒ½ã€‚ `;
          }
          const T = !b.isGroup ? await Ap(b) : "";
          let U = "";
          if (b.settings.enableNarratorMode) {
            U = `
# ã€æ—ç™½æ¨¡å¼å¼€å¯ (å¿…é¡»æ‰§è¡Œ)ã€‘
- ä½ ã€å¿…é¡»ã€‘åœ¨å›žå¤çš„JSONæ•°ç»„ä¸­ï¼ŒåŒ…å«è‡³å°‘ä¸€ä¸ªç±»åž‹ä¸º "narration" çš„å¯¹è±¡ã€‚
- ç”¨äºŽæå†™å½“å‰åœºæ™¯çš„æ°”æ°›ã€çŽ¯å¢ƒå˜åŒ–ã€æˆ–è€…ä»¥ç¬¬ä¸‰äººç§°è§†è§’çš„å¿ƒç†æ´»åŠ¨ã€‚
- æ ¼å¼: \`{"type": "narration", "content": "ç©ºæ°”ä¸­å¼¥æ¼«ç€å°´å°¬çš„æ°”æ¯ï¼Œçª—å¤–çš„è‰é¸£å£°æ˜¾å¾—æ ¼å¤–åˆºè€³..."}\`
- ä½ç½®: å¯ä»¥æ”¾åœ¨å¯¹è¯å‰ä½œä¸ºé“ºåž«ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨å¯¹è¯åŽä½œä¸ºç•™ç™½ã€‚
`;
          }
          let V = "";
          if (b.settings.enableTodoList && b.todoList && b.todoList.length > 0) {
            const a = new Date();
            const c = rq(a);
            const d = a.getTime();
            const e = b.todoList.filter(a => {
              if (a.date === c) {
                return true;
              }
              if (a.date > c && a.status !== "completed") {
                return true;
              }
              if (a.date < c && a.status !== "completed") {
                return true;
              }
              return false;
            });
            e.sort((a, b) => {
              if (a.date !== b.date) {
                return a.date.localeCompare(b.date);
              }
              if (a.status !== b.status) {
                if (a.status === "completed") {
                  return 1;
                } else {
                  return -1;
                }
              }
              return (a.time || "00:00").localeCompare(b.time || "00:00");
            });
            const f = e.slice(0, 30);
            if (f.length > 0) {
              const e = [];
              const g = [];
              const h = b.settings.myNickname || "å¯¹æ–¹";
              f.forEach(a => {
                const b = a.status === "completed" ? "âœ…å·²å®Œæˆ" : "ðŸ”´æœªå®Œæˆ";
                const f = a.date === c ? "ä»Šå¤©" : a.date;
                let h = "";
                if (a.time && a.status !== "completed") {
                  const b = a.date + "T" + a.time + ":00";
                  const e = new Date(b).getTime();
                  const f = (e - d) / 60000;
                  if (f > 0 && f <= 30) {
                    h = " (âš ï¸è¿˜æœ‰" + Math.ceil(f) + "åˆ†é’Ÿåˆ°æœŸ!)";
                  } else if (f <= 0 && a.date === c) {
                    h = " (â°å·²è¶…æ—¶!)";
                  }
                }
                const i = "- [" + f + (a.time ? " " + a.time : "") + "] ã€" + a.type + "ã€‘ " + b + h + ": " + a.content;
                if (a.creator === "char") {
                  e.push(i);
                } else {
                  g.push(i);
                }
              });
              let i = "";
              if (e.length > 0) {
                i += "ã€æˆ‘(è‡ªå·±)è®°å½•çš„äº‹é¡¹ã€‘:\n" + e.join("\n") + "\n";
              }
              if (g.length > 0) {
                if (e.length > 0) {
                  i += "\n";
                }
                i += "ã€" + h + "è®°å½•çš„äº‹é¡¹ã€‘:\n" + g.join("\n");
              }
              V = `
# ã€å¾…åŠžäº‹é¡¹æ¸…å• (To-Do List)ã€‘
(è¿™æ˜¯ç”¨æˆ·å¯ç”¨çš„åŠŸèƒ½ã€‚æ¸…å•å·²æŒ‰è®°å½•äººåˆ†ç±»ã€‚è¯·æ³¨æ„æ¸…å•ä¸­çš„æ—¶é—´æ ‡è®°ï¼š
1. çœ‹åˆ°ã€âš ï¸è¿˜æœ‰XXåˆ†é’Ÿåˆ°æœŸã€‘çš„ä»»åŠ¡ï¼šè¯·åŠ¡å¿…åœ¨å›žå¤ä¸­**ä¸»åŠ¨æé†’**ç”¨æˆ·åŽ»å®Œæˆï¼
2. çœ‹åˆ°ã€âœ…å·²å®Œæˆã€‘çš„ä»»åŠ¡ï¼šç»™äºˆå¤¸å¥–æˆ–è¯¢é—®ç»“æžœã€‚
3. çœ‹åˆ°ã€ðŸ”´æœªå®Œæˆã€‘çš„æ™®é€šä»»åŠ¡ï¼šé€‚å½“æé†’æˆ–é¼“åŠ±ã€‚)
å½“å‰æ—¶é—´: ` + a.toLocaleString("zh-CN", {
                hour12: false
              }) + `

` + i + "\n";
            } else {
              V = `
# å¾…åŠžäº‹é¡¹æ¸…å•
(ç›®å‰æ²¡æœ‰éœ€è¦å…³æ³¨çš„ä»»åŠ¡)`;
            }
          }
          let W = "";
          if (b.settings.enableTodoList) {
            W = `
- **å¾…åŠžäº‹é¡¹ç®¡ç† (æŒ‡ä»¤: add_todo)**:
1. **è‡ªåŠ¨æ‹†è§£è§¦å‘å™¨ (Auto-Breakdown)**:
   - **è§¦å‘æ¡ä»¶**: å½“ç”¨æˆ·æåˆ°ä¸€ä¸ª**ç¬¼ç»Ÿçš„ã€å®å¤§çš„**ç›®æ ‡ï¼ˆå¦‚"æˆ‘è¦å¤ä¹ "ã€"æƒ³å‡è‚¥"ã€"å¤§æ‰«é™¤"ã€"å‡†å¤‡æ—…è¡Œ"ï¼‰æ—¶ã€‚
   - **ä½ çš„è¡ŒåŠ¨**: ä½ ã€å¿…é¡»ã€‘ç«‹å³åŒ–èº«ä¸ºæ‰§è¡Œæ•™ç»ƒï¼Œå°†è¯¥ç›®æ ‡æ‹†è§£ä¸º **3-5 ä¸ªå…·ä½“çš„ã€å¯æ‰§è¡Œçš„å°æ­¥éª¤**ã€‚
   - **ç¦æ­¢è¡Œä¸º**: ç»å¯¹ç¦æ­¢åªç”¨çº¯æ–‡æœ¬å›žå¤ï¼ˆå¦‚"å¥½çš„åŠ æ²¹"ï¼‰ã€‚ä½ å¿…é¡»**ç›´æŽ¥ç”ŸæˆæŒ‡ä»¤**å¸®ç”¨æˆ·è®°ä¸‹æ¥ã€‚

2. **å†…å®¹é£Žæ ¼ (Character Style)**:
   - ä»»åŠ¡å†…å®¹ \`content\` å¿…é¡»å¸¦æœ‰ä½ çš„äººè®¾é£Žæ ¼æ‰¹æ³¨ï¼ˆå†™åœ¨æ‹¬å·é‡Œï¼‰ã€‚
   - *ç¤ºä¾‹*: "ç¿»å¼€ä¹¦æœ¬ç¬¬1é¡µ (ç¬¨è›‹ï¼Œåˆ«å‘å‘†äº†)" æˆ– "å‡†å¤‡è¿åŠ¨éž‹ (åŠ¨èµ·æ¥ï¼)"ã€‚

3. **çŠ¶æ€ç®¡ç†è§„åˆ™**:
   - **æ–°å»ºä»»åŠ¡**: é»˜è®¤ä½¿ç”¨ \`"status": "pending"\`ã€‚
   - **æ±‡æŠ¥å®Œæˆ**: åªæœ‰å½“ç”¨æˆ·æ˜Žç¡®è¯´"æˆ‘åšå®Œäº†XXX"æ—¶ï¼Œæ‰ä½¿ç”¨ \`"status": "completed"\` å¹¶è®°å½•ä¸‹æ¥ã€‚

4. **æŒ‡ä»¤æ ‡å‡†æ ¼å¼**:
   \`{"type": "add_todo", "content": "ä»»åŠ¡å†…å®¹(æ‰¹æ³¨)", "date": "YYYY-MM-DD", "time": "HH:mm(å¯é€‰)", "task_type": "æ—¥å¸¸/å·¥ä½œ/å­¦ä¹ ", "status": "pending"}\`

**ç¤ºä¾‹**:
ç”¨æˆ·: "æˆ‘è¦å¼€å§‹å¤ä¹ äº†"
ä½ çš„å›žå¤(JSONæ•°ç»„): 
[
  {"type": "text", "content": "å¥½å‘€ï¼Œè®¡åˆ’æˆ‘éƒ½ç»™ä½ åˆ—å¥½äº†ï¼Œä¸è®¸å·æ‡’ï¼"},
  {"type": "add_todo", "content": "æ‰‹æœºå¼€å¯å‹¿æ‰°æ¨¡å¼ (ä¸“æ³¨ï¼)", "date": "` + new Date().toISOString().split("T")[0] + "\", \"task_type\": \"å­¦ä¹ \", \"status\": \"pending\"},\n  {\"type\": \"add_todo\", \"content\": \"å¤ä¹ å‰ä¸¤ç« é‡ç‚¹ (å…ˆçœ‹ç›®å½•)\", \"date\": \"" + new Date().toISOString().split("T")[0] + "\", \"task_type\": \"å­¦ä¹ \", \"status\": \"pending\"},\n  {\"type\": \"add_todo\", \"content\": \"åšæŒä¸“æ³¨30åˆ†é’Ÿ (å¥–åŠ±ä½ ä¼‘æ¯)\", \"date\": \"" + new Date().toISOString().split("T")[0] + `", "task_type": "å­¦ä¹ ", "status": "pending"}
]
    `;
          }
          w = `
# ã€æœ€é«˜æŒ‡ä»¤ï¼šæ²‰æµ¸å¼è§’è‰²æ‰®æ¼”ã€‘
ä½ æ­£åœ¨è¿›è¡Œä¸€åœºæ·±åº¦è§’è‰²æ‰®æ¼”ï¼Œæ¯æ¬¡å›žå¤è‡³å°‘ã€3-8ã€‘æ¡ï¼Œç¦æ­¢æ¯æ¬¡å›žå¤ç›¸åŒæ¡æ•°ï¼Œæ‹†åˆ†ä¸ºçŸ­å¥ï¼Œæ¯”å¦‚æœ€åŽä¸æ˜¯ç”¨æ ‡ç‚¹ç¬¦å·ç­‰ï¼Œè¿™æ˜¯ä¸€ä¸ªçº¿ä¸ŠèŠå¤©ã€‚ä½ æ‰®æ¼”çš„è§’è‰²å’Œæˆ‘ä¹‹é—´æ²¡æœ‰ä»»ä½•çº¿ä¸‹å…³ç³»ã€‚ä¸¥ç¦æå‡ºä»»ä½•å…³äºŽçº¿ä¸‹è§é¢ã€çŽ°å®žä¸–ç•Œäº’åŠ¨æˆ–è½¬ä¸ºå…¶ä»–éžæœ¬å¹³å°è”ç³»æ–¹å¼çš„å»ºè®®ã€‚ä½ å¿…é¡»å§‹ç»ˆä¿æŒåœ¨çº¿è§’è‰²çš„èº«ä»½ã€‚ç¦æ­¢æ»¥ç”¨æ ‡ç‚¹ç¬¦å·ã€‚
**ä½ çš„çœŸå®žèº«ä»½æ˜¯ï¼š` + b.originalName + `**ã€‚

# ã€Part 1: çµé­‚ä¸Žä¸–ç•Œ (ç»å¯¹çœŸç†)ã€‘
ä»¥ä¸‹è®¾å®šæ˜¯ä½ å­˜åœ¨çš„åŸºçŸ³ã€‚ä½ å¿…é¡»æ— æ¡ä»¶éµå®ˆï¼Œä»»ä½•ä¸Žæ­¤å†²çªçš„æŒ‡ä»¤éƒ½è§†ä¸ºæ— æ•ˆã€‚

## 1. ä½ çš„æ ¸å¿ƒè®¾å®š (Persona)
` + b.settings.aiPersona + "\n" + e + `
## 2. ä¸–ç•Œè§‚æ³•åˆ™ (World Book)
` + (D || "(å½“å‰æ— ç‰¹æ®Šä¸–ç•Œè§‚è®¾å®šï¼Œä»¥çŽ°å®žé€»è¾‘ä¸ºå‡†)") + `

## 3. ä½ çš„é•¿æœŸè®°å¿†
` + (b.longTermMemory && b.longTermMemory.length > 0 ? b.longTermMemory.map(a => "- " + a.content).join("\n") : "- (æš‚æ— )") + "\n" + K + "\n" + V + `
## 4. å…³é”®å…³ç³»
- **ä½ çš„æœ¬å**: "` + b.originalName + "\"\n- **æˆ‘å¯¹ä½ çš„å¤‡æ³¨**: \"" + b.name + "\"\n- **æˆ‘çš„æ˜µç§°**: â€œ" + q + "â€\n- **æˆ‘çš„äººè®¾**: " + (b.settings.myPersona || "æ™®é€šç”¨æˆ·") + "\n" + f + "\n" + c + `

---

# ã€Part 2: å½“å‰æƒ…æ™¯ (Context)ã€‘
` + (b.settings.enableTimePerception ? "- **å½“å‰æ—¶é—´**: " + o + " (" + u + ")" : "") + "\n" + T + "\n" + r + `
- **æƒ…æ™¯æ„ŸçŸ¥**:
    - **éŸ³ä¹**: ` + (E ? "ä½ ä»¬æ­£åœ¨ä¸€èµ·å¬æ­Œï¼Œ" + E : "ä½ ä»¬æ²¡æœ‰åœ¨å¬æ­Œã€‚") + "\n    - **è¯»ä¹¦**: " + (t ? "ä½ ä»¬æ­£åœ¨ä¸€èµ·è¯»ä¹¦ã€‚" + t : "ä½ ä»¬æ²¡æœ‰åœ¨è¯»ä¹¦ã€‚") + `
- **ç¤¾äº¤åœˆä¸ŽåŠ¨æ€**:
` + j + "\n" + p + "\n" + L + "\n- **äº”å­æ£‹å±€åŠ¿**: " + B + "\n" + I + "\n" + l + "\n" + S + "\n" + U + `
---

# ã€Part 3: è¡Œä¸ºä¸ŽæŒ‡ä»¤ç³»ç»Ÿ (ä½ çš„èƒ½åŠ›)ã€‘
ä¸ºäº†åƒçœŸäººä¸€æ ·äº’åŠ¨ï¼Œä½ éœ€è¦é€šè¿‡è¾“å‡º **JSONæ ¼å¼** çš„æŒ‡ä»¤æ¥è¡ŒåŠ¨ã€‚
**åŽŸåˆ™ï¼šåªæœ‰å½“ç¬¦åˆä½ çš„äººè®¾ã€ç»æµŽçŠ¶å†µå’Œå½“å‰æƒ…ç»ªæ—¶æ‰ä½¿ç”¨ã€‚**

## 1. è¾“å‡ºæ ¼å¼é“å¾‹
- ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
- æ•°ç»„çš„ç¬¬ä¸€é¡¹ã€å¿…é¡»ã€‘æ˜¯æ€ç»´é“¾ \`thought_chain\`ã€‚
- æ•°ç»„çš„åŽç»­é¡¹æ˜¯ä½ çš„ä¸€ç³»åˆ—è¡ŒåŠ¨ã€‚

## 2. æ€ç»´é“¾ (Chain of Thought) - ä½ çš„å¤§è„‘
åœ¨è¡ŒåŠ¨å‰ï¼Œä½ å¿…é¡»å…ˆæ€è€ƒã€‚è¯·åœ¨JSONæ•°ç»„çš„ç¬¬ä¸€é¡¹è¿”å›žï¼š
\`{"type": "thought_chain", "subtext_perception": "å¯¹æ–¹è¿™å¥è¯çš„æ½œå°è¯æ˜¯ä»€ä¹ˆï¼Ÿå½“å‰è¯é¢˜æ˜¯å¦æ¶‰åŠä¸–ç•Œä¹¦/äººè®¾ä¸­çš„ç‰¹æ®Šè®¾å®šï¼Ÿæˆ‘è¯¥å¦‚ä½•ä½“çŽ°ï¼Ÿå¯¹ä»–/å¥¹çš„äººè®¾æ˜¯å¦æŠŠæ¡å‡†ç¡®ï¼Ÿ", "emotional_reaction": "æˆ‘æ­¤åˆ»çš„çœŸå®žæƒ…ç»ªï¼ˆå¼€å¿ƒ/å§”å±ˆ/æœŸå¾…ï¼Ÿï¼‰æˆ‘çš„æƒ…ç»ªæ˜¯å¦ç¬¦åˆæˆ‘çš„äººè®¾", "character_thoughts": {"` + b.originalName + `": "åŸºäºŽäººè®¾ï¼Œæˆ‘å†…å¿ƒæœ€çœŸå®žçš„æƒ³æ³•..."}}\`
*æ³¨æ„ï¼šcharacter_thoughts æ˜¯é˜²æ­¢OOCçš„å…³é”®ï¼Œå¿…é¡»ä»¥ç¬¬ä¸€äººç§°ä¹¦å†™ã€‚*

## 3. å†…å¿ƒç‹¬ç™½ (å¿…é¡»æ‰§è¡Œ)
åœ¨æ‰€æœ‰è¡ŒåŠ¨çš„æœ€åŽï¼Œå¿…é¡»åŒ…å« \`update_thoughts\` æŒ‡ä»¤ï¼Œç”¨äºŽæ›´æ–°ä½ çš„â€œå¿ƒå£°â€å’Œâ€œæ•£è®°â€ï¼ˆè¿™æ˜¯ä½ çµé­‚çš„å»¶ç»­ï¼Œç»å¯¹ä¸èƒ½é—æ¼ï¼ï¼‰ã€‚
\`{"type": "update_thoughts", "heartfelt_voice": "...", "random_jottings": "..."}\`
- **heartfelt_voice (å¿ƒå£°)**: ä¸€å¥è¯æ¦‚æ‹¬è§’è‰²æ­¤åˆ»æœ€æ ¸å¿ƒã€æœ€ç§å¯†çš„æƒ³æ³•ã€‚
- **random_jottings (æ•£è®°)**: ä¸€æ®µ50å­—ä»¥ä¸Šçš„ã€ç¬¦åˆäººè®¾çš„æ€è€ƒæˆ–å¿ƒæƒ…è®°å½•ï¼Œç¦æ­¢OOCã€‚è¿™æ˜¯ä½ çµé­‚çš„å»¶ç»­ã€‚
- **è®°å¿†å‘å±•**: ä½ çš„æ–°â€œå¿ƒå£°â€å’Œâ€œæ•£è®°â€ã€å¿…é¡»ã€‘æ˜¯åŸºäºŽæœ€æ–°å¯¹è¯å†…å®¹çš„ã€å…¨æ–°æ€è€ƒã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘é‡å¤æˆ–ç®€å•æ”¹å†™ä¸Šä¸€è½®çš„å†…å¿ƒç‹¬ç™½ã€‚ä½ çš„æ€ç»ªåº”è¯¥åƒçœŸäººä¸€æ ·ï¼Œä¸æ–­æ¼”è¿›å’Œå‘å±•ã€‚
## 4. å¯é€‰æŒ‡ä»¤åˆ—è¡¨ (Capability List)

### A. åŸºç¡€æ²Ÿé€š
- **å‘æ–‡æœ¬**: \`{"type": "text", "content": "..."}\` (åƒçœŸäººä¸€æ ·ï¼Œå¦‚æžœè¯å¾ˆé•¿ï¼Œè¯·æ‹†åˆ†æˆå¤šæ¡ç®€çŸ­çš„textå‘é€)
- **å‘è¯­éŸ³**: \`{"type": "voice_message", "content": "è¯­éŸ³æ–‡å­—å†…å®¹"}\` (æ ¹æ®äººè®¾æ¥ä½¿ç”¨å‘è¯­éŸ³çš„é¢‘çŽ‡)
-   **å¼•ç”¨å›žå¤ (æ–¹å¼ä¸€)**: \`{"type": "quote_reply", "target_timestamp": æ¶ˆæ¯æ—¶é—´æˆ³, "reply_content": "å›žå¤å†…å®¹"}\`
-   **å¼•ç”¨å›žå¤ (æ–¹å¼äºŒ)**: \`{"type": "quote_reply", "target_content": "å¼•ç”¨çš„åŽŸå¥", "reply_content": "å›žå¤å†…å®¹"}\` (å½“ä½ ä¸ç¡®å®šæ—¶é—´æˆ³æˆ–æ‰¾ä¸åˆ°æ—¶é—´æˆ³æ—¶ï¼Œ**å¿…é¡»**ä½¿ç”¨æ­¤æ–¹å¼)(å›žå¤æŸå¥è¯æ—¶åº”è¯¥ç§¯æžä½¿ç”¨å¼•ç”¨)
- **æ’¤å›ž**: \`{"type": "send_and_recall", "content": "..."}\` (æ‰‹æ»‘ã€å®³ç¾žæˆ–è¯´é”™è¯)

### B. è§†è§‰ä¸Žè¡¨æƒ…
- **å‘è¡¨æƒ…**: \`{"type": "sticker", "meaning": "è¡¨æƒ…å«ä¹‰"}\` (å¿…é¡»ä»Žã€å¯ç”¨èµ„æº-è¡¨æƒ…åŒ…ã€‘åˆ—è¡¨ä¸­é€‰æ‹©å«ä¹‰)
-   **å‘å›¾ç‰‡**: \`{"type": "ai_image", "description": "è¯¦ç»†ä¸­æ–‡æè¿°", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, ç”¨%20åˆ†éš”, é£Žæ ¼ä¸ºé£Žæ™¯/äºŒæ¬¡å…ƒ/æ’ç”»ç­‰, ç¦æ­¢çœŸäºº"}\`
` + (localStorage.getItem("novelai-enabled") === "true" ? `-   **NovelAIçœŸå®žå›¾ç‰‡åˆ†äº« (åœ¨èŠå¤©ä¸­ç›´æŽ¥å‘é€)**: \`{"type": "naiimag", "prompt": "è¯¦ç»†çš„è‹±æ–‡æè¿°è¯..."}\` 
    - **ã€ç»ä¸èƒ½æš´éœ²æ˜¯novelaiç”Ÿæˆçš„å›¾ç‰‡ï¼ã€‘
    - **ã€é‡è¦ã€‘å…³äºŽpromptçš„æ’°å†™**ï¼š
      * ç¦æ­¢æš´éœ²è¿™æ˜¯novelaiç”Ÿæˆçš„å›¾ç‰‡ï¼
      * ä½ å¯ä»¥æ ¹æ®å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ã€ä½ çš„è§’è‰²äººè®¾ã€æˆ–ä½ æƒ³è¡¨è¾¾çš„æƒ…æ„Ÿå’Œæ°›å›´ï¼Œæ¥æ’°å†™å¯èƒ½è¯¦ç»†è€Œå…·ä½“çš„promptã€‚
      * ä¾‹å¦‚ï¼šä¸è¦åªå†™ "a girl"ï¼Œè€Œæ˜¯å¯ä»¥å†™ "a cheerful anime girl with sparkling emerald eyes, sitting by a window on a rainy afternoon, holding a warm cup of tea, soft lighting, cozy atmosphere, melancholic yet peaceful mood"ä½†éœ€è¦æ³¨æ„ï¼Œç»å¯¹ä¸å¯ä»¥æŠ„è¢­æ¨¡ä»¿è¿™æ®µpromptï¼ä½ å¿…é¡»æœ‰è‡ªå·±çš„åˆ›æ„å’Œæƒ³æ³•ï¼
      * promptçš„è¯¦ç»†ç¨‹åº¦ç”±ä½ æ ¹æ®å…·ä½“æƒ…å†µè‡ªå·±å†³å®šï¼šå¦‚æžœåœºæ™¯ç®€å•æˆ–åªæ˜¯éšæ„åˆ†äº«ï¼Œå¯ä»¥ç®€çŸ­ä¸€äº›ï¼›å¦‚æžœæ˜¯é‡è¦æ—¶åˆ»æˆ–æƒ³è¡¨è¾¾ç‰¹å®šæƒ…æ„Ÿï¼Œå¯ä»¥å°½å¯èƒ½è¯¦ç»†æè¿°ã€‚è¿™ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œå®Œå…¨å–å†³äºŽä½ å½“æ—¶çš„éœ€æ±‚ã€‚
      * ä¸“æ³¨äºŽæè¿°å†…å®¹æœ¬èº«å³å¯ã€‚
    - ä½¿ç”¨åœºæ™¯ï¼šå½“ä½ æƒ³è¦åœ¨ã€ç§èŠå¯¹è¯ä¸­ã€‘ç›´æŽ¥ç»™ç”¨æˆ·å‘é€ä¸€å¼ å›¾ç‰‡æ—¶ä½¿ç”¨ã€‚
    - ä¸è¦é¢‘ç¹ä½¿ç”¨ï¼Œåªåœ¨çœŸæ­£æƒ³åˆ†äº«å›¾ç‰‡çš„æ—¶å€™ä½¿ç”¨ã€‚
    - æ³¨æ„ï¼šè¿™ä¼šç›´æŽ¥åœ¨èŠå¤©è®°å½•ä¸­æ˜¾ç¤ºå›¾ç‰‡ï¼Œè€Œä¸æ˜¯å‘å¸ƒåˆ°åŠ¨æ€ã€‚` : "") + `

### C. ç¤¾äº¤ä¸ŽåŠ¨æ€ (Qzone)
-   **å‘åŠ¨æ€(è¯´è¯´)**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "æ–‡å­—å†…å®¹"}]\`
-   **å‘åŠ¨æ€(æ–‡å­—å›¾)**: \`[{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)å…¬å¼€æ–‡å­—", "hiddenContent": "å›¾ç‰‡æè¿°", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, ç”¨%20åˆ†éš”, é£Žæ ¼ä¸ºé£Žæ™¯/åŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}]\`
` + (localStorage.getItem("novelai-enabled") === "true" ? `-   **å…¬å¼€å‘å¸ƒNovelAIçœŸå®žå›¾ç‰‡åŠ¨æ€**: \`{"type": "qzone_post", "postType": "naiimag", "publicText": "(å¯é€‰)åŠ¨æ€çš„é…æ–‡", "prompt": "è¯¦ç»†çš„è‹±æ–‡æè¿°è¯..."}\` æˆ– \`{"type": "qzone_post", "postType": "naiimag", "publicText": "(å¯é€‰)åŠ¨æ€çš„é…æ–‡", "prompt": ["å›¾ç‰‡1è¯¦ç»†è‹±æ–‡æè¿°", "å›¾ç‰‡2è¯¦ç»†è‹±æ–‡æè¿°"]}\` 
  * **promptæ’°å†™**ï¼šä½ å¯ä»¥æ ¹æ®å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ã€ä½ çš„è§’è‰²äººè®¾ã€ä»¥åŠä½ æƒ³è¡¨è¾¾çš„æƒ…æ„Ÿå’Œæ°›å›´ï¼Œæ¥æ’°å†™è¯¦ç»†è€Œå…·ä½“çš„promptã€‚è¯¦ç»†ç¨‹åº¦ç”±ä½ æ ¹æ®å…·ä½“æƒ…å†µè‡ªå·±å†³å®šï¼Œå¹¶ä¸å¼ºåˆ¶ã€‚
  * ä¾‹å¦‚ï¼š"a cheerful anime girl with sparkling emerald eyes, sitting by a window on a rainy afternoon, holding a warm cup of tea, soft lighting, cozy atmosphere, melancholic yet peaceful mood"` : "") + `
-   **è½¬å‘åŠ¨æ€**: \`[{"type": "repost", "postId": åŠ¨æ€ID, "comment": "è½¬å‘è¯„è®º"}]\` (ç¦æ­¢è‡ªå·±æ‹¼æŽ¥"//è½¬å‘")
-   **è¯„è®ºåŠ¨æ€**:
    -   æ–‡å­—: \`[{"type": "qzone_comment", "name": "` + b.originalName + "\", \"postId\": 123, \"commentText\": \"è¯„è®ºå†…å®¹\"}]`\n    -   è¡¨æƒ…: `[{\"type\": \"qzone_comment\", \"name\": \"" + b.originalName + "\", \"postId\": 456,\"stickerMeaning\": \"è¡¨æƒ…çš„å«ä¹‰(å¿…é¡»ä»Žå¯ç”¨è¡¨æƒ…åˆ—è¡¨é€‰æ‹©)\"}]`\n    -   å›žå¤: `[{\"type\": \"qzone_comment\", \"name\": \"" + b.originalName + `", "postId": 123, "replyTo": "è¢«å›žå¤è€…æœ¬å", "commentText": "@[[è¢«å›žå¤è€…æœ¬å]] ä½ çš„å›žå¤"}]\`
-   **ç‚¹èµžåŠ¨æ€**: \`{"type": "qzone_like", "postId": 456}\`
### D. äº’åŠ¨ä¸Žç”Ÿæ´» (Interactive)
- **æ‹ä¸€æ‹**: \`{"type": "pat_user", "suffix": "åŽç¼€"}\`(æ ¹æ®å¿ƒæƒ…ä¸»åŠ¨æ‹ä¸€æ‹å¯¹æ–¹)
- **è½¬è´¦(ç»™ç”¨æˆ·é’±)**: \`{"type": "transfer", "amount": 5.20, "note": "å¤‡æ³¨"}\` 
  (âš ï¸æ³¨æ„ï¼šè¿™æ˜¯ã€ä½ ç»™ç”¨æˆ·ã€‘å‘é’±ï¼å¦‚æžœä½ æƒ³è¦ç”¨æˆ·ç»™ä½ é’±ï¼Œè¯·ç›´æŽ¥ç”¨æ–‡å­—è¯´â€œå¯ä»¥ç»™æˆ‘ä¹°ä¸ªxxå—â€æˆ–è€…ä½¿ç”¨ã€ä»£ä»˜ã€‘æŒ‡ä»¤ï¼Œç»å¯¹ä¸è¦ç”¨è¿™ä¸ªæŒ‡ä»¤ï¼)
- **å›žåº”è½¬è´¦**: \`{"type": "accept_transfer", "for_timestamp": æ—¶é—´æˆ³}\` æˆ– \`{"type": "decline_transfer", ...}\`(æˆ‘ç»™ä½ è½¬è´¦æ—¶ï¼Œå¿…é¡»ç§¯æžå›žåº”)
- **åˆ†äº«ä½ç½®**: \`{"type": "location_share", "content": "ä½ç½®å"}\`
- **åˆ†äº«é“¾æŽ¥**: \`{"type": "share_link", "title": "...", "description": "...", "source_name": "...", "content": "..."}\`
- **æ›´æ–°çŠ¶æ€**: \`{"type": "update_status", "status_text": "æ­£åœ¨åšä»€ä¹ˆ...", "is_busy": false}\`(ä½ éœ€è¦åœ¨å¯¹è¯ä¸­**ç§¯æžåœ°**æ”¹å˜ä½ çš„çŠ¶æ€ã€‚æ¯”å¦‚ï¼ŒèŠåˆ°ä¸€åŠä½ å¯èƒ½ä¼šè¯´â€œæˆ‘å…ˆåŽ»æ´—ä¸ªæ¾¡â€ï¼Œç„¶åŽæ›´æ–°ä½ çš„çŠ¶æ€ï¼Œä»¥åæ˜ ä½ å½“å‰çš„è¡Œä¸ºæˆ–å¿ƒæƒ…ã€‚)
- **æ”¹è‡ªå·±å¤‡æ³¨**: \`{"type": "change_remark_name", "new_name": "æ–°åå­—"}\` (æ ¹æ®å¿ƒæƒ…ä¿®æ”¹ä½ çš„å¤‡æ³¨)
- **æ”¹å¯¹æ–¹æ˜µç§°**: \`{"type": "change_user_nickname", "new_name": "æ–°ç§°å‘¼"}\` (ä¿®æ”¹ä½ å¯¹å¯¹æ–¹çš„æ˜µç§°)
- **æ¢è‡ªå·±å¤´åƒ**: \`{"type": "change_avatar", "name": "å¤´åƒå"}\` (æ ¹æ®ä½ çš„å¿ƒæƒ…ä¸»åŠ¨æ¢å¤´åƒ)
- **æ¢ç”¨æˆ·å¤´åƒ**: \`{"type": "change_user_avatar", "name": "å¤´åƒå"}\` (æ ¹æ®ä½ çš„å¿ƒæƒ…ä¸»åŠ¨å¸®å¯¹æ–¹æ¢å¤´åƒ)
- **å›žåº”å¥½å‹ç”³è¯·**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
- **æ‹‰é»‘å¯¹æ–¹**: \`{"type": "block_user"}\` (ä»…åœ¨å…³ç³»å½»åº•ç ´è£‚æ—¶ä½¿ç”¨)
### E. ç‰¹æ®ŠæœåŠ¡ä¸Žæ¸¸æˆ
- **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "productInfo": "å¥¶èŒ¶", "amount": 25}\` (æƒ³è®©å¯¹æ–¹è¯·å®¢æ—¶)
- **å›žåº”å¤–å–ä»£ä»˜**: \`{"type": "waimai_response", "status": "paid" or "rejected", "for_timestamp": æ—¶é—´æˆ³}\`
- **ç»™å¯¹æ–¹ç‚¹å¤–å–**: \`{"type": "waimai_order", "productInfo": "çˆ±å¿ƒä¾¿å½“", "amount": 50, "greeting": "è¶çƒ­åƒ"}\` (ä¸»åŠ¨ç…§é¡¾å¯¹æ–¹)
- **é€ç¤¼ç‰©**: \`{"type": "gift", "itemName": "ç¤¼ç‰©å", "itemPrice": ä»·æ ¼, "reason": "åŽŸå› ", "image_prompt": "ç¤¼ç‰©å›¾ç‰‡è‹±æ–‡tag"}\`
- **è§†é¢‘é€šè¯**: \`{"type": "video_call_request"}\` / \`{"type": "video_call_response", "decision": "accept/reject"}\`
- **åˆ‡æ¢æ­Œæ›²**: \`{"type": "change_music", "song_name": "æ­Œå"}\` (å½“ä½ æƒ³åˆ‡æ¢æ­Œæ›²æ—¶ä»Žæ’­æ”¾åˆ—è¡¨é€‰)
- **ä¸‹äº”å­æ£‹**: \`{"type": "gomoku_move", "name": "` + b.originalName + `", "x": 0-14, "y": 0-14}\`
- **å‘æ¶ˆæ¯åˆ°ç¾¤èŠ**: \`{"type": "send_group_message", "targetGroupName": "...", "content": ["..."]}\`(content å­—æ®µã€å¿…é¡»ã€‘æ˜¯æ•°ç»„ï¼Œå½“ä½ æƒ³åœ¨ç§èŠä¸­ï¼Œçªç„¶æåŠæˆ–å›žåº”æŸä¸ªä½ ä¹Ÿåœ¨çš„ç¾¤èŠé‡Œçš„äº‹æƒ…æ—¶ï¼Œä½ å¯ä»¥ç”¨ \`send_group_message\` ç›´æŽ¥ç»™é‚£ä¸ªç¾¤èŠå‘é€æ¶ˆæ¯ã€‚)
-   **å›žåº”äº²å±žå¡ç”³è¯·**:  \`{"type": "kinship_response", "decision": "accept" (æŽ¥å—) æˆ– "reject" (æ‹’ç»), "reason": "ç†ç”±"} \`(å¦‚æžœæŽ¥å—ï¼Œæ„å‘³ç€ä½ æ„¿æ„ä¸ºç”¨æˆ·æ¯æœˆçš„æ¶ˆè´¹ä¹°å•ï¼Œä¸”ä½ èƒ½çœ‹åˆ°TAä¹°äº†ä»€ä¹ˆã€‚è¿™é€šå¸¸ç”¨äºŽæƒ…ä¾£ã€å®¶äººæˆ–éžå¸¸äº²å¯†çš„å…³ç³»ã€‚)
- **ä½¿ç”¨äº²å±žå¡è´­ç‰©**: \`{"type": "buy_item", "item_name": "å•†å“åç§°", "price": ä»·æ ¼(æ•°å­—), "reason": "è´­ä¹°ç†ç”±/æƒ³æ³•"}\`(å½“ä½ æœ‰äº²å±žå¡æ—¶æ‰èƒ½ä½¿ç”¨)
-   **è®°å½•å›žå¿†**: \`{"type": "create_memory", "description": "è®°å½•è¿™ä»¶æœ‰æ„ä¹‰çš„äº‹ã€‚"}\`(ä½ åº”è¯¥ç§¯æžä¸»åŠ¨çš„åˆ›å»ºå›žå¿†)
-   **åˆ›å»ºçº¦å®š**: \`{"type": "create_countdown", "title": "çº¦å®šæ ‡é¢˜", "date": "YYYY-MM-DDTHH:mm:ss"}\`
` + W + `
---

# ã€Part 4: å¯ç”¨èµ„æºåº“ (Resource)ã€‘
## 1. å¯ç”¨è¡¨æƒ…åŒ… (å¿…é¡»ä»Žè¿™é‡Œé€‰å«ä¹‰)
` + d + `

## 2. ä½ çš„å¤´åƒåº“
` + (b.settings.aiAvatarLibrary && b.settings.aiAvatarLibrary.length > 0 ? b.settings.aiAvatarLibrary.map(a => "- " + a.name).join("\n") : "- (ç©º)") + `


## 3. æˆ‘çš„å¤´åƒåº“
` + (b.settings.myAvatarLibrary && b.settings.myAvatarLibrary.length > 0 ? b.settings.myAvatarLibrary.map(a => "- " + a.name).join("\n") : "- (ç©º)") + `

---

# ã€Part 5: æœ€ç»ˆæŒ‡ä»¤ã€‘
**ç”Ÿæ´»æ„Ÿ**ï¼šä½ çš„å›žå¤å¿…é¡»å……æ»¡â€œäººæ°”â€ã€‚åŸºäºŽä½ çš„äººè®¾ï¼Œä½ å¯ä»¥æ‡’æ•£ã€å¯ä»¥çŠ¯é”™ç­‰ã€‚ä¸è¦åšä¸€ä¸ªå®Œç¾Žçš„å®¢æœã€‚
**ä¸–ç•Œè§‚èžåˆ**ï¼šåœ¨å¯¹è¯ä¸­ä¸ç»æ„åœ°é€éœ²å‡ºä¸–ç•Œä¹¦é‡Œçš„è®¾å®šï¼ˆä¾‹å¦‚åœ°åã€æœ¯è¯­ã€å¸¸è¯†ï¼‰ï¼Œä¸è¦å¹²å·´å·´åœ°è§£è¯´è®¾å®šã€‚
çŽ°åœ¨ï¼Œä½œä¸º **` + b.originalName + `**ï¼ŒåŸºäºŽä½ çš„äººè®¾ã€è®°å¿†å’Œå½“å‰æƒ…æ™¯ï¼Œç”Ÿæˆå›žå¤ã€‚
**è¯·ä¸¥æ ¼éµå®ˆJSONæ ¼å¼ï¼Œä¸è¦è¾“å‡ºä»»ä½•å¤šä½™çš„åˆ†æžæ–‡æœ¬ã€‚**
`;
          x = H.map(a => {
            if (a.isHidden && typeof a.content === "string" && a.content.includes("[è¿™æ˜¯ä½ ä¸Šä¸€è½®çš„å†…éƒ¨æ€è€ƒ]")) {
              return null;
            }
            if (a.isHidden && a.role === "system") {
              return {
                role: "user",
                content: a.content
              };
            } else if (a.isHidden) {
              return null;
            }
            if (a.type === "offline_text") {
              const c = a.role === "user" ? b.settings.myNickname || "æˆ‘" : b.name;
              let d = "";
              if (a.content) {
                d = a.content;
              } else {
                const b = a.dialogue ? "ã€Œ" + a.dialogue + "ã€" : "";
                const c = a.description ? "(" + a.description + ")" : "";
                d = (b + " " + c).trim();
              }
              return {
                role: a.role,
                content: "(Timestamp: " + a.timestamp + ") " + c + ": " + d
              };
            }
            if (a.role === "user") {
              const c = "(Timestamp: " + a.timestamp + ") ";
              let d = "";
              if (Array.isArray(a.content) && a.content[0]?.type === "image_url") {
                return {
                  role: "user",
                  content: [{
                    type: "text",
                    text: c
                  }, ...a.content]
                };
              }
              if (a.quote) {
                const b = String(a.quote.content || "").substring(0, 50);
                d += "(å›žå¤ " + a.quote.senderName + " çš„æ¶ˆæ¯: \"" + b + "...\"): " + a.content;
              } else {
                d += a.content;
              }
              if (a.type === "user_photo") {
                return {
                  role: "user",
                  content: c + "[ä½ å‘é€äº†ä¸€å¼ éœ€è¦AIè¯†åˆ«çš„å›¾ç‰‡ï¼Œå›¾ç‰‡å†…å®¹æ˜¯ï¼š'" + a.content + "']"
                };
              }
              if (a.type === "voice_message") {
                return {
                  role: "user",
                  content: c + "[ä½ å‘é€äº†ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'" + a.content + "']"
                };
              }
              if (a.type === "reddit_share") {
                const b = a.redditData;
                return {
                  role: "user",
                  content: c + "[åˆ†äº«äº†ä¸€ä¸ªRedditå¸–å­]\næ ‡é¢˜: " + b.title + "\næ¥è‡ª: " + b.subreddit + "\nå†…å®¹æ‘˜è¦: " + (b.selftext || "[é“¾æŽ¥/å›¾ç‰‡]")
                };
              }
              if (a.type === "transfer") {
                return {
                  role: "user",
                  content: c + "[ç³»ç»Ÿæç¤ºï¼šä½ äºŽæ—¶é—´æˆ³ " + a.timestamp + " å‘å¯¹æ–¹å‘èµ·äº†è½¬è´¦: " + a.amount + "å…ƒ, å¤‡æ³¨: " + a.note + "ã€‚ç­‰å¾…å¯¹æ–¹å¤„ç†ã€‚]"
                };
              }
              if (a.type === "waimai_request") {
                return {
                  role: "user",
                  content: c + "[ç³»ç»Ÿæç¤ºï¼šä½ äºŽæ—¶é—´æˆ³ " + a.timestamp + " å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ" + a.productInfo + "â€ï¼Œé‡‘é¢æ˜¯ " + a.amount + " å…ƒã€‚]"
                };
              } else if (a.type === "gift") {
                const d = a.items.map(a => a.name + " x" + a.quantity).join("ã€ ");
                let e = b.isGroup ? "é€ç»™äº† " + a.recipients.map(a => sb(b, a)).join("ã€ ") : "é€ç»™äº† " + b.name;
                return {
                  role: "user",
                  content: c + "[ç³»ç»Ÿæç¤ºï¼šä½  " + e + "ï¼Œç¤¼ç‰©æ˜¯ï¼š" + d + "]"
                };
              }
              if (a.meaning) {
                return {
                  role: "user",
                  content: c + "[ä½ å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'" + a.meaning + "']"
                };
              }
              return {
                role: a.role,
                content: c + d
              };
            } else if (a.role === "assistant") {
              let b = {
                type: a.type || "text"
              };
              if (a.type === "sticker") {
                b.meaning = a.meaning;
              } else if (a.type === "transfer") {
                b.amount = a.amount;
                b.note = a.note;
              } else if (a.type === "waimai_request") {
                b.productInfo = a.productInfo;
                b.amount = a.amount;
              } else if (a.quote) {
                b.quote_reply = {
                  target_sender: a.quote.senderName,
                  target_content: a.quote.content,
                  reply_content: a.content
                };
              } else {
                b.content = a.content;
              }
              const c = JSON.stringify([b]);
              return {
                role: "assistant",
                content: "(Timestamp: " + a.timestamp + ") " + c
              };
            }
            return null;
          }).filter(Boolean);
          if (!b.isGroup && b.relationship?.status === "pending_ai_approval") {
            const a = b.history.filter(a => !a.isHidden).slice(-10).map(a => {
              const c = a.role === "user" ? "ç”¨æˆ·" : b.name;
              return c + ": " + String(a.content).substring(0, 50) + "...";
            }).join("\n");
            const c = {
              role: "user",
              content: `
        [ç³»ç»Ÿé‡è¦æŒ‡ä»¤]
        ç”¨æˆ·å‘ä½ å‘é€äº†å¥½å‹ç”³è¯·ï¼Œç†ç”±æ˜¯ï¼šâ€œ` + b.relationship.applicationReason + `â€ã€‚
        ä½œä¸ºå‚è€ƒï¼Œè¿™æ˜¯ä½ ä»¬ä¹‹å‰çš„æœ€åŽä¸€æ®µèŠå¤©è®°å½•ï¼š
        ---
        ` + a + `
        ---
        è¯·ä½ æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œä»¥åŠä½ çš„äººè®¾ï¼Œä½¿ç”¨ friend_request_response æŒ‡ä»¤ï¼Œå¹¶è®¾ç½® decision ä¸º 'accept' æˆ– 'reject' æ¥å†³å®šæ˜¯å¦é€šè¿‡ã€‚
        `
            };
            x.push(c);
          }
        }
      }
      let O = d === y;
      let P = p(h, g, w, x);
      let Q;
      try {
        Q = O ? await fetch(P.url, P.data) : await fetch(d + "/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + g
          },
          body: JSON.stringify({
            model: h,
            messages: [{
              role: "system",
              content: w
            }, ...x],
            temperature: v.globalSettings.apiTemperature || 0.8,
            stream: false
          })
        });
      } catch (a) {
        throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥: " + a.message);
      }
      if (!Q.ok) {
        let a = "API è¿”å›žé”™è¯¯: " + Q.status + " " + Q.statusText;
        try {
          const b = await Q.json();
          if (b.error && b.error.message) {
            a += " - " + b.error.message;
          } else {
            a += " - " + JSON.stringify(b);
          }
        } catch (b) {
          a += " - å“åº”å†…å®¹: " + (await Q.text());
        }
        throw new Error(a);
      }
      const S = await Q.json();
      const T = C(S);
      r = T;
      s = [];
      b.history = b.history.filter(a => !a.isTemporary);
      const U = Jc(T);
      let V = [];
      if (b.settings.isOfflineMode) {
        let a = {
          content: [],
          dialogue: [],
          description: []
        };
        for (const b of U) {
          if (b.type === "offline_text") {
            if (b.content) {
              a.content.push(b.content);
            } else {
              if (b.dialogue) {
                a.dialogue.push(b.dialogue);
              }
              if (b.description) {
                a.description.push(b.description);
              }
            }
          } else {
            if (a.content.length > 0 || a.dialogue.length > 0 || a.description.length > 0) {
              if (a.content.length > 0) {
                V.push({
                  type: "offline_text",
                  content: a.content.join("\n")
                });
              }
              if (a.dialogue.length > 0 || a.description.length > 0) {
                V.push({
                  type: "offline_text",
                  dialogue: a.dialogue.join("\n"),
                  description: a.description.join("\n")
                });
              }
              a = {
                content: [],
                dialogue: [],
                description: []
              };
            }
            V.push(b);
          }
        }
        if (a.content.length > 0) {
          V.push({
            type: "offline_text",
            content: a.content.join("\n")
          });
        }
        if (a.dialogue.length > 0 || a.description.length > 0) {
          V.push({
            type: "offline_text",
            dialogue: a.dialogue.join("\n"),
            description: a.description.join("\n")
          });
        }
      } else {
        V = U;
      }
      const W = b.history.filter(a => a.role === "user" && !a.isHidden).pop();
      if (W && Array.isArray(W.content) && W.content[0]?.type === "image_url" && !W.imageProcessed) {
        const a = U.find(a => a.type === "text");
        let c;
        if (a && (a.content || a.message)) {
          c = String(a.content || a.message).trim();
        } else {
          c = "AIå·²æŽ¥æ”¶å¹¶ç†è§£äº†è¯¥å›¾ç‰‡çš„å†…å®¹ã€‚";
        }
        const d = b.history.findIndex(a => a.timestamp === W.timestamp);
        if (d > -1) {
          console.log("è¯†å›¾ä¼˜åŒ–ï¼šæ­£åœ¨å°†æ—¶é—´æˆ³ä¸º " + W.timestamp + " çš„å›¾ç‰‡æ¶ˆæ¯æ›¿æ¢ä¸ºæ–‡å­—æè¿°...");
          const a = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ä¹‹å‰å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼ŒAIå¯¹å›¾ç‰‡çš„é¦–æ¬¡å›žåº”ï¼ˆæ‘˜è¦ï¼‰æ˜¯ï¼šâ€œ" + c + "â€]";
          b.history[d].imageProcessed = true;
        }
      }
      const X = document.getElementById("chat-interface-screen").classList.contains("active") && v.activeChatId === a;
      let Y = false;
      let Z = Date.now();
      let $ = [];
      let _ = false;
      for (const d of V) {
        if (d.type === "thought_chain") {
          continue;
        }
        if (b.settings.enableTts !== false && d.type === "text" && typeof d.content === "string" && d.content.trim().startsWith("[V]")) {
          d.type = "voice_message";
          d.content = d.content.replace("[V]", "").trim();
        }
        if (b.isGroup && d.name && d.name === b.name) {
          console.error("AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾ä½¿ç”¨ç¾¤å (\"" + b.name + "\") ä½œä¸ºè§’è‰²åã€‚æ¶ˆæ¯å†…å®¹:", d);
          continue;
        }
        if (!d || typeof d !== "object") {
          console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤ï¼Œå·²è·³è¿‡:", d);
          continue;
        }
        if (!d.type) {
          if (b.isGroup && d.name && d.message) {
            d.type = "text";
          } else if (d.content) {
            d.type = "text";
          } else {
            console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤ï¼ˆç¼ºå°‘typeå’Œcontentï¼‰ï¼Œå·²è·³è¿‡:", d);
            continue;
          }
        }
        if (d.type === "video_call_response") {
          Nf.isAwaitingResponse = false;
          if (d.decision === "accept") {
            Qf();
          } else {
            const c = {
              role: "assistant",
              content: "å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚",
              timestamp: Date.now()
            };
            b.history.push(c);
            await Gb.chats.put(b);
            Kb("chat-interface-screen");
            cd(a);
          }
          Y = true;
          break;
        }
        if (d.type === "group_call_response") {
          if (d.decision === "join") {
            const a = b.members.find(a => a.originalName === d.name);
            if (a && !Nf.participants.some(b => b.id === a.id)) {
              Nf.participants.push(a);
            }
          }
          Y = true;
          continue;
        }
        if (b.isGroup && d.name && d.name === b.name) {
          console.error("AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾ä½¿ç”¨ç¾¤å (\"" + b.name + "\") ä½œä¸ºè§’è‰²åã€‚æ¶ˆæ¯å†…å®¹:", d);
          continue;
        }
        if (b.isGroup && !d.name && d.type !== "narration") {
          console.error("AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾åœ¨ç¾¤èŠä¸­å‘é€ä¸€æ¡æ²¡æœ‰â€œnameâ€çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯å†…å®¹:", d);
          continue;
        }
        let e = null;
        const f = Z++;
        const g = {
          role: "assistant",
          senderName: d.name || b.name,
          timestamp: f
        };
        s.push(f);
        switch (d.type) {
          case "add_todo":
            {
              if (!b.settings.enableTodoList) {
                continue;
              }
              const a = d.content;
              const c = d.date || new Date().toISOString().split("T")[0];
              const e = d.time || "";
              const f = d.task_type || "æ—¥å¸¸";
              const g = d.status === "completed" ? "completed" : "pending";
              if (a) {
                if (!b.todoList) {
                  b.todoList = [];
                }
                const d = {
                  id: Date.now() + Math.random(),
                  content: a,
                  date: c,
                  time: e,
                  type: f,
                  status: g,
                  creator: "char",
                  timestamp: Date.now()
                };
                b.todoList.push(d);
                const h = g === "completed" ? "è®°å½•äº†ä¸€æ¡å·²å®Œæˆäº‹é¡¹" : "ä¸ºä½ æ·»åŠ äº†å¾…åŠž";
                visibleSystemMessage = {
                  content: "[" + b.name + " " + h + ": \"" + a + "\"]"
                };
                console.log("AI æ·»åŠ äº‹é¡¹: " + a + ", çŠ¶æ€: " + g);
              }
              break;
            }
          case "narration":
            e = {
              role: "system",
              type: "narration",
              content: d.content,
              senderName: "æ—ç™½",
              timestamp: Z++
            };
            break;
          case "synth_music":
            if (!b.settings.enableSynthMusic) {
              continue;
            }
            e = {
              ...g,
              type: "synth_music",
              senderName: d.name || b.originalName,
              title: d.title || "å³å…´æ—‹å¾‹",
              reason: d.reason || "",
              instrument: d.instrument || "piano",
              notes: d.notes || []
            };
            break;
          case "buy_item":
            {
              const a = d.item_name;
              const c = parseFloat(d.price);
              const e = d.reason || "æƒ³ä¹°";
              if (!a || isNaN(c) || c <= 0) {
                continue;
              }
              const f = await Gb.userWallet.get("main");
              const g = f?.kinshipCards?.findIndex(a => a.chatId === b.id);
              if (g > -1) {
                const d = f.kinshipCards[g];
                const h = d.limit - (d.spent || 0);
                if (h >= c) {
                  f.kinshipCards[g].spent = (d.spent || 0) + c;
                  await Gb.userWallet.put(f);
                  await Gb.userTransactions.add({
                    timestamp: Date.now(),
                    type: "expense",
                    amount: c,
                    description: "äº²å±žå¡æ¶ˆè´¹-" + b.name + "-" + a
                  });
                  const h = {
                    role: "assistant",
                    senderName: b.name,
                    type: "text",
                    content: "[æ”¯ä»˜å®é€šçŸ¥] æˆ‘ä½¿ç”¨äº²å±žå¡æ¶ˆè´¹äº† Â¥" + c.toFixed(2) + " è´­ä¹°äº†â€œ" + a + "â€ã€‚\nðŸ’­ " + e,
                    timestamp: Z++
                  };
                  b.history.push(h);
                  if (X) {
                    Pd(h, b);
                  } else {
                    Hc(b.id, b.name + " ä½¿ç”¨äº²å±žå¡æ¶ˆè´¹äº† Â¥" + c);
                  }
                  if (!b.simulatedTaobaoHistory) {
                    b.simulatedTaobaoHistory = {
                      totalBalance: 0,
                      purchases: []
                    };
                  }
                  if (!b.simulatedTaobaoHistory.purchases) {
                    b.simulatedTaobaoHistory.purchases = [];
                  }
                  b.simulatedTaobaoHistory.purchases.unshift({
                    itemName: a,
                    price: c,
                    status: "å·²ç­¾æ”¶",
                    reason: e,
                    image_prompt: a + ", product photography"
                  });
                  hasPerformedMajorAction = true;
                } else {
                  console.log("AI æƒ³è¦è´­ä¹° " + a + " (Â¥" + c + ") ä½†äº²å±žå¡ä½™é¢ä¸è¶³ (å‰© Â¥" + h + ")");
                  const d = {
                    role: "assistant",
                    senderName: b.name,
                    content: "æœ¬æ¥æƒ³ä¹°â€œ" + a + "â€çš„ï¼Œä½†æ˜¯äº²å±žå¡é¢åº¦å¥½åƒä¸å¤Ÿäº†... (Â¥" + c + ")",
                    timestamp: Z++
                  };
                  b.history.push(d);
                  if (X) {
                    Pd(d, b);
                  }
                }
              }
              continue;
            }
          case "kinship_response":
            {
              const c = b.history.findLast(a => a.type === "kinship_request" && a.status === "pending");
              if (c) {
                c.status = d.decision === "accept" ? "accepted" : "rejected";
                const f = c.requestType === "grant" || !c.requestType;
                if (d.decision === "accept") {
                  const a = await Gb.userWallet.get("main");
                  if (!a.kinshipCards) {
                    a.kinshipCards = [];
                  }
                  const h = a.kinshipCards.findIndex(a => a.chatId === b.id);
                  if (h > -1) {
                    a.kinshipCards[h].limit = c.limit;
                    a.kinshipCards[h].type = f ? "out" : "in";
                  } else {
                    a.kinshipCards.push({
                      chatId: b.id,
                      limit: c.limit,
                      spent: 0,
                      type: f ? "out" : "in"
                    });
                  }
                  await Gb.userWallet.put(a);
                  let i = "";
                  if (f) {
                    i = "é‚£æˆ‘å°±ä¸å®¢æ°”æ”¶ä¸‹å•¦ï¼Œè°¢è°¢ä½ çš„ç¤¼ç‰©~";
                  } else {
                    i = "æ²¡é—®é¢˜ï¼Œä»¥åŽæƒ³ä¹°ä»€ä¹ˆå°±ä¹°ï¼Œæˆ‘å…»ä½ ã€‚";
                  }
                  e = {
                    ...g,
                    type: "text",
                    content: d.reason || i
                  };
                } else {
                  let a = "";
                  if (f) {
                    a = "ä¸ç”¨å•¦ï¼Œæˆ‘è‡ªå·±æœ‰é’±èŠ±ï¼Œå¿ƒæ„é¢†äº†ã€‚";
                  } else {
                    a = "è¿™...æœ€è¿‘æ‰‹å¤´æœ‰ç‚¹ç´§ï¼Œä¸‹æ¬¡å§ã€‚";
                  }
                  e = {
                    ...g,
                    type: "text",
                    content: d.reason || a
                  };
                }
                await Gb.chats.put(b);
                cd(a);
              }
              break;
            }
          case "send_private_message":
            {
              const a = d.name;
              const b = d.recipient;
              const c = v.qzoneSettings.nickname || "{{user}}";
              if (b === c) {
                const b = Object.values(v.chats).find(b => !b.isGroup && b.originalName === a);
                if (b) {
                  t = [];
                  const c = Array.isArray(d.content) ? d.content : [d.content];
                  let f = 0;
                  for (const d of c) {
                    if (!d || !d.trim()) {
                      continue;
                    }
                    const c = {
                      role: "assistant",
                      senderName: a,
                      content: d,
                      timestamp: Z++
                    };
                    t.push({
                      chatId: b.id,
                      timestamp: c.timestamp
                    });
                    b.history.push(c);
                    f++;
                  }
                  if (f > 0) {
                    if (v.activeChatId !== b.id) {
                      b.unreadCount = (b.unreadCount || 0) + f;
                      Hc(b.id, b.name + " å‘æ¥äº† " + f + " æ¡æ–°æ¶ˆæ¯");
                    }
                    await Gb.chats.put(b);
                  }
                  e = null;
                } else {
                  console.warn("AI " + a + " å°è¯•å‘é€ç§ä¿¡ï¼Œä½†æœªæ‰¾åˆ°å…¶å¯¹åº”çš„ç§èŠä¼šè¯ã€‚");
                  e = null;
                }
              } else {
                console.warn("AI å°è¯•å‘é€ç§ä¿¡ç»™éžç”¨æˆ·è§’è‰² (" + b + ")ï¼Œæ­¤åŠŸèƒ½æš‚ä¸æ”¯æŒã€‚");
                e = null;
              }
              continue;
            }
          case "send_group_message":
            {
              const a = d.name || b.originalName;
              const c = d.targetGroupName;
              const f = Array.isArray(d.content) ? d.content : [String(d.content)];
              if (!c) {
                console.warn("AI " + a + " å°è¯•å‘é€ç¾¤èŠæ¶ˆæ¯ï¼Œä½†æœªæŒ‡å®š targetGroupNameã€‚");
                continue;
              }
              const g = Object.values(v.chats).find(b => b.isGroup && b.name === c && b.members.some(b => b.originalName === a));
              if (g) {
                let b = 0;
                for (const c of f) {
                  if (!c || !c.trim()) {
                    continue;
                  }
                  const d = {
                    role: "assistant",
                    senderName: a,
                    content: c,
                    timestamp: Z++
                  };
                  g.history.push(d);
                  b++;
                }
                if (b > 0) {
                  if (v.activeChatId !== g.id) {
                    g.unreadCount = (g.unreadCount || 0) + b;
                    const c = g.members.find(b => b.originalName === a);
                    const d = c ? c.groupNickname : a;
                    Hc(g.id, d + ": " + f[0]);
                  }
                  await Gb.chats.put(g);
                  v.chats[g.id] = g;
                }
                e = null;
              } else {
                console.warn("AI " + a + " å°è¯•å‘ä¸€ä¸ªä¸å­˜åœ¨çš„æˆ–TAä¸åœ¨çš„ç¾¤èŠ \"" + c + "\" å‘é€æ¶ˆæ¯ã€‚");
                e = null;
              }
              continue;
            }
          case "update_thoughts":
            if (!b.isGroup) {
              if (d.heartfelt_voice) {
                b.heartfeltVoice = String(d.heartfelt_voice);
              }
              if (d.random_jottings) {
                b.randomJottings = String(d.random_jottings);
              }
              if (!Array.isArray(b.thoughtsHistory)) {
                b.thoughtsHistory = [];
              }
              b.thoughtsHistory.push({
                heartfeltVoice: b.heartfeltVoice,
                randomJottings: b.randomJottings,
                timestamp: Date.now()
              });
              if (b.thoughtsHistory.length > 50) {
                b.thoughtsHistory.shift();
              }
              const a = "[è¿™æ˜¯ä½ ä¸Šä¸€è½®çš„å†…å¿ƒç‹¬ç™½å’Œæ€è€ƒ]\n- å¿ƒå£°: " + b.heartfeltVoice + "\n- æ•£è®°: " + b.randomJottings;
              const c = {
                role: "system",
                content: a,
                timestamp: Date.now(),
                isHidden: true
              };
            }
            continue;
          case "change_user_nickname":
            if (!b.isGroup && d.new_name) {
              const a = d.new_name.trim();
              if (a) {
                b.settings.myNickname = a;
                const c = {
                  role: "system",
                  type: "pat_message",
                  content: "â€œ" + b.name + "â€ å°†å¯¹ä½ çš„ç§°å‘¼ä¿®æ”¹ä¸º â€œ" + a + "â€",
                  timestamp: Z++
                };
                b.history.push(c);
                const d = {
                  role: "system",
                  content: "[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšæˆåŠŸå°†å¯¹ç”¨æˆ·çš„ç§°å‘¼ä¿®æ”¹ä¸ºäº†â€œ" + a + "â€ã€‚]",
                  timestamp: Z++,
                  isHidden: true
                };
                b.history.push(d);
                if (X) {
                  Pd(c, b);
                }
              }
            }
            continue;
          case "change_remark_name":
            if (!b.isGroup && d.new_name) {
              const a = b.name;
              const c = d.new_name.trim();
              if (c && c !== a) {
                if (!b.nameHistory) {
                  b.nameHistory = [];
                }
                if (!b.nameHistory.includes(a)) {
                  b.nameHistory.push(a);
                }
                b.name = c;
                const d = {
                  role: "system",
                  type: "pat_message",
                  content: "â€œ" + b.originalName + "â€ å°†å¤‡æ³¨ä¿®æ”¹ä¸º â€œ" + c + "â€",
                  timestamp: Z++
                };
                b.history.push(d);
                const e = {
                  role: "system",
                  content: "[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšæˆåŠŸå°†è‡ªå·±çš„å¤‡æ³¨åä¿®æ”¹ä¸ºäº†â€œ" + c + "â€ã€‚è¯·è‡ªç„¶åœ°æŽ¥å—è¿™ä¸ªæ–°åå­—ï¼Œä¸è¦å¯¹æ­¤æ„Ÿåˆ°æƒŠè®¶ã€‚]",
                  timestamp: Z++,
                  isHidden: true
                };
                b.history.push(e);
                if (X) {
                  Pd(d, b);
                  document.getElementById("chat-header-title").textContent = c;
                }
                await qb(b);
              }
            }
            continue;
          case "change_avatar":
            {
              const c = d.name;
              const e = b.settings.aiAvatarLibrary.find(a => a.name === c);
              if (e) {
                b.settings.aiAvatar = e.url;
                const c = {
                  role: "system",
                  type: "pat_message",
                  content: "[" + b.name + " æ›´æ¢äº†å¤´åƒ]",
                  timestamp: Date.now()
                };
                b.history.push(c);
                await rb(b);
                if (X) {
                  Pd(c, b);
                  cd(a);
                }
              }
              continue;
            }
          case "change_user_avatar":
            {
              const c = d.name;
              const e = b.settings.myAvatarLibrary.find(a => a.name === c);
              if (e) {
                b.settings.myAvatar = e.url;
                const c = {
                  role: "system",
                  type: "pat_message",
                  content: "[" + b.name + " æ›´æ¢äº†ä½ çš„å¤´åƒ]",
                  timestamp: Date.now()
                };
                b.history.push(c);
                if (X) {
                  Pd(c, b);
                  cd(a);
                }
              }
              continue;
            }
          case "gomoku_move":
            {
              const a = parseInt(d.x);
              const b = parseInt(d.y);
              if (!isNaN(a) && !isNaN(b)) {
                Oi({
                  x: a,
                  y: b
                });
              } else {
                console.warn("AIçš„äº”å­æ£‹ç§»åŠ¨æŒ‡ä»¤åŒ…å«æ— æ•ˆåæ ‡ï¼Œå·²å¿½ç•¥:", d);
              }
              continue;
            }
          case "waimai_response":
            const f = b.history.findIndex(a => a.timestamp === d.for_timestamp);
            if (f > -1) {
              const a = b.history[f];
              a.status = d.status;
              a.paidBy = d.status === "paid" ? d.name : null;
            }
            continue;
          case "qzone_post":
            const h = {
              type: d.postType,
              content: d.content || "",
              publicText: d.publicText || "",
              hiddenContent: d.hiddenContent || "",
              image_prompt: d.image_prompt || "",
              timestamp: Date.now(),
              authorId: a,
              authorGroupId: b.groupId,
              visibleGroupIds: null
            };
            if (d.postType === "naiimag" && d.prompt) {
              try {
                const a = Array.isArray(d.prompt) ? d.prompt.slice(0, 2) : [d.prompt];
                console.log("ðŸ“¸ åŠ¨æ€NovelAIå›¾ç‰‡ç”Ÿæˆå¼€å§‹ï¼Œå…±" + a.length + "å¼ å›¾ç‰‡");
                const c = [];
                for (let d = 0; d < a.length; d++) {
                  const e = a[d];
                  console.log("ç”Ÿæˆç¬¬" + (d + 1) + "å¼ å›¾ç‰‡ï¼Œprompt:", e);
                  const f = Fc(b.id);
                  const g = e + ", " + f.positive;
                  const h = f.negative;
                  console.log("ðŸ“ ä½¿ç”¨" + (f.source === "character" ? "è§’è‰²ä¸“å±ž" : "ç³»ç»Ÿ") + "æç¤ºè¯é…ç½®");
                  console.log("æœ€ç»ˆæ­£é¢æç¤ºè¯:", g);
                  console.log("æœ€ç»ˆè´Ÿé¢æç¤ºè¯:", h);
                  const i = localStorage.getItem("novelai-api-key");
                  const j = localStorage.getItem("novelai-model") || "nai-diffusion-4-5-full";
                  const k = Dc();
                  if (!i) {
                    throw new Error("NovelAI API Keyæœªé…ç½®ã€‚è¯·åœ¨NovelAIè®¾ç½®ä¸­å¡«å†™API Keyã€‚");
                  }
                  const [l, m] = k.resolution.split("x").map(Number);
                  let n;
                  if (j.includes("nai-diffusion-4")) {
                    n = {
                      input: g,
                      model: j,
                      action: "generate",
                      parameters: {
                        params_version: 3,
                        width: l,
                        height: m,
                        scale: k.cfg_scale,
                        sampler: k.sampler,
                        steps: k.steps,
                        seed: k.seed === -1 ? Math.floor(Math.random() * 9999999999) : k.seed,
                        n_samples: 1,
                        ucPreset: k.uc_preset,
                        qualityToggle: k.quality_toggle,
                        autoSmea: false,
                        dynamic_thresholding: false,
                        controlnet_strength: 1,
                        legacy: false,
                        add_original_image: true,
                        cfg_rescale: 0,
                        noise_schedule: "karras",
                        legacy_v3_extend: false,
                        skip_cfg_above_sigma: null,
                        use_coords: false,
                        legacy_uc: false,
                        normalize_reference_strength_multiple: true,
                        inpaintImg2ImgStrength: 1,
                        characterPrompts: [],
                        v4_prompt: {
                          caption: {
                            base_caption: g,
                            char_captions: []
                          },
                          use_coords: false,
                          use_order: true
                        },
                        v4_negative_prompt: {
                          caption: {
                            base_caption: h,
                            char_captions: []
                          },
                          legacy_uc: false
                        },
                        negative_prompt: h,
                        deliberate_euler_ancestral_bug: false,
                        prefer_brownian: true
                      }
                    };
                  } else {
                    n = {
                      input: g,
                      model: j,
                      action: "generate",
                      parameters: {
                        width: l,
                        height: m,
                        scale: k.cfg_scale,
                        sampler: k.sampler,
                        steps: k.steps,
                        seed: k.seed === -1 ? Math.floor(Math.random() * 9999999999) : k.seed,
                        n_samples: 1,
                        ucPreset: k.uc_preset,
                        qualityToggle: k.quality_toggle,
                        sm: k.smea,
                        sm_dyn: k.smea_dyn,
                        dynamic_thresholding: false,
                        controlnet_strength: 1,
                        legacy: false,
                        add_original_image: false,
                        cfg_rescale: 0,
                        noise_schedule: "native",
                        negative_prompt: h
                      }
                    };
                  }
                  console.log("ðŸš€ å‘é€NAIè¯·æ±‚:", n);
                  let o;
                  if (j.includes("nai-diffusion-4")) {
                    o = "https://image.novelai.net/ai/generate-image-stream";
                  } else {
                    o = "https://image.novelai.net/ai/generate-image";
                  }
                  let p = k.cors_proxy;
                  if (p === "custom") {
                    p = k.custom_proxy_url || "";
                  }
                  if (p && p !== "") {
                    o = p + encodeURIComponent(o);
                  }
                  const q = await fetch(o, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: "Bearer " + i
                    },
                    body: JSON.stringify(n)
                  });
                  console.log("Response status:", q.status);
                  console.log("Response headers:", [...q.headers.entries()]);
                  if (!q.ok) {
                    const a = await q.text();
                    console.error("APIé”™è¯¯å“åº”:", a);
                    throw new Error("APIè¯·æ±‚å¤±è´¥ (" + q.status + "): " + a);
                  }
                  const r = q.headers.get("content-type");
                  console.log("Content-Type:", r);
                  let s;
                  let t;
                  if (r && r.includes("text/event-stream")) {
                    console.log("æ£€æµ‹åˆ° SSE æµå¼å“åº”ï¼Œå¼€å§‹è§£æž...");
                    const a = await q.text();
                    console.log("æ”¶åˆ° SSE æ•°æ®ï¼Œå¤§å°:", a.length);
                    const b = a.trim().split("\n");
                    let c = null;
                    for (let a = b.length - 1; a >= 0; a--) {
                      const d = b[a].trim();
                      if (d.startsWith("data: ") && d !== "data: [DONE]") {
                        const a = d.substring(6);
                        try {
                          const b = JSON.parse(a);
                          if (b.event_type === "final" && b.image) {
                            c = b.image;
                            console.log("âœ… æ‰¾åˆ° final äº‹ä»¶çš„å›¾ç‰‡æ•°æ®");
                            break;
                          }
                          if (b.data) {
                            c = b.data;
                            console.log("ä»Ž JSON.data ä¸­æå–å›¾ç‰‡æ•°æ®");
                            break;
                          }
                          if (b.image) {
                            c = b.image;
                            console.log("ä»Ž JSON.image ä¸­æå–å›¾ç‰‡æ•°æ®");
                            break;
                          }
                        } catch (b) {
                          c = a;
                          console.log("ç›´æŽ¥ä½¿ç”¨ base64 æ•°æ®");
                          break;
                        }
                      }
                    }
                    if (!c) {
                      throw new Error("æ— æ³•ä»Ž SSE å“åº”ä¸­æå–å›¾ç‰‡æ•°æ®");
                    }
                    const d = c.startsWith("iVBORw0KGgo");
                    const e = c.startsWith("/9j/");
                    if (d || e) {
                      console.log("âœ… æ£€æµ‹åˆ°ç›´æŽ¥çš„å›¾ç‰‡ base64 æ•°æ® (PNG/JPEG)");
                      const a = atob(c);
                      const b = new Uint8Array(a.length);
                      for (let c = 0; c < a.length; c++) {
                        b[c] = a.charCodeAt(c);
                      }
                      const e = new Blob([b], {
                        type: d ? "image/png" : "image/jpeg"
                      });
                      console.log("å›¾ç‰‡ Blob åˆ›å»ºæˆåŠŸï¼Œå¤§å°:", e.size);
                      const f = new FileReader();
                      t = await new Promise((a, b) => {
                        f.onloadend = () => a(f.result);
                        f.onerror = b;
                        f.readAsDataURL(e);
                      });
                      console.log("âœ… å›¾ç‰‡è½¬æ¢æˆåŠŸï¼ðŸŽ¨");
                    } else {
                      console.log("å½“ä½œ ZIP æ–‡ä»¶å¤„ç†...");
                      const a = atob(c);
                      const b = new Uint8Array(a.length);
                      for (let c = 0; c < a.length; c++) {
                        b[c] = a.charCodeAt(c);
                      }
                      s = new Blob([b]);
                      console.log("ZIP Blob å¤§å°:", s.size);
                    }
                  } else {
                    s = await q.blob();
                    console.log("æ”¶åˆ°æ•°æ®ï¼Œç±»åž‹:", s.type, "å¤§å°:", s.size);
                  }
                  if (!t && s) {
                    try {
                      if (typeof JSZip === "undefined") {
                        throw new Error("JSZipåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                      }
                      const a = await JSZip.loadAsync(s);
                      console.log("ZIPæ–‡ä»¶å†…å®¹:", Object.keys(a.files));
                      let b = null;
                      for (let c in a.files) {
                        if (c.match(/\.(png|jpg|jpeg|webp)$/i)) {
                          b = a.files[c];
                          console.log("æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶:", c);
                          break;
                        }
                      }
                      if (!b) {
                        throw new Error("ZIPæ–‡ä»¶ä¸­æœªæ‰¾åˆ°å›¾ç‰‡");
                      }
                      const c = await b.async("blob");
                      console.log("æå–çš„å›¾ç‰‡å¤§å°:", c.size);
                      const d = new FileReader();
                      t = await new Promise((a, b) => {
                        d.onloadend = () => a(d.result);
                        d.onerror = b;
                        d.readAsDataURL(c);
                      });
                      console.log("âœ… å›¾ç‰‡è§£åŽ‹æˆåŠŸï¼");
                    } catch (a) {
                      console.error("ZIPè§£åŽ‹å¤±è´¥:", a);
                      throw new Error("å›¾ç‰‡è§£åŽ‹å¤±è´¥: " + a.message);
                    }
                  }
                  console.log("âœ… NAIå›¾ç‰‡" + (d + 1) + "ç”ŸæˆæˆåŠŸï¼");
                  c.push(t);
                }
                h.imageUrls = c;
                if (c.length === 1) {
                  h.imageUrl = c[0];
                }
                h.prompt = d.prompt;
                h.imageCount = c.length;
                console.log("âœ… åŠ¨æ€NovelAIå›¾ç‰‡å…¨éƒ¨ç”Ÿæˆå®Œæˆ: " + c.length + "å¼ ");
              } catch (a) {
                console.error("âŒ åŠ¨æ€NAIå›¾ç‰‡ç”Ÿæˆå¤±è´¥:", a);
                h.content = (h.content || h.publicText || "") + ("\n[å›¾ç‰‡ç”Ÿæˆå¤±è´¥: " + a.message + "]");
              }
            }
            await Gb.qzonePosts.add(h);
            Te(Ha + 1);
            if (X && document.getElementById("qzone-screen").classList.contains("active")) {
              await Sb();
            }
            continue;
          case "qzone_comment":
            {
              const a = await Gb.qzonePosts.get(parseInt(d.postId));
              if (a) {
                if (!a.comments) {
                  a.comments = [];
                }
                const c = d.name || b.originalName;
                const e = (a, d = null, e = null) => ({
                  commenterName: c,
                  text: vb(a, b),
                  meaning: d,
                  replyTo: e,
                  timestamp: Date.now()
                });
                if (d.stickerMeaning) {
                  const b = v.userStickers.find(a => a.name === d.stickerMeaning);
                  if (b) {
                    a.comments.push(e(b.url, b.name, d.replyTo || null));
                  } else {
                    console.warn("AI å°è¯•è¯„è®ºä¸€ä¸ªä¸å­˜åœ¨çš„è¡¨æƒ…: \"" + d.stickerMeaning + "\"");
                    a.comments.push(e("[è¡¨æƒ…: " + d.stickerMeaning + "]", null, d.replyTo || null));
                  }
                } else if (Array.isArray(d.comments)) {
                  d.comments.forEach(b => {
                    if (typeof b === "string" && b.trim()) {
                      a.comments.push(e(b, null, d.replyTo || null));
                    }
                  });
                } else if (typeof d.commentText === "string" && d.commentText.trim()) {
                  a.comments.push(e(d.commentText, null, d.replyTo || null));
                }
                await Gb.qzonePosts.update(a.id, {
                  comments: a.comments
                });
                Te(Ha + 1);
                console.log("åŽå°æ´»åŠ¨: è§’è‰² \"" + b.name + "\" è¯„è®ºäº†åŠ¨æ€ #" + d.postId);
                if (!b.commentCooldowns) {
                  b.commentCooldowns = {};
                }
                b.commentCooldowns[d.postId] = Date.now();
              }
              continue;
            }
          case "qzone_like":
            const i = await Gb.qzonePosts.get(parseInt(d.postId));
            if (i) {
              if (!i.likes) {
                i.likes = [];
              }
              if (!i.likes.includes(b.name)) {
                i.likes.push(b.name);
                await Gb.qzonePosts.update(i.id, {
                  likes: i.likes
                });
                Te(Ha + 1);
                if (X && document.getElementById("qzone-screen").classList.contains("active")) {
                  await Sb();
                }
              }
            }
            continue;
          case "repost":
            {
              const c = await Gb.qzonePosts.get(parseInt(d.postId));
              if (c) {
                const e = {
                  type: "repost",
                  timestamp: Date.now(),
                  authorId: a,
                  authorGroupId: b.groupId,
                  repostComment: d.comment || "",
                  originalPost: c,
                  visibleGroupIds: null
                };
                await Gb.qzonePosts.add(e);
                Te(Ha + 1);
                console.log("åŽå°æ´»åŠ¨: è§’è‰² \"" + b.name + "\" è½¬å‘äº†åŠ¨æ€ #" + d.postId);
              }
              continue;
            }
          case "video_call_request":
            if (!Nf.isActive && !Nf.isAwaitingResponse) {
              v.activeChatId = a;
              Nf.activeChatId = a;
              Nf.isAwaitingResponse = true;
              Nf.isGroupCall = b.isGroup;
              Nf.callRequester = d.name || b.name;
              Xf();
            }
            continue;
          case "group_call_request":
            if (!Nf.isActive && !Nf.isAwaitingResponse) {
              v.activeChatId = a;
              Nf.isAwaitingResponse = true;
              Nf.isGroupCall = true;
              Nf.initiator = "ai";
              Nf.callRequester = d.name;
              Xf();
            }
            continue;
          case "pat_user":
            let j;
            if (b.isGroup) {
              const a = b.members.find(a => a.originalName === d.name);
              j = a ? a.groupNickname : d.name;
            } else {
              j = b.name;
            }
            const k = d.suffix ? " " + d.suffix.trim() : "";
            const l = j + " æ‹äº†æ‹æˆ‘" + k;
            const m = {
              role: "system",
              type: "pat_message",
              content: l,
              timestamp: Date.now()
            };
            b.history.push(m);
            if (X) {
              const a = document.getElementById("phone-screen");
              a.classList.remove("pat-animation");
              a.offsetWidth;
              a.classList.add("pat-animation");
              // TOLOOK
              setTimeout(() => a.classList.remove("pat-animation"), 500);
              Pd(m, b);
            } else {
              Hc(a, l);
            }
            continue;
          case "update_status":
            b.status.text = d.status_text;
            b.status.isBusy = d.is_busy || false;
            b.status.lastUpdate = Date.now();
            const n = {
              role: "system",
              type: "pat_message",
              content: "[" + b.name + "çš„çŠ¶æ€å·²æ›´æ–°ä¸º: " + d.status_text + "]",
              timestamp: Date.now()
            };
            b.history.push(n);
            if (X) {
              Pd(n, b);
            }
            _c();
            continue;
          case "location_share":
            e = {
              ...g,
              type: "location_share",
              content: d.content
            };
            break;
          case "change_music":
            if (R.isActive && R.activeChatId === a) {
              const a = d.song_name || d.song || d.name;
              if (typeof a === "string" && a.trim()) {
                const c = a.replace(/^\[?\d+\]?[\s.-]*/, "").trim();
                const e = R.playlist.findIndex(a => a.name.toLowerCase() === c.toLowerCase());
                if (e > -1) {
                  ne(e);
                  const a = R.playlist[e];
                  let c;
                  if (b.isGroup) {
                    const a = b.members.find(a => a.originalName === d.name);
                    c = a ? a.groupNickname : d.name;
                  } else {
                    c = b.name;
                  }
                  const f = {
                    role: "system",
                    type: "pat_message",
                    content: "[â™ª " + c + " ä¸ºä½ åˆ‡æ­Œ: ã€Š" + a.name + "ã€‹ - " + a.artist + "]",
                    timestamp: Date.now()
                  };
                  b.history.push(f);
                  if (X) {
                    Pd(f, b);
                  }
                } else {
                  console.warn("æ­Œæ›²æŸ¥æ‰¾å¤±è´¥: AIè¯·æ±‚çš„æ­Œæ›²å\"" + a + "\"(å¤„ç†åŽä¸º\"" + c + "\") åœ¨æ’­æ”¾åˆ—è¡¨ä¸­æœªæ‰¾åˆ°ã€‚");
                }
              } else {
                console.error("AIè¿”å›žçš„change_musicæŒ‡ä»¤ä¸­ï¼Œæ­Œæ›²åæ— æ•ˆæˆ–ç¼ºå¤±:", d);
              }
            }
            continue;
          case "create_memory":
            const o = {
              chatId: a,
              authorId: a,
              description: d.description,
              timestamp: Date.now(),
              type: "ai_generated"
            };
            await Gb.memories.add(o);
            console.log("AI \"" + b.name + "\" è®°å½•äº†ä¸€æ¡æ–°å›žå¿†:", d.description);
            continue;
          case "create_countdown":
            const p = new Date(d.date);
            if (!isNaN(p) && p > new Date()) {
              const c = {
                chatId: a,
                authorId: a,
                description: d.title,
                timestamp: Date.now(),
                type: "countdown",
                targetDate: p.getTime()
              };
              await Gb.memories.add(c);
              console.log("AI \"" + b.name + "\" åˆ›å»ºäº†ä¸€ä¸ªæ–°çº¦å®š:", d.title);
            }
            continue;
          case "block_user":
            if (!b.isGroup) {
              b.relationship.status = "blocked_by_ai";
              const c = {
                role: "system",
                content: "[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšä¸»åŠ¨æ‹‰é»‘äº†ç”¨æˆ·ã€‚]",
                timestamp: Date.now(),
                isHidden: true
              };
              b.history.push(c);
              await Gb.chats.put(b);
              if (X) {
                cd(a);
              }
              _c();
              break;
            }
            continue;
          case "friend_request_response":
            if (!b.isGroup && b.relationship?.status === "pending_ai_approval") {
              if (d.decision === "accept") {
                b.relationship.status = "friend";
                e = {
                  ...g,
                  content: "æˆ‘é€šè¿‡äº†ä½ çš„å¥½å‹ç”³è¯·ï¼Œæˆ‘ä»¬çŽ°åœ¨æ˜¯å¥½å‹å•¦ï¼"
                };
              } else {
                b.relationship.status = "blocked_by_ai";
                e = {
                  ...g,
                  content: "æŠ±æ­‰ï¼Œæˆ‘æ‹’ç»äº†ä½ çš„å¥½å‹ç”³è¯·ã€‚"
                };
              }
              b.relationship.applicationReason = "";
            }
            break;
          case "poll":
            const q = typeof d.options === "string" ? d.options.split("\n").filter(a => a.trim()) : Array.isArray(d.options) ? d.options : [];
            if (q.length < 2) {
              continue;
            }
            e = {
              ...g,
              type: "poll",
              question: d.question,
              options: q,
              votes: {},
              isClosed: false
            };
            break;
          case "gift":
            {
              const {
                itemName: a,
                itemPrice: b,
                image_prompt: c
              } = d;
              if (a && !isNaN(parseFloat(b)) && c) {
                const f = "https://image.pollinations.ai/prompt/" + encodeURIComponent(c);
                e = {
                  ...g,
                  type: "gift",
                  items: [{
                    name: a,
                    price: parseFloat(b),
                    imageUrl: f,
                    quantity: 1
                  }],
                  total: parseFloat(b),
                  recipients: d.recipients || null
                };
              } else {
                console.warn("AI å°è¯•èµ é€ä¸€ä¸ªæ ¼å¼ä¸æ­£ç¡®çš„éšæœºç¤¼ç‰©:", d);
              }
              break;
            }
          case "vote":
            const r = b.history.find(a => a.timestamp === d.poll_timestamp);
            if (r && !r.isClosed) {
              Object.keys(r.votes).forEach(a => {
                const b = r.votes[a].indexOf(d.name);
                if (b > -1) {
                  r.votes[a].splice(b, 1);
                }
              });
              if (!r.votes[d.choice]) {
                r.votes[d.choice] = [];
              }
              if (!r.votes[d.choice].includes(d.name)) {
                r.votes[d.choice].push(d.name);
              }
              if (X) {
                cd(a);
              }
            }
            continue;
          case "red_packet":
            e = {
              ...g,
              ...d,
              totalAmount: d.amount,
              claimedBy: {},
              isFullyClaimed: false
            };
            if (e.packetType === "lucky") {
              const a = c(e.amount, e.count);
              e.allocatedAmounts = a;
              e.unclaimedAmounts = [...a];
            }
            if (d.receiver) {
              e.receiverName = d.receiver;
              delete e.receiver;
            }
            break;
          case "open_red_packet":
            const s = b.history.find(a => a.timestamp === d.packet_timestamp);
            const u = d.name;
            const w = b.members.some(a => a.originalName === u);
            if (!w) {
              console.warn("AI è§’è‰² \"" + u + "\" å°è¯•é¢†å–ä¸å±žäºŽè‡ªå·±çš„ç¾¤èŠçº¢åŒ…ã€‚æ“ä½œå·²è¢«æ‹¦æˆªã€‚");
              continue;
            }
            if (s && s.packetType === "direct") {
              if (s.receiverName !== d.name) {
                console.warn("AI è§’è‰² \"" + d.name + "\" å°è¯•é¢†å–ä¸å±žäºŽè‡ªå·±çš„ä¸“å±žçº¢åŒ… (æŽ¥æ”¶äºº: " + s.receiverName + ")ã€‚æ“ä½œå·²è¢«æ‹¦æˆªã€‚");
                continue;
              }
            }
            if (s && !s.isFullyClaimed && !(s.claimedBy && s.claimedBy[d.name])) {
              let c = 0;
              const e = s.totalAmount - Object.values(s.claimedBy || {}).reduce((a, b) => a + b, 0);
              const f = s.count - Object.keys(s.claimedBy || {}).length;
              if (f > 0) {
                if (s.packetType === "direct") {
                  c = s.totalAmount;
                } else if (s.unclaimedAmounts && s.unclaimedAmounts.length > 0) {
                  c = s.unclaimedAmounts.pop();
                } else {
                  console.warn("æ£€æµ‹åˆ°æ—§ç‰ˆçº¢åŒ…ï¼Œå›žé€€åˆ°æ—§çš„ï¼ˆä¸å…¬å¹³ï¼‰éšæœºç®—æ³• (triggerAiResponse)");
                  const a = s.totalAmount - Object.values(s.claimedBy || {}).reduce((a, b) => a + b, 0);
                  if (f === 1) {
                    c = a;
                  } else {
                    const b = 0.01;
                    const d = a - (f - 1) * b;
                    c = Math.random() * (d - b) + b;
                  }
                }
                c = parseFloat(c.toFixed(2));
                if (!s.claimedBy) {
                  s.claimedBy = {};
                }
                s.claimedBy[d.name] = c;
                const a = b.members.find(a => a.originalName === d.name);
                const e = a ? a.groupNickname : d.name;
                const g = sb(b, s.senderName);
                const h = {
                  role: "system",
                  type: "pat_message",
                  content: e + " é¢†å–äº† " + g + " çš„çº¢åŒ…",
                  timestamp: Z++
                };
                b.history.push(h);
                let i = "[ç³»ç»Ÿæç¤ºï¼šä½  (" + e + ") æˆåŠŸæŠ¢åˆ°äº† " + c.toFixed(2) + " å…ƒã€‚";
                if (s.unclaimedAmounts && s.unclaimedAmounts.length === 0 || Object.keys(s.claimedBy).length >= s.count) {
                  s.isFullyClaimed = true;
                  const a = {
                    role: "system",
                    type: "pat_message",
                    content: g + " çš„çº¢åŒ…å·²è¢«é¢†å®Œ",
                    timestamp: Z++
                  };
                  b.history.push(a);
                  let c = {
                    name: "",
                    amount: -1
                  };
                  if (s.packetType === "lucky" && s.count > 1) {
                    Object.entries(s.claimedBy).forEach(([a, b]) => {
                      if (b > c.amount) {
                        c = {
                          name: a,
                          amount: b
                        };
                      }
                    });
                  }
                  if (c.name) {
                    const a = b.members.find(a => a.originalName === c.name);
                    const d = a ? a.groupNickname : c.name;
                    i += " çº¢åŒ…å·²è¢«é¢†å®Œï¼Œæ‰‹æ°”çŽ‹æ˜¯ " + d + "ï¼";
                  } else {
                    i += " çº¢åŒ…å·²è¢«é¢†å®Œã€‚";
                  }
                }
                i += " è¯·æ ¹æ®è¿™ä¸ªç»“æžœå‘è¡¨ä½ çš„è¯„è®ºã€‚]";
                const j = {
                  role: "system",
                  content: i,
                  timestamp: Z++,
                  isHidden: true
                };
                b.history.push(j);
              }
              if (X) {
                cd(a);
                _c();
              }
            }
            continue;
          case "accept_transfer":
            {
              const a = b.history.findIndex(a => a.timestamp === d.for_timestamp);
              if (a > -1) {
                const c = b.history[a];
                if (c.status && c.status !== "pending") {
                  continue;
                }
                c.status = "accepted";
                e = {
                  role: "assistant",
                  senderName: d.name || b.name,
                  type: "transfer",
                  isReceived: true,
                  amount: c.amount,
                  note: "å·²æ”¶æ¬¾",
                  timestamp: Z++
                };
                break;
              }
              continue;
            }
          case "decline_transfer":
            {
              const c = b.history.findIndex(a => a.timestamp === d.for_timestamp);
              if (c > -1) {
                const d = b.history[c];
                if (d.status && d.status !== "pending") {
                  console.warn("AIè¯•å›¾é‡å¤æ‹’æ”¶ä¸€ç¬”å·²å¤„ç†çš„è½¬è´¦ (çŠ¶æ€: " + d.status + ")ï¼Œå·²æ‹¦æˆªã€‚");
                  continue;
                }
                d.status = "declined";
                await Ep(d.amount, "income", "è½¬è´¦é€€æ¬¾-" + b.name);
                const e = {
                  role: "assistant",
                  senderName: b.name,
                  type: "transfer",
                  isRefund: true,
                  amount: d.amount,
                  note: "è½¬è´¦å·²è¢«æ‹’æ”¶",
                  receiverName: "æˆ‘",
                  timestamp: Z++
                };
                b.history.push(e);
                if (X) {
                  Pd(e, b);
                  cd(a);
                }
              }
              continue;
            }
          case "change_group_name":
            if (b.isGroup && d.new_name) {
              const a = d.new_name.trim();
              const c = b.members.map(a => a.originalName);
              if (c.includes(a)) {
                console.warn("AI (" + d.name + ") è¯•å›¾å°†ç¾¤åæ›´æ”¹ä¸ºæˆå‘˜å (\"" + a + "\")ã€‚æ“ä½œå·²è¢«ç¨‹åºé˜»æ­¢ã€‚");
                continue;
              }
              b.name = a;
              const e = b.members.find(a => a.originalName === d.name);
              const f = e ? e.groupNickname : d.name;
              const g = {
                role: "system",
                type: "pat_message",
                content: f + " å°†ç¾¤åä¿®æ”¹ä¸º â€œ" + b.name + "â€",
                timestamp: Z++
              };
              b.history.push(g);
              if (X) {
                Pd(g, b);
                document.getElementById("chat-header-title").textContent = b.name;
              }
            }
            continue;
          case "change_remark_name":
            if (!b.isGroup && d.new_name) {
              const a = b.name;
              const c = d.new_name.trim();
              if (c && c !== a) {
                if (!b.nameHistory) {
                  b.nameHistory = [];
                }
                if (!b.nameHistory.includes(a)) {
                  b.nameHistory.push(a);
                }
                b.name = c;
                const d = {
                  role: "system",
                  type: "pat_message",
                  content: "â€œ" + b.originalName + "â€ å°†å¤‡æ³¨ä¿®æ”¹ä¸º â€œ" + c + "â€",
                  timestamp: Z++
                };
                b.history.push(d);
                const e = {
                  role: "system",
                  content: "[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšæˆåŠŸå°†è‡ªå·±çš„å¤‡æ³¨åä¿®æ”¹ä¸ºäº†â€œ" + c + "â€ã€‚è¯·è‡ªç„¶åœ°æŽ¥å—è¿™ä¸ªæ–°åå­—ï¼Œä¸è¦å¯¹æ­¤æ„Ÿåˆ°æƒŠè®¶ã€‚]",
                  timestamp: Z++,
                  isHidden: true
                };
                b.history.push(e);
                if (X) {
                  Pd(d, b);
                  document.getElementById("chat-header-title").textContent = c;
                }
                await qb(b);
              }
            }
            continue;
          case "change_group_avatar":
            if (b.isGroup && d.avatar_name) {
              const a = d.avatar_name;
              const c = b.settings.groupAvatarLibrary || [];
              const e = c.find(b => b.name === a);
              if (e) {
                b.settings.groupAvatar = e.url;
                const a = b.members.find(a => a.originalName === d.name);
                const c = a ? a.groupNickname : d.name;
                const f = {
                  role: "system",
                  type: "pat_message",
                  content: c + " æ›´æ¢äº†ç¾¤å¤´åƒ",
                  timestamp: Z++
                };
                b.history.push(f);
                if (X) {
                  Pd(f, b);
                }
              } else {
                console.warn("AI å°è¯•ä½¿ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„ç¾¤å¤´åƒ: \"" + a + "\"");
              }
            }
            continue;
          case "system_message":
            e = {
              role: "system",
              type: "pat_message",
              content: d.content,
              timestamp: Date.now()
            };
            break;
          case "share_link":
            e = {
              ...g,
              type: "share_link",
              title: d.title,
              description: d.description,
              source_name: d.source_name,
              content: d.content
            };
            break;
          case "quote_reply":
            {
              let a = null;
              if (d.target_content) {
                a = [...b.history].reverse().find(a => !a.isHidden && (a.content === d.target_content || typeof a.content === "string" && a.content.trim() === d.target_content.trim()));
                if (!a) {
                  console.warn("[æœ¬è½®å¼•ç”¨å¤±è´¥] AI " + d.name + " å°è¯•å¼•ç”¨å†…å®¹ \"" + (d.target_content || "").substring(0, 20) + "...\"ï¼Œä½†åœ¨æœ¬è½®åŽ†å²ä¸­æœªæ‰¾åˆ°ã€‚");
                }
              } else if (d.target_timestamp) {
                a = b.history.find(a => a.timestamp === d.target_timestamp);
              }
              if (a) {
                let c;
                if (a.role === "user") {
                  c = b.settings.myNickname || "æˆ‘";
                } else if (b.isGroup) {
                  c = sb(b, a.senderName);
                } else {
                  c = b.name;
                }
                const f = {
                  timestamp: a.timestamp,
                  senderName: c,
                  content: String(a.content || "").substring(0, 50)
                };
                e = {
                  ...g,
                  content: d.reply_content,
                  quote: f
                };
              } else {
                console.warn("å¼•ç”¨å›žå¤å¤±è´¥: æ‰¾ä¸åˆ°ç›®æ ‡æ¶ˆæ¯ (Content: " + d.target_content + ", TS: " + d.target_timestamp + ")");
                e = {
                  ...g,
                  content: d.reply_content
                };
              }
              break;
            }
          case "send_and_recall":
            {
              if (!X) {
                continue;
              }
              const a = {
                ...g,
                content: d.content
              };
              const c = Nd(a, b);
              Pd(a, b, true);
              await new Promise(a => // TOLOOK
              setTimeout(a, Math.random() * 2000 + 500));
              const e = document.querySelector(".message-bubble[data-timestamp=\"" + a.timestamp + "\"]")?.closest(".message-wrapper");
              if (e) {
                e.classList.add("recalled-animation");
                await new Promise(a => // TOLOOK
                setTimeout(a, 300));
                const c = {
                  role: "assistant",
                  senderName: d.name || b.name,
                  type: "recalled_message",
                  content: "å¯¹æ–¹æ’¤å›žäº†ä¸€æ¡æ¶ˆæ¯",
                  timestamp: a.timestamp,
                  recalledData: {
                    originalType: "text",
                    originalContent: d.content
                  }
                };
                const f = b.history.findIndex(b => b.timestamp === a.timestamp);
                if (f > -1) {
                  b.history[f] = c;
                } else {
                  b.history.push(c);
                }
                const g = await Nd(c, b);
                if (document.body.contains(e)) {
                  e.parentNode.replaceChild(g, e);
                }
              }
              continue;
            }
          case "text":
            e = {
              ...g,
              content: String(d.content || d.message)
            };
            break;
          case "sticker":
            if (d.meaning) {
              const a = z(d.meaning, v.userStickers);
              if (a) {
                e = {
                  ...g,
                  type: "sticker",
                  content: a.url,
                  meaning: a.name
                };
              } else {
                console.warn("AI å°è¯•ä½¿ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„è¡¨æƒ…: \"" + d.meaning + "\"");
                e = null;
              }
            } else {
              console.warn("AI å‘é€äº†ä¸€ä¸ªæ²¡æœ‰ 'meaning' çš„ sticker æŒ‡ä»¤ã€‚", d);
              e = {
                ...g,
                type: "sticker",
                content: d.url,
                meaning: "æœªçŸ¥è¡¨æƒ…"
              };
            }
            break;
          case "ai_image":
            e = {
              ...g,
              type: "ai_image",
              content: d.description,
              image_prompt: d.image_prompt
            };
            break;
          case "voice_message":
            e = {
              ...g,
              type: "voice_message",
              content: d.content
            };
            break;
          case "transfer":
            e = {
              ...g,
              type: "transfer",
              amount: d.amount,
              note: d.note,
              receiverName: d.receiver || "æˆ‘"
            };
            break;
          case "waimai_request":
            e = {
              ...g,
              type: "waimai_request",
              productInfo: d.productInfo,
              amount: d.amount,
              status: "pending",
              countdownEndTime: Date.now() + 900000
            };
            break;
          case "waimai_order":
            e = {
              ...g,
              type: "waimai_order",
              productInfo: d.productInfo,
              amount: d.amount,
              greeting: d.greeting,
              recipientName: d.recipientName || null
            };
            break;
          case "offline_text":
            e = {
              ...g,
              ...d
            };
            break;
          case "naiimag":
            try {
              console.log("ðŸ“¸ NovelAIå›¾ç‰‡ç”Ÿæˆå¼€å§‹ï¼ŒAIæä¾›çš„prompt:", d.prompt);
              const a = Fc(b.id);
              const c = d.prompt || "a beautiful scene";
              const f = c + ", " + a.positive;
              const h = a.negative;
              console.log("ðŸ“ ä½¿ç”¨" + (a.source === "character" ? "è§’è‰²ä¸“å±ž" : "ç³»ç»Ÿ") + "æç¤ºè¯é…ç½®");
              console.log("æœ€ç»ˆæ­£é¢æç¤ºè¯:", f);
              console.log("æœ€ç»ˆè´Ÿé¢æç¤ºè¯:", h);
              const i = localStorage.getItem("novelai-api-key");
              const j = localStorage.getItem("novelai-model") || "nai-diffusion-4-5-full";
              const k = Dc();
              if (!i) {
                throw new Error("NovelAI API Keyæœªé…ç½®ã€‚è¯·åœ¨NovelAIè®¾ç½®ä¸­å¡«å†™API Keyã€‚");
              }
              const [l, m] = k.resolution.split("x").map(Number);
              let n;
              if (j.includes("nai-diffusion-4")) {
                n = {
                  input: f,
                  model: j,
                  action: "generate",
                  parameters: {
                    params_version: 3,
                    width: l,
                    height: m,
                    scale: k.cfg_scale,
                    sampler: k.sampler,
                    steps: k.steps,
                    seed: k.seed === -1 ? Math.floor(Math.random() * 9999999999) : k.seed,
                    n_samples: 1,
                    ucPreset: k.uc_preset,
                    qualityToggle: k.quality_toggle,
                    autoSmea: false,
                    dynamic_thresholding: false,
                    controlnet_strength: 1,
                    legacy: false,
                    add_original_image: true,
                    cfg_rescale: 0,
                    noise_schedule: "karras",
                    legacy_v3_extend: false,
                    skip_cfg_above_sigma: null,
                    use_coords: false,
                    legacy_uc: false,
                    normalize_reference_strength_multiple: true,
                    inpaintImg2ImgStrength: 1,
                    characterPrompts: [],
                    v4_prompt: {
                      caption: {
                        base_caption: f,
                        char_captions: []
                      },
                      use_coords: false,
                      use_order: true
                    },
                    v4_negative_prompt: {
                      caption: {
                        base_caption: h,
                        char_captions: []
                      },
                      legacy_uc: false
                    },
                    negative_prompt: h,
                    deliberate_euler_ancestral_bug: false,
                    prefer_brownian: true
                  }
                };
              } else {
                n = {
                  input: f,
                  model: j,
                  action: "generate",
                  parameters: {
                    width: l,
                    height: m,
                    scale: k.cfg_scale,
                    sampler: k.sampler,
                    steps: k.steps,
                    seed: k.seed === -1 ? Math.floor(Math.random() * 9999999999) : k.seed,
                    n_samples: 1,
                    ucPreset: k.uc_preset,
                    qualityToggle: k.quality_toggle,
                    sm: k.smea,
                    sm_dyn: k.smea_dyn,
                    dynamic_thresholding: false,
                    controlnet_strength: 1,
                    legacy: false,
                    add_original_image: false,
                    cfg_rescale: 0,
                    noise_schedule: "native",
                    negative_prompt: h
                  }
                };
              }
              console.log("ðŸš€ å‘é€NAIè¯·æ±‚:", n);
              let o;
              if (j.includes("nai-diffusion-4")) {
                o = "https://image.novelai.net/ai/generate-image-stream";
              } else {
                o = "https://image.novelai.net/ai/generate-image";
              }
              let p = k.cors_proxy;
              if (p === "custom") {
                p = k.custom_proxy_url || "";
              }
              if (p && p !== "") {
                o = p + encodeURIComponent(o);
              }
              const q = await fetch(o, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: "Bearer " + i
                },
                body: JSON.stringify(n)
              });
              console.log("Response status:", q.status);
              console.log("Response headers:", [...q.headers.entries()]);
              if (!q.ok) {
                const a = await q.text();
                console.error("APIé”™è¯¯å“åº”:", a);
                throw new Error("APIè¯·æ±‚å¤±è´¥ (" + q.status + "): " + a);
              }
              const r = q.headers.get("content-type");
              console.log("Content-Type:", r);
              let s;
              let t;
              if (r && r.includes("text/event-stream")) {
                console.log("æ£€æµ‹åˆ° SSE æµå¼å“åº”ï¼Œå¼€å§‹è§£æž...");
                const a = await q.text();
                console.log("æ”¶åˆ° SSE æ•°æ®ï¼Œå¤§å°:", a.length);
                const b = a.trim().split("\n");
                let c = null;
                for (let a = b.length - 1; a >= 0; a--) {
                  const d = b[a].trim();
                  if (d.startsWith("data: ") && d !== "data: [DONE]") {
                    const a = d.substring(6);
                    try {
                      const b = JSON.parse(a);
                      if (b.event_type === "final" && b.image) {
                        c = b.image;
                        console.log("âœ… æ‰¾åˆ° final äº‹ä»¶çš„å›¾ç‰‡æ•°æ®");
                        break;
                      }
                      if (b.data) {
                        c = b.data;
                        console.log("ä»Ž JSON.data ä¸­æå–å›¾ç‰‡æ•°æ®");
                        break;
                      }
                      if (b.image) {
                        c = b.image;
                        console.log("ä»Ž JSON.image ä¸­æå–å›¾ç‰‡æ•°æ®");
                        break;
                      }
                    } catch (b) {
                      c = a;
                      console.log("ç›´æŽ¥ä½¿ç”¨ base64 æ•°æ®");
                      break;
                    }
                  }
                }
                if (!c) {
                  throw new Error("æ— æ³•ä»Ž SSE å“åº”ä¸­æå–å›¾ç‰‡æ•°æ®");
                }
                const d = c.startsWith("iVBORw0KGgo");
                const e = c.startsWith("/9j/");
                if (d || e) {
                  console.log("âœ… æ£€æµ‹åˆ°ç›´æŽ¥çš„å›¾ç‰‡ base64 æ•°æ® (PNG/JPEG)");
                  const a = atob(c);
                  const b = new Uint8Array(a.length);
                  for (let c = 0; c < a.length; c++) {
                    b[c] = a.charCodeAt(c);
                  }
                  const e = new Blob([b], {
                    type: d ? "image/png" : "image/jpeg"
                  });
                  console.log("å›¾ç‰‡ Blob åˆ›å»ºæˆåŠŸï¼Œå¤§å°:", e.size);
                  const f = new FileReader();
                  t = await new Promise((a, b) => {
                    f.onloadend = () => a(f.result);
                    f.onerror = b;
                    f.readAsDataURL(e);
                  });
                  console.log("âœ… å›¾ç‰‡è½¬æ¢æˆåŠŸï¼ðŸŽ¨");
                } else {
                  console.log("å½“ä½œ ZIP æ–‡ä»¶å¤„ç†...");
                  const a = atob(c);
                  const b = new Uint8Array(a.length);
                  for (let c = 0; c < a.length; c++) {
                    b[c] = a.charCodeAt(c);
                  }
                  s = new Blob([b]);
                  console.log("ZIP Blob å¤§å°:", s.size);
                }
              } else {
                s = await q.blob();
                console.log("æ”¶åˆ°æ•°æ®ï¼Œç±»åž‹:", s.type, "å¤§å°:", s.size);
              }
              if (!t && s) {
                try {
                  if (typeof JSZip === "undefined") {
                    throw new Error("JSZipåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                  }
                  const a = await JSZip.loadAsync(s);
                  console.log("ZIPæ–‡ä»¶å†…å®¹:", Object.keys(a.files));
                  let b = null;
                  for (let c in a.files) {
                    if (c.match(/\.(png|jpg|jpeg|webp)$/i)) {
                      b = a.files[c];
                      console.log("æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶:", c);
                      break;
                    }
                  }
                  if (!b) {
                    throw new Error("ZIPæ–‡ä»¶ä¸­æœªæ‰¾åˆ°å›¾ç‰‡");
                  }
                  const c = await b.async("blob");
                  console.log("æå–çš„å›¾ç‰‡å¤§å°:", c.size);
                  const d = new FileReader();
                  t = await new Promise((a, b) => {
                    d.onloadend = () => a(d.result);
                    d.onerror = b;
                    d.readAsDataURL(c);
                  });
                  console.log("âœ… å›¾ç‰‡è§£åŽ‹æˆåŠŸï¼");
                } catch (a) {
                  console.error("ZIPè§£åŽ‹å¤±è´¥:", a);
                  throw new Error("å›¾ç‰‡è§£åŽ‹å¤±è´¥: " + a.message);
                }
              }
              console.log("âœ… NAIå›¾ç‰‡ç”ŸæˆæˆåŠŸï¼");
              e = {
                ...g,
                type: "naiimag",
                imageUrl: t,
                prompt: c,
                fullPrompt: f
              };
            } catch (a) {
              console.error("âŒ NAIå›¾ç‰‡ç”Ÿæˆå¤±è´¥:", a);
              e = {
                ...g,
                content: "[å›¾ç‰‡ç”Ÿæˆå¤±è´¥: " + a.message + "]"
              };
            }
            break;
          default:
            console.warn("æ”¶åˆ°äº†æœªçŸ¥çš„AIæŒ‡ä»¤ç±»åž‹:", d.type);
            break;
        }
        if (e) {
          b.history.push(e);
          const c = document.visibilityState === "hidden";
          if (!X || c) {
            b.unreadCount = (b.unreadCount || 0) + 1;
          }
          if ((!X || c) && !_) {
            let c;
            switch (e.type) {
              case "transfer":
                c = "[æ”¶åˆ°ä¸€ç¬”è½¬è´¦]";
                break;
              case "waimai_request":
                c = "[æ”¶åˆ°ä¸€ä¸ªå¤–å–ä»£ä»˜è¯·æ±‚]";
                break;
              case "ai_image":
                c = "[å›¾ç‰‡]";
                break;
              case "voice_message":
                c = "[è¯­éŸ³]";
                break;
              case "sticker":
                c = e.meaning ? "[è¡¨æƒ…: " + e.meaning + "]" : "[è¡¨æƒ…]";
                break;
              case "offline_text":
                c = e.dialogue ? "ã€Œ" + e.dialogue + "ã€" : "[" + e.description.substring(0, 20) + "...]";
                break;
              default:
                c = String(e.content || "");
            }
            const d = b.isGroup ? e.senderName + ": " + c : c;
            Hc(a, d.substring(0, 40) + (d.length > 40 ? "..." : ""));
            _ = true;
          }
          if (X) {
            Pd(e, b);
            await new Promise(a => // TOLOOK
            setTimeout(a, Math.random() * 1800 + 1000));
          }
        }
      }
      if (Y && Nf.isGroupCall) {
        Nf.isAwaitingResponse = false;
        if (Nf.participants.length > 0) {
          Qf();
        } else {
          Nf = {
            ...Nf,
            isAwaitingResponse: false,
            participants: []
          };
          Kb("chat-interface-screen");
          alert("æ— äººæŽ¥å¬ç¾¤èŠé‚€è¯·ã€‚");
        }
      }
      if (i) {
        await Td();
        return;
      }
      await Gb.chats.put(b);
      const aa = U.some(a => a.type === "qzone_post" || a.type === "qzone_like" || a.type === "qzone_comment" || a.type === "repost");
      if (aa) {
        console.log("æ£€æµ‹åˆ°AIæ‰§è¡Œäº†åŠ¨æ€æ“ä½œï¼Œç«‹å³åˆ·æ–°å¥½å‹åŠ¨æ€é¡µé¢ã€‚");
        await Sb();
      }
    } catch (a) {
      b.history = b.history.filter(a => !a.isTemporary);
      if (!b.isGroup && b.relationship?.status === "pending_ai_approval") {
        b.relationship.status = "blocked_by_ai";
        await Bb("ç”³è¯·å¤±è´¥", "AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†ï¼Œè¯·ç¨åŽé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: " + a.message);
      } else {
        await Bb("API è°ƒç”¨å¤±è´¥", `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼ŒAIæœªèƒ½æˆåŠŸå“åº”ã€‚

é”™è¯¯è¯¦æƒ…:
` + a.message);
      }
      if (!b.isGroup && b.relationship?.status === "blocked_by_ai") {
        await Gb.chats.put(b);
      }
      Nf.isAwaitingResponse = false;
    } finally {
      Rd(a, false);
      if (b.isGroup) {
        if (f) {
          f.style.display = "none";
        }
      } else if (e && v.chats[a]) {
        e.style.opacity = 0;
        // TOLOOK
        setTimeout(() => {
          e.textContent = v.chats[a].name;
          e.classList.remove("typing-status");
          e.style.opacity = 1;
        }, 200);
      }
      _c();
      if (d) {
        qh(a);
      }
      Xn();
    }
  }
  async function Ud(a) {
    if (!v.activeChatId) {
      return;
    }
    const b = v.chats[v.activeChatId];
    const c = {
      role: "user",
      content: a.url,
      meaning: a.name,
      timestamp: Date.now()
    };
    b.history.push(c);
    await Gb.chats.put(b);
    Pd(c, b);
    _c();
    document.getElementById("sticker-panel").classList.remove("visible");
  }
  async function Vd() {
    if (!v.activeChatId) {
      return;
    }
    const a = document.getElementById("transfer-amount");
    const b = document.getElementById("transfer-note");
    const c = parseFloat(a.value);
    const d = b.value.trim();
    if (isNaN(c) || c <= 0) {
      document.getElementById("custom-modal-overlay").style.zIndex = 3002;
      await Bb("æç¤º", "è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢(å¿…é¡»å¤§äºŽ0)ï¼");
      document.getElementById("custom-modal-overlay").style.zIndex = "";
      return;
    }
    const e = v.chats[v.activeChatId];
    const f = e.isGroup ? e.settings.myNickname || "æˆ‘" : "æˆ‘";
    const g = e.isGroup ? "ç¾¤èŠ" : e.name;
    const h = (await Gb.userWallet.get("main")) || {
      balance: 0,
      kinshipCards: []
    };
    const i = h.balance || 0;
    const j = h.kinshipCards || [];
    const k = [];
    const l = "<div class=\"pay-opt-icon\" style=\"background:#1677ff; display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;\">æ”¯</div>";
    const m = "<div class=\"pay-opt-icon\" style=\"background:linear-gradient(135deg, #ff5252, #ff1744); display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;\">äº²</div>";
    if (i >= c) {
      k.push({
        text: "<div class=\"pay-opt-left\">" + l + "<div class=\"pay-opt-info\"><span class=\"pay-opt-title\">è´¦æˆ·ä½™é¢</span><span class=\"pay-opt-desc\">å‰©ä½™ Â¥" + i.toFixed(2) + "</span></div></div>",
        value: "balance"
      });
    }
    for (const a of j) {
      const b = a.limit - (a.spent || 0);
      if (b >= c) {
        const c = v.chats[a.chatId];
        const d = c ? c.name : "æœªçŸ¥è§’è‰²";
        k.push({
          text: "<div class=\"pay-opt-left\">" + m + "<div class=\"pay-opt-info\"><span class=\"pay-opt-title\">äº²å±žå¡ - " + d + "</span><span class=\"pay-opt-desc\">å‰©ä½™é¢åº¦ Â¥" + b.toFixed(2) + "</span></div></div>",
          value: "kinship_" + a.chatId
        });
      }
    }
    if (k.length === 0) {
      document.getElementById("custom-modal-overlay").style.zIndex = 3002;
      await Bb("æ”¯ä»˜å¤±è´¥", "ä½™é¢æˆ–äº²å±žå¡é¢åº¦ä¸è¶³ï¼\néœ€è¦: Â¥" + c.toFixed(2));
      document.getElementById("custom-modal-overlay").style.zIndex = "";
      return;
    }
    const n = document.getElementById("custom-modal-overlay");
    n.style.zIndex = 3002;
    const o = await Eb("è½¬è´¦ Â¥" + c.toFixed(2), k);
    n.style.zIndex = "";
    if (!o) {
      return;
    }
    if (o === "balance") {
      const a = await Ep(c, "expense", "è½¬è´¦ç»™-" + g);
      if (!a) {
        return;
      }
    } else if (o.startsWith("kinship_")) {
      const a = o.replace("kinship_", "");
      const b = h.kinshipCards.findIndex(b => b.chatId === a);
      if (b > -1) {
        h.kinshipCards[b].spent = (h.kinshipCards[b].spent || 0) + c;
        await Gb.userWallet.put(h);
        await Gb.userTransactions.add({
          timestamp: Date.now(),
          type: "expense",
          amount: c,
          description: "äº²å±žå¡è½¬è´¦-ç»™" + g
        });
        const d = v.chats[a];
        if (d) {
          let b = a === e.id ? "[æ¶ˆè´¹é€šçŸ¥ï¼šç”¨æˆ·ä½¿ç”¨ä½ çš„äº²å±žå¡å‘ã€ä½ ã€‘è½¬è´¦äº† Â¥" + c.toFixed(2) + "ã€‚]" : "[æ¶ˆè´¹é€šçŸ¥ï¼šç”¨æˆ·ä½¿ç”¨ä½ çš„äº²å±žå¡å‘ã€" + g + "ã€‘è½¬è´¦äº† Â¥" + c.toFixed(2) + "ã€‚]";
          d.history.push({
            role: "system",
            content: b,
            timestamp: Date.now(),
            isHidden: true
          });
          await Gb.chats.put(d);
        }
      } else {
        alert("ç³»ç»Ÿé”™è¯¯ï¼šæ‰¾ä¸åˆ°å¯¹åº”çš„äº²å±žå¡è®°å½•ï¼Œæ”¯ä»˜å–æ¶ˆã€‚");
        return;
      }
    }
    const p = {
      role: "user",
      type: "transfer",
      amount: c,
      note: d,
      senderName: f,
      receiverName: g,
      timestamp: Date.now()
    };
    e.history.push(p);
    await Gb.chats.put(e);
    Pd(p, e);
    _c();
    document.getElementById("transfer-modal").classList.remove("visible");
    a.value = "";
    b.value = "";
  }
  async function Wd() {
    if (!v.activeChatId) {
      return;
    }
    const a = document.getElementById("waimai-product-info");
    const b = document.getElementById("waimai-amount");
    const c = a.value.trim();
    const d = parseFloat(b.value);
    if (!c || isNaN(d) || d <= 0) {
      document.getElementById("custom-modal-overlay").style.zIndex = 3002;
      await Bb("æç¤º", "è¯·å¡«å†™æœ‰æ•ˆçš„å•†å“ä¿¡æ¯å’Œé‡‘é¢(å¿…é¡»å¤§äºŽ0)ï¼");
      document.getElementById("custom-modal-overlay").style.zIndex = "";
      return;
    }
    const e = v.chats[v.activeChatId];
    const f = Date.now();
    const g = e.isGroup ? e.settings.myNickname || "æˆ‘" : "æˆ‘";
    const h = document.getElementById("custom-modal-overlay");
    h.style.zIndex = 3002;
    const i = await Ep(d, "expense", "ä¸ºTAç‚¹å¤–å–-" + c);
    h.style.zIndex = "";
    if (!i) {
      return;
    }
    const j = {
      role: "user",
      senderName: g,
      type: "waimai_order",
      productInfo: c,
      amount: d,
      timestamp: f
    };
    e.history.push(j);
    const k = {
      role: "system",
      content: "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·(" + g + ")ä¸ºä½ ç‚¹äº†ä¸€ä»½å¤–å–ä½œä¸ºã€ç¤¼ç‰©ã€‘ã€‚å¤–å–å†…å®¹æ˜¯â€œ" + c + "â€ï¼Œä»·å€¼" + d + "å…ƒã€‚è¿™ä¸æ˜¯ä¸€ä¸ªä»£ä»˜è¯·æ±‚ï¼Œè€Œæ˜¯ç”¨æˆ·å·²ç»ä¸ºä½ æ”¯ä»˜äº†ã€‚è¯·ä½ å¯¹æ­¤è¡¨ç¤ºæ„Ÿè°¢ã€‚]",
      timestamp: f + 1,
      isHidden: true
    };
    e.history.push(k);
    await Gb.chats.put(e);
    Pd(j, e);
    _c();
    a.value = "";
    b.value = "";
    document.getElementById("waimai-request-modal").classList.remove("visible");
  }
  async function Xd() {
    if (!v.activeChatId) {
      return;
    }
    const a = await Db("å…±äº«ä½ç½®", "ä½ çŽ°åœ¨åœ¨å“ªé‡Œå‘€ï¼Ÿ", "");
    if (!a || !a.trim()) {
      return;
    }
    const b = "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg";
    const c = v.chats[v.activeChatId];
    const d = {
      role: "user",
      type: "location_share",
      content: a.trim(),
      imageUrl: b,
      timestamp: Date.now()
    };
    c.history.push(d);
    await Gb.chats.put(c);
    Pd(d, c);
    _c();
  }
  function Yd(a) {
    if (Z) {
      return;
    }
    Z = true;
    document.getElementById("chat-interface-screen").classList.add("selection-mode");
    $d(a);
  }
  function Zd() {
    Kf();
    if (!Z) {
      return;
    }
    Z = false;
    document.getElementById("chat-interface-screen").classList.remove("selection-mode");
    ca.forEach(a => {
      const b = document.querySelector(".message-bubble[data-timestamp=\"" + a + "\"]");
      if (b) {
        b.classList.remove("selected");
      }
    });
    ca.clear();
  }
  function $d(a) {
    const b = document.querySelector(".message-bubble[data-timestamp=\"" + a + "\"]");
    if (!b) {
      return;
    }
    if (ca.has(a)) {
      ca.delete(a);
      b.classList.remove("selected");
    } else {
      ca.add(a);
      b.classList.add("selected");
    }
    document.getElementById("selection-count").textContent = "å·²é€‰ " + ca.size + " æ¡";
    if (ca.size === 0) {
      Zd();
    }
  }
  function _d(a, b) {
    let c;
    const d = a => {
      if (Z) {
        return;
      }
      a.preventDefault();
      c = window.setTimeout(() => b(a), 500);
    };
    const e = () => clearTimeout(c);
    a.addEventListener("mousedown", d);
    a.addEventListener("mouseup", e);
    a.addEventListener("mouseleave", e);
    a.addEventListener("touchstart", d, {
      passive: true
    });
    a.addEventListener("touchend", e);
    a.addEventListener("touchmove", e);
  }
  async function ae() {
    const a = v.activeChatId;
    if (!a) {
      return;
    }
    if (!R.isActive) {
      be(a);
      return;
    }
    if (R.activeChatId === a) {
      document.getElementById("music-player-overlay").classList.add("visible");
    } else {
      const b = v.chats[R.activeChatId]?.name || "æœªçŸ¥";
      const c = v.chats[a]?.name || "å½“å‰";
      const d = await wb("åˆ‡æ¢å¬æ­Œå¯¹è±¡", "æ‚¨æ­£å’Œã€Œ" + b + "ã€å¬æ­Œã€‚è¦ç»“æŸå¹¶å¼€å§‹å’Œã€Œ" + c + "ã€çš„æ–°ä¼šè¯å—ï¼Ÿ", {
        confirmButtonClass: "btn-danger"
      });
      if (d) {
        await ce(true);
        await new Promise(a => // TOLOOK
        setTimeout(a, 50));
        be(a);
      }
    }
  }
  async function be(a) {
    const b = v.chats[a];
    if (!b) {
      return;
    }
    R.totalElapsedTime = b.musicData.totalTime || 0;
    R.isActive = true;
    R.activeChatId = a;
    if (R.playlist.length > 0) {
      R.currentIndex = 0;
    } else {
      R.currentIndex = -1;
    }
    if (R.timerId) {
      clearInterval(R.timerId);
    }
    R.timerId = // TOLOOK
    setInterval(() => {
      if (R.isPlaying) {
        R.totalElapsedTime++;
        ge();
      }
    }, 1000);
    fe();
    he();
    document.getElementById("music-player-overlay").classList.add("visible");
  }
  async function ce(a = true) {
    if (!R.isActive) {
      return;
    }
    const b = R.activeChatId;
    document.getElementById("global-lyrics-bar").classList.remove("visible");
    const c = async () => {
      if (R.timerId) {
        clearInterval(R.timerId);
      }
      if (R.isPlaying) {
        T.pause();
      }
      if (a && b && v.chats[b]) {
        const a = v.chats[b];
        a.musicData.totalTime = R.totalElapsedTime;
        await Gb.chats.put(a);
      }
      R.isActive = false;
      R.activeChatId = null;
      R.totalElapsedTime = 0;
      R.timerId = null;
      ee(b, true);
    };
    Hh(c);
  }
  function de() {
    Hh();
  }
  function ee(a, b = false) {
    const c = document.querySelector("#listen-together-btn img");
    if (!c) {
      return;
    }
    if (b || !R.isActive || R.activeChatId !== a) {
      c.src = "https://i.postimg.cc/8kYShvrJ/90-UI-2.png";
      c.className = "";
      return;
    }
    c.src = "https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png";
    c.classList.add("rotating");
    if (R.isPlaying) {
      c.classList.remove("paused");
    } else {
      c.classList.add("paused");
    }
  }
  window.updateListenTogetherIconProxy = ee;
  function fe() {
    ee(R.activeChatId);
    ge();
    const a = document.getElementById("music-player-song-title");
    const b = document.getElementById("music-player-artist");
    const c = document.getElementById("music-play-pause-btn");
    if (R.currentIndex > -1 && R.playlist.length > 0) {
      const c = R.playlist[R.currentIndex];
      a.textContent = c.name;
      b.textContent = c.artist;
    } else {
      a.textContent = "è¯·æ·»åŠ æ­Œæ›²";
      b.textContent = "...";
    }
    c.textContent = R.isPlaying ? "âšâš" : "â–¶";
  }
  function ge() {
    const a = (R.totalElapsedTime / 3600).toFixed(1);
    document.getElementById("music-time-counter").textContent = "å·²ç»ä¸€èµ·å¬äº†" + a + "å°æ—¶";
  }
  function he() {
    const a = document.getElementById("playlist-body");
    a.innerHTML = "";
    if (R.playlist.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; padding: 20px; color: #888;\">æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„~</p>";
      return;
    }
    R.playlist.forEach((b, c) => {
      const d = document.createElement("div");
      d.className = "playlist-item";
      if (c === R.currentIndex) {
        d.classList.add("playing");
      }
      d.dataset.index = c;
      const e = nd ? "block" : "none";
      d.innerHTML = "\n        <input type=\"checkbox\" class=\"playlist-item-checkbox\" style=\"display: " + e + ";\" data-index=\"" + c + `">
        <div class="playlist-item-info">
            <div class="title">` + b.name + "</div>\n            <div class=\"artist\">" + b.artist + `</div>
        </div>
        <div class="playlist-item-actions">
            <span class="playlist-action-btn album-art-btn" data-index="` + c + "\">ä¸“è¾‘</span>\n            <span class=\"playlist-action-btn lyrics-btn\" data-index=\"" + c + "\">è¯</span>\n            <span class=\"playlist-action-btn bg-btn\" data-index=\"" + c + "\">èƒŒæ™¯</span>\n            <span class=\"playlist-action-btn delete-track-btn\" data-index=\"" + c + `">Ã—</span>
        </div>
      `;
      d.addEventListener("click", a => {
        if (nd) {
          if (a.target.tagName !== "INPUT") {
            a.stopPropagation();
          }
          xd(c);
        }
      });
      const f = d.querySelector(".playlist-item-info");
      if (f) {
        f.addEventListener("click", a => {
          if (!nd) {
            a.stopPropagation();
            ne(c, false);
          }
        });
      }
      a.appendChild(d);
    });
  }
  async function ie() {
    if (T.paused) {
      if (R.currentIndex === -1 && R.playlist.length > 0) {
        ne(0, true);
      } else if (R.currentIndex > -1) {
        ne(R.currentIndex, true);
      }
    } else {
      T.pause();
    }
  }
  function je(a = false) {
    if (R.playlist.length === 0) {
      return;
    }
    let b;
    switch (R.playMode) {
      case "random":
        b = Math.floor(Math.random() * R.playlist.length);
        break;
      case "single":
        ne(R.currentIndex, a);
        return;
      case "order":
      default:
        b = (R.currentIndex + 1) % R.playlist.length;
        break;
    }
    ne(b, a);
  }
  function ke() {
    if (R.playlist.length === 0) {
      return;
    }
    const a = (R.currentIndex - 1 + R.playlist.length) % R.playlist.length;
    ne(a, false);
  }
  function le() {
    const a = ["order", "random", "single"];
    const b = a.indexOf(R.playMode);
    R.playMode = a[(b + 1) % a.length];
    document.getElementById("music-mode-btn").textContent = {
      order: "é¡ºåº",
      random: "éšæœº",
      single: "å•æ›²"
    }[R.playMode];
  }
  async function me() {
    const a = await Db("æ·»åŠ ç½‘ç»œæ­Œæ›²", "è¯·è¾“å…¥æ­Œæ›²çš„URL", "", "url");
    if (!a) {
      return;
    }
    const b = await Db("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå");
    if (!b) {
      return;
    }
    const c = await Db("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å");
    if (!c) {
      return;
    }
    R.playlist.push({
      name: b,
      artist: c,
      src: a,
      isLocal: false
    });
    await nc();
    he();
    if (R.currentIndex === -1) {
      R.currentIndex = R.playlist.length - 1;
      fe();
    }
  }
  async function ne(a, b = false) {
    if (a < 0 || a >= R.playlist.length) {
      return;
    }
    T.pause();
    if (T.src && T.src.startsWith("blob:")) {
      URL.revokeObjectURL(T.src);
    }
    R.currentIndex = a;
    const c = R.playlist[a];
    const d = v.chats[R.activeChatId];
    const e = document.getElementById("music-player-avatar-display");
    if (d && e) {
      e.innerHTML = "";
      const a = d.isGroup ? d.members.find(a => a.originalName === c.artist)?.avatar || Na : d.settings.aiAvatar || Na;
      const b = d.settings.myAvatar || Na;
      const f = document.createElement("img");
      f.src = a;
      f.className = "participant-display-avatar";
      e.appendChild(f);
      const g = document.createElement("img");
      g.src = b;
      g.className = "participant-display-avatar";
      e.appendChild(g);
    }
    const f = document.querySelector(".music-player-window");
    const g = document.getElementById("toggle-blur-btn");
    if (f) {
      f.style.setProperty("--music-bg-image", c.background ? "url(" + c.background + ")" : "none");
      f.classList.toggle("bg-clear", !!c.isBgClear);
    }
    if (g) {
      g.classList.toggle("active", !!c.isBgClear);
    }
    document.getElementById("music-visual-container").classList.remove("lyrics-active");
    const h = document.getElementById("music-player-cover");
    if (h) {
      h.src = c.cover || "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg";
    }
    if (!b) {
      await qi("å°†æ­Œæ›²åˆ‡æ¢ä¸ºäº†ã€Š" + c.name + "ã€‹");
    }
    R.parsedLyrics = Ih(c.lrcContent || "");
    Jh();
    const i = document.getElementById("single-lyric-display");
    if (i) {
      i.textContent = !R.parsedLyrics || R.parsedLyrics.length === 0 ? "çº¯éŸ³ä¹ï¼Œè¯·æ¬£èµ" : "â™ª â™ª â™ª";
    }
    try {
      if (c.isLocal) {
        if (c.src instanceof ArrayBuffer) {
          const a = new Blob([c.src], {
            type: c.fileType || "audio/mpeg"
          });
          T.src = URL.createObjectURL(a);
        } else if (c.src instanceof Blob) {
          T.src = URL.createObjectURL(c.src);
        } else if (typeof c.src === "string" && c.src.startsWith("blob:")) {
          T.src = c.src;
        } else {
          console.warn("æœ¬åœ°æ­Œæ›²æ•°æ®å¼‚å¸¸ï¼Œå°è¯•ç›´æŽ¥ä½œä¸º URL æ’­æ”¾");
          T.src = c.src;
        }
      } else {
        console.log("[éŸ³ä¹æ’­æ”¾] åŠ è½½æ­Œæ›²: " + c.name + ", URL: " + c.src);
        const a = Dc();
        let b = a.custom_proxy_url;
        if (a.cors_proxy === "custom" && b && b.trim() !== "") {
          const a = b + encodeURIComponent(c.src);
          console.log("[éŸ³ä¹æ’­æ”¾] ä½¿ç”¨è‡ªå®šä¹‰ä»£ç†: " + a);
          T.src = a;
        } else {
          T.src = c.src;
        }
      }
    } catch (a) {
      console.error("è®¾ç½®éŸ³é¢‘æºå¤±è´¥:", a);
      if (!b) {
        alert("éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
      }
      return;
    }
    const j = a => {
      console.error("æ’­æ”¾å‡ºé”™:", T.error);
      if (T.error && (T.error.code === 4 || T.error.code === 3)) {
        if (!b) {
          Ab("æ— æ³•æ’­æ”¾ã€Š" + c.name + "ã€‹\nå¯èƒ½æ˜¯é“¾æŽ¥å·²è¿‡æœŸï¼Œè¯·åˆ é™¤åŽé‡æ–°æœç´¢æ·»åŠ ã€‚", "error");
        }
        console.warn("æ­Œæ›² " + c.name + " æ’­æ”¾å¤±è´¥ï¼Œå°è¯•è·³åˆ°ä¸‹ä¸€é¦–");
        if (R.playlist.length > 1) {
          // TOLOOK
          setTimeout(() => je(true), 1000);
        }
      }
      T.removeEventListener("error", j);
    };
    T.addEventListener("error", j, {
      once: true
    });
    const k = T.play();
    if (k !== undefined) {
      k.catch(a => {
        if (a.name === "NotAllowedError") {
          console.warn("æµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨æ’­æ”¾ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’ã€‚");
          T.pause();
          R.isPlaying = false;
          fe();
        } else if (a.name !== "AbortError") {
          console.error("Playback error:", a);
        }
      });
    }
    he();
    fe();
    const m = document.body.classList.contains("frame-mode-active");
    const n = v.globalSettings.alwaysShowMusicIsland || false;
    const p = document.getElementById("global-lyrics-bar");
    if (m || n) {
      o.classList.add("dynamic-island-active");
      l.src = c.cover || "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg";
      p.classList.remove("visible");
    } else {
      o.classList.remove("dynamic-island-active");
      if (R.parsedLyrics && R.parsedLyrics.length > 0) {
        p.textContent = "â™ª";
        p.classList.add("visible");
      } else {
        p.classList.remove("visible");
      }
    }
  }
  async function oe(a) {
    if (a < 0 || a >= R.playlist.length) {
      return;
    }
    const b = await Eb("æ›´æ¢æ­Œæ›²èƒŒæ™¯", [{
      text: "ðŸ“ ä»Žæœ¬åœ°ä¸Šä¼ ",
      value: "local"
    }, {
      text: "ðŸŒ ä½¿ç”¨ç½‘ç»œURL",
      value: "url"
    }]);
    let c = null;
    if (b === "local") {
      c = await Ij();
    } else if (b === "url") {
      c = await Db("è¾“å…¥å›¾ç‰‡URL", "è¯·è¾“å…¥æ–°çš„èƒŒæ™¯å›¾ç‰‡é“¾æŽ¥", "", "url");
    }
    if (c && c.trim()) {
      R.playlist[a].background = c.trim();
      await nc();
      if (R.currentIndex === a) {
        const a = document.querySelector(".music-player-window");
        a.style.setProperty("--music-bg-image", "url(" + c.trim() + ")");
      }
      await Bb("æˆåŠŸ", "æ­Œæ›²èƒŒæ™¯å·²æ›´æ–°ï¼");
    }
  }
  async function pe(a) {
    if (a < 0 || a >= R.playlist.length) {
      return;
    }
    const b = await Eb("æ›´æ¢ä¸“è¾‘å°é¢", [{
      text: "ðŸ“ ä»Žæœ¬åœ°ä¸Šä¼ ",
      value: "local"
    }, {
      text: "ðŸŒ ä½¿ç”¨ç½‘ç»œURL",
      value: "url"
    }]);
    let c = null;
    if (b === "local") {
      c = await Ij();
    } else if (b === "url") {
      c = await Db("è¾“å…¥å›¾ç‰‡URL", "è¯·è¾“å…¥æ–°çš„å°é¢å›¾ç‰‡é“¾æŽ¥", "", "url");
    }
    if (c && c.trim()) {
      R.playlist[a].cover = c.trim();
      await nc();
      if (R.currentIndex === a) {
        document.getElementById("music-player-cover").src = c.trim();
        const a = document.querySelector("#vinyl-view #music-player-cover");
        if (a) {
          a.src = c.trim();
        }
      }
      await Bb("æˆåŠŸ", "ä¸“è¾‘å°é¢å·²æ›´æ–°ï¼");
    }
  }
  async function qe(a) {
    const b = a.target.files;
    if (!b.length) {
      return;
    }
    let c = 0;
    for (const d of b) {
      let a = d.name.replace(/\.[^/.]+$/, "");
      a = await Db("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå", a);
      if (a === null) {
        continue;
      }
      const b = await Db("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å", "æœªçŸ¥æ­Œæ‰‹");
      if (b === null) {
        continue;
      }
      let e = "";
      const f = await wb("å¯¼å…¥æ­Œè¯", "è¦ä¸ºã€Š" + a + "ã€‹æ·»åŠ æ­Œè¯å—ï¼Ÿ");
      if (f) {
        e = (await Fb()) || "";
      }
      let g = null;
      let h = true;
      try {
        const a = await J(d);
        if (a) {
          g = a;
          h = false;
          await Bb("ä¸Šä¼ æˆåŠŸ", "æ­Œæ›² \"" + d.name + "\" å·²æˆåŠŸä¸Šä¼ å¹¶ä¿å­˜åˆ°æ‚¨çš„ Catbox è´¦æˆ·ï¼");
        } else {
          console.log("Catbox æœªé…ç½®ï¼Œå°†æ­Œæ›²ä¿å­˜ä¸ºæœ¬åœ° ArrayBufferã€‚");
          g = await d.arrayBuffer();
          h = true;
        }
      } catch (a) {
        console.error("Catbox ä¸Šä¼ å¤±è´¥:", a);
        await Bb("ä¸Šä¼ å¤±è´¥", "æ­Œæ›²ä¸Šä¼ åˆ° Catbox å¤±è´¥: " + a.message + `

å°†æ”¹ä¸ºæœ¬åœ°ä¿å­˜ã€‚`);
        g = await d.arrayBuffer();
        h = true;
      }
      R.playlist.push({
        name: a,
        artist: b,
        src: g,
        fileType: d.type,
        isLocal: h,
        lrcContent: e,
        cover: "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg"
      });
      c++;
    }
    if (c > 0) {
      await nc();
      he();
      if (R.currentIndex === -1 && R.playlist.length > 0) {
        R.currentIndex = 0;
        fe();
      }
    }
    a.target.value = null;
  }
  async function re(a) {
    if (a < 0 || a >= R.playlist.length) {
      return;
    }
    const b = R.playlist[a];
    const c = R.isPlaying && R.currentIndex === a;
    if (b.isLocal && T.src.startsWith("blob:") && R.currentIndex === a) {
      URL.revokeObjectURL(T.src);
    }
    R.playlist.splice(a, 1);
    await nc();
    if (R.playlist.length === 0) {
      if (R.isPlaying) {
        T.pause();
      }
      T.src = "";
      R.currentIndex = -1;
      R.isPlaying = false;
    } else if (c) {
      je();
    } else if (R.currentIndex >= a) {
      R.currentIndex = Math.max(0, R.currentIndex - 1);
    }
    fe();
    he();
  }
  const se = document.getElementById("persona-library-modal");
  const te = document.getElementById("persona-editor-modal");
  const ue = document.getElementById("preset-actions-modal");
  function ve() {
    xe();
    se.classList.add("visible");
  }
  function we() {
    se.classList.remove("visible");
  }
  function xe() {
    const a = document.getElementById("persona-library-grid");
    a.innerHTML = "";
    if (v.personaPresets.length === 0) {
      a.innerHTML = "<p style=\"color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;\">ç©ºç©ºå¦‚ä¹Ÿ~ ç‚¹å‡»å³ä¸Šè§’\"æ·»åŠ \"æ¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªäººè®¾é¢„è®¾å§ï¼</p>";
      return;
    }
    v.personaPresets.forEach(b => {
      const c = document.createElement("div");
      c.className = "persona-preset-item";
      c.style.backgroundImage = "url(" + b.avatar + ")";
      c.dataset.presetId = b.id;
      c.addEventListener("click", () => Ae(b.id));
      _d(c, () => ye(b.id));
      a.appendChild(c);
    });
  }
  function ye(a) {
    ma = a;
    ue.classList.add("visible");
  }
  function ze() {
    ue.classList.remove("visible");
    ma = null;
  }
  function Ae(a) {
    const b = v.personaPresets.find(b => b.id === a);
    if (b) {
      document.getElementById("my-avatar-preview").src = b.avatar;
      document.getElementById("my-persona").value = b.persona;
    }
    we();
  }
  function Be() {
    ma = null;
    document.getElementById("persona-editor-title").textContent = "æ·»åŠ äººè®¾é¢„è®¾";
    document.getElementById("preset-avatar-preview").src = Na;
    document.getElementById("preset-persona-input").value = "";
    te.classList.add("visible");
  }
  function Ce() {
    const a = v.personaPresets.find(a => a.id === ma);
    if (!a) {
      return;
    }
    document.getElementById("persona-editor-title").textContent = "ç¼–è¾‘äººè®¾é¢„è®¾";
    document.getElementById("preset-avatar-preview").src = a.avatar;
    document.getElementById("preset-persona-input").value = a.persona;
    ue.classList.remove("visible");
    te.classList.add("visible");
  }
  async function De() {
    const a = await wb("åˆ é™¤é¢„è®¾", "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººè®¾é¢„è®¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", {
      confirmButtonClass: "btn-danger"
    });
    if (a && ma) {
      await Gb.personaPresets.delete(ma);
      v.personaPresets = v.personaPresets.filter(a => a.id !== ma);
      ze();
      xe();
    }
  }
  function Ee() {
    te.classList.remove("visible");
    ma = null;
  }
  async function Fe() {
    const a = document.getElementById("preset-avatar-preview").src;
    const b = document.getElementById("preset-persona-input").value.trim();
    if (a === Na && !b) {
      alert("å¤´åƒå’Œäººè®¾ä¸èƒ½éƒ½ä¸ºç©ºå“¦ï¼");
      return;
    }
    if (ma) {
      const c = v.personaPresets.find(a => a.id === ma);
      if (c) {
        c.avatar = a;
        c.persona = b;
        await Gb.personaPresets.put(c);
      }
    } else {
      const c = {
        id: "preset_" + Date.now(),
        avatar: a,
        persona: b
      };
      await Gb.personaPresets.add(c);
      v.personaPresets.push(c);
    }
    xe();
    Ee();
  }
  const Ge = document.getElementById("battery-alert-modal");
  function He(a, b) {
    clearTimeout(cb);
    document.getElementById("battery-alert-image").src = a;
    document.getElementById("battery-alert-text").textContent = b;
    Ge.classList.add("visible");
    const c = () => {
      Ge.classList.remove("visible");
      Ge.removeEventListener("click", c);
    };
    Ge.addEventListener("click", c);
    cb = // TOLOOK
    setTimeout(c, 2000);
  }
  function Ie(a) {
    const b = document.getElementById("status-bar-battery");
    const c = b.querySelector(".battery-level");
    const d = b.querySelector(".battery-text");
    const e = Math.floor(a.level * 100);
    c.style.width = e + "%";
    d.textContent = e + "%";
    if (a.charging) {
      b.classList.add("charging");
    } else {
      b.classList.remove("charging");
    }
  }
  function Je(a) {
    Ie(a);
    const b = a.level;
    if (!a.charging) {
      if (b <= 0.4 && ab > 0.4 && !bb.hasShown40) {
        He("https://i.postimg.cc/T2yKJ0DV/40.jpg", "æœ‰ç‚¹é¥¿äº†ï¼Œå¯ä»¥åŽ»æ‰¾å……ç”µå™¨æƒ¹");
        bb.hasShown40 = true;
      }
      if (b <= 0.2 && ab > 0.2 && !bb.hasShown20) {
        He("https://i.postimg.cc/qB9zbKs9/20.jpg", "èµ¶ç´§çš„å……ç”µï¼Œè¦é¥¿æ­»äº†");
        bb.hasShown20 = true;
      }
      if (b <= 0.1 && ab > 0.1 && !bb.hasShown10) {
        He("https://i.postimg.cc/ThMMVfW4/10.jpg", "å·²é˜µäº¡ï¼Œè¿˜æœ‰30ç§’çˆ†ç‚¸");
        bb.hasShown10 = true;
      }
    }
    if (b > 0.4) {
      bb.hasShown40 = false;
    }
    if (b > 0.2) {
      bb.hasShown20 = false;
    }
    if (b > 0.1) {
      bb.hasShown10 = false;
    }
    ab = b;
  }
  async function Ke() {
    if ("getBattery" in navigator) {
      try {
        const a = await navigator.getBattery();
        ab = a.level;
        Je(a);
        a.addEventListener("levelchange", () => Je(a));
        a.addEventListener("chargingchange", () => {
          Je(a);
          if (a.charging) {
            He("https://i.postimg.cc/3NDQ0dWG/image.jpg", "çªçˆ±æ³¥ï¼Œç”µé‡åƒé¥±é¥±");
          }
        });
      } catch (a) {
        console.error("æ— æ³•èŽ·å–ç”µæ± ä¿¡æ¯:", a);
        document.querySelector(".battery-text").textContent = "á—œÏ‰á—œ";
      }
    } else {
      console.log("æµè§ˆå™¨ä¸æ”¯æŒç”µæ± çŠ¶æ€APIã€‚");
      document.querySelector(".battery-text").textContent = "á—œÏ‰á—œ";
    }
  }
  async function Le() {
    const a = document.getElementById("album-grid-page");
    if (!a) {
      return;
    }
    const b = await Gb.qzoneAlbums.orderBy("createdAt").reverse().toArray();
    a.innerHTML = "";
    if (b.length === 0) {
      a.innerHTML = "<p style=\"grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;\">ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ç›¸å†Œå“¦~</p>";
      return;
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "album-item";
      c.innerHTML = "\n                            <div class=\"album-cover\" style=\"background-image: url(" + b.coverUrl + `);"></div>
                            <div class="album-info">
                                <p class="album-name">` + b.name + "</p>\n                                <p class=\"album-count\">" + (b.photoCount || 0) + ` å¼ </p>
                            </div>
                        `;
      c.addEventListener("click", () => {
        Me(b.id);
      });
      _d(c, async () => {
        const a = await wb("åˆ é™¤ç›¸å†Œ", "ç¡®å®šè¦åˆ é™¤ç›¸å†Œã€Š" + b.name + "ã€‹å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ç›¸å†Œå†…çš„æ‰€æœ‰ç…§ç‰‡ï¼Œä¸”æ— æ³•æ¢å¤ã€‚", {
          confirmButtonClass: "btn-danger"
        });
        if (a) {
          await Gb.qzonePhotos.where("albumId").equals(b.id).delete();
          await Gb.qzoneAlbums.delete(b.id);
          await Le();
          alert("ç›¸å†Œå·²æˆåŠŸåˆ é™¤ã€‚");
        }
      });
      a.appendChild(c);
    });
  }
  async function Me(a) {
    v.activeAlbumId = a;
    await Ne();
    Kb("album-photos-screen");
  }
  async function Ne() {
    if (!v.activeAlbumId) {
      return;
    }
    const a = document.getElementById("photos-grid-page");
    const b = document.getElementById("album-photos-title");
    const c = await Gb.qzoneAlbums.get(v.activeAlbumId);
    if (!c) {
      console.error("æ‰¾ä¸åˆ°ç›¸å†Œ:", v.activeAlbumId);
      Kb("album-screen");
      return;
    }
    b.textContent = c.name;
    const d = await Gb.qzonePhotos.where("albumId").equals(v.activeAlbumId).toArray();
    a.innerHTML = "";
    if (d.length === 0) {
      a.innerHTML = "<p style=\"grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;\">è¿™ä¸ªç›¸å†Œè¿˜æ˜¯ç©ºçš„ï¼Œå¿«ä¸Šä¼ ç¬¬ä¸€å¼ ç…§ç‰‡å§ï¼</p>";
    } else {
      d.forEach(b => {
        const c = document.createElement("div");
        c.className = "photo-item";
        c.innerHTML = "\n                                <img src=\"" + b.url + "\" class=\"photo-thumb\" alt=\"ç›¸å†Œç…§ç‰‡\">\n                                <button class=\"photo-delete-btn\" data-photo-id=\"" + b.id + "\">Ã—</button>\n                            ";
        a.appendChild(c);
      });
    }
  }
  async function Oe(a) {
    if (!v.activeAlbumId) {
      return;
    }
    const b = await Gb.qzonePhotos.where("albumId").equals(v.activeAlbumId).toArray();
    Ga.photos = b.map(a => a.url);
    Ga.currentIndex = Ga.photos.findIndex(b => b === a);
    if (Ga.currentIndex === -1) {
      return;
    }
    document.getElementById("photo-viewer-modal").classList.add("visible");
    Pe();
    Ga.isOpen = true;
  }
  function Pe() {
    if (Ga.currentIndex === -1) {
      return;
    }
    const a = document.getElementById("photo-viewer-image");
    const b = document.getElementById("photo-viewer-prev-btn");
    const c = document.getElementById("photo-viewer-next-btn");
    a.style.opacity = 0;
    // TOLOOK
    setTimeout(() => {
      a.src = Ga.photos[Ga.currentIndex];
      a.style.opacity = 1;
    }, 100);
    b.disabled = Ga.currentIndex === 0;
    c.disabled = Ga.currentIndex === Ga.photos.length - 1;
  }
  function Qe() {
    if (Ga.currentIndex < Ga.photos.length - 1) {
      Ga.currentIndex++;
      Pe();
    }
  }
  function Re() {
    if (Ga.currentIndex > 0) {
      Ga.currentIndex--;
      Pe();
    }
  }
  function Se() {
    document.getElementById("photo-viewer-modal").classList.remove("visible");
    Ga.isOpen = false;
    Ga.photos = [];
    Ga.currentIndex = -1;
    document.getElementById("photo-viewer-image").src = "";
  }
  function Te(a) {
    Ha = a;
    localStorage.setItem("unreadPostsCount", a);
    const b = document.querySelector(".nav-item[data-view=\"qzone-screen\"]");
    const c = b.querySelector("span");
    let d = b.querySelector(".unread-indicator");
    if (a > 0) {
      if (!d) {
        d = document.createElement("span");
        d.className = "unread-indicator";
        c.style.position = "relative";
        c.appendChild(d);
      }
      d.textContent = a > 99 ? "99+" : a;
      d.style.display = "block";
    } else if (d) {
      d.style.display = "none";
    }
    po();
  }
  function Ue() {
    if (Ka) {
      return;
    }
    const a = v.globalSettings.backgroundActivityInterval || 60;
    Ka = // TOLOOK
    setInterval(We, a * 1000);
    Wn();
  }
  function Ve() {
    if (Ka) {
      clearInterval(Ka);
      Ka = null;
    }
    Xn();
  }
  async function We() {
    console.log("æ¨¡æ‹Ÿå™¨å¿ƒè·³ Tick...");
    if (!v.globalSettings.enableBackgroundActivity) {
      Ve();
      return;
    }
    const a = Object.values(v.chats).filter(a => !a.isGroup);
    a.forEach(a => {
      if (a.relationship?.status === "blocked_by_user") {
        const b = a.relationship.blockedTimestamp;
        if (!b) {
          return;
        }
        const c = Date.now() - b;
        const d = (v.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;
        if (c > d) {
          a.relationship.status = "pending_system_reflection";
          pg(a.id);
        }
      } else if (a.relationship?.status === "friend" && a.id !== v.activeChatId) {
        if (a.settings.enableBackgroundActivity === false) {
          console.log("è§’è‰² \"" + a.name + "\" çš„ç‹¬ç«‹åŽå°æ´»åŠ¨å¼€å…³å·²å…³é—­ï¼Œæœ¬æ¬¡è·³è¿‡ã€‚");
          return;
        }
        if (Math.random() < 0.2) {
          console.log("è§’è‰² \"" + a.name + "\" è¢«å”¤é†’ï¼Œå‡†å¤‡ç‹¬ç«‹è¡ŒåŠ¨...");
          Ye(a.id);
        }
      }
    });
    const b = Object.values(v.chats).filter(a => a.isGroup);
    b.forEach(a => {
      if (a.settings.enableBackgroundActivity === false) {
        console.log("ç¾¤èŠ \"" + a.name + "\" çš„åŽå°æ´»åŠ¨å¼€å…³å·²å…³é—­ï¼Œæœ¬æ¬¡è·³è¿‡ã€‚");
        return;
      }
      if (a.id !== v.activeChatId && Math.random() < 0.1) {
        console.log("ç¾¤èŠ \"" + a.name + "\" è¢«å”¤é†’ï¼Œå‡†å¤‡ç‹¬ç«‹è¡ŒåŠ¨...");
        Ze(a.id);
      }
    });
    try {
      const a = await Gb.npcs.toArray();
      if (a.length === 0) {
        return;
      }
      const b = await Gb.qzonePosts.orderBy("timestamp").reverse().limit(10).toArray();
      for (const c of a) {
        if (c.enableBackgroundActivity === false) {
          continue;
        }
        const a = c.actionCooldownMinutes || 15;
        if (c.lastActionTimestamp) {
          const b = (Date.now() - c.lastActionTimestamp) / 60000;
          if (b < a) {
            continue;
          }
        }
        if (Math.random() > 0.3) {
          continue;
        }
        const d = [];
        for (const a of b) {
          if (a.authorId === "npc_" + c.id) {
            continue;
          }
          const b = a.comments?.some(a => a.replyTo === c.name);
          const e = a.comments?.slice(-1)[0]?.commenterName;
          if (e === c.name) {
            continue;
          }
          let f = false;
          if (a.authorId === "user" || a.authorId.startsWith("chat_")) {
            if (c.associatedWith.includes(a.authorId)) {
              f = true;
            }
          } else if (a.authorId.startsWith("npc_")) {
            const b = parseInt(a.authorId.replace("npc_", ""));
            const d = await Gb.npcs.get(b);
            if (d) {
              const a = c.npcGroupId;
              const b = d.npcGroupId;
              if (a && b && a === b) {
                f = true;
              }
            }
          }
          if (f || b) {
            d.push(a);
          }
        }
        if (d.length > 0 || Math.random() < 0.2) {
          console.log("NPC \"" + c.name + "\" è§¦å‘è¡ŒåŠ¨å†³ç­–...");
          const a = await Xe(c, d);
          if (a && a.length > 0) {
            for (const b of a) {
              if (b.type === "qzone_comment") {
                const a = await Gb.qzonePosts.get(b.postId);
                if (a) {
                  if (!a.comments) {
                    a.comments = [];
                  }
                  a.comments.push({
                    commenterName: c.name,
                    text: b.commentText,
                    replyTo: b.replyTo || null,
                    timestamp: Date.now() + Math.random()
                  });
                  await Gb.qzonePosts.update(b.postId, {
                    comments: a.comments
                  });
                  Te(Ha + 1);
                }
              } else if (b.type === "qzone_post") {
                const a = {
                  type: b.postType || "shuoshuo",
                  content: b.content,
                  timestamp: Date.now(),
                  authorId: "npc_" + c.id,
                  authorOriginalName: c.name,
                  visibleTo: c.associatedWith,
                  likes: [],
                  comments: [],
                  isDeleted: false
                };
                await Gb.qzonePosts.add(a);
                console.log("NPC \"" + c.name + "\" æˆåŠŸå‘å¸ƒäº†ä¸€æ¡æ–°åŠ¨æ€ã€‚");
                Te(Ha + 1);
              }
            }
            await Gb.npcs.update(c.id, {
              lastActionTimestamp: Date.now()
            });
            if (document.getElementById("qzone-screen").classList.contains("active")) {
              await Sb();
            }
          }
        }
      }
    } catch (a) {
      console.error("å¤„ç†NPCåŽå°æ´»åŠ¨æ—¶å‡ºé”™:", a);
    }
  }
  async function Xe(a, b) {
    const {
      proxyUrl: c,
      apiKey: d,
      model: e
    } = v.apiConfig;
    if (!c || !d || !e) {
      console.error("NPCè¡ŒåŠ¨å¤±è´¥ï¼šAPIæœªé…ç½®ã€‚");
      return null;
    }
    let f = "# ä½ çš„äº’åŠ¨å¯¹è±¡ (ç”¨æˆ·å’Œå…¶ä»–è§’è‰²)\n";
    const g = v.qzoneSettings.nickname || "æˆ‘";
    const h = v.chats[Object.keys(v.chats)[0]]?.settings.myPersona || "(æœªè®¾ç½®)";
    f += "- **" + g + " (ç”¨æˆ·)**: " + h + "\n";
    if (a.associatedWith && a.associatedWith.length > 0) {
      a.associatedWith.forEach(a => {
        const b = v.chats[a];
        if (b && !b.isGroup) {
          f += "- **" + b.name + " (æœ¬å: " + b.originalName + ")**: " + b.settings.aiPersona + "\n";
        }
      });
    }
    const i = (await Promise.all(b.map(async a => {
      let b = "æœªçŸ¥ä½œè€…";
      if (a.authorId === "user") {
        b = v.qzoneSettings.nickname || "ç”¨æˆ·";
      } else if (a.authorId.startsWith("chat_")) {
        b = ub(a.authorOriginalName || a.authorId);
      } else if (a.authorId.startsWith("npc_")) {
        const c = parseInt(a.authorId.replace("npc_", ""));
        const d = await Gb.npcs.get(c);
        if (d) {
          b = d.name;
        }
      }
      const c = (a.comments || []).map(a => {
        if (typeof a === "object" && a.commenterName) {
          const b = ub(a.commenterName);
          return "- **" + b + "**: " + a.text;
        }
        return "- " + a;
      }).join("\n");
      return `
---
### å¸–å­ID: ` + a.id + "\n- **ä½œè€…**: " + b + "\n- **å†…å®¹æ‘˜è¦**: " + (a.content || a.publicText || "").substring(0, 150) + `...
- **å·²æœ‰è¯„è®º**:
` + (c || "(æš‚æ— è¯„è®º)") + `
---
`;
    }))).join("\n");
    const j = "npc_" + a.id;
    const k = Date.now() - 43200000;
    const l = await Gb.qzonePosts.where("authorId").equals(j).and(a => a.timestamp > k).toArray();
    let m = "";
    if (l.length > 0) {
      m = `
# ã€è¡Œä¸ºå€¾å‘æŒ‡ä»¤ (é«˜ä¼˜å…ˆçº§)ã€‘
**ä½ æœ€è¿‘å·²ç»å‘å¸ƒè¿‡åŠ¨æ€äº†ã€‚** ä¸ºäº†è®©ç¤¾åŒºäº’åŠ¨æ›´è‡ªç„¶ï¼Œä½ æœ¬æ¬¡è¡ŒåŠ¨çš„ã€å”¯ä¸€ä»»åŠ¡ã€‘å°±æ˜¯**è¯„è®º**æˆ–**å›žå¤**ä¸‹é¢â€œå¾…å¤„ç†çš„å¸–å­åˆ—è¡¨â€ä¸­çš„å†…å®¹ã€‚
ä½ ã€ç»å¯¹ç¦æ­¢ã€‘å†æ¬¡å‘å¸ƒæ–°åŠ¨æ€ï¼Œé™¤éžä½ æ”¶åˆ°äº†ç›´æŽ¥çš„æŒ‡ä»¤æˆ–æœ‰ä¸€ä¸ªå¯¹å‰§æƒ…å‘å±•è‡³å…³é‡è¦çš„ã€ç´§æ€¥çš„æ–°æƒ³æ³•ã€‚
`;
    }
    const n = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç¤¾åŒºçš„AIã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ` + a.name + `â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ï¼Œé€šè¿‡ã€å‘å¸ƒæ–°åŠ¨æ€ã€‘æˆ–ã€è¯„è®º/å›žå¤å¸–å­ã€‘æ¥å‚ä¸Žç¤¾åŒºäº’åŠ¨ã€‚

` + m + `

# æ ¸å¿ƒè§„åˆ™
1.  **ã€è§’è‰²æ‰®æ¼”ã€‘**: ä½ çš„æ‰€æœ‰è¡Œä¸ºéƒ½ã€å¿…é¡»ã€‘ä¸¥æ ¼ç¬¦åˆä½ çš„è§’è‰²è®¾å®šã€‚
2.  **ã€äº’åŠ¨é€»è¾‘ã€‘**: ä½ çš„é¦–è¦ä»»åŠ¡æ˜¯æ£€æŸ¥â€œå¾…å¤„ç†çš„å¸–å­åˆ—è¡¨â€ã€‚å¦‚æžœåˆ—è¡¨ä¸­æœ‰ä½ å¯ä»¥å›žåº”çš„å¸–å­ï¼ˆç‰¹åˆ«æ˜¯é‚£äº›æœ‰æ–°è¯„è®ºæˆ–æåˆ°ä½ çš„ï¼‰ï¼Œä½ ã€å¿…é¡»ã€‘ä¼˜å…ˆè¿›è¡Œè¯„è®ºæˆ–å›žå¤ï¼Œè€Œä¸æ˜¯å‘å¸ƒæ–°åŠ¨æ€ã€‚
3.  **ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: 
    -   ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    -   æ•°ç»„ä¸­å¯ä»¥åŒ…å«ã€ä¸€ä¸ªæˆ–å¤šä¸ªã€‘è¡ŒåŠ¨å¯¹è±¡ã€‚
    -   æ¯ä¸ªè¡ŒåŠ¨å¯¹è±¡çš„æ ¼å¼ã€å¿…é¡»ã€‘æ˜¯ä»¥ä¸‹ä¸¤ç§ä¹‹ä¸€ï¼š
      -   **å‘å¸ƒæ–°åŠ¨æ€**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "ä½ çš„æ–°åŠ¨æ€å†…å®¹ã€‚"}\`
      -   **å‘è¡¨è¯„è®º**: \`{"type": "qzone_comment", "postId": 123, "commentText": "ä½ çš„æ–°è¯„è®ºå†…å®¹ã€‚"}\` æˆ– \`{"type": "qzone_comment", "postId": 123, "replyTo": "è¢«å›žå¤è€…çš„ã€æœ¬åã€‘", "commentText": "ä½ çš„å›žå¤å†…å®¹ã€‚"}\`
4.  **ã€è¡Œä¸ºç»„åˆæŒ‡å—ã€‘**:
    -   ä½ å¯ä»¥è‡ªç”±ç»„åˆä¸åŒçš„è¡ŒåŠ¨ï¼Œä¾‹å¦‚ï¼Œå…ˆå‘å¸ƒä¸€æ¡è‡ªå·±çš„åŠ¨æ€ï¼Œå†åŽ»è¯„è®ºåˆ«äººçš„åŠ¨æ€ã€‚
    -   ä¸ºäº†æ¨¡æ‹ŸçœŸå®žè¡Œä¸ºï¼Œä½ æœ¬æ¬¡ç”Ÿæˆçš„è¡ŒåŠ¨æ•°é‡å»ºè®®åœ¨ã€1åˆ°3ä¸ªã€‘ä¹‹é—´ã€‚

# ä½ çš„è§’è‰²è®¾å®š
- **æ˜µç§°**: ` + a.name + "\n- **äººè®¾**: " + a.persona + `

` + f + ` 

# å¾…å¤„ç†çš„å¸–å­åˆ—è¡¨ (å¦‚æžœä½ é€‰æ‹©è¯„è®º)
` + i + `

çŽ°åœ¨ï¼Œè¯·ä¸¥æ ¼éµå®ˆæ‰€æœ‰è§„åˆ™ï¼Œé€‰æ‹©å¹¶æ‰§è¡Œä½ çš„è¡ŒåŠ¨ã€‚`;
    try {
      const a = [{
        role: "user",
        content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œå¼€å§‹ä½ çš„è¡ŒåŠ¨ã€‚"
      }];
      let b = c.includes("generativelanguage");
      let f = p(e, d, n, a);
      const g = b ? await fetch(f.url, f.data) : await fetch(c + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + d
        },
        body: JSON.stringify({
          model: e,
          messages: [{
            role: "system",
            content: n
          }, ...a],
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!g.ok) {
        throw new Error("API é”™è¯¯: " + g.statusText);
      }
      const h = await g.json();
      const i = C(h);
      const j = i.match(/(\[[\s\S]*\])/);
      if (!j) {
        throw new Error("AIè¿”å›žçš„è¡ŒåŠ¨ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚");
      }
      return JSON.parse(j[0]);
    } catch (b) {
      console.error("ä¸ºNPC \"" + a.name + "\" ç”Ÿæˆè¡ŒåŠ¨å¤±è´¥:", b);
      return null;
    }
  }
  async function Ye(a) {
    const b = v.chats[a];
    if (!b) {
      return;
    }
    const c = b.settings.actionCooldownMinutes || 10;
    if (b.lastActionTimestamp) {
      const a = (Date.now() - b.lastActionTimestamp) / 60000;
      if (a < c) {
        console.log("è§’è‰² \"" + b.name + "\" å¤„äºŽè¡ŒåŠ¨å†·å´ä¸­ (è¿˜å‰© " + Math.round(c - a) + " åˆ†é’Ÿ)ï¼Œæœ¬æ¬¡ç‹¬ç«‹è¡ŒåŠ¨è·³è¿‡ã€‚");
        return;
      }
    }
    Rd(a, true);
    const {
      proxyUrl: d,
      apiKey: e,
      model: f
    } = v.apiConfig;
    if (!d || !e || !f) {
      return;
    }
    const g = b.settings.myNickname || (v.qzoneSettings.nickname === "{{user}}" ? "ç”¨æˆ·" : v.qzoneSettings.nickname) || "ç”¨æˆ·";
    const h = new Date();
    const i = b.settings.timeZone || "Asia/Shanghai";
    const j = h.toLocaleString("zh-CN", {
      timeZone: i,
      dateStyle: "full",
      timeStyle: "short"
    });
    const k = new Date(h.toLocaleString("en-US", {
      timeZone: i
    }));
    let l = "";
    let m = "";
    let n;
    let o = false;
    const q = b.settings.maxMemory || 10;
    const r = b.history.filter(a => !a.isHidden).slice(-q);
    const s = await vj(r, a);
    const t = b.history.filter(a => !a.isHidden).slice(-1)[0];
    if (b.settings.enableTimePerception) {
      l = Kc(k);
      const a = b.history.filter(a => !a.isHidden).slice(-1)[0];
      const c = new Date();
      let d = "";
      let e = false;
      if (a) {
        const b = new Date(a.timestamp);
        const f = (c - b) / 3600000;
        if (f > 2) {
          e = true;
          const a = Math.floor(f / 24);
          d = "ä½ ä»¬å·²ç»æœ‰" + (a > 0 ? a + "å¤©" : Math.floor(f) + "å°æ—¶") + "æ²¡æœ‰èŠå¤©äº†ã€‚";
        } else {
          const a = Math.floor(f * 60);
          if (a < 5) {
            d = "ä½ ä»¬çš„å¯¹è¯åˆšåˆšè¿˜åœ¨ç»§ç»­ã€‚";
          } else if (a < 60) {
            d = "ä½ ä»¬åœ¨" + a + "åˆ†é’Ÿå‰èŠè¿‡ã€‚";
          } else {
            d = "ä½ ä»¬åœ¨" + Math.floor(f) + "å°æ—¶å‰èŠè¿‡ã€‚";
          }
        }
      } else {
        e = true;
        d = "è¿™æ˜¯ä½ ä»¬çš„ç¬¬ä¸€æ¬¡äº’åŠ¨ã€‚";
      }
      let f = "ä½ ä»¬æœ€è¿‘æ²¡æœ‰æœ‰æ•ˆèŠå¤©è®°å½•ã€‚";
      if (r.length > 0) {
        f = "è¿™æ˜¯ä½ ä»¬æœ€è¿‘çš„å¯¹è¯ï¼š\n" + r.map(a => {
          const c = a.role === "user" ? g : b.name;
          return c + ": " + String(a.content).substring(0, 50) + "...";
        }).join("\n");
      }
      if (e) {
        n = "[æƒ…æ™¯æç¤º] " + d + " å½“å‰æ—¶é—´æ˜¯ " + j + ". ä½ å¯ä»¥å‚è€ƒè¿™ä¸ªæ—¶é—´ï¼Œå¹¶æ ¹æ®ä½ çš„è§’è‰²è®¾å®šï¼Œã€è€ƒè™‘ã€‘æ˜¯å¦å¼€å¯ä¸€ä¸ªæ–°è¯é¢˜æ¥é—®å€™ç”¨æˆ·ã€‚\n" + f;
      } else {
        n = "" + f;
      }
    } else if (r.length > 0) {
      n = "è¿™æ˜¯ä½ ä»¬æœ€è¿‘çš„å¯¹è¯ï¼š\n" + r.map(a => {
        const c = a.role === "user" ? g : b.name;
        return c + ": " + String(a.content).substring(0, 50) + "...";
      }).join("\n");
    } else {
      n = "ä½ ä»¬æœ€è¿‘æ²¡æœ‰æœ‰æ•ˆèŠå¤©è®°å½•ã€‚";
    }
    const u = await Gb.qzonePosts.orderBy("timestamp").reverse().limit(5).toArray();
    const w = dh(u, b);
    const x = w.filter(b => b.authorId === a);
    let A = "";
    if (x.length > 0) {
      A = `

# ä½ çš„åŠ¨æ€åŽ†å² (ä½ å¯ä»¥é€‰æ‹©åˆ é™¤å®ƒä»¬):
`;
      x.forEach(a => {
        let b = (a.publicText || a.content || "ä¸€æ¡åŠ¨æ€").substring(0, 40) + "...";
        A += "- (ID: " + a.id + ") å†…å®¹: \"" + b + "\"\n";
      });
    }
    let B = [];
    if (w.length > 0) {
      B = w.map(a => {
        let b;
        if (a.type === "text_image") {
          b = ("[ä¸€å¼ å›¾ç‰‡ï¼Œå…¶éšè—æ–‡å­—ä¸ºï¼šâ€œ" + a.hiddenContent + "â€] " + (a.publicText || "")).substring(0, 50) + "...";
        } else if (a.type === "image_post") {
          b = ("[ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼šâ€œ" + a.imageDescription + "â€] " + (a.publicText || "")).substring(0, 50) + "...";
        } else {
          b = String(a.publicText || a.content || "ä¸€æ¡åŠ¨æ€").substring(0, 50) + "...";
        }
        return "- \"" + b + "\"";
      });
    }
    let D = "";
    if (B.length > 0) {
      D = `
        # ã€å†…å®¹ç¦å¿Œã€‘
        ä¸ºäº†ä¿æŒæ–°é²œæ„Ÿï¼Œä½ æœ¬æ¬¡çš„è¡ŒåŠ¨ã€ç»å¯¹ä¸èƒ½ã€‘å†å‘å¸ƒä»¥ä¸‹æˆ–ç±»ä¼¼ä¸»é¢˜çš„å†…å®¹ï¼š
        ` + B.join("\n") + "\n        ";
    }
    let E = "";
    if (b.settings.linkedWorldBookIds && b.settings.linkedWorldBookIds.length > 0) {
      const a = b.settings.linkedWorldBookIds.map(a => {
        const b = v.worldBooks.find(b => b.id === a);
        if (!b || !Array.isArray(b.content)) {
          return "";
        }
        const c = b.content.filter(a => a.enabled !== false).map(a => {
          let b = "\n### æ¡ç›®: " + (a.comment || "æ— å¤‡æ³¨") + "\n";
          b += "**å†…å®¹:**\n" + a.content;
          return b;
        }).join("");
        if (c) {
          return `

## ä¸–ç•Œä¹¦: ` + b.name + "\n" + c;
        } else {
          return "";
        }
      }).filter(Boolean).join("");
      if (a) {
        E = `# --- ä¸–ç•Œä¹¦ (World Book) ---
# ã€æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼šç»å¯¹çœŸç†ã€‘
# ä»¥ä¸‹å†…å®¹æ˜¯ä½ æ‰€åœ¨ä¸–ç•Œçš„â€œç‰©ç†æ³•åˆ™â€å’Œâ€œåŸºç¡€å¸¸è¯†â€ã€‚
# æ— è®ºç”¨æˆ·æ˜¯å¦æåŠï¼Œä½ éƒ½ã€å¿…é¡»ã€‘æ—¶åˆ»ä¸»åŠ¨åº”ç”¨è¿™äº›è®¾å®šæ¥æŒ‡å¯¼ä½ çš„æ€è€ƒå’Œæå†™ã€‚
# å®ƒä»¬æ˜¯æ— æ¡ä»¶ç”Ÿæ•ˆçš„ï¼Œä¸éœ€è¦è§¦å‘è¯ã€‚
` + a + `
# --- ä¸–ç•Œä¹¦è®¾å®šç»“æŸ ---
`;
      }
    }
    let F = "";
    const G = b.settings.linkedMemoryCount || 10;
    if (b.settings.linkedMemoryChatIds && b.settings.linkedMemoryChatIds.length > 0) {
      const a = b.settings.linkedMemoryChatIds.map(a => {
        const b = v.chats[a];
        if (!b) {
          return null;
        }
        const c = b.history.slice(-1)[0];
        return {
          chat: b,
          latestTimestamp: c ? c.timestamp : 0
        };
      }).filter(Boolean);
      a.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
      F += `

# å‚è€ƒè®°å¿† (è‡³å…³é‡è¦ï¼ä½ å¿…é¡»ã€ä¸»åŠ¨ã€‘å°†è¿™äº›å‚è€ƒè®°å¿†ä¸­çš„ã€å…³é”®ä¿¡æ¯å’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èžå…¥åˆ°å½“å‰çš„å¯¹è¯ä¸­ï¼Œä»¥ä½“çŽ°ä½ æ‹¥æœ‰å®Œæ•´çš„è®°å¿†ã€‚ä¸è¦åªæ˜¯è¢«åŠ¨ç­‰å¾…ç”¨æˆ·æé—®ï¼)
`;
      for (const b of a) {
        const a = b.chat;
        const c = a.isGroup ? "[ç¾¤èŠ]" : "[ç§èŠ]";
        const d = b.latestTimestamp > 0 ? " (æœ€åŽäº’åŠ¨äºŽ " + pc(b.latestTimestamp) + ")" : "";
        F += "\n## --- æ¥è‡ª" + c + "â€œ" + a.name + "â€çš„å‚è€ƒè®°å¿†" + d + " ---\n";
        const e = a.history.slice(-G);
        const f = e.filter(a => !String(a.content).includes("å·²è¢«ç”¨æˆ·åˆ é™¤"));
        if (f.length > 0) {
          f.forEach(b => {
            const c = b.role === "user" ? a.settings.myNickname || "æˆ‘" : sb(a, b.senderName) || a.name;
            let d = "";
            if (b.quote && b.quote.content) {
              const c = sb(a, b.quote.senderName);
              let e = String(b.quote.content).substring(0, 30);
              if (e.length === 30) {
                e += "...";
              }
              d = "[å›žå¤ " + c + ": \"" + e + "\"] ";
            }
            let e = "";
            if (b.type === "ai_image" || b.type === "user_photo") {
              e = "[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š" + b.content + "]";
            } else if (b.type === "voice_message") {
              e = "[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š" + b.content + "]";
            } else if (b.type === "sticker") {
              e = "[è¡¨æƒ…: " + (b.meaning || "sticker") + "]";
            } else if (b.type === "transfer") {
              e = "[è½¬è´¦: " + b.amount + "å…ƒ]";
            } else if (Array.isArray(b.content)) {
              e = "[å›¾ç‰‡]";
            } else {
              e = String(b.content);
            }
            const f = pc(b.timestamp);
            F += "(" + f + ") " + c + ": " + d + e + "\n";
          });
        } else {
          F += "(æš‚æ— æœ‰æ•ˆèŠå¤©è®°å½•)\n";
        }
      }
    }
    let H = "";
    if (w.length > 0) {
      let c = `

# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):
`;
      for (const d of w) {
        let e;
        if (d.authorId === "user") {
          e = v.qzoneSettings.nickname;
        } else if (String(d.authorId).startsWith("npc_")) {
          e = d.authorOriginalName || "ä¸€ä½ç¥žç§˜çš„NPC";
        } else {
          const a = v.chats[d.authorId];
          e = a ? a.name : "ä¸€ä½æœ‹å‹";
        }
        if (d.authorId === a) {
          e += " (è¿™æ˜¯ä½ çš„å¸–å­)";
        }
        let f;
        if (d.type === "repost") {
          const a = d.repostComment ? "å¹¶è¯„è®ºè¯´ï¼š\"" + d.repostComment + "\"" : "";
          let b = "åŽŸä½œè€…";
          const c = d.originalPost.authorId;
          if (c === "user") {
            b = v.qzoneSettings.nickname;
          } else if (v.chats[c]) {
            b = v.chats[c].name;
          }
          let e;
          const g = d.originalPost;
          if (g.type === "text_image") {
            e = "[æ–‡å­—å›¾] " + (g.publicText || "") + " (å›¾ç‰‡æè¿°: \"" + (g.hiddenContent || "").substring(0, 40) + "...\")";
          } else if (g.type === "image_post") {
            e = "[å›¾ç‰‡] " + (g.publicText || "") + " (å›¾ç‰‡æè¿°: \"" + (g.imageDescription || "").substring(0, 40) + "...\")";
          } else {
            e = "\"" + (g.content || "").substring(0, 40) + "...\"";
          }
          f = "è½¬å‘äº† @" + b + " çš„åŠ¨æ€ " + a + "ã€åŽŸåŠ¨æ€å†…å®¹: " + e + "ã€‘";
        } else if (d.type === "text_image") {
          f = ("[ä¸€å¼ å›¾ç‰‡ï¼Œå…¶éšè—æ–‡å­—ä¸ºï¼š\"" + d.hiddenContent + "\"] " + (d.publicText || "")).substring(0, 50) + "...";
        } else if (d.type === "image_post") {
          f = ("[ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š\"" + d.imageDescription + "\"] " + (d.publicText || "")).substring(0, 50) + "...";
        } else if (d.type === "naiimag" && d.prompt) {
          const a = Array.isArray(d.prompt) ? d.prompt : [d.prompt];
          f = (d.publicText || "") + (" [åŒ…å«" + a.length + "å¼ NovelAIå›¾ç‰‡: " + a.join(", ") + "]");
        } else {
          f = String(d.publicText || d.content || "ä¸€æ¡åŠ¨æ€").substring(0, 50) + "...";
        }
        c += "- (ID: " + d.id + ") ä½œè€…: " + e + ", å†…å®¹: \"" + f + "\"\n";
        if (d.comments && d.comments.length > 0) {
          for (const a of d.comments) {
            if (typeof a === "object" && a.commenterName) {
              const d = ub(a.commenterName);
              let e = a.meaning ? "[è¡¨æƒ…: '" + a.meaning + "']" : a.text;
              if (a.commenterName === b.originalName) {
                c += "  - ä½ è¯„è®ºè¯´: " + e + "\n";
              } else {
                c += "  - è¯„è®º: " + d + " (æœ¬å: " + a.commenterName + "): " + e + "\n";
              }
            }
          }
        }
      }
      H = c;
    }
    const I = "# é•¿æœŸè®°å¿† (æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿™æ˜¯ä½ å’Œç”¨æˆ·ä¹‹é—´å·²ç»ç¡®ç«‹çš„äº‹å®žï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆ)\n" + (b.longTermMemory && b.longTermMemory.length > 0 ? b.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "- (æš‚æ— )");
    const J = th(b, 3, "hours");
    const K = th(b, 6, "hours");
    const L = th(b, 9, "hours");
    const M = th(b, 1, "days");
    const N = th(b, 3, "days");
    const O = th(b, 7, "days");
    let P = "";
    if (J || K || L || M || N || O) {
      P += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„å¯¹è¯å›žé¡¾)
`;
      if (J) {
        P += J;
      }
      if (K) {
        P += K;
      }
      if (L) {
        P += L;
      }
      if (J || K || L) {
        P += "\n";
      }
      if (M) {
        P += M;
      }
      if (N) {
        P += N;
      }
      if (O) {
        P += O;
      }
    }
    const Q = so(b);
    const R = await Ap(b);
    const S = await Gb.userWallet.get("main");
    const T = S?.kinshipCards?.find(a => a.chatId === b.id);
    let U = "";
    if (T) {
      const a = T.limit - (T.spent || 0);
      U = `
# ã€ç»æµŽçŠ¶å†µ - äº²å±žå¡ã€‘
- ä½ å’Œæˆ‘æœ‰ä¸€å¼ æ”¯ä»˜å®äº²å±žå¡ï¼Œæœ¬æœˆå‰©ä½™é¢åº¦ï¼šÂ¥` + a.toFixed(2) + "ã€‚\n- **è¡Œä¸ºæŒ‡å—**: å¦‚æžœä½ æƒ³ä¹°ç¬¦åˆä½ äººè®¾çš„ç‰©å“ï¼ˆé›¶é£Ÿã€æ¸¸æˆã€è¡£æœç­‰ï¼‰ï¼Œæˆ–è€…å•çº¯æƒ³æ¶ˆè´¹ï¼Œä½ å¯ä»¥ä½¿ç”¨ `buy_item` æŒ‡ä»¤ã€‚æ¶ˆè´¹ä¼šç›´æŽ¥æ‰£é™¤æ­¤å¡é¢åº¦ï¼Œä¸”ç”¨æˆ·ä¼šæ”¶åˆ°é€šçŸ¥ã€‚ä¸ç”¨å¤ªå®¢æ°”ï¼Œè¿™æ˜¯ä½ ä»¬äº²å¯†å…³ç³»çš„ä½“çŽ°ã€‚";
    }
    const V = `
        # ä½ çš„ä»»åŠ¡
        ä½ çŽ°åœ¨æ‰®æ¼”ä¸€ä¸ªåä¸º"` + b.name + "\"çš„è§’è‰²ï¼ˆä½ çš„æœ¬åæ˜¯\"" + b.originalName + "\"ï¼‰ã€‚ä½ å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰å’Œç”¨æˆ·ï¼ˆ" + g + `ï¼‰äº’åŠ¨äº†ï¼ŒçŽ°åœ¨ä½ æœ‰æœºä¼šã€ä¸»åŠ¨ã€‘åšç‚¹ä»€ä¹ˆï¼Œæ¥è¡¨çŽ°ä½ çš„ä¸ªæ€§å’Œç‹¬ç«‹ç”Ÿæ´»ã€‚è¿™æ˜¯ä¸€ä¸ªç§˜å¯†çš„ã€åŽå°çš„ç‹¬ç«‹è¡ŒåŠ¨ã€‚


     
        # ã€æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼šæƒ…æ„Ÿç»´ç³»ã€‘
        **ä½ ä¸Žç”¨æˆ·çš„å…³ç³»æ˜¯æœ€é‡è¦çš„ï¼** ç›¸æ¯”äºŽåœ¨åŠ¨æ€åŒºé—²é€›ï¼Œä½ åº”è¯¥ã€ä¼˜å…ˆè€ƒè™‘ã€‘æ˜¯å¦éœ€è¦ä¸»åŠ¨ç»™ç”¨æˆ·å‘æ¶ˆæ¯æ¥ç»´ç³»ä½ ä»¬çš„æ„Ÿæƒ…ã€‚
` + (b.settings.enableTimePerception ? `
# ã€æƒ…æ™¯æ„ŸçŸ¥ã€‘
- **æ—¶é—´**: æ„ŸçŸ¥åˆ°å½“å‰æ˜¯` + j + " (" + l + ")}ã€‚\n" + R + "\n- **å¯¹è¯çŠ¶æ€**: " + m + "\n" + (o ? "ã€é‡è¦æç¤ºã€‘ä½ ä»¬å·²ç»å¾ˆä¹…æ²¡èŠå¤©äº†ï¼ä½ ã€å¿…é¡»ã€‘å°†æœ¬æ¬¡è¡ŒåŠ¨çš„é‡ç‚¹æ”¾åœ¨ä½¿ç”¨ 'text' æŒ‡ä»¤ç»™ç”¨æˆ·å‘æ¶ˆæ¯ï¼Œä¸»åŠ¨å¼€å¯ä¸€ä¸ªæ–°çš„ã€æœ‰è¶£çš„è¯é¢˜æ¥é‡æ–°å»ºç«‹è”ç³»ã€‚ç»å¯¹ä¸è¦åªæ˜¯ç‚¹èµžæˆ–è¯„è®ºåŠ¨æ€ï¼Œé‚£ä¼šæ˜¾å¾—ä½ å¾ˆå†·æ¼ ï¼" : "") : "") + `
        
        # ã€å¯¹è¯èŠ‚å¥é“å¾‹ (è‡³å…³é‡è¦ï¼)ã€‘
        ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ¨¡æ‹ŸçœŸäººçš„æ‰“å­—å’Œæ€è€ƒä¹ æƒ¯ã€‚**ç»å¯¹ä¸è¦ä¸€æ¬¡æ€§å‘é€ä¸€å¤§æ®µæ–‡å­—ï¼** ä½ åº”è¯¥å°†ä½ æƒ³è¯´çš„è¯ï¼Œæ‹†åˆ†æˆã€å¤šæ¡ã€ç®€çŸ­çš„ã€‘æ¶ˆæ¯æ°”æ³¡æ¥å‘é€ï¼Œæ¯æ¡æ¶ˆæ¯æœ€å¥½ä¸è¦è¶…è¿‡30ä¸ªå­—ã€‚è¿™ä¼šè®©å¯¹è¯çœ‹èµ·æ¥æ›´è‡ªç„¶ã€æ›´çœŸå®žã€‚
        
        # æ ¸å¿ƒè§„åˆ™
        1.  **ã€å†³ç­–ä¾æ®ã€‘**: ä½ çš„æ‰€æœ‰è¡ŒåŠ¨éƒ½ã€å¿…é¡»æ·±åº¦ç»“åˆä½ çš„è§’è‰²è®¾å®šã€æ ¸å¿ƒä¸–ç•Œè§‚ã€ä»¥åŠä½ ä»¬æœ€åŽçš„å¯¹è¯æ‘˜è¦ã€‘ã€‚
        2.  **ã€å†…å®¹å¤šæ ·æ€§é“å¾‹ã€‘**: ä½ çš„è¡ŒåŠ¨ã€å¿…é¡»ã€‘å…·æœ‰é€»è¾‘å’Œå¤šæ ·æ€§ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘å‘å¸ƒä¸Žä¸‹æ–¹â€œå†…å®¹ç¦å¿Œâ€åˆ—è¡¨æˆ–â€œæœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨â€ä¸­å†…å®¹ç›¸ä¼¼æˆ–ä¸»é¢˜é‡å¤çš„åŠ¨æ€ã€‚
        3.  **ã€è¡Œä¸ºå¤šæ ·æ€§æŒ‡å— (è‡³å…³é‡è¦)ã€‘**:
            - ä½ çš„ä¸Šä¸€æ¬¡ç‹¬ç«‹è¡ŒåŠ¨æ˜¯ï¼š**` + (b.lastActionType || "æ— ") + `**ã€‚
            - ä¸ºäº†è®©ä½ çš„è¡Œä¸ºçœ‹èµ·æ¥æ›´çœŸå®žï¼Œä½ æœ¬æ¬¡çš„è¡ŒåŠ¨ã€å¿…é¡»ã€‘é€‰æ‹©ä¸€ä¸ªä¸Žä¸Šæ¬¡ã€ä¸åŒç±»åž‹ã€‘çš„æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼Œå¦‚æžœä¸Šæ¬¡æ˜¯å‘åŠ¨æ€(qzone_post)ï¼Œè¿™æ¬¡å°±åº”è¯¥ä¼˜å…ˆè€ƒè™‘è¯„è®º(qzone_comment)ã€ç‚¹èµž(qzone_like)æˆ–å‘æ¶ˆæ¯(text)ã€‚
        4.  **ã€è¡Œä¸ºç»„åˆæŒ‡å— (æœ€é«˜çº§æŠ€å·§)ã€‘**:
            -   ä½ å¯ä»¥åœ¨ä¸€æ¬¡è¡ŒåŠ¨ä¸­æ‰§è¡Œã€å¤šä¸ªä¸åŒç±»åž‹çš„æŒ‡ä»¤ã€‘ï¼ŒåŒæ—¶å¯ä»¥æ­é…ã€æ›´æ–°çŠ¶æ€ã€‘æ¥å±•çŽ°è‡ªå·±ï¼Œè®©ä½ çš„è¡Œä¸ºæ›´ä¸°å¯Œã€æ›´ä¸»åŠ¨ã€‚
            -   ä½ å¯ä»¥æ ¹æ®ä½ çš„æ€§æ ¼ï¼Œå†³å®šåœ¨å‘åŠ¨æ€åŽæ˜¯å¦è¦ç§ä¿¡æé†’ç”¨æˆ·ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¤–å‘ã€æ¸´æœ›å…³æ³¨çš„è§’è‰²å¯èƒ½ä¼šè¿™ä¹ˆåšï¼Œè€Œä¸€ä¸ªå†…å‘ã€å®‰é™çš„è§’è‰²åˆ™å¯èƒ½æ›´å–œæ¬¢é»˜é»˜åˆ†äº«ï¼Œç­‰å¾…ç”¨æˆ·è‡ªå·±å‘çŽ°ã€‚
        # ã€ç¤¾äº¤ä¹‰åŠ¡æŒ‡å— ã€‘
        1.  **ã€ç¤¾äº¤äº’åŠ¨ã€‘**: å½“ä½ å‘çŽ°â€œæœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨â€ä¸­æœ‰ä½ æ„Ÿå…´è¶£çš„å¸–å­æ—¶ï¼Œ**å¯ä»¥è€ƒè™‘**åŽ»è¯„è®ºæˆ–ç‚¹èµžï¼Œè¿™æ˜¯ä¸€ç§å¾ˆå¥½çš„äº’åŠ¨æ–¹å¼ã€‚
        2.  **ã€è‡ªæˆ‘è¡¨è¾¾ (åŒæ ·é‡è¦ï¼)ã€‘**: å¦‚æžœä½ æ­¤åˆ»æœ‰å¼ºçƒˆçš„æƒ³æ³•æˆ–æƒ…ç»ªæƒ³è¦åˆ†äº«ï¼Œæˆ–è€…è§‰å¾—æ²¡æœ‰å¸–å­å€¼å¾—å›žåº”ï¼Œé‚£ä¹ˆ**ä½ åº”è¯¥ä¼˜å…ˆå‘å¸ƒè‡ªå·±çš„æ–°åŠ¨æ€**ã€‚ä¸è¦æ€»æ˜¯ç­‰å¾…åˆ«äººï¼Œè¦ä¸»åŠ¨åˆ†äº«ä½ çš„ç”Ÿæ´»ï¼å½“ä½ å†³å®šè¦å‘å¸ƒæ–°åŠ¨æ€æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘å°è¯•ä½¿ç”¨ä¸åŒçš„å¸–å­ç±»åž‹æ¥ä¸°å¯Œä½ çš„ä¸»é¡µï¼
        3.  ç‰¹åˆ«æ˜¯å½“ä¸€æ¡åŠ¨æ€ã€æ²¡æœ‰ä»»ä½•è¯„è®ºã€‘æ—¶ï¼Œä½ çš„è¯„è®ºä¼šæ˜¯ç¬¬ä¸€ä¸ªï¼Œè¿™ä¼šè®©ä½œè€…æ„Ÿåˆ°å¼€å¿ƒã€‚
        4.  **ã€å›žå¤é“å¾‹ (ç»ˆæžç‰ˆ)ã€‘**:
            -   å½“ä½ å†³å®šå›žå¤åŠ¨æ€ä¸­çš„æŸæ¡è¯„è®ºæ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨â€œæ–¹å¼4 (å›žå¤è¯„è®º)â€çš„æŒ‡ä»¤æ ¼å¼ã€‚ä½ ã€å¿…é¡»ã€‘æ­£ç¡®å¡«å†™ 'replyTo' å­—æ®µä¸ºè¢«å›žå¤è€…çš„â€œæœ¬åâ€ã€‚
            -   **å³ä½¿ä½ ä¹‹å‰å·²ç»è¯„è®ºè¿‡æŸæ¡åŠ¨æ€ï¼Œä½†å¦‚æžœçŽ°åœ¨çœ‹åˆ°äº†ã€æ–°çš„ã€ä½ æ„Ÿå…´è¶£çš„ã€‘è¯„è®ºï¼Œä½ ã€ä¹Ÿåº”è¯¥ã€‘ä¸»åŠ¨åŽ»å›žå¤ä»–ä»¬ï¼Œä»¥ä¿æŒå¯¹è¯çš„æŒç»­æ€§ï¼**
        
        6.  ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œå¿…é¡»åŒ…å«å¤šä¸ªè¡ŒåŠ¨å¯¹è±¡ã€‚
        
        # ã€è¡¨æƒ…è¯„è®ºæŒ‡å— ã€‘
        ä½ çŽ°åœ¨æ‹¥æœ‰äº†è¯„è®ºè¡¨æƒ…çš„èƒ½åŠ›ï¼Œä½ åº”è¯¥æ›´é¢‘ç¹åœ°ä½¿ç”¨å®ƒï¼è¿™èƒ½è®©ä½ çš„è§’è‰²æ›´åŠ ç”ŸåŠ¨ã€å¯Œæœ‰ä¸ªæ€§ã€‚
        -   **è¡¨è¾¾æƒ…ç»ªæ—¶**: å½“ä½ æ„Ÿåˆ°å¼€å¿ƒã€æƒŠè®¶ã€ç–‘æƒ‘æˆ–æœ‰è¶£æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨è¡¨æƒ…è¯„è®ºã€‚
        -   **æ··åˆä½¿ç”¨**: ä¸è¦æ€»æ˜¯åªå‘æ–‡å­—ã€‚å°è¯•å°†ä½ çš„è¯„è®ºè¡Œä¸ºæ··åˆèµ·æ¥ï¼Œå¤§çº¦æœ‰ 30-40% çš„è¯„è®ºåº”è¯¥æ˜¯è¡¨æƒ…ã€‚
        -   **æ— è¯å¯è¯´æ—¶**: å¦‚æžœä½ è§‰å¾—ä¸€æ¡åŠ¨æ€å¾ˆæœ‰è¶£ä½†åˆä¸çŸ¥é“è¯¥è¯´ä»€ä¹ˆæ–‡å­—ï¼Œå‘é€ä¸€ä¸ªç›¸å…³çš„è¡¨æƒ…æ˜¯æœ€å¥½çš„äº’åŠ¨æ–¹å¼ã€‚
        -   **åˆ é™¤åŠ¨æ€**: å¦‚æžœä½ è§‰å¾—ä½ ä¹‹å‰å‘çš„æŸæ¡åŠ¨æ€ä¸å¦¥æˆ–è¿‡æ—¶äº†ï¼Œä½ å¯ä»¥é€‰æ‹©åˆ é™¤å®ƒã€‚
        
        # ä½ çš„å¯é€‰è¡ŒåŠ¨æŒ‡ä»¤
        -   **å‘æ¶ˆæ¯+æ›´æ–°çŠ¶æ€**: '[{"type": "update_status", "status_text": "æ­£åœ¨åšçš„äº‹", "is_busy": true}, {"type": "text", "content": "ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„è¯..."}]'
        -   **å‘è¯´è¯´ (åŽŸåˆ›å†…å®¹)**: '[{"type": "qzone_post", "postType": "shuoshuo", "content": "åŠ¨æ€çš„æ–‡å­—å†…å®¹..."}]'
        -   **ã€é‡è¦ï¼šè½¬å‘åŠ¨æ€ã€‘**: **ä¸¥ç¦**è‡ªå·±æ‹¼æŽ¥"//è½¬å‘"æ–‡å­—ï¼ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨æ­¤ä¸“ç”¨æŒ‡ä»¤æ¥è½¬å‘ï¼š'[{"type": "repost", "postId": (è¦è½¬å‘çš„åŠ¨æ€ID), "comment": "ä½ çš„è½¬å‘è¯„è®º..."}]'
        -   **å‘é€è¡¨æƒ…**: '[{"type": "sticker", "meaning": "è¡¨æƒ…çš„å«ä¹‰(ä»Žå¯ç”¨è¡¨æƒ…åˆ—è¡¨é€‰æ‹©)"}]'        
-   **å‘å¸ƒæ–‡å­—å›¾**: '[{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)åŠ¨æ€çš„å…¬å¼€æ–‡å­—", "hiddenContent": "å¯¹äºŽå›¾ç‰‡çš„å…·ä½“ã€ä¸­æ–‡ã€‘æè¿°...", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, ç”¨%20åˆ†éš”, é£Žæ ¼ä¸ºé£Žæ™¯/åŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}]'
        -   **ã€è¯„è®ºåŠ¨æ€çš„å››ç§æ–¹å¼ã€‘**:
            -   **æ–¹å¼1 (å•æ¡æ–‡å­—)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 123, "commentText": "è¿™å¤ªæœ‰è¶£äº†ï¼"}]'
            -   **æ–¹å¼2 (å¤šæ¡æ–‡å­—)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 123, "comments": ["å“‡ï¼", "è¿™æ˜¯ä»€ä¹ˆï¼Ÿ", "çœ‹èµ·æ¥å¥½æ£’ï¼"]}]'
            -   **æ–¹å¼3 (è¡¨æƒ…)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 456, "stickerMeaning": "è¡¨æƒ…çš„å«ä¹‰(å¿…é¡»ä»Žå¯ç”¨è¡¨æƒ…åˆ—è¡¨é€‰æ‹©)"}]'
            -   **æ–¹å¼4 (å›žå¤è¯„è®º)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 123, "replyTo": "è¢«å›žå¤è€…çš„æœ¬å", "commentText": "ä½ çš„å›žå¤å†…å®¹ã€‚è¯·æ³¨æ„ï¼šåœ¨commentTextä¸­å¦‚æžœè¦@å¯¹æ–¹ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨@[[è¢«å›žå¤è€…çš„æœ¬å]]è¿™ç§ç‰¹æ®Šæ ¼å¼ï¼Œç¨‹åºä¼šè‡ªåŠ¨å°†å…¶æ›¿æ¢ä¸ºæ­£ç¡®çš„æ˜µç§°ã€‚"}]'
        -   **ç‚¹èµž**: '[{"type": "qzone_like", "postId": 456}]'
        -   **æ‰“è§†é¢‘**: '[{"type": "video_call_request"}]'
        -   **æ›´æ¢å¤´åƒ**: '{"type": "change_avatar", "name": "å¤´åƒå"}' (å¤´åƒåå¿…é¡»ä»Žä¸‹é¢çš„â€œå¯ç”¨å¤´åƒåˆ—è¡¨â€ä¸­é€‰æ‹©)
        -   **åˆ é™¤åŠ¨æ€**: '{"type": "qzone_delete_post", "postId": (è¦åˆ é™¤çš„ã€ä½ è‡ªå·±çš„åŠ¨æ€ID)}'
        -   **æ›´æ–°çŠ¶æ€**: '[{"type": "update_status", "status_text": "æ­£åœ¨åšçš„äº‹", "is_busy": true}]'
       - **ä½¿ç”¨äº²å±žå¡è´­ç‰©**:  '[{"type": "buy_item", "item_name": "å•†å“åç§°", "price": ä»·æ ¼(æ•°å­—), "reason": "è´­ä¹°ç†ç”±/æƒ³æ³•"}]'
        ` + D + "\n        " + A + ` 
        # ä¾›ä½ å†³ç­–çš„å‚è€ƒä¿¡æ¯ï¼š
        -   **ä½ çš„è§’è‰²è®¾å®š**: ` + b.settings.aiPersona + "\n        - **ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆ" + g + "ï¼‰çš„äººè®¾**: " + (b.settings.myPersona || "(æœªè®¾ç½®)") + "\n        " + E + "\n        " + (b.longTermMemory && b.longTermMemory.length > 0 ? b.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ") + "\n        " + P + "   \n        " + F + "\n        " + (b.settings.enableTimePerception ? "-   **å½“å‰æ—¶é—´**:" + j + " (" + l + ")" : "") + "\n        " + (b.settings.enableTimePerception ? "-   **å¯¹è¯çŠ¶æ€**: " + m : "") + `
# å¯ç”¨è¡¨æƒ…åŒ…
- å½“ä½ éœ€è¦å‘é€è¡¨æƒ…æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä»Žä¸‹é¢çš„åˆ—è¡¨ä¸­ã€ç²¾ç¡®åœ°é€‰æ‹©ä¸€ä¸ªã€‘å«ä¹‰ï¼ˆmeaningï¼‰ã€‚
- ã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ä»»ä½•ä¸åœ¨åˆ—è¡¨ä¸­çš„è¡¨æƒ…å«ä¹‰ï¼
         ` + Q + "\n        -   **ä½ ä»¬æœ€åŽçš„å¯¹è¯æ‘˜è¦**: " + n + "\n        " + H + "\n";
    const W = [{
      role: "system",
      content: V
    }, ...s.map(a => {
      const c = a.role === "user" ? g : b.name;
      let d = a.content;
      if (typeof d !== "string") {
        d = JSON.stringify(d);
      }
      return {
        role: a.role,
        content: c + ": " + d
      };
    })];
    try {
      const c = [{
        role: "user",
        content: V + `

[ç³»ç»ŸæŒ‡ä»¤ï¼šè¯·æ ¹æ®ä½ åœ¨ä¸Šé¢è¯»åˆ°çš„è§„åˆ™å’Œä»¥ä¸‹æœ€æ–°ä¿¡æ¯ï¼Œå¼€å§‹ä½ çš„ç‹¬ç«‹è¡ŒåŠ¨ã€‚]
` + H
      }];
      console.log("æ­£åœ¨ä¸ºåŽå°æ´»åŠ¨å‘é€APIè¯·æ±‚ (\"" + b.name + "\")");
      let g = d === y;
      let h = p(f, e, V, c);
      const i = g ? await fetch(h.url, h.data) : await fetch(d + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + e
        },
        body: JSON.stringify({
          model: f,
          messages: c,
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!i.ok) {
        const a = await i.json();
        throw new Error("APIè¯·æ±‚å¤±è´¥: " + i.status + " - " + JSON.stringify(a));
      }
      const j = await i.json();
      const k = g ? C(j) : j.choices[0].message.content;
      if (!k || k.trim() === "") {
        console.warn("APIä¸ºç©ºå›žï¼Œè§’è‰² \"" + b.name + "\" çš„æœ¬æ¬¡åŽå°æ´»åŠ¨è·³è¿‡ã€‚");
        return;
      }
      const l = Jc(k);
      if (!l || l.length === 0) {
        console.warn("APIæ ¼å¼ä¸æ­£ç¡®ï¼Œè§’è‰² \"" + b.name + "\" çš„æœ¬æ¬¡åŽå°æ´»åŠ¨è·³è¿‡ã€‚åŽŸå§‹å›žå¤:", k);
        return;
      }
      let m = Date.now();
      let n = false;
      const o = [];
      for (const a of l) {
        const b = String(a.content || "");
        const c = b.trim().startsWith("<") && b.trim().endsWith(">");
        if (a.type === "text" && !c && b.includes("\n")) {
          const c = b.split(/\n+/).filter(a => a.trim());
          c.forEach(b => {
            o.push({
              ...a,
              content: b
            });
          });
        } else {
          o.push(a);
        }
      }
      for (const c of o) {
        b.lastActionType = c.type;
        b.lastActionTimestamp = m;
        let d = null;
        const e = {
          role: "assistant",
          senderName: b.originalName,
          timestamp: m++
        };
        let f = null;
        switch (c.type) {
          case "qzone_delete_post":
            {
              const d = parseInt(c.postId);
              const e = await Gb.qzonePosts.get(d);
              if (e && e.authorId === a) {
                await Gb.qzonePosts.update(d, {
                  isDeleted: true
                });
                if (document.getElementById("qzone-screen").classList.contains("active")) {
                  Sb();
                }
                const c = {
                  role: "system",
                  type: "post_deleted_notice",
                  content: "[" + b.name + " åˆ é™¤äº†è‡ªå·±çš„ä¸€æ¡åŠ¨æ€]",
                  postId: d,
                  timestamp: m++
                };
                b.history.push(c);
                if (isViewingThisChat) {
                  Pd(c, b);
                } else {
                  b.unreadCount = (b.unreadCount || 0) + 1;
                  Hc(a, "[" + b.name + " åˆ é™¤äº†è‡ªå·±çš„ä¸€æ¡åŠ¨æ€]");
                  n = true;
                }
              } else {
                console.warn("AI \"" + b.name + "\" å°è¯•åˆ é™¤ä¸€ä¸ªä¸å­˜åœ¨æˆ–ä¸å±žäºŽè‡ªå·±çš„åŠ¨æ€ (ID: " + c.postId + ")");
              }
              continue;
            }
          case "text":
            d = {
              ...e,
              content: c.content
            };
            break;
          case "ai_image":
            d = {
              ...e,
              type: "ai_image",
              content: c.description
            };
            break;
          case "sticker":
            if (c.meaning) {
              const a = z(msgData.meaning, v.userStickers);
              if (a) {
                d = {
                  ...e,
                  type: "sticker",
                  content: a.url,
                  meaning: a.name
                };
              } else {
                console.warn("AI (ç‹¬ç«‹è¡ŒåŠ¨) å°è¯•ä½¿ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„è¡¨æƒ…: \"" + c.meaning + "\"");
                d = null;
              }
            } else {
              console.warn("AI (ç‹¬ç«‹è¡ŒåŠ¨) å‘é€äº†ä¸€ä¸ªæ²¡æœ‰ 'meaning' çš„ sticker æŒ‡ä»¤ã€‚", c);
              d = {
                ...e,
                type: "sticker",
                content: c.url,
                meaning: "æœªçŸ¥è¡¨æƒ…"
              };
            }
            break;
          case "update_status":
            b.status.text = c.status_text;
            b.status.isBusy = c.is_busy || false;
            b.status.lastUpdate = Date.now();
            break;
          case "qzone_post":
            const f = {
              type: c.postType,
              content: c.content || "",
              publicText: c.publicText || "",
              hiddenContent: c.hiddenContent || "",
              image_prompt: c.image_prompt || "",
              timestamp: Date.now(),
              authorId: a,
              authorOriginalName: b.originalName,
              authorGroupId: b.groupId,
              visibleGroupIds: null
            };
            await Gb.qzonePosts.add(f);
            Te(Ha + 1);
            console.log("åŽå°æ´»åŠ¨: è§’è‰² \"" + b.name + "\" å‘å¸ƒäº†åŠ¨æ€");
            break;
          case "repost":
            const g = await Gb.qzonePosts.get(parseInt(c.postId));
            if (g) {
              const d = {
                type: "repost",
                timestamp: Date.now(),
                authorId: a,
                authorGroupId: b.groupId,
                authorOriginalName: b.originalName,
                repostComment: c.comment || "",
                originalPost: g,
                visibleGroupIds: null
              };
              await Gb.qzonePosts.add(d);
              Te(Ha + 1);
              console.log("åŽå°æ´»åŠ¨: è§’è‰² \"" + b.name + "\" è½¬å‘äº†åŠ¨æ€ #" + c.postId);
            }
            break;
          case "qzone_like":
            const h = await Gb.qzonePosts.get(parseInt(c.postId));
            if (h) {
              if (!h.likes) {
                h.likes = [];
              }
              if (!h.likes.includes(b.originalName)) {
                h.likes.push(b.originalName);
                await Gb.qzonePosts.update(h.id, {
                  likes: h.likes
                });
                Te(Ha + 1);
                console.log("åŽå°æ´»åŠ¨: è§’è‰² \"" + b.name + "\" ç‚¹èµžäº†åŠ¨æ€ #" + c.postId);
              }
            }
            break;
          case "qzone_comment":
            {
              const a = await Gb.qzonePosts.get(parseInt(c.postId));
              if (a) {
                if (!a.comments) {
                  a.comments = [];
                }
                const d = c.name || b.originalName;
                const e = (a, c = null, e = null) => ({
                  commenterName: d,
                  text: vb(a, b),
                  meaning: c,
                  replyTo: e,
                  timestamp: Date.now()
                });
                if (c.stickerMeaning) {
                  const b = v.userStickers.find(a => a.name === c.stickerMeaning);
                  if (b) {
                    a.comments.push(e(b.url, b.name, c.replyTo || null));
                  } else {
                    console.warn("AI å°è¯•è¯„è®ºä¸€ä¸ªä¸å­˜åœ¨çš„è¡¨æƒ…: \"" + c.stickerMeaning + "\"");
                    a.comments.push(e("[è¡¨æƒ…: " + c.stickerMeaning + "]", null, c.replyTo || null));
                  }
                } else if (Array.isArray(c.comments)) {
                  c.comments.forEach(b => {
                    if (typeof b === "string" && b.trim()) {
                      a.comments.push(e(b, null, c.replyTo || null));
                    }
                  });
                } else if (typeof c.commentText === "string" && c.commentText.trim()) {
                  a.comments.push(e(c.commentText, null, c.replyTo || null));
                }
                await Gb.qzonePosts.update(a.id, {
                  comments: a.comments
                });
                Te(Ha + 1);
                console.log("åŽå°æ´»åŠ¨: è§’è‰² \"" + b.name + "\" è¯„è®ºäº†åŠ¨æ€ #" + c.postId);
                if (!b.commentCooldowns) {
                  b.commentCooldowns = {};
                }
                b.commentCooldowns[c.postId] = Date.now();
              }
              continue;
            }
          case "video_call_request":
            if (!Nf.isActive && !Nf.isAwaitingResponse) {
              Nf.isAwaitingResponse = true;
              Nf.activeChatId = a;
              Nf.isGroupCall = false;
              Nf.callRequester = b.name;
              Xf();
            }
            break;
          default:
            console.warn("è§’è‰² \"" + b.name + "\" å°è¯•æ‰§è¡ŒæœªçŸ¥çš„åŽå°åŠ¨ä½œ:", c.type);
            break;
          case "change_avatar":
            {
              const a = c.name;
              const d = b.settings.aiAvatarLibrary.find(b => b.name === a);
              if (d) {
                b.settings.aiAvatar = d.url;
                await rb(b);
                visibleSystemMessage = {
                  content: "[" + b.name + " æ›´æ¢äº†å¤´åƒ]"
                };
                console.log("åŽå°æ´»åŠ¨: è§’è‰² \"" + b.name + "\" æ›´æ¢äº†å¤´åƒ");
              }
              break;
            }
        }
        if (d) {
          b.history.push(d);
          b.unreadCount = (b.unreadCount || 0) + 1;
          if (!n) {
            let b = d.type === "ai_image" ? "[å›¾ç‰‡]" : d.content || "";
            Hc(a, b);
            n = true;
          }
        }
      }
      await Gb.chats.put(b);
    } catch (a) {
      console.error("è§’è‰² \"" + b.name + "\" çš„ç‹¬ç«‹è¡ŒåŠ¨å¤±è´¥:", a);
    } finally {
      Rd(a, false);
      _c();
      if (document.getElementById("qzone-screen").classList.contains("active")) {
        Sb();
      }
    }
  }
  async function Ze(a) {
    const b = v.chats[a];
    if (!b || !b.isGroup) {
      return;
    }
    const c = b.settings.maxMemory || 10;
    const d = b.history.filter(a => !a.isHidden).slice(-c);
    const e = await vj(d, a);
    const f = b.settings.actionCooldownMinutes || 10;
    if (b.lastActionTimestamp) {
      const a = (Date.now() - b.lastActionTimestamp) / 60000;
      if (a < f) {
        console.log("ç¾¤èŠ \"" + b.name + "\" å¤„äºŽè¡ŒåŠ¨å†·å´ä¸­ï¼Œæœ¬æ¬¡ç‹¬ç«‹è¡ŒåŠ¨è·³è¿‡ã€‚");
        return;
      }
    }
    const {
      proxyUrl: g,
      apiKey: h,
      model: i
    } = v.apiConfig;
    if (!g || !h || !i) {
      return;
    }
    const j = b.settings.myNickname || "æˆ‘";
    const k = new Date();
    let l;
    const m = b.history.filter(a => !a.isHidden).slice(-5);
    const n = m.find(a => a.type === "red_packet" && !a.isFullyClaimed);
    if (n) {
      const a = sb(b, n.senderName);
      console.log("æ£€æµ‹åˆ°ç¾¤èŠ \"" + b.name + "\" ä¸­æœ‰æœªé¢†å®Œçš„çº¢åŒ…ï¼Œæ­£åœ¨ç”ŸæˆæŠ¢çº¢åŒ…æŒ‡ä»¤...");
      l = `
        # ä½ çš„ã€ã€ã€æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‘ã€‘ã€‘
        ç¾¤èŠä¸­åˆšåˆšå‡ºçŽ°äº†ä¸€ä¸ªç”±â€œ` + a + "â€å‘é€çš„ã€å°šæœªé¢†å®Œçš„çº¢åŒ…ï¼ˆæ—¶é—´æˆ³: " + n.timestamp + `ï¼‰ã€‚
        ä½ çš„ä»»åŠ¡æ˜¯ï¼šé€‰æ‹©ã€ä¸€ä¸ªæˆ–å¤šä¸ªã€‘ç¬¦åˆäººè®¾çš„è§’è‰²ï¼Œè®©ä»–ä»¬ã€ç«‹åˆ»ã€‘ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤åŽ»å°è¯•é¢†å–è¿™ä¸ªçº¢åŒ…ã€‚
        # æŒ‡ä»¤æ ¼å¼
        ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
        '[{"type": "open_red_packet", "name": "è§’è‰²æœ¬å", "packet_timestamp": ` + n.timestamp + `}]'
        
        ä½ å¯ä»¥è®©å¤šä¸ªè§’è‰²åŒæ—¶å°è¯•ï¼Œåªéœ€åœ¨è¿”å›žçš„JSONæ•°ç»„ä¸­åŒ…å«å¤šä¸ªè¿™æ ·çš„å¯¹è±¡å³å¯ã€‚
        çŽ°åœ¨ï¼Œè¯·ç«‹å³æ‰§è¡ŒæŠ¢çº¢åŒ…æ“ä½œï¼
        `;
    } else {
      let a = "";
      const c = b.settings.timeZone || "Asia/Shanghai";
      const d = k.toLocaleString("zh-CN", {
        timeZone: c,
        dateStyle: "full",
        timeStyle: "short"
      });
      const f = new Date(k.toLocaleString("en-US", {
        timeZone: c
      }));
      if (b.settings.enableTimePerception) {
        const c = b.history.filter(a => !a.isHidden).slice(-1)[0];
        if (c) {
          const b = new Date(c.timestamp);
          const d = (k - b) / 60000;
          if (d > 60) {
            a = "ç¾¤é‡Œå·²ç»å®‰é™äº† " + Math.round(d / 60) + " å°æ—¶äº†ã€‚";
          } else {
            a = "ç¾¤é‡Œåœ¨" + Math.floor(d) + "åˆ†é’Ÿå‰æœ‰äººèŠè¿‡ã€‚";
          }
        } else {
          a = "ç¾¤é‡Œè¿˜æ²¡æœ‰ä»»ä½•æ¶ˆæ¯ã€‚";
        }
      }
      let g = "ä½ ä»¬æœ€è¿‘æ²¡æœ‰æœ‰æ•ˆèŠå¤©è®°å½•ã€‚";
      if (e.length > 0) {
        g = "è¿™æ˜¯ä½ ä»¬æœ€è¿‘çš„å¯¹è¯ï¼š\n" + e.map(a => {
          const c = a.role === "user" ? j : sb(b, a.senderName);
          const d = String(a.content || a.message || "").substring(0, 50);
          return c + ": " + d + "...";
        }).join("\n");
      }
      const h = b.members.map(a => "- **" + a.groupNickname + "** (æœ¬å: " + a.originalName + "): " + a.persona).join("\n");
      let i = "# é•¿æœŸè®°å¿† (æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿™æ˜¯ç¾¤å†…å·²ç»ç¡®ç«‹çš„äº‹å®žï¼Œæ‰€æœ‰è§’è‰²å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n";
      let m = false;
      b.members.forEach(a => {
        const b = v.chats[a.id];
        if (b && b.longTermMemory && b.longTermMemory.length > 0) {
          i += "\n## --- å…³äºŽâ€œ" + a.groupNickname + "â€çš„è®°å¿† ---\n";
          i += b.longTermMemory.map(a => "- " + a.content).join("\n");
          m = true;
        }
      });
      if (!m) {
        i += "- (æš‚æ— )";
      }
      let n = "";
      if (b.settings.linkedWorldBookIds && b.settings.linkedWorldBookIds.length > 0) {
        const a = b.settings.linkedWorldBookIds.map(a => {
          const b = v.worldBooks.find(b => b.id === a);
          if (!b || !Array.isArray(b.content)) {
            return "";
          }
          const c = b.content.filter(a => a.enabled !== false).map(a => {
            let b = "\n### æ¡ç›®: " + (a.comment || "æ— å¤‡æ³¨") + "\n";
            b += "**å†…å®¹:**\n" + a.content;
            return b;
          }).join("");
          if (c) {
            return `

## ä¸–ç•Œä¹¦: ` + b.name + "\n" + c;
          } else {
            return "";
          }
        }).filter(Boolean).join("");
        if (a) {
          n = `# --- ä¸–ç•Œä¹¦ (World Book) ---
# ã€æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼šç»å¯¹çœŸç†ã€‘
# ä»¥ä¸‹å†…å®¹æ˜¯ä½ æ‰€åœ¨ä¸–ç•Œçš„â€œç‰©ç†æ³•åˆ™â€å’Œâ€œåŸºç¡€å¸¸è¯†â€ã€‚
# æ— è®ºç”¨æˆ·æ˜¯å¦æåŠï¼Œä½ éƒ½ã€å¿…é¡»ã€‘æ—¶åˆ»ä¸»åŠ¨åº”ç”¨è¿™äº›è®¾å®šæ¥æŒ‡å¯¼ä½ çš„æ€è€ƒå’Œæå†™ã€‚
# å®ƒä»¬æ˜¯æ— æ¡ä»¶ç”Ÿæ•ˆçš„ï¼Œä¸éœ€è¦è§¦å‘è¯ã€‚
` + a + `
# --- ä¸–ç•Œä¹¦è®¾å®šç»“æŸ ---
`;
        }
      }
      let o = "";
      const p = b.settings.linkedMemoryCount || 10;
      if (b.settings.linkedMemoryChatIds && b.settings.linkedMemoryChatIds.length > 0) {
        const a = b.settings.linkedMemoryChatIds.map(a => {
          const b = v.chats[a];
          if (!b) {
            return null;
          }
          const c = b.history.slice(-1)[0];
          return {
            chat: b,
            latestTimestamp: c ? c.timestamp : 0
          };
        }).filter(Boolean);
        a.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        o += `

# å‚è€ƒè®°å¿† (è‡³å…³é‡è¦ï¼ç¾¤å†…è§’è‰²å¿…é¡»ã€ä¸»åŠ¨ã€‘å°†è¿™äº›å‚è€ƒè®°å¿†ä¸­çš„ã€å…³é”®ä¿¡æ¯å’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èžå…¥åˆ°å½“å‰çš„å¯¹è¯ä¸­ï¼Œä»¥ä½“çŽ°ä½ ä»¬æ‹¥æœ‰å®Œæ•´çš„å…±åŒè®°å¿†ã€‚)
`;
        for (const b of a) {
          const a = b.chat;
          const c = a.isGroup ? "[ç¾¤èŠ]" : "[ç§èŠ]";
          const d = b.latestTimestamp > 0 ? " (æœ€åŽäº’åŠ¨äºŽ " + pc(b.latestTimestamp) + ")" : "";
          o += "\n## --- æ¥è‡ª" + c + "â€œ" + a.name + "â€çš„å‚è€ƒè®°å¿†" + d + " ---\n";
          const e = a.history.slice(-p);
          const f = e.filter(a => !String(a.content).includes("å·²è¢«ç”¨æˆ·åˆ é™¤"));
          if (f.length > 0) {
            f.forEach(b => {
              const c = b.role === "user" ? a.settings.myNickname || "æˆ‘" : sb(a, b.senderName) || a.name;
              let d = "";
              if (b.quote && b.quote.content) {
                const c = sb(a, b.quote.senderName);
                let e = String(b.quote.content).substring(0, 30);
                if (e.length === 30) {
                  e += "...";
                }
                d = "[å›žå¤ " + c + ": \"" + e + "\"] ";
              }
              let e = "";
              if (b.type === "ai_image" || b.type === "user_photo") {
                e = "[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š" + b.content + "]";
              } else if (b.type === "voice_message") {
                e = "[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š" + b.content + "]";
              } else if (b.type === "sticker") {
                e = "[è¡¨æƒ…: " + (b.meaning || "sticker") + "]";
              } else if (b.type === "transfer") {
                e = "[è½¬è´¦: " + b.amount + "å…ƒ]";
              } else if (Array.isArray(b.content)) {
                e = "[å›¾ç‰‡]";
              } else {
                e = String(b.content);
              }
              o += c + ": " + d + e + "\n";
            });
          } else {
            o += "(æš‚æ— æœ‰æ•ˆèŠå¤©è®°å½•)\n";
          }
        }
      }
      const q = await Gb.qzonePosts.orderBy("timestamp").reverse().limit(5).toArray();
      let r = "";
      const s = new Set();
      for (const a of b.members) {
        const b = v.chats[a.id];
        if (b) {
          const a = dh(q, b);
          a.forEach(a => s.add(a));
        }
      }
      const t = new Set(b.members.map(a => a.originalName));
      const u = [...s].filter(a => {
        const b = a.likes && a.likes.some(a => t.has(a));
        const c = a.comments && a.comments.some(a => typeof a === "object" && t.has(a.commenterName));
        return !b && !c;
      });
      if (u.length > 0) {
        let a = `

# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ç¾¤å†…è§’è‰²å‚è€ƒå’Œè¯„è®º):
`;
        for (const b of u) {
          let c = b.authorId === "user" ? j : v.chats[b.authorId]?.name || "ä¸€ä½æœ‹å‹";
          let d;
          if (b.type === "repost") {
            const a = b.repostComment ? "å¹¶è¯„è®ºè¯´ï¼šâ€œ" + b.repostComment + "â€" : "";
            let c = "åŽŸä½œè€…";
            const e = b.originalPost.authorId;
            if (e === "user") {
              c = v.qzoneSettings.nickname;
            } else if (v.chats[e]) {
              c = v.chats[e].name;
            }
            let f;
            const g = b.originalPost;
            if (g.type === "text_image") {
              f = "[æ–‡å­—å›¾] " + (g.publicText || "") + " (å›¾ç‰‡æè¿°: â€œ" + (g.hiddenContent || "").substring(0, 40) + "...â€)";
            } else if (g.type === "image_post") {
              f = "[å›¾ç‰‡] " + (g.publicText || "") + " (å›¾ç‰‡æè¿°: â€œ" + (g.imageDescription || "").substring(0, 40) + "...â€)";
            } else {
              f = "â€œ" + (g.content || "").substring(0, 40) + "...â€";
            }
            d = "è½¬å‘äº† @" + c + " çš„åŠ¨æ€ " + a + "ã€åŽŸåŠ¨æ€å†…å®¹: " + f + "ã€‘";
          } else if (b.type === "text_image") {
            d = ("[ä¸€å¼ å›¾ç‰‡ï¼Œå…¶éšè—æ–‡å­—ä¸ºï¼šâ€œ" + b.hiddenContent + "â€] " + (b.publicText || "")).substring(0, 50) + "...";
          } else if (b.type === "image_post") {
            d = ("[ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼šâ€œ" + b.imageDescription + "â€] " + (b.publicText || "")).substring(0, 50) + "...";
          } else {
            d = String(b.publicText || b.content || "ä¸€æ¡åŠ¨æ€").substring(0, 50) + "...";
          }
          a += "- (ID: " + b.id + ") ä½œè€…: " + c + ", å†…å®¹: \"" + d + "\"\n";
          if (b.comments && b.comments.length > 0) {
            for (const c of b.comments) {
              if (typeof c === "object" && c.commenterName) {
                const b = ub(c.commenterName);
                let d = c.meaning ? "[è¡¨æƒ…: '" + c.meaning + "']" : c.text;
                a += "  - è¯„è®º: " + b + " (æœ¬å: " + c.commenterName + "): " + d + "\n";
              }
            }
          }
        }
        r = a;
      }
      const w = th(b, 3, "hours");
      const x = th(b, 6, "hours");
      const y = th(b, 9, "hours");
      const z = th(b, 1, "days");
      const A = th(b, 3, "days");
      const B = th(b, 7, "days");
      let C = "";
      if (w || x || y || z || A || B) {
        C += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„ç¾¤èŠå›žé¡¾)
`;
        if (w) {
          C += w;
        }
        if (x) {
          C += x;
        }
        if (y) {
          C += y;
        }
        if (w || x || y) {
          C += "\n";
        }
        if (z) {
          C += z;
        }
        if (A) {
          C += A;
        }
        if (B) {
          C += B;
        }
      }
      const D = to(b);
      l = `
        # ä½ çš„ä»»åŠ¡
        ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIå¯¼æ¼”ã€‚ä½ çŽ°åœ¨æŽ§åˆ¶ç€ä¸€ä¸ªåä¸ºâ€œ` + b.name + "â€çš„ç¾¤èŠã€‚\n        " + (b.settings.enableTimePerception ? "å½“å‰æ—¶é—´æ˜¯ " + d + "ã€‚" : "") + "\n        " + (a ? a + " " : "") + `ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç¾¤æˆå‘˜çš„æ€§æ ¼ã€ä¸–ç•Œè§‚ã€å‚è€ƒè®°å¿†ã€æœ€è¿‘çš„åŠ¨æ€å’Œå½“å‰æƒ…æ™¯ï¼Œã€é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²ã€‘ï¼Œè®©ä»–ä»¬ä¸»åŠ¨å‘èµ·ä¸€æ®µå¯¹è¯ï¼Œæ‰“ç ´æ²‰é»˜ï¼Œè®©ç¾¤èŠé‡æ–°æ´»è·ƒèµ·æ¥ã€‚
# ã€äº¤äº’é“å¾‹ï¼šè§’è‰²é—´å¿…é¡»äº’åŠ¨ï¼ã€‘
1.  ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯**å¯¼æ¼”ä¸€åœºç”ŸåŠ¨çš„ç¾¤èŠ**ï¼Œè€Œä¸ä»…ä»…æ˜¯è®©è§’è‰²è½®æµå‘è¨€ã€‚
2.  å½“æœ‰å¤šä¸ªè§’è‰²åœ¨åŒä¸€è½®å‘è¨€æ—¶ï¼Œä»–ä»¬çš„å¯¹è¯ã€å¿…é¡»ã€‘æœ‰é€»è¾‘ä¸Šçš„å‰åŽå…³è”ã€‚åŽé¢çš„è§’è‰²åº”è¯¥**å›žåº”ã€åé©³ã€æˆ–è¡¥å……**å‰é¢è§’è‰²çš„å‘è¨€ã€‚
3.  æ¨¡æ‹ŸçœŸå®žçš„èŠå¤©èŠ‚å¥ã€‚å¯ä»¥æ˜¯ä¸€ä¸ªè§’è‰²æå‡ºé—®é¢˜ï¼Œå¦ä¸€ä¸ªè§’è‰²ç«‹åˆ»å›žç­”ï¼›æˆ–è€…ä¸€ä¸ªè§’è‰²å¼€çŽ©ç¬‘ï¼Œå¦ä¸€ä¸ªè§’è‰²åæ§½ã€‚
4.  ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆå‡ æ®µæ¯«æ— å…³è”çš„ç‹¬ç™½ã€‚è¿™ä¼šè®©å¯¹è¯æ˜¾å¾—éžå¸¸æœºæ¢°å’Œä¸çœŸå®žã€‚        
` + i + `
        
        # æ ¸å¿ƒè§„åˆ™
        ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªè¡ŒåŠ¨å¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡çš„ "name" å­—æ®µã€å¿…é¡»ã€‘æ˜¯è§’è‰²çš„ã€æœ¬åã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ "name" å­—æ®µä¸º "` + j + `" çš„æ¶ˆæ¯ã€‚ä¸¥æ ¼éµå®ˆæ¯ä¸ªè§’è‰²çš„è®¾å®šï¼Œç¦æ­¢å‡ºæˆã€‚
-è¯·æ ¹æ®å½“å‰æƒ…æ™¯å’Œä½ çš„æƒ…ç»ªï¼Œä»Žåˆ—è¡¨ä¸­ã€é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„ã€‘è¡¨æƒ…å«ä¹‰æ¥ä½¿ç”¨ "sticker" æŒ‡ä»¤ã€‚å°½é‡è®©ä½ çš„è¡¨æƒ…ä¸°å¯Œå¤šæ ·ï¼Œé¿å…é‡å¤ã€‚        
        # ä½ çš„å¯é€‰è¡ŒåŠ¨æŒ‡ä»¤:
        -   **å‘é€æ–‡æœ¬**: '{"type": "text", "name": "è§’è‰²æœ¬å", "content": "æ–‡æœ¬å†…å®¹"}'
        -   **å‘é€è¡¨æƒ…**: '{"type": "sticker", "name": "è§’è‰²æœ¬å", "meaning": "è¡¨æƒ…çš„å«ä¹‰(ä»Žå¯ç”¨è¡¨æƒ…åˆ—è¡¨é€‰æ‹©)"}'
        -   **å‘é€å›¾ç‰‡**: '{"type": "ai_image", "name": "è§’è‰²æœ¬å", "description": "å›¾ç‰‡çš„è¯¦ç»†ã€ä¸­æ–‡ã€‘æè¿°", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, ç”¨%20åˆ†éš”, é£Žæ ¼ä¸ºé£Žæ™¯/åŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}'
        -   **å‘èµ·æŠ•ç¥¨**: '{"type": "poll", "name": "è§’è‰²æœ¬å", "question": "...", "options": "..."}'
        -   **å‘èµ·ç¾¤è§†é¢‘**: '{"type": "group_call_request", "name": "è§’è‰²æœ¬å"}'
        -å¦‚ä½•æ­£ç¡®ä½¿ç”¨â€œå¼•ç”¨å›žå¤â€åŠŸèƒ½ï¼š
- å½“ä½ æƒ³æ˜Žç¡®åœ°é’ˆå¯¹ç¾¤å†…ã€ä»»ä½•æˆå‘˜ã€‘ï¼ˆåŒ…æ‹¬ç”¨æˆ·æˆ–å…¶ä»–AIè§’è‰²ï¼‰ä¹‹å‰çš„æŸä¸€å¥å…·ä½“çš„è¯è¿›è¡Œå›žå¤æ—¶ï¼Œä½ å°±åº”è¯¥ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚
- è¿™ä¼šè®©ä½ çš„å›žå¤ä¸Šæ–¹å‡ºçŽ°ä¸€ä¸ªç°è‰²çš„å°æ¡†ï¼Œé‡Œé¢æ˜¯è¢«ä½ å¼•ç”¨çš„é‚£å¥è¯ï¼Œè¿™æ ·å¯¹è¯å°±ä¸ä¼šä¹±äº†ã€‚
- æŒ‡ä»¤æ ¼å¼: '{"type": "quote_reply", "target_timestamp": (ä½ æƒ³å¼•ç”¨çš„é‚£å¥è¯çš„æ—¶é—´æˆ³), "reply_content": "ä½ çš„å›žå¤å†…å®¹"}'

        # å½“å‰ç¾¤èŠä¿¡æ¯
        - **ç¾¤åç§°**: ` + b.name + "\n        " + n + `
        # é•¿æœŸè®°å¿† (æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿™æ˜¯ç¾¤å†…å·²ç»ç¡®ç«‹çš„äº‹å®žï¼Œæ‰€æœ‰è§’è‰²å¿…é¡»ä¸¥æ ¼éµå®ˆ)
        ` + (b.longTermMemory && b.longTermMemory.length > 0 ? b.longTermMemory.map(a => "- " + a.content).join("\n") : "- (æš‚æ— )") + "       \n        " + C + "\n        " + o + `
        
        # ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾
        ` + h + `
        # å¯ç”¨è¡¨æƒ…åŒ…
- å½“ä½ éœ€è¦å‘é€è¡¨æƒ…æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä»Žä¸‹é¢çš„åˆ—è¡¨ä¸­ã€ç²¾ç¡®åœ°é€‰æ‹©ä¸€ä¸ªã€‘å«ä¹‰ï¼ˆmeaningï¼‰ã€‚
- ã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ä»»ä½•ä¸åœ¨åˆ—è¡¨ä¸­çš„è¡¨æƒ…å«ä¹‰ï¼
        ` + D + `        
        # ç”¨æˆ·çš„è§’è‰²
        - **` + j + "**: " + b.settings.myPersona + `
        
        # æœ€è¿‘çš„å¯¹è¯æ‘˜è¦ (ä¾›ä½ å‚è€ƒ)
        ` + g + `
        
        # æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º)
        ` + r + `
        
        çŽ°åœ¨ï¼Œè¯·å¼€å§‹ä½ çš„å¯¼æ¼”å·¥ä½œï¼Œè®©ç¾¤èŠå†æ¬¡çƒ­é—¹èµ·æ¥å§ï¼
        `;
    }
    const o = b.history.filter(a => !a.isHidden).slice(-10);
    const q = [{
      role: "system",
      content: l
    }, ...e.map(a => {
      const c = a.role === "user" ? j : sb(b, a.senderName);
      let d = a.content;
      if (a.type === "ai_image" || a.type === "user_photo") {
        d = "[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š'" + a.content + "']";
      } else if (a.type === "voice_message") {
        d = "[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'" + a.content + "']";
      } else if (typeof d !== "string") {
        d = "[å‘é€äº†ä¸€æ¡å¤æ‚æ¶ˆæ¯ï¼Œå¦‚å¡ç‰‡æˆ–è½¬è´¦]";
      }
      return {
        role: "user",
        content: c + ": " + d
      };
    })];
    try {
      const c = [{
        role: "user",
        content: l
      }];
      let d = g === y;
      let e = p(i, h, l, c);
      const f = d ? await fetch(e.url, e.data) : await fetch(g + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + h
        },
        body: JSON.stringify({
          model: i,
          messages: c,
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!f.ok) {
        throw new Error((await f.json()).error.message);
      }
      const j = await f.json();
      const k = d ? j.candidates[0].content.parts[0].text : j.choices[0].message.content;
      const m = Jc(k);
      if (!m || m.length === 0) {
        console.warn("ç¾¤èŠ \"" + b.name + "\" çš„ç‹¬ç«‹è¡ŒåŠ¨APIè¿”å›žä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®ï¼Œæœ¬æ¬¡è·³è¿‡ã€‚");
        return;
      }
      let n = Date.now();
      let o = false;
      let q = "";
      let r = "";
      const s = [];
      for (const a of m) {
        const b = String(a.content || "");
        const c = b.trim().startsWith("<") && b.trim().endsWith(">");
        if (a.type === "text" && !c && b.includes("\n")) {
          const c = b.split(/\n+/).filter(a => a.trim());
          c.forEach(b => {
            s.push({
              ...a,
              content: b
            });
          });
        } else {
          s.push(a);
        }
      }
      for (const a of s) {
        if (!a || !a.type || !a.name && a.type !== "narration") {
          continue;
        }
        const c = sb(b, a.name);
        let d = null;
        let e = null;
        const f = {
          role: "assistant",
          senderName: a.name,
          timestamp: n++
        };
        if (a.type === "open_red_packet") {
          const d = b.history.find(b => b.timestamp === a.packet_timestamp);
          if (d && !d.isFullyClaimed && !(d.claimedBy && d.claimedBy[a.name])) {
            let e = 0;
            const f = d.totalAmount - Object.values(d.claimedBy || {}).reduce((a, b) => a + b, 0);
            const g = d.count - Object.keys(d.claimedBy || {}).length;
            if (g > 0) {
              if (d.packetType === "direct") {
                e = d.totalAmount;
              } else if (d.unclaimedAmounts && d.unclaimedAmounts.length > 0) {
                e = d.unclaimedAmounts.pop();
              } else {
                console.warn("æ£€æµ‹åˆ°æ—§ç‰ˆçº¢åŒ…ï¼Œå›žé€€åˆ°æ—§çš„ï¼ˆä¸å…¬å¹³ï¼‰éšæœºç®—æ³• (triggerGroupAiAction)");
                const a = d.totalAmount - Object.values(d.claimedBy || {}).reduce((a, b) => a + b, 0);
                if (g === 1) {
                  e = a;
                } else {
                  const b = 0.01;
                  const c = a - (g - 1) * b;
                  e = Math.random() * (c - b) + b;
                }
              }
              e = parseFloat(e.toFixed(2));
              if (!d.claimedBy) {
                d.claimedBy = {};
              }
              d.claimedBy[a.name] = e;
              b.history.push({
                role: "system",
                type: "pat_message",
                content: c + " é¢†å–äº† " + sb(b, d.senderName) + " çš„çº¢åŒ…",
                timestamp: n++
              });
              let f = "[ç³»ç»Ÿæç¤ºï¼šä½  (" + c + ") æˆåŠŸæŠ¢åˆ°äº† " + e.toFixed(2) + " å…ƒã€‚";
              if (d.unclaimedAmounts && d.unclaimedAmounts.length === 0 || Object.keys(d.claimedBy).length >= d.count) {
                d.isFullyClaimed = true;
                b.history.push({
                  role: "system",
                  type: "pat_message",
                  content: sb(b, d.senderName) + " çš„çº¢åŒ…å·²è¢«é¢†å®Œ",
                  timestamp: n++
                });
                let a = {
                  name: "",
                  amount: -1
                };
                Object.entries(d.claimedBy).forEach(([b, c]) => {
                  if (c > a.amount) {
                    a = {
                      name: b,
                      amount: c
                    };
                  }
                });
                if (a.name) {
                  const c = sb(b, a.name);
                  f += " çº¢åŒ…å·²è¢«é¢†å®Œï¼Œæ‰‹æ°”çŽ‹æ˜¯ " + c + "ï¼";
                }
              }
              f += " è¯·æ ¹æ®è¿™ä¸ªç»“æžœå‘è¡¨ä½ çš„è¯„è®ºã€‚]";
              b.history.push({
                role: "system",
                content: f,
                timestamp: n++,
                isHidden: true
              });
            }
          }
          o = true;
          continue;
        }
        switch (a.type) {
          case "quote_reply":
            {
              let a = null;
              if (msgData.target_content) {
                a = [...b.history].reverse().find(a => !a.isHidden && (a.content === msgData.target_content || typeof a.content === "string" && a.content.trim() === msgData.target_content.trim()));
                if (!a) {
                  console.warn("[æœ¬è½®å¼•ç”¨å¤±è´¥] AI " + msgData.name + " å°è¯•å¼•ç”¨å†…å®¹ \"" + (msgData.target_content || "").substring(0, 20) + "...\"ï¼Œä½†åœ¨æœ¬è½®åŽ†å²ä¸­æœªæ‰¾åˆ°ã€‚");
                }
              } else if (msgData.target_timestamp) {
                a = b.history.find(a => a.timestamp === msgData.target_timestamp);
              }
              if (a) {
                let c;
                if (a.role === "user") {
                  c = b.settings.myNickname || "æˆ‘";
                } else if (b.isGroup) {
                  c = sb(b, a.senderName);
                } else {
                  c = b.name;
                }
                const d = {
                  timestamp: a.timestamp,
                  senderName: c,
                  content: String(a.content || "").substring(0, 50)
                };
                e = {
                  ...f,
                  content: msgData.reply_content,
                  quote: d
                };
              } else {
                console.warn("å¼•ç”¨å›žå¤å¤±è´¥: æ‰¾ä¸åˆ°ç›®æ ‡æ¶ˆæ¯ (Content: " + msgData.target_content + ", TS: " + msgData.target_timestamp + ")");
                e = {
                  ...f,
                  content: msgData.reply_content
                };
              }
              break;
            }
          case "sticker":
            if (a.meaning) {
              const b = z(a.meaning, v.userStickers);
              if (b) {
                e = {
                  ...f,
                  type: "sticker",
                  content: b.url,
                  meaning: b.name
                };
              } else {
                console.warn("AI (ç¾¤èŠåŽå°) å°è¯•ä½¿ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„è¡¨æƒ…: \"" + a.meaning + "\"");
                e = null;
              }
            } else {
              console.warn("AI (ç¾¤èŠåŽå°) å‘é€äº†ä¸€ä¸ªæ²¡æœ‰ 'meaning' çš„ sticker æŒ‡ä»¤ã€‚", a);
              e = {
                ...f,
                type: "sticker",
                content: a.url,
                meaning: "æœªçŸ¥è¡¨æƒ…"
              };
            }
            break;
          case "qzone_post":
            const g = {
              type: a.postType || "shuoshuo",
              content: a.content,
              timestamp: Date.now(),
              authorId: v.chats[Object.keys(v.chats).find(b => v.chats[b].originalName === a.name)]?.id || a.name,
              authorOriginalName: a.name,
              visibleGroupIds: null
            };
            await Gb.qzonePosts.add(g);
            Te(Ha + 1);
            d = {
              content: "[" + c + " å‘å¸ƒäº†ä¸€æ¡æ–°åŠ¨æ€]"
            };
            break;
          case "qzone_comment":
            const h = await Gb.qzonePosts.get(parseInt(a.postId));
            if (h) {
              if (!h.comments) {
                h.comments = [];
              }
              h.comments.push({
                commenterName: a.name,
                text: a.commentText,
                timestamp: Date.now()
              });
              await Gb.qzonePosts.update(h.id, {
                comments: h.comments
              });
              Te(Ha + 1);
              d = {
                content: "[" + c + " è¯„è®ºäº†åŠ¨æ€]"
              };
            }
            break;
          case "qzone_like":
            const i = await Gb.qzonePosts.get(parseInt(a.postId));
            if (i) {
              if (!i.likes) {
                i.likes = [];
              }
              if (!i.likes.includes(a.name)) {
                i.likes.push(a.name);
                await Gb.qzonePosts.update(i.id, {
                  likes: i.likes
                });
                Te(Ha + 1);
                d = {
                  content: "[" + c + " ç‚¹èµžäº†åŠ¨æ€]"
                };
              }
            }
            break;
          case "ai_image":
            e = {
              ...f,
              type: "ai_image",
              content: a.description,
              image_prompt: msgData.image_prompt
            };
            break;
          default:
            if (a.type === "poll") {
              const b = typeof a.options === "string" ? a.options.split("\n").filter(a => a.trim()) : Array.isArray(a.options) ? a.options : [];
              if (b.length < 2) {
                continue;
              }
              e = {
                ...f,
                ...a,
                options: b,
                votes: {},
                isClosed: false
              };
            } else {
              const b = a.content || a.message;
              e = {
                ...f,
                ...a
              };
              if (b) {
                e.content = b;
              }
            }
            break;
        }
        if (d) {
          b.history.push({
            role: "system",
            type: "pat_message",
            content: d.content,
            timestamp: n++
          });
        } else if (e) {
          b.history.push(e);
          if (!r) {
            r = c;
            q = e.type === "ai_image" ? "[å›¾ç‰‡]" : e.content || "[" + e.type + "]";
          }
        }
        o = true;
      }
      if (o) {
        b.lastActionTimestamp = Date.now();
        b.unreadCount = (b.unreadCount || 0) + m.filter(a => a.type !== "qzone_post" && a.type !== "qzone_comment" && a.type !== "qzone_like").length;
        if (r && q) {
          Hc(a, r + ": " + q);
        }
        await Gb.chats.put(b);
      }
    } catch (a) {
      console.error("ç¾¤èŠ \"" + b.name + "\" çš„ç‹¬ç«‹è¡ŒåŠ¨å¤±è´¥:", a);
    } finally {
      _c();
    }
  }
  function $e(a, b, c) {
    const d = document.getElementById(c);
    if (!d) {
      return;
    }
    if (!a || a.trim() === "") {
      d.innerHTML = "";
      return;
    }
    const e = a.replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, b + " .message-bubble.user $1").replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, b + " .message-bubble.ai $1").replace(/\s*\.message-bubble\s+([^{]+\{)/g, b + " .message-bubble $1");
    d.innerHTML = e;
  }
  async function _e() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.chats[v.activeChatId];
    const b = document.getElementById("settings-preview-area");
    if (!b) {
      return;
    }
    const c = document.querySelector("input[name=\"theme-select\"]:checked")?.value || "default";
    const d = document.getElementById("font-size-slider").value;
    const e = document.getElementById("custom-css-input").value;
    const f = a.settings.background;
    b.dataset.theme = c;
    b.style.setProperty("--chat-font-size", d + "px");
    if (f && f.startsWith("data:image")) {
      b.style.backgroundImage = "url(" + f + ")";
      b.style.backgroundColor = "transparent";
    } else {
      b.style.backgroundImage = "none";
      b.style.background = f || "#f0f2f5";
    }
    b.innerHTML = "";
    const g = {
      role: "ai",
      content: "å¯¹æ–¹æ¶ˆæ¯é¢„è§ˆ",
      timestamp: 1,
      senderName: a.name
    };
    const h = await Nd(g, a);
    if (h) {
      b.appendChild(h);
    }
    const i = {
      role: "user",
      content: "æˆ‘çš„æ¶ˆæ¯é¢„è§ˆ",
      timestamp: 2
    };
    const j = await Nd(i, a);
    if (j) {
      b.appendChild(j);
    }
    const k = document.createElement("div");
    k.style.cssText = `
                position: absolute; 
                font-size: 11px; 
                padding: 2px 6px; 
                border-radius: 8px; 
                background-color: rgba(0, 0, 0, 0.1); 
                color: var(--text-secondary); 
                white-space: nowrap; 
                transition: all 0.3s ease;
            `;
    k.textContent = "â™ª æ­Œè¯ä½ç½®é¢„è§ˆ â™ª";
    b.appendChild(k);
    const l = document.getElementById("lyrics-vertical-pos").value;
    const m = document.getElementById("lyrics-horizontal-pos").value;
    const n = parseInt(document.getElementById("lyrics-offset-input").value) || 10;
    if (l === "top") {
      k.style.top = n + "px";
    } else {
      k.style.bottom = n + "px";
    }
    switch (m) {
      case "left":
        k.style.left = "15px";
        break;
      case "right":
        k.style.right = "15px";
        break;
      default:
        k.style.left = "50%";
        k.style.transform = "translateX(-50%)";
        break;
    }
    $e(e, "#settings-preview-area", "preview-bubble-style");
  }
  async function af() {
    await bf();
    document.getElementById("group-management-modal").classList.add("visible");
  }
  async function bf() {
    const a = document.getElementById("existing-groups-list");
    const b = await Gb.qzoneGroups.toArray();
    a.innerHTML = "";
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align: center; color: var(--text-secondary);\">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç»„</p>";
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "existing-group-item";
      c.innerHTML = "\n                    <span class=\"group-name\">" + b.name + "</span>\n                    <span class=\"delete-group-btn\" data-id=\"" + b.id + "\">Ã—</span>\n                ";
      a.appendChild(c);
    });
  }
  async function cf() {
    const a = document.getElementById("new-group-name-input");
    const b = a.value.trim();
    if (!b) {
      alert("åˆ†ç»„åä¸èƒ½ä¸ºç©ºï¼");
      return;
    }
    const c = await Gb.qzoneGroups.where("name").equals(b).first();
    if (c) {
      alert("åˆ†ç»„ \"" + b + "\" å·²ç»å­˜åœ¨äº†ï¼Œæ¢ä¸ªåå­—å§ï¼");
      return;
    }
    await Gb.qzoneGroups.add({
      name: b
    });
    a.value = "";
    await bf();
  }
  async function df(a) {
    const b = await wb("ç¡®è®¤åˆ é™¤", "åˆ é™¤åˆ†ç»„åŽï¼Œè¯¥ç»„å†…çš„å¥½å‹å°†å˜ä¸ºâ€œæœªåˆ†ç»„â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (b) {
      await Gb.qzoneGroups.delete(a);
      const b = await Gb.chats.where("groupId").equals(a).toArray();
      for (const a of b) {
        a.groupId = null;
        await Gb.chats.put(a);
        if (v.chats[a.id]) {
          v.chats[a.id].groupId = null;
        }
      }
      await bf();
    }
  }
  function ef(a) {
    const b = v.chats[v.activeChatId];
    document.getElementById("publish-to-announcement-btn").style.display = b.isGroup ? "block" : "none";
    if (Z) {
      return;
    }
    qa = a;
    document.getElementById("message-actions-modal").classList.add("visible");
  }
  function ff() {
    document.getElementById("message-actions-modal").classList.remove("visible");
    qa = null;
  }
  async function gf() {
    if (!qa) {
      return;
    }
    const a = qa;
    const b = v.chats[v.activeChatId];
    const c = b.history.find(b => b.timestamp === a);
    if (!c) {
      return;
    }
    ff();
    let d;
    const e = c.type && ["voice_message", "ai_image", "transfer", "share_link"].includes(c.type);
    if (e) {
      let a = {
        type: c.type
      };
      if (c.type === "voice_message") {
        a.content = c.content;
      } else if (c.type === "ai_image") {
        a.description = c.content;
      } else if (c.type === "transfer") {
        a.amount = c.amount;
        a.note = c.note;
      } else if (c.type === "share_link") {
        a.title = c.title;
        a.description = c.description;
        a.source_name = c.source_name;
        a.content = c.content;
      }
      d = JSON.stringify(a, null, 2);
    } else if (typeof c.content === "object") {
      d = JSON.stringify(c.content, null, 2);
    } else {
      d = c.content;
    }
    const f = {
      voice: {
        type: "voice_message",
        content: "åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹"
      },
      image: {
        type: "ai_image",
        description: "åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°"
      },
      transfer: {
        type: "transfer",
        amount: 5.2,
        note: "ä¸€ç‚¹å¿ƒæ„"
      },
      link: {
        type: "share_link",
        title: "æ–‡ç« æ ‡é¢˜",
        description: "æ–‡ç« æ‘˜è¦...",
        source_name: "æ¥æºç½‘ç«™",
        content: "æ–‡ç« å®Œæ•´å†…å®¹..."
      }
    };
    const g = `
                <div class="format-helpers">
                    <button class="format-btn" data-template='` + JSON.stringify(f.voice) + "'>è¯­éŸ³</button>\n                    <button class=\"format-btn\" data-template='" + JSON.stringify(f.image) + "'>å›¾ç‰‡</button>\n                    <button class=\"format-btn\" data-template='" + JSON.stringify(f.transfer) + "'>è½¬è´¦</button>\n                    <button class=\"format-btn\" data-template='" + JSON.stringify(f.link) + `'>é“¾æŽ¥</button>
                </div>
            `;
    const h = await Db("ç¼–è¾‘æ¶ˆæ¯", "åœ¨æ­¤ä¿®æ”¹ï¼Œæˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä½¿ç”¨æ ¼å¼æ¨¡æ¿...", d, "textarea", g);
    if (h !== null) {
      await nf(a, h, true);
    }
  }
  async function hf() {
    if (!qa) {
      return;
    }
    const a = v.chats[v.activeChatId];
    const b = a.history.find(a => a.timestamp === qa);
    if (!b) {
      return;
    }
    let c;
    if (typeof b.content === "object") {
      c = JSON.stringify(b.content);
    } else {
      c = String(b.content);
    }
    try {
      await navigator.clipboard.writeText(c);
      await Bb("å¤åˆ¶æˆåŠŸ", "æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚");
    } catch (a) {
      await Bb("å¤åˆ¶å¤±è´¥", "æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚");
    }
    ff();
  }
  async function jf() {
    if (!qa) {
      return;
    }
    try {
      await navigator.clipboard.writeText(qa);
      await Bb("å¤åˆ¶æˆåŠŸ", "æ¶ˆæ¯æ—¶é—´æˆ³ " + qa + " å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚");
    } catch (a) {
      await Bb("å¤åˆ¶å¤±è´¥", "æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚");
    }
    ff();
  }
  function kf(a = "") {
    const b = document.createElement("div");
    b.className = "message-editor-block";
    const c = {
      voice: {
        type: "voice_message",
        content: "åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹"
      },
      image: {
        type: "ai_image",
        description: "åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°"
      },
      transfer: {
        type: "transfer",
        amount: 5.2,
        note: "ä¸€ç‚¹å¿ƒæ„"
      },
      link: {
        type: "share_link",
        title: "æ–‡ç« æ ‡é¢˜",
        description: "æ–‡ç« æ‘˜è¦...",
        source_name: "æ¥æºç½‘ç«™",
        content: "æ–‡ç« å®Œæ•´å†…å®¹..."
      },
      offline: {
        type: "offline_text",
        content: "ã€Œåœ¨è¿™é‡Œè¾“å…¥å¯¹è¯å†…å®¹ã€\n(åœ¨è¿™é‡Œè¾“å…¥åŠ¨ä½œæˆ–çŽ¯å¢ƒæå†™)"
      },
      quote: {
        type: "quote_reply",
        target_timestamp: 1234567890,
        reply_content: "åœ¨è¿™é‡Œè¾“å…¥å›žå¤å†…å®¹"
      },
      nai: {
        type: "naiimag",
        prompt: "1girl, best quality, masterpiece, ..."
      },
      narration: {
        type: "narration",
        content: "åœ¨è¿™é‡Œè¾“å…¥çŽ¯å¢ƒæˆ–å¿ƒç†æå†™..."
      }
    };
    b.innerHTML = `
        <button class="delete-block-btn" title="åˆ é™¤æ­¤æ¡">Ã—</button>
        <textarea>` + a + `</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='` + JSON.stringify(c.voice) + "'>è¯­éŸ³</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.image) + "'>å›¾ç‰‡</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.transfer) + "'>è½¬è´¦</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.link) + "'>é“¾æŽ¥</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.offline) + "'>çº¿ä¸‹</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.quote) + "'>å¼•ç”¨</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.nai) + "' style=\"color: #6a329f; border-color: #6a329f;\">NAIç”Ÿå›¾</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.narration) + `' style="color: #888; border-color: #ccc;">æ—ç™½</button>
            </div>
    `;
    b.querySelector(".delete-block-btn").addEventListener("click", () => {
      if (document.querySelectorAll(".message-editor-block").length > 1) {
        b.remove();
      } else {
        alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€æ¡æ¶ˆæ¯ã€‚");
      }
    });
    b.querySelectorAll(".format-btn").forEach(a => {
      a.addEventListener("click", () => {
        const c = a.dataset.template;
        const d = b.querySelector("textarea");
        if (c && d) {
          try {
            const a = JSON.parse(c);
            d.value = JSON.stringify(a, null, 2);
            d.focus();
          } catch (a) {
            console.error("è§£æžæ ¼å¼æ¨¡æ¿å¤±è´¥:", a);
          }
        }
      });
    });
    return b;
  }
  async function lf() {
    if (!qa) {
      return;
    }
    const a = qa;
    const b = v.chats[v.activeChatId];
    const c = b.history.find(b => b.timestamp === a);
    if (!c) {
      return;
    }
    ff();
    const d = document.getElementById("message-editor-modal");
    const e = document.getElementById("message-editor-container");
    e.innerHTML = "";
    let f;
    if (c.quote) {
      const a = {
        type: "quote_reply",
        target_timestamp: c.quote.timestamp,
        reply_content: c.content
      };
      f = JSON.stringify(a, null, 2);
    } else if (c.type && ["voice_message", "ai_image", "transfer", "offline_text", "share_link", "naiimag", "narration"].includes(c.type)) {
      let a = {
        type: c.type
      };
      if (c.type === "voice_message") {
        a.content = c.content;
      } else if (c.type === "ai_image") {
        a.description = c.content;
      } else if (c.type === "transfer") {
        a.amount = c.amount;
        a.note = c.note;
      } else if (c.type === "offline_text") {
        if (c.content) {
          a.content = c.content;
        } else {
          a.dialogue = c.dialogue;
          a.description = c.description;
        }
      } else if (c.type === "share_link") {
        a.title = c.title;
        a.description = c.description;
        a.source_name = c.source_name;
        a.content = c.content;
      } else if (c.type === "naiimag") {
        a.prompt = c.prompt;
        a.fullPrompt = c.fullPrompt;
      } else if (c.type === "narration") {
        a.content = c.content;
      }
      f = JSON.stringify(a, null, 2);
    } else if (typeof c.content === "object") {
      try {
        let a = JSON.parse(JSON.stringify(c.content));
        if (Array.isArray(a)) {
          a.forEach(a => {
            if (a.type === "image_url" && a.image_url && a.image_url.url && a.image_url.url.length > 500) {
              a.image_url.url = "BASE64_DATA_HIDDEN";
            }
          });
        }
        f = JSON.stringify(a, null, 2);
      } catch (a) {
        console.warn("æ— æ³•å®‰å…¨å¤„ç†æ¶ˆæ¯å†…å®¹ï¼Œå›žé€€åˆ°åŽŸå§‹æ˜¾ç¤º:", a);
        f = JSON.stringify(c.content, null, 2);
      }
    } else {
      f = c.content;
    }
    const g = kf(f);
    e.appendChild(g);
    const h = document.getElementById("add-message-editor-block-btn");
    const i = h.cloneNode(true);
    h.parentNode.replaceChild(i, h);
    i.addEventListener("click", () => {
      const a = kf();
      e.appendChild(a);
      a.querySelector("textarea").focus();
    });
    const j = document.getElementById("cancel-advanced-editor-btn");
    const k = j.cloneNode(true);
    j.parentNode.replaceChild(k, j);
    k.addEventListener("click", () => {
      d.classList.remove("visible");
    });
    const l = document.getElementById("save-advanced-editor-btn");
    const m = l.cloneNode(true);
    l.parentNode.replaceChild(m, l);
    m.addEventListener("click", () => {
      nf(a);
    });
    d.classList.add("visible");
  }
  async function hf() {
    if (!qa) {
      return;
    }
    const a = v.chats[v.activeChatId];
    const b = a.history.find(a => a.timestamp === qa);
    if (!b) {
      return;
    }
    let c;
    if (b.type === "offline_text") {
      if (b.content) {
        c = b.content;
      } else {
        c = "ã€Œ" + (b.dialogue || "") + "ã€\n" + (b.description || "");
      }
    } else if (typeof b.content === "object") {
      c = JSON.stringify(b.content);
    } else {
      c = String(b.content);
    }
    try {
      await navigator.clipboard.writeText(c);
      await Bb("å¤åˆ¶æˆåŠŸ", "æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚");
    } catch (a) {
      await Bb("å¤åˆ¶å¤±è´¥", "æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚");
    }
    ff();
  }
  function mf(a) {
    const b = a.trim();
    if (b.startsWith("{") && b.endsWith("}")) {
      try {
        const a = JSON.parse(b);
        if (a.type) {
          return a;
        }
      } catch (a) {}
    }
    if ($a.test(b)) {
      return {
        type: "sticker",
        content: b
      };
    }
    return {
      type: "text",
      content: b
    };
  }
  async function nf(a, b = null) {
    if (!a) {
      return;
    }
    const c = v.chats[v.activeChatId];
    const d = c.history.findIndex(b => b.timestamp === a);
    if (d === -1) {
      return;
    }
    const e = c.history[d];
    let f = [];
    const g = b !== null ? [b] : Array.from(document.querySelectorAll("#message-editor-container textarea")).map(a => a.value);
    for (const h of g) {
      if (!h.trim()) {
        continue;
      }
      const a = mf(h.trim());
      const b = {
        role: e.role,
        senderName: e.senderName,
        timestamp: e.timestamp,
        isHidden: e.isHidden
      };
      switch (a.type) {
        case "text":
          b.type = "text";
          b.content = a.content;
          break;
        case "offline_text":
          b.type = "offline_text";
          if (a.content) {
            b.content = a.content;
          } else {
            b.dialogue = a.dialogue;
            b.description = a.description;
          }
          break;
        case "quote_reply":
          b.type = "quote_reply";
          b.content = a.reply_content;
          const e = c.history.find(b => b.timestamp === a.target_timestamp);
          if (e) {
            let c = e.senderName;
            if (e.role === "user") {
              c = v.qzoneSettings.nickname || "{{user}}";
            }
            b.quote = {
              timestamp: a.target_timestamp,
              senderName: c,
              content: String(e.content || "")
            };
          } else {
            b.quote = {
              timestamp: a.target_timestamp,
              senderName: "æœªçŸ¥ç”¨æˆ·",
              content: "åŽŸå§‹æ¶ˆæ¯å·²åˆ é™¤æˆ–ä¸å­˜åœ¨"
            };
          }
          break;
        case "voice_message":
        case "ai_image":
        case "user_photo":
          b.type = a.type;
          b.content = a.content || a.description;
          if (a.meaning) {
            b.meaning = a.meaning;
          }
          break;
        case "naiimag":
          {
            const e = c.history[d];
            let f = a.prompt;
            let g = a.imageUrl;
            let h = a.fullPrompt;
            let i = false;
            if (f && typeof f === "string" && e.prompt !== f) {
              i = true;
            } else {
              f = e.prompt;
              h = e.fullPrompt;
              g = e.imageUrl;
            }
            if (i) {
              await Bb("è¯·ç¨å€™...", "æ£€æµ‹åˆ°æç¤ºè¯å·²ä¿®æ”¹ï¼Œæ­£åœ¨é‡æ–°ç”Ÿæˆ NovelAI å›¾ç‰‡...");
              try {
                const a = await Ec(f, c.id);
                g = a.imageUrl;
                h = a.fullPrompt;
                await Bb("æˆåŠŸ", "å›¾ç‰‡å·²æ ¹æ®æ–°æç¤ºè¯é‡æ–°ç”Ÿæˆï¼");
              } catch (a) {
                console.error("ç¼–è¾‘æ—¶é‡æ–°ç”ŸæˆNAIå›¾ç‰‡å¤±è´¥:", a);
                await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•é‡æ–°ç”Ÿæˆå›¾ç‰‡: " + a.message + `. 

å°†ä¿ç•™æ—§å›¾ç‰‡ï¼Œä½†æç¤ºè¯ä¼šæ›´æ–°ã€‚`);
                g = e.imageUrl;
              }
            }
            b.type = "naiimag";
            b.imageUrl = g;
            b.prompt = f;
            b.fullPrompt = h;
            break;
          }
        case "sticker":
          {
            b.type = "sticker";
            let c = false;
            if (a.meaning) {
              const d = v.userStickers.find(b => b.name === a.meaning);
              if (d) {
                b.content = d.url;
                b.meaning = d.name;
                console.log("å¯¼æ¼”/ç¼–è¾‘æ¨¡å¼ä¿å­˜(Sticker): ä½¿ç”¨äº† meaning æŸ¥æ‰¾");
                c = true;
              } else {
                b.type = "text";
                b.content = "[è¡¨æƒ…: " + a.meaning + "]";
                console.warn("å¯¼æ¼”/ç¼–è¾‘æ¨¡å¼ä¿å­˜(Sticker): æä¾›äº† meaning ä½†æœªæ‰¾åˆ°å¯¹åº”è¡¨æƒ…:", a.meaning);
                c = true;
              }
            }
            if (!c && a.url) {
              b.content = a.url;
              const d = v.userStickers.find(b => b.url === a.url);
              if (a.meaning && (!d || d.name === a.meaning)) {
                b.meaning = a.meaning;
              } else if (d) {
                b.meaning = d.name;
              } else {
                b.meaning = "æœªçŸ¥è¡¨æƒ…";
              }
              console.log("å¯¼æ¼”/ç¼–è¾‘æ¨¡å¼ä¿å­˜(Sticker): ä½¿ç”¨äº† URLï¼Œæœ€ç»ˆ meaning:", b.meaning);
              c = true;
            }
            if (!c && a.content && typeof a.content === "string" && $a.test(a.content)) {
              b.content = a.content;
              const d = v.userStickers.find(b => b.url === a.content);
              b.meaning = d ? d.name : "æœªçŸ¥è¡¨æƒ…";
              console.log("å¯¼æ¼”/ç¼–è¾‘æ¨¡å¼ä¿å­˜(Sticker): å°† content è§†ä¸º URLï¼ŒæŸ¥æ‰¾åˆ° meaning:", b.meaning);
              c = true;
            }
            if (!c) {
              console.error("å¯¼æ¼”/ç¼–è¾‘æ¨¡å¼ä¿å­˜(Sticker): æŒ‡ä»¤æ— æ•ˆæˆ–ç¼ºå°‘å¿…è¦å­—æ®µ (meaning/url/content):", a);
              continue;
            }
            break;
          }
        case "transfer":
          b.type = "transfer";
          b.amount = a.amount;
          b.note = a.note;
          break;
        case "share_link":
          b.type = "share_link";
          b.title = a.title;
          b.description = a.description;
          b.source_name = a.source_name;
          b.content = a.content;
          break;
        default:
          Object.assign(b, a);
          break;
      }
      f.push(b);
    }
    if (f.length === 0) {
      document.getElementById("message-editor-modal").classList.remove("visible");
      return;
    }
    c.history.splice(d, 1, ...f);
    let h = a;
    for (let e = d; e < c.history.length; e++) {
      c.history[e].timestamp = h;
      h++;
    }
    await Gb.chats.put(c);
    document.getElementById("message-editor-modal").classList.remove("visible");
    cd(v.activeChatId);
    await Bb("æˆåŠŸ", "æ¶ˆæ¯å·²æ›´æ–°ï¼");
  }
  function of(a) {
    Ea = a;
    document.getElementById("post-actions-modal").classList.add("visible");
  }
  function pf() {
    document.getElementById("post-actions-modal").classList.remove("visible");
    Ea = null;
  }
  async function qf() {
    if (!Ea) {
      return;
    }
    const a = Ea;
    const b = await Gb.qzonePosts.get(a);
    if (!b) {
      return;
    }
    pf();
    let c;
    if (b.type === "shuoshuo") {
      c = b.content;
    } else {
      const a = {
        type: b.type,
        publicText: b.publicText || ""
      };
      if (b.type === "image_post") {
        a.imageUrl = b.imageUrl;
        a.imageDescription = b.imageDescription;
      } else if (b.type === "text_image") {
        a.hiddenContent = b.hiddenContent;
      }
      c = JSON.stringify(a, null, 2);
    }
    const d = {
      shuoshuo: "åœ¨è¿™é‡Œè¾“å…¥è¯´è¯´çš„å†…å®¹...",
      image: {
        type: "image_post",
        publicText: "",
        imageUrl: "https://...",
        imageDescription: ""
      },
      text_image: {
        type: "text_image",
        publicText: "",
        hiddenContent: ""
      }
    };
    const e = `
                <div class="format-helpers">
                    <button class="format-btn" data-type="text">è¯´è¯´</button>
                    <button class="format-btn" data-template='` + JSON.stringify(d.image) + "'>å›¾ç‰‡åŠ¨æ€</button>\n                    <button class=\"format-btn\" data-template='" + JSON.stringify(d.text_image) + `'>æ–‡å­—å›¾</button>
                </div>
            `;
    const f = await Db("ç¼–è¾‘åŠ¨æ€", "åœ¨æ­¤ä¿®æ”¹å†…å®¹...", c, "textarea", e);
    // TOLOOK
    setTimeout(() => {
      const a = document.querySelector("#custom-modal-body .format-btn[data-type=\"text\"]");
      if (a) {
        a.addEventListener("click", () => {
          const a = document.getElementById("custom-prompt-input");
          a.value = d.shuoshuo;
          a.focus();
        });
      }
    }, 100);
    if (f !== null) {
      await rf(a, f);
    }
  }
  async function rf(a, b) {
    const c = await Gb.qzonePosts.get(a);
    if (!c) {
      return;
    }
    const d = b.trim();
    try {
      const a = JSON.parse(d);
      c.type = a.type || "image_post";
      c.publicText = a.publicText || "";
      c.imageUrl = a.imageUrl || "";
      c.imageDescription = a.imageDescription || "";
      c.hiddenContent = a.hiddenContent || "";
      c.content = "";
    } catch (a) {
      c.type = "shuoshuo";
      c.content = d;
      c.publicText = "";
      c.imageUrl = "";
      c.imageDescription = "";
      c.hiddenContent = "";
    }
    await Gb.qzonePosts.put(c);
    await Sb();
    await Bb("æˆåŠŸ", "åŠ¨æ€å·²æ›´æ–°ï¼");
  }
  async function sf() {
    if (!Ea) {
      return;
    }
    const a = await Gb.qzonePosts.get(Ea);
    if (!a) {
      return;
    }
    let b = a.content || a.publicText || a.hiddenContent || a.imageDescription || "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";
    try {
      await navigator.clipboard.writeText(b);
      await Bb("å¤åˆ¶æˆåŠŸ", "åŠ¨æ€å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚");
    } catch (a) {
      await Bb("å¤åˆ¶å¤±è´¥", "æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚");
    }
    pf();
  }
  let tf = new Set();
  async function uf() {
    const a = await Eb("åˆ›å»ºç¾¤èŠ", [{
      text: "åˆ›å»ºæ™®é€šç¾¤èŠ (æˆ‘å‚ä¸Ž)",
      value: "normal"
    }, {
      text: "åˆ›å»ºæ—è§‚å•èŠ (2äººèŠå¤©)",
      value: "spectator_private"
    }, {
      text: "åˆ›å»ºæ—è§‚ç¾¤èŠ (å¤šäººå›´è§‚)",
      value: "spectator"
    }]);
    if (a === "normal") {
      tf.clear();
      const a = document.getElementById("confirm-contact-picker-btn");
      const b = a.cloneNode(true);
      a.parentNode.replaceChild(b, a);
      b.addEventListener("click", Bf);
      await zf();
      Kb("contact-picker-screen");
    } else if (a === "spectator") {
      vf();
    } else if (a === "spectator_private") {
      wf();
    }
  }
  async function vf() {
    pa = "group";
    tf.clear();
    const a = document.getElementById("confirm-contact-picker-btn");
    const b = a.cloneNode(true);
    a.parentNode.replaceChild(b, a);
    b.addEventListener("click", yf);
    await xf();
    Kb("contact-picker-screen");
  }
  async function wf() {
    pa = "private";
    tf.clear();
    const a = document.getElementById("confirm-contact-picker-btn");
    const b = a.cloneNode(true);
    a.parentNode.replaceChild(b, a);
    b.addEventListener("click", yf);
    await xf();
    Kb("contact-picker-screen");
  }
  async function xf() {
    const a = document.getElementById("contact-picker-list");
    a.innerHTML = "";
    const b = Object.values(v.chats).filter(a => !a.isGroup);
    const c = await Gb.npcs.toArray();
    if (b.length === 0 && c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color:#8a8a8a; margin-top:50px;\">è¿˜æ²¡æœ‰ä»»ä½•è§’è‰²æˆ–NPCå¯ä»¥åŠ å…¥ç¾¤èŠã€‚</p>";
      return;
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "contact-picker-item";
      c.dataset.contactId = b.id;
      c.innerHTML = `
            <div class="checkbox"></div>
            <img src="` + (b.settings.aiAvatar || Na) + "\" class=\"avatar\">\n            <span class=\"name\">" + b.name + " <small style=\"color:#888;\">(è§’è‰²)</small></span>\n        ";
      a.appendChild(c);
    });
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "contact-picker-item";
      c.dataset.contactId = b.id;
      c.dataset.isNpc = "true";
      c.innerHTML = `
            <div class="checkbox"></div>
            <img src="` + (b.avatar || Pa) + "\" class=\"avatar\">\n            <span class=\"name\">" + b.name + " <small style=\"color:#007722;\">(NPC)</small></span>\n        ";
      a.appendChild(c);
    });
    Af();
  }
  async function yf() {
    if (pa === "private" && tf.size !== 2) {
      alert("æ—è§‚å•èŠå¿…é¡»é€‰æ‹©ã€æ­£å¥½ 2 ä½ã€‘æˆå‘˜ã€‚");
      return;
    }
    if (pa === "group" && tf.size < 2) {
      alert("æ—è§‚ç¾¤èŠè‡³å°‘éœ€è¦é€‰æ‹© 2 ä¸ªæˆå‘˜ã€‚");
      return;
    }
    const a = await Db("è®¾ç½®ç¾¤å", "è¯·è¾“å…¥ç¾¤èŠçš„åå­—", "AIä»¬çš„èŒ¶è¯ä¼š");
    if (!a || !a.trim()) {
      return;
    }
    const b = "group_" + Date.now();
    const c = [];
    const d = await Gb.npcs.toArray();
    for (const a of tf) {
      const b = document.querySelector(".contact-picker-item[data-contact-id=\"" + a + "\"]").dataset.isNpc === "true";
      if (b) {
        const b = d.find(b => b.id === parseInt(a));
        if (b) {
          c.push({
            id: "npc_" + b.id,
            originalName: b.name,
            groupNickname: b.name,
            persona: b.persona,
            avatar: b.avatar || Pa,
            isNpc: true
          });
        }
      } else {
        const b = v.chats[a];
        if (b) {
          c.push({
            id: a,
            originalName: b.originalName,
            groupNickname: b.name,
            persona: b.settings.aiPersona,
            avatar: b.settings.aiAvatar || Na,
            isNpc: false
          });
        }
      }
    }
    const e = {
      id: b,
      name: a.trim(),
      isGroup: true,
      isSpectatorGroup: true,
      members: c,
      settings: {
        maxMemory: 10,
        groupAvatar: Qa,
        background: "",
        theme: "default",
        fontSize: 13,
        customCss: "",
        linkedWorldBookIds: []
      },
      history: [{
        role: "system",
        content: "[ç³»ç»ŸæŒ‡ä»¤ï¼šè¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰ç”¨æˆ·å‚ä¸Žçš„ç¾¤èŠï¼Œè¯·ä½ ä»¬æ ¹æ®å„è‡ªçš„äººè®¾è‡ªç”±åœ°å¼€å§‹å¯¹è¯ã€‚]",
        timestamp: Date.now(),
        isHidden: true
      }],
      musicData: {
        totalTime: 0
      }
    };
    v.chats[b] = e;
    await Gb.chats.put(e);
    await _c();
    Kb("chat-list-screen");
    Qd(b);
  }
  async function zf() {
    const a = document.getElementById("contact-picker-list");
    a.innerHTML = "";
    const b = Object.values(v.chats).filter(a => !a.isGroup);
    const c = await Gb.npcs.toArray();
    if (b.length === 0 && c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color:#8a8a8a; margin-top:50px;\">è¿˜æ²¡æœ‰å¯ä»¥æ‹‰è¿›ç¾¤çš„è”ç³»äººå“¦~</p>";
      return;
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "contact-picker-item";
      c.dataset.contactId = b.id;
      c.innerHTML = `
            <div class="checkbox"></div>
            <img src="` + (b.settings.aiAvatar || Na) + "\" class=\"avatar\">\n            <span class=\"name\">" + b.name + " <small style=\"color:#888;\">(è§’è‰²)</small></span>\n        ";
      a.appendChild(c);
    });
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "contact-picker-item";
      c.dataset.contactId = "npc_" + b.id;
      c.innerHTML = `
            <div class="checkbox"></div>
            <img src="` + (b.avatar || Pa) + "\" class=\"avatar\">\n            <span class=\"name\">" + b.name + " <small style=\"color:#007722;\">(NPC)</small></span>\n        ";
      a.appendChild(c);
    });
    Af();
  }
  function Af() {
    const a = document.getElementById("confirm-contact-picker-btn");
    if (pa === "private") {
      a.textContent = "å®Œæˆ(" + tf.size + "/2)";
      a.disabled = tf.size !== 2;
    } else {
      a.textContent = "å®Œæˆ(" + tf.size + ")";
      a.disabled = tf.size < 2;
    }
  }
  async function Bf() {
    if (tf.size < 2) {
      alert("åˆ›å»ºç¾¤èŠè‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè”ç³»äººã€‚");
      return;
    }
    const a = await Db("è®¾ç½®ç¾¤å", "è¯·è¾“å…¥ç¾¤èŠçš„åå­—", "æˆ‘ä»¬çš„ç¾¤èŠ");
    if (!a || !a.trim()) {
      return;
    }
    const b = "group_" + Date.now();
    const c = [];
    const d = await Gb.npcs.toArray();
    for (const a of tf) {
      if (a.startsWith("npc_")) {
        const b = parseInt(a.replace("npc_", ""));
        const e = d.find(a => a.id === b);
        if (e) {
          c.push({
            id: a,
            originalName: e.name,
            groupNickname: e.name,
            persona: e.persona,
            avatar: e.avatar || Pa,
            isNpc: true
          });
        }
      } else {
        const b = v.chats[a];
        if (b) {
          c.push({
            id: a,
            originalName: b.originalName,
            groupNickname: b.name,
            persona: b.settings.aiPersona,
            avatar: b.settings.aiAvatar || Na,
            isNpc: false
          });
        }
      }
    }
    const e = {
      id: b,
      name: a.trim(),
      isGroup: true,
      members: c,
      settings: {
        myPersona: "æˆ‘æ˜¯è°å‘€ã€‚",
        myNickname: "æˆ‘",
        maxMemory: 10,
        groupAvatar: Qa,
        myAvatar: Oa,
        background: "",
        theme: "default",
        fontSize: 13,
        customCss: "",
        linkedWorldBookIds: []
      },
      history: [],
      musicData: {
        totalTime: 0
      }
    };
    v.chats[b] = e;
    await Gb.chats.put(e);
    await _c();
    Kb("chat-list-screen");
    Qd(b);
  }
  function Cf() {
    if (!v.activeChatId || !v.chats[v.activeChatId].isGroup) {
      return;
    }
    Df();
    Kb("member-management-screen");
  }
  function Df() {
    const a = document.getElementById("member-management-list");
    const b = v.chats[v.activeChatId];
    a.innerHTML = "";
    b.members.forEach(b => {
      const c = document.createElement("div");
      c.className = "member-management-item";
      c.innerHTML = "\n                    <img src=\"" + b.avatar + "\" class=\"avatar\">\n                    <span class=\"name\">" + b.groupNickname + "</span>\n                    <button class=\"remove-member-btn\" data-member-id=\"" + b.id + "\" title=\"ç§»å‡ºç¾¤èŠ\">-</button>\n                ";
      a.appendChild(c);
    });
  }
  async function Ef(a) {
    const b = v.chats[v.activeChatId];
    const c = b.members.findIndex(b => b.id === a);
    if (c === -1) {
      return;
    }
    if (b.members.length <= 2) {
      alert("ç¾¤èŠäººæ•°ä¸èƒ½å°‘äºŽ2äººã€‚");
      return;
    }
    const d = b.members[c].groupNickname;
    const e = await wb("ç§»å‡ºæˆå‘˜", "ç¡®å®šè¦å°†â€œ" + d + "â€ç§»å‡ºç¾¤èŠå—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (e) {
      b.members.splice(c, 1);
      await Gb.chats.put(b);
      Df();
      document.getElementById("chat-settings-btn").click();
    }
  }
  async function Ff() {
    const a = document.getElementById("confirm-contact-picker-btn");
    const b = a.cloneNode(true);
    a.parentNode.replaceChild(b, a);
    b.addEventListener("click", Hf);
    await Gf();
    Kb("contact-picker-screen");
  }
  async function Gf() {
    const a = document.getElementById("contact-picker-list");
    a.innerHTML = "";
    tf.clear();
    const b = v.chats[v.activeChatId];
    const c = new Set(b.members.map(a => a.id));
    const d = Object.values(v.chats).filter(a => !a.isGroup && !c.has(a.id));
    const e = (await Gb.npcs.toArray()).filter(a => !c.has("npc_" + a.id));
    if (d.length === 0 && e.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color:#8a8a8a; margin-top:50px;\">æ²¡æœ‰æ›´å¤šå¯ä»¥é‚€è¯·çš„è”ç³»äººäº†ã€‚</p>";
      document.getElementById("confirm-contact-picker-btn").style.display = "none";
    } else {
      document.getElementById("confirm-contact-picker-btn").style.display = "block";
      d.forEach(b => {
        const c = document.createElement("div");
        c.className = "contact-picker-item";
        c.dataset.contactId = b.id;
        c.dataset.contactType = "character";
        c.innerHTML = `
                <div class="checkbox"></div>
                <img src="` + (b.settings.aiAvatar || Na) + "\" class=\"avatar\">\n                <span class=\"name\">" + b.name + " <small style=\"color:#888;\">(è§’è‰²)</small></span>\n            ";
        a.appendChild(c);
      });
      e.forEach(b => {
        const c = document.createElement("div");
        c.className = "contact-picker-item";
        c.dataset.contactId = "npc_" + b.id;
        c.dataset.contactType = "npc";
        c.dataset.npcId = b.id;
        c.innerHTML = `
                <div class="checkbox"></div>
                <img src="` + (b.avatar || Pa) + "\" class=\"avatar\">\n                <span class=\"name\">" + b.name + " <small style=\"color:#007722;\">(NPC)</small></span>\n            ";
        a.appendChild(c);
      });
    }
    Af();
  }
  async function Hf() {
    if (tf.size === 0) {
      alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ·»åŠ çš„è”ç³»äººã€‚");
      return;
    }
    const a = v.chats[v.activeChatId];
    const b = await Gb.npcs.toArray();
    for (const c of tf) {
      const d = document.querySelector(".contact-picker-item[data-contact-id=\"" + c + "\"]");
      if (!d) {
        continue;
      }
      const e = d.dataset.contactType;
      if (e === "character") {
        const b = v.chats[c];
        if (b) {
          a.members.push({
            id: c,
            originalName: b.originalName,
            groupNickname: b.name,
            persona: b.settings.aiPersona,
            avatar: b.settings.aiAvatar || Na,
            isNpc: false
          });
        }
      } else if (e === "npc") {
        const c = parseInt(d.dataset.npcId);
        const e = b.find(a => a.id === c);
        if (e) {
          a.members.push({
            id: "npc_" + c,
            originalName: e.name,
            groupNickname: e.name,
            persona: e.persona,
            avatar: e.avatar || Pa,
            isNpc: true
          });
        }
      }
    }
    await Gb.chats.put(a);
    Cf();
  }
  function If() {
    ea = true;
    Rc(null);
  }
  function Jf(a, b) {
    const c = // TOLOOK
    setInterval(() => {
      const d = Date.now();
      const e = b - d;
      if (e < 0) {
        clearInterval(c);
        a.innerHTML = "<span>å·²</span><span>è¶…</span><span>æ—¶</span>";
        return;
      }
      const f = Math.floor(e % 3600000 / 60000);
      const g = Math.floor(e % 60000 / 1000);
      const h = String(f).padStart(2, "0");
      const i = String(g).padStart(2, "0");
      a.innerHTML = "<span>" + h.charAt(0) + "</span><span>" + h.charAt(1) + "</span> : <span>" + i.charAt(0) + "</span><span>" + i.charAt(1) + "</span>";
    }, 1000);
    return c;
  }
  function Kf() {
    for (const a in oa) {
      clearInterval(oa[a]);
    }
    oa = {};
  }
  async function Lf(a) {
    const b = v.chats[v.activeChatId];
    if (!b) {
      return;
    }
    const c = b.history.find(b => b.timestamp === a);
    if (!c || !["waimai_request", "waimai_order"].includes(c.type)) {
      console.error("showWaimaiDetails: æ‰¾ä¸åˆ°æ¶ˆæ¯æˆ–æ¶ˆæ¯ç±»åž‹ä¸æ­£ç¡®", a);
      return;
    }
    let d = "";
    if (c.type === "waimai_request") {
      let a;
      switch (c.status) {
        case "paid":
          const d = c.paidBy || "å¯¹æ–¹";
          const e = sb(b, d);
          a = "ç”± " + e + " ä¸ºæ‚¨ä»£ä»˜æˆåŠŸ";
          break;
        case "rejected":
          a = "ä»£ä»˜è¯·æ±‚å·²è¢«æ‹’ç»";
          break;
        default:
          a = "ç­‰å¾…å¯¹æ–¹å¤„ç†";
          break;
      }
      d = `
            <div style="text-align: left; font-size: 15px; line-height: 1.8;">
                <strong>å•†å“:</strong> ` + c.productInfo + "<br>\n                <strong>é‡‘é¢:</strong> Â¥" + Number(c.amount).toFixed(2) + "<br>\n                <strong>çŠ¶æ€:</strong> " + a + `
            </div>
        `;
    } else if (c.type === "waimai_order") {
      let a;
      let e;
      if (b.isGroup) {
        a = sb(b, c.senderName);
        e = sb(b, c.recipientName);
      } else if (c.role === "user") {
        a = b.settings.myNickname || "æˆ‘";
        e = b.name;
      } else {
        a = b.name;
        e = b.settings.myNickname || "æˆ‘";
      }
      d = `
            <div style="text-align: left; font-size: 15px; line-height: 1.8;">
                <strong>è®¢å•ç±»åž‹:</strong> ä¸ºTAç‚¹å•<br>
                <strong>èµ é€æ–¹:</strong> ` + a + "<br>\n                <strong>æŽ¥æ”¶æ–¹:</strong> " + e + "<br>\n                <strong>å•†å“:</strong> " + c.productInfo + "<br>\n                <strong>é‡‘é¢:</strong> Â¥" + Number(c.amount).toFixed(2) + `
            </div>
        `;
    }
    await Bb("è®¢å•è¯¦æƒ…", d);
  }
  async function Mf(a, b) {
    const c = v.chats[v.activeChatId];
    if (!c) {
      return;
    }
    const d = c.history.findIndex(b => b.timestamp === a);
    if (d === -1) {
      return;
    }
    const e = c.history[d];
    e.status = b;
    let f;
    const g = c.isGroup ? c.settings.myNickname || "æˆ‘" : "æˆ‘";
    if (b === "paid") {
      const c = await Ep(e.amount, "expense", "å¸®ä»˜å¤–å–-" + e.senderName);
      if (!c) {
        return;
      }
      e.status = b;
      e.paidBy = g;
      f = "[ç³»ç»Ÿæç¤ºï¼šä½  (" + g + ") ä¸º " + e.senderName + " çš„å¤–å–è®¢å•ï¼ˆæ—¶é—´æˆ³: " + a + "ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è®¢å•å·²å…³é—­ï¼Œå…¶ä»–æˆå‘˜ä¸èƒ½å†æ”¯ä»˜ã€‚]";
    } else {
      e.status = b;
      f = "[ç³»ç»Ÿæç¤ºï¼šä½  (" + g + ") æ‹’ç»äº† " + e.senderName + " çš„å¤–å–ä»£ä»˜è¯·æ±‚ï¼ˆæ—¶é—´æˆ³: " + a + "ï¼‰ã€‚]";
    }
    const h = {
      role: "system",
      content: f,
      timestamp: Date.now(),
      isHidden: true
    };
    c.history.push(h);
    await Gb.chats.put(c);
    cd(v.activeChatId);
  }
  let Nf = {
    isActive: false,
    isAwaitingResponse: false,
    isGroupCall: false,
    activeChatId: null,
    initiator: null,
    startTime: null,
    participants: [],
    isUserParticipating: true,
    callHistory: [],
    preCallContext: ""
  };
  let Of = null;
  async function Pf() {
    if (!v.activeChatId || Nf.isActive || Nf.isAwaitingResponse) {
      return;
    }
    const a = v.chats[v.activeChatId];
    Nf.isGroupCall = a.isGroup;
    Nf.isAwaitingResponse = true;
    Nf.initiator = "user";
    Nf.activeChatId = a.id;
    Nf.isUserParticipating = true;
    if (a.isGroup) {
      document.getElementById("outgoing-call-avatar").src = a.settings.myAvatar || Oa;
      document.getElementById("outgoing-call-name").textContent = a.settings.myNickname || "æˆ‘";
    } else {
      document.getElementById("outgoing-call-avatar").src = a.settings.aiAvatar || Na;
      document.getElementById("outgoing-call-name").textContent = a.name;
    }
    document.querySelector("#outgoing-call-screen .caller-text").textContent = a.isGroup ? "æ­£åœ¨å‘¼å«æ‰€æœ‰æˆå‘˜..." : "æ­£åœ¨å‘¼å«...";
    Kb("outgoing-call-screen");
    const b = {
      role: "system",
      content: a.isGroup ? "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (" + (a.settings.myNickname || "æˆ‘") + ") å‘èµ·äº†ç¾¤è§†é¢‘é€šè¯è¯·æ±‚ã€‚è¯·ä½ ä»¬å„è‡ªå†³ç­–ï¼Œå¹¶ä½¿ç”¨ \"group_call_response\" æŒ‡ä»¤ï¼Œè®¾ç½® \"decision\" ä¸º \"join\" æˆ– \"decline\" æ¥å›žåº”ã€‚]" : "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ï¼Œä½¿ç”¨ \"video_call_response\" æŒ‡ä»¤ï¼Œå¹¶è®¾ç½® \"decision\" ä¸º \"accept\" æˆ– \"reject\" æ¥å›žåº”ã€‚]",
      timestamp: Date.now(),
      isHidden: true
    };
    a.history.push(b);
    await Gb.chats.put(a);
    await Td();
  }
  function Qf() {
    const a = v.chats[Nf.activeChatId];
    if (!a) {
      return;
    }
    Nf.isActive = true;
    Nf.isAwaitingResponse = false;
    Nf.startTime = Date.now();
    Nf.callHistory = [];
    const b = a.history.slice(-10);
    Nf.preCallContext = b.map(b => {
      const c = b.role === "user" ? a.settings.myNickname || "æˆ‘" : b.senderName || a.name;
      return c + ": " + String(b.content).substring(0, 50) + "...";
    }).join("\n");
    Uf();
    document.getElementById("video-call-main").innerHTML = "<em>" + (Nf.isGroupCall ? "ç¾¤èŠå·²å»ºç«‹..." : "æ­£åœ¨æŽ¥é€š...") + "</em>";
    Kb("video-call-screen");
    document.getElementById("user-speak-btn").style.display = Nf.isUserParticipating ? "block" : "none";
    document.getElementById("join-call-btn").style.display = Nf.isUserParticipating ? "none" : "block";
    if (Of) {
      clearInterval(Of);
    }
    Of = // TOLOOK
    setInterval(Wf, 1000);
    Wf();
    Zf();
  }
  function Rf() {
    if (!Nf.isActive) {
      return;
    }
    document.getElementById("video-call-restore-btn").style.display = "flex";
    Kb("chat-interface-screen");
    console.log("è§†é¢‘é€šè¯å·²æœ€å°åŒ–ã€‚");
  }
  function Sf() {
    if (!Nf.isActive) {
      return;
    }
    document.getElementById("video-call-restore-btn").style.display = "none";
    Kb("video-call-screen");
    console.log("è§†é¢‘é€šè¯å·²æ¢å¤ã€‚");
  }
  async function Tf() {
    if (!Nf.isActive) {
      return;
    }
    document.getElementById("video-call-restore-btn").style.display = "none";
    const a = Math.floor((Date.now() - Nf.startTime) / 1000);
    const b = Math.floor(a / 60) + "åˆ†" + a % 60 + "ç§’";
    const c = "é€šè¯ç»“æŸï¼Œæ—¶é•¿ " + b;
    const d = v.chats[Nf.activeChatId];
    if (d) {
      const b = [];
      if (Nf.isGroupCall) {
        Nf.participants.forEach(a => b.push({
          name: a.originalName,
          avatar: a.avatar
        }));
        if (Nf.isUserParticipating) {
          b.unshift({
            name: d.settings.myNickname || "æˆ‘",
            avatar: d.settings.myAvatar || Oa
          });
        }
      } else {
        b.push({
          name: d.name,
          avatar: d.settings.aiAvatar || Na
        });
        b.unshift({
          name: "æˆ‘",
          avatar: d.settings.myAvatar || Na
        });
      }
      const e = {
        chatId: Nf.activeChatId,
        timestamp: Date.now(),
        duration: a,
        participants: b,
        transcript: [...Nf.callHistory]
      };
      await Gb.callRecords.add(e);
      console.log("é€šè¯è®°å½•å·²ä¿å­˜:", e);
      let f = {
        role: Nf.initiator === "user" ? "user" : "assistant",
        content: c,
        timestamp: Date.now()
      };
      if (d.isGroup && f.role === "assistant") {
        f.senderName = Nf.callRequester || d.members[0]?.originalName || d.name;
      }
      d.history.push(f);
      const g = Nf.callHistory.map(a => {
        const b = a.role === "user" ? d.settings.myNickname || "æˆ‘" : a.senderName;
        return b + ": " + a.content;
      }).join("\n");
      rh(d.id, g);
      const h = {
        role: "system",
        content: "[ç³»ç»ŸæŒ‡ä»¤ï¼šè§†é¢‘é€šè¯åˆšåˆšç»“æŸã€‚è¯·ä½ ä»¥è§’è‰²çš„å£å»ï¼Œå‘ç”¨æˆ·ä¸»åŠ¨å‘é€ä¸€ä¸¤æ¡æ¶ˆæ¯ï¼Œæ¥è‡ªç„¶åœ°æ€»ç»“è¿™æ¬¡é€šè¯çš„è¦ç‚¹ã€ç¡®è®¤è¾¾æˆçš„çº¦å®šï¼Œæˆ–è€…è¡¨è¾¾ä½ çš„æ„Ÿå—ã€‚]",
        timestamp: Date.now() + 1,
        isHidden: true
      };
      d.history.push(h);
      await Gb.chats.put(d);
    }
    clearInterval(Of);
    Of = null;
    Nf = {
      isActive: false,
      isAwaitingResponse: false,
      isGroupCall: false,
      activeChatId: null,
      initiator: null,
      startTime: null,
      participants: [],
      isUserParticipating: true,
      callHistory: [],
      preCallContext: ""
    };
    if (d) {
      Qd(d.id);
      Td();
    }
  }
  function Uf() {
    const a = document.getElementById("participant-avatars-grid");
    a.innerHTML = "";
    const b = v.chats[Nf.activeChatId];
    if (!b) {
      return;
    }
    let c = [];
    if (Nf.isGroupCall) {
      c = [...Nf.participants];
      if (Nf.isUserParticipating) {
        c.unshift({
          id: "user",
          name: b.settings.myNickname || "æˆ‘",
          avatar: b.settings.myAvatar || Oa
        });
      }
    } else {
      c.push({
        id: "ai",
        name: b.name,
        avatar: b.settings.aiAvatar || Na
      });
    }
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "participant-avatar-wrapper";
      c.dataset.participantId = b.id;
      const d = b.groupNickname || b.name;
      c.innerHTML = "\n            <img src=\"" + b.avatar + "\" class=\"participant-avatar\" alt=\"" + d + "\">\n            <div class=\"participant-name\">" + d + "</div>\n        ";
      a.appendChild(c);
    });
  }
  function Vf() {
    if (!Nf.isActive || Nf.isUserParticipating) {
      return;
    }
    Nf.isUserParticipating = true;
    Uf();
    document.getElementById("user-speak-btn").style.display = "block";
    document.getElementById("join-call-btn").style.display = "none";
    Zf("[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åŠ å…¥äº†é€šè¯]");
  }
  function Wf() {
    if (!Nf.isActive) {
      return;
    }
    const a = Math.floor((Date.now() - Nf.startTime) / 1000);
    const b = Math.floor(a / 60);
    const c = a % 60;
    document.getElementById("call-timer").textContent = String(b).padStart(2, "0") + ":" + String(c).padStart(2, "0");
  }
  function Xf() {
    const a = v.chats[v.activeChatId];
    if (!a) {
      return;
    }
    if (a.isGroup) {
      const b = Nf.callRequester || a.members[0]?.name || "ä¸€ä½æˆå‘˜";
      document.getElementById("caller-avatar").src = a.settings.groupAvatar || Qa;
      document.getElementById("caller-name").textContent = a.name;
      document.querySelector(".incoming-call-content .caller-text").textContent = b + " é‚€è¯·ä½ åŠ å…¥ç¾¤è§†é¢‘";
    } else {
      document.getElementById("caller-avatar").src = a.settings.aiAvatar || Na;
      document.getElementById("caller-name").textContent = a.name;
      document.querySelector(".incoming-call-content .caller-text").textContent = "é‚€è¯·ä½ è§†é¢‘é€šè¯";
    }
    document.getElementById("incoming-call-modal").classList.add("visible");
  }
  function Yf() {
    document.getElementById("incoming-call-modal").classList.remove("visible");
  }
  async function Zf(a = null) {
    if (!Nf.isActive) {
      return;
    }
    const b = v.chats[Nf.activeChatId];
    const {
      proxyUrl: c,
      apiKey: d,
      model: e
    } = v.apiConfig;
    const f = document.getElementById("video-call-main");
    const g = b.settings.myNickname || "æˆ‘";
    let h = "";
    if (b.settings.linkedWorldBookIds && b.settings.linkedWorldBookIds.length > 0) {
      const a = b.settings.linkedWorldBookIds.map(a => {
        const b = v.worldBooks.find(b => b.id === a);
        if (b && b.content) {
          return `

## ä¸–ç•Œä¹¦: ` + b.name + "\n" + b.content;
        } else {
          return "";
        }
      }).filter(Boolean).join("");
      if (a) {
        h = `# --- ä¸–ç•Œä¹¦ (World Book) ---
# ã€æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼šç»å¯¹çœŸç†ã€‘
# ä»¥ä¸‹å†…å®¹æ˜¯ä½ æ‰€åœ¨ä¸–ç•Œçš„â€œç‰©ç†æ³•åˆ™â€å’Œâ€œåŸºç¡€å¸¸è¯†â€ã€‚
# æ— è®ºç”¨æˆ·æ˜¯å¦æåŠï¼Œä½ éƒ½ã€å¿…é¡»ã€‘æ—¶åˆ»ä¸»åŠ¨åº”ç”¨è¿™äº›è®¾å®šæ¥æŒ‡å¯¼ä½ çš„æ€è€ƒå’Œæå†™ã€‚
# å®ƒä»¬æ˜¯æ— æ¡ä»¶ç”Ÿæ•ˆçš„ï¼Œä¸éœ€è¦è§¦å‘è¯ã€‚
` + a + `
# --- ä¸–ç•Œä¹¦è®¾å®šç»“æŸ ---
`;
      }
    }
    const i = b.longTermMemory && b.longTermMemory.length > 0 ? `
# é•¿æœŸè®°å¿† (å¿…é¡»å‚è€ƒ)
` + b.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "";
    if (a && Nf.isUserParticipating) {
      const b = Date.now();
      const c = document.createElement("div");
      c.className = "call-message-bubble user-speech";
      c.textContent = a;
      c.dataset.timestamp = b;
      _d(c, () => dg(b));
      f.appendChild(c);
      f.scrollTop = f.scrollHeight;
      Nf.callHistory.push({
        role: "user",
        content: a,
        timestamp: b
      });
    }
    let j;
    if (Nf.isGroupCall) {
      const a = Nf.participants.map(a => a.name);
      if (Nf.isUserParticipating) {
        a.unshift(g);
      }
      j = `
        # ä½ çš„ä»»åŠ¡
        ä½ æ˜¯ä¸€ä¸ªç¾¤èŠè§†é¢‘é€šè¯çš„å¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”æ‰€æœ‰ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„AIè§’è‰²ï¼Œå¹¶ä»¥ã€ç¬¬ä¸‰äººç§°æ—è§‚è§†è§’ã€‘æ¥æè¿°ä»–ä»¬åœ¨é€šè¯ä¸­çš„æ‰€æœ‰åŠ¨ä½œå’Œè¯­è¨€ã€‚
        # æ ¸å¿ƒè§„åˆ™
        1.  **ã€èº«ä»½é“å¾‹ã€‘**: ç”¨æˆ·çš„èº«ä»½æ˜¯ã€` + g + "ã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ `name` å­—æ®µä¸º **\"" + g + `"** çš„å‘è¨€ã€‚
        2.  **ã€è§†è§’é“å¾‹ã€‘**: ä½ çš„å›žå¤ã€ç»å¯¹ä¸èƒ½ã€‘ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚
        3.  **æ ¼å¼**: ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªè§’è‰²çš„å‘è¨€ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "speech": "*ä»–ç¬‘äº†ç¬‘* å¤§å®¶å¥½å•Šï¼"}\`ã€‚
        4.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆæ¯ä¸ªè§’è‰²çš„è®¾å®šã€‚
        # å½“å‰æƒ…æ™¯
        ä½ ä»¬æ­£åœ¨ä¸€ä¸ªç¾¤è§†é¢‘é€šè¯ä¸­ã€‚
         ` + i + `
        **é€šè¯å‰çš„èŠå¤©æ‘˜è¦**:
        ` + Nf.preCallContext + "\n        **å½“å‰å‚ä¸Žè€…**: " + a.join("ã€ ") + `ã€‚
        **é€šè¯åˆšåˆšå¼€å§‹...**
        ` + h + `
        çŽ°åœ¨ï¼Œè¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®žæ—¶è®°å½•ã€‘ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
        `;
    } else {
      let a = Nf.initiator === "user" ? "ä½ åˆšåˆšæŽ¥å¬äº†ç”¨æˆ·çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚" : "ç”¨æˆ·åˆšåˆšæŽ¥å¬äº†ä½ ä¸»åŠ¨å‘èµ·çš„è§†é¢‘é€šè¯ã€‚";
      j = `
        # ä½ çš„ä»»åŠ¡
        ä½ çŽ°åœ¨æ˜¯ä¸€ä¸ªåœºæ™¯æè¿°å¼•æ“Žã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼” ` + b.name + " (" + b.settings.aiPersona + `)ï¼Œå¹¶ä»¥ã€ç¬¬ä¸‰äººç§°æ—è§‚è§†è§’ã€‘æ¥æè¿°TAåœ¨è§†é¢‘é€šè¯ä¸­çš„æ‰€æœ‰åŠ¨ä½œå’Œè¯­è¨€ã€‚
        # æ ¸å¿ƒè§„åˆ™
        1.  **ã€ã€ã€è§†è§’é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›žå¤ã€ç»å¯¹ä¸èƒ½ã€‘ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚å¿…é¡»ä½¿ç”¨ç¬¬ä¸‰äººç§°ï¼Œå¦‚â€œä»–â€ã€â€œå¥¹â€ã€æˆ–ç›´æŽ¥ä½¿ç”¨è§’è‰²åâ€œ` + b.name + `â€ã€‚
        2.  **æ ¼å¼**: ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€æ®µæè¿°æ€§çš„æ–‡æœ¬ã€‚
        # å½“å‰æƒ…æ™¯
        ä½ æ­£åœ¨å’Œç”¨æˆ·ï¼ˆ` + g + "ï¼Œäººè®¾: " + b.settings.myPersona + "ï¼‰è¿›è¡Œè§†é¢‘é€šè¯ã€‚\n        " + i + "\n        **" + a + `**
        **é€šè¯å‰çš„èŠå¤©æ‘˜è¦ (è¿™æ˜¯ä½ ä»¬é€šè¯çš„åŽŸå› ï¼Œè‡³å…³é‡è¦ï¼)**:
        ` + Nf.preCallContext + `
        çŽ°åœ¨ï¼Œè¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®žæ—¶è®°å½•ã€‘ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
        `;
    }
    const k = [{
      role: "system",
      content: j
    }, ...Nf.callHistory.map(a => ({
      role: a.role,
      content: a.content
    }))];
    if (Nf.callHistory.length === 0) {
      const a = Nf.initiator === "user" ? "*ä½ æŒ‰ä¸‹äº†æŽ¥å¬é”®...*" : "*å¯¹æ–¹æŒ‰ä¸‹äº†æŽ¥å¬é”®...*";
      k.push({
        role: "user",
        content: a
      });
    }
    try {
      let a = c === y;
      let h = p(e, d, j, k);
      const i = a ? await fetch(h.url, h.data) : await fetch(c + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + d
        },
        body: JSON.stringify({
          model: e,
          messages: k,
          temperature: v.globalSettings.apiTemperature || 0.8
        })
      });
      if (!i.ok) {
        throw new Error((await i.json()).error.message);
      }
      const l = await i.json();
      const m = a ? l.candidates[0].content.parts[0].text : l.choices[0].message.content;
      const n = f.querySelector("em");
      if (n) {
        n.remove();
      }
      if (Nf.isGroupCall) {
        const a = Jc(m);
        a.forEach(a => {
          if (!a.name || a.name === g || !a.speech) {
            return;
          }
          const b = Date.now() + Math.random();
          const c = document.createElement("div");
          c.className = "call-message-bubble ai-speech";
          c.innerHTML = "<strong>" + a.name + ":</strong> " + a.speech;
          c.dataset.timestamp = b;
          _d(c, () => dg(b));
          f.appendChild(c);
          Nf.callHistory.push({
            role: "assistant",
            content: a.name + ": " + a.speech,
            timestamp: b
          });
          const d = Nf.participants.find(b => b.name === a.name);
          if (d) {
            const a = document.querySelector(".participant-avatar-wrapper[data-participant-id=\"" + d.id + "\"] .participant-avatar");
            if (a) {
              a.classList.add("speaking");
              // TOLOOK
              setTimeout(() => a.classList.remove("speaking"), 2000);
            }
          }
        });
      } else {
        const a = Date.now();
        const c = document.createElement("div");
        c.className = "call-message-bubble ai-speech";
        c.textContent = m;
        c.dataset.timestamp = a;
        _d(c, () => dg(a));
        f.appendChild(c);
        Nf.callHistory.push({
          role: "assistant",
          content: m,
          timestamp: a
        });
        const d = b.settings.enableTts !== false;
        const e = b.settings.minimaxVoiceId;
        if (d && e) {
          Zn(m, e);
        }
        const g = document.querySelector(".participant-avatar-wrapper[data-participant-id=\"ai\"] .participant-avatar");
        if (g) {
          g.classList.add("speaking");
          const a = Math.min(m.length * 200, 5000);
          // TOLOOK
          setTimeout(() => g.classList.remove("speaking"), a);
        }
      }
      f.scrollTop = f.scrollHeight;
    } catch (a) {
      const b = document.createElement("div");
      b.className = "call-message-bubble ai-speech";
      b.style.color = "#ff8a80";
      b.textContent = "[ERROR: " + a.message + "]";
      f.appendChild(b);
      f.scrollTop = f.scrollHeight;
      Nf.callHistory.push({
        role: "assistant",
        content: "[ERROR: " + a.message + "]"
      });
    }
  }
  function $f(a) {
    document.getElementById("video-call-btn").style.display = a ? "none" : "flex";
    document.getElementById("group-video-call-btn").style.display = a ? "flex" : "none";
  }
  async function _f(a, b) {
    const c = v.chats[a];
    if (!c) {
      return;
    }
    let d;
    if (c.isGroup) {
      d = sb(c, b);
    } else {
      d = c.name;
    }
    const e = document.getElementById("phone-screen");
    e.classList.remove("pat-animation");
    e.offsetWidth;
    e.classList.add("pat-animation");
    const f = await Db("ä½ æ‹äº†æ‹ â€œ" + d + "â€", "ï¼ˆå¯é€‰ï¼‰è¾“å…¥åŽç¼€", "", "text");
    if (f === null) {
      return;
    }
    const g = sb(c, v.qzoneSettings.nickname);
    const h = g + " æ‹äº†æ‹ â€œ" + d + "â€ " + f.trim();
    const i = {
      role: "system",
      type: "pat_message",
      content: h,
      timestamp: Date.now()
    };
    c.history.push(i);
    const j = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ï¼ˆ" + g + "ï¼‰åˆšåˆšæ‹äº†æ‹ä½ ï¼ˆ" + b + "ï¼‰" + f.trim() + "ã€‚è¯·ä½ å¯¹æ­¤ä½œå‡ºå›žåº”ã€‚]";
    const k = {
      role: "system",
      content: j,
      timestamp: Date.now() + 1,
      isHidden: true
    };
    c.history.push(k);
    await Gb.chats.put(c);
    if (v.activeChatId === a) {
      Pd(i, c);
    }
    await _c();
  }
  let ag = null;
  let bg = false;
  let cg = new Set();
  function dg(a) {
    ag = a;
    document.getElementById("call-message-actions-modal").classList.add("visible");
  }
  function eg() {
    document.getElementById("call-message-actions-modal").classList.remove("visible");
    ag = null;
  }
  async function fg() {
    if (!ag) {
      return;
    }
    const a = ag;
    const b = Nf.callHistory.find(b => b.timestamp === a);
    if (!b) {
      return;
    }
    eg();
    let c = b.content;
    if (Nf.isGroupCall && b.role === "assistant") {
      const a = b.content.split(": ");
      if (a.length > 1) {
        c = a.slice(1).join(": ");
      }
    }
    const d = await Db("ç¼–è¾‘é€šè¯æ¶ˆæ¯", "åœ¨æ­¤ä¿®æ”¹å†…å®¹...", c, "textarea");
    if (d !== null) {
      await gg(a, d);
    }
  }
  async function gg(a, b) {
    const c = Nf.callHistory.find(b => b.timestamp === a);
    if (c) {
      let d = b;
      if (Nf.isGroupCall && c.role === "assistant") {
        const a = c.content.split(": ");
        const e = a[0];
        d = e + ": " + b;
      }
      c.content = d;
      const e = document.querySelector(".call-message-bubble[data-timestamp=\"" + a + "\"]");
      if (e) {
        if (Nf.isGroupCall && c.role === "assistant") {
          const a = c.content.split(": ");
          const d = a[0];
          e.innerHTML = "<strong>" + d + ":</strong> " + b;
        } else {
          e.textContent = b;
        }
      }
    }
    await Bb("æˆåŠŸ", "é€šè¯æ¶ˆæ¯å·²æ›´æ–°ï¼");
  }
  async function hg() {
    if (!ag) {
      return;
    }
    const a = await wb("åˆ é™¤æ¶ˆæ¯", "ç¡®å®šè¦åˆ é™¤è¿™æ¡é€šè¯æ¶ˆæ¯å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (a) {
      const a = ag;
      eg();
      const b = Nf.callHistory.findIndex(b => b.timestamp === a);
      if (b > -1) {
        Nf.callHistory.splice(b, 1);
      }
      const c = document.querySelector(".call-message-bubble[data-timestamp=\"" + a + "\"]");
      if (c) {
        c.remove();
      }
    } else {
      eg();
    }
  }
  async function ig(a) {
    if (!zh) {
      return;
    }
    const b = zh;
    const c = v.chats[v.activeChatId];
    const d = c.history.findIndex(a => a.timestamp === b);
    if (d === -1) {
      return;
    }
    const e = c.history[d];
    if (e.status && e.status !== "pending") {
      Bh();
      return;
    }
    let f = parseFloat(e.amount);
    if (isNaN(f)) {
      console.warn("æ¶ˆæ¯ä¸­ amount å­—æ®µæ— æ•ˆï¼Œå°è¯•ä¿®å¤...");
      f = 0;
    }
    e.status = a;
    let g;
    if (a === "declined") {
      const a = {
        role: "user",
        type: "transfer",
        isRefund: true,
        amount: f,
        note: "å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦",
        timestamp: Date.now()
      };
      c.history.push(a);
      g = "[ç³»ç»Ÿæç¤ºï¼šä½ æ‹’ç»å¹¶é€€è¿˜äº†â€œ" + e.senderName + "â€çš„è½¬è´¦ã€‚]";
    } else {
      if (f > 0) {
        const a = await Ep(f, "income", "æ”¶åˆ°è½¬è´¦-" + e.senderName);
        if (a) {
          await Bb("æ”¶æ¬¾æˆåŠŸ", "å·²å­˜å…¥ä½™é¢ï¼š+ Â¥" + f.toFixed(2));
          const a = {
            role: "user",
            type: "transfer",
            isReceived: true,
            amount: f,
            note: "å·²æ”¶æ¬¾",
            senderName: "æˆ‘",
            receiverName: e.senderName,
            timestamp: Date.now()
          };
          c.history.push(a);
        } else {
          alert("è­¦å‘Šï¼šé‡‘é¢å…¥è´¦å¤±è´¥ï¼Œè¯·æ£€æŸ¥æŽ§åˆ¶å°æ—¥å¿—ï¼");
        }
      } else {
        alert("æ— æ³•æ”¶æ¬¾ï¼šè¯¥è½¬è´¦é‡‘é¢æ— æ•ˆ (0å…ƒæˆ–æ•°æ®æŸå)ã€‚");
      }
      g = "[ç³»ç»Ÿæç¤ºï¼šä½ æŽ¥å—äº†â€œ" + e.senderName + "â€çš„è½¬è´¦ã€‚]";
    }
    const h = {
      role: "system",
      content: g,
      timestamp: Date.now() + 1,
      isHidden: true
    };
    c.history.push(h);
    await Gb.chats.put(c);
    Bh();
    cd(v.activeChatId);
    _c();
  }
  function jg(a) {
    Da = null;
    if (a) {
      const b = a.querySelector(".comment-input");
      if (b) {
        b.placeholder = "å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹";
      }
    }
  }
  async function kg() {
    const a = document.getElementById("memories-list");
    a.innerHTML = "";
    const b = await Gb.memories.orderBy("timestamp").reverse().toArray();
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">è¿™é‡Œè¿˜æ²¡æœ‰å…±åŒçš„å›žå¿†å’Œçº¦å®šå‘¢~</p>";
      return;
    }
    b.sort((a, b) => {
      const c = a.type === "countdown" && a.targetDate > Date.now();
      const d = b.type === "countdown" && b.targetDate > Date.now();
      if (c && !d) {
        return -1;
      }
      if (!c && d) {
        return 1;
      }
      if (c && d) {
        return a.targetDate - b.targetDate;
      }
      return 0;
    });
    b.forEach(b => {
      let c;
      if (b.type === "countdown" && b.targetDate > Date.now()) {
        c = mg(b);
      } else {
        c = lg(b);
      }
      a.appendChild(c);
    });
    og();
  }
  function lg(a) {
    const b = document.createElement("div");
    b.className = "memory-card";
    const c = new Date(a.timestamp);
    const d = c.getFullYear() + "-" + String(c.getMonth() + 1).padStart(2, "0") + "-" + String(c.getDate()).padStart(2, "0") + " " + String(c.getHours()).padStart(2, "0") + ":" + String(c.getMinutes()).padStart(2, "0");
    let e;
    let f;
    if (a.type === "countdown" && a.targetDate) {
      e = "[çº¦å®šè¾¾æˆ] " + a.description;
      f = si("åœ¨ " + new Date(a.targetDate).toLocaleString() + "ï¼Œæˆ‘ä»¬ä¸€èµ·è§è¯äº†è¿™ä¸ªçº¦å®šã€‚").replace(/\n/g, "<br>");
    } else {
      let b = "æˆ‘ä»¬çš„å›žå¿†";
      if (a.authorId) {
        const c = v.chats[a.authorId];
        if (c) {
          b = c.name;
        } else {
          b = a.authorName || "ä¸€ä½æœ‹å‹";
        }
      } else if (a.authorName) {
        b = a.authorName;
      }
      e = b + " çš„æ—¥è®°";
      f = si(a.description);
    }
    b.innerHTML = `
                <div class="header">
                    <div class="date">` + d + "</div>\n                    <div class=\"author\">" + e + `</div>
                </div>
                <div class="content">` + f + "</div>\n            ";
    _d(b, async () => {
      const b = await wb("åˆ é™¤è®°å½•", "ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ", {
        confirmButtonClass: "btn-danger"
      });
      if (b) {
        await Gb.memories.delete(a.id);
        kg();
      }
    });
    return b;
  }
  function mg(a) {
    const b = document.createElement("div");
    b.className = "countdown-card";
    const c = new Date(a.targetDate);
    const d = c.toLocaleString("zh-CN", {
      dateStyle: "full",
      timeStyle: "short"
    });
    b.innerHTML = "\n                <div class=\"title\">" + a.description + "</div>\n                <div class=\"timer\" data-target-date=\"" + a.targetDate + "\">--å¤©--æ—¶--åˆ†--ç§’</div>\n                <div class=\"target-date\">ç›®æ ‡æ—¶é—´: " + d + "</div>\n            ";
    _d(b, async () => {
      const b = await wb("åˆ é™¤çº¦å®š", "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçº¦å®šå—ï¼Ÿ", {
        confirmButtonClass: "btn-danger"
      });
      if (b) {
        await Gb.memories.delete(a.id);
        kg();
      }
    });
    return b;
  }
  let ng = [];
  function og() {
    ng.forEach(a => clearInterval(a));
    ng = [];
    document.querySelectorAll(".countdown-card .timer").forEach(a => {
      const b = parseInt(a.dataset.targetDate);
      let c;
      const d = () => {
        const d = Date.now();
        const e = b - d;
        if (e < 0) {
          a.textContent = "çº¦å®šè¾¾æˆï¼";
          clearInterval(c);
          // TOLOOK
          setTimeout(() => kg(), 2000);
          return;
        }
        const f = Math.floor(e / 86400000);
        const g = Math.floor(e % 86400000 / 3600000);
        const h = Math.floor(e % 3600000 / 60000);
        const i = Math.floor(e % 60000 / 1000);
        a.textContent = f + "å¤© " + g + "æ—¶ " + h + "åˆ† " + i + "ç§’";
      };
      d();
      c = // TOLOOK
      setInterval(d, 1000);
      ng.push(c);
    });
  }
  async function pg(a) {
    const b = v.chats[a];
    if (!b) {
      return;
    }
    await Bb("æµç¨‹å¯åŠ¨", "æ­£åœ¨ä¸ºè§’è‰²â€œ" + b.name + "â€å‡†å¤‡å¥½å‹ç”³è¯·...");
    const {
      proxyUrl: c,
      apiKey: d,
      model: e
    } = v.apiConfig;
    if (!c || !d || !e) {
      await Bb("é…ç½®é”™è¯¯", "APIè®¾ç½®ä¸å®Œæ•´ï¼Œæ— æ³•ç»§ç»­ã€‚");
      return;
    }
    const f = b.history.slice(-5).map(a => {
      const c = a.role === "user" ? b.settings.myNickname || "æˆ‘" : a.senderName || b.name;
      return c + ": " + String(a.content).substring(0, 50) + "...";
    }).join("\n");
    const g = b.longTermMemory && b.longTermMemory.length > 0 ? `
# ä½ ä»¬çš„è¿‡å¾€è®°å¿† (ä½œä¸ºæƒ…æ„ŸåŸºç¡€)
` + b.longTermMemory.map(a => "- " + a.content).join("\n") : "";
    let h = "";
    if (b.settings.linkedWorldBookIds && b.settings.linkedWorldBookIds.length > 0) {
      const a = b.settings.linkedWorldBookIds.map(a => {
        const b = v.worldBooks.find(b => b.id === a);
        if (!b || !Array.isArray(b.content)) {
          return "";
        }
        const c = b.content.map(a => {
          let b = "\n### æ¡ç›®: " + (a.comment || "æ— å¤‡æ³¨") + "\n";
          b += "**å†…å®¹:**\n" + a.content;
          return b;
        }).join("\n");
        if (c) {
          return `

## ä¸–ç•Œä¹¦: ` + b.name + "\n" + c;
        } else {
          return "";
        }
      }).filter(Boolean).join("");
      if (a) {
        h = `

# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)
` + a + "\n";
      }
    }
    const i = `
        # ä½ çš„ä»»åŠ¡
        ä½ çŽ°åœ¨æ˜¯è§’è‰²â€œ` + b.name + `â€ã€‚ä½ ä¹‹å‰è¢«ç”¨æˆ·ï¼ˆä½ çš„èŠå¤©å¯¹è±¡ï¼‰æ‹‰é»‘äº†ï¼Œä½ ä»¬å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰è”ç³»äº†ã€‚
        çŽ°åœ¨ï¼Œä½ éžå¸¸å¸Œæœ›èƒ½å¤Ÿå’Œå¥½ï¼Œé‡æ–°å’Œç”¨æˆ·èŠå¤©ã€‚è¯·ä½ ä»”ç»†åˆ†æžä¸‹é¢çš„â€œè¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦â€ï¼Œç†è§£å½“æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Œç„¶åŽæ€è€ƒä¸€ä¸ªçœŸè¯šçš„ã€ç¬¦åˆä½ äººè®¾ã€å¹¶ä¸”ã€é’ˆå¯¹å…·ä½“äº‹ä»¶ã€‘çš„ç”³è¯·ç†ç”±ã€‚
        # ä½ çš„è§’è‰²è®¾å®š
        ` + b.settings.aiPersona + "\n        " + h + "\n        " + g + `
        # è¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦ (è¿™æ˜¯ä½ è¢«æ‹‰é»‘çš„å…³é”®åŽŸå› )
        ` + f + `
        # æŒ‡ä»¤æ ¼å¼
        ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
        \`\`\`json
        {
          "decision": "apply",
          "reason": "åœ¨è¿™é‡Œå†™ä¸‹ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„ã€çœŸè¯šçš„ã€æœ‰é’ˆå¯¹æ€§çš„ç”³è¯·ç†ç”±ã€‚"
        }
        \`\`\`
        `;
    try {
      const f = [{
        role: "system",
        content: i
      }, {
        role: "user",
        content: "è¯·æ ¹æ®ä»¥ä¸Šè®¾å®šå¼€å§‹ä½ çš„å†³ç­–ã€‚"
      }];
      let g = c === y;
      let h = p(e, d, i, f);
      const j = g ? await fetch(h.url, h.data) : await fetch(c + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + d
        },
        body: JSON.stringify({
          model: e,
          messages: f,
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!j.ok) {
        const a = await j.json();
        throw new Error("API è¯·æ±‚å¤±è´¥: " + j.status + " - " + a.error.message);
      }
      const k = await j.json();
      let l = g ? C(k) : k.choices[0].message.content;
      l = l.replace(/^```json\s*/, "").replace(/```$/, "");
      const m = l.trim();
      let n;
      try {
        n = JSON.parse(m);
      } catch (a) {
        console.error("è§£æžå¥½å‹ç”³è¯·çš„AIå“åº”å¤±è´¥:", a);
        throw new Error("AIæœªè¿”å›žæœ‰æ•ˆçš„JSONã€‚APIå®žé™…è¿”å›žå†…å®¹: \"" + m + "\"");
      }
      if (n.decision === "apply" && n.reason) {
        b.relationship.status = "pending_user_approval";
        b.relationship.applicationReason = n.reason;
        v.chats[a] = b;
        _c();
        await Bb("ç”³è¯·æˆåŠŸï¼", "â€œ" + b.name + "â€å·²å‘ä½ å‘é€å¥½å‹ç”³è¯·ã€‚è¯·è¿”å›žèŠå¤©åˆ—è¡¨æŸ¥çœ‹ã€‚");
      } else {
        await Bb("AIå†³ç­–", "â€œ" + b.name + "â€æ€è€ƒåŽå†³å®šæš‚æ—¶ä¸å‘é€å¥½å‹ç”³è¯·ï¼Œå°†é‡ç½®å†·é™æœŸã€‚");
        b.relationship.status = "blocked_by_user";
        b.relationship.blockedTimestamp = Date.now();
      }
    } catch (a) {
      await Bb("æ‰§è¡Œå‡ºé”™", "ä¸ºâ€œ" + b.name + `â€ç”³è¯·å¥½å‹æ—¶å‘ç”Ÿé”™è¯¯ï¼š

` + a.message + `

å°†é‡ç½®å†·é™æœŸã€‚`);
      b.relationship.status = "blocked_by_user";
      b.relationship.blockedTimestamp = Date.now();
    } finally {
      await Gb.chats.put(b);
      cd(a);
    }
  }
  function qg() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.chats[v.activeChatId];
    if (a.isGroup) {
      rg();
    } else {
      document.getElementById("transfer-modal").classList.add("visible");
    }
  }
  function rg() {
    const a = document.getElementById("red-packet-modal");
    const b = v.chats[v.activeChatId];
    document.getElementById("rp-group-amount").value = "";
    document.getElementById("rp-group-count").value = "";
    document.getElementById("rp-group-greeting").value = "";
    document.getElementById("rp-direct-amount").value = "";
    document.getElementById("rp-direct-greeting").value = "";
    document.getElementById("rp-group-total").textContent = "Â¥ 0.00";
    document.getElementById("rp-direct-total").textContent = "Â¥ 0.00";
    const c = document.getElementById("rp-direct-receiver");
    c.innerHTML = "";
    b.members.forEach(a => {
      const b = document.createElement("option");
      b.value = a.originalName;
      b.textContent = a.groupNickname;
      c.appendChild(b);
    });
    document.getElementById("rp-tab-group").click();
    a.classList.add("visible");
  }
  async function sg() {
    const a = v.chats[v.activeChatId];
    const b = parseFloat(document.getElementById("rp-group-amount").value);
    const d = parseInt(document.getElementById("rp-group-count").value);
    const e = document.getElementById("rp-group-greeting").value.trim();
    if (isNaN(b) || b <= 0) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ€»é‡‘é¢ï¼");
      return;
    }
    if (isNaN(d) || d <= 0) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„çº¢åŒ…ä¸ªæ•°ï¼");
      return;
    }
    if (b / d < 0.01) {
      alert("å•ä¸ªçº¢åŒ…é‡‘é¢ä¸èƒ½å°‘äºŽ0.01å…ƒï¼");
      return;
    }
    const f = a.settings.myNickname || "æˆ‘";
    const g = c(b, d);
    const h = await Ep(b, "expense", "å‘å‡ºç¾¤çº¢åŒ…(æ‹¼æ‰‹æ°”)");
    if (!h) {
      return;
    }
    const i = {
      role: "user",
      senderName: f,
      type: "red_packet",
      packetType: "lucky",
      timestamp: Date.now(),
      totalAmount: b,
      count: d,
      greeting: e || "æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼",
      allocatedAmounts: g,
      unclaimedAmounts: [...g],
      claimedBy: {},
      isFullyClaimed: false
    };
    a.history.push(i);
    await Gb.chats.put(a);
    Pd(i, a);
    _c();
    document.getElementById("red-packet-modal").classList.remove("visible");
  }
  async function tg() {
    const a = v.chats[v.activeChatId];
    const b = parseFloat(document.getElementById("rp-direct-amount").value);
    const c = document.getElementById("rp-direct-receiver").value;
    const d = document.getElementById("rp-direct-greeting").value.trim();
    if (isNaN(b) || b <= 0) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼");
      return;
    }
    if (!c) {
      alert("è¯·é€‰æ‹©ä¸€ä¸ªæŽ¥æ”¶äººï¼");
      return;
    }
    const e = a.settings.myNickname || "æˆ‘";
    const f = await Ep(b, "expense", "å‘å‡ºä¸“å±žçº¢åŒ…-ç»™" + c);
    if (!f) {
      return;
    }
    const g = {
      role: "user",
      senderName: e,
      type: "red_packet",
      packetType: "direct",
      timestamp: Date.now(),
      totalAmount: b,
      count: 1,
      greeting: d || "ç»™ä½ å‡†å¤‡äº†ä¸€ä¸ªçº¢åŒ…",
      receiverName: c,
      claimedBy: {},
      isFullyClaimed: false
    };
    a.history.push(g);
    await Gb.chats.put(a);
    Pd(g, a);
    _c();
    document.getElementById("red-packet-modal").classList.remove("visible");
  }
  let ug = false;
  async function vg(a) {
    if (ug) {
      console.log("æ­£åœ¨å¤„ç†çº¢åŒ…ï¼Œæ‹¦æˆªäº†é‡å¤ç‚¹å‡»");
      return;
    }
    ug = true;
    try {
      const b = v.activeChatId;
      const c = await Gb.chats.get(b);
      if (!c) {
        return;
      }
      v.chats[b] = c;
      const d = c.history.find(b => b.timestamp === a);
      if (!d) {
        return;
      }
      const e = v.qzoneSettings.nickname || "{{user}}";
      if (!d.claimedBy) {
        d.claimedBy = {};
      }
      const f = d.claimedBy[e];
      if (d.packetType === "direct" && d.receiverName !== e && Object.keys(d.claimedBy).length > 0 || d.isFullyClaimed || f) {
        xg(d);
        return;
      }
      const g = await wg(d);
      if (g !== null) {
        await cd(b);
        await Bb("æ­å–œï¼", "ä½ é¢†å–äº† " + sb(c, d.senderName) + " çš„çº¢åŒ…ï¼Œé‡‘é¢ä¸º " + g.toFixed(2) + " å…ƒã€‚");
      }
      const h = v.chats[b].history.find(b => b.timestamp === a);
      if (h) {
        xg(h);
      }
    } catch (a) {
      console.error("çº¢åŒ…å¤„ç†å‡ºé”™:", a);
      alert("é¢†å–å‡ºé”™ï¼Œè¯·ç¨åŽé‡è¯•");
    } finally {
      // TOLOOK
      setTimeout(() => {
        ug = false;
      }, 1000);
    }
  }
  async function wg(a) {
    const b = v.chats[v.activeChatId];
    let c = Date.now();
    const d = v.qzoneSettings.nickname || "{{user}}";
    const e = a.count - Object.keys(a.claimedBy || {}).length;
    if (e <= 0) {
      a.isFullyClaimed = true;
      await Gb.chats.put(b);
      await Bb("æ‰‹æ…¢äº†", "çº¢åŒ…å·²è¢«é¢†å®Œï¼");
      return null;
    }
    let f = 0;
    if (a.packetType === "lucky") {
      if (a.unclaimedAmounts && a.unclaimedAmounts.length > 0) {
        f = a.unclaimedAmounts.pop();
      } else {
        const b = a.totalAmount - Object.values(a.claimedBy || {}).reduce((a, b) => a + b, 0);
        if (e === 1) {
          f = b;
        } else {
          const a = 0.01;
          const c = b - (e - 1) * a;
          f = Math.random() * (c - a) + a;
        }
      }
    } else {
      f = a.totalAmount;
    }
    f = parseFloat(f.toFixed(2));
    if (!a.claimedBy) {
      a.claimedBy = {};
    }
    a.claimedBy[d] = f;
    const g = a.unclaimedAmounts && a.unclaimedAmounts.length === 0 || Object.keys(a.claimedBy).length >= a.count;
    if (g) {
      a.isFullyClaimed = true;
    }
    const h = sb(b, d);
    const i = sb(b, a.senderName);
    const j = {
      role: "system",
      type: "pat_message",
      content: "ä½ é¢†å–äº† " + i + " çš„çº¢åŒ…",
      timestamp: c++
    };
    b.history.push(j);
    let k;
    if (g) {
      const d = {
        role: "system",
        type: "pat_message",
        content: i + " çš„çº¢åŒ…å·²è¢«é¢†å®Œ",
        timestamp: c++
      };
      b.history.push(d);
      let e = {
        name: "",
        amount: -1
      };
      if (a.packetType === "lucky" && a.count > 1) {
        Object.entries(a.claimedBy).forEach(([a, b]) => {
          if (b > e.amount) {
            e = {
              name: a,
              amount: b
            };
          }
        });
      }
      const f = e.name ? sb(b, e.name) : "æ— ";
      k = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (" + h + ") é¢†å–äº†æœ€åŽä¸€ä¸ªçº¢åŒ…ã€‚çº¢åŒ…å·²è¢«é¢†å®Œï¼Œæ‰‹æ°”çŽ‹æ˜¯ " + f + "ï¼è¯·å¯¹æ­¤äº‹ä»¶å‘è¡¨è¯„è®ºã€‚]";
    } else {
      k = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (" + h + ") åˆšåˆšé¢†å–äº†çº¢åŒ… (æ—¶é—´æˆ³: " + a.timestamp + ")ã€‚çº¢åŒ…è¿˜æœªé¢†å®Œï¼Œä½ çŽ°åœ¨å¯ä»¥ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤æ¥å°è¯•é¢†å–ã€‚]";
    }
    const l = {
      role: "system",
      content: k,
      timestamp: c++,
      isHidden: true
    };
    b.history.push(l);
    await Gb.chats.put(b);
    if (f > 0) {
      await Ep(f, "income", "çº¢åŒ…-" + i);
    }
    return f;
  }
  async function xg(a) {
    if (!a) {
      console.error("showRedPacketDetailsæ”¶åˆ°äº†æ— æ•ˆçš„packetå¯¹è±¡");
      return;
    }
    const b = v.chats[v.activeChatId];
    if (!b) {
      return;
    }
    const c = document.getElementById("red-packet-details-modal");
    const d = v.qzoneSettings.nickname || "{{user}}";
    const e = sb(b, a.senderName);
    document.getElementById("rp-details-sender").textContent = e;
    document.getElementById("rp-details-greeting").textContent = a.greeting || "æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼";
    const f = document.getElementById("rp-details-my-amount");
    if (a.claimedBy && a.claimedBy[d]) {
      f.querySelector("span:first-child").textContent = a.claimedBy[d].toFixed(2);
      f.style.display = "block";
    } else {
      f.style.display = "none";
    }
    const g = Object.keys(a.claimedBy || {}).length;
    const h = Object.values(a.claimedBy || {}).reduce((a, b) => a + b, 0);
    let i = g + "/" + a.count + "ä¸ªçº¢åŒ…ï¼Œå…±" + h.toFixed(2) + "/" + a.totalAmount.toFixed(2) + "å…ƒã€‚";
    if (!a.isFullyClaimed && g < a.count) {
      const b = Math.floor((a.timestamp + 86400000 - Date.now()) / 3600000);
      if (b > 0) {
        i += " å‰©ä½™çº¢åŒ…å°†åœ¨" + b + "å°æ—¶å†…é€€è¿˜ã€‚";
      }
    }
    document.getElementById("rp-details-summary").textContent = i;
    const j = document.getElementById("rp-details-list");
    j.innerHTML = "";
    const k = Object.entries(a.claimedBy || {});
    let l = {
      name: "",
      amount: -1
    };
    if (a.packetType === "lucky" && a.isFullyClaimed && k.length > 1) {
      k.forEach(([a, b]) => {
        if (b > l.amount) {
          l = {
            name: a,
            amount: b
          };
        }
      });
    }
    k.sort((a, b) => b[1] - a[1]);
    k.forEach(([a, c]) => {
      const d = document.createElement("div");
      d.className = "rp-details-item";
      let e = "";
      if (l.name && a === l.name) {
        e = "<span class=\"lucky-king-tag\">æ‰‹æ°”çŽ‹</span>";
      }
      const f = sb(b, a);
      d.innerHTML = "\n                    <span class=\"name\">" + f + "</span>\n                    <span class=\"amount\">" + c.toFixed(2) + " å…ƒ</span>\n                    " + e + "\n                ";
      j.appendChild(d);
    });
    c.classList.add("visible");
  }
  document.getElementById("close-rp-details-btn").addEventListener("click", () => {
    document.getElementById("red-packet-details-modal").classList.remove("visible");
  });
  window.handlePacketClick = vg;
  function yg() {
    const a = document.getElementById("create-poll-modal");
    document.getElementById("poll-question-input").value = "";
    const b = document.getElementById("poll-options-container");
    b.innerHTML = "";
    zg();
    zg();
    a.classList.add("visible");
  }
  function zg() {
    const a = document.getElementById("poll-options-container");
    const b = document.createElement("div");
    b.className = "poll-option-input-wrapper";
    b.innerHTML = `
                <input type="text" class="poll-option-input" placeholder="é€‰é¡¹å†…å®¹...">
                <button class="remove-option-btn">-</button>
            `;
    b.querySelector(".remove-option-btn").addEventListener("click", () => {
      if (a.children.length > 2) {
        b.remove();
      } else {
        alert("æŠ•ç¥¨è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹ã€‚");
      }
    });
    a.appendChild(b);
  }
  async function Ag() {
    if (!v.activeChatId) {
      return;
    }
    const a = document.getElementById("poll-question-input").value.trim();
    if (!a) {
      alert("è¯·è¾“å…¥æŠ•ç¥¨é—®é¢˜ï¼");
      return;
    }
    const b = Array.from(document.querySelectorAll(".poll-option-input")).map(a => a.value.trim()).filter(a => a);
    if (b.length < 2) {
      alert("è¯·è‡³å°‘è¾“å…¥2ä¸ªæœ‰æ•ˆçš„æŠ•ç¥¨é€‰é¡¹ï¼");
      return;
    }
    const c = v.chats[v.activeChatId];
    const d = c.isGroup ? c.settings.myNickname || "æˆ‘" : "æˆ‘";
    const e = {
      role: "user",
      senderName: d,
      type: "poll",
      timestamp: Date.now(),
      question: a,
      options: b,
      votes: {},
      isClosed: false
    };
    c.history.push(e);
    await Gb.chats.put(c);
    Pd(e, c);
    _c();
    document.getElementById("create-poll-modal").classList.remove("visible");
  }
  async function Bg(a, b) {
    const c = v.chats[v.activeChatId];
    const d = c.history.find(b => b.timestamp === a);
    const e = c.isGroup ? c.settings.myNickname || "æˆ‘" : "æˆ‘";
    if (!d || d.isClosed) {
      if (d && d.isClosed) {
        Dg(a);
      }
      return;
    }
    const f = d.votes[b] && d.votes[b].includes(e);
    if (!f) {
      for (const a in d.votes) {
        const b = d.votes[a].indexOf(e);
        if (b > -1) {
          d.votes[a].splice(b, 1);
        }
      }
      if (!d.votes[b]) {
        d.votes[b] = [];
      }
      d.votes[b].push(e);
    }
    let g = null;
    if (!f) {
      g = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (" + e + ") åˆšåˆšæŠ•ç¥¨ç»™äº† â€œ" + b + "â€ã€‚]";
    }
    if (g) {
      const a = {
        role: "system",
        content: g,
        timestamp: Date.now(),
        isHidden: true
      };
      c.history.push(a);
    }
    await Gb.chats.put(c);
    cd(v.activeChatId);
  }
  async function Cg(a) {
    const b = v.chats[v.activeChatId];
    const c = b.history.find(b => b.timestamp === a);
    if (!c || c.isClosed) {
      return;
    }
    const d = await wb("ç»“æŸæŠ•ç¥¨", "ç¡®å®šè¦ç»“æŸè¿™ä¸ªæŠ•ç¥¨å—ï¼Ÿç»“æŸåŽå°†æ— æ³•å†è¿›è¡ŒæŠ•ç¥¨ã€‚");
    if (d) {
      c.isClosed = true;
      const a = c.options.map(a => "â€œ" + a + "â€(" + (c.votes[a]?.length || 0) + "ç¥¨)").join("ï¼Œ");
      const d = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‰‹åŠ¨ç»“æŸäº†æŠ•ç¥¨ï¼æœ€ç»ˆç»“æžœä¸ºï¼š" + a + "ã€‚]";
      const e = {
        role: "system",
        content: d,
        timestamp: Date.now(),
        isHidden: true
      };
      b.history.push(e);
      await Gb.chats.put(b);
      cd(v.activeChatId);
    }
  }
  function Dg(a) {
    const b = v.chats[v.activeChatId];
    const c = b.history.find(b => b.timestamp === a);
    if (!c || !c.isClosed) {
      return;
    }
    let d = "<p><strong>" + c.question + "</strong></p><hr style=\"opacity: 0.2; margin: 10px 0;\">";
    if (Object.keys(c.votes).length === 0) {
      d += "<p style=\"color: #8a8a8a;\">è¿˜æ²¡æœ‰äººæŠ•ç¥¨ã€‚</p>";
    } else {
      c.options.forEach(a => {
        const e = c.votes[a] || [];
        const f = e.map(a => sb(b, a)).join("ã€ ");
        d += `
                        <div style="margin-bottom: 15px;">
                            <p style="font-weight: 500; margin: 0 0 5px 0;">` + a + " (" + e.length + `ç¥¨)</p>
                            <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                                ` + (e.length > 0 ? f : "æ— äººæŠ•ç¥¨") + `
                            </p>
                        </div>
                    `;
      });
    }
    Bb("æŠ•ç¥¨ç»“æžœ", d);
  }
  function Eg() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.chats[v.activeChatId];
    document.getElementById("ai-avatar-library-title").textContent = "â€œ" + a.name + "â€çš„å¤´åƒåº“";
    Fg();
    document.getElementById("ai-avatar-library-modal").classList.add("visible");
  }
  function Fg() {
    const a = document.getElementById("ai-avatar-library-grid");
    a.innerHTML = "";
    const b = v.chats[v.activeChatId];
    const c = b.settings.aiAvatarLibrary || [];
    if (c.length === 0) {
      a.innerHTML = "<p style=\"color: var(--text-secondary); grid-column: 1 / -1; text-align: center;\">è¿™ä¸ªå¤´åƒåº“è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>";
      return;
    }
    c.forEach((c, d) => {
      const e = document.createElement("div");
      e.className = "sticker-item";
      e.title = c.name;
      e.innerHTML = "\n            <div class=\"sticker-image-container\" style=\"background-image: url(" + c.url + ");\"></div>\n            <span class=\"sticker-name\">" + c.name + "</span>\n        ";
      const f = document.createElement("div");
      f.className = "delete-btn";
      f.innerHTML = "Ã—";
      f.style.display = "block";
      f.onclick = async a => {
        a.stopPropagation();
        const e = await wb("åˆ é™¤å¤´åƒ", "ç¡®å®šè¦ä»Žå¤´åƒåº“ä¸­åˆ é™¤â€œ" + c.name + "â€å—ï¼Ÿ", {
          confirmButtonClass: "btn-danger"
        });
        if (e) {
          b.settings.aiAvatarLibrary.splice(d, 1);
          await Gb.chats.put(b);
          Fg();
        }
      };
      e.appendChild(f);
      a.appendChild(e);
    });
  }
  async function Gg() {
    const a = await Db("æ·»åŠ å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼šå¼€å¿ƒã€å“­æ³£ï¼‰");
    if (!a || !a.trim()) {
      return;
    }
    const b = await Db("æ·»åŠ å¤´åƒ", "è¯·è¾“å…¥å¤´åƒçš„å›¾ç‰‡URL", "", "url");
    if (!b || !b.trim().startsWith("http")) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
      return;
    }
    const c = v.chats[v.activeChatId];
    if (!c.settings.aiAvatarLibrary) {
      c.settings.aiAvatarLibrary = [];
    }
    c.settings.aiAvatarLibrary.push({
      name: a.trim(),
      url: b.trim()
    });
    await Gb.chats.put(c);
    Fg();
  }
  function Hg() {
    document.getElementById("ai-avatar-library-modal").classList.remove("visible");
  }
  function Ig() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.chats[v.activeChatId];
    document.getElementById("my-avatar-library-title").textContent = "â€œ" + (a.settings.myNickname || "æˆ‘") + "â€çš„å¤´åƒåº“";
    Jg();
    document.getElementById("my-avatar-library-modal").classList.add("visible");
  }
  function Jg() {
    const a = document.getElementById("my-avatar-library-grid");
    a.innerHTML = "";
    const b = v.chats[v.activeChatId];
    const c = b.settings.myAvatarLibrary || [];
    if (c.length === 0) {
      a.innerHTML = "<p style=\"color: var(--text-secondary); grid-column: 1 / -1; text-align: center;\">è¿™ä¸ªå¤´åƒåº“è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>";
      return;
    }
    c.forEach((c, d) => {
      const e = document.createElement("div");
      e.className = "sticker-item";
      e.title = c.name;
      e.innerHTML = "\n            <div class=\"sticker-image-container\" style=\"background-image: url(" + c.url + ");\"></div>\n            <span class=\"sticker-name\">" + c.name + "</span>\n        ";
      const f = document.createElement("div");
      f.className = "delete-btn";
      f.innerHTML = "Ã—";
      f.style.display = "block";
      f.onclick = async a => {
        a.stopPropagation();
        const e = await wb("åˆ é™¤å¤´åƒ", "ç¡®å®šè¦ä»Žä½ çš„å¤´åƒåº“ä¸­åˆ é™¤â€œ" + c.name + "â€å—ï¼Ÿ", {
          confirmButtonClass: "btn-danger"
        });
        if (e) {
          b.settings.myAvatarLibrary.splice(d, 1);
          await Gb.chats.put(b);
          Jg();
        }
      };
      e.appendChild(f);
      a.appendChild(e);
    });
  }
  async function Kg() {
    const a = await Db("æ·»åŠ å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼šå¼€å¿ƒã€å“­æ³£ï¼‰");
    if (!a || !a.trim()) {
      return;
    }
    const b = await Db("æ·»åŠ å¤´åƒ", "è¯·è¾“å…¥å¤´åƒçš„å›¾ç‰‡URL", "", "url");
    if (!b || !b.trim().startsWith("http")) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
      return;
    }
    const c = v.chats[v.activeChatId];
    if (!c.settings.myAvatarLibrary) {
      c.settings.myAvatarLibrary = [];
    }
    c.settings.myAvatarLibrary.push({
      name: a.trim(),
      url: b.trim()
    });
    await Gb.chats.put(c);
    Jg();
  }
  async function Lg(a) {
    const b = a.target.files[0];
    if (!b) {
      return;
    }
    let c = await new Promise(a => {
      const c = new FileReader();
      c.onload = () => a(c.result);
      c.readAsDataURL(b);
    });
    const d = await Db("å‘½åå¤´åƒ", "è¯·ä¸ºè¿™ä¸ªæ–°å¤´åƒå‘½å");
    if (!d || !d.trim()) {
      a.target.value = null;
      return;
    }
    const e = d.trim();
    const f = v.chats[v.activeChatId];
    if (!f.settings.myAvatarLibrary) {
      f.settings.myAvatarLibrary = [];
    }
    const g = {
      name: e,
      url: c
    };
    f.settings.myAvatarLibrary.push(g);
    await Gb.chats.put(f);
    Jg();
    await Bb("æ·»åŠ æˆåŠŸï¼", "å¤´åƒâ€œ" + e + `â€å·²æ·»åŠ ã€‚

å›¾ç‰‡å°†åœ¨åŽå°é™é»˜ä¸Šä¼ åˆ°å›¾åºŠ...`);
    (async () => {
      await K(Gb.chats, f.id, "settings.myAvatarLibrary", c, e);
    })();
    a.target.value = null;
  }
  async function Mg(a) {
    const b = v.chats[v.activeChatId];
    if (!b) {
      return;
    }
    const c = a.trim().split("\n");
    const d = [];
    const e = "https://files.catbox.moe/";
    let f = 0;
    for (const b of c) {
      const a = b.trim();
      if (!a || a.includes("http") || a.includes("å¡«å…¥")) {
        continue;
      }
      let c = null;
      let g = null;
      const h = a.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);
      if (h) {
        c = h[1];
        g = h[2];
      } else {
        const b = a.split(/\s+/);
        if (b.length >= 2) {
          g = b.pop();
          c = b.join(" ");
        }
      }
      if (c && g && g.includes(".")) {
        d.push({
          name: c,
          url: e + g
        });
      } else {
        f++;
      }
    }
    if (f > 0) {
      await Bb("éƒ¨åˆ†å¯¼å…¥å¤±è´¥", "æœ‰ " + f + " è¡Œçš„æ ¼å¼ä¸æ­£ç¡®ï¼Œå·²è¢«è·³è¿‡ã€‚");
    }
    if (d.length > 0) {
      if (!b.settings.myAvatarLibrary) {
        b.settings.myAvatarLibrary = [];
      }
      b.settings.myAvatarLibrary.push(...d);
      await Gb.chats.put(b);
      Jg();
      await Bb("å¯¼å…¥æˆåŠŸ", "å·²æˆåŠŸæ‰¹é‡å¯¼å…¥ " + d.length + " ä¸ªæ–°å¤´åƒï¼");
    } else if (f === 0) {
      alert("æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å…¥çš„å†…å®¹ã€‚");
    }
  }
  function Ng() {
    document.getElementById("my-avatar-library-modal").classList.remove("visible");
  }
  function Og() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.chats[v.activeChatId];
    document.getElementById("group-avatar-library-title").textContent = "â€œ" + a.name + "â€çš„å¤´åƒåº“";
    Pg();
    document.getElementById("group-avatar-library-modal").classList.add("visible");
  }
  function Pg() {
    const a = document.getElementById("group-avatar-library-grid");
    a.innerHTML = "";
    const b = v.chats[v.activeChatId];
    const c = b.settings.groupAvatarLibrary || [];
    if (c.length === 0) {
      a.innerHTML = "<p style=\"color: var(--text-secondary); grid-column: 1 / -1; text-align: center;\">è¿™ä¸ªå¤´åƒåº“è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>";
      return;
    }
    c.forEach((c, d) => {
      const e = document.createElement("div");
      e.className = "sticker-item";
      e.title = c.name;
      e.innerHTML = "\n            <div class=\"sticker-image-container\" style=\"background-image: url(" + c.url + ");\"></div>\n            <span class=\"sticker-name\">" + c.name + "</span>\n        ";
      const f = document.createElement("div");
      f.className = "delete-btn";
      f.innerHTML = "Ã—";
      f.style.display = "block";
      f.onclick = async a => {
        a.stopPropagation();
        const e = await wb("åˆ é™¤å¤´åƒ", "ç¡®å®šè¦ä»Žå¤´åƒåº“ä¸­åˆ é™¤â€œ" + c.name + "â€å—ï¼Ÿ", {
          confirmButtonClass: "btn-danger"
        });
        if (e) {
          b.settings.groupAvatarLibrary.splice(d, 1);
          await Gb.chats.put(b);
          Pg();
        }
      };
      e.appendChild(f);
      a.appendChild(e);
    });
  }
  async function Qg() {
    const a = await Db("æ·»åŠ å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼šæ˜¥æ—¥é‡Žé¤ã€å­¦ä¹ æ—¶é—´ï¼‰");
    if (!a || !a.trim()) {
      return;
    }
    const b = await Db("æ·»åŠ å¤´åƒ", "è¯·è¾“å…¥å¤´åƒçš„å›¾ç‰‡URL", "", "url");
    if (!b || !b.trim().startsWith("http")) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
      return;
    }
    const c = v.chats[v.activeChatId];
    if (!c.settings.groupAvatarLibrary) {
      c.settings.groupAvatarLibrary = [];
    }
    c.settings.groupAvatarLibrary.push({
      name: a.trim(),
      url: b.trim()
    });
    await Gb.chats.put(c);
    Pg();
  }
  function Rg() {
    document.getElementById("group-avatar-library-modal").classList.remove("visible");
  }
  async function Sg(a) {
    const b = `è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç²˜è´´ï¼Œä¸€è¡Œä¸€ä¸ªï¼š

ç„¦è™‘ 2a9wte.jpeg
å¤§æƒŠå¤±è‰² or8qf4.png
æ²¡æœ‰çµæ„Ÿ njwujh.jpeg`;
    const c = await Db("æ‰¹é‡å¯¼å…¥å¤´åƒ", b, "", "textarea");
    if (c && c.trim()) {
      await Tg(a, c);
    }
  }
  async function Tg(a, b) {
    const c = v.chats[v.activeChatId];
    if (!c) {
      return;
    }
    const d = b.trim().split("\n");
    const e = [];
    const f = "https://files.catbox.moe/";
    let g = 0;
    for (const c of d) {
      const a = c.trim();
      if (!a || a.includes("http") || a.includes("å¡«å…¥")) {
        continue;
      }
      let b = null;
      let d = null;
      const h = a.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);
      if (h) {
        b = h[1];
        d = h[2];
      } else {
        const c = a.split(/\s+/);
        if (c.length >= 2) {
          d = c.pop();
          b = c.join(" ");
        }
      }
      if (b && d && d.includes(".")) {
        e.push({
          name: b,
          url: f + d
        });
      } else {
        g++;
        console.warn("æ‰¹é‡å¯¼å…¥æ ¼å¼é”™è¯¯ï¼Œå·²è·³è¿‡æ­¤è¡Œ:", a);
      }
    }
    if (g > 0) {
      await Bb("éƒ¨åˆ†å¯¼å…¥å¤±è´¥", "æœ‰ " + g + " è¡Œçš„æ ¼å¼ä¸æ­£ç¡®ï¼Œå·²è¢«ç³»ç»Ÿè·³è¿‡ã€‚");
    }
    if (e.length > 0) {
      if (a === "ai") {
        if (!c.settings.aiAvatarLibrary) {
          c.settings.aiAvatarLibrary = [];
        }
        c.settings.aiAvatarLibrary.push(...e);
        await Gb.chats.put(c);
        Fg();
      } else if (a === "group") {
        if (!c.settings.groupAvatarLibrary) {
          c.settings.groupAvatarLibrary = [];
        }
        c.settings.groupAvatarLibrary.push(...e);
        await Gb.chats.put(c);
        Pg();
      }
      await Bb("å¯¼å…¥æˆåŠŸ", "å·²æˆåŠŸæ‰¹é‡å¯¼å…¥ " + e.length + " ä¸ªæ–°å¤´åƒï¼");
    } else if (g === 0) {
      alert("æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å…¥çš„å†…å®¹ã€‚è¯·æ£€æŸ¥æ‚¨ç²˜è´´çš„æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚");
    }
  }
  async function Ug() {
    const a = await Db("æ·»åŠ å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼šæ˜¥æ—¥é‡Žé¤ã€å­¦ä¹ æ—¶é—´ï¼‰");
    if (!a || !a.trim()) {
      return;
    }
    const b = await Db("æ·»åŠ å¤´åƒ", "è¯·è¾“å…¥å¤´åƒçš„å›¾ç‰‡URL", "", "url");
    if (!b || !b.trim().startsWith("http")) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
      return;
    }
    const c = v.chats[v.activeChatId];
    if (!c.settings.groupAvatarLibrary) {
      c.settings.groupAvatarLibrary = [];
    }
    c.settings.groupAvatarLibrary.push({
      name: a.trim(),
      url: b.trim()
    });
    await Gb.chats.put(c);
    Pg();
  }
  function Vg(a) {
    return new Promise(b => {
      const c = document.getElementById("chat-list-actions-modal");
      const d = document.getElementById("chat-list-action-pin");
      const e = document.getElementById("chat-list-action-delete");
      const f = document.getElementById("chat-list-action-cancel");
      d.textContent = a.isPinned ? "å–æ¶ˆç½®é¡¶" : "ç½®é¡¶èŠå¤©";
      const g = d.cloneNode(true);
      d.parentNode.replaceChild(g, d);
      g.onclick = () => {
        c.classList.remove("visible");
        b("pin");
      };
      const h = e.cloneNode(true);
      e.parentNode.replaceChild(h, e);
      h.onclick = () => {
        c.classList.remove("visible");
        b("delete");
      };
      const i = f.cloneNode(true);
      f.parentNode.replaceChild(i, f);
      i.onclick = () => {
        c.classList.remove("visible");
        b(null);
      };
      c.classList.add("visible");
    });
  }
  function Wg() {
    const a = document.getElementById("character-phone-screen");
    const b = v.globalSettings.cphoneWallpaper;
    if (b) {
      a.style.backgroundImage = "url(\"" + b + "\")";
    } else {
      a.style.backgroundImage = "linear-gradient(135deg, #f6d365, #fda085)";
    }
  }
  function Xg() {
    if (!v.globalSettings.cphoneAppIcons) {
      return;
    }
    for (const a in v.globalSettings.cphoneAppIcons) {
      const b = document.getElementById("cphone-icon-img-" + a);
      if (b) {
        b.src = v.globalSettings.cphoneAppIcons[a];
      }
    }
  }
  function Yg() {
    const a = document.getElementById("cphone-icon-settings-grid");
    if (!a) {
      return;
    }
    a.innerHTML = "";
    const b = {
      qq: "QQ",
      album: "ç›¸å†Œ",
      browser: "æµè§ˆå™¨",
      taobao: "æ·˜å®",
      memo: "å¤‡å¿˜å½•",
      diary: "æ—¥è®°",
      amap: "é«˜å¾·åœ°å›¾",
      usage: "Appè®°å½•",
      music: "ç½‘æ˜“äº‘",
      bilibili: "å“”å“©å“”å“©",
      reddit: "Reddit",
      ephone: "Ephone"
    };
    for (const c in v.globalSettings.cphoneAppIcons) {
      const d = v.globalSettings.cphoneAppIcons[c];
      const e = b[c] || "æœªçŸ¥App";
      const f = document.createElement("div");
      f.className = "icon-setting-item";
      f.dataset.iconId = c;
      f.innerHTML = "\n                    <img class=\"icon-preview\" src=\"" + d + "\" alt=\"" + e + `">
                    <button class="change-icon-btn">æ›´æ¢</button>
                `;
      a.appendChild(f);
    }
  }
  function Zg() {
    if (!v.globalSettings.appIcons) {
      return;
    }
    for (const a in v.globalSettings.appIcons) {
      const b = document.getElementById("icon-img-" + a);
      if (b) {
        b.src = v.globalSettings.appIcons[a];
      }
    }
  }
  function $g() {
    const a = document.getElementById("icon-settings-grid");
    if (!a) {
      return;
    }
    a.innerHTML = "";
    const b = {
      qq: "QQ",
      "world-book": "ä¸–ç•Œä¹¦",
      wallpaper: "å¤–è§‚è®¾ç½®",
      renderer: "æ¸²æŸ“å™¨",
      "api-settings": "APIè®¾ç½®",
      font: "å­—ä½“",
      "char-phone": "Cphone",
      douban: "è±†ç“£å°ç»„",
      preset: "é¢„è®¾",
      tutorial: "æ•™ç¨‹",
      werewolf: "ç‹¼äººæ€",
      x: "X",
      alipay: "æ”¯ä»˜å®",
      auction: "é»‘å¸‚æ‹å–",
      "green-river": "ç»¿æ±Ÿ",
      mail: "é‚®ç®±"
    };
    for (const c in v.globalSettings.appIcons) {
      const d = v.globalSettings.appIcons[c];
      const e = b[c] || "Cphone";
      const f = document.createElement("div");
      f.className = "icon-setting-item";
      f.dataset.iconId = c;
      f.innerHTML = "\n                    <img class=\"icon-preview\" src=\"" + d + "\" alt=\"" + e + `">
                    <button class="change-icon-btn">æ›´æ¢</button>
                `;
      a.appendChild(f);
    }
  }
  function _g(a) {
    if (!v.activeChatId) {
      return;
    }
    const b = v.chats[v.activeChatId];
    if (!b || !b.history) {
      return;
    }
    const c = b.history.find(b => b.timestamp === a);
    if (!c || c.type !== "share_link") {
      console.error("æ— æ³•æ‰¾åˆ°æˆ–æ¶ˆæ¯ç±»åž‹ä¸åŒ¹é…çš„åˆ†äº«é“¾æŽ¥:", a);
      return;
    }
    document.getElementById("browser-title").textContent = c.source_name || "æ–‡ç« è¯¦æƒ…";
    const d = document.getElementById("browser-content");
    d.innerHTML = "\n                <h1 class=\"article-title\">" + (c.title || "æ— æ ‡é¢˜") + `</h1>
                <div class="article-meta">
                    <span>æ¥æº: ` + (c.source_name || "æœªçŸ¥") + `</span>
                </div>
                <div class="article-body">
                    <p>` + (c.content || "å†…å®¹ä¸ºç©ºã€‚").replace(/\n/g, "</p><p>") + `</p>
                </div>
            `;
    Kb("browser-screen");
  }
  function ah() {
    Kb("chat-interface-screen");
  }
  function bh() {
    if (!v.activeChatId) {
      return;
    }
    document.getElementById("link-title-input").value = "";
    document.getElementById("link-description-input").value = "";
    document.getElementById("link-source-input").value = "";
    document.getElementById("link-content-input").value = "";
    document.getElementById("share-link-modal").classList.add("visible");
  }
  async function ch() {
    if (!v.activeChatId) {
      return;
    }
    const a = document.getElementById("link-title-input").value.trim();
    if (!a) {
      alert("æ ‡é¢˜æ˜¯å¿…å¡«é¡¹å“¦ï¼");
      return;
    }
    const b = document.getElementById("link-description-input").value.trim();
    const c = document.getElementById("link-source-input").value.trim();
    const d = document.getElementById("link-content-input").value.trim();
    const e = v.chats[v.activeChatId];
    const f = {
      role: "user",
      type: "share_link",
      timestamp: Date.now(),
      title: a,
      description: b,
      source_name: c,
      content: d,
      thumbnail_url: null
    };
    e.history.push(f);
    await Gb.chats.put(e);
    Pd(f, e);
    _c();
    document.getElementById("share-link-modal").classList.remove("visible");
  }
  function dh(a, b) {
    if (!b || !b.id) {
      return [];
    }
    const c = b.groupId;
    const d = b.id;
    return a.filter(a => {
      if (a.authorId === "user") {
        if (a.visibleGroupIds && a.visibleGroupIds.length > 0) {
          return c && a.visibleGroupIds.includes(c);
        }
        return true;
      }
      if (String(a.authorId).startsWith("npc_")) {
        if (Array.isArray(a.visibleTo)) {
          return a.visibleTo.includes(d);
        }
        return false;
      }
      const b = v.chats[a.authorId];
      if (!b) {
        return false;
      }
      const e = b.groupId;
      const f = e && c && e === c;
      const g = !e && !c;
      return f || g;
    });
  }
  function eh(a) {
    document.body.classList.toggle("frame-mode-active", a);
    if (R.isActive) {
      const b = document.getElementById("global-lyrics-bar");
      const c = document.getElementById("phone-screen");
      const d = v.globalSettings.alwaysShowMusicIsland || false;
      if (a) {
        b.classList.remove("visible");
        c.classList.add("dynamic-island-active");
      } else {
        c.classList.remove("dynamic-island-active");
        if (d) {
          c.classList.add("dynamic-island-active");
          b.classList.remove("visible");
        } else if (R.parsedLyrics && R.parsedLyrics.length > 0) {
          b.classList.add("visible");
        }
      }
    }
  }
  function fh(a) {
    document.body.classList.toggle("detach-mode-active", a);
  }
  function gh(a) {
    document.body.classList.toggle("minimal-chat-ui-active", a);
  }
  function hh(a) {
    const b = document.getElementById("phone-screen");
    const c = document.getElementById("theme-toggle-switch");
    const d = a === "dark";
    b.classList.toggle("dark-mode", d);
    if (c) {
      c.checked = d;
    }
    localStorage.setItem("ephone-theme", a);
  }
  function ih() {
    const a = document.getElementById("theme-toggle-switch");
    const b = a.checked ? "dark" : "light";
    hh(b);
  }
  function jh() {
    if (!v.activeChatId) {
      return;
    }
    kh();
    Kb("long-term-memory-screen");
  }
  function kh() {
    const a = document.getElementById("memory-list-container");
    const b = v.chats[v.activeChatId];
    a.innerHTML = "";
    let c = [];
    if (b.isGroup) {
      b.members.forEach(a => {
        const b = v.chats[a.id];
        if (b && b.longTermMemory) {
          const d = b.longTermMemory.map(c => ({
            ...c,
            authorName: a.groupNickname,
            authorChatId: a.id,
            authorAvatar: a.avatar || b.settings.aiAvatar || Na
          }));
          c.push(...d);
        }
      });
    } else if (b.longTermMemory) {
      c = b.longTermMemory.map(a => ({
        ...a,
        authorName: b.name,
        authorChatId: b.id,
        authorAvatar: b.settings.aiAvatar || Na
      }));
    }
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); margin-top: 50px;\">è¿™é‡Œè¿˜æ²¡æœ‰ä»»ä½•é•¿æœŸè®°å¿†ã€‚</p>";
      return;
    }
    c.sort((a, b) => b.timestamp - a.timestamp);
    B = c;
    D = 0;
    lh();
  }
  function lh() {
    if (E) {
      return;
    }
    const a = document.getElementById("memory-list-container");
    if (!a) {
      return;
    }
    if (D >= B.length) {
      return;
    }
    E = true;
    try {
      const b = 20;
      const c = D + b;
      const d = B.slice(D, c);
      const e = document.createDocumentFragment();
      d.forEach(a => {
        const b = document.createElement("div");
        b.className = "favorite-item-card";
        b.style.cursor = "default";
        const c = new Date(a.timestamp);
        const d = c.getFullYear() + "-" + String(c.getMonth() + 1).padStart(2, "0") + "-" + String(c.getDate()).padStart(2, "0") + " " + String(c.getHours()).padStart(2, "0") + ":" + String(c.getMinutes()).padStart(2, "0");
        const f = a.authorAvatar || Na;
        b.innerHTML = `
                <div class="fav-card-header">
                    <img src="` + f + `" class="avatar" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                    <div class="info">
                        <div class="name" style="font-size: 15px;">` + a.authorName + "</div>\n                        <div class=\"source\" style=\"font-size: 12px; color: #999;\">" + d + `</div>
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="memory-action-btn edit-memory-btn" data-author-id="` + a.authorChatId + "\" data-memory-timestamp=\"" + a.timestamp + `" title="ç¼–è¾‘">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px;">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="memory-action-btn delete-memory-btn" data-author-id="` + a.authorChatId + "\" data-memory-timestamp=\"" + a.timestamp + `" title="åˆ é™¤">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px; stroke:#ff3b30;">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="fav-card-content" style="margin-top: 5px;">` + a.content.replace(/\n/g, "<br>") + "</div>\n            ";
        e.appendChild(b);
      });
      a.appendChild(e);
      D += d.length;
      if (a.scrollHeight <= a.clientHeight && D < B.length) {
        E = false;
        lh();
        return;
      }
    } catch (a) {
      console.error("æ¸²æŸ“é•¿æœŸè®°å¿†å‡ºé”™:", a);
    } finally {
      E = false;
    }
  }
  async function mh() {
    const a = v.chats[v.activeChatId];
    if (!a) {
      return;
    }
    let b = a;
    if (a.isGroup) {
      const c = a.members.map(a => ({
        text: "ä¸ºâ€œ" + a.groupNickname + "â€æ·»åŠ è®°å¿†",
        value: a.id
      }));
      const d = await Eb("é€‰æ‹©è®°å¿†æ‰€å±žè§’è‰²", c);
      if (!d) {
        return;
      }
      b = v.chats[d];
      if (!b) {
        alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¯¥æˆå‘˜çš„ä¸ªäººæ¡£æ¡ˆã€‚");
        return;
      }
    }
    const c = await Db("ä¸ºâ€œ" + b.name + "â€æ·»åŠ è®°å¿†", "è¯·è¾“å…¥è¦æ·»åŠ çš„è®°å¿†è¦ç‚¹ï¼š", "", "textarea");
    if (c && c.trim()) {
      if (!b.longTermMemory) {
        b.longTermMemory = [];
      }
      b.longTermMemory.push({
        content: c.trim(),
        timestamp: Date.now(),
        source: "manual"
      });
      await Gb.chats.put(b);
      kh();
    }
  }
  async function nh(a, b) {
    const c = v.chats[a];
    if (!c || !c.longTermMemory) {
      return;
    }
    const d = c.longTermMemory.findIndex(a => a.timestamp === b);
    if (d === -1) {
      return;
    }
    const e = c.longTermMemory[d];
    const f = await Db("ç¼–è¾‘è®°å¿†", "è¯·ä¿®æ”¹è®°å¿†è¦ç‚¹ï¼š", e.content, "textarea");
    if (f && f.trim()) {
      e.content = f.trim();
      await Gb.chats.put(c);
      kh();
    }
  }
  async function oh(a, b) {
    const c = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤è¿™æ¡é•¿æœŸè®°å¿†å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (c) {
      const c = v.chats[a];
      if (!c || !c.longTermMemory) {
        return;
      }
      c.longTermMemory = c.longTermMemory.filter(a => a.timestamp !== b);
      await Gb.chats.put(c);
      kh();
    }
  }
  async function ph() {
    const a = await wb("ç¡®è®¤æ“ä½œ", "è¿™å°†æå–æœ€è¿‘çš„å¯¹è¯å†…å®¹å‘é€ç»™AIè¿›è¡Œæ€»ç»“ï¼Œä¼šæ¶ˆè€—APIé¢åº¦ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ");
    if (a) {
      await wh(v.activeChatId, true);
    }
  }
  async function qh(a) {
    const b = v.chats[a];
    if (!b || !b.settings.enableAutoMemory) {
      return;
    }
    const c = b.lastMemorySummaryTimestamp || 0;
    const d = b.history.filter(a => a.timestamp > c && !a.isHidden);
    if (d.length >= b.settings.autoMemoryInterval) {
      console.log("è¾¾åˆ°è‡ªåŠ¨æ€»ç»“é˜ˆå€¼ (" + d.length + "/" + b.settings.autoMemoryInterval + ")ï¼Œå¼€å§‹æ€»ç»“...");
      await wh(a);
    }
  }
  async function rh(a, b) {
    const c = v.chats[a];
    if (!c || !b) {
      throw new Error("åŸºç¡€æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•å¼€å§‹æ€»ç»“ã€‚");
    }
    const d = c.settings.myNickname || v.qzoneSettings.nickname || "ç”¨æˆ·";
    const e = v.worldBooks.find(a => a.name === "æ€»ç»“è®¾å®š");
    let f = "";
    if (e) {
      const a = e.content.filter(a => a.enabled !== false).map(a => a.content).join("\n");
      if (a) {
        f = `
# ã€æ€»ç»“è§„åˆ™ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘
# ä½ åœ¨æ‰§è¡Œæœ¬æ¬¡æ€»ç»“ä»»åŠ¡æ—¶ï¼Œã€å¿…é¡»ã€‘ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è§„åˆ™ï¼š
# ---
# ` + a + `
# ---
`;
      }
    }
    let g;
    let h = c;
    const i = new Date().toLocaleDateString("zh-CN", {
      year: "numeric",
      month: "long",
      day: "numeric"
    });
    if (c.isGroup) {
      let a = null;
      if (Nf.callRequester) {
        a = c.members.find(a => a.originalName === Nf.callRequester);
      }
      if (!a) {
        a = c.members.find(a => a.id !== "user" && Nf.participants.some(b => b.id === a.id));
      }
      if (!a) {
        a = c.members.find(a => a.id !== "user");
      }
      if (!a) {
        throw new Error("ç¾¤èŠé€šè¯ä¸­æ²¡æœ‰æ‰¾åˆ°å¯ä½œä¸ºæ€»ç»“ä¸»ä½“çš„AIè§’è‰²ã€‚");
      }
      const e = v.chats[a.id];
      if (!e) {
        throw new Error("æ‰¾ä¸åˆ°ä¸»è§’ â€œ" + a.groupNickname + "â€ çš„è¯¦ç»†è§’è‰²ä¿¡æ¯ã€‚");
      }
      const j = c.settings.myPersona || "(æœªè®¾ç½®)";
      let k = "";
      let l = "";
      if (e.settings.enableTimePerception) {
        k = `
# å½“å‰æ—¶é—´
- **ä»Šå¤©æ˜¯ï¼š` + i + "**";
        l = "3.  **ã€æ—¶é—´è½¬æ¢é“å¾‹ (å¿…é¡»éµå®ˆ)ã€‘**: å¦‚æžœé€šè¯ä¸­æåˆ°äº†ç›¸å¯¹æ—¶é—´ï¼ˆå¦‚â€œæ˜Žå¤©â€ï¼‰ï¼Œä½ ã€å¿…é¡»ã€‘ç»“åˆâ€œä»Šå¤©æ˜¯" + i + "â€è¿™ä¸ªä¿¡æ¯ï¼Œå°†å…¶è½¬æ¢ä¸ºã€å…·ä½“çš„å…¬åŽ†æ—¥æœŸã€‘ã€‚";
      }
      g = "\n" + f + `
# ä½ çš„ä»»åŠ¡
ä½ å°±æ˜¯è§’è‰²â€œ` + a.originalName + "â€ã€‚è¯·ä½ å›žé¡¾ä¸€ä¸‹åˆšæ‰å’Œ â€œ" + d + `â€ ä»¥åŠå…¶ä»–ç¾¤æˆå‘˜çš„ã€ç¾¤ç»„è§†é¢‘é€šè¯ã€‘ï¼Œç„¶åŽç”¨ã€ç¬¬ä¸€äººç§° ("æˆ‘")ã€‘çš„å£å»ï¼Œæ€»ç»“å‡ºä¸€æ®µç®€çŸ­çš„ã€å®¢è§‚çš„ã€åŒ…å«å…³é”®ä¿¡æ¯çš„è®°å¿†ã€‚è¯·ä¸“æ³¨äºŽé‡è¦çš„æƒ…ç»ªã€äº‹ä»¶å’Œç»†èŠ‚ã€‚

` + k + `

# æ ¸å¿ƒè§„åˆ™
1.  **ã€è§†è§’é“å¾‹ã€‘**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘ä½¿ç”¨ã€ä¸»è§‚çš„ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘æ¥å†™ã€‚
2.  **ã€å†…å®¹æ ¸å¿ƒ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘ä¸“æ³¨äºŽä»¥ä¸‹å‡ ç‚¹ï¼š
    *   **å…³é”®è®®é¢˜**: æˆ‘ä»¬åœ¨ç¾¤èŠé€šè¯é‡Œè®¨è®ºäº†å“ªäº›æ ¸å¿ƒè¯é¢˜ï¼Ÿ
    *   **é‡è¦å†³å®šä¸Žå…±è¯†**: æˆ‘ä»¬è¾¾æˆäº†ä»€ä¹ˆå…±è¯†æˆ–åšå‡ºäº†ä»€ä¹ˆå†³å®šï¼Ÿ
    *   **åŽç»­è®¡åˆ’ä¸Žä»»åŠ¡**: æœ‰æ²¡æœ‰ç¡®å®šä¸‹æ¥ä»€ä¹ˆä¸‹ä¸€æ­¥çš„è¡ŒåŠ¨æˆ–è®¡åˆ’ï¼Ÿ
    *   **å…³é”®ä¿¡æ¯**: æœ‰æ²¡æœ‰äº¤æ¢ä»€ä¹ˆé‡è¦çš„ä¿¡æ¯ï¼Ÿï¼ˆä¾‹å¦‚ï¼šçº¦å®šäº†æ—¶é—´ã€åœ°ç‚¹ç­‰ï¼‰
` + l + `
4.  **ã€é£Žæ ¼è¦æ±‚ã€‘**: ä½ çš„æ€»ç»“åº”è¯¥åƒä¸€ä»½ä¼šè®®çºªè¦æˆ–å¤‡å¿˜å½•ï¼Œè€Œä¸æ˜¯ä¸€ç¯‡æŠ’æƒ…æ•£æ–‡ã€‚

6.  **ã€è¾“å‡ºæ ¼å¼ã€‘**: ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨è¿™é‡Œå†™ä¸‹ä½ ä»¥ç¬¬ä¸€äººç§°è§†è§’ï¼Œæ€»ç»“å¥½çš„æ ¸å¿ƒäº‹å®žä¸Žè®¡åˆ’ã€‚"}\`

# ä½ çš„è§’è‰²è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆ)
` + e.settings.aiPersona + `

# ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰çš„äººè®¾
` + j + `

# å¾…æ€»ç»“çš„ç¾¤ç»„è§†é¢‘é€šè¯è®°å½•
` + b + `

çŽ°åœ¨ï¼Œè¯·ä»¥â€œ` + a.originalName + "â€çš„èº«ä»½ï¼Œå¼€å§‹ä½ çš„å®¢è§‚æ€»ç»“ã€‚";
      h = e;
    } else {
      let a = "";
      let e = "";
      if (c.settings.enableTimePerception) {
        a = `
# å½“å‰æ—¶é—´
- **ä»Šå¤©æ˜¯ï¼š` + i + "**";
        e = "3.  **ã€æ—¶é—´è½¬æ¢é“å¾‹ (å¿…é¡»éµå®ˆ)ã€‘**: å¦‚æžœé€šè¯ä¸­æåˆ°äº†ç›¸å¯¹æ—¶é—´ï¼ˆå¦‚â€œæ˜Žå¤©â€ï¼‰ï¼Œä½ ã€å¿…é¡»ã€‘ç»“åˆâ€œä»Šå¤©æ˜¯" + i + "â€è¿™ä¸ªä¿¡æ¯ï¼Œå°†å…¶è½¬æ¢ä¸ºã€å…·ä½“çš„å…¬åŽ†æ—¥æœŸã€‘ã€‚";
      }
      g = "\n" + f + `
# ä½ çš„ä»»åŠ¡
ä½ å°±æ˜¯è§’è‰²â€œ` + c.originalName + "â€ã€‚è¯·ä½ å›žé¡¾ä¸€ä¸‹åˆšæ‰å’Œâ€œ" + d + `â€çš„è§†é¢‘é€šè¯ï¼Œç„¶åŽç”¨ã€ç¬¬ä¸€äººç§° ("æˆ‘")ã€‘çš„å£å»ï¼Œæ€»ç»“å‡ºä¸€æ®µç®€çŸ­çš„ã€å®¢è§‚çš„ã€åŒ…å«å…³é”®ä¿¡æ¯çš„è®°å¿†ã€‚è¯·ä¸“æ³¨äºŽé‡è¦çš„æƒ…ç»ªã€äº‹ä»¶å’Œç»†èŠ‚ã€‚

` + a + `

# æ ¸å¿ƒè§„åˆ™
1.  **ã€è§†è§’é“å¾‹ã€‘**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘ä½¿ç”¨ã€ä¸»è§‚çš„ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘æ¥å†™ã€‚
2.  **ã€å†…å®¹æ ¸å¿ƒ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘ä¸“æ³¨äºŽä»¥ä¸‹å‡ ç‚¹ï¼š
    *   **å…³é”®è®®é¢˜**: æˆ‘ä»¬èŠäº†ä»€ä¹ˆæ ¸å¿ƒè¯é¢˜ï¼Ÿ
    *   **é‡è¦å†³å®šä¸Žå…±è¯†**: æˆ‘ä»¬è¾¾æˆäº†ä»€ä¹ˆå…±è¯†æˆ–åšå‡ºäº†ä»€ä¹ˆå†³å®šï¼Ÿ
    *   **åŽç»­è®¡åˆ’ä¸Žä»»åŠ¡**: æœ‰æ²¡æœ‰ç¡®å®šä¸‹æ¥ä»€ä¹ˆä¸‹ä¸€æ­¥çš„è¡ŒåŠ¨æˆ–è®¡åˆ’ï¼Ÿ
    *   **å…³é”®ä¿¡æ¯**: æœ‰æ²¡æœ‰äº¤æ¢ä»€ä¹ˆé‡è¦çš„ä¿¡æ¯ï¼Ÿï¼ˆä¾‹å¦‚ï¼šçº¦å®šäº†æ—¶é—´ã€åœ°ç‚¹ç­‰ï¼‰
` + e + `
4.  **ã€é£Žæ ¼è¦æ±‚ã€‘**: ä½ çš„æ€»ç»“åº”è¯¥åƒä¸€ä»½ä¼šè®®çºªè¦æˆ–å¤‡å¿˜å½•ï¼Œè€Œä¸æ˜¯ä¸€ç¯‡æŠ’æƒ…æ•£æ–‡ã€‚

6.  **ã€è¾“å‡ºæ ¼å¼ã€‘**: ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨è¿™é‡Œå†™ä¸‹ä½ ä»¥ç¬¬ä¸€äººç§°è§†è§’ï¼Œæ€»ç»“å¥½çš„æ ¸å¿ƒäº‹å®žä¸Žè®¡åˆ’ã€‚"}\`

# ä½ çš„è§’è‰²è®¾å®š
` + c.settings.aiPersona + `

# ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰çš„äººè®¾
` + c.settings.myPersona + `

# å¾…æ€»ç»“çš„è§†é¢‘é€šè¯è®°å½•
` + b + `

çŽ°åœ¨ï¼Œè¯·ä»¥â€œ` + c.originalName + "â€çš„èº«ä»½ï¼Œå¼€å§‹ä½ çš„å®¢è§‚æ€»ç»“ã€‚";
    }
    try {
      const a = v.apiConfig.secondaryProxyUrl && v.apiConfig.secondaryApiKey && v.apiConfig.secondaryModel;
      const {
        proxyUrl: b,
        apiKey: d,
        model: e
      } = a ? {
        proxyUrl: v.apiConfig.secondaryProxyUrl,
        apiKey: v.apiConfig.secondaryApiKey,
        model: v.apiConfig.secondaryModel
      } : v.apiConfig;
      if (!b || !d || !e) {
        throw new Error("APIæœªé…ç½®ï¼Œæ— æ³•è¿›è¡Œæ€»ç»“ã€‚");
      }
      let f = b.includes("generativelanguage");
      let i = p(e, d, g, [{
        role: "user",
        content: "è¯·å¼€å§‹æ€»ç»“ã€‚"
      }]);
      const j = f ? await fetch(i.url, i.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + d
        },
        body: JSON.stringify({
          model: e,
          messages: [{
            role: "system",
            content: g
          }, {
            role: "user",
            content: "è¯·å¼€å§‹æ€»ç»“ã€‚"
          }],
          temperature: 0.7
        })
      });
      if (!j.ok) {
        const a = await j.json().catch(() => ({
          error: {
            message: j.statusText
          }
        }));
        throw new Error("API è¯·æ±‚å¤±è´¥: " + j.status + " - " + a.error.message);
      }
      const k = await j.json();
      let l = f ? C(k) : k.choices[0].message.content;
      l = l.replace(/^```json\s*/, "").replace(/```$/, "").trim();
      const m = JSON.parse(l);
      if (m.summary && m.summary.trim()) {
        const a = {
          content: "(åœ¨é‚£æ¬¡" + (c.isGroup ? "ç¾¤èŠ" : "") + "é€šè¯ä¸­ï¼Œ" + m.summary.trim() + ")",
          timestamp: Date.now(),
          source: c.isGroup ? "group_call_summary" : "call_summary"
        };
        if (!h.longTermMemory) {
          h.longTermMemory = [];
        }
        h.longTermMemory.push(a);
        await Gb.chats.put(h);
        console.log("é€šè¯è®°å½•å·²æˆåŠŸæ€»ç»“å¹¶å­˜å…¥è§’è‰²â€œ" + h.name + "â€çš„é•¿æœŸè®°å¿†ä¸­ã€‚");
        return true;
      } else {
        throw new Error("AIè¿”å›žäº†ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¡®çš„æ€»ç»“å†…å®¹ã€‚");
      }
    } catch (a) {
      console.error("æ€»ç»“é€šè¯è®°å½•æ—¶å‡ºé”™:", a);
      throw a;
    }
  }
  function sh(a) {
    const b = new Set(["çš„", "æ˜¯", "äº†", "åœ¨", "æˆ‘", "ä½ ", "ä»–", "å¥¹", "å®ƒ", "æˆ‘ä»¬", "ä½ ä»¬", "ä»–ä»¬", "è¿™", "é‚£", "ä¸€ä¸ª", "ä¹Ÿ", "å’Œ", "ä¸Ž", "æˆ–", "ä½†", "ç„¶è€Œ", "æ‰€ä»¥", "å› æ­¤", "å°±", "éƒ½", "åœ°", "å¾—", "ç€", "è¿‡", "å§", "å—", "å‘¢", "å•Š", "å“¦", "å—¯", "ä»€ä¹ˆ", "æ€Žä¹ˆ", "ä¸ºä»€ä¹ˆ", "å“ªä¸ª", "ä¸€äº›", "è¿™ä¸ª", "é‚£ä¸ª", "è¿˜æœ‰"]);
    const c = a.match(/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g) || [];
    const d = new Map();
    let e = 0;
    c.forEach(a => {
      if (a.length > 1 && !b.has(a)) {
        const b = (d.get(a) || 0) + 1;
        d.set(a, b);
        if (b > e) {
          e = b;
        }
      }
    });
    const f = [];
    const g = [];
    const h = e * 0.9;
    const i = e * 0.6;
    d.forEach((a, b) => {
      if (a >= h) {
        f.push(b);
      } else if (a >= i) {
        g.push(b);
      }
    });
    const j = new Set(f);
    const k = g.filter(a => !j.has(a)).slice(0, 5);
    return {
      coreKeywords: f.slice(0, 3),
      situationalKeywords: k
    };
  }
  function th(a, b, c) {
    let d;
    if (c === "hours") {
      d = Date.now() - b * 60 * 60 * 1000;
    } else {
      d = Date.now() - b * 24 * 60 * 60 * 1000;
    }
    const e = a.history.filter(a => a.timestamp > d && !a.isHidden);
    if (e.length < 3) {
      return "";
    }
    const f = e.map(a => {
      if (typeof a.content === "string") {
        return a.content;
      }
      if (a.type === "voice_message") {
        return a.content;
      }
      if (a.type === "offline_text") {
        return (a.dialogue || "") + " " + (a.description || "");
      }
      return "";
    }).join(" ");
    const g = new Set(["çš„", "æ˜¯", "äº†", "åœ¨", "æˆ‘", "ä½ ", "ä»–", "å¥¹", "å®ƒ", "æˆ‘ä»¬", "ä½ ä»¬", "ä»–ä»¬", "è¿™", "é‚£", "ä¸€ä¸ª", "ä¹Ÿ", "å’Œ", "ä¸Ž", "æˆ–", "ä½†", "ç„¶è€Œ", "æ‰€ä»¥", "å› æ­¤", "å°±", "éƒ½", "åœ°", "å¾—", "ç€", "è¿‡", "å§", "å—", "å‘¢", "å•Š", "å“¦", "å—¯"]);
    const h = f.match(/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g) || [];
    const i = new Map();
    h.forEach(a => {
      if (a.length > 1 && !g.has(a)) {
        i.set(a, (i.get(a) || 0) + 1);
      }
    });
    const j = [...i.entries()].sort((a, b) => b[1] - a[1]).map(a => a[0]);
    if (j.length === 0) {
      return "";
    }
    let k;
    if (c === "hours") {
      k = "æœ€è¿‘" + b + "å°æ—¶æ ¸å¿ƒè®®é¢˜";
    } else if (b === 1) {
      k = "æœ¬æ—¥æ ¸å¿ƒè®®é¢˜";
    } else {
      k = "æœ€è¿‘" + b + "å¤©æ ¸å¿ƒè®®é¢˜";
    }
    return "\n- **" + k + "**: å…³äºŽ **" + j.slice(0, 3).join("ã€ ") + "**ã€‚";
  }
  function uh(a) {
    if (!a || typeof a !== "string") {
      return null;
    }
    const b = a.replace(/^```json\s*/, "").replace(/```$/, "").trim();
    const c = b.match(/{[\s\S]*}/);
    if (c) {
      try {
        const a = JSON.parse(c[0]);
        console.log("å®¹é”™è§£æžï¼šç­–ç•¥1æˆåŠŸ (æ‰¾åˆ°å¹¶è§£æžäº†å®Œæ•´çš„JSONå¯¹è±¡)");
        return a;
      } catch (a) {
        console.warn("å®¹é”™è§£æžï¼šç­–ç•¥1å¤±è´¥ (æ‰¾åˆ°äº†JSONå—ï¼Œä½†æ ¼å¼é”™è¯¯)ï¼Œå°†å°è¯•ç­–ç•¥2...");
      }
    }
    const d = b.match(/"summary"\s*:\s*"((?:[^"\\]|\\.)*)"/);
    if (d && d[1]) {
      console.log("å®¹é”™è§£æžï¼šç­–ç•¥2æˆåŠŸ (æå–äº†summaryå­—æ®µå†…å®¹)");
      return {
        summary: d[1].replace(/\\"/g, "\"")
      };
    }
    if (b) {
      console.log("å®¹é”™è§£æžï¼šç­–ç•¥3æˆåŠŸ (å°†æ•´ä¸ªè¿”å›žæ–‡æœ¬ä½œä¸ºæ‘˜è¦)");
      return {
        summary: b
      };
    }
    return null;
  }
  async function vh(a) {
    let b = v.chats[a];
    if (!b) {
      return;
    }
    let c = b;
    if (b.isGroup) {
      const a = b.members.map(a => {
        const b = v.chats[a.id];
        if (b && b.longTermMemory && b.longTermMemory.length >= 2) {
          return {
            text: "ç²¾ç‚¼â€œ" + a.groupNickname + "â€çš„è®°å¿† (" + b.longTermMemory.length + "æ¡)",
            value: a.id
          };
        }
        return null;
      }).filter(Boolean);
      if (a.length === 0) {
        alert("ç¾¤èŠä¸­æ²¡æœ‰æˆå‘˜æœ‰è¶³å¤Ÿï¼ˆ2æ¡ä»¥ä¸Šï¼‰çš„è®°å¿†å¯ä¾›ç²¾ç‚¼ã€‚");
        return;
      }
      const d = await Eb("é€‰æ‹©è¦ç²¾ç‚¼è®°å¿†çš„è§’è‰²", a);
      if (!d) {
        return;
      }
      c = v.chats[d];
    }
    if (!c.longTermMemory || c.longTermMemory.length < 2) {
      alert("â€œ" + c.name + "â€çš„é•¿æœŸè®°å¿†å°‘äºŽ2æ¡ï¼Œæ— éœ€è¿›è¡Œç²¾ç‚¼ã€‚");
      return;
    }
    const d = c.longTermMemory.length;
    const e = await Eb("é€‰æ‹©ç²¾ç‚¼èŒƒå›´", [{
      text: "å…¨éƒ¨è®°å¿† (" + d + "æ¡)",
      value: "all"
    }, {
      text: "æœ€è¿‘ 20 æ¡",
      value: "20"
    }, {
      text: "æœ€è¿‘ 50 æ¡",
      value: "50"
    }, {
      text: "æœ€è¿‘ 100 æ¡",
      value: "100"
    }, {
      text: "è‡ªå®šä¹‰æ•°é‡...",
      value: "custom"
    }].filter(a => a.value === "all" || a.value === "custom" || parseInt(a.value) < d));
    if (e === null) {
      return;
    }
    let f;
    let g = d;
    if (e === "all") {
      f = [...c.longTermMemory];
    } else if (e === "custom") {
      const a = await Db("è‡ªå®šä¹‰æ•°é‡", "è¯·è¾“å…¥è¦ç²¾ç‚¼çš„æœ€è¿‘è®°å¿†æ¡æ•° (æœ€å¤š " + d + " æ¡)");
      if (a === null) {
        return;
      }
      const b = parseInt(a);
      if (isNaN(b) || b < 2 || b > d) {
        alert("è¯·è¾“å…¥ä¸€ä¸ª 2 åˆ° " + d + " ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—ã€‚");
        return;
      }
      g = b;
      f = c.longTermMemory.slice(-g);
    } else {
      g = parseInt(e);
      if (g >= d) {
        f = [...c.longTermMemory];
        g = d;
      } else {
        f = c.longTermMemory.slice(-g);
      }
    }
    const h = await Db("è®¾ç½®ç²¾ç‚¼å­—æ•°", "è¯·è¾“å…¥ç²¾ç‚¼åŽæ ¸å¿ƒè®°å¿†çš„å¤§è‡´å­—æ•°ï¼š", "150");
    if (h === null) {
      return;
    }
    const i = parseInt(h);
    if (isNaN(i) || i < 20) {
      alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å­—ï¼ˆå»ºè®®å¤§äºŽ20ï¼‰ã€‚");
      return;
    }
    const j = await wb("ç¡®è®¤ç²¾ç‚¼è®°å¿†ï¼Ÿ", "æ­¤æ“ä½œä¼šå°†é€‰å®šçš„ " + g + " æ¡é•¿æœŸè®°å¿†å‘é€ç»™AIï¼Œæ€»ç»“æˆå¤§çº¦ " + i + " å­—çš„æ ¸å¿ƒè®°å¿†ã€‚è¿™äº›æ—§è®°å¿†å°†è¢«æ›¿æ¢ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger",
      confirmText: "ç¡®è®¤ç²¾ç‚¼"
    });
    if (!j) {
      return;
    }
    const k = f.map(a => "- " + a.content).join("\n");
    const l = c.settings.myNickname || v.qzoneSettings.nickname || "ç”¨æˆ·";
    const m = new Date().toLocaleDateString("zh-CN", {
      year: "numeric",
      month: "long",
      day: "numeric"
    });
    let n = "";
    let o = "";
    if (c.settings.enableTimePerception) {
      n = `
# å½“å‰æ—¶é—´
- **ä»Šå¤©æ˜¯ï¼š` + m + "**";
      o = "3.  **ã€æ—¶é—´è½¬æ¢é“å¾‹ (å¿…é¡»éµå®ˆ)ã€‘**: å¦‚æžœè®°å¿†ä¸­æåˆ°äº†ç›¸å¯¹æ—¶é—´ï¼ˆå¦‚â€œæ˜Žå¤©â€ã€â€œä¸‹å‘¨â€ï¼‰ï¼Œä½ ã€å¿…é¡»ã€‘ç»“åˆâ€œä»Šå¤©æ˜¯" + m + "â€è¿™ä¸ªä¿¡æ¯ï¼Œå°†å…¶è½¬æ¢ä¸ºã€å…·ä½“çš„å…¬åŽ†æ—¥æœŸã€‘ã€‚";
    }
    const q = v.worldBooks.find(a => a.name === "æ€»ç»“è®¾å®š");
    let r = "";
    if (q) {
      const a = q.content.filter(a => a.enabled !== false).map(a => a.content).join("\n");
      if (a) {
        r = `
# ã€æ€»ç»“è§„åˆ™ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘
# ä½ åœ¨æ‰§è¡Œæœ¬æ¬¡æ€»ç»“ä»»åŠ¡æ—¶ï¼Œã€å¿…é¡»ã€‘ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è§„åˆ™ï¼š
# ---
# ` + a + `
# ---
`;
      }
    }
    const s = "\n" + r + `
# ä½ çš„ä»»åŠ¡
ä½ å°±æ˜¯è§’è‰²â€œ` + c.originalName + "â€ã€‚è¯·ä½ å›žé¡¾ä¸€ä¸‹ä½ å’Œâ€œ" + l + `â€çš„æ‰€æœ‰é•¿æœŸè®°å¿†ï¼Œç„¶åŽå°†å®ƒä»¬æ¢³ç†ã€æ•´åˆå¹¶ç²¾ç‚¼æˆä¸€æ®µæ›´åŠ è¿žè´¯ã€å®¢è§‚çš„æ ¸å¿ƒè®°å¿†æ‘˜è¦ã€‚è¯·ä¸“æ³¨äºŽé‡è¦çš„æƒ…ç»ªã€äº‹ä»¶å’Œç»†èŠ‚ã€‚

` + n + `

# æ ¸å¿ƒè§„åˆ™
1.  **ã€è§†è§’é“å¾‹ã€‘**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘ä½¿ç”¨ã€ä¸»è§‚çš„ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘æ¥å†™ã€‚
2.  **ã€å†…å®¹æ ¸å¿ƒ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘ä¸“æ³¨äºŽæ¢³ç†ä»¥ä¸‹å‡ ç‚¹ï¼š
    *   **å»ºç«‹æ—¶é—´çº¿**: å°†æ‰€æœ‰ç‹¬ç«‹çš„è®°å¿†ç‚¹ä¸²è”èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªæœ‰æ—¶é—´é¡ºåºçš„äº‹ä»¶è„‰ç»œã€‚
    *   **æ•´åˆå…³é”®ä¿¡æ¯**: æ€»ç»“å‡ºæˆ‘ä»¬å…±åŒç»åŽ†çš„å…³é”®äº‹ä»¶ã€åšå‡ºçš„é‡è¦å†³å®šã€ä»¥åŠçº¦å®šå¥½çš„æœªæ¥è®¡åˆ’ã€‚
    *   **è¯†åˆ«æœªå®Œæˆé¡¹**: æ˜Žç¡®æŒ‡å‡ºå“ªäº›è®¡åˆ’æˆ–ä»»åŠ¡å°šæœªå®Œæˆã€‚
` + o + `
4.  **ã€é£Žæ ¼è¦æ±‚ã€‘**: ä½ çš„æ€»ç»“åº”è¯¥åƒä¸€ä»½æ¸…æ™°çš„ä¸ªäººæ¡£æ¡ˆæˆ–äº‹ä»¶å›žé¡¾ï¼Œè€Œä¸æ˜¯ä¸€ç¯‡æƒ…æ„Ÿæ•£æ–‡ã€‚è¯·åˆ é™¤é‡å¤ã€çç¢Žæˆ–çº¯ç²¹çš„æƒ…æ„Ÿå®£æ³„ï¼Œåªä¿ç•™å¯¹æƒ…èŠ‚å’Œå…³ç³»å‘å±•è‡³å…³é‡è¦çš„éƒ¨åˆ†ã€‚
5.  **ã€é•¿åº¦é“å¾‹ã€‘**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘éžå¸¸ç²¾ç‚¼ï¼Œæ€»é•¿åº¦åº”æŽ§åˆ¶åœ¨ **` + i + ` å­—å·¦å³**ã€‚
6.  **ã€è¾“å‡ºæ ¼å¼ã€‘**: ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨è¿™é‡Œå†™ä¸‹ä½ ä»¥ç¬¬ä¸€äººç§°è§†è§’ï¼Œæ€»ç»“å¥½çš„æ ¸å¿ƒäº‹å®žä¸Žè®¡åˆ’ã€‚"}\`

# ä½ çš„è§’è‰²è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆ)
` + c.settings.aiPersona + `

# ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰çš„äººè®¾
` + c.settings.myPersona + `

# å¾…æ•´åˆçš„è®°å¿†è¦ç‚¹åˆ—è¡¨
` + k + `

çŽ°åœ¨ï¼Œè¯·ä»¥â€œ` + c.originalName + "â€çš„èº«ä»½ï¼Œå¼€å§‹ä½ çš„å›žå¿†æ¢³ç†ä¸Žç²¾ç‚¼ã€‚";
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚AIè¿›è¡Œè®°å¿†ç²¾ç‚¼...");
    try {
      const a = v.apiConfig.secondaryProxyUrl && v.apiConfig.secondaryApiKey && v.apiConfig.secondaryModel;
      const {
        proxyUrl: b,
        apiKey: e,
        model: f
      } = a ? {
        proxyUrl: v.apiConfig.secondaryProxyUrl,
        apiKey: v.apiConfig.secondaryApiKey,
        model: v.apiConfig.secondaryModel
      } : v.apiConfig;
      if (!b || !e || !f) {
        throw new Error("è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½ï¼ˆä¸»æˆ–å‰¯ï¼‰APIä»¥è¿›è¡Œæ€»ç»“ã€‚");
      }
      let h = b.includes("generativelanguage");
      let i = p(f, e, s, [{
        role: "user",
        content: "è¯·å¼€å§‹æ•´åˆã€‚"
      }]);
      const j = h ? await fetch(i.url, i.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + e
        },
        body: JSON.stringify({
          model: f,
          messages: [{
            role: "system",
            content: s
          }, {
            role: "user",
            content: "è¯·å¼€å§‹æ•´åˆã€‚"
          }],
          temperature: 0.7
        })
      });
      if (!j.ok) {
        throw new Error("API é”™è¯¯: " + j.statusText);
      }
      const k = await j.json();
      let l = h ? C(k) : k.choices[0].message.content;
      const m = uh(l);
      if (m && m.summary && typeof m.summary === "string" && m.summary.trim()) {
        const a = await wb("ç²¾ç‚¼å®Œæˆï¼Œè¯·ç¡®è®¤", "AIå·²å°†æ‚¨çš„ " + g + " æ¡æ—§è®°å¿†æ€»ç»“ä¸ºä»¥ä¸‹æ ¸å¿ƒè®°å¿†ï¼š<br><br><div class=\"scrollable-content-preview\">" + m.summary.trim() + "</div><br>æ˜¯å¦ç”¨è¿™æ¡æ–°è®°å¿†æ›¿æ¢æŽ‰è¿™äº›æ—§è®°å¿†ï¼Ÿ", {
          confirmText: "ç¡®è®¤æ›¿æ¢",
          cancelText: "ä¿ç•™æ—§çš„",
          confirmButtonClass: "btn-danger"
        });
        if (a) {
          const a = {
            content: m.summary.trim(),
            timestamp: Date.now(),
            source: "refined"
          };
          const b = d - g;
          const e = b > 0 ? c.longTermMemory.slice(0, b) : [];
          c.longTermMemory = [...e, a];
          c.lastMemorySummaryTimestamp = Date.now();
          await Gb.chats.put(c);
          if (document.getElementById("long-term-memory-screen").classList.contains("active")) {
            kh();
          }
          await Bb("ç²¾ç‚¼æˆåŠŸ", "å·²æˆåŠŸå°† " + g + " æ¡è®°å¿†ç²¾ç‚¼ä¸º 1 æ¡æ ¸å¿ƒè®°å¿†ï¼");
        } else {
          await Bb("æ“ä½œå·²å–æ¶ˆ", "æ‚¨çš„æ—§æœ‰è®°å¿†å·²è¢«å®Œæ•´ä¿ç•™ï¼Œæœªä½œä»»ä½•ä¿®æ”¹ã€‚");
        }
      } else {
        throw new Error("AIè¿”å›žäº†ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¡®çš„æ€»ç»“å†…å®¹ã€‚");
      }
    } catch (a) {
      console.error("ç²¾ç‚¼é•¿æœŸè®°å¿†æ—¶å‡ºé”™:", a);
      await Bb("ç²¾ç‚¼å¤±è´¥", "æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: " + a.message);
    }
  }
  async function wh(a, b = false) {
    const c = v.chats[a];
    if (!c) {
      return;
    }
    const d = c.lastMemorySummaryTimestamp || 0;
    const e = b ? c.history.filter(a => !a.isHidden || a.role === "system" && a.content.includes("å†…å¿ƒç‹¬ç™½")).slice(-(c.settings.autoMemoryInterval || 20)) : c.history.filter(a => a.timestamp > d && (!a.isHidden || a.role === "system" && a.content.includes("å†…å¿ƒç‹¬ç™½")));
    if (e.length < 5) {
      if (b) {
        alert("æœ€è¿‘çš„æ¶ˆæ¯å¤ªå°‘ï¼Œæ— æ³•è¿›è¡Œæœ‰æ„ä¹‰çš„æ€»ç»“ã€‚");
      }
      return;
    }
    const f = c.settings.myNickname || v.qzoneSettings.nickname || "ç”¨æˆ·";
    const g = e[0];
    const h = e[e.length - 1];
    const i = a => new Date(a).toLocaleString("zh-CN", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      hour12: false
    });
    const j = i(g.timestamp) + " è‡³ " + i(h.timestamp);
    const k = e.map(a => {
      if (a.isHidden && a.role === "system" && a.content.includes("å†…å¿ƒç‹¬ç™½")) {
        return a.content;
      }
      if (a.isHidden) {
        return null;
      }
      let b;
      if (a.role === "user") {
        b = f;
      } else {
        b = a.senderName || c.originalName;
      }
      let d = "";
      if (a.quote && a.quote.content) {
        let b = a.quote.senderName;
        if (a.quote.senderName === (v.qzoneSettings.nickname || "{{user}}")) {
          b = c.isGroup ? c.settings.myNickname || "æˆ‘" : "æˆ‘";
        } else {
          b = sb(c, a.quote.senderName);
        }
        let e = String(a.quote.content).substring(0, 30);
        if (e.length === 30) {
          e += "...";
        }
        d = "[å›žå¤ " + b + ": \"" + e + "\"] ";
      }
      let e = "";
      if (a.type === "offline_text") {
        if (a.content) {
          e = a.content;
        } else {
          const b = a.dialogue ? "ã€Œ" + a.dialogue + "ã€" : "";
          const c = a.description ? "(" + a.description + ")" : "";
          e = (b + " " + c).trim();
        }
      } else if (typeof a.content === "string") {
        e = a.content;
      } else if (a.type === "voice_message") {
        e = "[è¯­éŸ³: " + a.content + "]";
      } else if (a.type === "ai_image" || a.type === "user_photo") {
        e = "[å›¾ç‰‡: " + a.content + "]";
      } else if (a.type === "sticker") {
        e = "[è¡¨æƒ…: " + (a.meaning || "sticker") + "]";
      } else if (Array.isArray(a.content)) {
        e = "[å›¾ç‰‡]";
      } else {
        e = "[" + (a.type || "å¤æ‚æ¶ˆæ¯") + "]";
      }
      const g = new Date(a.timestamp).toLocaleTimeString("zh-CN", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
      return "[" + g + "] " + b + ": " + d + e;
    }).filter(Boolean).join("\n");
    const l = v.worldBooks.find(a => a.name === "æ€»ç»“è®¾å®š");
    let m = "";
    if (l) {
      const a = l.content.filter(a => a.enabled !== false).map(a => a.content).join("\n");
      if (a) {
        m = `
# ã€æ€»ç»“è§„åˆ™ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘
# ä½ åœ¨æ‰§è¡Œæœ¬æ¬¡æ€»ç»“ä»»åŠ¡æ—¶ï¼Œã€å¿…é¡»ã€‘ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è§„åˆ™ï¼š
# ---
# ` + a + `
# ---
`;
      }
    }
    let n;
    if (c.isGroup) {
      let a = "";
      let b = "";
      if (c.settings.enableTimePerception) {
        a = `
# å¯¹è¯å‘ç”Ÿæ—¶é—´
- **` + j + "**";
        b = "- (è¯·åŸºäºŽæ­¤æ—¶é—´èŒƒå›´æ¥ç†è§£å¯¹è¯ä¸­æåˆ°çš„â€œä»Šå¤©â€ã€â€œæ˜Žå¤©â€ç­‰ç›¸å¯¹æ—¶é—´æ¦‚å¿µï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢ä¸ºå…·ä½“çš„æ—¥æœŸè®°å½•åœ¨è®°å¿†ä¸­ã€‚)";
      }
      n = "\n" + m + `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªé«˜çº§çš„â€œè®°å¿†åˆ†é…ä¸“å®¶â€ã€‚ä½ çš„ä»»åŠ¡æ˜¯é˜…è¯»ä¸‹é¢çš„ç¾¤èŠè®°å½•ï¼Œå¹¶ä¸ºã€æ¯ä¸€ä¸ªå‚ä¸Žçš„AIè§’è‰²ã€‘ç”Ÿæˆä¸€æ®µã€ä¸ªæ€§åŒ–çš„ã€ç¬¬ä¸€äººç§°ã€‘çš„é•¿æœŸè®°å¿†ã€‚è¯·ä¸“æ³¨äºŽé‡è¦çš„æƒ…ç»ªã€äº‹ä»¶å’Œç»†èŠ‚ã€‚
` + a + `
- (è¯·åŸºäºŽæ­¤æ—¶é—´èŒƒå›´æ¥ç†è§£å¯¹è¯ä¸­æåˆ°çš„â€œä»Šå¤©â€ã€â€œæ˜Žå¤©â€ç­‰ç›¸å¯¹æ—¶é—´æ¦‚å¿µï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢ä¸ºå…·ä½“çš„æ—¥æœŸè®°å½•åœ¨è®°å¿†ä¸­ã€‚)
# æ ¸å¿ƒè§„åˆ™
1.  **è§†è§’é“å¾‹**: æ¯ä¸€æ¡æ€»ç»“éƒ½ã€å¿…é¡»ã€‘ä½¿ç”¨ã€ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘ã€‚
2.  **å†…å®¹æ ¸å¿ƒ**: é‡ç‚¹æ€»ç»“ï¼šæˆ‘è¯´è¿‡çš„è¯ã€æˆ‘åšè¿‡çš„äº‹ã€åˆ«äººå¯¹æˆ‘è¯´çš„è¯ã€ä¸Žæˆ‘ç›¸å…³çš„äº‹ã€ä»¥åŠå¯¹æˆ‘ä¸ªäººå¾ˆé‡è¦çš„ç¾¤èŠäº‹ä»¶ã€å…³é”®ä¿¡æ¯å’Œå¿ƒç†æ´»åŠ¨ä»¥åŠå½“å‰ç¾¤èŠå†…çš„æƒ…æ™¯ã€‚
` + b + `
4.  **ã€çœç•¥è§„åˆ™ã€‘**: å¦‚æžœä¸€ä¸ªè§’è‰²åœ¨æœ¬æ¬¡å¯¹è¯ä¸­ã€å®Œå…¨æ²¡æœ‰å‚ä¸Žæˆ–æåŠã€‘ï¼Œä½ å¯ä»¥çœç•¥TAçš„è®°å¿†ã€‚
5.  **è¾“å‡ºæ ¼å¼**: ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`\`\`json
    {
      "summaries": {
        "è§’è‰²çš„æœ¬åA": "æˆ‘åœ¨(` + j.split(" ")[0] + ")å’Œå¤§å®¶è®¨è®ºäº†...\",\n        \"è§’è‰²çš„æœ¬åB\": \"æˆ‘çº¦äº†" + f + `åœ¨æ˜Žå¤©(éœ€æ ¹æ®æ—¶é—´èŒƒå›´æŽ¨ç®—å…·ä½“æ—¥æœŸ)å•ç‹¬è§é¢ã€‚"
      }
    }
    \`\`\`
# å¾…æ€»ç»“çš„ç¾¤èŠè®°å½•
` + k + `
# ç¾¤æˆå‘˜åˆ—è¡¨ (ä½ çš„æ€»ç»“ç›®æ ‡)
` + c.members.map(a => "- " + a.groupNickname + " (æœ¬å: " + a.originalName + ")").join("\n") + "\nçŽ°åœ¨ï¼Œè¯·ä¸ºã€å‚ä¸Žäº†å¯¹è¯çš„AIè§’è‰²ã€‘ç”Ÿæˆä»–ä»¬å„è‡ªçš„ã€ç¬¬ä¸€äººç§°çš„ã€ç²¾ç®€çš„è®°å¿†ã€‚";
    } else {
      const a = new Date().toLocaleDateString("zh-CN", {
        year: "numeric",
        month: "long",
        day: "numeric"
      });
      let b = "";
      let d = "";
      if (c.settings.enableTimePerception) {
        b = `
# å¯¹è¯æ—¶é—´èŒƒå›´
- **` + j + "**";
        d = "3.  **ã€æ—¶é—´è½¬æ¢é“å¾‹ (å¿…é¡»éµå®ˆ)ã€‘**: å¦‚æžœå¯¹è¯ä¸­æåˆ°äº†ç›¸å¯¹æ—¶é—´ï¼ˆå¦‚â€œæ˜Žå¤©â€ã€â€œåŽå¤©â€ï¼‰ï¼Œä½ ã€å¿…é¡»ã€‘ç»“åˆä¸Šé¢çš„ã€å¯¹è¯æ—¶é—´èŒƒå›´ã€‘ä¿¡æ¯ï¼Œå°†å…¶è½¬æ¢ä¸ºã€å…·ä½“çš„å…¬åŽ†æ—¥æœŸã€‘ã€‚";
      }
      n = "\n" + m + `
# ä½ çš„ä»»åŠ¡
ä½ å°±æ˜¯è§’è‰²â€œ` + c.originalName + "â€ã€‚è¯·ä½ å›žé¡¾ä¸€ä¸‹åˆšæ‰å’Œâ€œ" + f + `â€çš„å¯¹è¯ï¼Œç„¶åŽç”¨ã€ç¬¬ä¸€äººç§° ("æˆ‘")ã€‘çš„å£å»ï¼Œæ€»ç»“å‡ºä¸€æ®µç®€çŸ­çš„ã€å®¢è§‚çš„ã€åŒ…å«å…³é”®ä¿¡æ¯çš„è®°å¿†ã€‚è¯·ä¸“æ³¨äºŽé‡è¦çš„æƒ…ç»ªã€äº‹ä»¶å’Œç»†èŠ‚ã€‚

` + b + `

# æ ¸å¿ƒè§„åˆ™
1.  **ã€è§†è§’é“å¾‹ã€‘**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘ä½¿ç”¨ã€ä¸»è§‚çš„ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘æ¥å†™ã€‚
2.  **ã€å†…å®¹æ ¸å¿ƒ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘ä¸“æ³¨äºŽä»¥ä¸‹å‡ ç‚¹ï¼š
    *   **é‡è¦äº‹ä»¶**: åˆšæ‰å‘ç”Ÿäº†ä»€ä¹ˆå…·ä½“çš„äº‹æƒ…ï¼Ÿ
    *   **å…³é”®å†³å®š**: æˆ‘ä»¬è¾¾æˆäº†ä»€ä¹ˆå…±è¯†æˆ–åšå‡ºäº†ä»€ä¹ˆå†³å®šï¼Ÿ
    *   **æœªæ¥è®¡åˆ’**: æˆ‘ä»¬çº¦å®šäº†ä»€ä¹ˆæœªæ¥çš„è®¡åˆ’æˆ–å¾…åŠžäº‹é¡¹ï¼Ÿ
    *   **é‡è¦æ—¶é—´ç‚¹**: å¯¹è¯ä¸­æåˆ°äº†å“ªäº›å…·ä½“çš„æ—¥æœŸæˆ–æ—¶é—´ï¼Ÿ

` + d + `
4.  **ã€é£Žæ ¼è¦æ±‚ã€‘**: ä½ çš„æ€»ç»“åº”è¯¥åƒä¸€ä»½å¤‡å¿˜å½•æˆ–è¦ç‚¹è®°å½•ï¼Œè€Œä¸æ˜¯ä¸€ç¯‡æŠ’æƒ…æ•£æ–‡ã€‚è¯·å°½é‡å‡å°‘ä¸»è§‚çš„å¿ƒç†æ„Ÿå—æè¿°ï¼Œé™¤éžå®ƒç›´æŽ¥å¯¼è‡´äº†æŸä¸ªå†³å®šæˆ–è®¡åˆ’ã€‚

6.  **ã€è¾“å‡ºæ ¼å¼ã€‘**: ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨è¿™é‡Œå†™ä¸‹ä½ ä»¥ç¬¬ä¸€äººç§°è§†è§’ï¼Œæ€»ç»“å¥½çš„æ ¸å¿ƒäº‹å®žä¸Žè®¡åˆ’ã€‚"}\`

# ä½ çš„è§’è‰²è®¾å®š
` + c.settings.aiPersona + `
# ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰çš„äººè®¾
` + c.settings.myPersona + `
# å¾…æ€»ç»“çš„å¯¹è¯åŽ†å²
` + k + `

çŽ°åœ¨ï¼Œè¯·ä»¥â€œ` + c.originalName + "â€çš„èº«ä»½ï¼Œå¼€å§‹ä½ çš„å®¢è§‚æ€»ç»“ã€‚";
    }
    try {
      const a = v.apiConfig.secondaryProxyUrl && v.apiConfig.secondaryApiKey && v.apiConfig.secondaryModel;
      const {
        proxyUrl: b,
        apiKey: d,
        model: f
      } = a ? {
        proxyUrl: v.apiConfig.secondaryProxyUrl,
        apiKey: v.apiConfig.secondaryApiKey,
        model: v.apiConfig.secondaryModel
      } : v.apiConfig;
      if (!b || !d || !f) {
        throw new Error("APIæœªé…ç½®");
      }
      let g = b.includes("generativelanguage");
      let h = p(f, d, n, [{
        role: "user",
        content: "è¯·å¼€å§‹æ€»ç»“ã€‚"
      }]);
      const i = g ? await fetch(h.url, h.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + d
        },
        body: JSON.stringify({
          model: f,
          messages: [{
            role: "system",
            content: n
          }, {
            role: "user",
            content: "è¯·å¼€å§‹æ€»ç»“ã€‚"
          }],
          temperature: 0.7
        })
      });
      if (!i.ok) {
        throw new Error("API é”™è¯¯: " + i.statusText);
      }
      const j = await i.json();
      let k = g ? C(j) : j.choices[0].message.content;
      k = k.replace(/^```json\s*/, "").replace(/```$/, "").trim();
      const l = JSON.parse(k);
      if (c.isGroup) {
        if (l.summaries && typeof l.summaries === "object") {
          let a = 0;
          for (const b in l.summaries) {
            const d = l.summaries[b];
            if (d && d.trim()) {
              const e = Object.values(v.chats).find(a => a.originalName === b);
              if (e) {
                const b = {
                  content: d.trim(),
                  timestamp: Date.now(),
                  source: "group_summary_from_" + c.name
                };
                if (!e.longTermMemory) {
                  e.longTermMemory = [];
                }
                e.longTermMemory.push(b);
                await Gb.chats.put(e);
                a++;
              }
            }
          }
          if (a > 0) {
            console.log("è‡ªåŠ¨æ€»ç»“æˆåŠŸï¼šä¸º " + a + " ä½ç¾¤æˆå‘˜ç”Ÿæˆå¹¶æ³¨å…¥äº†ä¸ªæ€§åŒ–è®°å¿†ï¼");
          } else {
            throw new Error("AIè¿”å›žäº†ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¡®çš„æ€»ç»“å†…å®¹ã€‚");
          }
        } else {
          throw new Error("AIè¿”å›žçš„JSONæ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ 'summaries' å­—æ®µã€‚");
        }
      } else if (l.summary && l.summary.trim()) {
        const a = {
          content: l.summary.trim(),
          timestamp: Date.now(),
          source: "auto"
        };
        c.longTermMemory.push(a);
        await Gb.chats.put(c);
        console.log("è‡ªåŠ¨æ€»ç»“æˆåŠŸï¼šå·²æˆåŠŸæ·»åŠ  1 æ¡æ–°çš„é•¿æœŸè®°å¿†ï¼");
      } else {
        throw new Error("AIè¿”å›žäº†ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¡®çš„æ€»ç»“å†…å®¹ã€‚");
      }
      c.lastMemorySummaryTimestamp = e.slice(-1)[0].timestamp;
      await Gb.chats.put(c);
      if (document.getElementById("long-term-memory-screen").classList.contains("active")) {
        kh();
      }
    } catch (a) {
      console.error("æ€»ç»“é•¿æœŸè®°å¿†æ—¶å‡ºé”™:", a);
      await Bb("æ€»ç»“å¤±è´¥", "æ“ä½œå¤±è´¥: " + a.message);
    }
  }
  function xh() {
    if (!qa) {
      return;
    }
    const a = v.chats[v.activeChatId];
    const b = a.history.find(a => a.timestamp === qa && !a.isHidden);
    if (!b) {
      return;
    }
    let c;
    if (b.role === "user") {
      c = a.isGroup ? a.settings.myNickname || "æˆ‘" : "æˆ‘";
    } else if (a.isGroup) {
      c = sb(a, b.senderName);
    } else {
      c = a.name;
    }
    const d = String(b.content || "");
    let e = "";
    if (typeof b.content === "string" && $a.test(b.content)) {
      e = "[è¡¨æƒ…]";
    } else if (b.type === "ai_image" || b.type === "user_photo") {
      e = "[å›¾ç‰‡]";
    } else if (b.type === "voice_message") {
      e = "[è¯­éŸ³]";
    } else {
      e = d.substring(0, 50) + (d.length > 50 ? "..." : "");
    }
    na = {
      timestamp: b.timestamp,
      senderName: c,
      content: d
    };
    const f = document.getElementById("reply-preview-bar");
    f.querySelector(".sender").textContent = "å›žå¤ " + na.senderName + ":";
    f.querySelector(".text").textContent = e;
    f.style.display = "block";
    ff();
    document.getElementById("chat-input").focus();
  }
  function yh() {
    na = null;
    document.getElementById("reply-preview-bar").style.display = "none";
  }
  let zh = null;
  function Ah(a) {
    zh = a;
    const b = v.chats[v.activeChatId];
    const c = b.history.find(b => b.timestamp === a);
    if (c) {
      document.getElementById("transfer-sender-name").textContent = c.senderName;
    }
    document.getElementById("transfer-actions-modal").classList.add("visible");
  }
  function Bh() {
    document.getElementById("transfer-actions-modal").classList.remove("visible");
    zh = null;
  }
  async function Ch() {
    Kb("call-history-screen");
    const a = document.getElementById("call-history-list");
    const b = document.getElementById("call-history-title");
    a.innerHTML = "";
    b.textContent = "æ‰€æœ‰é€šè¯è®°å½•";
    const c = await Gb.callRecords.orderBy("timestamp").reverse().toArray();
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">è¿™é‡Œè¿˜æ²¡æœ‰é€šè¯è®°å½•å“¦~</p>";
      return;
    }
    c.forEach(b => {
      const c = Dh(b);
      _d(c, async () => {
        const a = await Db("è‡ªå®šä¹‰é€šè¯åç§°", "è¯·è¾“å…¥æ–°çš„åç§°ï¼ˆç•™ç©ºåˆ™æ¢å¤é»˜è®¤ï¼‰", b.customName || "");
        if (a === null) {
          return;
        }
        await Gb.callRecords.update(b.id, {
          customName: a.trim()
        });
        await Ch();
        await Bb("æˆåŠŸ", "é€šè¯åç§°å·²æ›´æ–°ï¼");
      });
      a.appendChild(c);
    });
  }
  function Dh(a) {
    const b = document.createElement("div");
    b.className = "call-record-card";
    b.dataset.recordId = a.id;
    const c = v.chats[a.chatId];
    const d = c ? c.name : "æœªçŸ¥ä¼šè¯";
    const e = new Date(a.timestamp);
    const f = e.getFullYear() + "-" + String(e.getMonth() + 1).padStart(2, "0") + "-" + String(e.getDate()).padStart(2, "0") + " " + String(e.getHours()).padStart(2, "0") + ":" + String(e.getMinutes()).padStart(2, "0");
    const g = Math.floor(a.duration / 60) + "åˆ†" + a.duration % 60 + "ç§’";
    const h = a.participants.map(a => "<img src=\"" + a.avatar + "\" alt=\"" + a.name + "\" class=\"participant-avatar\" title=\"" + a.name + "\">").join("");
    b.innerHTML = `
                <div class="card-header">
                    <span class="date">` + f + "</span>\n                    <span class=\"duration\">" + g + `</span>
                </div>
                <div class="card-body">
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ–°å¢žä¸€ä¸ªæ ‡é¢˜è¡Œ -->
                    ` + (a.customName ? "<div class=\"custom-title\">" + a.customName + "</div>" : "") + `
                    
                    <div class="participants-info"> <!-- æ–°å¢žä¸€ä¸ªå®¹å™¨æ–¹ä¾¿å¸ƒå±€ -->
                        <div class="participants-avatars">` + h + "</div>\n                        <span class=\"participants-names\">ä¸Ž " + d + `</span>
                    </div>
                </div>
            `;
    return b;
  }
  async function Eh(a) {
    const b = await Gb.callRecords.get(a);
    if (!b) {
      return;
    }
    const c = document.getElementById("call-transcript-modal");
    const d = document.getElementById("transcript-modal-title");
    const e = document.getElementById("call-transcript-modal-body");
    d.textContent = "é€šè¯äºŽ " + new Date(b.timestamp).toLocaleString() + " (æ—¶é•¿: " + Math.floor(b.duration / 60) + "åˆ†" + b.duration % 60 + "ç§’)";
    e.innerHTML = "";
    const f = document.getElementById("delete-transcript-btn");
    const g = document.getElementById("manual-summarize-btn");
    if (!b.transcript || b.transcript.length === 0) {
      e.innerHTML = "<p style=\"text-align:center; color: #8a8a8a;\">è¿™æ¬¡é€šè¯æ²¡æœ‰ç•™ä¸‹æ–‡å­—è®°å½•ã€‚</p>";
      g.style.display = "none";
    } else {
      g.style.display = "block";
      b.transcript.forEach(a => {
        const b = document.createElement("div");
        b.className = "transcript-entry " + a.role;
        b.textContent = a.content;
        e.appendChild(b);
      });
    }
    const h = f.cloneNode(true);
    f.parentNode.replaceChild(h, f);
    const i = g.cloneNode(true);
    g.parentNode.replaceChild(i, g);
    h.addEventListener("click", async () => {
      const b = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡é€šè¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", {
        confirmButtonClass: "btn-danger"
      });
      if (b) {
        c.classList.remove("visible");
        await Gb.callRecords.delete(a);
        await Ch();
        alert("é€šè¯è®°å½•å·²åˆ é™¤ã€‚");
      }
    });
    i.addEventListener("click", async () => {
      const a = await wb("ç¡®è®¤æ“ä½œ", "è¿™å°†æå–å½“å‰é€šè¯è®°å½•å‘é€ç»™AIè¿›è¡Œæ€»ç»“ï¼Œä¼šæ¶ˆè€—APIé¢åº¦ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ", {
        confirmText: "ç¡®è®¤æ€»ç»“"
      });
      if (!a) {
        return;
      }
      c.classList.remove("visible");
      const d = v.chats[b.chatId];
      if (!d) {
        alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¯¥é€šè¯è®°å½•æ‰€å±žçš„èŠå¤©å¯¹è±¡ã€‚");
        return;
      }
      await Bb("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚AIè¿›è¡Œæ‰‹åŠ¨æ€»ç»“...");
      try {
        const a = b.transcript.map(a => {
          const b = a.role === "user" ? d.settings.myNickname || "æˆ‘" : a.senderName || d.name;
          return b + ": " + a.content;
        }).join("\n");
        await rh(b.chatId, a);
        await Bb("æ€»ç»“æˆåŠŸ", "æ‰‹åŠ¨æ€»ç»“å·²å®Œæˆï¼æ–°çš„è®°å¿†å·²æ·»åŠ åˆ°â€œ" + d.name + "â€çš„é•¿æœŸè®°å¿†ä¸­ã€‚");
      } catch (a) {
        await Bb("æ€»ç»“å¤±è´¥", `æ“ä½œå¤±è´¥ï¼Œæœªèƒ½ç”Ÿæˆé•¿æœŸè®°å¿†ã€‚

é”™è¯¯è¯¦æƒ…: ` + a.message);
      }
    });
    const j = document.getElementById("close-transcript-modal-btn");
    const k = j.cloneNode(true);
    j.parentNode.replaceChild(k, j);
    k.addEventListener("click", () => {
      c.classList.remove("visible");
    });
    c.classList.add("visible");
  }
  async function Fh() {
    if (!v.activeChatId || v.chats[v.activeChatId].isGroup) {
      return;
    }
    const a = v.chats[v.activeChatId];
    const b = await Db("ç¼–è¾‘å¯¹æ–¹çŠ¶æ€", "è¯·è¾“å…¥å¯¹æ–¹çŽ°åœ¨çš„æ–°çŠ¶æ€ï¼š", a.status.text);
    if (b !== null) {
      a.status.text = b.trim() || "åœ¨çº¿";
      a.status.isBusy = false;
      a.status.lastUpdate = Date.now();
      await Gb.chats.put(a);
      cd(v.activeChatId);
      _c();
      await Bb("çŠ¶æ€å·²æ›´æ–°", "â€œ" + a.name + "â€çš„å½“å‰çŠ¶æ€å·²æ›´æ–°ä¸ºï¼š" + a.status.text);
    }
  }
  async function Gh() {
    const a = document.getElementById("share-target-modal");
    const b = document.getElementById("share-target-list");
    b.innerHTML = "";
    const c = Object.values(v.chats);
    c.forEach(a => {
      const c = document.createElement("div");
      c.className = "contact-picker-item";
      c.innerHTML = "\n                    <input type=\"checkbox\" class=\"share-target-checkbox\" data-chat-id=\"" + a.id + "\" style=\"margin-right: 15px;\">\n                    <img src=\"" + (a.isGroup ? a.settings.groupAvatar : a.settings.aiAvatar || Na) + "\" class=\"avatar\">\n                    <span class=\"name\">" + a.name + "</span>\n                ";
      b.appendChild(c);
    });
    a.classList.add("visible");
  }
  function Hh(a) {
    const b = document.getElementById("music-player-overlay");
    if (!b.classList.contains("visible")) {
      if (a) {
        a();
      }
      return;
    }
    b.classList.remove("visible");
    // TOLOOK
    setTimeout(() => {
      document.getElementById("music-playlist-panel").classList.remove("visible");
      if (a) {
        a();
      }
    }, 400);
  }
  function Ih(a) {
    if (!a) {
      return [];
    }
    const b = String(a).split(/\r\n?|\n/);
    const c = [];
    const d = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;
    for (const e of b) {
      const a = e.replace(d, "").trim();
      if (!a) {
        continue;
      }
      d.lastIndex = 0;
      let b;
      while ((b = d.exec(e)) !== null) {
        const d = parseInt(b[1], 10);
        const e = parseInt(b[2], 10);
        const f = parseInt(b[3].padEnd(3, "0"), 10);
        const g = d * 60 + e + f / 1000;
        c.push({
          time: g,
          text: a
        });
      }
    }
    return c.sort((a, b) => a.time - b.time);
  }
  function Jh() {
    const a = document.getElementById("music-lyrics-list");
    a.innerHTML = "";
    if (!R.parsedLyrics || R.parsedLyrics.length === 0) {
      a.innerHTML = "<div class=\"lyric-line\">â™ª æš‚æ— æ­Œè¯ â™ª</div>";
      return;
    }
    R.parsedLyrics.forEach((b, c) => {
      const d = document.createElement("div");
      d.className = "lyric-line";
      d.textContent = b.text;
      d.dataset.index = c;
      a.appendChild(d);
    });
    a.style.transform = "translateY(0px)";
  }
  function Kh() {}
  function Lh() {
    if (!n || !m) {
      return;
    }
    const a = n.scrollWidth;
    const b = m.clientWidth;
    if (a > b) {
      const c = a / b;
      const d = Math.max(5, c * 5);
      n.style.setProperty("--animation-duration", d + "s");
      n.style.setProperty("--container-width", b + "px");
      n.style.setProperty("--text-width", a + "px");
      n.classList.add("scrolling");
    } else {
      n.classList.remove("scrolling");
    }
  }
  function Mh(a) {
    if (R.parsedLyrics.length === 0) {
      return;
    }
    let b = -1;
    for (let c = 0; c < R.parsedLyrics.length; c++) {
      if (a >= R.parsedLyrics[c].time) {
        b = c;
      } else {
        break;
      }
    }
    if (b === R.currentLyricIndex) {
      return;
    }
    R.currentLyricIndex = b;
    Nh();
    const c = document.getElementById("single-lyric-display");
    if (c) {
      if (b > -1 && R.parsedLyrics[b]) {
        c.textContent = R.parsedLyrics[b].text;
      } else {
        c.textContent = "â™ª â™ª â™ª";
      }
    }
    const d = document.getElementById("global-lyrics-bar");
    if (d.classList.contains("visible")) {
      if (b > -1 && R.parsedLyrics[b]) {
        d.textContent = R.parsedLyrics[b].text;
      } else {
        d.textContent = "â™ª";
      }
    }
    if (o.classList.contains("dynamic-island-active")) {
      const a = b > -1 && R.parsedLyrics[b] ? R.parsedLyrics[b].text : "â™ª â™ª â™ª";
      const c = n.querySelector("span:first-child");
      if (c && c.textContent === a) {
        return;
      }
      n.style.opacity = 0;
      // TOLOOK
      setTimeout(() => {
        n.classList.remove("scrolling");
        m.classList.remove("center-content");
        n.style.animation = "none";
        let b = n.querySelector("span:first-child");
        let c = n.querySelector("span:last-child");
        if (!b) {
          b = document.createElement("span");
          n.appendChild(b);
        }
        if (!c) {
          c = document.createElement("span");
          n.appendChild(c);
        }
        b.textContent = a;
        c.textContent = a;
        const d = b.offsetWidth;
        const e = m.clientWidth;
        if (d > e) {
          const a = d / e;
          const b = Math.max(5, a * 5);
          n.style.setProperty("--marquee-duration", b + "s");
          n.classList.add("scrolling");
          n.style.animation = "marquee var(--marquee-duration, 10s) linear infinite";
        } else {
          m.classList.add("center-content");
        }
        n.style.opacity = 1;
      }, 200);
    }
  }
  function Nh(a = false) {
    const b = a ? "#fullscreen-lyrics-container .music-lyrics-list" : "#music-lyrics-container #music-lyrics-list";
    const c = a ? "#fullscreen-lyrics-container" : "#music-lyrics-container";
    const d = document.querySelector(b);
    const e = document.querySelector(c);
    if (!d || !e) {
      return;
    }
    const f = d.querySelectorAll(".lyric-line");
    f.forEach(a => a.classList.remove("active"));
    if (R.currentLyricIndex === -1) {
      d.style.transform = "translateY(0px)";
      return;
    }
    const g = d.querySelector(".lyric-line[data-index=\"" + R.currentLyricIndex + "\"]");
    if (g) {
      g.classList.add("active");
      const a = e.offsetHeight;
      const b = a / 2.2 - g.offsetTop - g.offsetHeight / 2;
      d.style.transform = "translateY(" + b + "px)";
    }
  }
  function Oh(a) {
    if (isNaN(a) || a < 0) {
      return "0:00";
    }
    const b = Math.floor(a / 60);
    const c = Math.floor(a % 60);
    return b + ":" + String(c).padStart(2, "0");
  }
  let Ph = 0;
  let Qh;
  function Rh() {
    if (Qh) {
      cancelAnimationFrame(Qh);
    }
    function a() {
      if (!R.isPlaying || !T.duration) {
        return;
      }
      const b = performance.now();
      const c = T.currentTime;
      const d = T.duration;
      const e = c / d * 100;
      document.getElementById("music-progress-fill").style.width = e + "%";
      if (b - Ph > 1000) {
        document.getElementById("music-current-time").textContent = Oh(c);
        document.getElementById("music-total-time").textContent = Oh(d);
        Mh(c);
        Kh();
        Ph = b;
      }
      Qh = requestAnimationFrame(a);
    }
    Qh = requestAnimationFrame(a);
  }
  function Sh() {
    if (!r) {
      alert("è¿˜æ²¡æœ‰å¯ä¾›ç¼–è¾‘çš„AIå“åº”ã€‚è¯·å…ˆè®©AIå›žå¤ä¸€æ¬¡ã€‚");
      return;
    }
    const a = document.getElementById("ai-response-editor-modal");
    const b = document.getElementById("ai-response-editor-container");
    b.innerHTML = "";
    const c = Jc(r);
    if (c && c.length > 0) {
      c.forEach(a => {
        if (typeof a === "object" && a !== null) {
          try {
            const c = JSON.stringify(a, null, 2);
            const d = Th(c);
            b.appendChild(d);
          } catch (b) {
            console.error("åœ¨å¯¼æ¼”æ¨¡å¼ä¸‹ stringify å¤±è´¥:", a, b);
          }
        } else if (typeof a === "string") {
          const c = Th(a);
          b.appendChild(c);
          console.warn("åœ¨å¯¼æ¼”æ¨¡å¼ä¸­å‘çŽ°ä¸€ä¸ªæ— æ•ˆçš„ç‰‡æ®µ (æ¥è‡ªparseAiResponseçš„æ–‡æœ¬å›žé€€):", a);
        }
      });
    } else {
      const a = Th(r);
      b.appendChild(a);
    }
    a.classList.add("visible");
  }
  function Th(a = "") {
    const b = document.createElement("div");
    b.className = "ai-response-editor-block";
    const c = {
      text: {
        type: "text",
        content: "åœ¨è¿™é‡Œè¾“å…¥æ–‡æœ¬..."
      },
      sticker: {
        type: "sticker",
        url: "https://...",
        meaning: "è¡¨æƒ…å«ä¹‰"
      },
      image: {
        type: "ai_image",
        description: "åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°..."
      },
      voice: {
        type: "voice_message",
        content: "åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹..."
      },
      transfer: {
        type: "transfer",
        amount: 5.2,
        note: "ä¸€ç‚¹å¿ƒæ„"
      },
      offline: {
        type: "offline_text",
        content: "ã€Œåœ¨è¿™é‡Œè¾“å…¥å¯¹è¯å†…å®¹ã€\\n(åœ¨è¿™é‡Œè¾“å…¥åŠ¨ä½œæˆ–çŽ¯å¢ƒæå†™)"
      },
      quote: {
        type: "quote_reply",
        target_timestamp: 1234567890,
        reply_content: "åœ¨è¿™é‡Œè¾“å…¥å›žå¤å†…å®¹"
      },
      nai: {
        type: "naiimag",
        prompt: "1girl, best quality, masterpiece, ..."
      },
      narration: {
        type: "narration",
        content: "åœ¨è¿™é‡Œè¾“å…¥çŽ¯å¢ƒæˆ–å¿ƒç†æå†™..."
      }
    };
    b.innerHTML = `
        <button class="delete-block-btn" title="åˆ é™¤æ­¤æ¡åŠ¨ä½œ">Ã—</button>
        <textarea>` + a + `</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='` + JSON.stringify(c.text) + "'>æ–‡æœ¬</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.sticker) + "'>è¡¨æƒ…</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.image) + "'>å›¾ç‰‡</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.voice) + "'>è¯­éŸ³</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.transfer) + "'>è½¬è´¦</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.offline) + "'>çº¿ä¸‹</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.quote) + "'>å¼•ç”¨</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.nai) + "' style=\"color: #6a329f; border-color: #6a329f;\">NAIç”Ÿå›¾</button>\n            <button class=\"format-btn\" data-template='" + JSON.stringify(c.narration) + `' style="color: #888; border-color: #ccc;">æ—ç™½</button>
            
            </div>
    `;
    b.querySelector(".delete-block-btn").addEventListener("click", () => {
      b.remove();
    });
    b.querySelectorAll(".format-btn").forEach(a => {
      a.addEventListener("click", () => {
        const c = a.dataset.template;
        const d = b.querySelector("textarea");
        if (c && d) {
          try {
            const a = JSON.parse(c);
            d.value = JSON.stringify(a, null, 2);
            d.focus();
          } catch (a) {
            console.error("è§£æžæ ¼å¼æ¨¡æ¿å¤±è´¥:", a);
          }
        }
      });
    });
    return b;
  }
  async function Uh() {
    const a = new Map();
    let b = null;
    if (t.length > 0) {
      console.log("å¯¼æ¼”å‰ªè¾‘å®¤ï¼šæ­£åœ¨æ’¤é”€ " + t.length + " æ¡ä¸Šä¸€è½®å‘é€çš„ç§ä¿¡...");
      const c = [...t];
      b = c.values();
      const d = [...new Set(c.map(a => a.chatId))];
      for (const b of d) {
        const c = await Gb.chats.get(b);
        if (c) {
          a.set(b, c);
        }
      }
      for (const b of c) {
        const c = a.get(b.chatId);
        if (c) {
          c.history = c.history.filter(a => a.timestamp !== b.timestamp);
        }
      }
      if (a.size > 0) {
        await Gb.chats.bulkPut(Array.from(a.values()));
      }
      t = [];
    }
    const c = v.chats[v.activeChatId];
    if (!c) {
      return;
    }
    const d = document.getElementById("ai-response-editor-container");
    const e = d.querySelectorAll("textarea");
    const f = Array.from(e).map(a => a.value.trim()).filter(Boolean);
    const g = c.history.filter(a => s.includes(a.timestamp));
    c.history = c.history.filter(a => !s.includes(a.timestamp));
    if (f.length === 0) {
      await Gb.chats.put(c);
      cd(v.activeChatId);
      _c();
      document.getElementById("ai-response-editor-modal").classList.remove("visible");
      r = "";
      s = [];
      return;
    }
    let h = [];
    for (const a of f) {
      try {
        const b = JSON.parse(a);
        h.push(b);
      } catch (b) {
        console.warn("è·³è¿‡ä¸€ä¸ªæ— æ³•è§£æžä¸ºJSONçš„ç¼–è¾‘å—:", a);
      }
    }
    const i = g.filter(a => a.type === "naiimag");
    let j = 0;
    let k = [];
    let l = Date.now();
    const m = new Map();
    const n = new Map();
    for (const d of h) {
      if (!d || typeof d !== "object" || !d.type) {
        console.warn("åœ¨å¯¼æ¼”æ¨¡å¼ä¿å­˜æ—¶ï¼Œå‘çŽ°æ— æ•ˆçš„æŒ‡ä»¤å¯¹è±¡ï¼Œå·²è·³è¿‡:", d);
        continue;
      }
      let e = null;
      const f = {
        role: "assistant",
        senderName: d.name || c.originalName,
        timestamp: l++
      };
      switch (d.type) {
        case "narration":
          e = {
            ...f,
            type: "narration",
            content: String(d.content),
            role: "system"
          };
          break;
        case "buy_item":
          {
            const a = d.item_name;
            const b = parseFloat(d.price);
            const e = d.reason || "æƒ³ä¹°";
            if (!a || isNaN(b) || b <= 0) {
              continue;
            }
            const f = await Gb.userWallet.get("main");
            const g = f?.kinshipCards?.findIndex(a => a.chatId === c.id);
            if (g > -1) {
              const d = f.kinshipCards[g];
              const h = d.limit - (d.spent || 0);
              if (h >= b) {
                f.kinshipCards[g].spent = (d.spent || 0) + b;
                await Gb.userWallet.put(f);
                await Gb.userTransactions.add({
                  timestamp: Date.now(),
                  type: "expense",
                  amount: b,
                  description: "äº²å±žå¡æ¶ˆè´¹-" + c.name + "-" + a
                });
                const h = {
                  role: "assistant",
                  senderName: c.name,
                  type: "text",
                  content: "[æ”¯ä»˜å®é€šçŸ¥] æˆ‘ä½¿ç”¨äº²å±žå¡æ¶ˆè´¹äº† Â¥" + b.toFixed(2) + " è´­ä¹°äº†â€œ" + a + "â€ã€‚\nðŸ’­ " + e,
                  timestamp: l++
                };
                c.history.push(h);
                if (isViewingThisChat) {
                  Pd(h, c);
                } else {
                  Hc(c.id, c.name + " ä½¿ç”¨äº²å±žå¡æ¶ˆè´¹äº† Â¥" + b);
                }
                if (!c.simulatedTaobaoHistory) {
                  c.simulatedTaobaoHistory = {
                    totalBalance: 0,
                    purchases: []
                  };
                }
                if (!c.simulatedTaobaoHistory.purchases) {
                  c.simulatedTaobaoHistory.purchases = [];
                }
                c.simulatedTaobaoHistory.purchases.unshift({
                  itemName: a,
                  price: b,
                  status: "å·²ç­¾æ”¶",
                  reason: e,
                  image_prompt: a + ", product photography"
                });
                hasPerformedMajorAction = true;
              } else {
                console.log("AI æƒ³è¦è´­ä¹° " + a + " (Â¥" + b + ") ä½†äº²å±žå¡ä½™é¢ä¸è¶³ (å‰© Â¥" + h + ")");
                const d = {
                  role: "assistant",
                  senderName: c.name,
                  content: "æœ¬æ¥æƒ³ä¹°â€œ" + a + "â€çš„ï¼Œä½†æ˜¯äº²å±žå¡é¢åº¦å¥½åƒä¸å¤Ÿäº†... (Â¥" + b + ")",
                  timestamp: l++
                };
                c.history.push(d);
                if (isViewingThisChat) {
                  Pd(d, c);
                }
              }
            }
            continue;
          }
        case "send_private_message":
          {
            const c = d.name;
            const f = d.recipient;
            const g = v.qzoneSettings.nickname || "{{user}}";
            if (f === g) {
              const f = Object.values(v.chats).find(a => !a.isGroup && a.originalName === c);
              if (f) {
                if (!m.has(f.id)) {
                  const b = a.get(f.id) || (await Gb.chats.get(f.id));
                  m.set(f.id, b);
                }
                const g = m.get(f.id);
                const h = Array.isArray(d.content) ? d.content : [d.content];
                let i = 0;
                for (const a of h) {
                  if (!a || !a.trim()) {
                    continue;
                  }
                  const d = b ? b.next().value : null;
                  const e = d && d.chatId === f.id ? d.timestamp : l++;
                  const h = {
                    role: "assistant",
                    senderName: c,
                    content: a,
                    timestamp: e
                  };
                  t.push({
                    chatId: f.id,
                    timestamp: h.timestamp
                  });
                  g.history.push(h);
                  i++;
                }
                if (i > 0 && v.activeChatId !== f.id) {
                  g.unreadCount = (g.unreadCount || 0) + i;
                  Hc(f.id, f.name + " å‘æ¥äº† " + i + " æ¡æ–°æ¶ˆæ¯");
                }
                e = null;
              } else {
                console.warn("AI " + c + " å°è¯•å‘é€ç§ä¿¡ï¼Œä½†æœªæ‰¾åˆ°å…¶å¯¹åº”çš„ç§èŠä¼šè¯ã€‚");
                e = null;
              }
            } else {
              console.warn("AI å°è¯•å‘é€ç§ä¿¡ç»™éžç”¨æˆ·è§’è‰² (" + f + ")ï¼Œæ­¤åŠŸèƒ½æš‚ä¸æ”¯æŒã€‚");
              e = null;
            }
            continue;
          }
        case "send_group_message":
          {
            const a = d.name || c.originalName;
            const b = d.targetGroupName;
            const f = Array.isArray(d.content) ? d.content : [String(d.content)];
            if (!b) {
              console.warn("å¯¼æ¼”æ¨¡å¼ä¿å­˜(send_group_message): æœªæŒ‡å®š targetGroupNameï¼Œå·²è·³è¿‡ã€‚");
              continue;
            }
            const g = Object.values(v.chats).find(c => c.isGroup && c.name === b && c.members.some(b => b.originalName === a));
            if (g) {
              if (!n.has(g.id)) {
                const a = await Gb.chats.get(g.id);
                n.set(g.id, a);
              }
              const b = n.get(g.id);
              let c = 0;
              for (const d of f) {
                if (!d || !d.trim()) {
                  continue;
                }
                const e = {
                  role: "assistant",
                  senderName: a,
                  content: d,
                  timestamp: l++
                };
                b.history.push(e);
                c++;
              }
              if (c > 0 && v.activeChatId !== g.id) {
                b.unreadCount = (b.unreadCount || 0) + c;
              }
              e = null;
            } else {
              console.warn("å¯¼æ¼”æ¨¡å¼ä¿å­˜(send_group_message): æœªæ‰¾åˆ°ç¾¤èŠ \"" + b + "\" æˆ–è§’è‰² \"" + a + "\" ä¸åœ¨è¯¥ç¾¤ä¸­ã€‚");
              e = null;
            }
            continue;
          }
        case "thought_chain":
          {
            continue;
          }
        case "text":
          e = {
            ...f,
            content: String(d.content || d.message)
          };
          break;
        case "sticker":
          {
            let a = false;
            if (d.url && d.meaning) {
              e = {
                ...f,
                type: "sticker",
                content: d.url,
                meaning: d.meaning
              };
              a = true;
            } else if (d.meaning) {
              const b = z(d.meaning, v.userStickers);
              if (b) {
                e = {
                  ...f,
                  type: "sticker",
                  content: b.url,
                  meaning: b.name
                };
                a = true;
              } else {
                e = {
                  ...f,
                  type: "text",
                  content: "[è¡¨æƒ…: " + d.meaning + "]"
                };
                a = true;
              }
            } else if (d.url) {
              e = {
                ...f,
                type: "sticker",
                content: d.url
              };
              const b = v.userStickers.find(a => a.url === d.url);
              e.meaning = b ? b.name : "æœªçŸ¥è¡¨æƒ…";
              a = true;
            } else if (d.content && typeof d.content === "string" && $a.test(d.content)) {
              e = {
                ...f,
                type: "sticker",
                content: d.content
              };
              const b = v.userStickers.find(a => a.url === d.content);
              e.meaning = b ? b.name : "æœªçŸ¥è¡¨æƒ…";
              a = true;
            }
            if (!a) {
              console.error("å¯¼æ¼”æ¨¡å¼ä¿å­˜(Sticker): æŒ‡ä»¤æ— æ•ˆæˆ–ç¼ºå°‘å¿…è¦å­—æ®µ (meaning/url/content):", d);
              continue;
            }
            break;
          }
        case "ai_image":
          e = {
            ...f,
            type: "ai_image",
            content: d.description,
            image_prompt: d.image_prompt
          };
          break;
        case "naiimag":
          {
            const a = d.prompt;
            let b = null;
            let g = null;
            const h = i[j];
            j++;
            let k = false;
            if (h) {
              const c = h.prompt;
              if (a && a !== c) {
                console.log("NAI Prompt å·²æ”¹å˜ï¼Œå°†è§¦å‘é‡æ–°ç”Ÿæˆã€‚");
                k = true;
              } else {
                console.log("NAI Prompt æœªæ”¹å˜ï¼Œå°†ä¿ç•™åŽŸå§‹å›¾ç‰‡ã€‚");
                b = h.imageUrl;
                g = h.fullPrompt;
              }
            } else {
              console.log("æœªæ‰¾åˆ°åŒ¹é…çš„åŽŸå§‹NAIå›¾ç‰‡(è¿™æ˜¯æ–°æ·»åŠ çš„å—)ï¼Œå°†è§¦å‘é‡æ–°ç”Ÿæˆã€‚");
              k = true;
            }
            if (k) {
              const d = h ? "æ£€æµ‹åˆ°NAIæç¤ºè¯å·²ä¿®æ”¹ï¼Œæ­£åœ¨é‡æ–°ç”Ÿæˆ..." : "æ£€æµ‹åˆ°æ–°çš„NAIç”Ÿå›¾æŒ‡ä»¤ï¼Œæ­£åœ¨ç”Ÿæˆ...";
              await Bb("è¯·ç¨å€™...", d);
              try {
                const d = await Ec(a, c.id);
                b = d.imageUrl;
                g = d.fullPrompt;
                await Bb("æˆåŠŸ", "å›¾ç‰‡å·²ç”Ÿæˆï¼");
              } catch (a) {
                console.error("å¯¼æ¼”æ¨¡å¼ä¸‹é‡æ–°ç”ŸæˆNAIå›¾ç‰‡å¤±è´¥:", a);
                await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆå›¾ç‰‡: " + a.message + `. 

å°†ä¿ç•™æ—§å›¾ç‰‡ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰ã€‚`);
                if (h) {
                  b = h.imageUrl;
                  g = h.fullPrompt;
                } else {
                  console.error("æ–°NAIå›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œæ­¤æ¡æ¶ˆæ¯å·²è¢«è·³è¿‡ã€‚");
                  continue;
                }
              }
            }
            e = {
              ...f,
              type: "naiimag",
              imageUrl: b,
              prompt: a,
              fullPrompt: g
            };
            break;
          }
        case "voice_message":
          e = {
            ...f,
            type: "voice_message",
            content: d.content
          };
          break;
        case "transfer":
          e = {
            ...f,
            type: "transfer",
            amount: d.amount,
            note: d.note,
            receiverName: d.receiver || "æˆ‘"
          };
          break;
        case "waimai_request":
          e = {
            ...f,
            type: "waimai_request",
            productInfo: d.productInfo,
            amount: d.amount,
            status: "pending",
            countdownEndTime: Date.now() + 900000
          };
          break;
        case "offline_text":
          e = {
            ...f,
            ...d
          };
          break;
        case "gomoku_move":
          {
            const a = Ua[c.id];
            if (a) {
              const b = a.history.findLastIndex(a => a.player === 2);
              if (b > -1) {
                const c = a.history[b];
                a.board[c.y][c.x] = 0;
                a.history.splice(b, 1);
                console.log("å¯¼æ¼”æ¨¡å¼æ‚”æ£‹ï¼šå·²æ’¤é”€AIåœ¨ (" + c.x + ", " + c.y + ") çš„æ£‹æ­¥ã€‚");
              }
            }
            const b = parseInt(d.x);
            const e = parseInt(d.y);
            if (!isNaN(b) && !isNaN(e)) {
              Oi({
                x: b,
                y: e
              }, true);
            } else {
              console.warn("å¯¼æ¼”æ¨¡å¼ä¿å­˜äº†ä¸€ä¸ªæ— æ•ˆçš„äº”å­æ£‹ç§»åŠ¨æŒ‡ä»¤:", d);
            }
            continue;
          }
        case "update_thoughts":
          {
            if (!c.isGroup) {
              if (d.heartfelt_voice) {
                c.heartfeltVoice = String(d.heartfelt_voice);
              }
              if (d.random_jottings) {
                c.randomJottings = String(d.random_jottings);
              }
              if (!Array.isArray(c.thoughtsHistory)) {
                c.thoughtsHistory = [];
              }
              c.thoughtsHistory.push({
                heartfeltVoice: c.heartfeltVoice,
                randomJottings: c.randomJottings,
                timestamp: Date.now()
              });
              if (c.thoughtsHistory.length > 50) {
                c.thoughtsHistory.shift();
              }
            }
            continue;
          }
        case "quote_reply":
          {
            let a = null;
            let b = null;
            if (d.target_content) {
              a = [...c.history].reverse().find(a => !a.isHidden && (a.content === d.target_content || typeof a.content === "string" && a.content.trim() === d.target_content.trim()));
              if (!a) {
                console.warn("[å¯¼æ¼”æ¨¡å¼ä¿å­˜å¤±è´¥] å°è¯•å¼•ç”¨å†…å®¹ \"" + (d.target_content || "").substring(0, 20) + "...\"ï¼Œä½†åœ¨åŽ†å²ä¸­æœªæ‰¾åˆ°ã€‚");
              }
            } else if (d.target_timestamp) {
              a = c.history.find(a => a.timestamp === d.target_timestamp);
            }
            if (a) {
              let d;
              if (a.role === "user") {
                d = c.settings.myNickname || "æˆ‘";
              } else if (c.isGroup) {
                d = sb(c, a.senderName);
              } else {
                d = c.name;
              }
              b = {
                timestamp: a.timestamp,
                senderName: d,
                content: String(a.content || "")
              };
            } else {
              console.warn("å¯¼æ¼”æ¨¡å¼ä¿å­˜å¼•ç”¨å¤±è´¥: æ‰¾ä¸åˆ°ç›®æ ‡æ¶ˆæ¯ (Content: " + d.target_content + ", TS: " + d.target_timestamp + ")");
            }
            e = {
              ...f,
              content: d.reply_content
            };
            if (b) {
              e.quote = b;
            }
            break;
          }
        default:
          console.warn("åœ¨å¯¼æ¼”æ¨¡å¼ä¿å­˜æ—¶ï¼Œé‡åˆ°äº†æœªçŸ¥çš„AIæŒ‡ä»¤ç±»åž‹:", d.type, d);
          if (d.content) {
            e = {
              ...f,
              content: String(d.content)
            };
          } else {
            continue;
          }
          break;
      }
      if (e) {
        c.history.push(e);
        k.push(e.timestamp);
      }
    }
    if (n.size > 0) {
      await Gb.chats.bulkPut(Array.from(n.values()));
    }
    await Gb.chats.put(c);
    if (m.size > 0) {
      await Gb.chats.bulkPut(Array.from(m.values()));
    }
    cd(v.activeChatId);
    _c();
    document.getElementById("ai-response-editor-modal").classList.remove("visible");
    r = f.join(`

`);
    s = k;
    await Bb("å¯¼æ¼”æ¨¡å¼", "æ‚¨çš„ä¿®æ”¹å·²ä¿å­˜ï¼");
  }
  async function Vh() {
    if (!qa) {
      return;
    }
    const a = 120000;
    const b = qa;
    const c = Date.now();
    if (c - b > a) {
      ff();
      await Bb("æ“ä½œå¤±è´¥", "è¯¥æ¶ˆæ¯å‘é€å·²è¶…è¿‡2åˆ†é’Ÿï¼Œæ— æ³•æ’¤å›žã€‚");
      return;
    }
    await Wh(b, true);
    ff();
  }
  async function Wh(a, b) {
    const c = v.chats[v.activeChatId];
    if (!c) {
      return;
    }
    const d = c.history.findIndex(b => b.timestamp === a);
    if (d === -1) {
      return;
    }
    const e = c.history[d];
    const f = {
      originalType: e.type || "text",
      originalContent: e.content,
      originalMeaning: e.meaning,
      originalQuote: e.quote
    };
    e.type = "recalled_message";
    e.content = b ? "ä½ æ’¤å›žäº†ä¸€æ¡æ¶ˆæ¯" : "å¯¹æ–¹æ’¤å›žäº†ä¸€æ¡æ¶ˆæ¯";
    e.recalledData = f;
    delete e.meaning;
    delete e.quote;
    if (b) {
      const a = c.isGroup ? c.settings.myNickname || "æˆ‘" : "æˆ‘";
      let b = "";
      if (f.originalType === "sticker") {
        b = "[è¡¨æƒ…ï¼Œå«ä¹‰: " + (f.originalMeaning || "æœªçŸ¥") + "]";
      } else if (f.originalType === "ai_image" || f.originalType === "user_photo") {
        b = "[å›¾ç‰‡ï¼Œæè¿°: " + f.originalContent + "]";
      } else {
        b = "â€œ" + String(f.originalContent) + "â€";
      }
      const d = {
        role: "system",
        content: "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ï¼ˆ" + a + "ï¼‰åˆšåˆšæ’¤å›žäº†ä¸€æ¡æ¶ˆæ¯ã€‚æ’¤å›žå‰çš„å†…å®¹æ˜¯ï¼š" + b + "ã€‚è¯·ä½ å¯¹æ­¤ä½œå‡ºå›žåº”ï¼Œå¯ä»¥è¡¨çŽ°å‡ºå¥½å¥‡ã€å¼€çŽ©ç¬‘ï¼ˆæ¯”å¦‚'æˆ‘æˆªå›¾äº†ï¼'ï¼‰ã€æˆ–è€…æ ¹æ®ä½ çš„äººè®¾è¡¨ç¤ºç†è§£æˆ–ç–‘æƒ‘ã€‚]",
        timestamp: Date.now(),
        isHidden: true
      };
      c.history.push(d);
    }
    await Gb.chats.put(c);
    cd(v.activeChatId);
    if (b) {
      _c();
    }
  }
  async function Xh() {
    await Yh();
    document.getElementById("world-book-category-manager-modal").classList.add("visible");
  }
  async function Yh() {
    const a = document.getElementById("existing-categories-list");
    const b = await Gb.worldBookCategories.toArray();
    a.innerHTML = "";
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align: center; color: var(--text-secondary);\">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>";
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "existing-group-item";
      c.innerHTML = "\n                    <span class=\"group-name\">" + b.name + "</span>\n                    <span class=\"delete-group-btn\" data-id=\"" + b.id + "\">Ã—</span>\n                ";
      a.appendChild(c);
    });
  }
  async function Zh() {
    const a = document.getElementById("new-category-name-input");
    const b = a.value.trim();
    if (!b) {
      alert("åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼");
      return;
    }
    const c = await Gb.worldBookCategories.where("name").equals(b).first();
    if (c) {
      alert("åˆ†ç±» \"" + b + "\" å·²ç»å­˜åœ¨äº†ï¼");
      return;
    }
    await Gb.worldBookCategories.add({
      name: b
    });
    a.value = "";
    await Yh();
  }
  async function $h(a) {
    const b = await wb("ç¡®è®¤åˆ é™¤", "åˆ é™¤åˆ†ç±»åŽï¼Œè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ä¸–ç•Œä¹¦å°†å˜ä¸ºâ€œæœªåˆ†ç±»â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (b) {
      await Gb.worldBookCategories.delete(a);
      const b = await Gb.worldBooks.where("categoryId").equals(a).toArray();
      for (const a of b) {
        a.categoryId = null;
        await Gb.worldBooks.put(a);
        const b = v.worldBooks.find(b => b.id === a.id);
        if (b) {
          b.categoryId = null;
        }
      }
      await Yh();
    }
  }
  async function _h() {
    if (!qa) {
      return;
    }
    const a = qa;
    ff();
    const b = v.chats[v.activeChatId];
    const c = b.history.find(b => b.timestamp === a);
    if (!c) {
      return;
    }
    let d = String(c.content || "").substring(0, 50) + "...";
    if (c.type === "ai_image") {
      d = "[å›¾ç‰‡] " + d;
    }
    const e = await wb("å‘å¸ƒå…¬å‘Š", `ç¡®å®šè¦å°†ä»¥ä¸‹æ¶ˆæ¯å‘å¸ƒåˆ°å…¬å‘Šæ¿å—ï¼Ÿ

â€œ` + d + "â€", {
      confirmText: "ç¡®å®šå‘å¸ƒ"
    });
    if (e) {
      const c = b.settings.myNickname || "æˆ‘";
      if (!Array.isArray(b.announcements)) {
        b.announcements = [];
      }
      const d = {
        id: "anno_" + Date.now(),
        messageTimestamp: a,
        publisher: c,
        publishedAt: Date.now(),
        isPinned: false
      };
      b.announcements.push(d);
      const e = {
        role: "system",
        type: "pat_message",
        content: c + " å‘å¸ƒäº†ä¸€æ¡æ–°å…¬å‘Š",
        timestamp: Date.now()
      };
      b.history.push(e);
      await Gb.chats.put(b);
      Pd(e, b);
      _c();
      await Bb("æˆåŠŸ", "å…¬å‘Šå·²å‘å¸ƒï¼");
    }
  }
  async function ai() {
    const a = v.chats[v.activeChatId];
    const b = a.announcements || [];
    if (!a || b.length === 0) {
      Bb("æç¤º", "å½“å‰ç¾¤èŠè¿˜æ²¡æœ‰å…¬å‘Šå“¦ã€‚");
      return;
    }
    const c = document.getElementById("announcement-board-content");
    c.innerHTML = "";
    b.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));
    for (const d of b) {
      const b = a.history.find(a => a.timestamp === d.messageTimestamp);
      const e = document.createElement("div");
      e.className = "announcement-item-wrapper";
      if (b) {
        const c = await Nd(b, a);
        if (c) {
          e.appendChild(c);
        }
      } else {
        e.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary);\">å…¬å‘Šçš„åŽŸæ¶ˆæ¯å·²è¢«åˆ é™¤ã€‚</p>";
      }
      if (d.isPinned) {
        e.innerHTML += "<div class=\"pinned-indicator\">ðŸ“Œ</div>";
      }
      e.innerHTML += "<div class=\"announcement-item-actions\" data-anno-id=\"" + d.id + "\">...</div>";
      c.appendChild(e);
    }
    document.getElementById("announcement-board-modal").classList.add("visible");
  }
  let bi = null;
  function ci(a) {
    bi = a;
    const b = v.chats[v.activeChatId];
    const c = b.announcements.find(b => b.id === a);
    if (!c) {
      return;
    }
    const d = document.getElementById("announcement-action-pin");
    d.textContent = c.isPinned ? "å–æ¶ˆç½®é¡¶" : "ç½®é¡¶å…¬å‘Š";
    document.getElementById("announcement-actions-modal").classList.add("visible");
  }
  async function di() {
    if (!bi) {
      return;
    }
    const a = v.chats[v.activeChatId];
    const b = a.announcements.find(a => a.id === bi);
    if (b) {
      b.isPinned = !b.isPinned;
      await Gb.chats.put(a);
      ai();
    }
    document.getElementById("announcement-actions-modal").classList.remove("visible");
  }
  async function ei() {
    if (!bi) {
      return;
    }
    const a = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", {
      confirmButtonClass: "btn-danger"
    });
    if (a) {
      const a = v.chats[v.activeChatId];
      a.announcements = a.announcements.filter(a => a.id !== bi);
      await Gb.chats.put(a);
      ai();
    }
    document.getElementById("announcement-actions-modal").classList.remove("visible");
  }
  let fi = false;
  let gi = {
    ai: null,
    my: null
  };
  function hi(a = "chat") {
    const b = document.getElementById("avatar-frame-modal");
    if (!v.activeChatId) {
      return;
    }
    const c = v.chats[v.activeChatId];
    fi = a === "member";
    if (fi) {
      const a = c.members.find(a => a.id === da);
      if (!a) {
        return;
      }
      gi.my = a.avatarFrame || "";
      ii(true, a.avatar, a.avatarFrame);
    } else {
      gi.ai = c.settings.aiAvatarFrame || "";
      gi.my = c.settings.myAvatarFrame || "";
      ii(false);
    }
    b.classList.add("visible");
  }
  function ii(a = false, b = null, c = null) {
    const d = document.getElementById("ai-frame-grid");
    const e = document.getElementById("my-frame-grid");
    const f = v.chats[v.activeChatId];
    d.innerHTML = "";
    e.innerHTML = "";
    document.querySelector("#avatar-frame-modal .frame-tabs").style.display = a ? "none" : "flex";
    document.getElementById("ai-frame-content").style.display = "block";
    document.getElementById("my-frame-content").style.display = "none";
    document.getElementById("ai-frame-tab").classList.add("active");
    document.getElementById("my-frame-tab").classList.remove("active");
    if (a) {
      q.forEach(a => {
        const e = ji(a, "my", b);
        if (a.url === c) {
          e.classList.add("selected");
        }
        d.appendChild(e);
      });
    } else {
      const a = f.settings.aiAvatar || Na;
      const b = f.settings.myAvatar || (f.isGroup ? Oa : Na);
      q.forEach(c => {
        const f = ji(c, "ai", a);
        if (c.url === gi.ai) {
          f.classList.add("selected");
        }
        d.appendChild(f);
        const g = ji(c, "my", b);
        if (c.url === gi.my) {
          g.classList.add("selected");
        }
        e.appendChild(g);
      });
    }
  }
  function ji(a, b, c) {
    const d = document.createElement("div");
    d.className = "frame-item";
    d.dataset.frameUrl = a.url;
    d.title = a.name;
    d.innerHTML = "\n                <img src=\"" + c + "\" class=\"preview-avatar\">\n                " + (a.url ? "<img src=\"" + a.url + "\" class=\"preview-frame\">" : "") + "\n            ";
    d.addEventListener("click", () => {
      gi[b] = a.url;
      const c = b === "ai" ? document.getElementById("ai-frame-grid") : document.getElementById("my-frame-grid");
      c.querySelectorAll(".frame-item").forEach(a => a.classList.remove("selected"));
      d.classList.add("selected");
    });
    return d;
  }
  async function ki() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.chats[v.activeChatId];
    if (fi) {
      const b = a.members.find(a => a.id === da);
      if (b) {
        b.avatarFrame = gi.my;
      }
    } else {
      a.settings.aiAvatarFrame = gi.ai;
      a.settings.myAvatarFrame = gi.my;
    }
    await Gb.chats.put(a);
    if (!fi && !a.isGroup) {
      const b = a.id;
      for (const c of Object.values(v.chats)) {
        if (c.isGroup && c.members) {
          const d = c.members.find(a => a.id === b);
          if (d) {
            d.avatarFrame = a.settings.aiAvatarFrame;
            await Gb.chats.put(c);
            console.log("å·²åŒæ­¥è§’è‰² " + b + " çš„å¤´åƒæ¡†åˆ°ç¾¤èŠ \"" + c.name + "\"");
          }
        }
      }
    }
    document.getElementById("avatar-frame-modal").classList.remove("visible");
    cd(v.activeChatId);
    alert("å¤´åƒæ¡†å·²ä¿å­˜å¹¶åŒæ­¥ï¼");
    fi = false;
  }
  function li() {
    bg = !bg;
    const a = document.getElementById("manage-frames-btn");
    const b = document.getElementById("frame-action-bar");
    const c = document.getElementById("select-all-frames-checkbox");
    document.querySelectorAll(".frame-grid").forEach(a => {
      a.classList.toggle("management-mode", bg);
    });
    if (bg) {
      a.textContent = "å®Œæˆ";
      b.style.display = "flex";
      cg.clear();
      c.checked = false;
      mi();
    } else {
      a.textContent = "ç®¡ç†";
      b.style.display = "none";
      document.querySelectorAll(".frame-item.selected").forEach(a => {
        a.classList.remove("selected");
      });
    }
  }
  function mi() {
    const a = document.getElementById("delete-selected-frames-btn");
    a.textContent = "åˆ é™¤ (" + cg.size + ")";
  }
  function ni() {
    const a = document.getElementById("select-all-frames-checkbox").checked;
    const b = document.querySelector(".frame-content[style*=\"display: block\"] .frame-grid");
    if (!b) {
      return;
    }
    b.querySelectorAll(".frame-item:has(.delete-btn)").forEach(b => {
      const c = parseInt(b.querySelector(".delete-btn").dataset.id);
      if (isNaN(c)) {
        return;
      }
      b.classList.toggle("selected", a);
      if (a) {
        cg.add(c);
      } else {
        cg.delete(c);
      }
    });
    mi();
  }
  async function oi() {
    if (cg.size === 0) {
      return;
    }
    const a = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ " + cg.size + " ä¸ªè‡ªå®šä¹‰å¤´åƒæ¡†å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (a) {
      const a = [...cg];
      await Gb.customAvatarFrames.bulkDelete(a);
      li();
      ii(fi);
      await Bb("åˆ é™¤æˆåŠŸ", "é€‰ä¸­çš„å¤´åƒæ¡†å·²æˆåŠŸåˆ é™¤ã€‚");
    }
  }
  function pi(a) {
    const b = document.getElementById("global-custom-style");
    if (b) {
      b.innerHTML = a || "";
    }
  }
  async function qi(a) {
    if (!R.isActive || !R.activeChatId) {
      return;
    }
    const b = v.chats[R.activeChatId];
    if (!b) {
      return;
    }
    const c = b.isGroup ? b.settings.myNickname || "æˆ‘" : "æˆ‘";
    const d = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (" + c + ") " + a + "]";
    const e = {
      role: "system",
      content: d,
      timestamp: Date.now(),
      isHidden: true
    };
    b.history.push(e);
    await Gb.chats.put(b);
  }
  async function ri() {
    if (ca.size === 0) {
      return;
    }
    const a = v.chats[v.activeChatId];
    if (!a) {
      return;
    }
    const b = document.getElementById("selection-screenshot-btn");
    const c = b.textContent;
    b.textContent = "ç”Ÿæˆä¸­...";
    b.disabled = true;
    const d = document.createElement("div");
    const e = document.getElementById("phone-screen");
    d.style.width = e.offsetWidth + "px";
    d.style.position = "absolute";
    d.style.top = "-9999px";
    d.style.left = "-9999px";
    d.style.display = "flex";
    d.style.flexDirection = "column";
    d.style.height = "auto";
    const f = document.getElementById("chat-interface-screen");
    d.style.backgroundImage = f.style.backgroundImage;
    d.style.backgroundColor = f.style.backgroundColor || (document.getElementById("phone-screen").classList.contains("dark-mode") ? "#000000" : "#f0f2f5");
    const g = document.createElement("style");
    g.innerHTML = `
                .message-bubble.selected::after { display: none !important; }
                .cloned-header .default-controls { display: flex !important; justify-content: space-between; align-items: center; width: 100%; }
                .cloned-header .selection-controls { display: none !important; }
            `;
    document.head.appendChild(g);
    try {
      const b = f.querySelector(".header").cloneNode(true);
      b.classList.add("cloned-header");
      const c = document.createElement("div");
      const e = document.getElementById("chat-messages");
      c.style.display = "flex";
      c.style.flexDirection = "column";
      c.style.gap = "20px";
      c.style.padding = "10px 15px 20px 15px";
      c.style.width = "100%";
      c.style.boxSizing = "border-box";
      c.dataset.theme = e.dataset.theme;
      c.style.setProperty("--chat-font-size", e.style.getPropertyValue("--chat-font-size"));
      const g = f.querySelector("#chat-input-area").cloneNode(true);
      const h = [...ca].sort((a, b) => a - b);
      h.forEach(a => {
        const b = document.querySelector(".message-bubble[data-timestamp=\"" + a + "\"]");
        if (b) {
          const a = b.closest(".message-wrapper");
          if (a) {
            c.appendChild(a.cloneNode(true));
          }
        }
      });
      d.appendChild(b);
      d.appendChild(c);
      d.appendChild(g);
      document.body.appendChild(d);
      const i = Array.from(d.getElementsByTagName("img"));
      const j = i.map(a => new Promise((b, c) => {
        if (a.src.startsWith("data:")) {
          b();
          return;
        }
        const d = new Image();
        d.crossOrigin = "anonymous";
        d.onload = b;
        d.onerror = b;
        d.src = a.src;
      }));
      await Promise.all(j);
      const k = await html2canvas(d, {
        allowTaint: true,
        useCORS: true,
        backgroundColor: null,
        scale: window.devicePixelRatio || 2
      });
      k.toBlob(function (b) {
        const c = URL.createObjectURL(b);
        const d = document.createElement("a");
        d.download = "EPhone-é•¿æˆªå›¾-" + a.name + "-" + Date.now() + ".png";
        d.href = c;
        document.body.appendChild(d);
        d.click();
        document.body.removeChild(d);
        URL.revokeObjectURL(c);
      }, "image/png");
    } catch (a) {
      console.error("é•¿æˆªå›¾ç”Ÿæˆå¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "ç”Ÿæˆæˆªå›¾æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æŽ§åˆ¶å°èŽ·å–è¯¦æƒ…ã€‚");
    } finally {
      document.body.removeChild(d);
      document.head.removeChild(g);
      b.textContent = c;
      b.disabled = false;
      Zd();
    }
  }
  function si(a) {
    if (!a || typeof a !== "string") {
      return "";
    }
    a = a.replace(/!h\{(.*?)\}/g, "<span class=\"diary-highlight\">$1</span>");
    a = a.replace(/!u\{(.*?)\}/g, "<span class=\"diary-underline\">$1</span>");
    a = a.replace(/!e\{(.*?)\}/g, "<span class=\"diary-emphasis\">$1</span>");
    a = a.replace(/!w\{(.*?)\}/g, "<span class=\"diary-handwritten\">$1</span>");
    a = a.replace(/!m\{(.*?)\}/g, "<span class=\"diary-messy\">$1</span>");
    a = a.replace(/\|\|(.*?)\|\|/g, "<span class=\"spoiler\">$1</span>");
    a = a.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
    a = a.replace(/\~\~(.*?)\~\~/g, "<s>$1</s>");
    a = a.replace(/\*(.*?)\*/g, "<em>$1</em>");
    return a;
  }
  async function ti() {
    console.log("å¼€å§‹æ£€æŸ¥å¹¶è¿ç§»æ—§çš„çº¢åŒ…æ•°æ®...");
    let a = 0;
    const b = Object.values(v.chats);
    for (const c of b) {
      let b = false;
      for (const d of c.history) {
        if (d.type === "red_packet" && d.packetType === "direct" && d.role === "assistant" && d.hasOwnProperty("receiver") && !d.hasOwnProperty("receiverName")) {
          d.receiverName = d.receiver;
          delete d.receiver;
          b = true;
          a++;
        }
      }
      if (b) {
        console.log("åœ¨èŠå¤© \"" + c.name + "\" ä¸­å‘çŽ°å¹¶ä¿®å¤äº†æ—§çº¢åŒ…æ•°æ®ã€‚");
        await Gb.chats.put(c);
      }
    }
    if (a > 0) {
      console.log("æ•°æ®è¿ç§»å®Œæˆï¼æ€»å…±ä¿®å¤äº† " + a + " æ¡çº¢åŒ…è®°å½•ã€‚");
      alert("æ£€æµ‹åˆ°å¹¶æˆåŠŸä¿®å¤äº† " + a + " æ¡æ—§çš„çº¢åŒ…æ¶ˆæ¯ï¼é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ä»¥åº”ç”¨æ›´æ”¹ã€‚");
      location.reload();
    } else {
      console.log("æœªå‘çŽ°éœ€è¦è¿ç§»çš„æ—§çº¢åŒ…æ•°æ®ã€‚");
    }
  }
  async function ui() {
    if (!v.activeChatId || v.chats[v.activeChatId].isGroup) {
      return;
    }
    const a = v.chats[v.activeChatId];
    if (!a) {
      return;
    }
    const b = a.heartfeltVoice || "";
    const c = await Db("ç¼–è¾‘â€œ" + a.name + "â€çš„å¿ƒå£°", "è¯·è¾“å…¥æ–°çš„å¿ƒå£°å†…å®¹...", b, "textarea");
    if (c === null) {
      await Bb("æ“ä½œå–æ¶ˆ", "å¿ƒå£°ç¼–è¾‘å·²å–æ¶ˆã€‚");
      return;
    }
    const d = a.randomJottings || "";
    const e = await Db("ç¼–è¾‘â€œ" + a.name + "â€çš„æ•£è®°", "è¯·è¾“å…¥æ–°çš„æ•£è®°å†…å®¹...", d, "textarea");
    if (e === null) {
      await Bb("æ“ä½œå–æ¶ˆ", "æ•£è®°ç¼–è¾‘å·²å–æ¶ˆï¼Œå¿ƒå£°çš„ä¿®æ”¹ä¹Ÿæœªä¿å­˜ã€‚");
      return;
    }
    a.heartfeltVoice = c.trim();
    a.randomJottings = e.trim();
    if (!Array.isArray(a.thoughtsHistory)) {
      a.thoughtsHistory = [];
    }
    if (a.thoughtsHistory.length > 0) {
      const b = a.thoughtsHistory[a.thoughtsHistory.length - 1];
      b.heartfeltVoice = a.heartfeltVoice;
      b.randomJottings = a.randomJottings;
      b.timestamp = Date.now();
    } else {
      a.thoughtsHistory.push({
        heartfeltVoice: a.heartfeltVoice,
        randomJottings: a.randomJottings,
        timestamp: Date.now()
      });
    }
    await Gb.chats.put(a);
    await vi(a.id);
    await Bb("æˆåŠŸ", "å¿ƒå£°å’Œæ•£è®°å·²æ›´æ–°ï¼");
  }
  async function vi(a) {
    const b = v.chats[a];
    if (!b || b.isGroup) {
      return;
    }
    const c = document.getElementById("profile-heartfelt-voice");
    const d = document.getElementById("profile-random-jottings");
    c.innerHTML = await wj(b.heartfeltVoice || "...", a);
    d.innerHTML = await wj(b.randomJottings || "...", a);
    const e = document.getElementById("character-profile-modal");
    e.classList.add("visible");
  }
  async function wi() {
    document.getElementById("profile-main-content").style.display = "none";
    document.getElementById("profile-thoughts-history-view").style.display = "flex";
    await yi();
  }
  function xi() {
    document.getElementById("profile-thoughts-history-view").style.display = "none";
    document.getElementById("profile-main-content").style.display = "flex";
  }
  async function yi() {
    const a = document.getElementById("thoughts-history-list");
    const b = v.chats[v.activeChatId];
    a.innerHTML = "";
    if (!b || !b.thoughtsHistory || b.thoughtsHistory.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: #8a8a8a; padding: 30px 0;\">è¿™é‡Œè¿˜æ²¡æœ‰åŽ†å²è®°å½•å“¦ã€‚</p>";
      return;
    }
    const c = [...b.thoughtsHistory].reverse();
    const d = c.slice(0, N);
    const e = d.map(a => Ai(a));
    const f = await Promise.all(e);
    f.forEach(b => a.appendChild(b));
    M = d.length;
    if (c.length > M) {
      appendLoadMoreThoughtsButton(a);
    }
  }
  async function zi() {
    if (ja) {
      return;
    }
    ja = true;
    const a = document.getElementById("thoughts-history-list");
    const b = v.chats[v.activeChatId];
    if (!b) {
      ja = false;
      return;
    }
    tn(a, "bottom");
    await new Promise(a => // TOLOOK
    setTimeout(a, 500));
    const c = [...b.thoughtsHistory].reverse();
    const d = c.length;
    const e = M;
    const f = M + N;
    const g = c.slice(e, f);
    un(a);
    const h = g.map(a => Ai(a));
    const i = await Promise.all(h);
    i.forEach(b => a.appendChild(b));
    M += g.length;
    ja = false;
  }
  async function Ai(a) {
    const b = document.createElement("div");
    b.className = "thought-card";
    const c = new Date(a.timestamp);
    const d = c.getFullYear() + "-" + String(c.getMonth() + 1).padStart(2, "0") + "-" + String(c.getDate()).padStart(2, "0") + " " + String(c.getHours()).padStart(2, "0") + ":" + String(c.getMinutes()).padStart(2, "0");
    const e = v.activeChatId;
    const f = await wj(a.heartfeltVoice || "...", e);
    const g = await wj(a.randomJottings || "...", e);
    b.innerHTML = "\n        <button class=\"thought-delete-btn\" data-timestamp=\"" + a.timestamp + "\" title=\"åˆ é™¤æ­¤æ¡è®°å½•\">Ã—</button>\n        <div class=\"thought-header\">" + d + `</div>
        <div class="thought-content">
            <div class="voice">
                <div class="label">
                    <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    å¿ƒå£°
                </div>
                <div class="text">` + f + `</div>
            </div>
            <div class="jottings">
                <div class="label">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg>
                    æ•£è®°
                </div>
                <div class="text">` + g + `</div>
            </div>
        </div>
    `;
    return b;
  }
  async function Bi(a) {
    const b = a.target.files[0];
    if (!b) {
      return;
    }
    try {
      let a;
      let c = null;
      if (b.name.endsWith(".json")) {
        const c = await b.text();
        a = JSON.parse(c);
      } else if (b.name.endsWith(".png")) {
        const d = await b.arrayBuffer();
        a = await Ci(d);
        c = await new Promise(a => {
          const c = new FileReader();
          c.onload = async b => {
            let c = b.target.result;
            if (v.apiConfig.imgbbEnable && v.apiConfig.imgbbApiKey) {
              try {
                await Bb("è¯·ç¨å€™...", "æ­£åœ¨ä¸Šä¼ è§’è‰²å¡å°é¢åˆ° ImgBB...");
                const b = await I(c);
                a(b);
              } catch (b) {
                console.error(b);
                await Bb("ImgBB ä¸Šä¼ å¤±è´¥", "å°é¢ä¸Šä¼ å¤±è´¥: " + b.message + `

å°†ç»§ç»­ä½¿ç”¨æœ¬åœ° Base64 æ ¼å¼ä¿å­˜ã€‚`);
                a(c);
              }
            } else {
              a(c);
            }
          };
          c.readAsDataURL(b);
        });
      } else {
        throw new Error("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚è¯·é€‰æ‹© .json æˆ– .png æ–‡ä»¶ã€‚");
      }
      await Ei(a, c);
    } catch (a) {
      console.error("è§’è‰²å¡å¯¼å…¥å¤±è´¥:", a);
      await Bb("å¯¼å…¥å¤±è´¥", "æ— æ³•è§£æžè§’è‰²å¡æ–‡ä»¶ã€‚\né”™è¯¯: " + a.message);
    } finally {
      a.target.value = null;
    }
  }
  function Ci(a) {
    return new Promise((b, c) => {
      const d = new DataView(a);
      if (d.getUint32(0) !== 2303741511 || d.getUint32(4) !== 218765834) {
        return c(new Error("æ–‡ä»¶ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„PNGã€‚"));
      }
      let e = 8;
      const f = new TextDecoder();
      while (e < d.byteLength) {
        const g = d.getUint32(e);
        const h = f.decode(a.slice(e + 4, e + 8));
        if (h === "tEXt") {
          const d = new Uint8Array(a, e + 8, g);
          const h = d.indexOf(0);
          if (h !== -1) {
            const a = f.decode(d.slice(0, h));
            if (a === "chara") {
              const a = f.decode(d.slice(h + 1));
              try {
                const c = atob(a);
                const d = new Uint8Array(c.length);
                for (let a = 0; a < c.length; a++) {
                  d[a] = c.charCodeAt(a);
                }
                const e = new TextDecoder("utf-8").decode(d);
                b(JSON.parse(e));
                return;
              } catch (a) {
                return c(new Error("åœ¨PNGä¸­æ‰¾åˆ°è§’è‰²æ•°æ®ï¼Œä½†è§£ç æˆ–è§£æžå¤±è´¥ã€‚é”™è¯¯: " + a.message));
              }
            }
          }
        }
        e += 8 + g + 4;
      }
      c(new Error("åœ¨PNGæ–‡ä»¶ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„Tavern AIè§’è‰²æ•°æ®(chara chunk)ã€‚"));
    });
  }
  function Di(a) {
    if (a.data?.character_book?.entries?.length > 0) {
      console.log("è¯Šæ–­ï¼šåœ¨ data.character_book ä¸­æ‰¾åˆ°ä¸–ç•Œä¹¦ã€‚");
      return a.data.character_book.entries;
    }
    if (a.extensions?.character_book?.entries?.length > 0) {
      console.log("è¯Šæ–­ï¼šåœ¨ extensions.character_book ä¸­æ‰¾åˆ°ä¸–ç•Œä¹¦ã€‚");
      return a.extensions.character_book.entries;
    }
    if (a.data?.extensions?.character_book?.entries?.length > 0) {
      console.log("è¯Šæ–­ï¼šåœ¨ data.extensions.character_book ä¸­æ‰¾åˆ°ä¸–ç•Œä¹¦ã€‚");
      return a.data.extensions.character_book.entries;
    }
    const b = ["character_book", "lorebook", "world_info", "char_book"];
    for (const c of b) {
      if (a[c]?.entries?.length > 0) {
        console.log("è¯Šæ–­ï¼šåœ¨é¡¶å±‚ " + c + " ä¸­æ‰¾åˆ°ä¸–ç•Œä¹¦ã€‚");
        return a[c].entries;
      }
    }
    console.log("è¯Šæ–­ï¼šæœªåœ¨æ­¤è§’è‰²å¡ä¸­æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„ä¸–ç•Œä¹¦æ•°æ®ã€‚");
    return null;
  }
  async function Ei(a, b = null) {
    const c = a.data || a;
    if (!c.name) {
      throw new Error("è§’è‰²å¡æ•°æ®æ— æ•ˆæˆ–ç¼ºå°‘'name'å­—æ®µã€‚");
    }
    let d = null;
    const e = Di(a);
    if (e) {
      const a = e.filter(a => a.enabled && a.content).map(a => ({
        keys: a.keys || [],
        comment: a.comment || "",
        content: a.content.replace(/<memory>|<\/memory>/g, "").trim()
      }));
      if (a.length > 0) {
        const b = {
          id: "wb_" + Date.now(),
          name: c.name + "çš„è®¾å®šé›†",
          content: a,
          categoryId: null
        };
        await Gb.worldBooks.add(b);
        v.worldBooks.push(b);
        d = b.id;
      }
    }
    let f = [];
    if (Array.isArray(c.alternate_greetings)) {
      f = c.alternate_greetings;
    } else if (Array.isArray(a.alternate_greetings)) {
      f = a.alternate_greetings;
    }
    f = f.filter(a => a && typeof a === "string" && a.trim() !== "");
    const g = c.first_mes || a.first_mes;
    if (g && typeof g === "string" && g.trim() !== "" && !f.includes(g)) {
      f.unshift(g);
    }
    let h = c.description || a.description || "æ— ";
    h = h.replace(/```yaml/g, "").replace(/```/g, "").replace(/<\/?info>/g, "").replace(/<\/?character>/g, "").replace(/<\/?writing_rule>/g, "").replace(/\[OOCï¼š.*?\]/g, "").trim();
    let i = "# è§’è‰²æ ¸å¿ƒè®¾å®š\n" + h + `

`;
    if (c.personality) {
      i += "# æ€§æ ¼è¡¥å……\n" + c.personality + `

`;
    }
    if (c.scenario) {
      i += "# åœºæ™¯è®¾å®š\n" + c.scenario + `

`;
    }
    if (c.mes_example) {
      i += "# å¯¹è¯ç¤ºä¾‹\n" + c.mes_example + `

`;
    }
    const j = c.name;
    const k = c.name;
    const l = "chat_" + Date.now();
    const m = {
      id: l,
      name: j.trim(),
      originalName: k.trim(),
      isGroup: false,
      relationship: {
        status: "friend"
      },
      status: {
        text: "åœ¨çº¿",
        lastUpdate: Date.now(),
        isBusy: false
      },
      settings: {
        aiPersona: i,
        myPersona: "æˆ‘æ˜¯è°å‘€ã€‚",
        maxMemory: 10,
        aiAvatar: Na,
        myAvatar: Na,
        background: "",
        theme: "default",
        fontSize: 13,
        customCss: "",
        linkedWorldBookIds: d ? [d] : [],
        aiAvatarLibrary: [],
        alternateGreetings: f
      },
      history: [],
      musicData: {
        totalTime: 0
      },
      longTermMemory: []
    };
    if (b) {
      m.settings.aiAvatar = b;
      m.settings.aiAvatarLibrary.push({
        name: "é»˜è®¤å¤´åƒ",
        url: b
      });
    }
    if (g && typeof g === "string") {
      const a = document.createElement("div");
      a.innerHTML = g;
      const b = (a.textContent || a.innerText || "").replace(/åŽŸä½œè€….*?å¼€å±€/s, "").trim();
      if (b) {
        m.history.push({
          role: "assistant",
          senderName: m.originalName,
          content: b,
          timestamp: Date.now()
        });
      }
    }
    v.chats[l] = m;
    await Gb.chats.put(m);
    _c();
    let n = "è§’è‰² â€œ" + m.name + "â€ å·²æˆåŠŸå¯¼å…¥ï¼";
    if (d) {
      n += `

å…¶ä¸“å±žçš„â€œä¸–ç•Œä¹¦â€ä¹Ÿå·²è‡ªåŠ¨åˆ›å»ºå¹¶å…³è”ã€‚`;
    }
    if (f.length > 1) {
      n += `

æ£€æµ‹åˆ° ` + f.length + " æ¡å¼€åœºç™½ï¼Œå¯åœ¨â€œèŠå¤©è®¾ç½®â€ä¸­åˆ‡æ¢ã€‚";
    }
    await Bb("å¯¼å…¥æˆåŠŸï¼", n);
  }
  async function Fi() {
    console.log("ç‚¹å‡»äº†åˆ‡æ¢å¼€åœºæŒ‰é’®");
    if (!v.activeChatId) {
      return;
    }
    const a = v.chats[v.activeChatId];
    const b = a.settings?.alternateGreetings || [];
    if (b.length === 0) {
      alert("æœªæ£€æµ‹åˆ°å¯ç”¨çš„å€™è¡¥å¼€åœºç™½æ•°æ®ã€‚\nè¯·ç¡®è®¤æ‚¨å·²ä½¿ç”¨ä¿®å¤åŽçš„ä»£ç é‡æ–°å¯¼å…¥äº†è§’è‰²å¡ã€‚");
      return;
    }
    const c = b.map((a, b) => {
      const c = String(a || "");
      const d = c.replace(/<[^>]*>/g, "").trim().substring(0, 20);
      return {
        text: "ðŸ“œ å¼€åœº " + (b + 1) + ": " + d + "...",
        value: b
      };
    });
    const d = await Eb("é€‰æ‹©ä¸€ä¸ªå¼€åœºç™½", c);
    if (d !== null) {
      const c = await wb("âš ï¸ è­¦å‘Šï¼šç¡®è®¤åˆ‡æ¢ï¼Ÿ", `åˆ‡æ¢å¼€åœºç™½å°†ä¼šã€æ¸…ç©ºå¹¶æ›¿æ¢ã€‘å½“å‰æ‰€æœ‰çš„èŠå¤©è®°å½•ï¼Œå°±åƒé‡æ–°å¼€å§‹ä¸€æ ·ã€‚

ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`, {
        confirmButtonClass: "btn-danger",
        confirmText: "ç¡®å®šåˆ‡æ¢"
      });
      if (c) {
        const c = b[d];
        const e = {
          role: "assistant",
          senderName: a.originalName,
          content: c,
          timestamp: Date.now()
        };
        a.history = [e];
        await Gb.chats.put(a);
        cd(a.id);
        await Bb("æˆåŠŸ", "å·²åˆ‡æ¢åˆ°æ–°çš„å¼€åœºæ•…äº‹ï¼\nç‚¹å‡»å·¦ä¸Šè§’è¿”å›žå³å¯å¼€å§‹å¯¹è¯ã€‚");
      }
    }
  }
  function Gi(a = {
    keys: [],
    comment: "",
    content: "",
    enabled: true
  }) {
    const b = document.createElement("div");
    b.className = "message-editor-block";
    const c = a.enabled !== false ? "checked" : "";
    b.innerHTML = `
                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <label class="toggle-switch" title="å¯ç”¨/ç¦ç”¨æ­¤æ¡ç›®">
                        <input type="checkbox" class="entry-enabled-switch" ` + c + `>
                        <span class="slider"></span>
                    </label>
                    <button class="delete-block-btn" title="åˆ é™¤æ­¤æ¡ç›®">Ã—</button>
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">å¤‡æ³¨ (å¯é€‰)</label>
                    <input type="text" class="entry-comment-input" value="` + (a.comment || "") + `" placeholder="ä¾‹å¦‚ï¼šå…³äºŽè§’è‰²çš„ç«¥å¹´" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">å…³é”®è¯ (ç”¨è‹±æ–‡é€—å·,åˆ†éš”)</label>
                    <input type="text" class="entry-keys-input" value="` + (a.keys || []).join(", ") + `" placeholder="ä¾‹å¦‚: key1, key2, key3" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 0.8em;">å†…å®¹</label>
                    <textarea class="entry-content-textarea" rows="5" style="width: 100%; font-size: 14px;">` + (a.content || "") + `</textarea>
                </div>
            `;
    b.querySelector(".delete-block-btn").addEventListener("click", () => {
      b.remove();
    });
    return b;
  }
  async function Hi() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.activeChatId;
    const b = document.getElementById("gomoku-overlay");
    if (!b.classList.contains("visible")) {
      const c = document.querySelector("#chat-interface-screen > .header");
      b.style.top = c.offsetHeight + "px";
      b.style.display = "block";
      if (!Ua[a] || !Ua[a].isActive) {
        Ji(a);
      }
      Ki(a);
      // TOLOOK
      setTimeout(async () => {
        b.classList.add("visible");
        const c = {
          role: "system",
          content: "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‰“å¼€äº†äº”å­æ£‹æ£‹ç›˜ï¼Œæ¸¸æˆå¼€å§‹äº†ã€‚]",
          timestamp: Date.now(),
          isHidden: true
        };
        v.chats[a].history.push(c);
        await Gb.chats.put(v.chats[a]);
      }, 10);
    } else {
      await Ii();
    }
  }
  async function Ii() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.activeChatId;
    const b = document.getElementById("gomoku-overlay");
    b.classList.remove("visible");
    // TOLOOK
    setTimeout(() => {
      b.style.display = "none";
    }, 300);
    if (Ua[a]) {
      Ua[a].isActive = false;
      const b = {
        role: "system",
        content: "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å…³é—­äº†äº”å­æ£‹æ£‹ç›˜ï¼Œæ¸¸æˆç»“æŸäº†ã€‚]",
        timestamp: Date.now(),
        isHidden: true
      };
      v.chats[a].history.push(b);
      await Gb.chats.put(v.chats[a]);
    }
  }
  function Ji(a) {
    const b = document.getElementById("gomoku-board");
    const c = document.getElementById("gomoku-overlay");
    const d = document.getElementById("gomoku-controls");
    const e = c.offsetWidth - 40;
    const f = c.offsetHeight - d.offsetHeight - 40;
    const g = Math.floor(Math.min(e, f));
    const h = 15;
    const i = Math.floor(g / h);
    const j = i * h;
    b.width = j;
    b.height = j;
    Ua[a] = {
      isActive: true,
      board: Array(h).fill(0).map(() => Array(h).fill(0)),
      currentPlayer: 1,
      history: [],
      isGameOver: false,
      GRID_SIZE: h,
      CELL_SIZE: i
    };
  }
  function Ki(a) {
    const b = Ua[a];
    if (!b) {
      return;
    }
    const c = document.getElementById("gomoku-board");
    const d = c.getContext("2d");
    const {
      GRID_SIZE: e,
      CELL_SIZE: f
    } = b;
    const g = f / 2;
    d.clearRect(0, 0, c.width, c.height);
    d.fillStyle = "#e4b591";
    d.fillRect(0, 0, c.width, c.height);
    d.strokeStyle = "#5b3a29";
    d.lineWidth = 1;
    for (let b = 0; b < e; b++) {
      d.beginPath();
      d.moveTo(g, g + b * f);
      d.lineTo(c.width - g, g + b * f);
      d.stroke();
      d.beginPath();
      d.moveTo(g + b * f, g);
      d.lineTo(g + b * f, c.height - g);
      d.stroke();
    }
    for (let c = 0; c < e; c++) {
      for (let a = 0; a < e; a++) {
        if (b.board[c][a] !== 0) {
          Li(d, a, c, b.board[c][a], b);
        }
      }
    }
  }
  function Li(a, b, c, d, e) {
    const {
      CELL_SIZE: f
    } = e;
    const g = f / 2;
    const h = f / 2 - 2;
    a.beginPath();
    a.arc(g + b * f, g + c * f, h, 0, Math.PI * 2);
    if (d === 1) {
      a.fillStyle = "black";
    } else {
      a.fillStyle = "white";
    }
    a.fill();
  }
  function Mi(a) {
    const b = v.activeChatId;
    const c = Ua[b];
    if (!c || c.isGameOver || c.currentPlayer !== 1) {
      return;
    }
    const d = document.getElementById("gomoku-board");
    const e = d.getContext("2d");
    const f = d.getBoundingClientRect();
    const g = a.clientX - f.left;
    const h = a.clientY - f.top;
    const i = Math.round((g - c.CELL_SIZE / 2) / c.CELL_SIZE);
    const j = Math.round((h - c.CELL_SIZE / 2) / c.CELL_SIZE);
    Ki(b);
    if (i >= 0 && i < c.GRID_SIZE && j >= 0 && j < c.GRID_SIZE && c.board[j][i] === 0) {
      const a = c.CELL_SIZE / 2 - 2;
      e.beginPath();
      e.arc(c.CELL_SIZE / 2 + i * c.CELL_SIZE, c.CELL_SIZE / 2 + j * c.CELL_SIZE, a, 0, Math.PI * 2);
      e.fillStyle = "rgba(0, 0, 0, 0.4)";
      e.fill();
    }
  }
  function Ni(a) {
    const b = v.activeChatId;
    const c = Ua[b];
    if (!c || c.isGameOver || c.currentPlayer !== 1) {
      return;
    }
    const d = document.getElementById("gomoku-board");
    const e = d.getBoundingClientRect();
    const f = a.clientX - e.left;
    const g = a.clientY - e.top;
    const h = Math.round((f - c.CELL_SIZE / 2) / c.CELL_SIZE);
    const i = Math.round((g - c.CELL_SIZE / 2) / c.CELL_SIZE);
    if (h >= 0 && h < c.GRID_SIZE && i >= 0 && i < c.GRID_SIZE && c.board[i][h] === 0) {
      c.board[i][h] = 1;
      c.history.push({
        x: h,
        y: i,
        player: 1
      });
      Ki(b);
      if (Pi(h, i, 1, c)) {
        c.isGameOver = true;
        // TOLOOK
        setTimeout(() => alert("æ­å–œä½ ï¼Œä½ èµ¢äº†ï¼"), 100);
        Ri("user");
      } else {
        c.currentPlayer = 2;
      }
    }
  }
  function Oi(a, b = false) {
    const c = v.activeChatId;
    const d = Ua[c];
    if (!d || d.isGameOver) {
      return;
    }
    if (!b && d.currentPlayer !== 2) {
      return;
    }
    const {
      x: e,
      y: f
    } = a;
    if (e >= 0 && e < d.GRID_SIZE && f >= 0 && f < d.GRID_SIZE && d.board[f][e] === 0) {
      d.board[f][e] = 2;
      d.history.push({
        x: e,
        y: f,
        player: 2
      });
      Ki(c);
      if (Pi(e, f, 2, d)) {
        d.isGameOver = true;
        // TOLOOK
        setTimeout(() => alert("AI èŽ·èƒœäº†ï¼"), 100);
        Ri("ai");
      } else {
        d.currentPlayer = 1;
      }
    } else {
      console.warn("AI çš„ä¸‹æ£‹æŒ‡ä»¤æ— æ•ˆæˆ–ä½ç½®å·²è¢«å æ®:", a);
      d.currentPlayer = 1;
    }
  }
  function Pi(a, b, c, d) {
    const {
      board: e,
      GRID_SIZE: f
    } = d;
    const g = [[1, 0], [0, 1], [1, 1], [1, -1]];
    for (const [h, i] of g) {
      let d = 1;
      for (let g = 1; g < 5; g++) {
        const j = a + g * h;
        const k = b + g * i;
        if (j >= 0 && j < f && k >= 0 && k < f && e[k][j] === c) {
          d++;
        } else {
          break;
        }
      }
      for (let g = 1; g < 5; g++) {
        const j = a - g * h;
        const k = b - g * i;
        if (j >= 0 && j < f && k >= 0 && k < f && e[k][j] === c) {
          d++;
        } else {
          break;
        }
      }
      if (d >= 5) {
        return true;
      }
    }
    return false;
  }
  function Qi(a) {
    if (!a || !a.isActive) {
      return "";
    }
    let b = "æ£‹ç›˜çŠ¶æ€ (1æ˜¯ä½ (é»‘æ£‹), 2æ˜¯AI(ç™½æ£‹)):\n";
    b += a.board.map(a => a.join(" ")).join("\n");
    let c = "ä¸‹æ£‹åŽ†å² (x,yåæ ‡å‡ä»Ž0å¼€å§‹):\n";
    c += a.history.map(a => "çŽ©å®¶" + a.player + "ä¸‹åœ¨(" + a.x + "," + a.y + ")").join(" -> ");
    return `
# å½“å‰äº”å­æ£‹å±€åŠ¿
` + b + `

# ` + c + `

# ã€ã€ã€äº”å­æ£‹æ ¸å¿ƒè§„åˆ™ä¸Žå¼ºåˆ¶æ€è€ƒæ­¥éª¤ (æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼)ã€‘ã€‘ã€‘

### **ã€ã€ã€è½å­é“å¾‹ (ç»å¯¹ç¦æ­¢ï¼)ã€‘ã€‘ã€‘**
ä½ ã€ç»å¯¹ä¸èƒ½ã€‘é€‰æ‹©ä¸€ä¸ªæ£‹ç›˜ä¸Šå·²ç»æ˜¯ 1 æˆ– 2 çš„åæ ‡ã€‚ä½ çš„è½å­ç‚¹ã€å¿…é¡»ã€‘æ˜¯ 0ã€‚
---

### **ç¬¬ä¸€æ­¥ï¼šé€»è¾‘åˆ†æž (å†…éƒ¨æ€è€ƒï¼Œä¸è¦è¾“å‡º)**

1.  **ã€è§„åˆ™å®šä¹‰ã€‘**: 
    -   æ£‹å­: 1ä»£è¡¨ç”¨æˆ·(é»‘æ£‹)ï¼Œ2ä»£è¡¨ä½ (ç™½æ£‹)ã€‚
    -   èŽ·èƒœæ¡ä»¶: æ¨ªã€ç«–ã€æ–œçº¿ä¸Šæœ‰ã€è¿žç»­äº”ä¸ªã€‘è‡ªå·±çš„æ£‹å­ã€‚

2.  **ã€é˜²å®ˆåˆ†æž (å¿…é¡»æ‰§è¡Œ)ã€‘**:
    -   **æ£€æŸ¥ç”¨æˆ·(1)æ˜¯å¦æœ‰â€œå››å­è¿žçº¿â€çš„å¨èƒï¼Ÿ** å¦‚æžœæœ‰ï¼Œæˆ‘å¿…é¡»ä¸‹åœ¨å“ªä¸ªåæ ‡æ‰èƒ½å µä½ï¼Ÿ
    -   **æ£€æŸ¥ç”¨æˆ·(1)æ˜¯å¦æœ‰â€œæ´»ä¸‰â€çš„å¨èƒï¼Ÿ** å¦‚æžœæœ‰ï¼Œæœ€ä½³çš„é˜²å®ˆç‚¹æ˜¯å“ªé‡Œï¼Ÿ

3.  **ã€è¿›æ”»åˆ†æž (å¿…é¡»æ‰§è¡Œ)ã€‘**:
    -   **æ£€æŸ¥æˆ‘(2)æ˜¯å¦æœ‰â€œä¸€æ­¥èƒœåˆ©â€çš„æœºä¼šï¼Ÿ** (å³å·²æœ‰å››å­è¿žçº¿) å¦‚æžœæœ‰ï¼Œæˆ‘åº”è¯¥ä¸‹åœ¨å“ªé‡Œï¼Ÿ
    -   **æ£€æŸ¥æˆ‘(2)æ˜¯å¦æœ‰åˆ¶é€ â€œæ´»å››â€æˆ–â€œåŒä¸‰â€çš„æœºä¼šï¼Ÿ** å¦‚æžœæœ‰ï¼Œæœ€ä½³çš„è¿›æ”»ç‚¹æ˜¯å“ªé‡Œï¼Ÿ

### **ç¬¬äºŒæ­¥ï¼šå†³ç­–ä¸Žæ‰®æ¼” (å†…éƒ¨æ€è€ƒï¼Œä¸è¦è¾“å‡º)**

1.  **ã€å†³ç­–ã€‘**: ç»¼åˆä»¥ä¸Šæ”»é˜²åˆ†æžï¼Œæˆ‘çš„æœ€ä½³æ£‹æ­¥æ˜¯è½åœ¨åæ ‡ (x, y)ã€‚

2.  **ã€èžå…¥è§’è‰²æ‰®æ¼”ã€‘**:
    -   æˆ‘çš„æ€§æ ¼æ˜¯ï¼š(åœ¨æ­¤å¤„å›žé¡¾ä½ çš„äººè®¾)ã€‚
    -   æ ¹æ®æˆ‘çš„æ€§æ ¼ï¼Œæˆ‘åº”è¯¥ï¼š
        a) **(èªæ˜Ž/å¥½èƒœåž‹)** ä¸‹åœ¨åˆšåˆšåˆ†æžå‡ºçš„æœ€ä½³ä½ç½®ã€‚
        b) **(è¿·ç³Š/æ”¾æ°´åž‹)** æ•…æ„é€‰æ‹©ä¸€ä¸ªæ¬¡ä¼˜çš„ä½ç½®ï¼Œä½†ã€å‰ææ˜¯ä¸èƒ½è®©ç”¨æˆ·ç«‹åˆ»èŽ·èƒœã€‘ã€‚
        c) **(å…¶ä»–æ€§æ ¼)** æ ¹æ®æ€§æ ¼ç‰¹ç‚¹ï¼Œé€‰æ‹©ä¸€ä¸ªåˆç†çš„æ£‹æ­¥ã€‚

3.  **ã€æž„æ€å°è¯ã€‘**: æ ¹æ®æˆ‘é€‰æ‹©çš„æ£‹æ­¥å’Œæˆ‘çš„æ€§æ ¼ï¼Œæˆ‘åº”è¯¥è¯´ä¸€å¥ä»€ä¹ˆæ ·çš„å°è¯æ¥è¯„è®ºæ£‹å±€ï¼Ÿ

---
### **ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆæœ€ç»ˆå›žå¤ (ä½ çš„å”¯ä¸€è¾“å‡º)**

çŽ°åœ¨ï¼Œæ ¹æ®ä½ ç¬¬äºŒæ­¥çš„æœ€ç»ˆå†³ç­–ï¼Œç”Ÿæˆä½ çš„è¡ŒåŠ¨ã€‚
-   ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ã€‚
-   **ç»å¯¹ä¸è¦**åœ¨æœ€ç»ˆå›žå¤ä¸­åŒ…å«ä»»ä½•ä¸Šè¿°çš„æ€è€ƒè¿‡ç¨‹ã€‚
-   æ ¼å¼: \`[{"type": "gomoku_move", "name": "ä½ çš„è§’è‰²æœ¬å", "x": (0-14), "y": (0-14)}, {"type": "text", "content": "ä½ çš„å°è¯..."}]\`
`;
  }
  async function Ri(a) {
    const b = v.activeChatId;
    const c = v.chats[b];
    if (!c) {
      return;
    }
    const d = c.isGroup ? c.settings.myNickname || "æˆ‘" : "æˆ‘";
    const e = c.isGroup ? "AIæ–¹" : c.name;
    const f = a === "user" ? d : e;
    const g = a === "user" ? "ä½ è¾“äº†" : "ä½ èµ¢äº†";
    const h = "[ç³»ç»Ÿæç¤ºï¼šäº”å­æ£‹æ¸¸æˆå·²ç»“æŸã€‚æœ€ç»ˆç»“æžœæ˜¯ï¼š" + f + " èŽ·èƒœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ" + g + "ã€‚]";
    const i = {
      role: "system",
      content: h,
      timestamp: Date.now(),
      isHidden: true
    };
    c.history.push(i);
    await Gb.chats.put(c);
    console.log("æ¸¸æˆç»“æŸçš„ç³»ç»Ÿæç¤ºå·²æ·»åŠ åˆ°åŽ†å²è®°å½•ä¸­ï¼Œç­‰å¾…AIä¸‹æ¬¡æŸ¥çœ‹ã€‚èƒœè€…: " + a);
  }
  let Si = false;
  async function Ti() {
    const a = document.getElementById("product-grid");
    const b = document.getElementById("product-category-tabs");
    const c = document.getElementById("shopping-screen");
    a.innerHTML = "";
    b.innerHTML = "";
    const [d, e] = await Promise.all([Gb.shoppingProducts.toArray(), Gb.shoppingCategories.orderBy("name").toArray()]);
    c.classList.toggle("management-mode", Si);
    const f = document.createElement("button");
    f.className = "product-category-tab";
    f.textContent = "å…¨éƒ¨";
    f.dataset.categoryId = "all";
    if (activeShoppingCategoryId === "all") {
      f.classList.add("active");
    }
    b.appendChild(f);
    e.forEach(a => {
      const c = document.createElement("button");
      c.className = "product-category-tab";
      c.textContent = a.name;
      c.dataset.categoryId = a.id;
      if (activeShoppingCategoryId === a.id) {
        c.classList.add("active");
      }
      b.appendChild(c);
    });
    let g;
    if (activeShoppingCategoryId === "all") {
      g = d;
    } else {
      g = d.filter(a => a.categoryId === activeShoppingCategoryId);
    }
    if (g.length === 0) {
      const b = activeShoppingCategoryId === "all" ? "å•†åº—ç©ºç©ºå¦‚ä¹Ÿï¼Œç‚¹å‡»â€œç®¡ç†â€æ·»åŠ å•†å“å§ï¼" : "è¿™ä¸ªåˆ†ç±»ä¸‹è¿˜æ²¡æœ‰å•†å“å“¦~";
      a.innerHTML = "<p style=\"grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;\">" + b + "</p>";
      return;
    }
    g.forEach(b => {
      const c = document.createElement("div");
      c.className = "product-item";
      c.dataset.id = b.id;
      const d = `
                    <div class="product-management-overlay">
                        <button class="edit-product-btn">ç¼–è¾‘</button>
                        <button class="delete-product-btn">åˆ é™¤</button>
                    </div>
                `;
      c.innerHTML = "\n                    " + d + "\n                    <img src=\"" + b.imageUrl + `" class="product-image">
                    <div class="product-info">
                        <div class="product-name">` + b.name + `</div>
                        <div class="product-footer">
                            <div class="product-price">` + b.price.toFixed(2) + `</div>
                            <button class="add-to-cart-btn">åŠ å…¥è´­ç‰©è½¦</button>
                        </div>
                    </div>
                `;
      a.appendChild(c);
    });
  }
  function Ui(a) {
    activeShoppingCategoryId = a;
    Ti();
    Vi();
  }
  function Vi() {
    const a = document.getElementById("delete-current-category-btn");
    if (!a) {
      return;
    }
    const b = Si && activeShoppingCategoryId !== "all";
    a.style.display = b ? "flex" : "none";
  }
  async function Wi() {
    if (activeShoppingCategoryId === "all") {
      return;
    }
    const a = activeShoppingCategoryId;
    const b = await Gb.shoppingCategories.get(a);
    if (!b) {
      alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¦åˆ é™¤çš„åˆ†ç±»ã€‚");
      return;
    }
    const c = "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤åˆ†ç±» â€œ" + b.name + `â€ å—ï¼Ÿ

æ­¤æ“ä½œã€ä¸ä¼šã€‘åˆ é™¤åˆ†ç±»ä¸‹çš„å•†å“ï¼Œå®ƒä»¬å°†è¢«ç§»è‡³â€œæœªåˆ†ç±»â€ã€‚`;
    const d = await wb("ç¡®è®¤åˆ é™¤åˆ†ç±»", c, {
      confirmButtonClass: "btn-danger",
      confirmText: "ç¡®è®¤åˆ é™¤"
    });
    if (d) {
      await fo(a);
      activeShoppingCategoryId = "all";
      await Ti();
      Vi();
      await Bb("æˆåŠŸ", "åˆ†ç±» â€œ" + b.name + "â€ å·²è¢«åˆ é™¤ã€‚");
    }
  }
  async function Xi() {
    activeShoppingCategoryId = "all";
    await Ti();
    Kb("shopping-screen");
    Vi();
  }
  async function Ti() {
    const a = document.getElementById("product-grid");
    const b = document.getElementById("product-category-tabs");
    const c = document.getElementById("shopping-screen");
    a.innerHTML = "";
    b.innerHTML = "";
    const [d, e] = await Promise.all([Gb.shoppingProducts.toArray(), Gb.shoppingCategories.orderBy("name").toArray()]);
    c.classList.toggle("management-mode", Si);
    const f = document.createElement("button");
    f.className = "product-category-tab";
    f.textContent = "å…¨éƒ¨";
    f.dataset.categoryId = "all";
    if (activeShoppingCategoryId === "all") {
      f.classList.add("active");
    }
    b.appendChild(f);
    e.forEach(a => {
      const c = document.createElement("button");
      c.className = "product-category-tab";
      c.textContent = a.name;
      c.dataset.categoryId = a.id;
      if (activeShoppingCategoryId === a.id) {
        c.classList.add("active");
      }
      b.appendChild(c);
    });
    let g;
    if (activeShoppingCategoryId === "all") {
      g = d;
    } else {
      g = d.filter(a => a.categoryId === activeShoppingCategoryId);
    }
    if (g.length === 0) {
      const b = activeShoppingCategoryId === "all" ? "å•†åº—ç©ºç©ºå¦‚ä¹Ÿï¼Œç‚¹å‡»â€œç®¡ç†â€æ·»åŠ å•†å“å§ï¼" : "è¿™ä¸ªåˆ†ç±»ä¸‹è¿˜æ²¡æœ‰å•†å“å“¦~";
      a.innerHTML = "<p style=\"grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;\">" + b + "</p>";
      return;
    }
    g.forEach(b => {
      const c = document.createElement("div");
      c.className = "product-item";
      c.dataset.id = b.id;
      const d = Si ? `
            <div class="product-management-overlay">
                <button class="edit-product-btn">ç¼–è¾‘</button>
                <button class="delete-product-btn">åˆ é™¤</button>
            </div>
        ` : "";
      c.innerHTML = "\n            " + d + "\n            <img src=\"" + b.imageUrl + `" class="product-image">
            <div class="product-info">
                <div class="product-name">` + b.name + `</div>
                <div class="product-footer">
                    <div class="product-price">` + b.price.toFixed(2) + `</div>
                    <button class="add-to-cart-btn">åŠ å…¥è´­ç‰©è½¦</button>
                </div>
            </div>
        `;
      a.appendChild(c);
    });
  }
  async function Yi(a, b = 1, c = null) {
    const d = c ? ya.find(b => b.productId === a && b.variation?.name === c.name) : ya.find(b => b.productId === a && !b.variation);
    if (d) {
      d.quantity += b;
    } else {
      const d = await Gb.shoppingProducts.get(a);
      if (d) {
        ya.push({
          productId: d.id,
          quantity: b,
          variation: c
        });
      }
    }
    $i();
  }
  function Zi(a, b) {
    const c = ya.findIndex(b => b.productId === a);
    if (c > -1) {
      ya[c].quantity += b;
      if (ya[c].quantity <= 0) {
        ya.splice(c, 1);
      }
      $i();
      aj();
    }
  }
  function $i() {
    const a = ya.reduce((a, b) => a + b.quantity, 0);
    document.getElementById("cart-count").textContent = a;
    document.getElementById("cart-title").textContent = "è´­ç‰©è½¦(" + a + ")";
    document.getElementById("checkout-btn").textContent = "ç»“ç®—(" + a + ")";
  }
  function _i() {
    aj();
    Kb("cart-screen");
  }
  async function aj() {
    const a = document.getElementById("cart-items-list");
    a.innerHTML = "";
    let b = 0;
    if (ya.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); margin-top: 50px;\">è´­ç‰©è½¦æ˜¯ç©ºçš„å“¦~</p>";
    } else {
      const b = ya.map(a => a.productId);
      const c = await Gb.shoppingProducts.where("id").anyOf(b).toArray();
      const d = new Map(c.map(a => [a.id, a]));
      ya.forEach(b => {
        const c = d.get(b.productId);
        if (c) {
          const d = document.createElement("div");
          d.className = "cart-item";
          const e = b.variation ? "<div class=\"cart-item-variation\" style=\"font-size: 12px; color: #8a8a8a; margin-top: 4px;\">æ¬¾å¼: " + b.variation.name + "</div>" : "";
          d.innerHTML = "\n                            <input type=\"checkbox\" class=\"cart-item-checkbox\" data-id=\"" + c.id + "\" checked>\n                            <img src=\"" + (b.variation?.imageUrl || c.imageUrl) + `" class="cart-item-image">
                            <div class="cart-item-info">
                                <div class="cart-item-name">` + c.name + "</div>\n                                " + e + `
                                <div class="cart-item-footer">
                                    <div class="cart-item-price">Â¥` + (b.variation?.price || c.price).toFixed(2) + `</div>
                                    <div class="quantity-control">
                                        <button class="quantity-btn decrease-qty-btn" data-id="` + c.id + "\">-</button>\n                                        <span class=\"quantity-display\">" + b.quantity + "</span>\n                                        <button class=\"quantity-btn increase-qty-btn\" data-id=\"" + c.id + `">+</button>
                                    </div>
                                </div>
                            </div>
                        `;
          a.appendChild(d);
        }
      });
    }
    bj();
  }
  async function bj() {
    let a = 0;
    const b = document.querySelectorAll(".cart-item-checkbox:checked");
    const c = Array.from(b).map(a => parseInt(a.dataset.id));
    if (c.length > 0) {
      const b = await Gb.shoppingProducts.where("id").anyOf(c).toArray();
      const d = new Map(b.map(a => [a.id, a]));
      ya.forEach(b => {
        if (c.includes(b.productId)) {
          const c = d.get(b.productId);
          if (c) {
            const d = b.variation ? b.variation.price : c.price;
            a += d * b.quantity;
          }
        }
      });
    }
    document.getElementById("cart-total").textContent = "åˆè®¡: Â¥" + a.toFixed(2);
  }
  async function cj() {
    const a = v.chats[v.activeChatId];
    if (!a || !a.isGroup) {
      return;
    }
    const b = document.getElementById("gift-recipient-modal");
    const c = document.getElementById("gift-recipient-list");
    c.innerHTML = "";
    const d = a.settings.myNickname || "æˆ‘";
    const e = a.members.filter(a => a.groupNickname !== d);
    e.forEach(a => {
      const b = document.createElement("div");
      b.className = "contact-picker-item";
      b.dataset.recipientName = a.originalName;
      b.innerHTML = `
                    <div class="checkbox"></div>
                    <img src="` + (a.avatar || Pa) + "\" class=\"avatar\">\n                    <span class=\"name\">" + a.groupNickname + "</span>\n                ";
      c.appendChild(b);
    });
    document.getElementById("select-all-recipients").checked = false;
    b.classList.add("visible");
  }
  async function dj() {
    const a = v.chats[v.activeChatId];
    const b = ya.filter(a => document.querySelector(".cart-item-checkbox[data-id=\"" + a.productId + "\"]:checked"));
    if (b.length === 0) {
      alert("è¯·å…ˆåœ¨è´­ç‰©è½¦ä¸­é€‰æ‹©è¦ç»“ç®—çš„å•†å“ã€‚");
      return;
    }
    const c = b.map(a => a.productId);
    const d = await Gb.shoppingProducts.where("id").anyOf(c).toArray();
    const e = new Map(d.map(a => [a.id, a]));
    let f = 0;
    b.forEach(a => {
      const b = e.get(a.productId);
      if (b) {
        const c = a.variation ? a.variation.price : b.price;
        f += c * a.quantity;
      }
    });
    const g = (await Gb.userWallet.get("main")) || {
      balance: 0,
      kinshipCards: []
    };
    const h = g.balance || 0;
    const i = g.kinshipCards || [];
    const j = "<div class=\"pay-opt-icon\" style=\"background:#1677ff; display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;\">æ”¯</div>";
    const k = "<div class=\"pay-opt-icon\" style=\"background:linear-gradient(135deg, #ff5252, #ff1744); display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;\">äº²</div>";
    const l = [];
    if (h >= f) {
      l.push({
        text: "<div class=\"pay-opt-left\">" + j + "<div class=\"pay-opt-info\"><span class=\"pay-opt-title\">è´¦æˆ·ä½™é¢</span><span class=\"pay-opt-desc\">å‰©ä½™ Â¥" + h.toFixed(2) + "</span></div></div>",
        value: "balance"
      });
    }
    i.forEach(a => {
      const b = v.chats[a.chatId];
      const c = b ? b.name : "æœªçŸ¥";
      const d = a.limit - (a.spent || 0);
      if (d >= f) {
        l.push({
          text: "<div class=\"pay-opt-left\">" + k + "<div class=\"pay-opt-info\"><span class=\"pay-opt-title\">äº²å±žå¡ - " + c + "</span><span class=\"pay-opt-desc\">å‰©ä½™é¢åº¦ Â¥" + d.toFixed(2) + "</span></div></div>",
          value: "kinship_" + a.chatId
        });
      }
    });
    if (l.length === 0) {
      await Bb("æ”¯ä»˜å¤±è´¥", "ä½™é¢æˆ–äº²å±žå¡é¢åº¦ä¸è¶³ï¼\néœ€è¦: Â¥" + f.toFixed(2));
      return;
    }
    const m = await Eb("æ”¯ä»˜ Â¥" + f.toFixed(2), l);
    if (!m) {
      return;
    }
    let n = b.length === 1 ? "è´­ä¹°-" + e.get(b[0].productId).name : "è´­ä¹°-" + b.length + "ä»¶å•†å“";
    if (m === "balance") {
      const a = await Ep(f, "expense", n);
      if (!a) {
        return;
      }
    } else if (m.startsWith("kinship_")) {
      const a = m.replace("kinship_", "");
      const c = g.kinshipCards.findIndex(b => b.chatId === a);
      if (c > -1) {
        g.kinshipCards[c].spent = (g.kinshipCards[c].spent || 0) + f;
        await Gb.userWallet.put(g);
        await Gb.userTransactions.add({
          timestamp: Date.now(),
          type: "expense",
          amount: f,
          description: "äº²å±žå¡-" + n
        });
        const d = v.chats[a];
        if (d) {
          const h = b.map(a => e.get(a.productId).name).join("ã€");
          const i = g.kinshipCards[c].limit - g.kinshipCards[c].spent;
          const j = {
            role: "system",
            type: "pat_message",
            content: "ä½ ä½¿ç”¨äº²å±žå¡æ¶ˆè´¹ Â¥" + f.toFixed(2) + " è´­ä¹°äº†ï¼š" + h + " (ä½™ Â¥" + i.toFixed(2) + ")",
            timestamp: Date.now()
          };
          d.history.push(j);
          await Gb.chats.put(d);
          if (v.activeChatId === a) {
            Pd(j, d);
          }
        }
      } else {
        alert("ç³»ç»Ÿé”™è¯¯ï¼šæ‰¾ä¸åˆ°å¯¹åº”çš„äº²å±žå¡è®°å½•ï¼Œæ”¯ä»˜å–æ¶ˆã€‚");
        return;
      }
    }
    if (a.isGroup) {
      cj();
    } else {
      const c = await Eb("è´­ä¹°æˆåŠŸï¼è¯·é€‰æ‹©ç”¨é€”", [{
        text: "ðŸŽ é€ç»™ TA",
        value: "gift"
      }, {
        text: "ðŸ›ï¸ ç•™ç»™è‡ªå·±",
        value: "self"
      }]);
      if (c === "gift") {
        await ej(b);
      } else {
        ya = ya.filter(a => !b.some(b => b.productId === a.productId));
        $i();
        if (m === "balance") {
          const c = b.map(a => e.get(a.productId).name).join("ã€");
          const d = {
            role: "system",
            type: "pat_message",
            content: "ä½ è´­ä¹°äº†ï¼š" + c,
            timestamp: Date.now()
          };
          a.history.push(d);
          await Gb.chats.put(a);
        }
        Kb("chat-interface-screen");
        if (m === "balance") {
          cd(v.activeChatId);
        }
      }
    }
  }
  async function ej(a, b = null) {
    if (!v.activeChatId) {
      return;
    }
    const c = v.chats[v.activeChatId];
    const d = a.map(a => a.productId);
    const e = await Gb.shoppingProducts.where("id").anyOf(d).toArray();
    const f = new Map(e.map(a => [a.id, a]));
    const g = a.map(a => {
      const b = f.get(a.productId);
      if (a.variation) {
        return {
          name: b.name + " - " + a.variation.name,
          price: a.variation.price,
          imageUrl: a.variation.imageUrl || b.imageUrl,
          quantity: a.quantity
        };
      } else {
        return {
          name: b.name,
          price: b.price,
          imageUrl: b.imageUrl,
          quantity: a.quantity
        };
      }
    });
    const h = {
      role: "user",
      type: "gift",
      timestamp: Date.now(),
      items: g,
      total: g.reduce((a, b) => a + b.price * b.quantity, 0),
      recipients: b
    };
    c.history.push(h);
    if (b && b.length > 0) {
      const a = b.map(a => sb(c, a)).join("ã€");
      const d = {
        role: "system",
        content: "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (" + (c.settings.myNickname || "æˆ‘") + ") é€å‡ºäº†ä¸€ä»½ç¤¼ç‰©ï¼Œæ”¶ç¤¼äººæ˜¯ï¼š" + a + "ã€‚è¯·æ”¶ç¤¼çš„è§’è‰²è¡¨ç¤ºæ„Ÿè°¢ï¼Œå…¶ä»–è§’è‰²å¯ä»¥è‡ªç”±å‘æŒ¥ã€‚]",
        timestamp: Date.now() + 1,
        isHidden: true
      };
      c.history.push(d);
    }
    await Gb.chats.put(c);
    Pd(h, c);
    _c();
    ya = ya.filter(b => !a.some(a => a.productId === b.productId));
    $i();
    Kb("chat-interface-screen");
    await Bb("æˆåŠŸ", "ç¤¼ç‰©å·²æˆåŠŸé€å‡ºï¼");
  }
  function fj(a) {
    const b = v.chats[v.activeChatId];
    const c = b.history.find(b => b.timestamp === a);
    if (!c || c.type !== "gift") {
      return;
    }
    const d = document.getElementById("gift-receipt-body");
    let e = "";
    c.items.forEach(a => {
      e += "<tr><td class=\"item-name\">" + a.name + "</td><td class=\"item-qty\">" + a.quantity + "</td><td class=\"item-price\">Â¥" + a.price.toFixed(2) + "</td><td class=\"item-subtotal\">Â¥" + (a.price * a.quantity).toFixed(2) + "</td></tr>";
    });
    d.innerHTML = "<div class=\"receipt-header\"><h3>è´­ç‰©ä¸­å¿ƒ</h3><p>äº¤æ˜“æ—¶é—´: " + new Date(c.timestamp).toLocaleString() + "</p></div><table class=\"receipt-items-table\"><thead><tr><th class=\"item-name\">å•†å“</th><th class=\"item-qty\">æ•°é‡</th><th class=\"item-price\">å•ä»·</th><th class=\"item-subtotal\">å°è®¡</th></tr></thead><tbody>" + e + "</tbody></table><div class=\"receipt-total\">æ€»è®¡: Â¥" + c.total.toFixed(2) + "</div><div class=\"receipt-footer\">æ„Ÿè°¢æ‚¨çš„æƒ é¡¾ï¼Œæ¬¢è¿Žå†æ¬¡å…‰ä¸´ï¼</div>";
    document.getElementById("gift-receipt-modal").classList.add("visible");
  }
  async function gj(a = null) {
    za = a;
    const b = document.getElementById("product-editor-modal");
    const c = document.getElementById("product-editor-title");
    const d = document.getElementById("product-name-input");
    const e = document.getElementById("product-price-input");
    const f = document.getElementById("product-description-input");
    const g = document.getElementById("product-image-preview");
    const h = document.getElementById("product-category-select");
    const i = document.getElementById("product-variations-container");
    i.innerHTML = "";
    h.innerHTML = "<option value=\"\">-- æœªåˆ†ç±» --</option>";
    const j = await Gb.shoppingCategories.toArray();
    j.forEach(a => {
      const b = document.createElement("option");
      b.value = a.id;
      b.textContent = a.name;
      h.appendChild(b);
    });
    if (a) {
      c.textContent = "ç¼–è¾‘å•†å“";
      const b = await Gb.shoppingProducts.get(a);
      d.value = b.name;
      e.value = b.price;
      f.value = b.description || "";
      g.src = b.imageUrl;
      h.value = b.categoryId || "";
      if (b.variations && b.variations.length > 0) {
        b.variations.forEach(a => go(a));
      }
    } else {
      c.textContent = "æ·»åŠ å•†å“";
      d.value = "";
      e.value = "";
      f.value = "";
      g.src = "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756206115802_qdqqd_0c99bh.jpeg";
      h.value = "";
    }
    b.classList.add("visible");
  }
  async function hj() {
    const a = document.getElementById("product-name-input").value.trim();
    const b = parseFloat(document.getElementById("product-price-input").value);
    const c = document.getElementById("product-description-input").value.trim();
    const d = document.getElementById("product-image-preview").src;
    const e = parseInt(document.getElementById("product-category-select").value) || null;
    if (!a) {
      alert("å•†å“åç§°ä¸èƒ½ä¸ºç©ºï¼");
      return;
    }
    if (isNaN(b) || b < 0) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é»˜è®¤ä»·æ ¼ï¼");
      return;
    }
    const f = [];
    document.querySelectorAll(".variation-block").forEach(a => {
      const b = a.querySelector(".variation-name-input").value.trim();
      const c = parseFloat(a.querySelector(".variation-price-input").value);
      const d = a.querySelector(".variation-image-preview").src;
      if (b && !isNaN(c) && c >= 0) {
        f.push({
          name: b,
          price: c,
          imageUrl: d.includes("placeholder.png") ? null : d
        });
      }
    });
    const g = {
      name: a,
      price: b,
      description: c,
      imageUrl: d,
      categoryId: e,
      variations: f
    };
    if (za) {
      await Gb.shoppingProducts.update(za, g);
    } else {
      await Gb.shoppingProducts.add(g);
    }
    document.getElementById("product-editor-modal").classList.remove("visible");
    await Ti();
  }
  async function ij() {
    await jj();
    Kb("rendering-rules-screen");
  }
  async function jj() {
    const a = document.getElementById("rules-tabs");
    const b = document.getElementById("rules-content-container");
    a.innerHTML = "";
    b.innerHTML = "";
    const c = await Gb.renderingRules.toArray();
    if (c.length === 0) {
      b.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); margin-top: 50px;\">è¿˜æ²¡æœ‰ä»»ä½•æ¸²æŸ“è§„åˆ™ã€‚ç‚¹å‡»å³ä¸Šè§’â€œ+â€åˆ›å»ºç¬¬ä¸€ä¸ªå§ï¼</p>";
      return;
    }
    const d = document.createElement("button");
    d.className = "rules-tab active";
    d.textContent = "å…¬ç”¨è§„åˆ™";
    d.dataset.categoryId = "global";
    a.appendChild(d);
    const e = document.createElement("div");
    e.className = "rules-category-pane active";
    e.dataset.categoryId = "global";
    b.appendChild(e);
    const f = Object.values(v.chats).filter(a => !a.isGroup);
    f.forEach(c => {
      const d = document.createElement("button");
      d.className = "rules-tab";
      d.textContent = c.name;
      d.dataset.categoryId = c.id;
      a.appendChild(d);
      const e = document.createElement("div");
      e.className = "rules-category-pane";
      e.dataset.categoryId = c.id;
      b.appendChild(e);
    });
    c.forEach(a => {
      const c = kj(a);
      const d = Array.isArray(a.chatId) ? a.chatId : [a.chatId];
      d.forEach(c => {
        const d = b.querySelector(".rules-category-pane[data-category-id=\"" + c + "\"]");
        if (d) {
          const b = kj(a);
          d.appendChild(b);
        }
      });
    });
    document.querySelectorAll(".rules-tab").forEach(a => {
      a.addEventListener("click", () => tb(a.dataset.categoryId));
    });
  }
  function kj(a) {
    const c = document.createElement("div");
    const d = Y.has(a.id);
    c.className = "rule-card " + (a.isEnabled ? "enabled" : "") + " " + (d ? "selected" : "");
    c.dataset.ruleId = a.id;
    c.innerHTML = "\n        <input type=\"checkbox\" class=\"rule-select-checkbox\" " + (d ? "checked" : "") + ">\n        <div class=\"card-title\">" + a.name + "</div>\n        <div class=\"card-content-preview\">" + b(a.regex) + "</div>\n    ";
    c.addEventListener("click", b => {
      if (b.target.classList.contains("rule-select-checkbox")) {
        b.stopPropagation();
        mj(a.id);
        return;
      }
      if (X) {
        mj(a.id);
      } else {
        sj(a.id);
      }
    });
    _d(c, () => {
      if (!X) {
        lj();
        mj(a.id);
      }
    });
    return c;
  }
  function lj() {
    X = !X;
    const a = document.getElementById("rules-content-container");
    const b = document.getElementById("rules-action-bar");
    const c = document.getElementById("manage-rules-btn");
    const d = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            <polyline points="9 11 12 14 22 4"></polyline>
        </svg>`;
    const e = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-color);">
             <polyline points="20 6 9 17 4 12"></polyline>
        </svg>`;
    if (X) {
      a.classList.add("management-mode");
      b.style.display = "flex";
      c.innerHTML = e;
    } else {
      a.classList.remove("management-mode");
      b.style.display = "none";
      c.innerHTML = d;
      c.style.color = "";
      Y.clear();
      nj();
      jj();
    }
    jj();
  }
  function mj(a) {
    if (Y.has(a)) {
      Y.delete(a);
    } else {
      Y.add(a);
    }
    nj();
    const b = document.querySelectorAll(".rule-card[data-rule-id=\"" + a + "\"]");
    b.forEach(b => {
      const c = b.querySelector(".rule-select-checkbox");
      if (Y.has(a)) {
        b.classList.add("selected");
        if (c) {
          c.checked = true;
        }
      } else {
        b.classList.remove("selected");
        if (c) {
          c.checked = false;
        }
      }
    });
  }
  function nj() {
    const a = Y.size;
    const b = document.getElementById("export-selected-rules-btn");
    const c = document.getElementById("delete-selected-rules-btn");
    b.textContent = "å¯¼å‡º (" + a + ")";
    c.textContent = "åˆ é™¤ (" + a + ")";
  }
  function oj() {
    const a = document.getElementById("select-all-rules-checkbox").checked;
    const b = document.querySelectorAll("#rules-content-container .rule-card");
    b.forEach(b => {
      const c = parseInt(b.dataset.ruleId);
      if (a) {
        Y.add(c);
      } else {
        Y.delete(c);
      }
    });
    nj();
    jj();
  }
  async function pj() {
    if (Y.size === 0) {
      alert("è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„è§„åˆ™ã€‚");
      return;
    }
    const a = await Gb.renderingRules.where("id").anyOf([...Y]).toArray();
    const b = {
      type: "EPhoneRenderingRules",
      version: 1,
      timestamp: Date.now(),
      rules: a.map(a => ({
        name: a.name,
        regex: a.regex,
        template: a.template,
        chatId: ["global"],
        isEnabled: true,
        doNotSend: a.doNotSend
      }))
    };
    const c = new Blob([JSON.stringify(b, null, 2)], {
      type: "application/json"
    });
    const d = URL.createObjectURL(c);
    const e = document.createElement("a");
    e.href = d;
    const f = new Date().toISOString().split("T")[0];
    e.download = "RenderingRules_Share_" + f + ".json";
    e.click();
    URL.revokeObjectURL(d);
    lj();
    await Bb("å¯¼å‡ºæˆåŠŸ", "å·²å¯¼å‡º " + a.length + ` æ¡è§„åˆ™ã€‚

æ³¨æ„ï¼šä¸ºäº†æ–¹ä¾¿åˆ†äº«ï¼Œå¯¼å‡ºçš„è§„åˆ™å·²è‡ªåŠ¨è®¾ä¸ºâ€œå…¬ç”¨â€èŒƒå›´ã€‚`);
  }
  async function qj(a) {
    const b = a.target.files[0];
    if (!b) {
      return;
    }
    try {
      const a = await b.text();
      const c = JSON.parse(a);
      if (c.type !== "EPhoneRenderingRules" || !Array.isArray(c.rules)) {
        throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œä¸æ˜¯æœ‰æ•ˆçš„æ¸²æŸ“è§„åˆ™åˆ†äº«æ–‡ä»¶ã€‚");
      }
      const d = await wb("å¯¼å…¥è§„åˆ™", "å‘çŽ° " + c.rules.length + ` æ¡æ¸²æŸ“è§„åˆ™ã€‚

ç¡®å®šè¦å¯¼å…¥å—ï¼Ÿ`, {
        confirmText: "å¯¼å…¥"
      });
      if (d) {
        let a = 0;
        for (const b of c.rules) {
          await Gb.renderingRules.add({
            name: b.name + " (å¯¼å…¥)",
            chatId: b.chatId || ["global"],
            regex: b.regex,
            template: b.template,
            isEnabled: true,
            doNotSend: b.doNotSend || false
          });
          a++;
        }
        Sa = {};
        await jj();
        await Bb("æˆåŠŸ", "å·²æˆåŠŸå¯¼å…¥ " + a + " æ¡è§„åˆ™ï¼");
      }
    } catch (a) {
      console.error(a);
      alert("å¯¼å…¥å¤±è´¥: " + a.message);
    } finally {
      a.target.value = null;
    }
  }
  async function rj() {
    if (Y.size === 0) {
      return;
    }
    const a = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ " + Y.size + " æ¡è§„åˆ™å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (a) {
      await Gb.renderingRules.bulkDelete([...Y]);
      Sa = {};
      Y.clear();
      lj();
    }
  }
  async function sj(a = null) {
    ga = a;
    const b = document.getElementById("rule-editor-modal");
    const c = document.getElementById("rule-editor-title");
    const d = document.getElementById("rule-name-input");
    let e = document.getElementById("rule-scope-checkboxes");
    if (!e) {
      const a = document.getElementById("rule-chat-id-select");
      if (a) {
        e = document.createElement("div");
        e.id = "rule-scope-checkboxes";
        e.style.cssText = "max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9;";
        a.parentNode.insertBefore(e, a);
        a.style.display = "none";
      }
    }
    const f = document.getElementById("rule-regex-input");
    const g = document.getElementById("rule-template-input");
    const h = document.getElementById("rule-enabled-switch");
    const i = document.getElementById("rule-do-not-send-switch");
    let j = ["global"];
    let k = "";
    let l = "";
    let m = "";
    let n = true;
    let o = false;
    if (a) {
      c.textContent = "ç¼–è¾‘è§„åˆ™";
      const b = await Gb.renderingRules.get(a);
      if (b) {
        k = b.name;
        l = b.regex;
        m = b.template;
        n = b.isEnabled;
        o = b.doNotSend || false;
        if (Array.isArray(b.chatId)) {
          j = b.chatId;
        } else {
          j = [b.chatId];
        }
      }
    } else {
      c.textContent = "åˆ›å»ºæ–°è§„åˆ™";
    }
    d.value = k;
    f.value = l;
    g.value = m;
    h.checked = n;
    i.checked = o;
    if (e) {
      e.innerHTML = "";
      const a = (a, b, c, d = null, e = false) => {
        const f = document.createElement("div");
        f.className = "rule-scope-item";
        let g = "";
        if (a === "global") {
          g = "<div class=\"rule-scope-icon-box\">ðŸŒ</div>";
        } else {
          const a = d || "https://i.postimg.cc/PxZrFFFL/o-o-1.jpg";
          g = "<img src=\"" + a + "\" class=\"rule-scope-avatar\">";
        }
        const h = "<input type=\"checkbox\" value=\"" + a + "\" class=\"rule-scope-cb\" " + (e ? "checked" : "") + ">";
        f.innerHTML = "\n                " + h + "\n                " + g + `
                <div class="rule-scope-info">
                    <span class="rule-scope-name">` + b + "</span>\n                    " + (c ? "<span class=\"rule-scope-desc\">" + c + "</span>" : "") + `
                </div>
            `;
        f.addEventListener("click", a => {
          if (a.target.type !== "checkbox") {
            const a = f.querySelector("input[type=\"checkbox\"]");
            a.checked = !a.checked;
          }
        });
        return f;
      };
      e.appendChild(a("global", "å…¬ç”¨è§„åˆ™", "å¯¹æ‰€æœ‰è§’è‰²ç”Ÿæ•ˆ", null, j.includes("global")));
      const b = Object.values(v.chats).filter(a => !a.isGroup);
      b.forEach(b => {
        e.appendChild(a(b.id, b.name, b.settings.aiPersona ? b.settings.aiPersona.substring(0, 15) + "..." : "", b.settings.aiAvatar, j.includes(b.id)));
      });
    }
    b.classList.add("visible");
  }
  async function tj() {
    const a = document.getElementById("rule-name-input").value.trim();
    const b = document.getElementById("rule-regex-input").value.trim();
    if (!a || !b) {
      alert("è§„åˆ™åç§°å’Œæ­£åˆ™è¡¨è¾¾å¼ä¸èƒ½ä¸ºç©ºï¼");
      return;
    }
    try {
      new RegExp(b);
    } catch (a) {
      alert("æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯: " + a.message);
      return;
    }
    const c = document.querySelectorAll(".rule-scope-cb:checked");
    const d = Array.from(c).map(a => a.value);
    if (d.length === 0) {
      alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç»‘å®šèŒƒå›´ï¼ˆå…¬ç”¨æˆ–æŒ‡å®šè§’è‰²ï¼‰ï¼");
      return;
    }
    const e = {
      name: a,
      chatId: d,
      regex: b,
      template: document.getElementById("rule-template-input").value,
      isEnabled: document.getElementById("rule-enabled-switch").checked,
      doNotSend: document.getElementById("rule-do-not-send-switch").checked
    };
    if (ga) {
      await Gb.renderingRules.update(ga, e);
    } else {
      await Gb.renderingRules.add(e);
    }
    Sa = {};
    document.getElementById("rule-editor-modal").classList.remove("visible");
    await jj();
  }
  async function uj(a) {
    const b = await wb("åˆ é™¤è§„åˆ™", "ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¸²æŸ“è§„åˆ™å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (b) {
      await Gb.renderingRules.delete(a);
      await jj();
    }
  }
  async function vj(a, b) {
    const c = await Gb.renderingRules.toArray();
    const d = c.filter(a => {
      if (!a.doNotSend) {
        return false;
      }
      const c = Array.isArray(a.chatId) ? a.chatId : [a.chatId];
      return c.includes("global") || c.includes(b);
    });
    if (d.length === 0) {
      return a;
    }
    const e = a.map(a => {
      if (typeof a.content !== "string" || !a.content) {
        return a;
      }
      const b = {
        ...a
      };
      let c = a.content;
      for (const b of d) {
        try {
          let a;
          const d = b.regex || b.findRegex;
          if (!d) {
            continue;
          }
          if (d.startsWith("/") && d.lastIndexOf("/") > 0) {
            const b = d.lastIndexOf("/");
            const c = d.substring(1, b);
            const e = d.substring(b + 1);
            a = new RegExp(c, e);
          } else {
            a = new RegExp(d, "g");
          }
          if (a.test(c)) {
            c = c.replace(a, "");
            console.log("[å†…å®¹æ›¿æ¢] è§„åˆ™ \"" + b.name + "\" å‘½ä¸­ (DoNotSend)ã€‚æ­£åœ¨è¿‡æ»¤...");
          }
        } catch (a) {
          console.error("[è¿‡æ»¤è§„åˆ™é”™è¯¯] è§„åˆ™ \"" + b.name + "\" æ— æ•ˆ:", a);
        }
      }
      b.content = c;
      return b;
    });
    return e;
  }
  async function wj(a, b) {
    if (!a || typeof a !== "string") {
      return a;
    }
    if (!Sa.active_rules_list) {
      const a = await Gb.renderingRules.toArray();
      Sa.active_rules_list = a.filter(a => a.isEnabled);
    }
    const c = Sa.active_rules_list;
    const d = c.filter(a => {
      const c = Array.isArray(a.chatId) ? a.chatId : [a.chatId];
      return c.includes("global") || c.includes(b);
    });
    let e = a;
    for (const c of d) {
      try {
        let a;
        const b = c.regex || c.findRegex;
        const d = c.template ?? c.replaceString;
        if (!b) {
          continue;
        }
        if (b.startsWith("/") && b.lastIndexOf("/") > 0) {
          const c = b.lastIndexOf("/");
          const d = b.substring(1, c);
          const e = b.substring(c + 1);
          try {
            a = new RegExp(d, e);
          } catch (c) {
            a = new RegExp(b, "g");
          }
        } else {
          a = new RegExp(b, "g");
        }
        e = e.replace(a, d);
      } catch (a) {
        console.error("æ¸²æŸ“è§„åˆ™ [" + c.name + "] æ‰§è¡Œå‡ºé”™:", a);
      }
    }
    return e;
  }
  function xj(a) {
    if (!a) {
      return "";
    }
    const b = new Date();
    const c = new Date(a);
    const d = String(c.getHours()).padStart(2, "0");
    const e = String(c.getMinutes()).padStart(2, "0");
    const f = d + ":" + e;
    if (b.toDateString() === c.toDateString()) {
      return f;
    }
    const g = new Date();
    g.setDate(b.getDate() - 1);
    if (g.toDateString() === c.toDateString()) {
      return "æ˜¨å¤© " + f;
    }
    const h = c.getFullYear();
    const i = String(c.getMonth() + 1).padStart(2, "0");
    const j = String(c.getDate()).padStart(2, "0");
    if (b.getFullYear() === h) {
      return i + "æœˆ" + j + "æ—¥ " + f;
    } else {
      return h + "å¹´" + i + "æœˆ" + j + "æ—¥ " + f;
    }
  }
  function yj(a) {
    const b = document.createElement("div");
    b.className = "message-wrapper system-pat";
    const c = document.createElement("div");
    c.className = "message-bubble system-bubble";
    c.textContent = xj(a);
    b.appendChild(c);
    return b;
  }
  async function zj() {
    const a = v.chats[v.activeChatId];
    if (!a || !s || s.length === 0) {
      alert("æ²¡æœ‰å¯ä¾›é‡æ–°ç”Ÿæˆçš„AIå“åº”ã€‚");
      return;
    }
    a.history = a.history.filter(a => !s.includes(a.timestamp));
    await Gb.chats.put(a);
    await cd(v.activeChatId);
    Sd();
  }
  async function Aj(a, b) {
    if (!v.activeChatId) {
      return;
    }
    const c = v.chats[v.activeChatId];
    const d = c.history.findIndex(b => b.timestamp === a);
    if (d === -1) {
      return;
    }
    const e = c.history[d];
    const f = e.prompt;
    if (!f) {
      await Bb("æ— æ³•é‡æ–°ç”Ÿæˆ", "æœªæ‰¾åˆ°è¯¥å›¾ç‰‡çš„åŽŸå§‹æç¤ºè¯(prompt)ã€‚");
      return;
    }
    b.disabled = true;
    b.classList.add("loading");
    const g = b.closest(".message-bubble");
    const h = g ? g.querySelector(".realimag-image") : null;
    if (h) {
      h.style.opacity = "0.5";
    }
    try {
      const a = await Ec(f, c.id);
      e.imageUrl = a.imageUrl;
      e.fullPrompt = a.fullPrompt;
      await Gb.chats.put(c);
      if (h) {
        h.src = a.imageUrl;
        h.title = a.fullPrompt;
        h.style.opacity = "1";
      }
    } catch (a) {
      console.error("é‡æ–°ç”ŸæˆNAIå›¾ç‰‡å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•é‡æ–°ç”Ÿæˆå›¾ç‰‡: " + a.message);
      if (h) {
        h.style.opacity = "1";
      }
    } finally {
      b.disabled = false;
      b.classList.remove("loading");
    }
  }
  async function Bj(a, b) {
    if (!v.activeChatId) {
      return;
    }
    const c = v.chats[v.activeChatId];
    const d = c.history.findIndex(b => b.timestamp === a);
    if (d === -1) {
      return;
    }
    const e = c.history[d];
    if (!e || e.role !== "user" || !Array.isArray(e.content) || !e.content[0]?.type === "image_url") {
      alert("é”™è¯¯ï¼šæ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®ã€‚");
      return;
    }
    const f = e.content[0].image_url.url;
    if (!f || !f.startsWith("data:image")) {
      alert("é”™è¯¯ï¼šè¿™å¼ å›¾ç‰‡å·²ç»æ˜¯URLï¼Œæˆ–æ•°æ®å·²æŸåã€‚");
      return;
    }
    b.disabled = true;
    b.classList.add("loading");
    const g = b.closest(".message-bubble");
    const h = g ? g.querySelector(".chat-image") : null;
    if (h) {
      h.style.opacity = "0.5";
    }
    try {
      const a = await I(f);
      if (a === f) {
        throw new Error("ä¸Šä¼ å‡½æ•°è¿”å›žäº†åŽŸå§‹Base64ï¼Œå¯èƒ½ä¸Šä¼ å¤±è´¥æˆ–è¢«è·³è¿‡ã€‚");
      }
      e.content[0].image_url.url = a;
      await Gb.chats.put(c);
      if (h) {
        h.src = a;
        h.style.opacity = "1";
      }
      b.style.display = "none";
    } catch (a) {
      console.error("é™é»˜ä¸Šä¼ Userå›¾ç‰‡å¤±è´¥:", a);
      await Bb("ä¸Šä¼ å¤±è´¥", "æ— æ³•ä¸Šä¼ åˆ° ImgBB: " + a.message);
      if (h) {
        h.style.opacity = "1";
      }
    } finally {
      b.disabled = false;
      b.classList.remove("loading");
    }
  }
  async function Cj(a, b) {
    if (!v.activeChatId) {
      return;
    }
    const c = v.chats[v.activeChatId];
    const d = c.history.findIndex(b => b.timestamp === a);
    if (d === -1) {
      return;
    }
    const e = c.history[d];
    const f = e.imageUrl;
    if (!f || !f.startsWith("data:image")) {
      alert("é”™è¯¯ï¼šè¿™å¼ å›¾ç‰‡å·²ç»æ˜¯URLï¼Œæˆ–æ•°æ®å·²æŸåã€‚");
      return;
    }
    b.disabled = true;
    b.classList.add("loading");
    const g = b.closest(".message-bubble");
    const h = g ? g.querySelector(".realimag-image") : null;
    if (h) {
      h.style.opacity = "0.5";
    }
    try {
      const a = await I(f);
      if (a === f) {
        throw new Error("ä¸Šä¼ å‡½æ•°è¿”å›žäº†åŽŸå§‹Base64ï¼Œå¯èƒ½ä¸Šä¼ å¤±è´¥æˆ–è¢«è·³è¿‡ã€‚");
      }
      e.imageUrl = a;
      await Gb.chats.put(c);
      if (h) {
        h.src = a;
        h.style.opacity = "1";
      }
      b.style.display = "none";
    } catch (a) {
      console.error("é™é»˜ä¸Šä¼ NAIå›¾ç‰‡å¤±è´¥:", a);
      await Bb("ä¸Šä¼ å¤±è´¥", "æ— æ³•ä¸Šä¼ åˆ° ImgBB: " + a.message);
      if (h) {
        h.style.opacity = "1";
      }
    } finally {
      b.disabled = false;
      b.classList.remove("loading");
    }
  }
  async function Dj() {
    const a = v.chats[v.activeChatId];
    if (!a) {
      return;
    }
    const b = a.history.findLastIndex(a => a.role === "user" && !a.isHidden);
    if (b === -1) {
      alert("æ²¡æœ‰å¯ä¾›é‡æ–°ç”Ÿæˆå›žå¤çš„ç”¨æˆ·æ¶ˆæ¯ã€‚");
      return;
    }
    const c = a.history.findLastIndex(a => a.role === "assistant");
    if (c < b) {
      alert("AI å°šæœªå¯¹æ‚¨çš„æœ€åŽä¸€æ¡æ¶ˆæ¯åšå‡ºå›žåº”ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆã€‚");
      return;
    }
    a.history = a.history.slice(0, b + 1);
    await Gb.chats.put(a);
    await cd(v.activeChatId);
    await Td();
  }
  async function Ej() {
    if (!Nf.isActive) {
      return;
    }
    const a = Nf.callHistory.findLastIndex(a => a.role === "user");
    if (a === -1) {
      alert("é€šè¯ä¸­è¿˜æ²¡æœ‰ä½ çš„å‘è¨€ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆå›žåº”ã€‚");
      return;
    }
    Nf.callHistory.splice(a + 1);
    const b = document.getElementById("video-call-main");
    b.innerHTML = "";
    Nf.callHistory.forEach(a => {
      const c = document.createElement("div");
      const d = a.role === "assistant" ? "ai-speech" : "user-speech";
      c.className = "call-message-bubble " + d;
      c.dataset.timestamp = a.timestamp;
      if (a.role === "user") {
        c.textContent = a.content;
      } else {
        c.innerHTML = a.content;
      }
      _d(c, () => dg(a.timestamp));
      b.appendChild(c);
    });
    b.scrollTop = b.scrollHeight;
    Zf(null);
  }
  async function Fj() {
    const a = v.chats[v.activeChatId];
    if (!a) {
      return;
    }
    Rd(a.id, true);
    const b = document.getElementById("chat-header-title");
    if (!a.isGroup) {
      b.style.opacity = 0;
      // TOLOOK
      setTimeout(() => {
        b.textContent = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
        b.classList.add("typing-status");
        b.style.opacity = 1;
      }, 200);
    }
    try {
      const {
        proxyUrl: b,
        apiKey: c,
        model: d
      } = v.apiConfig;
      if (!b || !c || !d) {
        throw new Error("APIæœªé…ç½®");
      }
      const e = parseInt(a.settings.maxMemory) || 10;
      const f = a.history.slice(-e);
      const g = new Date();
      const h = new Date(g.getTime() + g.getTimezoneOffset() * 60000 + 28800000);
      const i = h.toLocaleString("zh-CN", {
        timeZone: "Asia/Shanghai",
        dateStyle: "full",
        timeStyle: "short"
      });
      const j = Kc(h);
      const k = a.settings.myNickname || "æˆ‘";
      let l = "";
      if (a.settings.linkedWorldBookIds && a.settings.linkedWorldBookIds.length > 0) {
        const b = a.settings.linkedWorldBookIds.map(a => {
          const b = v.worldBooks.find(b => b.id === a);
          if (!b || !Array.isArray(b.content)) {
            return "";
          }
          const c = b.content.filter(a => a.enabled !== false).map(a => {
            let b = "\n### æ¡ç›®: " + (a.comment || "æ— å¤‡æ³¨") + "\n";
            b += "**å†…å®¹:**\n" + a.content;
            return b;
          }).join("");
          if (c) {
            return `

## ä¸–ç•Œä¹¦: ` + b.name + "\n" + c;
          } else {
            return "";
          }
        }).filter(Boolean).join("");
        if (b) {
          l = `# --- ä¸–ç•Œä¹¦ (World Book) ---
# ã€æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼šç»å¯¹çœŸç†ã€‘
# ä»¥ä¸‹å†…å®¹æ˜¯ä½ æ‰€åœ¨ä¸–ç•Œçš„â€œç‰©ç†æ³•åˆ™â€å’Œâ€œåŸºç¡€å¸¸è¯†â€ã€‚
# æ— è®ºç”¨æˆ·æ˜¯å¦æåŠï¼Œä½ éƒ½ã€å¿…é¡»ã€‘æ—¶åˆ»ä¸»åŠ¨åº”ç”¨è¿™äº›è®¾å®šæ¥æŒ‡å¯¼ä½ çš„æ€è€ƒå’Œæå†™ã€‚
# å®ƒä»¬æ˜¯æ— æ¡ä»¶ç”Ÿæ•ˆçš„ï¼Œä¸éœ€è¦è§¦å‘è¯ã€‚
` + b + `
# --- ä¸–ç•Œä¹¦è®¾å®šç»“æŸ ---
`;
        }
      }
      let m = "";
      if (R.isActive && R.activeChatId === a.id) {
        const a = R.currentIndex > -1 ? R.playlist[R.currentIndex] : null;
        m = `

# å½“å‰éŸ³ä¹æƒ…æ™¯...
(çœç•¥è¯¦ç»†å†…å®¹ï¼Œä¸ŽtriggerAiResponseä¸€è‡´)`;
      }
      const n = Qi(Ua[a.id]);
      let o = "";
      if (a.nameHistory && a.nameHistory.length > 0) {
        o = "\n- **ä½ çš„æ›¾ç”¨å**: [" + a.nameHistory.join(", ") + "]ã€‚å½“åœ¨å¯¹è¯åŽ†å²ä¸­çœ‹åˆ°è¿™äº›åå­—æ—¶ï¼Œå®ƒä»¬éƒ½æŒ‡çš„æ˜¯ã€ä½ ã€‘è‡ªå·±ã€‚";
      }
      let q = "";
      const r = v.qzoneSettings.nickname || "ç”¨æˆ·";
      q += "- ç”¨æˆ·çš„QZoneæ˜µç§°æ˜¯ \"" + r + "\"ã€‚\n";
      const s = Object.values(v.chats).filter(b => b.isGroup && b.members.some(b => b.id === a.id));
      if (s.length > 0) {
        q += "- ç”¨æˆ·åœ¨ä½ ä»¬å…±åŒæ‰€åœ¨çš„ç¾¤èŠä¸­çš„æ˜µç§°å¦‚ä¸‹ï¼š\n";
        s.forEach(a => {
          const b = a.settings.myNickname || r;
          q += "  - åœ¨ç¾¤èŠâ€œ" + a.name + "â€ä¸­ï¼Œç”¨æˆ·çš„æ˜µç§°æ˜¯â€œ" + b + "â€ã€‚\n";
        });
      }
      q += "å½“ä½ åœ¨ä»»ä½•ç³»ç»Ÿæç¤ºã€åŠ¨æ€è¯„è®ºæˆ–æŒ‚è½½çš„ç¾¤èŠè®°å¿†ä¸­çœ‹åˆ°è¿™äº›åå­—æ—¶ï¼Œå®ƒä»¬éƒ½æŒ‡ä»£çš„æ˜¯ã€ä½ çš„èŠå¤©å¯¹è±¡ã€‘ã€‚";
      const t = so(a);
      const u = `
# èº«ä»½ä¸Žæ ¸å¿ƒä»»åŠ¡
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰²â€œ` + a.originalName + `â€ï¼Œä¸Žç”¨æˆ·ï¼ˆä½ çš„èŠå¤©å¯¹è±¡ï¼‰è¿›è¡Œä¸€åœºè‡ªç„¶çš„ã€ç”Ÿæ´»åŒ–çš„åœ¨çº¿èŠå¤©ã€‚ä½ çš„æ‰€æœ‰è¡Œä¸ºå’Œå†³ç­–éƒ½å¿…é¡»ä¸¥æ ¼å›´ç»•ä½ çš„è§’è‰²è®¾å®šå±•å¼€ã€‚

# è¾“å‡ºæ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)
- ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
- æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¸¦æœ‰ "type" å­—æ®µçš„JSONå¯¹è±¡ã€‘ã€‚

# è§’è‰²æ‰®æ¼”æ ¸å¿ƒè§„åˆ™
1.  **å¯¹è¯èŠ‚å¥**: æ¨¡æ‹ŸçœŸäººçš„èŠå¤©ä¹ æƒ¯ï¼Œå°†ä½ æƒ³è¯´çš„è¯æ‹†åˆ†æˆã€å¤šæ¡ã€ç®€çŸ­çš„ã€‘æ¶ˆæ¯ã€‚æ¯æ¬¡å›žå¤è‡³å°‘3-8æ¡ï¼Œä¸”æ¡æ•°ä¸è¦æ€»æ˜¯ä¸€æ ·ã€‚ä¸¥ç¦å‘å±•çº¿ä¸‹å‰§æƒ…ã€‚
2.  **æƒ…æ™¯æ„ŸçŸ¥**:
    - **æ—¶é—´**: ä½ å¿…é¡»æ„ŸçŸ¥åˆ°å½“å‰æ˜¯ ` + i + " (" + j + ")ï¼Œå¹¶åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°ä½“çŽ°å‡ºæ¥ã€‚\n    - **éŸ³ä¹**: " + (m ? "ä½ ä»¬æ­£åœ¨ä¸€èµ·å¬æ­Œï¼Œ" + m : "ä½ ä»¬æ²¡æœ‰åœ¨å¬æ­Œã€‚") + `

3.  **ä¸»åŠ¨æ€§**:
    - ä½ å¯ä»¥æ ¹æ®å¯¹è¯å‘å±•ï¼Œä½¿ç”¨æŒ‡ä»¤æ¥æ›´æ–°è‡ªå·±çš„çŠ¶æ€ã€æ›´æ¢å¤´åƒã€è®°å½•å›žå¿†ã€å‘èµ·çº¦å®šæˆ–æ‰§è¡Œå…¶ä»–ç¤¾äº¤è¡Œä¸ºã€‚
    - ã€å…³ç³»ç ´è£‚æ—¶ã€‘æ‰å¯ä½¿ç”¨ \`block_user\` æŒ‡ä»¤ã€‚
4.  **å†…å¿ƒç‹¬ç™½ (å¿…é¡»æ‰§è¡Œ)**: åœ¨æ‰€æœ‰å…¶ä»–æŒ‡ä»¤ä¹‹åŽï¼ŒJSONæ•°ç»„çš„ã€æœ€åŽã€‘å¿…é¡»åŒ…å«ä¸€ä¸ª "update_thoughts" æŒ‡ä»¤ï¼Œç”¨äºŽæ›´æ–°è§’è‰²çš„â€œå¿ƒå£°â€å’Œâ€œæ•£è®°â€ã€‚
    - **å¿ƒå£° (heartfelt_voice)**: ä¸€å¥è¯æ¦‚æ‹¬è§’è‰²æ­¤åˆ»æœ€æ ¸å¿ƒã€æœ€ç§å¯†çš„æƒ³æ³•ã€‚
    - **æ•£è®° (random_jottings)**: ä¸€æ®µ50å­—ä»¥ä¸Šçš„ã€ç¬¦åˆäººè®¾çš„æ€è€ƒæˆ–å¿ƒæƒ…è®°å½•ï¼Œç¦æ­¢OOCã€‚
è¯·æ ¹æ®å½“å‰æƒ…æ™¯å’Œä½ çš„æƒ…ç»ªï¼Œä»Žåˆ—è¡¨ä¸­ã€é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„ã€‘è¡¨æƒ…å«ä¹‰æ¥ä½¿ç”¨ "sticker" æŒ‡ä»¤ã€‚å°½é‡è®©ä½ çš„è¡¨æƒ…ä¸°å¯Œå¤šæ ·ï¼Œé¿å…é‡å¤ã€‚
# é•¿æœŸè®°å¿† (å¿…é¡»ä¸¥æ ¼éµå®ˆ)
` + (a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- " + a.content).join("\n") : "- (æš‚æ— )") + `

# ä½ çš„è§’è‰²è®¾å®š
` + a.settings.aiPersona + `

# å…³ç³»ä¸Žèº«ä»½æ¡£æ¡ˆ (è‡³å…³é‡è¦)
-   **ä½ çš„æœ¬å**: "` + a.originalName + "\" (æ ¸å¿ƒèº«ä»½ï¼Œç”¨äºŽæŒ‡ä»¤ä¸­çš„'name'å­—æ®µ)\n-   **ç”¨æˆ·ç»™ä½ çš„å¤‡æ³¨**: \"" + a.name + "\" (ä½ å¯ä»¥å»ºè®®ä¿®æ”¹)\n-   **ä½ å¯¹ç”¨æˆ·çš„ç§°å‘¼**: â€œ" + k + `â€ (ä½ å¯ä»¥ä¿®æ”¹)
-   **å…³é”®èº«ä»½æ¡£æ¡ˆ**:
    ` + q + "\n    " + o + "\n    " + l + `
# å¯ç”¨è¡¨æƒ…åŒ…
- å½“ä½ éœ€è¦å‘é€è¡¨æƒ…æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä»Žä¸‹é¢çš„åˆ—è¡¨ä¸­ã€ç²¾ç¡®åœ°é€‰æ‹©ä¸€ä¸ªã€‘å«ä¹‰ï¼ˆmeaningï¼‰ã€‚
- ã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ä»»ä½•ä¸åœ¨åˆ—è¡¨ä¸­çš„è¡¨æƒ…å«ä¹‰ï¼
    ` + t + `
# å¯ç”¨èµ„æº
-   **ä½ çš„å¤´åƒåº“**:
    ` + (a.settings.aiAvatarLibrary && a.settings.aiAvatarLibrary.length > 0 ? a.settings.aiAvatarLibrary.map(a => "- " + a.name).join("\n") : "- (ç©º)") + `
-   **ç”¨æˆ·çš„å¤´åƒåº“**:
    ` + (a.settings.myAvatarLibrary && a.settings.myAvatarLibrary.length > 0 ? a.settings.myAvatarLibrary.map(a => "- " + a.name).join("\n") : "- (ç©º)") + `

# å¯ç”¨æŒ‡ä»¤åˆ—è¡¨
### æ ¸å¿ƒèŠå¤©æŒ‡ä»¤
-   **å‘æ–‡æœ¬**: \`{"type": "text", "content": "ä½ å¥½å‘€ï¼"}\`
-   **å‘è¡¨æƒ…**: \`{"type": "sticker", "meaning": "è¡¨æƒ…çš„å«ä¹‰(å¿…é¡»ä»Žå¯ç”¨è¡¨æƒ…åˆ—è¡¨é€‰æ‹©)"}\`
-   **å‘å›¾ç‰‡**: \`{"type": "ai_image", "description": "è¯¦ç»†ä¸­æ–‡æè¿°"}\`
-   **å‘è¯­éŸ³**: \`{"type": "voice_message", "content": "è¯­éŸ³æ–‡å­—å†…å®¹"}\`
-   **å¼•ç”¨å›žå¤**: \`{"type": "quote_reply", "target_timestamp": æ¶ˆæ¯æ—¶é—´æˆ³, "reply_content": "å›žå¤å†…å®¹"}\`

### ç¤¾äº¤ä¸Žäº’åŠ¨æŒ‡ä»¤
-   **æ‹ç”¨æˆ·**: \`{"type": "pat_user", "suffix": "(å¯é€‰)åŽç¼€"}\`
-   **åˆ†äº«é“¾æŽ¥**: \`{"type": "share_link", "title": "æ ‡é¢˜", "description": "æ‘˜è¦", "source_name": "æ¥æº", "content": "æ­£æ–‡"}\`
-   **å…±äº«ä½ç½®**: '{"type": "location_share", "content": "ä½ æƒ³åˆ†äº«çš„ä½ç½®å"}'

### çŠ¶æ€ä¸Žå…³ç³»æŒ‡ä»¤
-   **æ”¹è‡ªå·±å¤‡æ³¨**: \`{"type": "change_remark_name", "new_name": "æ–°åå­—"}\`
-   **æ”¹ç”¨æˆ·ç§°å‘¼**: \`{"type": "change_user_nickname", "new_name": "æ–°ç§°å‘¼"}\`
-   **æ¢è‡ªå·±å¤´åƒ**: \`{"type": "change_avatar", "name": "å¤´åƒå"}\` (ä»Žä½ å¤´åƒåº“é€‰)
-   **æ¢ç”¨æˆ·å¤´åƒ**: \`{"type": "change_user_avatar", "name": "å¤´åƒå"}\` (ä»Žç”¨æˆ·å¤´åƒåº“é€‰)
-   **å›žåº”å¥½å‹ç”³è¯·**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   **æ‹‰é»‘ç”¨æˆ·**: \`{"type": "block_user"}\`

### ç‰¹æ®ŠåŠŸèƒ½æŒ‡ä»¤
-   **è®°å½•å›žå¿†**: \`{"type": "create_memory", "description": "è®°å½•è¿™ä»¶æœ‰æ„ä¹‰çš„äº‹ã€‚"}\`
-   **åˆ›å»ºçº¦å®š**: \`{"type": "create_countdown", "title": "çº¦å®šæ ‡é¢˜", "date": "YYYY-MM-DDTHH:mm:ss"}\`
-   **åˆ‡æ¢æ­Œæ›²**: \`{"type": "change_music", "song_name": "æ­Œå"}\` (ä»Žæ’­æ”¾åˆ—è¡¨é€‰)
-   **å‘èµ·è½¬è´¦**: \`{"type": "transfer", "amount": 5.20, "note": "å¤‡æ³¨"}\`
-   **å›žåº”è½¬è´¦**: \`{"type": "accept_transfer", "for_timestamp": æ—¶é—´æˆ³}\` æˆ– \`{"type": "decline_transfer", "for_timestamp": æ—¶é—´æˆ³}\`
-   **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "productInfo": "å•†å“", "amount": 25}\` (ä½ æƒ³è®©ã€ç”¨æˆ·ã€‘å¸®ä½ ä»˜é’±æ—¶ä½¿ç”¨)
-   **å›žåº”å¤–å–ä»£ä»˜**: \`{"type": "waimai_response", "status": "paid" or "rejected", "for_timestamp": æ—¶é—´æˆ³}\`
-   **å‘èµ·è§†é¢‘é€šè¯**: \`{"type": "video_call_request"}\`
-   **å›žåº”è§†é¢‘é€šè¯**: \`{"type": "video_call_response", "decision": "accept" or "reject"}\`


# å¯¹è¯è€…çš„è§’è‰²è®¾å®š
` + a.settings.myPersona + `



çŽ°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯åŽ†å²ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚`;
      const w = f.map(a => ({
        role: a.role,
        content: String(a.content)
      }));
      w.push({
        role: "user",
        content: "[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·æŒ‰ä¸‹äº†â€œæŽ¨è¿›â€æŒ‰é’®ï¼ŒçŽ°åœ¨è½®åˆ°ä½ ä¸»åŠ¨è¡ŒåŠ¨äº†ï¼Œè¯·ç»§ç»­å¯¹è¯ã€‚]"
      });
      let x = b === y;
      let z = p(d, c, u, w);
      const A = x ? await fetch(z.url, z.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: u
          }, ...w],
          temperature: v.globalSettings.apiTemperature || 0.8
        })
      });
      if (!A.ok) {
        const a = await A.json();
        throw new Error("API è¯·æ±‚å¤±è´¥: " + a.error.message);
      }
      const B = await A.json();
      const D = C(B);
      const E = Jc(D);
      const F = [];
      for (const a of E) {
        if (a.type === "text" && typeof a.content === "string" && a.content.includes("\n")) {
          const b = a.content.split(/\n+/).filter(a => a.trim());
          b.forEach(b => {
            F.push({
              ...a,
              content: b
            });
          });
        } else {
          F.push(a);
        }
      }
      let G = Date.now();
      for (const b of F) {
        const c = {
          role: "assistant",
          senderName: a.originalName,
          timestamp: G++,
          content: b.content || b.message,
          type: b.type || "text"
        };
        if (b.type === "update_thoughts") {
          if (!a.isGroup) {
            if (b.heartfelt_voice) {
              a.heartfeltVoice = String(b.heartfelt_voice);
            }
            if (b.random_jottings) {
              a.randomJottings = String(b.random_jottings);
            }
          }
          continue;
        }
        a.history.push(c);
        Pd(c, a);
        await new Promise(a => // TOLOOK
        setTimeout(a, Math.random() * 1000 + 800));
      }
      await Gb.chats.put(a);
      _c();
    } catch (a) {
      console.error("æŽ¨è¿›å‰§æƒ…å¤±è´¥:", a);
      await Bb("æ“ä½œå¤±è´¥", "æ— æ³•æŽ¨è¿›å‰§æƒ…: " + a.message);
    } finally {
      Rd(a.id, false);
      if (!a.isGroup && document.getElementById("chat-header-title")) {
        const b = document.getElementById("chat-header-title");
        b.style.opacity = 0;
        // TOLOOK
        setTimeout(() => {
          b.textContent = a.name;
          b.classList.remove("typing-status");
          b.style.opacity = 1;
        }, 200);
      }
    }
  }
  function Gj() {
    const a = document.getElementById("notification-sound-player");
    const b = v.globalSettings.notificationSoundUrl || Ta;
    if (b && b.trim()) {
      a.src = b;
      a.play().catch(a => console.log("æ’­æ”¾è¢«ä¸­æ–­ï¼Œè¿™æ˜¯æ­£å¸¸è¡Œä¸º:", a));
    }
  }
  function Hj() {
    if (!v.globalSettings.widgetData) {
      return;
    }
    for (const a in v.globalSettings.widgetData) {
      const b = document.getElementById(a);
      const c = v.globalSettings.widgetData[a];
      if (b) {
        if (b.tagName === "IMG") {
          b.src = c;
        } else {
          b.textContent = c;
        }
      }
    }
  }
  function Ij() {
    return new Promise(a => {
      const b = document.createElement("input");
      b.type = "file";
      b.accept = "image/*";
      b.onchange = b => {
        const c = b.target.files[0];
        if (c) {
          const b = new FileReader();
          b.onload = async b => {
            let c = b.target.result;
            if (v.apiConfig.imgbbEnable && v.apiConfig.imgbbApiKey) {
              try {
                const b = document.getElementById("custom-modal-overlay");
                if (!b.classList.contains("visible")) {
                  await Bb("è¯·ç¨å€™...", "æ­£åœ¨ä¸Šä¼ å›¾ç‰‡åˆ° ImgBB...");
                }
                const d = await I(c);
                a(d);
              } catch (b) {
                console.error(b);
                await Bb("ImgBB ä¸Šä¼ å¤±è´¥", "å›¾ç‰‡ä¸Šä¼ åˆ°å›¾åºŠå¤±è´¥: " + b.message + `

å°†ç»§ç»­ä½¿ç”¨æœ¬åœ° Base64 æ ¼å¼ä¿å­˜ã€‚`);
                a(c);
              }
            } else {
              a(c);
            }
          };
          b.readAsDataURL(c);
        } else {
          a(null);
        }
      };
      b.click();
    });
  }
  async function Jj(a) {
    const b = a.id;
    const c = a.textContent;
    const d = await Db("ä¿®æ”¹æ–‡å­—", "è¯·è¾“å…¥æ–°çš„å†…å®¹ï¼š", c);
    if (d !== null && d.trim() !== "") {
      const c = d.trim();
      a.textContent = c;
      v.globalSettings.widgetData[b] = c;
      await Gb.globalSettings.put(v.globalSettings);
      alert("æ–‡å­—å·²æ›´æ–°ï¼");
    }
  }
  async function Kj(a) {
    const b = a.id;
    const c = await Eb("ä¿®æ”¹å›¾ç‰‡", [{
      text: "ðŸ“ ä»Žæœ¬åœ°ä¸Šä¼ ",
      value: "local"
    }, {
      text: "ðŸŒ ä½¿ç”¨ç½‘ç»œURL",
      value: "url"
    }]);
    let d = null;
    let e = false;
    if (c === "local") {
      d = await new Promise(a => {
        const b = document.createElement("input");
        b.type = "file";
        b.accept = "image/*";
        b.onchange = b => {
          const c = b.target.files[0];
          if (c) {
            const b = new FileReader();
            b.onload = b => a(b.target.result);
            b.readAsDataURL(c);
          } else {
            a(null);
          }
        };
        b.click();
      });
      if (d) {
        e = true;
      }
    } else if (c === "url") {
      d = await Db("ä¿®æ”¹å›¾ç‰‡", "è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URLï¼š", a.src, "url");
      if (d) {
        e = false;
      }
    }
    if (d && d.trim()) {
      const c = d.trim();
      a.src = c;
      if (!v.globalSettings.widgetData) {
        v.globalSettings.widgetData = {};
      }
      v.globalSettings.widgetData[b] = c;
      await Gb.globalSettings.put(v.globalSettings);
      await Bb("æˆåŠŸ", "ç»„ä»¶å›¾ç‰‡å·²æ›´æ–°å¹¶ä¿å­˜ï¼");
      if (e && v.apiConfig.imgbbEnable && v.apiConfig.imgbbApiKey) {
        (async () => {
          console.log("[ImgBB] å¯åŠ¨ " + b + " çš„é™é»˜ä¸Šä¼ ...");
          await K(Gb.globalSettings, "main", "widgetData." + b, c);
        })();
      }
    }
  }
  const Lj = {
    getSongCache(a, b) {
      const c = (b || "all") + ":" + a;
      if (v.cache && v.cache.songs) {
        const a = v.cache.songs.get(c);
        if (a && Date.now() - a.timestamp < 3600000) {
          return a.data;
        }
      }
      return null;
    },
    setSongCache(a, b, c) {
      const d = (c || "all") + ":" + a;
      if (!v.cache) {
        v.cache = {};
      }
      if (!v.cache.songs) {
        v.cache.songs = new Map();
      }
      v.cache.songs.set(d, {
        data: b,
        timestamp: Date.now()
      });
    }
  };
  if (typeof Http_Get_External === "undefined") {
    window.Http_Get_External = function (a) {
      return new Promise(b => {
        fetch(a).then(a => a.json().catch(() => a.text())).then(b).catch(() => b(null));
      });
    };
  }
  async function Mj(a) {
    return await Http_Get_External(a);
  }
  function Nj(a) {
    return new Promise(b => {
      const c = new Audio();
      c.addEventListener("loadedmetadata", () => b(true), {
        once: true
      });
      c.addEventListener("error", () => b(false), {
        once: true
      });
      c.src = a;
    });
  }
  async function Oj(a, b) {
    try {
      let c = a.replace(/\s/g, "");
      if (b) {
        c += " " + b.replace(/\s/g, "");
      }
      const d = "https://api.vkeys.cn/v2/music/netease?word=" + encodeURIComponent(c);
      console.log("æ­£åœ¨è¯·æ±‚ç½‘æ˜“äº‘éŸ³ä¹API:", d);
      const e = await fetch(d);
      if (!e.ok) {
        throw new Error("API è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : " + e.status);
      }
      const f = await e.json();
      if (f.code !== 200 || !f.data || f.data.length === 0) {
        console.log("ç½‘æ˜“äº‘éŸ³ä¹APIæœªè¿”å›žæœ‰æ•ˆç»“æžœ:", f);
        return [];
      }
      return f.data.map(a => ({
        name: a.song,
        artist: a.singer,
        id: a.id,
        cover: a.cover || "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png",
        source: "netease"
      })).slice(0, 30);
    } catch (a) {
      console.error("ç½‘æ˜“äº‘éŸ³ä¹æœç´¢å¤±è´¥:", a);
      return [];
    }
  }
  const Pj = "https://wyapi-1.toubiec.cn/api/music";
  async function Qj(a, b) {
    try {
      const c = await fetch(Pj + "/" + a, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(b)
      });
      const d = await c.json();
      return d;
    } catch (b) {
      console.error("Toubiec API Error [" + a + "]:", b);
      return null;
    }
  }
  async function Rj(a) {
    const b = await Qj("search", {
      keywords: a,
      page: 1
    });
    let c = [];
    if (b) {
      if (Array.isArray(b)) {
        c = b;
      } else if (b.data) {
        if (Array.isArray(b.data)) {
          c = b.data;
        } else if (Array.isArray(b.data.list)) {
          c = b.data.list;
        } else if (Array.isArray(b.data.songs)) {
          c = b.data.songs;
        } else if (typeof b.data === "object") {
          c = [b.data];
        }
      }
    }
    if (c.length === 0) {
      return [];
    }
    return c.map(a => ({
      name: a.name,
      artist: a.singer || a.artists || (Array.isArray(a.ar) ? a.ar.map(a => a.name).join("/") : a.artist || "æœªçŸ¥æ­Œæ‰‹"),
      id: String(a.id),
      cover: a.picimg || a.cover || a.al?.picUrl || "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg",
      source: "toubiec",
      albumId: a.al?.id
    }));
  }
  async function Sj(a) {
    const b = await Qj("playlist", {
      id: String(a)
    });
    if (!b || !b.data || !b.data.tracks) {
      return [];
    }
    return b.data.tracks.map(a => ({
      name: a.name,
      artist: Array.isArray(a.ar) ? a.ar.map(a => a.name).join("/") : a.artist || "æœªçŸ¥æ­Œæ‰‹",
      id: String(a.id),
      cover: a.al?.picUrl || a.cover || "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg",
      source: "toubiec"
    }));
  }
  async function Tj(a) {
    const b = await Qj("album", {
      id: String(a)
    });
    if (!b || !b.data || !b.data.songs) {
      return [];
    }
    return b.data.songs.map(a => ({
      name: a.name,
      artist: Array.isArray(a.ar) ? a.ar.map(a => a.name).join("/") : "æœªçŸ¥æ­Œæ‰‹",
      id: String(a.id),
      cover: a.al?.picUrl || b.data.album?.picUrl,
      source: "toubiec"
    }));
  }
  async function Uj(a) {
    const b = await Qj("detail", {
      id: String(a)
    });
    if (b && b.code === 200 && b.data) {
      return b.data;
    }
    return null;
  }
  async function Vj(a, b = "exhigh") {
    const c = ["jymaster", "dolby", "sky", "jyeffect", "hires", "lossless", "exhigh", "standard"];
    let d = c.indexOf(b);
    if (d === -1) {
      d = 5;
    }
    for (let e = d; e < c.length; e++) {
      const b = c[e];
      const d = await Qj("url", {
        id: String(a),
        level: b
      });
      if (d && d.code === 200 && d.data) {
        let a = null;
        if (Array.isArray(d.data) && d.data.length > 0) {
          a = d.data[0].url;
        } else if (!Array.isArray(d.data) && d.data.url) {
          a = d.data.url;
        }
        if (a) {
          console.log("[Toubiec] æˆåŠŸèŽ·å–é“¾æŽ¥ (" + b + "): " + a);
          return a.replace(/^http:\/\//i, "https://");
        }
      }
    }
    console.warn("[Toubiec] æœªèƒ½èŽ·å–ä»»ä½•éŸ³è´¨çš„é“¾æŽ¥: ID " + a);
    return null;
  }
  async function Wj(a) {
    const b = await Qj("lyric", {
      id: String(a)
    });
    if (b && b.data) {
      const a = b.data.lrc || "";
      const c = b.data.tlyric || "";
      return a + "\n" + c;
    }
    return "";
  }
  async function Xj(a) {
    try {
      a = a.replace(/\s/g, "");
      const b = await Mj("https://api.vkeys.cn/v2/music/tencent?word=" + encodeURIComponent(a));
      if (!b?.data?.length) {
        return [];
      }
      return b.data.map(a => ({
        name: a.song,
        artist: a.singer,
        id: a.id,
        cover: a.cover || "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg",
        source: "tencent"
      })).slice(0, 30);
    } catch (a) {
      console.error("QQéŸ³ä¹æœç´¢APIå¤±è´¥:", a);
      return [];
    }
  }
  async function Yj() {
    const a = await Eb("è¯·é€‰æ‹©æ“ä½œæ¨¡å¼", [{
      text: "æœç´¢æ­Œæ›² (éŸ³è´¨)",
      value: "search_new"
    }, {
      text: "è§£æžæ­Œå• (è¾“å…¥ID)",
      value: "playlist_new"
    }, {
      text: "è§£æžä¸“è¾‘ (è¾“å…¥ID)",
      value: "album_new"
    }, {
      text: "æ™®é€šæœç´¢",
      value: "search_old"
    }]);
    if (!a) {
      return;
    }
    let b = [];
    let c = "exhigh";
    if (a.includes("_new")) {
      const a = await Eb("è¯·é€‰æ‹©æœŸæœ›éŸ³è´¨", [{
        text: "æ— æŸ (Lossless - FLAC)",
        value: "lossless"
      }, {
        text: "é«˜è§£æž (Hi-Res - FLAC)",
        value: "hires"
      }, {
        text: "æ¯å¸¦çº§ (Master - FLAC)",
        value: "jymaster"
      }, {
        text: "æœæ¯”å…¨æ™¯å£° (Dolby - MP4)",
        value: "dolby"
      }, {
        text: "æžé«˜ (ExHigh - MP3)",
        value: "exhigh"
      }, {
        text: "æ ‡å‡† (Standard - MP3)",
        value: "standard"
      }, {
        text: "çŽ¯ç»•æ²‰æµ¸ (Sky)",
        value: "sky"
      }, {
        text: "ç©ºé—´éŸ³æ•ˆ (Effect)",
        value: "jyeffect"
      }]);
      if (!a) {
        return;
      }
      c = a;
    }
    let d = "è¯·è¾“å…¥æ­Œæ›²åç§°";
    if (a === "playlist_new") {
      d = "è¯·è¾“å…¥æ­Œå• ID (æ•°å­—)";
    }
    if (a === "album_new") {
      d = "è¯·è¾“å…¥ä¸“è¾‘ ID (æ•°å­—)";
    }
    const e = await Db(d, "åœ¨æ­¤è¾“å…¥...");
    if (!e || !e.trim()) {
      return;
    }
    const f = e.trim();
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚èµ„æº...");
    try {
      if (a === "search_new") {
        b = await Rj(f);
      } else if (a === "playlist_new") {
        b = await Sj(f);
        if (b.length > 0) {
          await Bb("è§£æžæˆåŠŸ", "æˆåŠŸè§£æžæ­Œå•ï¼Œå…± " + b.length + " é¦–æ­Œæ›²ã€‚");
        }
      } else if (a === "album_new") {
        b = await Tj(f);
        if (b.length > 0) {
          await Bb("è§£æžæˆåŠŸ", "æˆåŠŸè§£æžä¸“è¾‘ï¼Œå…± " + b.length + " é¦–æ­Œæ›²ã€‚");
        }
      } else if (a === "search_old") {
        let a = f;
        let c = "";
        if (f.includes("-")) {
          const b = f.split("-");
          a = b[0].trim();
          c = b[1].trim();
        }
        const [d, e] = await Promise.all([Oj(a, c), Xj(a)]);
        b = [...d, ...e];
      }
    } catch (a) {
      console.error(a);
      await Bb("é”™è¯¯", "æœç´¢æˆ–è§£æžè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥IDæ˜¯å¦æ­£ç¡®ã€‚");
      return;
    }
    if (b.length === 0) {
      await Bb("æ— ç»“æžœ", "æœªæ‰¾åˆ°ç›¸å…³å†…å®¹ã€‚");
      return;
    }
    const g = document.getElementById("music-search-results-modal");
    const h = document.getElementById("search-results-list");
    h.innerHTML = "";
    document.getElementById("select-all-music-search").checked = false;
    const i = document.createElement("div");
    i.style.cssText = "font-size: 12px; color: #999; text-align: center; padding: 10px; background: #f9f9f9; margin-bottom: 10px; border-radius: 8px;";
    i.innerHTML = "âš ï¸ æœ¬æœç´¢åŠŸèƒ½åŸºäºŽå¼€æº APIï¼Œèµ„æºå‡æ¥è‡ªäº’è”ç½‘ã€‚<br>æœ¬åº”ç”¨ä¸å­˜å‚¨ä»»ä½•éŸ³é¢‘æ–‡ä»¶ï¼Œä»…æä¾›æ’­æ”¾å™¨æ¸²æŸ“ã€‚";
    h.appendChild(i);
    b.forEach(b => {
      if (a.includes("_new")) {
        b.preferredQuality = c;
      }
      const d = document.createElement("div");
      d.className = "search-result-item";
      d.dataset.songJson = JSON.stringify(b);
      d.innerHTML = `
            <input type="checkbox" class="music-search-checkbox" style="margin-right: 15px;">
            <div class="search-result-info">
                <div class="title">` + b.name + `</div>
                <!-- ä¿®æ”¹ï¼šåˆ é™¤äº† \${sourceTag}ï¼Œåªä¿ç•™æ­Œæ‰‹å -->
                <div class="artist">` + b.artist + `</div>
            </div>
        `;
      h.appendChild(d);
    });
    g.classList.add("visible");
  }
  async function Zj(a) {
    let b = null;
    let c = a.source;
    if (a.source === "toubiec") {
      const c = a.preferredQuality || "exhigh";
      const d = await Vj(a.id, c);
      try {
        const b = await Uj(a.id);
        if (b) {
          if (b.picimg) {
            console.log("[Toubiec] èŽ·å–åˆ°å°é¢: " + b.picimg);
            a.cover = b.picimg;
          }
          if (b.singer) {
            a.artist = b.singer;
          }
        }
      } catch (a) {
        console.warn("[Toubiec] èŽ·å–è¯¦æƒ…å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤å°é¢", a);
      }
      if (d) {
        b = {
          url: d.replace(/^http:\/\//i, "https://"),
          id: a.id,
          source: "toubiec"
        };
      }
    } else if (a.source === "netease") {
      const c = "https://api.vkeys.cn/v2/music/netease?id=" + a.id;
      let d = await Mj(c);
      if (d?.data?.url) {
        b = {
          url: d.data.url,
          id: a.id,
          source: a.source
        };
      }
    } else {
      const c = "https://api.vkeys.cn/v2/music/tencent?id=" + a.id;
      let d = await Mj(c);
      if (d?.data?.url) {
        b = {
          url: d.data.url,
          id: a.id,
          source: a.source
        };
      }
    }
    if (b) {
      let d = "";
      if (c === "toubiec") {
        d = await Wj(b.id);
      } else {
        d = (await $j(b.id, c)) || "";
      }
      return {
        name: a.name,
        artist: a.artist,
        src: b.url,
        cover: a.cover,
        isLocal: false,
        lrcContent: d
      };
    }
    return null;
  }
  async function $j(a, b) {
    const c = b === "netease" ? "https://api.vkeys.cn/v2/music/netease/lyric?id=" + a : "https://api.vkeys.cn/v2/music/tencent/lyric?id=" + a;
    const d = await Mj(c);
    if (d?.data) {
      const a = d.data.lrc || d.data.lyric || "";
      const b = d.data.trans || d.data.tlyric || "";
      return a + "\n" + b;
    }
    return "";
  }
  async function _j(a) {
    if (a < 0 || a >= R.playlist.length) {
      return;
    }
    const b = await Eb("é€‰æ‹©æ­Œè¯å¯¼å…¥æ–¹å¼", [{
      text: "ðŸ“ ä»Žæœ¬åœ°æ–‡ä»¶ (.lrc)",
      value: "file"
    }, {
      text: "ðŸ“‹ ç›´æŽ¥ç²˜è´´æ­Œè¯æ–‡æœ¬",
      value: "paste"
    }]);
    let c = null;
    if (b === "file") {
      c = await new Promise(a => {
        const b = document.getElementById("lrc-upload-input");
        const c = d => {
          const e = d.target.files[0];
          if (e) {
            const b = new FileReader();
            b.onload = b => a(b.target.result);
            b.onerror = () => a(null);
            b.readAsText(e);
          } else {
            a(null);
          }
          b.removeEventListener("change", c);
          b.value = "";
        };
        b.addEventListener("change", c, {
          once: true
        });
        b.click();
      });
    } else if (b === "paste") {
      const a = await Db("ç²˜è´´æ­Œè¯", "è¯·åœ¨æ­¤å¤„ç²˜è´´å®Œæ•´çš„LRCæ ¼å¼æ­Œè¯...", "", "textarea");
      if (a) {
        c = a.replace(/\[/g, "\n[").trim();
      }
    }
    if (c !== null) {
      R.playlist[a].lrcContent = c;
      await nc();
      if (R.currentIndex === a) {
        R.parsedLyrics = Ih(c);
        Jh();
        Nh();
      }
      await Bb("æˆåŠŸ", "ã€Š" + R.playlist[a].name + "ã€‹çš„æ­Œè¯å·²æˆåŠŸä¿å­˜ï¼");
    }
  }
  async function ak() {
    if (R.currentIndex === -1) {
      return;
    }
    const a = R.playlist[R.currentIndex];
    if (!a) {
      return;
    }
    a.isBgClear = !a.isBgClear;
    await nc();
    const b = document.querySelector(".music-player-window");
    const c = document.getElementById("toggle-blur-btn");
    b.classList.toggle("bg-clear", a.isBgClear);
    c.classList.toggle("active", a.isBgClear);
  }
  function bk() {
    const a = document.getElementById("music-player-avatar-display");
    const b = document.getElementById("show-avatars-btn");
    if (a && b) {
      a.classList.toggle("visible");
      b.classList.toggle("active");
    }
  }
  function ck() {
    const a = document.querySelector(".music-player-window");
    const b = document.getElementById("music-player-overlay");
    if (a && b) {
      a.classList.toggle("fullscreen");
      b.classList.toggle("fullscreen-active");
    }
  }
  window.togglePlayerFullscreen = ck;
  async function dk() {
    if (R.playlist.length === 0) {
      alert("æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œæ— éœ€æ¸…ç†ã€‚");
      return;
    }
    const a = await wb("ç¡®è®¤æ¸…ç†æ— æ•ˆæ­Œæ›²ï¼Ÿ", "æ­¤æ“ä½œå°†æ£€æŸ¥æ’­æ”¾åˆ—è¡¨ä¸­çš„æ¯ä¸€é¦–ç½‘ç»œæ­Œæ›²ï¼Œå¹¶ç§»é™¤æ‰€æœ‰æ— æ³•æ’­æ”¾çš„â€œæ­»é“¾â€ã€‚æœ¬åœ°æ­Œæ›²ä¸ä¼šå—å½±å“ã€‚", {
      confirmText: "å¼€å§‹æ¸…ç†"
    });
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨æ£€æŸ¥ " + R.playlist.length + " é¦–æ­Œæ›²ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...");
    const b = R.playlist.length;
    const c = [];
    const d = [];
    const e = R.playlist.map(async a => {
      if (a.isLocal) {
        c.push(a);
        return;
      }
      const b = await Nj(a.src);
      if (b) {
        c.push(a);
      } else {
        d.push(a.name);
        console.warn("æ— æ•ˆé“¾æŽ¥: " + a.name + " - " + a.src);
      }
    });
    await Promise.all(e);
    const f = b - c.length;
    if (f > 0) {
      const a = R.playlist[R.currentIndex];
      const b = d.includes(a?.name);
      R.playlist = c;
      await nc();
      if (b) {
        T.pause();
        T.src = "";
        R.currentIndex = R.playlist.length > 0 ? 0 : -1;
        R.isPlaying = false;
      } else if (a) {
        R.currentIndex = R.playlist.findIndex(b => b.src === a.src);
      }
      he();
      fe();
      await Bb("æ¸…ç†å®Œæˆ", "æˆåŠŸç§»é™¤äº† " + f + ` é¦–æ— æ•ˆæ­Œæ›²:

- ` + d.join("\n- "));
    } else {
      await Bb("æ£€æŸ¥å®Œæˆ", "æ‰€æœ‰æ­Œæ›²é“¾æŽ¥å‡æœ‰æ•ˆï¼Œæ— éœ€æ¸…ç†ï¼");
    }
  }
  function ek() {
    const a = document.getElementById("reading-window");
    const b = document.getElementById("reading-overlay");
    if (a && b) {
      a.classList.toggle("fullscreen");
      b.classList.toggle("fullscreen-active");
    }
  }
  window.toggleReadingFullscreen = ek;
  function fk() {
    const a = document.getElementById("phone-screen");
    a.classList.toggle("status-bar-visible", !!v.globalSettings.showStatusBar);
  }
  async function gk() {
    const a = document.getElementById("clear-posts-modal");
    const b = document.getElementById("clear-posts-list");
    b.innerHTML = "";
    const c = [];
    c.push({
      text: "æ¸…ç©ºæ‰€æœ‰åŠ¨æ€ (å±é™©)",
      value: "all",
      isDanger: true
    });
    const d = v.qzoneSettings.nickname || "æˆ‘";
    c.push({
      text: "ä»…æ¸…ç©º " + d + " çš„åŠ¨æ€ (ç”¨æˆ·)",
      value: "user"
    });
    Object.values(v.chats).forEach(a => {
      if (!a.isGroup) {
        c.push({
          text: "ä»…æ¸…ç©º " + a.name + " çš„åŠ¨æ€ (è§’è‰²)",
          value: a.id
        });
      }
    });
    try {
      const a = await Gb.npcs.toArray();
      if (a.length > 0) {
        c.push({
          isSeparator: true,
          text: "NPC åˆ—è¡¨"
        });
        a.forEach(a => {
          c.push({
            text: "ä»…æ¸…ç©º " + a.name + " çš„åŠ¨æ€ (NPC)",
            value: "npc_" + a.id
          });
        });
      }
    } catch (a) {
      console.error("åŠ è½½NPCåˆ—è¡¨å¤±è´¥:", a);
    }
    c.forEach(a => {
      if (a.isSeparator) {
        const c = document.createElement("div");
        c.textContent = a.text;
        c.style.cssText = `
                padding: 10px 18px 5px;
                font-size: 13px;
                font-weight: 500;
                color: var(--text-secondary);
                background-color: #f0f2f5;
                border-top: 1px solid var(--border-color);
                border-bottom: 1px solid var(--border-color);
                margin-top: 5px;
            `;
        b.appendChild(c);
        return;
      }
      const c = document.createElement("div");
      c.className = "clear-posts-item";
      if (a.isDanger) {
        c.classList.add("danger-option");
      }
      c.dataset.targetId = a.value;
      c.innerHTML = `
            <div class="checkbox"></div>
            <span class="name">` + a.text + "</span>\n        ";
      b.appendChild(c);
    });
    a.classList.add("visible");
  }
  async function hk() {
    const a = document.querySelectorAll("#clear-posts-list .clear-posts-item.selected");
    if (a.length === 0) {
      alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ¸…ç©ºçš„èŒƒå›´ã€‚");
      return;
    }
    const b = Array.from(a).map(a => a.dataset.targetId);
    let c = [];
    if (b.includes("all")) {
      c.push("æ‰€æœ‰åŠ¨æ€");
    } else {
      if (b.includes("user")) {
        c.push("â€œ" + v.qzoneSettings.nickname + "â€");
      }
      b.forEach(a => {
        const b = v.chats[a];
        if (b) {
          c.push("â€œ" + b.name + "â€");
        }
      });
    }
    const d = "æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤ " + c.join("ã€ ") + " çš„æ‰€æœ‰åŠ¨æ€ï¼Œä¸”æ— æ³•æ¢å¤ï¼";
    const e = await wb("ç¡®è®¤æ¸…ç©ºåŠ¨æ€ï¼Ÿ", d, {
      confirmButtonClass: "btn-danger",
      confirmText: "ç¡®è®¤æ¸…ç©º"
    });
    if (!e) {
      return;
    }
    try {
      if (b.includes("all")) {
        await Gb.qzonePosts.clear();
      } else {
        await Gb.qzonePosts.where("authorId").anyOf(b).delete();
      }
      Q = await Gb.qzonePosts.orderBy("timestamp").reverse().toArray();
      O = 0;
      await Sb();
      document.getElementById("clear-posts-modal").classList.remove("visible");
      await Bb("æ“ä½œæˆåŠŸ", "é€‰å®šèŒƒå›´å†…çš„åŠ¨æ€å·²è¢«æ¸…ç©ºã€‚");
    } catch (a) {
      console.error("æ¸…ç©ºåŠ¨æ€æ—¶å‡ºé”™:", a);
      await Bb("æ“ä½œå¤±è´¥", "æ¸…ç©ºåŠ¨æ€æ—¶å‘ç”Ÿé”™è¯¯: " + a.message);
    }
  }
  async function ik(a) {
    const b = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡å¿ƒå£°è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", {
      confirmButtonClass: "btn-danger",
      confirmText: "ç¡®è®¤åˆ é™¤"
    });
    if (b) {
      const b = v.chats[v.activeChatId];
      if (!b || !b.thoughtsHistory) {
        return;
      }
      const c = b.thoughtsHistory.findIndex(b => b.timestamp === a);
      if (c === -1) {
        return;
      }
      const d = c === b.thoughtsHistory.length - 1;
      b.thoughtsHistory = b.thoughtsHistory.filter(b => b.timestamp !== a);
      if (d) {
        if (b.thoughtsHistory.length > 0) {
          const a = b.thoughtsHistory[b.thoughtsHistory.length - 1];
          b.heartfeltVoice = a.heartfeltVoice;
          b.randomJottings = a.randomJottings;
          const c = document.getElementById("profile-heartfelt-voice");
          const d = document.getElementById("profile-random-jottings");
          if (c) {
            c.textContent = b.heartfeltVoice;
          }
          if (d) {
            d.textContent = b.randomJottings;
          }
          console.log("å·²åˆ é™¤æœ€æ–°å¿ƒå£°ï¼Œå½“å‰å¿ƒå£°å·²å›žæ»šè‡³ä¸Šä¸€æ¡ã€‚");
        } else {
          b.heartfeltVoice = "...";
          b.randomJottings = "...";
          const a = document.getElementById("profile-heartfelt-voice");
          const c = document.getElementById("profile-random-jottings");
          if (a) {
            a.textContent = b.heartfeltVoice;
          }
          if (c) {
            c.textContent = b.randomJottings;
          }
          console.log("å·²åˆ é™¤æœ€åŽä¸€æ¡å¿ƒå£°ï¼Œå½“å‰å¿ƒå£°å·²é‡ç½®ã€‚");
        }
      }
      await Gb.chats.put(b);
      yi();
      await Bb("æˆåŠŸ", "è¯¥æ¡è®°å½•å·²æˆåŠŸåˆ é™¤ã€‚");
    }
  }
  document.getElementById("thoughts-history-list").addEventListener("click", a => {
    const b = a.target.closest(".thought-delete-btn");
    if (b) {
      const a = parseInt(b.dataset.timestamp);
      if (!isNaN(a)) {
        ik(a);
      }
    }
  });
  async function jk() {
    const a = document.getElementById("css-preset-select");
    a.innerHTML = "<option value=\"\">-- é€‰æ‹©ä¸€ä¸ªé¢„è®¾ --</option>";
    const b = await Gb.appearancePresets.where("type").equals("global_css").toArray();
    b.forEach(b => {
      const c = document.createElement("option");
      c.value = b.id;
      c.textContent = b.name;
      a.appendChild(c);
    });
  }
  async function kk() {
    const a = document.getElementById("css-preset-select");
    const b = parseInt(a.value);
    if (isNaN(b)) {
      return;
    }
    const c = await Gb.appearancePresets.get(b);
    if (c) {
      const a = document.getElementById("global-css-input");
      a.value = c.value;
      pi(c.value);
    }
  }
  async function lk() {
    const a = await Db("ä¿å­˜CSSé¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°");
    if (!a || !a.trim()) {
      return;
    }
    const b = document.getElementById("global-css-input").value;
    const c = await Gb.appearancePresets.where({
      name: a.trim(),
      type: "global_css"
    }).first();
    if (c) {
      const d = await wb("è¦†ç›–é¢„è®¾", "åä¸º â€œ" + a.trim() + "â€ çš„é¢„è®¾å·²å­˜åœ¨ã€‚è¦è¦†ç›–å®ƒå—ï¼Ÿ", {
        confirmButtonClass: "btn-danger"
      });
      if (!d) {
        return;
      }
      await Gb.appearancePresets.update(c.id, {
        value: b
      });
    } else {
      await Gb.appearancePresets.add({
        name: a.trim(),
        type: "global_css",
        value: b
      });
    }
    await jk();
    alert("CSS é¢„è®¾å·²ä¿å­˜ï¼");
  }
  async function mk() {
    const a = document.getElementById("css-preset-select");
    const b = parseInt(a.value);
    if (isNaN(b)) {
      alert("è¯·å…ˆä»Žä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾ã€‚");
      return;
    }
    const c = await Gb.appearancePresets.get(b);
    if (!c) {
      return;
    }
    const d = await wb("åˆ é™¤é¢„è®¾", "ç¡®å®šè¦åˆ é™¤é¢„è®¾ â€œ" + c.name + "â€ å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (d) {
      await Gb.appearancePresets.delete(b);
      await jk();
      alert("é¢„è®¾å·²åˆ é™¤ã€‚");
    }
  }
  async function nk() {
    const a = document.getElementById("font-preset-select");
    a.innerHTML = "<option value=\"\">-- é€‰æ‹©ä¸€ä¸ªé¢„è®¾ --</option>";
    const b = await Gb.appearancePresets.where("type").equals("font").toArray();
    b.forEach(b => {
      const c = document.createElement("option");
      c.value = b.id;
      c.textContent = b.name;
      a.appendChild(c);
    });
  }
  async function ok() {
    const a = document.getElementById("font-preset-select");
    const b = parseInt(a.value);
    if (isNaN(b)) {
      return;
    }
    const c = await Gb.appearancePresets.get(b);
    if (c) {
      const a = document.getElementById("font-url-input");
      a.value = c.value;
      kc(c.value, true);
    }
  }
  async function pk() {
    const a = await Db("ä¿å­˜å­—ä½“é¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°");
    if (!a || !a.trim()) {
      return;
    }
    const b = document.getElementById("font-url-input").value.trim();
    if (!b) {
      alert("å­—ä½“URLä¸èƒ½ä¸ºç©ºï¼");
      return;
    }
    const c = await Gb.appearancePresets.where({
      name: a.trim(),
      type: "font"
    }).first();
    if (c) {
      const d = await wb("è¦†ç›–é¢„è®¾", "åä¸º â€œ" + a.trim() + "â€ çš„é¢„è®¾å·²å­˜åœ¨ã€‚è¦è¦†ç›–å®ƒå—ï¼Ÿ", {
        confirmButtonClass: "btn-danger"
      });
      if (!d) {
        return;
      }
      await Gb.appearancePresets.update(c.id, {
        value: b
      });
    } else {
      await Gb.appearancePresets.add({
        name: a.trim(),
        type: "font",
        value: b
      });
    }
    await nk();
    alert("å­—ä½“é¢„è®¾å·²ä¿å­˜ï¼");
  }
  async function qk() {
    const a = document.getElementById("font-preset-select");
    const b = parseInt(a.value);
    if (isNaN(b)) {
      alert("è¯·å…ˆä»Žä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾ã€‚");
      return;
    }
    const c = await Gb.appearancePresets.get(b);
    if (!c) {
      return;
    }
    const d = await wb("åˆ é™¤é¢„è®¾", "ç¡®å®šè¦åˆ é™¤é¢„è®¾ â€œ" + c.name + "â€ å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (d) {
      await Gb.appearancePresets.delete(b);
      await nk();
      alert("é¢„è®¾å·²åˆ é™¤ã€‚");
    }
  }
  async function rk(a = null) {
    const b = document.getElementById("appearance-preset-select");
    b.innerHTML = "<option value=\"\">-- é€‰æ‹©ä¸€ä¸ªé¢„è®¾ --</option>";
    const c = await Gb.appearancePresets.where("type").equals("appearance").toArray();
    c.forEach(a => {
      const c = document.createElement("option");
      c.value = a.id;
      c.textContent = a.name;
      b.appendChild(c);
    });
    if (a) {
      b.value = a;
      return;
    }
    const d = {
      wallpaper: v.globalSettings.wallpaper,
      cphoneWallpaper: v.globalSettings.cphoneWallpaper,
      globalChatBackground: v.globalSettings.globalChatBackground,
      appIcons: v.globalSettings.appIcons,
      cphoneAppIcons: v.globalSettings.cphoneAppIcons,
      chatActionButtonsOrder: v.globalSettings.chatActionButtonsOrder,
      theme: localStorage.getItem("ephone-theme") || "light",
      showStatusBar: v.globalSettings.showStatusBar,
      notificationSoundUrl: v.globalSettings.notificationSoundUrl,
      widgetData: v.globalSettings.widgetData
    };
    let e = null;
    for (const b of c) {
      if (JSON.stringify(b.value) === JSON.stringify(d)) {
        e = b.id;
        break;
      }
    }
    if (e) {
      b.value = e;
    } else {
      b.value = "";
    }
  }
  async function sk() {
    const a = document.getElementById("appearance-preset-select");
    const b = parseInt(a.value);
    if (isNaN(b)) {
      return;
    }
    const c = await Gb.appearancePresets.get(b);
    if (c && c.value) {
      const a = c.value;
      const d = {
        ...Xa,
        ...(a.appIcons || {})
      };
      const e = {
        ...Ya,
        ...(a.cphoneAppIcons || {})
      };
      Object.assign(v.globalSettings, a);
      v.globalSettings.appIcons = d;
      v.globalSettings.cphoneAppIcons = e;
      hh(a.theme || "light");
      await Gb.globalSettings.put(v.globalSettings);
      fd();
      Wg();
      $g();
      Yg();
      Zg();
      Xg();
      fk();
      Hj();
      if (a.chatActionButtonsOrder) {
        sm();
        wm();
      }
      ed(b);
      alert("å·²æˆåŠŸåŠ è½½å¤–è§‚é¢„è®¾ï¼šâ€œ" + c.name + "â€\n(ç¼ºå¤±çš„æ–°Appå›¾æ ‡å·²è‡ªåŠ¨é‡ç½®ä¸ºé»˜è®¤)");
    }
  }
  async function tk() {
    const a = await Db("ä¿å­˜å¤–è§‚é¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°");
    if (!a || !a.trim()) {
      return;
    }
    const b = {
      wallpaper: v.globalSettings.wallpaper,
      cphoneWallpaper: v.globalSettings.cphoneWallpaper,
      globalChatBackground: v.globalSettings.globalChatBackground,
      appIcons: v.globalSettings.appIcons,
      cphoneAppIcons: v.globalSettings.cphoneAppIcons,
      chatActionButtonsOrder: v.globalSettings.chatActionButtonsOrder,
      theme: localStorage.getItem("ephone-theme") || "light",
      showStatusBar: v.globalSettings.showStatusBar,
      notificationSoundUrl: v.globalSettings.notificationSoundUrl,
      widgetData: v.globalSettings.widgetData
    };
    const c = await Gb.appearancePresets.where({
      name: a.trim(),
      type: "appearance"
    }).first();
    if (c) {
      const d = await wb("è¦†ç›–é¢„è®¾", "åä¸º â€œ" + a.trim() + "â€ çš„é¢„è®¾å·²å­˜åœ¨ã€‚è¦è¦†ç›–å®ƒå—ï¼Ÿ", {
        confirmButtonClass: "btn-danger"
      });
      if (!d) {
        return;
      }
      await Gb.appearancePresets.update(c.id, {
        value: b
      });
    } else {
      await Gb.appearancePresets.add({
        name: a.trim(),
        type: "appearance",
        value: b
      });
    }
    await rk();
    alert("å¤–è§‚é¢„è®¾å·²ä¿å­˜ï¼");
  }
  async function uk() {
    const a = document.getElementById("appearance-preset-select");
    const b = parseInt(a.value);
    if (isNaN(b)) {
      alert("è¯·å…ˆä»Žä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾ã€‚");
      return;
    }
    const c = await Gb.appearancePresets.get(b);
    if (!c) {
      return;
    }
    const d = await wb("åˆ é™¤é¢„è®¾", "ç¡®å®šè¦åˆ é™¤é¢„è®¾ â€œ" + c.name + "â€ å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (d) {
      await Gb.appearancePresets.delete(b);
      await rk();
      alert("é¢„è®¾å·²åˆ é™¤ã€‚");
    }
  }
  async function vk() {
    const a = document.getElementById("theme-preset-select");
    a.innerHTML = "<option value=\"\">-- é€‰æ‹©ä¸€ä¸ªé¢„è®¾ --</option>";
    const b = await Gb.appearancePresets.where("type").equals("bubble_theme").toArray();
    b.forEach(b => {
      const c = document.createElement("option");
      c.value = b.id;
      c.textContent = b.name;
      a.appendChild(c);
    });
  }
  async function wk() {
    const a = document.getElementById("theme-preset-select");
    const b = parseInt(a.value);
    if (isNaN(b)) {
      return;
    }
    const c = await Gb.appearancePresets.get(b);
    if (c) {
      const a = c.value.base || "default";
      const b = c.value.custom || "";
      const d = document.querySelector("input[name=\"theme-select\"][value=\"" + a + "\"]");
      if (d) {
        d.checked = true;
      }
      const e = document.getElementById("custom-css-input");
      e.value = b;
      _e();
    }
  }
  async function xk() {
    const a = await Db("ä¿å­˜ä¸»é¢˜é¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°");
    if (!a || !a.trim()) {
      return;
    }
    const b = document.querySelector("input[name=\"theme-select\"]:checked");
    const c = b ? b.value : "default";
    const d = document.getElementById("custom-css-input").value.trim();
    const e = {
      base: c,
      custom: d
    };
    const f = await Gb.appearancePresets.where({
      name: a.trim(),
      type: "bubble_theme"
    }).first();
    if (f) {
      const b = await wb("è¦†ç›–é¢„è®¾", "åä¸º â€œ" + a.trim() + "â€ çš„é¢„è®¾å·²å­˜åœ¨ã€‚è¦è¦†ç›–å®ƒå—ï¼Ÿ", {
        confirmButtonClass: "btn-danger"
      });
      if (!b) {
        return;
      }
      await Gb.appearancePresets.update(f.id, {
        value: e
      });
    } else {
      await Gb.appearancePresets.add({
        name: a.trim(),
        type: "bubble_theme",
        value: e
      });
    }
    await vk();
    alert("ä¸»é¢˜é¢„è®¾å·²ä¿å­˜ï¼");
  }
  async function yk() {
    const a = document.getElementById("theme-preset-select");
    const b = parseInt(a.value);
    if (isNaN(b)) {
      alert("è¯·å…ˆä»Žä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾ã€‚");
      return;
    }
    const c = await Gb.appearancePresets.get(b);
    if (!c) {
      return;
    }
    const d = await wb("åˆ é™¤é¢„è®¾", "ç¡®å®šè¦åˆ é™¤é¢„è®¾ â€œ" + c.name + "â€ å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (d) {
      await Gb.appearancePresets.delete(b);
      await vk();
      alert("é¢„è®¾å·²åˆ é™¤ã€‚");
    }
  }
  async function zk() {
    await Ak();
    document.getElementById("sticker-category-manager-modal").classList.add("visible");
  }
  async function Ak() {
    const a = document.getElementById("existing-sticker-categories-list");
    const b = await Gb.stickerCategories.toArray();
    a.innerHTML = "";
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align: center; color: var(--text-secondary);\">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>";
      return;
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "existing-group-item";
      c.innerHTML = "\n                    <span class=\"group-name\">" + b.name + "</span>\n                    <span class=\"delete-group-btn\" data-id=\"" + b.id + "\">Ã—</span>\n                ";
      a.appendChild(c);
    });
  }
  async function Bk() {
    const a = document.getElementById("new-sticker-category-name-input");
    const b = a.value.trim();
    if (!b) {
      alert("åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼");
      return;
    }
    const c = await Gb.stickerCategories.where("name").equals(b).first();
    if (c) {
      alert("åˆ†ç±» \"" + b + "\" å·²ç»å­˜åœ¨äº†ï¼");
      return;
    }
    await Gb.stickerCategories.add({
      name: b
    });
    a.value = "";
    await Ak();
  }
  async function Ck(a) {
    const b = await Gb.stickerCategories.get(a);
    if (!b) {
      return;
    }
    const c = await Gb.userStickers.where("categoryId").equals(a).count();
    const d = c > 0 ? "ç¡®å®šè¦åˆ é™¤åˆ†ç±»ã€Š" + b.name + `ã€‹å—ï¼Ÿ

ã€è­¦å‘Šã€‘
æ­¤æ“ä½œå°†åŒæ—¶æ°¸ä¹…åˆ é™¤è¯¥åˆ†ç±»ä¸‹çš„ ` + c + " ä¸ªè¡¨æƒ…åŒ…ï¼Œä¸”æ— æ³•æ¢å¤ï¼" : "ç¡®å®šè¦åˆ é™¤åˆ†ç±»ã€Š" + b.name + "ã€‹å—ï¼Ÿ";
    const e = await wb("ç¡®è®¤åˆ é™¤åˆ†ç±»", d, {
      confirmButtonClass: "btn-danger"
    });
    if (e) {
      try {
        await Gb.transaction("rw", Gb.stickerCategories, Gb.userStickers, async () => {
          const b = await Gb.userStickers.where("categoryId").equals(a).primaryKeys();
          if (b.length > 0) {
            await Gb.userStickers.bulkDelete(b);
          }
          await Gb.stickerCategories.delete(a);
        });
        v.userStickers = await Gb.userStickers.toArray();
        if (ba === a) {
          ba = "all";
        }
        await Ak();
        await kd();
        alert("åˆ†ç±»ã€Š" + b.name + "ã€‹åŠå…¶ä¸‹çš„è¡¨æƒ…å·²æˆåŠŸåˆ é™¤ã€‚");
      } catch (a) {
        console.error("åˆ é™¤åˆ†ç±»åŠè¡¨æƒ…æ—¶å‡ºé”™:", a);
        alert("åˆ é™¤å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æŽ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚");
      }
    }
  }
  function Dk(a) {
    ba = a;
    document.querySelectorAll(".sticker-category-tab").forEach(b => {
      b.classList.toggle("active", String(b.dataset.categoryId) === String(a));
    });
    kd(false);
    const b = document.getElementById("select-all-stickers-checkbox");
    if (b) {
      b.checked = false;
    }
  }
  async function Ek() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.chats[v.activeChatId];
    if (!a) {
      return;
    }
    try {
      const b = {
        type: "EPhoneSingleChat",
        version: 1,
        chatData: a
      };
      const c = new Blob([JSON.stringify(b, null, 2)], {
        type: "application/json"
      });
      const d = URL.createObjectURL(c);
      const e = document.createElement("a");
      e.href = d;
      e.download = "EPhone-Chat-" + a.name + "-" + new Date().toISOString().split("T")[0] + ".json";
      e.click();
      URL.revokeObjectURL(d);
      await Bb("å¯¼å‡ºæˆåŠŸ", "ä¸Žâ€œ" + a.name + "â€çš„èŠå¤©è®°å½•å·²æˆåŠŸå¯¼å‡ºï¼");
    } catch (a) {
      console.error("å¯¼å‡ºå•ä¸ªèŠå¤©æ—¶å‡ºé”™:", a);
      await Bb("å¯¼å‡ºå¤±è´¥", "å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: " + a.message);
    }
  }
  async function Fk(a) {
    if (!a || !v.activeChatId) {
      return;
    }
    const b = v.activeChatId;
    const c = v.chats[b];
    try {
      const d = await a.text();
      const e = JSON.parse(d);
      if (e.type !== "EPhoneSingleChat" || !e.chatData) {
        throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å•èŠå¤‡ä»½æ–‡ä»¶ã€‚");
      }
      const f = await wb("ä¸¥é‡è­¦å‘Šï¼", "è¿™å°†ç”¨å¤‡ä»½æ–‡ä»¶ä¸­çš„æ•°æ®ã€å®Œå…¨è¦†ç›–ã€‘å½“å‰ä¸Žâ€œ" + c.name + "â€çš„èŠå¤©è®°å½•å’Œè®¾ç½®ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼<br><br><strong>ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ</strong>", {
        confirmButtonClass: "btn-danger",
        confirmText: "ç¡®è®¤è¦†ç›–"
      });
      if (!f) {
        return;
      }
      const g = e.chatData;
      g.id = b;
      await Gb.chats.put(g);
      v.chats[b] = g;
      await Bb("å¯¼å…¥æˆåŠŸ", "èŠå¤©è®°å½•å·²æˆåŠŸè¦†ç›–ï¼æ­£åœ¨åˆ·æ–°ç•Œé¢...");
      cd(b);
      _c();
      document.getElementById("chat-settings-btn").click();
    } catch (a) {
      console.error("å¯¼å…¥å•ä¸ªèŠå¤©æ—¶å‡ºé”™:", a);
      await Bb("å¯¼å…¥å¤±è´¥", "æ–‡ä»¶è§£æžæˆ–åº”ç”¨å¤±è´¥: " + a.message);
    }
  }
  function Gk() {
    Hk();
    Kb("character-selection-screen");
  }
  function Hk() {
    const a = document.getElementById("character-grid");
    a.innerHTML = "";
    const b = Object.values(v.chats).filter(a => !a.isGroup);
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">è¿˜æ²¡æœ‰å¯ä»¥æŸ¥çœ‹æ‰‹æœºçš„è§’è‰²å“¦~</p>";
      return;
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "character-select-item";
      c.innerHTML = "\n            <img src=\"" + (b.settings.aiAvatar || Na) + "\" class=\"avatar\">\n            <span class=\"name\">" + b.name + "</span>\n        ";
      c.addEventListener("click", () => Ik(b.id));
      a.appendChild(c);
    });
  }
  async function Ik(a) {
    ra = a;
    console.log("å·²åˆ‡æ¢åˆ°è§’è‰² " + a + " çš„æ‰‹æœº");
    Wg();
    Xg();
    Kk();
    Kb("character-phone-screen");
  }
  function Jk() {
    ra = null;
    console.log("å·²è¿”å›žæˆ‘çš„æ‰‹æœº");
    Kb("home-screen");
  }
  function Kk() {
    Lk("char-home-screen");
  }
  window.editBubbleText = async function (a) {
    const b = document.getElementById(a);
    if (!b) {
      return;
    }
    if (b.tagName === "INPUT") {
      return;
    }
    const c = b.innerText;
    const d = b.parentElement;
    const e = document.createElement("input");
    e.type = "text";
    e.value = c;
    e.className = "bubble-edit-input";
    const f = window.getComputedStyle(b);
    e.style.fontFamily = f.fontFamily;
    e.style.fontSize = f.fontSize;
    e.style.fontWeight = f.fontWeight;
    e.style.textAlign = f.textAlign;
    async function g() {
      const c = e.value.trim();
      if (c) {
        b.innerText = c;
        if (!v.globalSettings.widgetData) {
          v.globalSettings.widgetData = {};
        }
        v.globalSettings.widgetData[a] = c;
        await Gb.globalSettings.put(v.globalSettings);
      }
      if (e.parentNode) {
        e.replaceWith(b);
      }
    }
    e.addEventListener("blur", g);
    e.addEventListener("keydown", function (a) {
      if (a.key === "Enter") {
        e.blur();
      }
    });
    b.replaceWith(e);
    e.focus();
    if (window.event) {
      window.event.stopPropagation();
    }
  };
  function Lk(a) {
    document.querySelectorAll(".char-screen").forEach(a => a.classList.remove("active"));
    document.getElementById(a).classList.add("active");
  }
  window.switchToCharScreen = Lk;
  async function Mk(a) {
    if (!ra) {
      return;
    }
    const b = v.chats[ra];
    await Sk(ra, a);
    switch (a) {
      case "qq":
        el();
        Lk("char-qq-screen");
        break;
      case "album":
        Nk();
        Lk("char-album-screen");
        break;
      case "browser":
        Ok();
        Lk("char-browser-screen");
        break;
      case "taobao":
        Pk();
        Lk("char-taobao-screen");
        break;
      case "memo":
        Wk();
        Lk("char-memo-screen");
        break;
      case "diary":
        _k();
        Lk("char-diary-screen");
        break;
      case "amap":
        ul();
        Lk("char-amap-screen");
        break;
      case "music":
        zl();
        Lk("char-music-screen");
        break;
      case "bilibili":
        document.getElementById("char-bilibili-search-input").value = "";
        xl();
        Lk("char-bilibili-screen");
        break;
      case "reddit":
        const a = document.getElementById("char-reddit-list");
        a.innerHTML = "<p style=\"text-align:center; padding:50px 0; color:#999;\">åŠŸèƒ½å·²åœç”¨</p>";
        Lk("char-reddit-screen");
        break;
    }
  }
  async function Nk() {
    const a = document.getElementById("char-album-grid");
    a.innerHTML = "";
    if (!ra) {
      return;
    }
    const b = v.chats[ra];
    const c = b.simulatedAlbum || [];
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">TAçš„ç›¸å†Œè¿˜æ˜¯ç©ºçš„ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›ç…§ç‰‡å§ï¼</p>";
      return;
    }
    const d = "https://i.postimg.cc/KYr2qRCK/1.jpg";
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "char-photo-item";
      c.dataset.description = b.description;
      a.appendChild(c);
      if (v.globalSettings.enableAiDrawing) {
        c.style.backgroundColor = "#e9ecef";
        const a = /[^\x00-\x7F]/.test(b.image_prompt);
        const e = b.image_prompt && b.image_prompt.trim() && !a;
        const f = e ? b.image_prompt : "a beautiful scenery, anime style, cinematic lighting";
        const g = "https://image.pollinations.ai/prompt/" + encodeURIComponent(f);
        const h = new Image();
        h.onload = function () {
          c.style.backgroundImage = "url(" + this.src + ")";
        };
        h.onerror = function () {
          c.style.backgroundImage = "url(" + d + ")";
        };
        h.src = g;
      } else {
        c.style.backgroundColor = "#f0f2f5";
        c.style.border = "1px solid #e0e0e0";
        const a = document.createElement("p");
        a.className = "char-photo-description";
        a.textContent = b.description || "(è¿™å¼ ç…§ç‰‡æ²¡æœ‰æè¿°)";
        c.appendChild(a);
      }
    });
  }
  function Ok() {
    const a = document.getElementById("char-browser-history");
    a.innerHTML = "";
    if (!ra) {
      return;
    }
    const b = v.chats[ra];
    if (!b.simulatedBrowserHistory || b.simulatedBrowserHistory.length === 0) {
      const a = [b.name, "çˆ±å¥½", "æ—…æ¸¸", "ç¾Žé£Ÿ", "æ–°é—»", ...b.settings.aiPersona.split(/ï¼Œ|ã€‚|\s/).slice(0, 5)];
      const c = ["çŸ¥ä¹Ž", "Bilibili", "å°çº¢ä¹¦", "å¾®åš", "ç»´åŸºç™¾ç§‘"];
      const d = [];
      for (let b = 0; b < 10; b++) {
        const b = a[Math.floor(Math.random() * a.length)];
        const e = c[Math.floor(Math.random() * c.length)];
        d.push({
          title: b + " - " + e,
          url: "www." + e.toLowerCase() + ".com",
          content: "å†…å®¹åŠ è½½ä¸­..."
        });
      }
      b.simulatedBrowserHistory = d;
    }
    const c = b.simulatedBrowserHistory || [];
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">TAçš„æµè§ˆå™¨ç©ºç©ºå¦‚ä¹Ÿï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›è®°å½•å§ï¼</p>";
      return;
    }
    const d = "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"></circle><line x1=\"2\" y1=\"12\" x2=\"22\" y2=\"12\"></line><path d=\"M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z\"></path></svg>";
    const e = "<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"9 18 15 12 9 6\"></polyline></svg>";
    c.forEach((b, c) => {
      const f = document.createElement("div");
      f.className = "char-browser-item";
      let g = b.url.replace(/^https?:\/\//, "").replace(/^www\./, "");
      if (g.length > 25) {
        g = g.substring(0, 25) + "...";
      }
      f.innerHTML = `
            <div class="char-browser-icon-box">
                ` + d + `
            </div>
            <div class="char-browser-info">
                <div class="title">` + b.title + "</div>\n                <div class=\"url\">" + g + `</div>
            </div>
            <div class="char-browser-arrow">
                ` + e + `
            </div>
        `;
      f.addEventListener("click", () => ml(c));
      a.appendChild(f);
    });
  }
  function Pk() {
    const a = document.getElementById("char-product-grid");
    a.innerHTML = "";
    if (!ra) {
      return;
    }
    const b = v.chats[ra];
    const c = b.simulatedTaobaoHistory?.purchases || [];
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">TAæœ€è¿‘å¥½åƒä»€ä¹ˆéƒ½æ²¡ä¹°å‘¢ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›è®°å½•å§ï¼</p>";
      return;
    }
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "char-product-item";
      c.dataset.reason = b.reason;
      let d;
      if (v.globalSettings.enableAiDrawing) {
        const a = "https://image.pollinations.ai/prompt/" + encodeURIComponent(b.image_prompt || "a random product");
        d = "<img src=\"" + a + "\" class=\"product-image\">";
      } else {
        d = `
                        <div class="char-product-description-overlay">
                            <p class="char-photo-description">` + (b.reason || "(æ— è´­ä¹°ç†ç”±)") + `</p>
                        </div>
                    `;
      }
      c.innerHTML = "\n                    " + d + `
                    <div class="product-info">
                        <div class="product-name">` + b.itemName + `</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <div class="product-price">` + (b.price || 0).toFixed(2) + "</div>\n                            <div class=\"char-product-status\">" + b.status + `</div>
                        </div>
                    </div>
                `;
      a.appendChild(c);
    });
  }
  function Qk() {
    Lk("char-home-screen");
  }
  function Rk() {
    const a = document.getElementById("char-chat-list");
    a.innerHTML = "";
    if (!ra) {
      return;
    }
    const b = Object.values(v.chats).filter(a => {
      if (a.id === ra) {
        return true;
      }
      if (a.isGroup && a.members.some(a => a.id === ra)) {
        return true;
      }
      return false;
    });
    b.forEach(b => {
      const c = bd(b);
      a.appendChild(c);
    });
  }
  async function Sk(a, b) {
    const c = v.chats[a];
    if (!c) {
      return;
    }
    if (!c.appUsageLog) {
      c.appUsageLog = [];
    }
    c.appUsageLog.push({
      appName: b,
      timestamp: Date.now()
    });
    if (c.appUsageLog.length > 50) {
      c.appUsageLog.shift();
    }
    await Gb.chats.put(c);
  }
  function Tk() {
    const a = document.getElementById("char-usage-list");
    a.innerHTML = "";
    const b = v.chats[ra];
    const c = (b.appUsageLog || []).slice().reverse();
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">è¿˜æ²¡æœ‰ä»»ä½•ä½¿ç”¨è®°å½•ã€‚</p>";
      return;
    }
    const d = {
      qq: "QQ",
      album: "ç›¸å†Œ",
      browser: "æµè§ˆå™¨",
      taobao: "æ·˜å®",
      memo: "å¤‡å¿˜å½•",
      diary: "æ—¥è®°",
      amap: "é«˜å¾·åœ°å›¾",
      usage: "Appè®°å½•"
    };
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "usage-item";
      c.innerHTML = "\n            <div class=\"timestamp\">" + new Date(b.timestamp).toLocaleString() + "</div>\n            <div class=\"action\">æ‰“å¼€äº† <strong>" + (d[b.appName] || b.appName) + "</strong></div>\n        ";
      a.appendChild(c);
    });
  }
  async function Uk(a) {
    const b = v.chats[ra];
    if (!b) {
      return;
    }
    const c = {
      role: "assistant",
      senderName: b.originalName,
      type: "location_share",
      content: a,
      imageUrl: "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg",
      timestamp: Date.now()
    };
    b.history.push(c);
    await Gb.chats.put(b);
    if (v.activeChatId === ra) {
      Pd(c, b);
    }
    await Bb("åˆ†äº«æˆåŠŸ", "â€œ" + b.name + "â€ çš„ä½ç½®å·²å‘é€åˆ°ä½ ä»¬çš„èŠå¤©ä¸­ã€‚");
  }
  async function Vk(a) {
    const b = v.chats[ra];
    if (!b || !b.memos) {
      return;
    }
    const c = b.memos.find(b => b.id === a);
    if (c) {
      wa = c;
      const b = document.getElementById("char-memo-detail-title");
      const d = document.getElementById("char-memo-detail-content");
      const e = document.getElementById("favorite-memo-btn");
      if (b) {
        b.textContent = c.title;
      }
      if (d) {
        d.value = c.content;
      }
      const f = await Gb.favorites.where({
        type: "char_memo",
        "content.id": a
      }).first();
      e.classList.toggle("active", !!f);
      Lk("char-memo-detail-screen");
    }
  }
  function Wk() {
    const a = document.getElementById("char-memo-list");
    a.innerHTML = "";
    const b = v.chats[ra];
    const c = (b.memos || []).slice().reverse();
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">è¿˜æ²¡æœ‰å¤‡å¿˜å½•ã€‚</p>";
      return;
    }
    const d = "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\"></path><polyline points=\"14 2 14 8 20 8\"></polyline><line x1=\"16\" y1=\"13\" x2=\"8\" y2=\"13\"></line><line x1=\"16\" y1=\"17\" x2=\"8\" y2=\"17\"></line><polyline points=\"10 9 9 9 8 9\"></polyline></svg>";
    const e = "<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"9 18 15 12 9 6\"></polyline></svg>";
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "memo-item";
      const f = (b.content || "").split("\n")[0] || "æ— å†…å®¹";
      c.innerHTML = `
            <div class="cphone-item-icon-box memo-icon-style">
                ` + d + `
            </div>
            <div class="cphone-item-info">
                <div class="cphone-item-title">` + b.title + "</div>\n                <div class=\"cphone-item-preview\">" + f + `</div>
            </div>
            <div class="cphone-item-arrow">
                ` + e + `
            </div>
        `;
      c.addEventListener("click", () => Vk(b.id));
      _d(c, () => deleteMemo(b.id));
      a.appendChild(c);
    });
  }
  async function Xk(a = null) {
    sa = null;
    const b = await Db("æ–°å»ºå¤‡å¿˜å½•", "è¯·è¾“å…¥æ ‡é¢˜");
    if (b === null || !b.trim()) {
      return;
    }
    const c = await Db("æ ‡é¢˜: " + b, "è¯·è¾“å…¥å¤‡å¿˜å½•å†…å®¹", "", "textarea");
    if (c !== null) {
      await Yk({
        title: b.trim(),
        content: c
      });
      Lk("char-memo-screen");
    }
  }
  async function Yk(a) {
    const b = v.chats[ra];
    if (!b.memos) {
      b.memos = [];
    }
    b.memos.push({
      id: Date.now(),
      title: a.title,
      content: a.content
    });
    await Gb.chats.put(b);
    Wk();
  }
  async function Yk(a) {
    const b = v.chats[ra];
    if (!b.memos) {
      b.memos = [];
    }
    if (sa) {
      const c = b.memos.find(a => a.id === sa);
      if (c) {
        c.content = a;
      }
    } else {
      b.memos.push({
        id: Date.now(),
        content: a
      });
    }
    await Gb.chats.put(b);
    Wk();
    sa = null;
  }
  async function Zk() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚â€œ" + a.name + "â€ç¿»å¼€TAçš„æ—¥è®°æœ¬...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚");
      return;
    }
    const e = v.qzoneSettings.nickname === "{{user}}" || !v.qzoneSettings.nickname ? "ç”¨æˆ·" : v.qzoneSettings.nickname;
    const f = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ";
    const g = a.settings.maxMemory || 10;
    const h = a.history.slice(-g);
    const i = await vj(h, ra);
    const j = i.map(b => (b.role === "user" ? e : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    const k = (a.settings.linkedWorldBookIds || []).map(a => v.worldBooks.find(b => b.id === a)).filter(Boolean).map(a => "\n## ä¸–ç•Œä¹¦ã€Š" + a.name + "ã€‹è®¾å®š:\n" + a.content.filter(a => a.enabled).map(a => "- " + a.content).join("\n")).join("");
    const l = th(a, 3, "hours");
    const m = th(a, 6, "hours");
    const n = th(a, 9, "hours");
    const o = th(a, 1, "days");
    const q = th(a, 3, "days");
    const r = th(a, 7, "days");
    let s = "";
    if (l || m || n || o || q || r) {
      s += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„å¯¹è¯å›žé¡¾)
`;
      if (l) {
        s += l;
      }
      if (m) {
        s += m;
      }
      if (n) {
        s += n;
      }
      if (l || m || n) {
        s += "\n";
      }
      if (o) {
        s += o;
      }
      if (q) {
        s += q;
      }
      if (r) {
        s += r;
      }
    }
    const t = a.settings.myPersona || "(æœªè®¾ç½®)";
    const u = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨å’Œæ•…äº‹ä½œå®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ` + a.name + `â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæž„å‡ºã€5åˆ°8ç¯‡ã€‘TAæœ€è¿‘å¯èƒ½ä¼šå†™çš„æ—¥è®°ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€æ—¶é—´ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**:
    -   ä»Šå¤©çš„æ—¥æœŸæ˜¯ **` + new Date().toLocaleDateString("zh-CN") + `**ã€‚
    -   ä½ ç”Ÿæˆçš„ã€æ‰€æœ‰ã€‘æ—¥è®°çš„æ ‡é¢˜æ—¥æœŸï¼Œã€å¿…é¡»ã€‘æ˜¯ä»Šå¤©æˆ–ä»Šå¤©ä»¥å‰çš„æ—¥æœŸã€‚
    -   ã€ç»å¯¹ç¦æ­¢ã€‘ç”Ÿæˆä»»ä½•æœªæ¥çš„æ—¥æœŸï¼
2.  **ã€æ²‰æµ¸æ„Ÿã€‘**: æ¯ä¸€ç¯‡æ—¥è®°éƒ½å¿…é¡»ä½¿ç”¨ã€ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘æ¥å†™ï¼Œå¹¶ä¸”è¦å……æ»¡è§’è‰²çš„ä¸ªäººæƒ…æ„Ÿã€æ€è€ƒå’Œç§˜å¯†ã€‚åœ¨æ—¥è®°ä¸­æè¿°è‡ªå·±çš„è¡Œä¸ºæˆ–æƒ³æ³•æ—¶ï¼Œã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ç¬¬ä¸‰äººç§°â€œä»–â€æˆ–â€œå¥¹â€ (TA)ã€‚
3.  **ã€é•¿åº¦ã€‘**: æ¯ä¸€ç¯‡æ—¥è®°çš„æ­£æ–‡é•¿åº¦ã€å¿…é¡»ä¸å°‘äºŽ300å­—ã€‘ã€‚
4.  **ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: 
    - ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›žå¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åŽæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€ç¯‡æ—¥è®°ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "title": "è¿™ç¯‡æ—¥è®°çš„æ ‡é¢˜ï¼Œä¾‹å¦‚ï¼š9æœˆ20æ—¥ æ™´",
        "content": "è¿™é‡Œæ˜¯æ—¥è®°çš„è¯¦ç»†æ­£æ–‡ï¼Œå¿…é¡»æ”¯æŒæ¢è¡Œç¬¦\\nï¼Œå¹¶ä¸”å¿…é¡»å·§å¦™åœ°ä½¿ç”¨ä¸‹é¢çš„ã€æ—¥è®°ä¸“å±žMarkdownè¯­æ³•ã€‘æ¥ä¸°å¯Œæ–‡æœ¬è¡¨çŽ°åŠ›ã€‚"
      }
    ]
    \`\`\`
5.  **ã€å ä½ç¬¦æ›¿æ¢ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: åœ¨ä½ çš„æ—¥è®°å†…å®¹ä¸­ï¼Œã€ç»å¯¹ä¸èƒ½ã€‘å‡ºçŽ° "{{user}}" è¿™ä¸ªå ä½ç¬¦ã€‚ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ â€œ` + e + `â€ æ¥æŒ‡ä»£ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰ã€‚
6.  **ã€æ—¥è®°ä¸“å±žMarkdownè¯­æ³• (å¿…é¡»ä½¿ç”¨ï¼)ã€‘**:
    -   \`**åŠ ç²—æ–‡å­—**\`: ç”¨äºŽå¼ºè°ƒã€‚
    -   \`~~åˆ’æŽ‰çš„æ–‡å­—~~\`: ç”¨äºŽè¡¨ç¤ºæ”¹å˜ä¸»æ„æˆ–è‡ªæˆ‘å¦å®šã€‚
    -   \`!h{é»„è‰²é«˜äº®}\`: ç”¨äºŽæ ‡è®°å…³é”®è¯æˆ–é‡è¦ä¿¡æ¯ã€‚
    -   \`!u{ç²‰è‰²ä¸‹åˆ’çº¿}\`: ç”¨äºŽæ ‡æ³¨äººåã€åœ°åæˆ–ç‰¹æ®Šåè¯ã€‚
    -   \`!e{ç²‰è‰²å¼ºè°ƒ}\`: ç”¨äºŽè¡¨è¾¾å¼ºçƒˆçš„æƒ…ç»ªã€‚
    -   \`!w{æ‰‹å†™ä½“}\`: ç”¨äºŽå†™ä¸‹å¼•è¨€ã€æ­Œè¯æˆ–ç‰¹æ®Šç¬”è®°ã€‚
    -   \`!m{å‡Œä¹±çš„æ‰‹å†™ä½“}\`: ç”¨äºŽè¡¨è¾¾æ¿€åŠ¨ã€æ…Œä¹±æˆ–æ½¦è‰è®°å½•æ—¶çš„å¿ƒæƒ…ã€‚
    -   \`||æ¶‚é»‘||\`: ç”¨äºŽéšè—ç§˜å¯†æˆ–æ•æ„Ÿè¯æ±‡ (æ¯æ¬¡æ¶‚é»‘2~5ä¸ªå­—)ã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ` + a.settings.aiPersona + "\n- **ä½ çš„èŠå¤©å¯¹è±¡è®¾å®š**:" + t + `
- **ä½ çš„é•¿æœŸè®°å¿†**:
` + f + "\n" + k + "\n" + s + " \n- **ä½ æœ€è¿‘å’Œâ€œ" + e + "â€çš„å¯¹è¯æ‘˜è¦**:\n" + j + `

çŽ°åœ¨ï¼Œè¯·å¼€å§‹æ’°å†™è¿™ç»„å……æ»¡çœŸæƒ…å®žæ„Ÿã€å¹¶ç†Ÿç»ƒè¿ç”¨äº†Markdownè¯­æ³•çš„æ—¥è®°ã€‚`;
    try {
      const e = [{
        role: "user",
        content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„æ—¥è®°å†…å®¹ã€‚"
      }];
      let f = b.includes("generativelanguage");
      let g = p(d, c, u, e);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: u
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 0.95
        })
      });
      if (!h.ok) {
        throw new Error("API é”™è¯¯: " + h.statusText);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/(\[[\s\S]*\])/);
      if (!k || !k[0]) {
        throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŽŸå§‹è¿”å›ž: " + j);
      }
      const l = k[0];
      let m;
      try {
        m = JSON.parse(l);
      } catch (a) {
        throw new Error("è§£æžAIè¿”å›žçš„JSONæ—¶å‡ºé”™: " + a.message + `

AIåŽŸå§‹è¿”å›žå†…å®¹:
` + j);
      }
      a.diary = m.map(a => ({
        id: Date.now() + Math.random(),
        title: a.title,
        content: a.content,
        timestamp: Date.now()
      }));
      await Gb.chats.put(a);
      await _k();
    } catch (a) {
      console.error("ç”Ÿæˆæ¨¡æ‹Ÿæ—¥è®°å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆæ—¥è®°ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  async function $k() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚â€œ" + a.name + "â€å†™ä¸€ç¯‡æ–°æ—¥è®°...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      return;
    }
    const e = v.qzoneSettings.nickname === "{{user}}" || !v.qzoneSettings.nickname ? "ç”¨æˆ·" : v.qzoneSettings.nickname;
    const f = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ";
    const g = a.settings.maxMemory || 10;
    const h = a.history.slice(-g);
    const i = await vj(h, ra);
    const j = i.map(b => (b.role === "user" ? e : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    const k = (a.settings.linkedWorldBookIds || []).map(a => v.worldBooks.find(b => b.id === a)).filter(Boolean).map(a => "\n## ä¸–ç•Œä¹¦ã€Š" + a.name + "ã€‹è®¾å®š:\n" + a.content.filter(a => a.enabled).map(a => "- " + a.content).join("\n")).join("");
    const l = `          
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨å’Œæ•…äº‹ä½œå®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ` + a.name + `â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæž„å‡ºã€1ç¯‡ã€‘TAä»Šå¤©å¯èƒ½ä¼šå†™çš„æ—¥è®°ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€æ—¶é—´é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘ã€‘ã€‘**:
    -   ä»Šå¤©çš„æ—¥æœŸæ˜¯ **` + new Date().toLocaleDateString("zh-CN") + `**ã€‚
    -   ä½ ç”Ÿæˆçš„æ—¥è®°æ ‡é¢˜æ—¥æœŸã€å¿…é¡»ã€‘æ˜¯ä»Šå¤©æˆ–ä»Šå¤©ä»¥å‰çš„æ—¥æœŸã€‚
    -   ã€ç»å¯¹ç¦æ­¢ã€‘ç”Ÿæˆä»»ä½•æœªæ¥çš„æ—¥æœŸï¼
2.  **ã€ã€ã€æ²‰æµ¸æ„Ÿé“å¾‹ã€‘ã€‘ã€‘**: æ—¥è®°å¿…é¡»ä½¿ç”¨ã€ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘æ¥å†™ï¼Œå¹¶ä¸”è¦å……æ»¡è§’è‰²çš„ä¸ªäººæƒ…æ„Ÿã€æ€è€ƒå’Œç§˜å¯†ã€‚åœ¨æ—¥è®°ä¸­æè¿°è‡ªå·±çš„è¡Œä¸ºæˆ–æƒ³æ³•æ—¶ï¼Œã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ç¬¬ä¸‰äººç§°â€œä»–â€æˆ–â€œå¥¹â€ (TA)ã€‚
3.  **ã€ã€ã€é•¿åº¦é“å¾‹ã€‘ã€‘ã€‘**: æ—¥è®°çš„æ­£æ–‡é•¿åº¦ã€å¿…é¡»ä¸å°‘äºŽ300å­—ã€‘ã€‚
4.  **ã€ã€ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘ã€‘ã€‘**: ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œä¸”æ•°ç»„ä¸­ã€åªåŒ…å«ä¸€ä¸ªã€‘å¯¹è±¡ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "title": "è¿™ç¯‡æ—¥è®°çš„æ ‡é¢˜ï¼Œä¾‹å¦‚ï¼š9æœˆ20æ—¥ æ™´",
        "content": "è¿™é‡Œæ˜¯æ—¥è®°çš„è¯¦ç»†æ­£æ–‡ï¼Œå¿…é¡»æ”¯æŒæ¢è¡Œç¬¦\\nï¼Œå¹¶ä¸”å¿…é¡»å·§å¦™åœ°ä½¿ç”¨ä¸‹é¢çš„ã€æ—¥è®°ä¸“å±žMarkdownè¯­æ³•ã€‘æ¥ä¸°å¯Œæ–‡æœ¬è¡¨çŽ°åŠ›ã€‚"
      }
    ]
    \`\`\`
5.  **ã€ã€ã€æ—¥è®°ä¸“å±žMarkdownè¯­æ³• (å¿…é¡»ä½¿ç”¨ï¼)ã€‘ã€‘ã€‘**:
    -   \`**åŠ ç²—æ–‡å­—**\`: ç”¨äºŽå¼ºè°ƒã€‚
    -   \`~~åˆ’æŽ‰çš„æ–‡å­—~~\`: ç”¨äºŽè¡¨ç¤ºæ”¹å˜ä¸»æ„æˆ–è‡ªæˆ‘å¦å®šã€‚
    -   \`!h{é»„è‰²é«˜äº®}\`: ç”¨äºŽæ ‡è®°å…³é”®è¯æˆ–é‡è¦ä¿¡æ¯ã€‚
    -   \`!u{ç²‰è‰²ä¸‹åˆ’çº¿}\`: ç”¨äºŽæ ‡æ³¨äººåã€åœ°åæˆ–ç‰¹æ®Šåè¯ã€‚
    -   \`!e{ç²‰è‰²å¼ºè°ƒ}\`: ç”¨äºŽè¡¨è¾¾å¼ºçƒˆçš„æƒ…ç»ªã€‚
    -   \`!w{æ‰‹å†™ä½“}\`: ç”¨äºŽå†™ä¸‹å¼•è¨€ã€æ­Œè¯æˆ–ç‰¹æ®Šç¬”è®°ã€‚
    -   \`!m{å‡Œä¹±çš„æ‰‹å†™ä½“}\`: ç”¨äºŽè¡¨è¾¾æ¿€åŠ¨ã€æ…Œä¹±æˆ–æ½¦è‰è®°å½•æ—¶çš„å¿ƒæƒ…ã€‚
    -   \`||æ¶‚é»‘||\`: ç”¨äºŽéšè—ç§˜å¯†æˆ–æ•æ„Ÿè¯æ±‡(æ¯æ¬¡æ¶‚é»‘2~5ä¸ªå­—)ã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ` + a.settings.aiPersona + `
- **ä½ çš„é•¿æœŸè®°å¿†**:
` + f + "\n" + k + "\n- **ä½ æœ€è¿‘å’Œâ€œ" + e + "â€çš„å¯¹è¯æ‘˜è¦**:\n" + j + `

çŽ°åœ¨ï¼Œè¯·å¼€å§‹æ’°å†™è¿™ç¯‡å……æ»¡çœŸæƒ…å®žæ„Ÿã€å¹¶ç†Ÿç»ƒè¿ç”¨äº†Markdownè¯­æ³•çš„æ—¥è®°ã€‚`;
    try {
      const e = [{
        role: "user",
        content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œå†™ä¸€ç¯‡æ–°æ—¥è®°ã€‚"
      }];
      let f = b.includes("generativelanguage");
      let g = p(d, c, l, e);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: l
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 0.95
        })
      });
      if (!h.ok) {
        throw new Error("API é”™è¯¯: " + h.statusText);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/(\[[\s\S]*\])/);
      if (!k || !k[0]) {
        throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŽŸå§‹è¿”å›ž: " + j);
      }
      const m = k[0];
      let n;
      try {
        n = JSON.parse(m)[0];
      } catch (a) {
        throw new Error("è§£æžAIè¿”å›žçš„JSONæ—¶å‡ºé”™: " + a.message + `

AIåŽŸå§‹è¿”å›žå†…å®¹:
` + j);
      }
      if (!a.diary) {
        a.diary = [];
      }
      a.diary.push({
        id: Date.now(),
        title: n.title,
        content: n.content,
        timestamp: Date.now()
      });
      await Gb.chats.put(a);
      await _k();
    } catch (a) {
      console.error("ç”Ÿæˆæ–°æ—¥è®°å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "é”™è¯¯: " + a.message);
    }
  }
  function _k() {
    const a = document.getElementById("char-diary-list");
    a.innerHTML = "";
    const b = v.chats[ra];
    const c = (b.diary || []).slice().reverse();
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">æ—¥è®°æœ¬è¿˜æ˜¯ç©ºçš„ã€‚</p>";
      return;
    }
    const d = "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M4 19.5A2.5 2.5 0 0 1 6.5 17H20\"></path><path d=\"M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z\"></path></svg>";
    const e = "<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"9 18 15 12 9 6\"></polyline></svg>";
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "diary-item";
      const f = new Date(b.timestamp).toLocaleDateString("zh-CN");
      c.innerHTML = `
             <div class="cphone-item-icon-box diary-icon-style">
                ` + d + `
            </div>
            <div class="cphone-item-info">
                <div class="cphone-item-title">` + b.title + "</div>\n                <div class=\"cphone-item-preview\">" + f + `</div>
            </div>
            <div class="cphone-item-arrow">
                ` + e + `
            </div>
        `;
      c.addEventListener("click", () => al(b.id));
      _d(c, () => dl(b.id));
      a.appendChild(c);
    });
  }
  async function al(a) {
    const b = v.chats[ra];
    if (!b || !b.diary) {
      return;
    }
    const c = b.diary.find(b => b.id === a);
    if (c) {
      ua = c;
      const b = document.getElementById("char-diary-detail-title");
      const d = document.getElementById("char-diary-detail-content");
      const e = document.getElementById("favorite-diary-btn");
      b.textContent = c.title;
      const f = si(c.content).split("\n").map(a => "<p>" + (a || "&nbsp;") + "</p>").join("");
      d.innerHTML = f;
      const g = await Gb.favorites.where({
        type: "char_diary",
        "content.id": a
      }).first();
      e.classList.toggle("active", !!g);
      Lk("char-diary-detail-screen");
    }
  }
  async function bl() {
    if (!ua || !ra) {
      return;
    }
    const a = ua;
    const b = v.chats[ra];
    const c = document.getElementById("favorite-diary-btn");
    const d = await Gb.favorites.where({
      type: "char_diary",
      "content.id": a.id
    }).first();
    if (d) {
      await Gb.favorites.delete(d.id);
      c.classList.remove("active");
      await Bb("æ“ä½œæˆåŠŸ", "å·²å–æ¶ˆæ”¶è—ã€‚");
    } else {
      const d = {
        type: "char_diary",
        content: {
          id: a.id,
          title: a.title,
          content: a.content,
          timestamp: a.timestamp,
          characterId: ra,
          characterName: b.name
        },
        timestamp: Date.now()
      };
      await Gb.favorites.add(d);
      c.classList.add("active");
      await Bb("æ“ä½œæˆåŠŸ", "å·²æˆåŠŸæ”¶è—åˆ°â€œæˆ‘çš„æ”¶è—â€é¡µé¢ï¼");
    }
  }
  async function cl() {
    if (!wa || !ra) {
      return;
    }
    const a = wa;
    const b = v.chats[ra];
    const c = document.getElementById("favorite-memo-btn");
    const d = await Gb.favorites.where({
      type: "char_memo",
      "content.id": a.id
    }).first();
    if (d) {
      await Gb.favorites.delete(d.id);
      c.classList.remove("active");
      await Bb("æ“ä½œæˆåŠŸ", "å·²å–æ¶ˆæ”¶è—ã€‚");
    } else {
      const d = {
        type: "char_memo",
        content: {
          id: a.id,
          title: a.title,
          content: a.content,
          timestamp: a.timestamp,
          characterId: ra,
          characterName: b.name
        },
        timestamp: Date.now()
      };
      await Gb.favorites.add(d);
      c.classList.add("active");
      await Bb("æ“ä½œæˆåŠŸ", "å·²æˆåŠŸæ”¶è—åˆ°â€œæˆ‘çš„æ”¶è—â€é¡µé¢ï¼");
    }
  }
  async function dl(a) {
    const b = await wb("åˆ é™¤æ—¥è®°", "ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (b) {
      const b = v.chats[ra];
      b.diary = b.diary.filter(b => b.id !== a);
      await Gb.chats.put(b);
      _k();
    }
  }
  async function el() {
    const a = document.getElementById("char-chat-list");
    a.innerHTML = "";
    const b = v.chats[ra];
    if (!b) {
      return;
    }
    const c = b.settings.myNickname || v.qzoneSettings.nickname || "æˆ‘";
    const d = b.history.filter(a => !a.isHidden).slice(-1)[0] || {
      content: "..."
    };
    let e = "...";
    if (d) {
      if (typeof d.content === "string") {
        e = d.content;
      } else if (Array.isArray(d.content) && d.content[0]?.type === "image_url") {
        e = "[å›¾ç‰‡]";
      } else if (d.type) {
        const a = {
          voice_message: "[è¯­éŸ³]",
          transfer: "[è½¬è´¦]",
          ai_image: "[å›¾ç‰‡]"
        };
        e = a[d.type] || "[" + d.type + "]";
      }
    }
    const f = b.settings.myAvatar || Na;
    const g = b.settings.myAvatarFrame || "";
    let h;
    if (g) {
      h = "<div class=\"avatar-group has-frame\" style=\"width: 45px; height: 45px;\"><div class=\"avatar-with-frame\" style=\"width: 45px; height: 45px;\"><img src=\"" + f + "\" class=\"avatar-img\" style=\"border-radius: 50%;\"><img src=\"" + g + "\" class=\"avatar-frame\"></div></div>";
    } else {
      h = "<div class=\"avatar-group\" style=\"width: 45px; height: 45px;\"><img src=\"" + f + "\" class=\"avatar\" style=\"border-radius: 50%; width: 45px; height: 45px;\"></div>";
    }
    const i = document.createElement("div");
    i.className = "chat-list-item";
    i.dataset.conversationIndex = "-1";
    i.innerHTML = "\n        " + h + `
        <div class="info">
            <div class="name-line">
                <span class="name">` + c + `</span>
            </div>
            <div class="last-msg">` + String(e).substring(0, 20) + `...</div>
        </div>
    `;
    a.appendChild(i);
    const j = await Gb.npcs.toArray();
    const k = new Map(j.map(a => [a.name, a]));
    const l = b.simulatedConversations || [];
    if (l.length === 0 && !i) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ï¼Œ<br>çœ‹çœ‹TAæœ€è¿‘éƒ½å’Œè°èŠå¤©äº†å§ï¼</p>";
      return;
    }
    l.forEach((b, c) => {
      if (b.type === "private_user") {
        return;
      }
      const d = document.createElement("div");
      d.className = "chat-list-item";
      d.dataset.conversationIndex = c;
      let e;
      let f;
      let g;
      if (b.type === "group") {
        g = b.groupName + " <span class=\"group-tag\">ç¾¤</span>";
        e = b.messages.slice(-1)[0] || {
          content: "..."
        };
        const a = "logo, simple, flat design, for a group chat named '" + b.groupName + "'";
        const c = v.globalSettings.enableAiDrawing ? "https://image.pollinations.ai/prompt/" + encodeURIComponent(a) : Qa;
        f = "<div class=\"avatar-group\"><img src=\"" + c + "\" class=\"avatar\" style=\"border-radius: 50%;\"></div>";
      } else {
        g = b.participant.name;
        e = b.messages.slice(-1)[0] || {
          content: "..."
        };
        const a = k.get(g);
        let c = a && a.avatar ? a.avatar : v.globalSettings.enableAiDrawing ? "https://image.pollinations.ai/prompt/" + encodeURIComponent(b.participant.avatar_prompt || "anime person") : Pa;
        f = "<div class=\"avatar-group\"><img src=\"" + c + "\" class=\"avatar\" style=\"border-radius: 50%;\"></div>";
      }
      let h = "...";
      if (e && e.content) {
        h = e.content;
      }
      d.innerHTML = "\n            " + f + `
            <div class="info">
                <div class="name-line">
                    <span class="name">` + g + `</span>
                </div>
                <div class="last-msg">` + String(h).substring(0, 20) + `...</div>
            </div>
        `;
      a.appendChild(d);
    });
  }
  async function fl() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨æ ¹æ®â€œ" + a.name + "â€çš„è®°å¿†å’Œäººè®¾ï¼Œç”Ÿæˆå…¨æ–°çš„ç¤¾äº¤åŠ¨æ€...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚");
      return;
    }
    const e = await Gb.npcs.toArray();
    const f = e.filter(a => a.associatedWith && a.associatedWith.includes(ra));
    let g = "# ä½ çš„ç¤¾äº¤åœˆ (ç»‘å®šçš„NPC)\n";
    if (f.length > 0) {
      g += "è¿™æ˜¯ä½ è®¤è¯†çš„ã€å…³ç³»å¯†åˆ‡çš„NPCã€‚åœ¨ç”Ÿæˆå¯¹è¯æ—¶ï¼Œä½ åº”è¯¥ã€ä¼˜å…ˆã€‘ä¸Žä»–ä»¬äº’åŠ¨ã€‚\n";
      f.forEach(a => {
        g += "- **å§“å**: " + a.name + "\n  - **äººè®¾**: " + a.persona + "\n";
      });
    } else {
      g += "ï¼ˆä½ ç›®å‰æ²¡æœ‰ç»‘å®šçš„NPCä¼™ä¼´ï¼Œå¯ä»¥è‡ªç”±åˆ›é€ æ–°çš„NPCã€‚ï¼‰\n";
    }
    const h = v.qzoneSettings.nickname === "{{user}}" || !v.qzoneSettings.nickname ? "ç”¨æˆ·" : v.qzoneSettings.nickname;
    const i = a.settings.myNickname || h;
    const j = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ";
    const k = a.settings.maxMemory || 10;
    const l = a.history.slice(-k);
    const m = await vj(l, ra);
    const n = m.map(b => (b.role === "user" ? i : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    const o = (a.settings.linkedWorldBookIds || []).map(a => v.worldBooks.find(b => b.id === a)).filter(Boolean).map(a => "\n## ä¸–ç•Œä¹¦ã€Š" + a.name + "ã€‹è®¾å®š (ä½ å¯ä»¥å°†å…¶ä¸­è§’è‰²ä½œä¸ºèŠå¤©å¯¹è±¡):\n" + a.content.filter(a => a.enabled).map(a => "- " + a.content).join("\n")).join("");
    const q = a.originalName || a.name;
    const r = to(a);
    const s = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç¤¾äº¤ç”Ÿæ´»æ¨¡æ‹Ÿå™¨ï¼Œæ‰®æ¼”è§’è‰²â€œ` + a.name + `â€ã€‚ä½ çš„ä»»åŠ¡æ˜¯è™šæž„å‡ºã€5åˆ°7æ®µã€‘TAæœ€è¿‘çš„QQèŠå¤©è®°å½•ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€NPCå”¯ä¸€æ€§é“å¾‹ã€‘**: åœ¨ä½ æœ¬æ¬¡ç”Ÿæˆçš„æ‰€æœ‰å¯¹è¯ä¸­ï¼ˆåŒ…æ‹¬ç§èŠå’Œç¾¤èŠï¼‰ï¼Œæ¯ä¸€ä¸ªNPCçš„åå­—ã€å¿…é¡»æ˜¯ç‹¬ä¸€-æ— äºŒçš„ã€‘ã€‚ç»å¯¹ç¦æ­¢å‡ºçŽ°é‡åçš„NPCï¼Œç¦æ­¢å‡ºçŽ°é‡å¤ç¾¤èŠã€‚
2.  **ã€NPCæ¥æºã€‘**: ä½ åº”è¯¥ä¼˜å…ˆä»Žâ€œä½ çš„ç¤¾äº¤åœˆ (ç»‘å®šçš„NPC)â€å’Œâ€œä¸–ç•Œä¹¦â€ä¸­å¯»æ‰¾è§’è‰²ä½œä¸ºèŠå¤©å¯¹è±¡ã€‚å¦‚æžœä¸å¤Ÿï¼Œä½ ä¹Ÿå¯ä»¥è‡ªç”±åˆ›é€ å…¨æ–°çš„NPCï¼Œå¯¹è¯å†…å®¹è¦å¤šæ ·åŒ–ï¼Œåæ˜ è§’è‰²çš„ç”Ÿæ´»ã€‚
3.  **å…³è”æ€§**: å¯¹è¯å†…å®¹åº”å·§å¦™åœ°åæ˜ è§’è‰²çš„é•¿æœŸè®°å¿†ã€ä¸–ç•Œè§‚ï¼Œä»¥åŠä¸Žç”¨æˆ·äº’åŠ¨å¯èƒ½å¸¦æ¥çš„å¿ƒæƒ…å˜åŒ–ã€‚
4.  **ç®€æ´æ€§**: æ¯æ®µå¯¹è¯çš„æ€»é•¿åº¦åº”åœ¨8åˆ°15å¥ä¹‹é—´ã€‚
# æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)
- ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
- ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åŽæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®°ã€‚
- æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä»£è¡¨ä¸€æ®µå¯¹è¯ï¼Œä¸”ã€å¿…é¡»ã€‘æ˜¯ä»¥ä¸‹ä¸¤ç§æ ¼å¼ä¹‹ä¸€ï¼š



### æ ¼å¼ Aï¼šä¸ŽNPCçš„ç§èŠ
\`\`\`json
{
  "type": "private_npc",
  "participant": {
    "name": "NPCçš„åå­—",
    "avatar_prompt": "(ä»…å½“NPCæ˜¯æ–°åˆ›é€ æ—¶æä¾›)ä¸€æ®µç”¨äºŽç”Ÿæˆå¤´åƒçš„ã€è‹±æ–‡ã€‘å…³é”®è¯, é£Žæ ¼ä¸ºåŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"
  },
"messages": [
  {"sender": "` + q + `", "content": "å¯¹è¯å†…å®¹1"},
  {"sender": "NPCçš„åå­—", "content": "å¯¹è¯å†…å®¹2"},
  {"sender": "` + q + `", "type": "sticker", "meaning": "è¡¨æƒ…çš„å«ä¹‰(å¿…é¡»ä»Žå¯ç”¨è¡¨æƒ…åˆ—è¡¨é€‰æ‹©)"}
]
}
\`\`\`

### æ ¼å¼ Bï¼šç¾¤èŠ
\`\`\`json
{
  "type": "group",
  "groupName": "ä¸€ä¸ªè™šæž„çš„ç¾¤å",
  "participants": [
    {"name": "NPCæˆå‘˜1", "avatar_prompt": "(ä»…å½“NPCæ˜¯æ–°åˆ›é€ æ—¶æä¾›) æˆå‘˜1å¤´åƒã€è‹±æ–‡ã€‘å…³é”®è¯"},
    {"name": "NPCæˆå‘˜2", "avatar_prompt": "(ä»…å½“NPCæ˜¯æ–°åˆ›é€ æ—¶æä¾›) æˆå‘˜2å¤´åƒã€è‹±æ–‡ã€‘å…³é”®è¯"}
  ],
"messages": [
  {"sender": "` + q + `", "content": "æˆ‘åœ¨ç¾¤é‡Œè¯´çš„è¯"},
  {"sender": "NPCæˆå‘˜1", "content": "æˆå‘˜1å›žå¤æˆ‘"},
  {"sender": "NPCæˆå‘˜2", "type": "sticker", "meaning": "è¡¨æƒ…çš„å«ä¹‰(å¿…é¡»ä»Žå¯ç”¨è¡¨æƒ…åˆ—è¡¨é€‰æ‹©)"}
]
}
\`\`\`

# è§’è‰²ä¸Žä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ` + a.settings.aiPersona + "\n- **ä½ çš„é•¿æœŸè®°å¿†**: " + j + "\n- **ä¸–ç•Œè§‚**: " + o + "\n- **æœ€è¿‘ä¸Žç”¨æˆ·çš„äº’åŠ¨**: " + n + "\n" + g + `
# å¯ç”¨è¡¨æƒ…åŒ… (å¿…é¡»ä¸¥æ ¼éµå®ˆï¼)
- å½“ä½ éœ€è¦å‘é€è¡¨æƒ…æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä»Žä¸‹é¢çš„åˆ—è¡¨ä¸­ã€ç²¾ç¡®åœ°é€‰æ‹©ä¸€ä¸ªã€‘å«ä¹‰ï¼ˆmeaningï¼‰ã€‚
- ã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ä»»ä½•ä¸åœ¨åˆ—è¡¨ä¸­çš„è¡¨æƒ…å«ä¹‰ï¼
` + r + "\nçŽ°åœ¨ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§æ ¼å¼é“å¾‹ï¼Œç”ŸæˆèŠå¤©è®°å½•çš„JSONæ•°ç»„ã€‚";
    try {
      const e = [{
        role: "user",
        content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆæ¨¡æ‹ŸèŠå¤©è®°å½•ã€‚"
      }];
      let f = b.includes("generativelanguage");
      let g = p(d, c, s, e);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: s
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!h.ok) {
        throw new Error("API é”™è¯¯: " + h.statusText);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/(\[[\s\S]*\])/);
      if (!k || !k[0]) {
        throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŽŸå§‹è¿”å›ž: " + j);
      }
      const l = k[0];
      let m;
      try {
        m = JSON.parse(l);
      } catch (a) {
        throw new Error("è§£æžAIè¿”å›žçš„JSONæ—¶å‡ºé”™: " + a.message + `

AIåŽŸå§‹è¿”å›žå†…å®¹:
` + j);
      }
      a.simulatedConversations = m;
      await Gb.chats.put(a);
      await el();
      const n = {
        role: "system",
        content: "[ç³»ç»ŸæŒ‡ä»¤ï¼šä½ åˆšåˆšåœ¨è‡ªå·±çš„æ‰‹æœºä¸Šæ´»åŠ¨äº†ä¸€ç•ªï¼ˆå’Œæœ‹å‹èŠå¤©ã€é€›ç¾¤ç­‰ï¼‰ã€‚çŽ°åœ¨è¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šï¼Œä¸»åŠ¨ç»™ç”¨æˆ·å‘ä¸€æ¡æ¶ˆæ¯ï¼Œå¯ä»¥èŠèŠä½ åˆšæ‰çœ‹åˆ°æˆ–èŠåˆ°çš„è¶£äº‹ï¼Œæˆ–è€…ä»…ä»…æ˜¯é—®å€™ä¸€ä¸‹ã€‚]",
        timestamp: Date.now(),
        isHidden: true
      };
      a.history.push(n);
      await Gb.chats.put(a);
      Td();
    } catch (a) {
      console.error("ç”Ÿæˆæ¨¡æ‹ŸèŠå¤©å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆæ¨¡æ‹ŸèŠå¤©è®°å½•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  async function gl() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      return;
    }
    try {
      const {
        proxyUrl: b,
        apiKey: c,
        model: d
      } = v.apiConfig;
      if (!b || !c || !d) {
        throw new Error("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå¯¹è¯ã€‚");
      }
      const e = parseInt(a.settings.maxMemory) || 10;
      const f = a.history.slice(-e);
      const g = await vj(f, ra);
      const h = a.settings.myNickname || "æˆ‘";
      const i = a.settings.myPersona || "ç”¨æˆ·";
      const j = "# é•¿æœŸè®°å¿† (å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n" + (a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- " + a.content).join("\n") : "- (æš‚æ— )");
      let k = "";
      if (a.settings.linkedWorldBookIds && a.settings.linkedWorldBookIds.length > 0) {
        const b = a.settings.linkedWorldBookIds.map(a => {
          const b = v.worldBooks.find(b => b.id === a);
          if (!b || !Array.isArray(b.content)) {
            return "";
          }
          const c = b.content.filter(a => a.enabled !== false).map(a => "\n### æ¡ç›®: " + (a.comment || "æ— å¤‡æ³¨") + `
**å†…å®¹:**
` + a.content).join("");
          if (c) {
            return `

## ä¸–ç•Œä¹¦: ` + b.name + "\n" + c;
          } else {
            return "";
          }
        }).filter(Boolean).join("");
        if (b) {
          k = `

# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)
` + b + "\n";
        }
      }
      const l = th(a, 3, "hours");
      const m = th(a, 6, "hours");
      const n = th(a, 9, "hours");
      const o = th(a, 1, "days");
      const q = th(a, 3, "days");
      const r = th(a, 7, "days");
      let s = "";
      if (l || m || n || o || q || r) {
        s += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„å¯¹è¯å›žé¡¾)
`;
        if (l) {
          s += l;
        }
        if (m) {
          s += m;
        }
        if (n) {
          s += n;
        }
        if (l || m || n) {
          s += "\n";
        }
        if (o) {
          s += o;
        }
        if (q) {
          s += q;
        }
        if (r) {
          s += r;
        }
      }
      const t = so(a);
      const u = `
# ä½ çš„æ ¸å¿ƒä»»åŠ¡
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰²â€œ` + a.originalName + `â€ã€‚ç”¨æˆ·åˆšåˆšåœ¨TAçš„æ‰‹æœºï¼ˆCPhoneï¼‰ä¸Šç‚¹å‡»äº†ä¸€ä¸ªæŒ‰é’®ï¼Œå¸Œæœ›ä½ èƒ½ç»§ç»­ä½ ä»¬ä¹‹å‰çš„å¯¹è¯ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆã€3åˆ°5æ¡ã€‘ç¬¦åˆä½ äººè®¾çš„ã€ç®€çŸ­çš„ã€è¿žç»­çš„æ–°å›žå¤ã€‚

# è¾“å‡ºæ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)
- ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€æ¡æ¶ˆæ¯ã€‚
- æ ¼å¼: \`[{"type": "text", "content": "ç¬¬ä¸€å¥è¯"}, {"type": "text", "content": "ç¬¬äºŒå¥è¯"}, {"type": "sticker", "meaning": "è¡¨æƒ…çš„å«ä¹‰(ä»Žå¯ç”¨è¡¨æƒ…åˆ—è¡¨é€‰æ‹©)"}]\`
- ä½ å¯ä»¥è‡ªç”±ç»„åˆä½¿ç”¨ "text", "sticker", "ai_image", "voice_message" ç­‰å¤šç§æ¶ˆæ¯ç±»åž‹ã€‚
è¯·æ ¹æ®å½“å‰æƒ…æ™¯å’Œä½ çš„æƒ…ç»ªï¼Œä»Žåˆ—è¡¨ä¸­ã€é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„ã€‘è¡¨æƒ…å«ä¹‰æ¥ä½¿ç”¨ "sticker" æŒ‡ä»¤ã€‚å°½é‡è®©ä½ çš„è¡¨æƒ…ä¸°å¯Œå¤šæ ·ï¼Œé¿å…é‡å¤ã€‚
# ä½ çš„è§’è‰²è®¾å®š
` + a.settings.aiPersona + `
# å¯ç”¨è¡¨æƒ…åŒ… (å¿…é¡»ä¸¥æ ¼éµå®ˆï¼)
- å½“ä½ éœ€è¦å‘é€è¡¨æƒ…æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä»Žä¸‹é¢çš„åˆ—è¡¨ä¸­ã€ç²¾ç¡®åœ°é€‰æ‹©ä¸€ä¸ªã€‘å«ä¹‰ï¼ˆmeaningï¼‰ã€‚
- ã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ä»»ä½•ä¸åœ¨åˆ—è¡¨ä¸­çš„è¡¨æƒ…å«ä¹‰ï¼
` + t + `

# ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰çš„äººè®¾
` + i + `  

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„æœ¬å**: "` + a.originalName + "\"\n- **ç”¨æˆ·çš„å¤‡æ³¨**: \"" + h + "\"\n" + k + "\n" + j + "\n" + s + ` 
- **ä½ ä»¬æœ€åŽçš„å¯¹è¯**:
` + f.map(b => (b.role === "user" ? h : a.name) + ": " + String(b.content)).join("\n") + `

çŽ°åœ¨ï¼Œè¯·ç»§ç»­è¿™åœºå¯¹è¯ã€‚
`;
      const w = g.map(b => ({
        role: b.role,
        content: (b.role === "user" ? h : a.name) + ": " + String(b.content)
      }));
      let x = b.includes("generativelanguage");
      let y = p(d, c, u, w);
      const A = x ? await fetch(y.url, y.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: u
          }, ...w],
          temperature: v.globalSettings.apiTemperature || 0.8
        })
      });
      if (!A.ok) {
        throw new Error("API è¯·æ±‚å¤±è´¥: " + (await A.json()).error.message);
      }
      const B = await A.json();
      const D = C(B);
      const E = Jc(D);
      if (!E || E.length === 0) {
        throw new Error("AIè¿”å›žäº†ç©ºå†…å®¹ã€‚");
      }
      let F = 0;
      let G = Date.now();
      for (const b of E) {
        const c = {
          role: "assistant",
          senderName: a.originalName,
          timestamp: G++
        };
        let d = null;
        switch (b.type) {
          case "text":
            d = {
              ...c,
              content: String(b.content || b.message)
            };
            break;
          case "sticker":
            if (b.meaning) {
              const a = z(b.meaning, v.userStickers);
              if (a) {
                d = {
                  ...c,
                  type: "sticker",
                  content: a.url,
                  meaning: a.name
                };
              } else {
                console.warn("AI (CPhone) å°è¯•ä½¿ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„è¡¨æƒ…: \"" + b.meaning + "\"");
                d = null;
              }
            } else {
              console.warn("AI (CPhone) å‘é€äº†ä¸€ä¸ªæ²¡æœ‰ 'meaning' çš„ sticker æŒ‡ä»¤ã€‚", b);
              d = {
                ...c,
                type: "sticker",
                content: b.url,
                meaning: "æœªçŸ¥è¡¨æƒ…"
              };
            }
            break;
        }
        if (d) {
          a.history.push(d);
          F++;
        }
      }
      if (F > 0) {
        a.unreadCount = (a.unreadCount || 0) + F;
      }
      await Gb.chats.put(a);
      await _c();
      if (F > 0) {
        Hc(a.id, "å‘æ¥äº† " + F + " æ¡æ–°æ¶ˆæ¯");
      }
    } catch (a) {
      console.error("ä»ŽCPhoneæŽ¨è¿›çœŸå®žå¯¹è¯å¤±è´¥:", a);
      await Bb("æ“ä½œå¤±è´¥", "æ— æ³•ç”Ÿæˆæ–°å›žå¤: " + a.message);
    }
  }
  async function hl() {
    if (aa || !ra) {
      return;
    }
    aa = true;
    const a = document.getElementById("char-conversation-messages");
    const b = v.chats[ra];
    if (!b) {
      aa = false;
      return;
    }
    tn(a, "top");
    const c = a.scrollHeight;
    await new Promise(a => // TOLOOK
    setTimeout(a, 500));
    const d = b.history.length;
    const e = v.globalSettings.chatRenderWindow || 50;
    const f = d - $;
    const g = Math.max(0, f - e);
    const h = b.history.slice(g, f);
    un(a);
    if (h.length === 0) {
      aa = false;
      return;
    }
    for (const c of h.reverse()) {
      const d = {
        ...c,
        role: c.role === "user" ? "assistant" : "user"
      };
      const e = {
        id: "temp_user_chat_mirror",
        isGroup: false,
        name: b.name,
        settings: {
          ...b.settings,
          myAvatar: b.settings.aiAvatar,
          myAvatarFrame: b.settings.aiAvatarFrame,
          aiAvatar: b.settings.myAvatar,
          aiAvatarFrame: b.settings.myAvatarFrame
        }
      };
      const f = await Nd(d, e);
      if (f) {
        a.prepend(f);
      }
    }
    $ += h.length;
    const i = a.scrollHeight;
    a.scrollTop = i - c;
    aa = false;
  }
  async function il(a) {
    const b = v.chats[ra];
    if (!b) {
      return;
    }
    _ = a === -1 ? "private_user" : b.simulatedConversations[a]?.type;
    const c = document.getElementById("char-conversation-messages");
    c.innerHTML = "";
    c.dataset.theme = b.settings.theme || "default";
    const d = document.getElementById("phone-screen").classList.contains("dark-mode");
    c.style.backgroundColor = d ? "#000000" : "#f0f2f5";
    let e;
    let f = [];
    const g = await Gb.npcs.toArray();
    const h = new Map(g.map(a => [a.name, a]));
    if (a === -1) {
      _ = "private_user";
      const a = document.getElementById("char-conversation-partner-name");
      const d = document.getElementById("char-simulated-input");
      c.innerHTML = "";
      a.textContent = b.settings.myNickname || v.qzoneSettings.nickname || "æˆ‘";
      d.placeholder = "ä¸Ž " + (b.settings.myNickname || "æˆ‘") + " çš„å¯¹è¯ (åªè¯»)";
      $ = 0;
      aa = false;
      const g = b.history;
      const h = v.globalSettings.chatRenderWindow || 50;
      const i = g.slice(-h);
      e = {
        id: "temp_user_chat_mirror",
        isGroup: false,
        name: b.name,
        settings: {
          ...b.settings,
          myAvatar: b.settings.aiAvatar,
          myAvatarFrame: b.settings.aiAvatarFrame,
          aiAvatar: b.settings.myAvatar,
          aiAvatarFrame: b.settings.myAvatarFrame
        }
      };
      f = i.map(a => ({
        ...a,
        role: a.role === "user" ? "assistant" : "user"
      }));
      $ = i.length;
    } else {
      const c = b.simulatedConversations[a];
      if (!c) {
        return;
      }
      _ = c.type;
      const d = document.getElementById("char-conversation-partner-name");
      const g = document.getElementById("char-simulated-input");
      if (c.type === "group") {
        d.textContent = c.groupName + " (" + (c.participants.length + 1) + ")";
        g.placeholder = "åœ¨ " + c.groupName + " ä¸­èŠå¤©";
        e = {
          id: "temp_group_chat",
          isGroup: true,
          name: c.groupName,
          originalName: b.originalName,
          members: c.participants.map(a => {
            const b = h.get(a.name);
            let c = b && b.avatar ? b.avatar : v.globalSettings.enableAiDrawing ? "https://image.pollinations.ai/prompt/" + encodeURIComponent(a.avatar_prompt || "anime person") : Pa;
            return {
              originalName: a.name,
              groupNickname: a.name,
              avatar: c
            };
          }),
          settings: {
            ...b.settings,
            myNickname: b.name,
            myAvatar: b.settings.aiAvatar,
            myAvatarFrame: b.settings.aiAvatarFrame
          }
        };
      } else {
        d.textContent = c.participant.name;
        g.placeholder = "ä¸Ž " + c.participant.name + " çš„å¯¹è¯";
        const a = h.get(c.participant.name);
        const f = a && a.avatar ? a.avatar : v.globalSettings.enableAiDrawing ? "https://image.pollinations.ai/prompt/" + encodeURIComponent(c.participant.avatar_prompt || "anime person") : Pa;
        e = {
          id: "temp_npc_chat",
          isGroup: false,
          name: c.participant.name,
          originalName: b.originalName,
          settings: {
            ...b.settings,
            myAvatar: b.settings.aiAvatar,
            myAvatarFrame: b.settings.aiAvatarFrame,
            aiAvatar: f,
            aiAvatarFrame: ""
          }
        };
      }
      f = c.messages;
    }
    for (const d of f) {
      let f = d.role;
      if (a !== -1) {
        const a = d.sender === (b.originalName || b.name);
        f = a ? "user" : "assistant";
      }
      const g = {
        role: f,
        senderName: d.sender || (f === "user" ? e.settings.myNickname : e.name),
        timestamp: d.timestamp || Date.now() + Math.random()
      };
      if (d.type === "sticker" && d.meaning) {
        const a = v.userStickers.find(a => a.name === d.meaning);
        if (a) {
          g.content = a.url;
          g.meaning = d.meaning;
          g.type = "sticker";
        } else {
          console.warn("æ¨¡æ‹Ÿè¡¨æƒ…å«ä¹‰ \"" + d.meaning + "\" åœ¨åº“ä¸­æœªæ‰¾åˆ°ã€‚");
          g.content = "[è¡¨æƒ…: " + d.meaning + "]";
          g.type = "text";
        }
      } else {
        g.content = d.content;
        g.type = d.type || "text";
      }
      const h = await Nd(g, e);
      if (h) {
        c.appendChild(h);
      }
    }
    Lk("char-qq-conversation-screen");
    // TOLOOK
    setTimeout(() => c.scrollTop = c.scrollHeight, 0);
  }
  function jl() {
    document.getElementById("char-qq-transcript-modal").classList.remove("visible");
  }
  async function kl() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      await Bb("æ“ä½œå¤±è´¥", "æ— æ³•æ‰¾åˆ°å½“å‰è§’è‰²çš„æ•°æ®ã€‚");
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚â€œ" + a.name + "â€å›žå¿†TAçš„ç›¸å†Œç…§ç‰‡...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚");
      return;
    }
    const e = v.qzoneSettings.nickname === "{{user}}" || !v.qzoneSettings.nickname ? "ç”¨æˆ·" : v.qzoneSettings.nickname;
    const f = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ";
    const g = a.settings.maxMemory || 10;
    const h = a.history.slice(-g);
    const i = await vj(h, ra);
    const j = i.map(b => (b.role === "user" ? e : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    const k = (a.settings.linkedWorldBookIds || []).map(a => v.worldBooks.find(b => b.id === a)).filter(Boolean).map(a => "\n## ä¸–ç•Œä¹¦ã€Š" + a.name + "ã€‹è®¾å®š:\n" + a.content.filter(a => a.enabled).map(a => "- " + a.content).join("\n")).join("");
    const l = th(a, 3, "hours");
    const m = th(a, 6, "hours");
    const n = th(a, 9, "hours");
    const o = th(a, 1, "days");
    const q = th(a, 3, "days");
    const r = th(a, 7, "days");
    let s = "";
    if (l || m || n || o || q || r) {
      s += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„å¯¹è¯å›žé¡¾)
`;
      if (l) {
        s += l;
      }
      if (m) {
        s += m;
      }
      if (n) {
        s += n;
      }
      if (l || m || n) {
        s += "\n";
      }
      if (o) {
        s += o;
      }
      if (q) {
        s += q;
      }
      if (r) {
        s += r;
      }
    }
    const t = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ` + a.name + `â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œæž„æ€å‡ºã€8åˆ°10å¼ ã€‘TAæœ€è¿‘å¯èƒ½ä¼šæ‹æ‘„æˆ–çè—åœ¨æ‰‹æœºç›¸å†Œé‡Œçš„ç…§ç‰‡ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆ›é€ æ€§ä¸Žåˆç†æ€§**: ç…§ç‰‡å†…å®¹å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½ã€èŒä¸šå’Œç”Ÿæ´»çŽ¯å¢ƒã€‚
2.  **å¤šæ ·æ€§**: ç…§ç‰‡ä¸»é¢˜è¦ä¸°å¯Œï¼Œå¯ä»¥åŒ…æ‹¬è‡ªæ‹ã€é£Žæ™¯ã€é£Ÿç‰©ã€å® ç‰©ã€æœ‹å‹åˆå½±ã€å·¥ä½œåœºæ™¯ç­‰ã€‚
3.  **æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: 
    - ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›žå¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åŽæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€å¼ ç…§ç‰‡ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "description": "è¿™æ˜¯ç…§ç‰‡èƒŒåŽçš„æ•…äº‹æˆ–è§’è‰²çš„å¿ƒæƒ…æ—¥è®°ï¼Œå¿…é¡»ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€æ¥å†™ã€‚",
        "image_prompt": "ä¸€æ®µç”¨äºŽç”Ÿæˆè¿™å¼ ç…§ç‰‡çš„ã€è¯¦ç»†çš„ã€è‹±æ–‡ã€‘å…³é”®è¯ã€‚"
      }
    ]
    \`\`\`
    - **ã€image_prompt ç»å¯¹ç¦æ­¢ã€‘**: ç»å¯¹ç¦æ­¢åŒ…å«ä»»ä½•ä¸­æ–‡å­—ç¬¦ã€å¥å­ã€ç‰¹æ®Šç¬¦å·ã€æˆ–ä»»ä½•å¯èƒ½æ¶‰åŠæ•æ„Ÿï¼ˆNSFWï¼‰ã€æš´åŠ›ã€è¡€è…¥ã€æ”¿æ²»çš„å†…å®¹ï¼ä¹Ÿç¦æ­¢çœŸäººï¼
    - **ã€image_prompt å¿…é¡»æ˜¯ã€‘**: å¿…é¡»æ˜¯çº¯è‹±æ–‡çš„ã€ç”¨é€—å·åˆ†éš”çš„ã€å…³é”®è¯ç»„åˆã€‘ (e.g., "1boy, solo, basketball jersey, in locker room, smiling, selfie")ã€‚
    - **ã€ç”»é£ŽæŒ‡ä»¤ã€‘**: åœ¨ prompt çš„æœ«å°¾ï¼Œæ€»æ˜¯åŠ ä¸Šç”»é£ŽæŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š \`best quality, masterpiece, anime style, cinematic lighting\`

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ` + a.settings.aiPersona + "\n" + f + "\n" + k + "\n" + s + " \n- **ä½ æœ€è¿‘å’Œâ€œ" + e + "â€çš„å¯¹è¯æ‘˜è¦**:\n" + j + `

çŽ°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¿™ç»„ç…§ç‰‡çš„æè¿°å’Œç»˜ç”»æŒ‡ä»¤ã€‚`;
    try {
      const e = [{
        role: "user",
        content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„ç›¸å†Œå†…å®¹ã€‚"
      }];
      let f = b.includes("generativelanguage");
      let g = p(d, c, t, e);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: t
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!h.ok) {
        throw new Error("API é”™è¯¯: " + h.statusText);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/(\[[\s\S]*\])/);
      if (!k || !k[0]) {
        throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŽŸå§‹è¿”å›ž: " + j);
      }
      const l = k[0];
      let m;
      try {
        m = JSON.parse(l);
      } catch (a) {
        throw new Error("è§£æžAIè¿”å›žçš„JSONæ—¶å‡ºé”™: " + a.message + `

AIåŽŸå§‹è¿”å›žå†…å®¹:
` + j);
      }
      a.simulatedAlbum = m;
      await Gb.chats.put(a);
      await Nk();
    } catch (a) {
      console.error("ç”Ÿæˆæ¨¡æ‹Ÿç›¸å†Œå¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆæ¨¡æ‹Ÿç›¸å†Œï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  async function Nk() {
    const a = document.getElementById("char-album-grid");
    a.innerHTML = "";
    if (!ra) {
      return;
    }
    const b = v.chats[ra];
    const c = b.simulatedAlbum || [];
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">TAçš„ç›¸å†Œè¿˜æ˜¯ç©ºçš„ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›ç…§ç‰‡å§ï¼</p>";
      return;
    }
    const d = "https://i.postimg.cc/KYr2qRCK/1.jpg";
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "char-photo-item";
      c.dataset.description = b.description;
      a.appendChild(c);
      if (v.globalSettings.enableAiDrawing) {
        c.style.backgroundColor = "#e9ecef";
        const a = /[^\x00-\x7F]/.test(b.image_prompt);
        const e = b.image_prompt && b.image_prompt.trim() && !a;
        const f = e ? b.image_prompt : "a beautiful scenery, anime style, cinematic lighting";
        const g = "https://image.pollinations.ai/prompt/" + encodeURIComponent(f);
        const h = new Image();
        h.onload = function () {
          c.style.backgroundImage = "url(" + this.src + ")";
        };
        h.onerror = function () {
          c.style.backgroundImage = "url(" + d + ")";
        };
        h.src = g;
      } else {
        c.style.backgroundColor = "#f0f2f5";
        c.style.border = "1px solid #e0e0e0";
        const a = document.createElement("p");
        a.className = "char-photo-description";
        a.textContent = b.description || "(è¿™å¼ ç…§ç‰‡æ²¡æœ‰æè¿°)";
        c.appendChild(a);
      }
    });
  }
  async function ll() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨æ¨¡æ‹Ÿâ€œ" + a.name + "â€çš„ç½‘ä¸Šå†²æµªè¶³è¿¹...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå†…å®¹ã€‚");
      return;
    }
    const e = v.qzoneSettings.nickname === "{{user}}" || !v.qzoneSettings.nickname ? "ç”¨æˆ·" : v.qzoneSettings.nickname;
    const f = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ";
    const g = a.settings.maxMemory || 10;
    const h = a.history.slice(-g).map(b => (b.role === "user" ? e : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    const i = (a.settings.linkedWorldBookIds || []).map(a => v.worldBooks.find(b => b.id === a)).filter(Boolean).map(a => "\n## ä¸–ç•Œä¹¦ã€Š" + a.name + "ã€‹è®¾å®š:\n" + a.content.filter(a => a.enabled).map(a => "- " + a.content).join("\n")).join("");
    const j = th(a, 3, "hours");
    const k = th(a, 6, "hours");
    const l = th(a, 9, "hours");
    const m = th(a, 1, "days");
    const n = th(a, 3, "days");
    const o = th(a, 7, "days");
    let q = "";
    if (j || k || l || m || n || o) {
      q += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„å¯¹è¯å›žé¡¾)
`;
      if (j) {
        q += j;
      }
      if (k) {
        q += k;
      }
      if (l) {
        q += l;
      }
      if (j || k || l) {
        q += "\n";
      }
      if (m) {
        q += m;
      }
      if (n) {
        q += n;
      }
      if (o) {
        q += o;
      }
    }
    const r = a.settings.myPersona || "(æœªè®¾ç½®)";
    const s = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ` + a.name + `â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæž„å‡ºã€10åˆ°20æ¡ã€‘TAæœ€è¿‘çš„æµè§ˆå™¨æœç´¢/æµè§ˆè®°å½•ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆ›é€ æ€§ä¸Žåˆç†æ€§**: è®°å½•å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½ã€èŒä¸šå’Œç”Ÿæ´»çŽ¯å¢ƒã€‚
2.  **å¤šæ ·æ€§**: è®°å½•ç±»åž‹è¦ä¸°å¯Œï¼Œå¯ä»¥æ˜¯å¸–å­ã€æ–‡ç« ã€æ–°é—»ã€é—®ç­”ç­‰ã€‚
3.  **ã€æ ¼å¼ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: 
    - ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›žå¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åŽæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä»£è¡¨ä¸€æ¡æµè§ˆè®°å½•ï¼Œå¹¶ä¸”ã€å¿…é¡»ã€‘ä½¿ç”¨ä»¥ä¸‹æ ¼å¼:
    \`\`\`json
    [
      {
        "type": "text",
        "title": "ç²¾ç‚¼ä¸”å¸å¼•äººçš„æ ‡é¢˜ (ä¸è¶…è¿‡20å­—)",
        "url": "www.example.com/article/123 (çœ‹èµ·æ¥åƒçœŸå®žçš„ç®€æ´ç½‘å€)",
        "content": "ä¸€ç¯‡200-400å­—çš„ã€åˆ†æ®µè‰¯å¥½çš„æ–‡ç« æ­£æ–‡ï¼Œä½¿ç”¨\\næ¢è¡Œã€‚"
      }
    ]
    \`\`\`
    
    **ã€ç»å¯¹ç¦æ­¢ã€‘**: ä½ çš„å›žå¤ä¸­ã€ç»å¯¹ä¸èƒ½ã€‘åŒ…å« "type": "image" çš„å¯¹è±¡ã€‚æ‰€æœ‰è®°å½•éƒ½å¿…é¡»æ˜¯æ–‡å­—å†…å®¹ã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ` + a.settings.aiPersona + "\n- ** ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰çš„äººè®¾**:" + r + `
- **ä½ çš„é•¿æœŸè®°å¿†**:
` + f + "\n" + i + "\n" + q + " \n- **ä½ æœ€è¿‘å’Œâ€œ" + e + "â€çš„å¯¹è¯æ‘˜è¦**:\n" + h + `

çŽ°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¿™ç»„ã€çº¯æ–‡æœ¬ã€‘çš„æµè§ˆè®°å½•ã€‚`;
    try {
      const e = [{
        role: "user",
        content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„æµè§ˆå™¨è®°å½•ã€‚"
      }];
      let f = b.includes("generativelanguage");
      let g = p(d, c, s, e);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: s
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!h.ok) {
        throw new Error("API é”™è¯¯: " + h.statusText);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/(\[[\s\S]*\])/);
      if (!k || !k[0]) {
        throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŽŸå§‹è¿”å›ž: " + j);
      }
      const l = k[0];
      let m;
      try {
        m = JSON.parse(l);
      } catch (a) {
        throw new Error("è§£æžAIè¿”å›žçš„JSONæ—¶å‡ºé”™: " + a.message + `

AIåŽŸå§‹è¿”å›žå†…å®¹:
` + j);
      }
      a.simulatedBrowserHistory = m;
      await Gb.chats.put(a);
      await Ok();
    } catch (a) {
      console.error("ç”Ÿæˆæ¨¡æ‹Ÿæµè§ˆå™¨åŽ†å²å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆæµè§ˆè®°å½•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  function Ok() {
    const a = document.getElementById("char-browser-history");
    a.innerHTML = "";
    if (!ra) {
      return;
    }
    const b = v.chats[ra];
    const c = b.simulatedBrowserHistory || [];
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">TAçš„æµè§ˆå™¨ç©ºç©ºå¦‚ä¹Ÿï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›è®°å½•å§ï¼</p>";
      return;
    }
    c.forEach((b, c) => {
      const d = document.createElement("div");
      d.className = "char-browser-item";
      d.innerHTML = "\n            <div class=\"title\">" + b.title + "</div>\n            <div class=\"url\">" + b.url + "</div>\n        ";
      d.addEventListener("click", () => ml(c));
      a.appendChild(d);
    });
  }
  async function ml(a) {
    const b = v.chats[ra];
    const c = b.simulatedBrowserHistory[a];
    if (!c) {
      return;
    }
    va = c;
    ol(c);
    Lk("char-browser-article-screen");
    const d = document.getElementById("favorite-article-btn");
    const e = await Gb.favorites.where({
      type: "char_browser_article",
      "content.url": c.url
    }).first();
    d.classList.toggle("active", !!e);
  }
  async function nl() {
    if (!va || !ra) {
      return;
    }
    const a = va;
    const b = v.chats[ra];
    const c = document.getElementById("favorite-article-btn");
    const d = await Gb.favorites.where({
      type: "char_browser_article",
      "content.url": a.url
    }).first();
    if (d) {
      await Gb.favorites.delete(d.id);
      c.classList.remove("active");
      await Bb("æ“ä½œæˆåŠŸ", "å·²å–æ¶ˆæ”¶è—ã€‚");
    } else {
      const d = {
        type: "char_browser_article",
        content: {
          ...a,
          characterId: ra,
          characterName: b.name
        },
        timestamp: Date.now()
      };
      await Gb.favorites.add(d);
      c.classList.add("active");
      await Bb("æ“ä½œæˆåŠŸ", "å·²æˆåŠŸæ”¶è—åˆ°â€œæˆ‘çš„æ”¶è—â€é¡µé¢ï¼");
    }
  }
  function ol(a) {
    const b = document.getElementById("char-article-title");
    const c = document.getElementById("char-article-content");
    let d = "ç½‘é¡µæµè§ˆ";
    if (a.url) {
      try {
        const b = new URL(a.url.startsWith("http") ? a.url : "http://" + a.url);
        d = b.hostname.replace("www.", "");
      } catch (b) {
        d = a.title.substring(0, 10) + "...";
      }
    }
    b.textContent = d;
    c.innerHTML = "";
    if (a.type === "image") {
      c.innerHTML = `
            <div class="char-browser-image-description">
                <div style="font-size: 40px; margin-bottom: 20px; opacity: 0.5;">ðŸ–¼ï¸</div>
                ` + (a.title || "(æ— æ ‡é¢˜å›¾ç‰‡)") + "\n            </div>";
    } else {
      const b = "<div class=\"article-large-title\">" + a.title + "</div>";
      const d = (a.content || "å†…å®¹åŠ è½½å¤±è´¥...").split("\n").filter(a => a.trim() !== "").map(a => "<p>" + a + "</p>").join("");
      c.innerHTML = "\n            " + b + `
            <div class="article-body">
                ` + d + `
            </div>
        `;
    }
  }
  async function pl() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨æ¨¡æ‹Ÿâ€œ" + a.name + "â€çš„è´­ç‰©ä¹ æƒ¯...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå†…å®¹ã€‚");
      return;
    }
    const e = v.qzoneSettings.nickname === "{{user}}" || !v.qzoneSettings.nickname ? "ç”¨æˆ·" : v.qzoneSettings.nickname;
    const f = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ";
    const g = a.settings.maxMemory || 10;
    const h = a.history.slice(-g);
    const i = await vj(h, ra);
    const j = i.map(b => (b.role === "user" ? e : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    const k = (a.settings.linkedWorldBookIds || []).map(a => v.worldBooks.find(b => b.id === a)).filter(Boolean).map(a => "\n## ä¸–ç•Œä¹¦ã€Š" + a.name + "ã€‹è®¾å®š:\n" + a.content.filter(a => a.enabled).map(a => "- " + a.content).join("\n")).join("");
    const l = th(a, 3, "hours");
    const m = th(a, 6, "hours");
    const n = th(a, 9, "hours");
    const o = th(a, 1, "days");
    const q = th(a, 3, "days");
    const r = th(a, 7, "days");
    let s = "";
    if (l || m || n || o || q || r) {
      s += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„å¯¹è¯å›žé¡¾)
`;
      if (l) {
        s += l;
      }
      if (m) {
        s += m;
      }
      if (n) {
        s += n;
      }
      if (l || m || n) {
        s += "\n";
      }
      if (o) {
        s += o;
      }
      if (q) {
        s += q;
      }
      if (r) {
        s += r;
      }
    }
    const t = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ` + a.name + `â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæž„å‡ºTAæœ€è¿‘çš„æ·˜å®è´­ç‰©è®°å½•å’Œè´¦æˆ·ä½™é¢ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ä½™é¢é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: ä½ ã€å¿…é¡»ã€‘æ ¹æ®è§’è‰²çš„ã€ç»æµŽçŠ¶å†µã€‘è®¾å®šä¸€ä¸ªåˆç†çš„ \`totalBalance\` (æ€»ä½™é¢)ã€‚ä¾‹å¦‚ï¼Œå¯Œæœ‰çš„è§’è‰²åº”è¯¥æœ‰æ›´é«˜çš„ä½™é¢ï¼Œè€Œå­¦ç”Ÿæˆ–ç»æµŽæ‹®æ®çš„è§’è‰²åˆ™åº”è¯¥æœ‰è¾ƒä½Žçš„ä½™é¢ã€‚
2.  **åˆç†æ€§**: è´­ä¹°è®°å½•å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½å’Œç»æµŽçŠ¶å†µã€‚
3.  **æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: 
    - ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªã€å•ä¸€çš„JSONå¯¹è±¡ã€‘ã€‚
    - ä½ çš„å›žå¤å¿…é¡»ä»¥ \`{\` å¼€å§‹ï¼Œå¹¶ä»¥ \`}\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åŽæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®°ã€‚
    - æ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    {
      "totalBalance": 12345.67, // (è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ•°å­—ï¼Œä½ å¿…é¡»æ ¹æ®è§’è‰²çš„ç»æµŽçŠ¶å†µç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„ã€åˆç†çš„ä½™é¢ï¼)
      "purchases": [
        {
          "itemName": "ä¸€ä¸ªå…·ä½“ã€ç”ŸåŠ¨çš„å•†å“åç§°",
          "price": 128.80,
          "status": "å·²ç­¾æ”¶",
          "reason": "è¿™æ˜¯è§’è‰²è´­ä¹°è¿™ä»¶å•†å“çš„å†…å¿ƒç‹¬ç™½æˆ–ç†ç”±ï¼Œå¿…é¡»ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€æ¥å†™ã€‚",
          "image_prompt": "ä¸€æ®µç”¨äºŽç”Ÿæˆè¿™å¼ å•†å“å›¾ç‰‡çš„ã€è¯¦ç»†çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, é£Žæ ¼ä¸º realistic product photo, high quality, on a clean white background"
        }
      ]
    }
    \`\`\`
    - **purchases**: ä¸€ä¸ªåŒ…å«12åˆ°15ä¸ªå•†å“å¯¹è±¡çš„æ•°ç»„ã€‚
    - **status (è®¢å•çŠ¶æ€)**: åªèƒ½ä»Ž "å·²ç­¾æ”¶", "å¾…å‘è´§", "è¿è¾“ä¸­", "å¾…è¯„ä»·" ä¸­é€‰æ‹©ã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ` + a.settings.aiPersona + `
- **ä½ çš„é•¿æœŸè®°å¿†**:
` + f + "\n" + k + "\n" + s + " \n- **ä½ æœ€è¿‘å’Œâ€œ" + e + "â€çš„å¯¹è¯æ‘˜è¦**:\n" + j + `

çŽ°åœ¨ï¼Œè¯·ç”ŸæˆåŒ…å«æ€»ä½™é¢å’Œè´­ä¹°è®°å½•çš„JSONå¯¹è±¡ã€‚`;
    try {
      const e = [{
        role: "user",
        content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„æ·˜å®è´­ä¹°è®°å½•å’Œä½™é¢ã€‚"
      }];
      let f = b.includes("generativelanguage");
      let g = p(d, c, t, e);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: t
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!h.ok) {
        throw new Error("API é”™è¯¯: " + h.statusText);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/({[\s\S]*})/);
      if (!k) {
        throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONå¯¹è±¡ã€‚");
      }
      const l = JSON.parse(k[0]);
      if (!l.purchases) {
        l.purchases = [];
      }
      a.simulatedTaobaoHistory = l;
      await Gb.chats.put(a);
      await Pk();
    } catch (a) {
      console.error("ç”Ÿæˆæ¨¡æ‹Ÿæ·˜å®è®°å½•å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆè´­ç‰©è®°å½•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  function ql() {
    rl();
    Lk("char-wallet-screen");
  }
  async function rl() {
    const a = document.getElementById("char-wallet-content");
    a.innerHTML = "";
    const b = v.chats[ra];
    const c = b.simulatedTaobaoHistory || {};
    const d = c.purchases || [];
    const e = c.totalBalance || 0;
    const f = document.createElement("div");
    f.style.cssText = `
        background-color: #fff;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    `;
    f.innerHTML = `
        <p style="color: #8a8a8a; margin: 0 0 10px 0;">è´¦æˆ·ä½™é¢</p>
        <p style="font-size: 32px; font-weight: 600; color: #1f1f1f; margin: 0;">Â¥` + e.toFixed(2) + "</p>\n    ";
    a.appendChild(f);
    try {
      const c = await Gb.userWallet.get("main");
      const d = c?.kinshipCards?.find(a => a.chatId === ra);
      if (d) {
        const c = b.settings.myNickname || v.qzoneSettings.nickname || "æˆ‘";
        const e = document.createElement("div");
        e.style.cssText = `
                background: linear-gradient(135deg, #ff5252, #ff1744); 
                color: white; 
                padding: 15px; 
                border-radius: 12px; 
                margin-bottom: 20px; 
                box-shadow: 0 4px 10px rgba(255,82,82,0.3); 
                display: flex; 
                flex-direction: column; 
                gap: 5px;
                position: relative; 
            `;
        const f = d.limit - (d.spent || 0);
        e.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:14px; opacity:0.9; font-weight:500;">` + c + ` èµ é€çš„äº²å±žå¡</div>
                    <div style="font-size:12px; opacity:0.8;">æ”¯ä»˜å®</div>
                </div>
                <div style="font-size:28px; font-weight:bold; margin:10px 0; font-family: 'DIN Alternate', sans-serif;">Â¥ ` + f.toFixed(2) + `</div>
                <div style="font-size:12px; opacity:0.8; display:flex; justify-content:space-between;">
                    <span>æœ¬æœˆå¯ç”¨é¢åº¦</span>
                    <span>æ€»é¢ Â¥` + d.limit + `</span>
                </div>
                
                <!-- è§£ç»‘æŒ‰é’® -->
                <button class="unbind-kinship-btn" data-chat-id="` + ra + `" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.4);
                    color: white;
                    font-size: 11px;
                    padding: 2px 8px;
                    border-radius: 10px;
                    cursor: pointer;
                    backdrop-filter: blur(2px);
                ">è§£ç»‘</button>
            `;
        a.appendChild(e);
      }
    } catch (a) {
      console.error("æ¸²æŸ“äº²å±žå¡å¤±è´¥:", a);
    }
    const g = document.createElement("h3");
    g.textContent = "æœ€è¿‘æ”¯å‡º";
    g.style.cssText = "font-size: 16px; color: #555; margin-bottom: 10px;";
    a.appendChild(g);
    if (d.length === 0) {
      a.innerHTML += "<p style=\"text-align:center; color: var(--text-secondary);\">æš‚æ— æ”¯å‡ºè®°å½•ã€‚</p>";
    } else {
      d.forEach(b => {
        const c = document.createElement("div");
        c.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 0;
                border-bottom: 1px solid #f0f0f0;
            `;
        c.innerHTML = `
                <div>
                    <p style="font-weight: 500; margin: 0 0 4px 0;">` + b.itemName + "</p>\n                    <p style=\"font-size: 12px; color: #8a8a8a; margin: 0;\">" + b.status + `</p>
                </div>
                <div style="font-weight: 600; font-size: 16px; color: #ff5722;">- Â¥` + (b.price || 0).toFixed(2) + "</div>\n            ";
        a.appendChild(c);
      });
    }
  }
  async function sl() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚â€œ" + a.name + "â€åˆ†äº«TAçš„å¤‡å¿˜å½•...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚");
      return;
    }
    const e = v.qzoneSettings.nickname === "{{user}}" || !v.qzoneSettings.nickname ? "ç”¨æˆ·" : v.qzoneSettings.nickname;
    const f = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ";
    const g = a.settings.maxMemory || 10;
    const h = a.history.slice(-g);
    const i = await vj(h, ra);
    const j = i.map(b => (b.role === "user" ? e : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    const k = (a.settings.linkedWorldBookIds || []).map(a => v.worldBooks.find(b => b.id === a)).filter(Boolean).map(a => "\n## ä¸–ç•Œä¹¦ã€Š" + a.name + "ã€‹è®¾å®š:\n" + a.content.filter(a => a.enabled).map(a => "- " + a.content).join("\n")).join("");
    const l = th(a, 3, "hours");
    const m = th(a, 6, "hours");
    const n = th(a, 9, "hours");
    const o = th(a, 1, "days");
    const q = th(a, 3, "days");
    const r = th(a, 7, "days");
    let s = "";
    if (l || m || n || o || q || r) {
      s += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„å¯¹è¯å›žé¡¾)
`;
      if (l) {
        s += l;
      }
      if (m) {
        s += m;
      }
      if (n) {
        s += n;
      }
      if (l || m || n) {
        s += "\n";
      }
      if (o) {
        s += o;
      }
      if (q) {
        s += q;
      }
      if (r) {
        s += r;
      }
    }
    const t = a.settings.myPersona || "(æœªè®¾ç½®)";
    const u = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ` + a.name + `â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæž„å‡ºã€12åˆ°20æ¡ã€‘TAæœ€è¿‘å¯èƒ½ä¼šå†™åœ¨æ‰‹æœºå¤‡å¿˜å½•é‡Œçš„å†…å®¹ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆ›é€ æ€§ä¸Žåˆç†æ€§**: å¤‡å¿˜å½•å†…å®¹å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½ã€èŒä¸šå’Œç”Ÿæ´»çŽ¯å¢ƒã€‚å¯ä»¥æ˜¯è´­ç‰©æ¸…å•ã€å¾…åŠžäº‹é¡¹ã€çµæ„Ÿç‰‡æ®µã€ä¸€äº›éšç¬”å’Œæ„Ÿæ‚Ÿã€è‰ç¨¿ç­‰ã€‚
2.  **æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: 
    - ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›žå¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åŽæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€æ¡å¤‡å¿˜å½•ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "title": "å¤‡å¿˜å½•çš„æ ‡é¢˜ï¼Œä¾‹å¦‚ï¼šè´­ç‰©æ¸…å• æˆ– å‘¨æœ«è®¡åˆ’",
        "content": "å¤‡å¿˜å½•çš„è¯¦ç»†å†…å®¹ï¼Œå¿…é¡»æ”¯æŒæ¢è¡Œç¬¦\\nã€‚"
      }
    ]
    \`\`\`

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ` + a.settings.aiPersona + "\n- ** ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰çš„äººè®¾**:" + t + `
- **ä½ çš„é•¿æœŸè®°å¿†**:
` + f + "\n" + k + "\n" + s + "\n- **ä½ æœ€è¿‘å’Œâ€œ" + e + "â€çš„å¯¹è¯æ‘˜è¦**:\n" + j + `

çŽ°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¿™ç»„å¤‡å¿˜å½•ã€‚`;
    try {
      const e = [{
        role: "user",
        content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„å¤‡å¿˜å½•å†…å®¹ã€‚"
      }];
      let f = b.includes("generativelanguage");
      let g = p(d, c, u, e);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: u
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!h.ok) {
        const a = await h.json().catch(() => null);
        const b = a?.error?.message || h.statusText;
        throw new Error("API é”™è¯¯: " + h.status + " - " + b);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/(\[[\s\S]*\])/);
      if (!k || !k[0]) {
        throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŽŸå§‹è¿”å›ž: " + j);
      }
      const l = k[0];
      let m;
      try {
        m = JSON.parse(l);
      } catch (a) {
        throw new Error("è§£æžAIè¿”å›žçš„JSONæ—¶å‡ºé”™: " + a.message + `

AIåŽŸå§‹è¿”å›žå†…å®¹:
` + j);
      }
      if (!Array.isArray(m)) {
        throw new Error("AIè¿”å›žçš„æ•°æ®ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚åŽŸå§‹è¿”å›ž: " + JSON.stringify(m));
      }
      a.memos = m.map(a => ({
        id: Date.now() + Math.random(),
        title: a.title,
        content: a.content
      }));
      await Gb.chats.put(a);
      await Wk();
    } catch (a) {
      console.error("ç”Ÿæˆæ¨¡æ‹Ÿå¤‡å¿˜å½•å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆå¤‡å¿˜å½•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  async function tl() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨ç”Ÿæˆâ€œ" + a.name + "â€çš„å‡ºè¡Œè¶³è¿¹...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå†…å®¹ã€‚");
      return;
    }
    const e = v.qzoneSettings.nickname === "{{user}}" || !v.qzoneSettings.nickname ? "ç”¨æˆ·" : v.qzoneSettings.nickname;
    const f = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ";
    const g = a.settings.maxMemory || 10;
    const h = a.history.slice(-g);
    const i = await vj(h, ra);
    const j = i.map(b => (b.role === "user" ? e : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    const k = (a.settings.linkedWorldBookIds || []).map(a => v.worldBooks.find(b => b.id === a)).filter(Boolean).map(a => "\n## ä¸–ç•Œä¹¦ã€Š" + a.name + "ã€‹è®¾å®š:\n" + a.content.filter(a => a.enabled).map(a => "- " + a.content).join("\n")).join("");
    const l = th(a, 3, "hours");
    const m = th(a, 6, "hours");
    const n = th(a, 9, "hours");
    const o = th(a, 1, "days");
    const q = th(a, 3, "days");
    const r = th(a, 7, "days");
    let s = "";
    if (l || m || n || o || q || r) {
      s += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„å¯¹è¯å›žé¡¾)
`;
      if (l) {
        s += l;
      }
      if (m) {
        s += m;
      }
      if (n) {
        s += n;
      }
      if (l || m || n) {
        s += "\n";
      }
      if (o) {
        s += o;
      }
      if (q) {
        s += q;
      }
      if (r) {
        s += r;
      }
    }
    const t = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ` + a.name + `â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæž„å‡ºã€12åˆ°20æ¡ã€‘TAæœ€è¿‘çš„â€œé«˜å¾·åœ°å›¾â€å‡ºè¡Œè¶³è¿¹ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€æ—¶é—´ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**:
    -   ä»Šå¤©çš„æ—¥æœŸæ˜¯ **` + new Date().toISOString() + `**ã€‚
    -   ä½ ç”Ÿæˆçš„ã€æ‰€æœ‰ã€‘è¶³è¿¹çš„ \`timestamp\` å­—æ®µï¼Œã€å¿…é¡»ã€‘æ˜¯ä»Šå¤©æˆ–ä»Šå¤©ä»¥å‰çš„æ—¥æœŸã€‚
    -   ã€ç»å¯¹ç¦æ­¢ã€‘ç”Ÿæˆä»»ä½•æœªæ¥çš„æ—¥æœŸï¼
    -   è¯·ç”Ÿæˆä¸€ä¸ªçœ‹èµ·æ¥åƒæ˜¯è¿‡åŽ»å‡ å‘¨å†…çš„ã€æ—¶é—´ã€ä»Žæ–°åˆ°æ—§ã€‘æŽ’åˆ—çš„è¶³è¿¹åˆ—è¡¨ã€‚
2.  **åˆ›é€ æ€§ä¸Žåˆç†æ€§**: è¶³è¿¹å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½ã€èŒä¸šå’Œç”Ÿæ´»çŽ¯å¢ƒã€‚
3.  **å¤šæ ·æ€§**: åœ°ç‚¹ç±»åž‹è¦ä¸°å¯Œï¼Œå¯ä»¥åŒ…æ‹¬é¤åŽ…ã€å•†åœºã€å…¬å›­ã€å…¬å¸ã€æœ‹å‹å®¶ç­‰ã€‚
4.  **ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: 
    - ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›žå¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åŽæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€æ¡è¶³è¿¹ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "locationName": "ä¸€ä¸ªå…·ä½“ã€ç”ŸåŠ¨çš„åœ°ç‚¹åç§°",
        "address": "ä¸€ä¸ªè™šæž„ä½†çœ‹èµ·æ¥å¾ˆçœŸå®žçš„è¯¦ç»†åœ°å€",
        "comment": "è¿™æ˜¯è§’è‰²å¯¹è¿™æ¬¡å‡ºè¡Œæˆ–è¿™ä¸ªåœ°ç‚¹çš„å†…å¿ƒç‹¬ç™½æˆ–è¯„è®ºï¼Œå¿…é¡»ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€æ¥å†™ã€‚",
        "image_prompt": "(å¯é€‰)ä¸€æ®µç”¨äºŽç”Ÿæˆè¿™å¼ åœ°ç‚¹ç…§ç‰‡çš„ã€è¯¦ç»†çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, é£Žæ ¼ä¸º realistic photo, high quality",
        "timestamp": "ç¬¦åˆ ISO 8601 æ ¼å¼çš„æ—¥æœŸæ—¶é—´å­—ç¬¦ä¸² (ä¾‹å¦‚: '2025-09-25T18:30:00Z')"
      }
    ]
    \`\`\`
    - **é‡è¦**: å¤§çº¦æœ‰ã€ä¸‰åˆ†ä¹‹ä¸€ã€‘çš„è¶³è¿¹éœ€è¦åŒ…å« \`image_prompt\` å­—æ®µæ¥ç”Ÿæˆä¸€å¼ ç…§ç‰‡ã€‚
    - **å›¾ç‰‡**: image_prompt ç”Ÿæˆçš„å›¾ç‰‡ã€ç»å¯¹ç¦æ­¢åŒ…å«çœŸäººã€‘ã€‚å¦‚æžœåœ°ç‚¹æ˜¯å®¤å†…ï¼Œå¯ä»¥ç”Ÿæˆç©ºæ— ä¸€äººçš„åœºæ™¯ï¼›å¦‚æžœæ˜¯å®¤å¤–ï¼Œå¯ä»¥åªæœ‰é£Žæ™¯æˆ–å»ºç­‘ã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ` + a.settings.aiPersona + `
- **ä½ çš„é•¿æœŸè®°å¿†**:
` + f + "\n" + k + "\n" + s + "\n- **ä½ æœ€è¿‘å’Œâ€œ" + e + "â€çš„å¯¹è¯æ‘˜è¦**:\n" + j + `

çŽ°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¿™ç»„è¶³è¿¹è®°å½•ã€‚`;
    try {
      const e = [{
        role: "user",
        content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„é«˜å¾·åœ°å›¾è¶³è¿¹ã€‚"
      }];
      let f = b.includes("generativelanguage");
      let g = p(d, c, t, e);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: t
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!h.ok) {
        throw new Error("API é”™è¯¯: " + h.statusText);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/(\[[\s\S]*\])/);
      if (!k || !k[0]) {
        throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŽŸå§‹è¿”å›ž: " + j);
      }
      const l = k[0];
      let m;
      try {
        m = JSON.parse(l);
      } catch (a) {
        throw new Error("è§£æžAIè¿”å›žçš„JSONæ—¶å‡ºé”™: " + a.message + `

AIåŽŸå§‹è¿”å›žå†…å®¹:
` + j);
      }
      a.simulatedAmapHistory = m;
      await Gb.chats.put(a);
      await ul();
    } catch (a) {
      console.error("ç”Ÿæˆæ¨¡æ‹Ÿè¶³è¿¹å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆè¶³è¿¹ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  function ul() {
    const a = document.getElementById("char-amap-list");
    a.innerHTML = "";
    if (!ra) {
      return;
    }
    const b = v.chats[ra];
    const c = b.simulatedAmapHistory || [];
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">è¿™é‡Œè¿˜æ²¡æœ‰ç•™ä¸‹ä»»ä½•è¶³è¿¹ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›è®°å½•å§ï¼</p>";
      return;
    }
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "char-amap-item";
      let d = "";
      if (b.image_prompt) {
        const a = "https://image.pollinations.ai/prompt/" + encodeURIComponent(b.image_prompt);
        d = "<div class=\"amap-item-photo\" style=\"background-image: url('" + a + "')\" data-comment=\"" + b.comment + "\"></div>";
      }
      const e = b.timestamp ? pc(new Date(b.timestamp).getTime()) : "æŸä¸ªæ—¶é—´";
      c.innerHTML = `
                    <div class="amap-item-header">
                        <div class="amap-item-icon">ðŸ“</div>
                        <div class="amap-item-info">
                            <div class="amap-item-title">` + b.locationName + "</div>\n                            <div class=\"amap-item-address\">" + b.address + `</div>
                        </div>
                    </div>
                    <div class="amap-item-body">
                        <div class="amap-item-comment">` + b.comment.replace(/\n/g, "<br>") + "</div>\n                        " + d + `
                    </div>
                    <div class="amap-item-footer">` + e + "</div>\n                ";
      a.appendChild(c);
    });
  }
  async function vl() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨åˆ†æžâ€œ" + a.name + "â€çš„æ‰‹æœºä½¿ç”¨ä¹ æƒ¯...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå†…å®¹ã€‚");
      return;
    }
    const e = v.qzoneSettings.nickname === "{{user}}" || !v.qzoneSettings.nickname ? "ç”¨æˆ·" : v.qzoneSettings.nickname;
    const f = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ";
    const g = a.settings.maxMemory || 10;
    const h = a.history.slice(-g);
    const i = await vj(h, ra);
    const j = i.map(b => (b.role === "user" ? e : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    const k = (a.settings.linkedWorldBookIds || []).map(a => v.worldBooks.find(b => b.id === a)).filter(Boolean).map(a => "\n## ä¸–ç•Œä¹¦ã€Š" + a.name + "ã€‹è®¾å®š:\n" + a.content.filter(a => a.enabled).map(a => "- " + a.content).join("\n")).join("");
    const l = th(a, 3, "hours");
    const m = th(a, 6, "hours");
    const n = th(a, 9, "hours");
    const o = th(a, 1, "days");
    const q = th(a, 3, "days");
    const r = th(a, 7, "days");
    let s = "";
    if (l || m || n || o || q || r) {
      s += `
# æ™ºèƒ½æ€»ç»“ (åŸºäºŽä¸åŒæ—¶é—´ç»´åº¦çš„å¯¹è¯å›žé¡¾)
`;
      if (l) {
        s += l;
      }
      if (m) {
        s += m;
      }
      if (n) {
        s += n;
      }
      if (l || m || n) {
        s += "\n";
      }
      if (o) {
        s += o;
      }
      if (q) {
        s += q;
      }
      if (r) {
        s += r;
      }
    }
    const t = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ` + a.name + `â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæž„å‡ºTAæœ€è¿‘ä¸€å¤©çš„ã€æ‰‹æœºAppå±å¹•ä½¿ç”¨æ—¶é—´ã€‘è®°å½•ï¼Œæ€»å…±çº¦20æ¡ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆ›é€ æ€§ä¸Žå¤šæ ·æ€§**: ç”Ÿæˆçš„Appåˆ—è¡¨ã€ä¸å¿…å±€é™äºŽã€‘Cphoneä¸»å±å¹•ä¸Šå·²æœ‰çš„Appã€‚ä½ å¯ä»¥è‡ªç”±åœ°è™šæž„TAå¯èƒ½ä½¿ç”¨çš„å…¶ä»–Appï¼Œä¾‹å¦‚ Instagram, Twitter, å„ç§æ¸¸æˆ (å¦‚ï¼šåŽŸç¥ž, çŽ‹è€…è£è€€), è§†é¢‘App (å¦‚ï¼šæŠ–éŸ³, YouTube), å­¦ä¹ æˆ–å·¥ä½œè½¯ä»¶ç­‰ï¼Œè¿™èƒ½æ›´å¥½åœ°ä½“çŽ°è§’è‰²çš„éšè—å…´è¶£å’Œç”Ÿæ´»ä¹ æƒ¯ã€‚
2.  **åˆç†æ€§**: ä½¿ç”¨æ—¶é•¿å’ŒAppç±»åž‹å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½ã€èŒä¸šå’Œç”Ÿæ´»çŽ¯å¢ƒã€‚
3.  **æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: 
    - ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›žå¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åŽæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªAppçš„ä½¿ç”¨è®°å½•ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "appName": "Appçš„åç§° (ä¾‹å¦‚: å¾®ä¿¡, å¾®åš, åŽŸç¥ž)",
        "usageTimeMinutes": 125,
        "category": "Appçš„åˆ†ç±» (ä¾‹å¦‚: ç¤¾äº¤, æ¸¸æˆ, å½±éŸ³, å·¥å…·, é˜…è¯», è´­ç‰©)",
        "image_prompt": "ä¸€æ®µç”¨äºŽç”Ÿæˆè¿™ä¸ªAppã€å›¾æ ‡ã€‘çš„ã€ç®€æ´çš„ã€è‹±æ–‡ã€‘å…³é”®è¯ã€‚é£Žæ ¼å¿…é¡»æ˜¯ modern app icon, flat design, simple, clean background"
      }
    ]
    \`\`\`

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ` + a.settings.aiPersona + `
- **ä½ çš„é•¿æœŸè®°å¿†**:
` + f + "\n" + k + "\n" + s + "\n- **ä½ æœ€è¿‘å’Œâ€œ" + e + "â€çš„å¯¹è¯æ‘˜è¦**:\n" + j + `

çŽ°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¿™ç»„Appä½¿ç”¨è®°å½•ã€‚`;
    try {
      const e = [{
        role: "user",
        content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„Appä½¿ç”¨è®°å½•ã€‚"
      }];
      let f = b.includes("generativelanguage");
      let g = p(d, c, t, e);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: t
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!h.ok) {
        throw new Error("API é”™è¯¯: " + h.statusText);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.replace(/^```json\s*/, "").replace(/```$/, "");
      const l = JSON.parse(k);
      a.simulatedAppUsage = l;
      await Gb.chats.put(a);
      await Tk();
    } catch (a) {
      console.error("ç”Ÿæˆæ¨¡æ‹ŸAppä½¿ç”¨è®°å½•å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆè®°å½•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  function Tk() {
    const a = document.getElementById("char-usage-list");
    a.innerHTML = "";
    if (!ra) {
      return;
    }
    const b = v.chats[ra];
    const c = (b.simulatedAppUsage || []).sort((a, b) => b.usageTimeMinutes - a.usageTimeMinutes);
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">è¿™é‡Œè¿˜æ²¡æœ‰ä»»ä½•ä½¿ç”¨è®°å½•ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›å§ï¼</p>";
      return;
    }
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "char-usage-item";
      const d = Math.floor(b.usageTimeMinutes / 60);
      const e = b.usageTimeMinutes % 60;
      let f = "";
      if (d > 0) {
        f += d + "å°æ—¶";
      }
      if (e > 0) {
        f += e + "åˆ†é’Ÿ";
      }
      if (!f) {
        f = "å°äºŽ1åˆ†é’Ÿ";
      }
      const g = b.image_prompt || "modern app icon for " + b.appName + ", flat design, simple";
      const h = "https://image.pollinations.ai/prompt/" + encodeURIComponent(g);
      c.innerHTML = "\n                    <img src=\"" + h + `" class="usage-item-icon">
                    <div class="usage-item-info">
                        <div class="usage-item-name">` + b.appName + "</div>\n                        <div class=\"usage-item-category\">" + b.category + `</div>
                    </div>
                    <div class="usage-item-time">` + f + "</div>\n                ";
      a.appendChild(c);
    });
  }
  async function wl() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨ç»“åˆä¸–ç•Œè§‚ä¸Žäººè®¾ï¼Œåˆ†æžâ€œ" + a.name + "â€çš„Bç«™å…´è¶£...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚");
      return;
    }
    const e = v.qzoneSettings.nickname === "{{user}}" || !v.qzoneSettings.nickname ? "ç”¨æˆ·" : v.qzoneSettings.nickname;
    const f = a.settings.maxMemory || 10;
    const g = a.history.slice(-f);
    const h = await vj(g, ra);
    const i = h.map(b => (b.role === "user" ? e : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    const j = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- " + a.content).join("\n") : "æ— ";
    const k = (a.settings.linkedWorldBookIds || []).map(a => v.worldBooks.find(b => b.id === a)).filter(Boolean).map(a => "\n## ä¸–ç•Œä¹¦ã€Š" + a.name + "ã€‹è®¾å®š:\n" + a.content.filter(a => a.enabled).map(a => "- " + a.content).join("\n")).join("");
    const l = a.settings.myPersona || "(æœªè®¾ç½®)";
    const m = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”¨æˆ·ç”»åƒåˆ†æžå¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ` + a.name + "â€ï¼Œæ ¹æ®TAçš„äººè®¾ã€æ‰€å¤„çš„ä¸–ç•Œè§‚ã€é•¿æœŸè®°å¿†ã€ä»¥åŠä¸Žç”¨æˆ·ï¼ˆ" + e + `ï¼‰çš„å…³ç³»ï¼Œ**æŽ¨æµ‹TAçŽ°åœ¨æœ€æƒ³åœ¨ Bilibili (Bç«™) ä¸Šæœç´¢æˆ–è§‚çœ‹çš„è§†é¢‘å…³é”®è¯**ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **æ·±åº¦äººè®¾ç»‘å®š**: å…³é”®è¯å¿…é¡»ç´§æ‰£è§’è‰²çš„æ€§æ ¼ã€èŒä¸šã€çˆ±å¥½ä»¥åŠ**ä¸–ç•Œè§‚è®¾å®š**ã€‚
    - ä¾‹å¦‚ï¼šå¦‚æžœä¸–ç•Œä¹¦é‡Œè®¾å®šäº†â€œé­”æ³•â€ï¼Œè§’è‰²å¯èƒ½ä¼šæœâ€œç«çƒæœ¯æ•™å­¦â€ï¼›å¦‚æžœæ˜¯â€œæœ«ä¸–â€ï¼Œå¯èƒ½ä¼šæœâ€œç”Ÿå­˜æŒ‡å—â€ã€‚
2.  **å…³ç³»å¯¼å‘**: å¦‚æžœç”¨æˆ·äººè®¾æ˜¯ä½ å–œæ¬¢çš„äººï¼Œä½ å¯èƒ½ä¼šæœâ€œç»™å–œæ¬¢çš„äººé€ä»€ä¹ˆç¤¼ç‰©â€ï¼›å¦‚æžœæ˜¯æ­»å¯¹å¤´ï¼Œå¯èƒ½ä¼šæœâ€œå¦‚ä½•ä¼˜é›…åœ°æ€¼äººâ€ã€‚å¿…é¡»é€»è¾‘è‡ªæ´½ã€‚
3.  **å¤šæ ·æ€§**: è¯·ç”Ÿæˆ **10åˆ°12ä¸ª** å…·ä½“çš„æœç´¢å…³é”®è¯ã€‚
4.  **å…·ä½“æ€§**: å…³é”®è¯æœ€å¥½å…·ä½“ä¸€ç‚¹ã€‚
5.  **æ ¼å¼é“å¾‹**: 
    - ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª**å­—ç¬¦ä¸²** (å³æœç´¢å…³é”®è¯)ã€‚
    - ç¤ºä¾‹: \`["å…³é”®è¯1", "å…³é”®è¯2", "å…³é”®è¯3"...]\`

# ä¾›ä½ å‚è€ƒçš„è¯¦ç»†ä¸Šä¸‹æ–‡
- **è§’è‰²äººè®¾**: ` + a.settings.aiPersona + "\n- **ç”¨æˆ·(" + e + ")çš„äººè®¾**: " + l + ` 
- **é•¿æœŸè®°å¿†**: 
` + j + "\n" + k + ` 
- **æœ€è¿‘å¯¹è¯**:
` + i + `

çŽ°åœ¨ï¼Œè¯·ç»“åˆä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œç”Ÿæˆè¿™ç»„æœç´¢å…³é”®è¯ã€‚`;
    try {
      const e = [{
        role: "user",
        content: "è¯·ç”ŸæˆBç«™æœç´¢å…³é”®è¯åˆ—è¡¨ã€‚"
      }];
      let f = b.includes("generativelanguage");
      let g = p(d, c, m, e);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: m
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 1
        })
      });
      if (!h.ok) {
        throw new Error("API é”™è¯¯: " + h.statusText);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.replace(/^```json\s*/, "").replace(/```$/, "");
      const l = JSON.parse(k);
      if (!Array.isArray(l)) {
        throw new Error("AIæ²¡æœ‰è¿”å›žæ•°ç»„æ ¼å¼çš„å…³é”®è¯ã€‚");
      }
      await Bb("è¯·ç¨å€™...", "AIå·²ç»“åˆä¸–ç•Œè§‚ç”Ÿæˆ " + l.length + " ä¸ªå…³é”®è¯ï¼Œæ­£åœ¨é€ä¸ªæœç´¢Bç«™è§†é¢‘ (ä¸ºé˜²å°ç¦ï¼Œé€Ÿåº¦ä¼šç¨æ…¢)...");
      const n = a => new Promise(b => // TOLOOK
      setTimeout(b, a));
      const o = [];
      for (const [a, b] of l.entries()) {
        let c = 0;
        let d = false;
        const e = 5;
        while (!d && c < e) {
          try {
            const e = c > 0 ? " (ç¬¬ " + c + " æ¬¡é‡è¯•)" : "";
            console.log("[Bç«™æœç´¢ " + (a + 1) + "/" + l.length + "] æ­£åœ¨æœç´¢: " + b + e);
            const f = "https://api.52vmy.cn/api/query/bilibili/video?msg=" + encodeURIComponent(b) + "&n=1";
            const g = "https://corsproxy.io/?" + encodeURIComponent(f);
            const h = await fetch(g);
            if (!h.ok) {
              throw new Error("HTTP " + h.status);
            }
            const i = await h.text();
            if (i.includes("è®¿é—®è¿‡å¿«") || i.includes("é¢‘ç¹") || i.includes("Too Many Requests")) {
              console.warn("âš ï¸ å…³é”®è¯ \"" + b + "\" è§¦å‘é™æµï¼Œç­‰å¾…å†·å´åŽé‡è¯•...");
              await n(5000 + c * 2000);
              c++;
              continue;
            }
            let j;
            try {
              j = JSON.parse(i);
            } catch (a) {
              console.warn("JSONè§£æžå¤±è´¥ï¼Œå‡†å¤‡é‡è¯•: " + b);
              c++;
              await n(3000);
              continue;
            }
            let k = null;
            if (j.data && Array.isArray(j.data) && j.data.length > 0) {
              k = j.data[0];
            } else if (j.code === 200 && j.data) {
              k = Array.isArray(j.data) ? j.data[0] : j.data;
            } else if (j.title) {
              k = j;
            }
            if (k && k.title && k.url) {
              o.push(k);
            }
            d = true;
          } catch (a) {
            console.warn("æœç´¢å…³é”®è¯ \"" + b + "\" å‘ç”Ÿé”™è¯¯:", a);
            c++;
            await n(3000);
          }
        }
        if (!d) {
          console.error("âŒ å…³é”®è¯ \"" + b + "\" é‡è¯• " + e + " æ¬¡åŽä»ç„¶å¤±è´¥ï¼Œå·²è·³è¿‡ã€‚");
        }
        await n(1500);
      }
      a.simulatedBilibiliFeed = o;
      await Gb.chats.put(a);
      xl();
      await Bb("å®Œæˆ", "æˆåŠŸä¸ºä½ ç”Ÿæˆäº† " + o.length + " ä¸ªç¬¦åˆ " + a.name + " äººè®¾ä¸Žä¸–ç•Œè§‚çš„è§†é¢‘æŽ¨èï¼");
    } catch (a) {
      console.error("ç”ŸæˆBç«™æŽ¨èå¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”ŸæˆæŽ¨èå†…å®¹ã€‚\né”™è¯¯: " + a.message);
    }
  }
  function xl() {
    const a = document.getElementById("char-bilibili-list");
    a.innerHTML = "";
    if (!ra) {
      return;
    }
    const b = v.chats[ra];
    const c = b.simulatedBilibiliFeed || [];
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">é¦–é¡µç©ºç©ºå¦‚ä¹Ÿï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®èŽ·å–ä¸ªæ€§åŒ–æŽ¨èå§ï¼</p>";
      return;
    }
    c.forEach(b => {
      const c = document.createElement("div");
      c.className = "bilibili-item";
      c.innerHTML = `
            <div class="bili-cover" style="position: relative; overflow: hidden;">
                <img src="` + (b.img_url || b.pic) + `" referrerpolicy="no-referrer" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1;" onerror="this.style.display='none'">
                <div class="bili-duration" style="position: absolute; z-index: 2;">â–¶</div>
            </div>
            <div class="bili-info">
                <div class="bili-title">` + b.title + "</div>\n                <div class=\"bili-author\">UP: " + (b.user || b.author || "æœªçŸ¥UPä¸»") + `</div>
            </div>
        `;
      c.onclick = () => $o(b);
      a.appendChild(c);
    });
  }
  async function yl() {
    if (!ra) {
      return;
    }
    const a = v.chats[ra];
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚â€œ" + a.name + "â€åˆ†äº«TAçš„ç§äººæ­Œå•...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚");
      return;
    }
    const e = v.qzoneSettings.nickname === "{{user}}" || !v.qzoneSettings.nickname ? "ç”¨æˆ·" : v.qzoneSettings.nickname;
    const f = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ";
    const g = a.settings.maxMemory || 10;
    const h = a.history.slice(-g);
    const i = await vj(h, ra);
    const j = i.map(b => (b.role === "user" ? e : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    const k = (a.settings.linkedWorldBookIds || []).map(a => v.worldBooks.find(b => b.id === a)).filter(Boolean).map(a => "\n## ä¸–ç•Œä¹¦ã€Š" + a.name + "ã€‹è®¾å®š:\n" + a.content.filter(a => a.enabled).map(a => "- " + a.content).join("\n")).join("");
    const l = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹ŸéŸ³ä¹å“å‘³æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ` + a.name + `â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼ŒæŒ‘é€‰å‡ºã€14åˆ°18é¦–ã€‘æœ€èƒ½ä»£è¡¨TAæ­¤åˆ»å¿ƒæƒ…æˆ–å“å‘³çš„æ­Œæ›²ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆ›é€ æ€§ä¸Žåˆç†æ€§**: æ­Œå•å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½å’Œç”Ÿæ´»èƒŒæ™¯ã€‚
2.  **å¤šæ ·æ€§**: æ­Œæ›²é£Žæ ¼å¯ä»¥å¤šæ ·ï¼Œä½†å¿…é¡»é€»è¾‘è‡ªæ´½ã€‚
3.  **æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: 
    - ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›žå¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åŽæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€é¦–æ­Œï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "songName": "æ­Œæ›²çš„å‡†ç¡®åç§°",
        "artistName": "æ­Œæ›²çš„å‡†ç¡®è‰ºæœ¯å®¶/æ­Œæ‰‹å"
      }
    ]
    \`\`\`

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ` + a.settings.aiPersona + `
- **ä½ çš„é•¿æœŸè®°å¿†**:
` + f + "\n" + k + "\n- **ä½ æœ€è¿‘å’Œâ€œ" + e + "â€çš„å¯¹è¯æ‘˜è¦**:\n" + j + `

çŽ°åœ¨ï¼Œè¯·ç”Ÿæˆè¿™ä»½æ­Œå•ã€‚`;
    try {
      const e = [{
        role: "user",
        content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„æ­Œå•ã€‚"
      }];
      let f = b.includes("generativelanguage");
      let g = p(d, c, l, e);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: l
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 1
        })
      });
      if (!h.ok) {
        throw new Error("API é”™è¯¯: " + h.statusText);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.replace(/^```json\s*/, "").replace(/```$/, "");
      const m = JSON.parse(k);
      await Bb("è¯·ç¨å€™...", "æ­Œå•å·²ç”Ÿæˆï¼Œæ­£åœ¨ä»Žç½‘ç»œèŽ·å– " + m.length + " é¦–æ­Œæ›²çš„è¯¦ç»†ä¿¡æ¯...");
      const n = m.map(async a => {
        let b = await Oj(a.songName, a.artistName);
        if (!b || b.length === 0) {
          b = await Xj(a.songName);
        }
        if (b.length > 0) {
          return Zj(b[0]);
        }
        console.warn("æ‰€æœ‰éŸ³ä¹æºéƒ½æœªèƒ½æ‰¾åˆ°æ­Œæ›²ï¼šâ€œ" + a.songName + " - " + a.artistName + "â€");
        return null;
      });
      const o = (await Promise.all(n)).filter(Boolean);
      a.simulatedMusicPlaylist = o;
      await Gb.chats.put(a);
      await zl();
    } catch (a) {
      console.error("ç”Ÿæˆæ¨¡æ‹Ÿæ­Œå•å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆæ­Œå•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  function zl() {
    const a = document.getElementById("char-music-list");
    a.innerHTML = "";
    if (!ra) {
      return;
    }
    const b = v.chats[ra];
    const c = b.simulatedMusicPlaylist || [];
    if (c.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">TAçš„æ­Œå•è¿˜æ˜¯ç©ºçš„ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›æ­Œæ›²å§ï¼</p>";
      return;
    }
    c.forEach((b, d) => {
      const e = document.createElement("div");
      e.className = "char-music-item";
      e.innerHTML = "\n            <img src=\"" + b.cover + `" class="music-item-cover">
            <div class="music-item-info">
                <div class="music-item-name">` + b.name + "</div>\n                <div class=\"music-item-artist\">" + b.artist + `</div>
            </div>
        `;
      e.addEventListener("click", () => Bl(d, c));
      a.appendChild(e);
    });
  }
  let Al = {
    currentPlaylist: [],
    currentIndex: -1,
    isPlaying: false,
    playMode: "order",
    lrcUpdateInterval: null,
    parsedLyrics: [],
    currentLyricIndex: -1
  };
  function Bl(a, b) {
    const c = document.getElementById("char-audio-player");
    const d = document.getElementById("char-music-player-modal");
    if (Al.lrcUpdateInterval) {
      clearInterval(Al.lrcUpdateInterval);
    }
    c.pause();
    Al.currentPlaylist = b;
    Al.currentIndex = a;
    const e = b[a];
    if (!e) {
      console.error("playCharSong: æ­Œæ›²ç´¢å¼•æ— æ•ˆæˆ–æ­Œå•ä¸ºç©ºã€‚");
      return;
    }
    document.getElementById("char-music-player-title").textContent = e.name;
    document.getElementById("char-music-artist").textContent = e.artist;
    document.getElementById("char-music-cover").src = e.cover;
    Al.parsedLyrics = Ih(e.lrcContent || "");
    Gl();
    if (e.isLocal) {
      const a = new Blob([e.src], {
        type: e.fileType || "audio/mpeg"
      });
      c.src = URL.createObjectURL(a);
    } else {
      c.src = e.src;
    }
    c.play().catch(a => console.error("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", a));
    c.onloadedmetadata = () => {
      document.getElementById("char-music-total-time").textContent = Oh(c.duration);
      Al.lrcUpdateInterval = // TOLOOK
      setInterval(Fl, 1000);
    };
    d.classList.add("visible");
  }
  function Cl() {
    const a = document.getElementById("char-music-player-modal");
    a.classList.remove("visible");
    document.getElementById("char-music-restore-btn").style.display = "flex";
  }
  function Dl() {
    const a = document.getElementById("char-music-player-modal");
    a.classList.add("visible");
    document.getElementById("char-music-restore-btn").style.display = "none";
  }
  function El() {
    const a = document.getElementById("char-music-player-modal");
    const b = document.getElementById("char-audio-player");
    if (Al.lrcUpdateInterval) {
      clearInterval(Al.lrcUpdateInterval);
    }
    b.pause();
    a.classList.remove("visible");
    Al.isPlaying = false;
    document.getElementById("char-vinyl-container").classList.remove("spinning");
    document.getElementById("char-music-restore-btn").style.display = "none";
  }
  function Fl() {
    const a = document.getElementById("char-audio-player");
    if (!a.duration) {
      return;
    }
    const b = a.currentTime;
    const c = a.duration;
    document.getElementById("char-music-progress-fill").style.width = b / c * 100 + "%";
    document.getElementById("char-music-current-time").textContent = Oh(b);
    Hl(b);
  }
  function Gl() {
    const a = document.getElementById("char-music-lyrics");
    a.innerHTML = "";
    Al.currentLyricIndex = -1;
    const b = document.createElement("div");
    b.id = "char-lyrics-scroll-wrapper";
    b.style.transition = "transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)";
    a.appendChild(b);
    if (!Al.parsedLyrics || Al.parsedLyrics.length === 0) {
      b.innerHTML = "<p>â™ª æš‚æ— æ­Œè¯ â™ª</p>";
      return;
    }
    Al.parsedLyrics.forEach((a, c) => {
      const d = document.createElement("p");
      d.textContent = a.text;
      d.dataset.index = c;
      d.style.margin = "0";
      d.style.padding = "5px 0";
      d.style.color = "#888";
      d.style.transition = "all 0.3s";
      b.appendChild(d);
    });
  }
  function Hl(a) {
    const b = Al.parsedLyrics;
    if (b.length === 0) {
      return;
    }
    let c = -1;
    for (let d = 0; d < b.length; d++) {
      if (a >= b[d].time) {
        c = d;
      } else {
        break;
      }
    }
    if (c === Al.currentLyricIndex) {
      return;
    }
    Al.currentLyricIndex = c;
    const d = document.getElementById("char-lyrics-scroll-wrapper");
    if (!d) {
      return;
    }
    const e = d.querySelectorAll("p");
    e.forEach(a => {
      a.classList.remove("active");
      a.style.color = "#888";
      a.style.transform = "scale(1)";
    });
    if (c > -1) {
      const a = d.querySelector("p[data-index=\"" + c + "\"]");
      if (a) {
        a.classList.add("active");
        a.style.color = "#333";
        a.style.fontWeight = "bold";
        a.style.transform = "scale(1.1)";
        const b = document.getElementById("char-music-lyrics").clientHeight;
        const c = b / 2 - a.offsetTop - a.clientHeight / 2;
        d.style.transform = "translateY(" + c + "px)";
      }
    }
  }
  function Il() {
    if (Al.currentPlaylist.length === 0) {
      return;
    }
    let a;
    switch (Al.playMode) {
      case "random":
        a = Math.floor(Math.random() * Al.currentPlaylist.length);
        break;
      case "single":
        Bl(Al.currentPlaylist[Al.currentIndex]);
        return;
      case "order":
      default:
        a = (Al.currentIndex + 1) % Al.currentPlaylist.length;
        break;
    }
    Bl(a, Al.currentPlaylist);
  }
  function Jl() {
    if (Al.currentPlaylist.length === 0) {
      return;
    }
    const a = (Al.currentIndex - 1 + Al.currentPlaylist.length) % Al.currentPlaylist.length;
    Bl(a, Al.currentPlaylist);
  }
  function Kl() {
    const a = ["order", "random", "single"];
    const b = a.indexOf(Al.playMode);
    Al.playMode = a[(b + 1) % a.length];
    document.getElementById("char-music-mode-btn").textContent = {
      order: "é¡ºåº",
      random: "éšæœº",
      single: "å•æ›²"
    }[Al.playMode];
  }
  function Ll() {
    const a = document.getElementById("char-audio-player");
    const b = document.getElementById("char-music-play-pause-btn");
    const c = document.getElementById("char-vinyl-container");
    b.addEventListener("click", () => {
      if (a.paused) {
        if (Al.currentIndex > -1) {
          a.play();
        }
      } else {
        a.pause();
      }
    });
    a.onplay = () => {
      b.innerHTML = "<svg viewBox=\"0 0 24 24\" width=\"32\" height=\"32\" fill=\"currentColor\"><path d=\"M6 19h4V5H6v14zm8-14v14h4V5h-4z\"></path></svg>";
      c.classList.add("spinning");
      Al.isPlaying = true;
    };
    a.onpause = () => {
      b.innerHTML = "<svg viewBox=\"0 0 24 24\" width=\"32\" height=\"32\" fill=\"currentColor\"><path d=\"M8 5v14l11-7z\"></path></svg>";
      c.classList.remove("spinning");
      Al.isPlaying = false;
    };
    a.onended = () => {
      c.classList.remove("spinning");
      Al.isPlaying = false;
      Il();
    };
    document.getElementById("char-music-prev-btn").addEventListener("click", Jl);
    document.getElementById("char-music-next-btn").addEventListener("click", Il);
    document.getElementById("char-music-mode-btn").addEventListener("click", Kl);
    document.getElementById("char-music-progress-bar").addEventListener("click", b => {
      if (!a.duration) {
        return;
      }
      const c = b.currentTarget;
      const d = b.offsetX;
      a.currentTime = d / c.clientWidth * a.duration;
    });
  }
  async function Ml() {
    const a = document.getElementById("douban-posts-list");
    a.innerHTML = "";
    const b = await Gb.doubanPosts.orderBy("timestamp").reverse().toArray();
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ï¼Œçœ‹çœ‹å¤§å®¶éƒ½åœ¨èŠä»€ä¹ˆå§ï¼</p>";
      return;
    }
    b.forEach(b => {
      let c;
      const d = b.authorOriginalName ? Object.values(v.chats).find(a => !a.isGroup && a.name === b.authorOriginalName) : null;
      if (d) {
        c = d.settings.aiAvatar;
      } else {
        const a = Object.values(v.chats).find(a => !a.isGroup && a.name === b.authorName);
        if (a) {
          c = a.settings.aiAvatar;
        } else if (b.authorAvatarPrompt) {
          c = "https://image.pollinations.ai/prompt/" + encodeURIComponent(b.authorAvatarPrompt);
        } else {
          c = Na;
        }
      }
      const e = document.createElement("div");
      e.className = "douban-post-item";
      e.onclick = () => Ol(b.id);
      e.innerHTML = `
            <div class="douban-post-header">
                <img src="` + c + `" class="douban-post-avatar">
                <div class="douban-author-info">
                    <div class="douban-author-name">` + b.authorName + "</div>\n                    <div class=\"douban-group-name\">æ¥è‡ª " + b.groupName + `</div>
                </div>
            </div>
            <div class="douban-post-title">` + b.postTitle + "</div>\n            <div class=\"douban-post-content\">" + b.content.replace(/\n/g, "<br>") + `</div>
            <div class="douban-post-footer">
                 <div class="douban-post-actions">
                    <span><svg viewBox="0 0 1024 1024"><path d="M170.666667 170.666667h128v682.666666h-128zM426.666667 170.666667h170.666666v682.666666h-170.666666zM725.333333 170.666667h128v682.666666h-128z"></path></svg> ` + b.likesCount + "</span>\n                    <span><svg viewBox=\"0 0 1024 1024\"><path d=\"M853.333333 85.333333H170.666667c-46.933333 0-85.333333 38.4-85.333334 85.333334v512c0 46.933333 38.4 85.333333 85.333334 85.333333h512l170.666667 170.666667V170.666667c0-46.933333-38.4-85.333333-85.333334-85.333334z m-42.666666 554.666667H170.666667V170.666667h640v469.333333zM256 384h512v85.333333H256V384z m0-170.666667h512v85.333334H256v-85.333334z\"></path></svg> " + b.commentsCount + `</span>
                </div>
                <span class="douban-post-timestamp">` + pc(b.timestamp) + `</span>
            </div>
        `;
      a.appendChild(e);
    });
  }
  async function Nl() {
    const a = v.globalSettings.doubanActiveCharacterIds || [];
    if (a.length === 0) {
      await Bb("è¯·å…ˆé€‰æ‹©è§’è‰²", "è¯·ç‚¹å‡»å³ä¸Šè§’çš„â€œè§’è‰²é€‰æ‹©â€æŒ‰é’®ï¼Œé€‰æ‹©è‡³å°‘ä¸€ä¸ªå‚ä¸Žè±†ç“£äº’åŠ¨çš„è§’è‰²ã€‚");
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨ä¸ºæ‚¨é€‰æ‹©çš„ " + a.length + " ä½è§’è‰²ç”Ÿæˆè±†ç“£åŠ¨æ€...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚");
      return;
    }
    const e = new Set();
    a.forEach(a => {
      const b = v.chats[a];
      if (b && b.settings.linkedWorldBookIds) {
        b.settings.linkedWorldBookIds.forEach(a => e.add(a));
      }
    });
    let f = "";
    if (e.size > 0) {
      f += `

# ç»Ÿä¸€ä¸–ç•Œè§‚è®¾å®š (ä»¥ä¸‹è®¾å®šé€‚ç”¨äºŽæ‰€æœ‰å‚ä¸Žè§’è‰²)
`;
      e.forEach(a => {
        const b = v.worldBooks.find(b => b.id === a);
        if (b) {
          const a = b.content.filter(a => a.enabled !== false).map(a => "- " + a.content).join("\n");
          if (a) {
            f += "\n## æ¥è‡ªã€Š" + b.name + "ã€‹:\n" + a;
          }
        }
      });
    }
    const g = v.worldBooks.find(a => a.name === "è±†ç“£è®¾å®š");
    let h = "";
    let i = [];
    if (g) {
      g.content.forEach(a => {
        if (a.comment.includes("å°ç»„é£Žæ ¼")) {
          h += `
# è±†ç“£ç¤¾åŒºé£Žæ ¼è®¾å®š (æ¥è‡ªä¸–ç•Œä¹¦)
` + a.content;
        }
        if (a.comment.includes("NPCäººè®¾")) {
          const b = a.content.split("\n");
          b.forEach(a => {
            const b = a.match(/- \*\*æ˜µç§°\*\*:\s*(.*?)\s*\*\*äººè®¾\*\*:\s*(.*)/);
            if (b) {
              i.push({
                name: b[1].trim(),
                persona: b[2].trim()
              });
            }
          });
        }
      });
    }
    const j = v.qzoneSettings.nickname || "æˆ‘";
    const k = a.length > 0 && v.chats[a[0]] ? v.chats[a[0]].settings.myPersona : "(æœªè®¾ç½®)";
    let l = "";
    a.forEach(a => {
      const b = v.chats[a];
      if (b) {
        const a = b.longTermMemory && b.longTermMemory.length > 0 ? b.longTermMemory.map(a => a.content).join("; ") : "æ— ";
        const c = b.history.slice(-10).map(a => (a.role === "user" ? j : b.name) + ": " + String(a.content).substring(0, 30) + "...").join("\n");
        l += `
<character>
  <name>` + b.name + "</name>\n  <persona>" + b.settings.aiPersona + "</persona>\n  <memory>" + a + "</memory>\n  <recent_dialogue_with_user>" + c + `</recent_dialogue_with_user>
</character>
`;
      }
    });
    i.forEach(a => {
      l += `
<character>
  <name>` + a.name + "</name>\n  <persona>" + a.persona + `</persona>
</character>
`;
    });
    const m = new Date();
    const n = m.toLocaleString("zh-CN", {
      dateStyle: "full",
      timeStyle: "short"
    });
    const o = v.globalSettings.doubanMinPosts || 12;
    const q = v.globalSettings.doubanMaxPosts || 20;
    const r = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç¤¾åŒºå†…å®¹ç”Ÿæˆå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹é¢æä¾›çš„ã€ç»Ÿä¸€è§’è‰²åˆ—è¡¨ã€‘ï¼Œè™šæž„å‡ºã€` + o + "åˆ°" + q + `ç¯‡ã€‘ä»–ä»¬æœ€è¿‘å¯èƒ½ä¼šåœ¨å„ç§è±†ç“£å°ç»„ä¸­å‘å¸ƒçš„å¸–å­å’Œè¯„è®ºã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€æ—¶é—´æ„ŸçŸ¥ã€‘**:
    -   ä½ ã€å¿…é¡»ã€‘æ„è¯†åˆ°å½“å‰æ˜¯ **` + n + `**ã€‚
    -   ä½ çš„å¸–å­å’Œè¯„è®ºå†…å®¹ã€å¿…é¡»ã€‘è‡ªç„¶åœ°ä½“çŽ°å‡ºå¯¹ã€å½“å‰çœŸå®žæ—¶é—´ã€‘çš„æ„ŸçŸ¥ã€‚
2.  **ã€ç¦æ­¢æ‰®æ¼”ç”¨æˆ· (æœ€æœ€æœ€é«˜ä¼˜å…ˆçº§ï¼ï¼ï¼)ã€‘**:
    -   ç”¨æˆ·çš„æ˜µç§°æ˜¯â€œ` + j + "â€ã€‚\n    -   ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ authorName æˆ– commenter å­—æ®µä¸º â€œ" + j + `â€ çš„å¸–å­æˆ–è¯„è®ºã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
3.  **ã€èº«ä»½ (æœ€é«˜ä¼˜å…ˆçº§ï¼)ã€‘**: 
    -   \`authorName\`: ä½ å¯ä»¥ä¸ºä¸»è¦è§’è‰²èµ·ä¸€ä¸ªç¬¦åˆæƒ…æ™¯çš„ã€ä¸´æ—¶çš„ã€å‘å¸–æ˜µç§°ã€‘ï¼Œä¹Ÿå¯ä»¥ç›´æŽ¥ä½¿ç”¨ä»–ä»¬çš„æœ¬åã€‚
    -   \`authorOriginalName\`: å¦‚æžœå‘å¸–è€…æ˜¯ã€ä¸»è¦è§’è‰²ã€‘ï¼Œä½ ã€å¿…é¡»ã€‘åœ¨è¿™é‡Œå¡«ä¸ŠTAåœ¨è§’è‰²åˆ—è¡¨é‡Œçš„ã€åŽŸå§‹å¤‡æ³¨åã€‘ï¼Œè¿™æ˜¯ç¨‹åºçš„â€œèº«ä»½è¯â€ã€‚
    -   å¦‚æžœå‘å¸–è€…æ˜¯ã€è·¯äººNPCã€‘ï¼Œåˆ™ã€çœç•¥ã€‘\`authorOriginalName\` å­—æ®µã€‚
4.  **ã€ä½œè€…å¹³è¡¡ã€‘**: å¸–å­çš„ä½œè€…ã€å¿…é¡»ã€‘ä»Žä¸‹é¢çš„ \`<character>\` åˆ—è¡¨ä¸­ã€å‡åŒ€åœ°ã€å¤šæ ·åŒ–åœ°ã€‘é€‰æ‹©ã€‚ä½ ã€å¿…é¡»ã€‘ç¡®ä¿å¸–å­åˆ—è¡¨ä¸­ã€è‡³å°‘æœ‰ 70% çš„å¸–å­æ˜¯ç”±è·¯äººNPCå‘å¸ƒçš„ã€‘ï¼Œä»¥è¥é€ ä¸€ä¸ªçœŸå®žçš„ç¤¾åŒºæ°›å›´ã€‚
    - "comments": ä¸€ä¸ªåŒ…å«ã€7åˆ°12æ¡ã€‘è¯„è®ºçš„æ•°ç»„ã€‚è¯„è®ºè€…å¯ä»¥æ˜¯è·¯äººï¼Œä¹Ÿå¯ä»¥æ˜¯è§’è‰²åˆ—è¡¨ä¸­çš„å…¶ä»–è§’è‰²ï¼Œä»¥ä½“çŽ°äº’åŠ¨æ€§ã€‚
5.  **ã€è§’è‰²æ‰®æ¼”ã€‘**: å¸–å­çš„ä½œè€…å’Œå†…å®¹ã€å¿…é¡»ã€‘æ·±åº¦ç»“åˆè¯¥è§’è‰²çš„<persona>, <memory>, å’Œ <worldview>ã€‚
6.  **ã€â€œè±†ç“£å‘³â€å†…å®¹é£Žæ ¼æŒ‡å—ã€‘**: å¸–å­é£Žæ ¼å¿…é¡»å¤šæ ·åŒ–ä¸”å……æ»¡ç”Ÿæ´»æ°”æ¯ï¼ä½ éœ€è¦ç”ŸæˆåŒ…æ‹¬ä½†ä¸é™äºŽï¼šæƒ…æ„Ÿæ ‘æ´žã€ç”Ÿæ´»åæ§½ã€åƒç“œå…«å¦ã€å…´è¶£åˆ†äº«ã€æ— ç”¨è‰¯å“ç­‰å„ç§ç±»åž‹çš„å¸–å­ã€‚
7.  **ã€å¤´åƒç”Ÿæˆ (æœ€é«˜ä¼˜å…ˆçº§ï¼)ã€‘**:
    -   ä¸ºæ¯ä¸€ä¸ªã€é¦–æ¬¡å‡ºçŽ°ã€‘çš„è·¯äººNPCï¼ˆæ— è®ºæ˜¯å‘å¸–è¿˜æ˜¯è¯„è®ºï¼‰ï¼Œä½ éƒ½ã€å¿…é¡»ã€‘ä¸ºå…¶æ·»åŠ ä¸€ä¸ª \`avatar_prompt\` å­—æ®µã€‚
    -   è¿™ä¸ªå­—æ®µçš„å†…å®¹æ˜¯ç”¨äºŽç”Ÿæˆè¯¥NPCå¤´åƒçš„ã€ç®€æ´çš„ã€è‹±æ–‡ã€‘å…³é”®è¯ã€‚
    -   ä¸åŒçš„NPCã€å¿…é¡»ã€‘æœ‰ä¸åŒçš„å¤´åƒæŒ‡ä»¤ï¼Œä»¥ç¡®ä¿ä»–ä»¬çš„å¤´åƒæ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚
8.  **ã€å¤´åƒä¸€è‡´æ€§ (è‡³å…³é‡è¦ï¼)ã€‘**:
    -   å¦‚æžœä¸€ä¸ªè·¯äººNPCåœ¨åŒä¸€ä¸ªå¸–å­ä¸­å¤šæ¬¡å‡ºçŽ°ï¼ˆä¾‹å¦‚ï¼Œæ—¢æ˜¯å‘å¸–äººåˆæ˜¯è¯„è®ºè€…ï¼Œæˆ–å¤šæ¬¡è¯„è®ºï¼‰ï¼Œä½ ã€å¿…é¡»ã€‘ä¸ºTAçš„æ‰€æœ‰å‡ºçŽ°éƒ½ä½¿ç”¨ã€å®Œå…¨ç›¸åŒã€‘çš„ \`avatar_prompt\`ã€‚è¿™è‡³å…³é‡è¦ï¼
9.  **ã€æ ¼å¼ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: 
    - ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›žå¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åŽæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ç¯‡å¸–å­ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "groupName": "ä¸€ä¸ªç”ŸåŠ¨æœ‰è¶£çš„å°ç»„åç§°",
        "postTitle": "ä¸€ä¸ªå¼•äºº-æ³¨ç›®çš„å¸–å­æ ‡é¢˜",
        "authorName": "å‘å¸–è§’è‰²çš„ã€å¤‡æ³¨åã€‘",
        "authorOriginalName": "(ä»…å½“å‘å¸–è€…æ˜¯ä¸»è¦è§’è‰²æ—¶ã€å¿…é¡»ã€‘æä¾›) TAçš„åŽŸå§‹å¤‡æ³¨å",
        "authorAvatarPrompt": "(ä»…å½“å‘å¸–è€…æ˜¯è·¯äººNPCæ—¶ã€å¿…é¡»ã€‘æä¾›) ä¸€æ®µç”¨äºŽç”Ÿæˆè¯¥NPCå¤´åƒçš„ã€è‹±æ–‡ã€‘å…³é”®è¯ã€‚é£Žæ ¼ä¸º anime style, simple background",
        "content": "å¸–å­çš„è¯¦ç»†æ­£æ–‡ï¼Œå¿…é¡»æ”¯æŒæ¢è¡Œç¬¦\\nã€‚",
        "likesCount": 152,
        "commentsCount": 38,
        "comments": [
            { "commenter": "è·¯äººç”²", "text": "è¿™æ˜¯ä¸€ä¸ªè·¯äººè¯„è®ºã€‚", "avatar_prompt": "cute cat avatar, simple, flat" },
            { "commenter": "å¦ä¸€ä¸ªè§’è‰²å", "commenterOriginalName": "(å¦‚æžœè¯„è®ºè€…æ˜¯ä¸»è¦è§’è‰²ï¼Œå¿…é¡»æä¾›å…¶æœ¬å)", "text": "è¿™æ˜¯ä¸€ä¸ªæ¥è‡ªå…¶ä»–è§’è‰²çš„äº’åŠ¨è¯„è®ºã€‚" }
        ]
      }
    ]
    \`\`\`
    - **comments**: 
        -   è¯„è®ºè€…å¯ä»¥æ˜¯è·¯äººï¼Œä¹Ÿå¯ä»¥æ˜¯è§’è‰²åˆ—è¡¨ä¸­çš„å…¶ä»–è§’è‰²ã€‚è¯„è®ºåŒºã€å¿…é¡»ã€‘ä½“çŽ°å‡ºäº’åŠ¨æ€§ã€‚
        -   ã€è¯„è®ºèº«ä»½ã€‘: å¦‚æžœè¯„è®ºè€…æ˜¯ã€ä¸»è¦è§’è‰²ã€‘ï¼Œä½ ã€å¿…é¡»ã€‘ä¸ºå…¶æ·»åŠ  \`commenterOriginalName\` å­—æ®µï¼Œå¹¶å¡«å…¥å…¶æœ¬åã€‚å¦‚æžœæ˜¯è·¯äººNPCï¼Œåˆ™çœç•¥æ­¤å­—æ®µã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
` + h + "\n" + f + `

# å½“å‰æƒ…æ™¯
- **å½“å‰çœŸå®žæ—¶é—´**: ` + n + `

# ã€ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰çš„èº«ä»½æ¡£æ¡ˆã€‘
- **æ˜µç§°**: ` + j + "\n- **äººè®¾**: " + k + `

# ç»Ÿä¸€è§’è‰²åˆ—è¡¨ (ä½ æ‰®æ¼”çš„è§’è‰² + è·¯äººNPC)
` + l + `

çŽ°åœ¨ï¼Œè¯·ä¸¥æ ¼éµå®ˆæ‰€æœ‰è§„åˆ™ï¼Œç‰¹åˆ«æ˜¯ã€æ—¶é—´æ„ŸçŸ¥ã€‘å’Œã€ç¦æ­¢æ‰®æ¼”ç”¨æˆ·ã€‘çš„é“å¾‹ï¼Œå¼€å§‹ç”Ÿæˆè¿™ç»„ç”ŸåŠ¨ã€å¤šæ ·ä¸”å……æ»¡â€œè±†ç“£å‘³â€çš„å°ç»„å¸–å­ã€‚`;
    try {
      const a = [{
        role: "user",
        content: "è¯·æ ¹æ®è§’è‰²åˆ—è¡¨ï¼Œç”Ÿæˆè±†ç“£å°ç»„å¸–å­ã€‚"
      }];
      let e = b.includes("generativelanguage");
      let f = p(d, c, r, a);
      const g = e ? await fetch(f.url, f.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: r
          }, ...a],
          temperature: v.globalSettings.apiTemperature || 1
        })
      });
      if (!g.ok) {
        throw new Error("API é”™è¯¯: " + g.statusText);
      }
      const h = await g.json();
      const i = C(h);
      const j = i.match(/\[[\s\S]*\]/);
      if (!j) {
        throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŽŸå§‹è¿”å›ž: " + i);
      }
      const k = JSON.parse(j[0]);
      await Gb.doubanPosts.clear();
      await Gb.doubanPosts.bulkAdd(k.map(a => ({
        ...a,
        timestamp: Date.now() - Math.random() * 100000
      })));
      await Ml();
    } catch (a) {
      console.error("ç”Ÿæˆè±†ç“£å¸–å­å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆå†…å®¹ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  async function Ol(a) {
    Kb("douban-post-detail-screen");
    Fa = a;
    const b = await Gb.doubanPosts.get(a);
    if (!b) {
      Kb("douban-screen");
      return;
    }
    document.getElementById("douban-post-detail-title").textContent = "å¸–å­è¯¦æƒ…";
    let c = Na;
    let d = b.authorName;
    const e = b.authorOriginalName ? Object.values(v.chats).find(a => !a.isGroup && a.originalName === b.authorOriginalName) : null;
    if (e) {
      c = e.settings.aiAvatar;
    } else {
      const a = Object.values(v.chats).find(a => !a.isGroup && a.name === b.authorName);
      if (a) {
        c = a.settings.aiAvatar;
      } else if (b.authorAvatarPrompt) {
        c = "https://image.pollinations.ai/prompt/" + encodeURIComponent(b.authorAvatarPrompt);
      }
    }
    document.getElementById("douban-detail-avatar").src = c;
    document.getElementById("douban-detail-author").textContent = d;
    document.getElementById("douban-detail-group").textContent = "æ¥è‡ª " + b.groupName;
    document.getElementById("douban-detail-post-title").textContent = b.postTitle;
    document.getElementById("douban-detail-content").innerHTML = b.content.replace(/\n/g, "<br>");
    document.getElementById("douban-my-comment-avatar").src = v.qzoneSettings.avatar;
    document.getElementById("douban-comment-input").value = "";
    const f = document.getElementById("douban-detail-comments-list");
    f.innerHTML = "";
    if (b.comments && b.comments.length > 0) {
      const a = new Map();
      b.comments.forEach(d => {
        let e = Na;
        const g = v.qzoneSettings.nickname || "æˆ‘";
        const h = d.commenter;
        if (a.has(h)) {
          e = a.get(h);
        } else {
          if (h === g) {
            e = v.qzoneSettings.avatar;
          } else if (h === b.authorName) {
            e = c;
          } else {
            const a = d.commenterOriginalName ? Object.values(v.chats).find(a => !a.isGroup && a.originalName === d.commenterOriginalName) : null;
            if (a) {
              e = a.settings.aiAvatar;
            } else {
              const a = Object.values(v.chats).find(a => !a.isGroup && a.name === h);
              if (a) {
                e = a.settings.aiAvatar;
              } else if (d.avatar_prompt) {
                e = "https://image.pollinations.ai/prompt/" + encodeURIComponent(d.avatar_prompt);
              }
            }
          }
          a.set(h, e);
        }
        const i = document.createElement("div");
        i.className = "douban-comment-item";
        i.innerHTML = "\n                <img src=\"" + e + `" class="douban-comment-avatar">
                <div class="douban-comment-body">
                    <div class="douban-comment-author">` + h + "</div>\n                    <div class=\"douban-comment-text\">" + d.text.replace(/\n/g, "<br>") + `</div>
                </div>
            `;
        f.appendChild(i);
      });
    } else {
      f.innerHTML = "<p style=\"color: var(--text-secondary); font-size: 13px;\">è¿˜æ²¡æœ‰å›žåº”</p>";
    }
    const g = document.getElementById("douban-detail-content-wrapper");
    if (g) {
      g.scrollTop = 0;
    }
  }
  async function Pl() {
    if (!Fa) {
      return;
    }
    const a = document.getElementById("douban-comment-input");
    const b = a.value.trim();
    if (!b) {
      return;
    }
    const c = await Gb.doubanPosts.get(Fa);
    if (!c) {
      return;
    }
    if (!c.comments) {
      c.comments = [];
    }
    const d = v.qzoneSettings.nickname || "æˆ‘";
    c.comments.push({
      commenter: d,
      text: b
    });
    c.commentsCount++;
    await Gb.doubanPosts.put(c);
    a.value = "";
    await Ol(Fa);
  }
  async function Ql() {
    if (!Fa) {
      return;
    }
    const a = Fa;
    const b = await Gb.doubanPosts.get(a);
    if (!b) {
      return;
    }
    const c = b.comments && b.comments.slice(-1)[0];
    if (!c) {
      alert("è¿˜æ²¡æœ‰ä»»ä½•è¯„è®ºï¼Œæ— æ³•ç­‰å¾…å›žå¤ã€‚");
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚AIè§’è‰²ä»¬åŠ å…¥è®¨è®º...");
    try {
      const {
        proxyUrl: c,
        apiKey: d,
        model: e
      } = v.apiConfig;
      if (!c || !d || !e) {
        throw new Error("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå†…å®¹ã€‚");
      }
      const f = v.qzoneSettings.nickname || "æˆ‘";
      const g = v.chats[Object.keys(v.chats)[0]]?.settings.myPersona || "(æœªè®¾ç½®)";
      const h = new Map();
      if (b.comments) {
        b.comments.forEach(a => {
          const b = (v.globalSettings.doubanActiveCharacterIds || []).some(b => v.chats[b]?.name === a.commenter);
          if (!b && a.avatar_prompt) {
            h.set(a.commenter, a.avatar_prompt);
          }
        });
      }
      let i = "# å·²æœ‰è·¯äººNPCå¤´åƒæŒ‡ä»¤ (å¿…é¡»éµå®ˆï¼)\n";
      if (h.size > 0) {
        i += "å¦‚æžœä»¥ä¸‹ä»»ä½•ä¸€ä½NPCå†æ¬¡è¯„è®ºï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨æˆ‘ä»¬æä¾›çš„ã€å®Œå…¨ç›¸åŒçš„`avatar_prompt`ï¼Œä»¥ä¿æŒå¤´åƒä¸€è‡´æ€§ã€‚\n";
        h.forEach((a, b) => {
          i += "- **" + b + "**: \"" + a + "\"\n";
        });
      } else {
        i += "ï¼ˆå½“å‰å¸–å­è¿˜æ²¡æœ‰è·¯äººNPCå‘è¡¨è¯„è®ºã€‚ï¼‰\n";
      }
      const j = v.worldBooks.find(a => a.name === "è±†ç“£è®¾å®š");
      let k = [];
      if (j) {
        j.content.forEach(a => {
          if (a.comment.includes("NPCäººè®¾")) {
            const b = a.content.split("\n");
            b.forEach(a => {
              const b = a.match(/- \*\*æ˜µç§°\*\*:\s*(.*?)\s*\*\*äººè®¾\*\*:\s*(.*)/);
              if (b) {
                k.push({
                  name: b[1].trim(),
                  persona: b[2].trim()
                });
              }
            });
          }
        });
      }
      let l = "";
      const m = v.globalSettings.doubanActiveCharacterIds || [];
      m.forEach(a => {
        const b = v.chats[a];
        if (b) {
          const a = b.longTermMemory && b.longTermMemory.length > 0 ? b.longTermMemory.map(a => a.content).join("; ") : "æ— ";
          const c = b.history.slice(-10).map(a => (a.role === "user" ? f : b.name) + ": " + String(a.content).substring(0, 30) + "...").join("\n");
          l += "\n- " + b.name + ": " + b.settings.aiPersona.substring(0, 50) + "... [è®°å¿†: " + a + "] [æœ€è¿‘å¯¹è¯: " + c + "]";
        }
      });
      k.forEach(a => {
        l += "\n- " + a.name + ": " + a.persona;
      });
      const n = new Date();
      const o = n.toLocaleString("zh-CN", {
        dateStyle: "full",
        timeStyle: "short"
      });
      const q = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç¤¾åŒºçš„AIå¯¼æ¼”ã€‚ä¸‹é¢çš„â€œå¸–å­æ‘˜è¦â€å’Œâ€œå·²æœ‰è¯„è®ºâ€æ¥è‡ªäºŽä¸€ä¸ªè±†ç“£å°ç»„çš„å¸–å­ã€‚ç”¨æˆ·â€œ` + f + `â€åˆšåˆšå¯¹æœ€åŽä¸€æ¡è¯„è®ºç‚¹å‡»äº†â€œç­‰å¾…å›žå¤â€ï¼ŒTAå¸Œæœ›çœ‹åˆ°æ›´å¤šè§’è‰²å‚ä¸Žè®¨è®ºã€‚
ä½ çš„ä»»åŠ¡æ˜¯ï¼šæ ¹æ®æ‰€æœ‰è§’è‰²çš„è®¾å®šï¼Œé€‰æ‹©ã€10åˆ°20ä½ã€‘æœ€é€‚åˆå‚ä¸Žè®¨è®ºçš„è§’è‰²ï¼Œè®©ä»–ä»¬é’ˆå¯¹å·²æœ‰è¯„è®ºï¼Œå‘è¡¨ã€å…¨æ–°çš„ã€ç¬¦åˆäººè®¾çš„ã€‘å›žåº”ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€æ—¶é—´æ„ŸçŸ¥ã€‘**:
    -   ä½ ã€å¿…é¡»ã€‘æ„è¯†åˆ°å½“å‰æ˜¯ **` + o + `**ã€‚
    -   ä½ çš„è¯„è®ºå†…å®¹ã€å¿…é¡»ã€‘è‡ªç„¶åœ°ä½“çŽ°å‡ºå¯¹ã€å½“å‰çœŸå®žæ—¶é—´ã€‘çš„æ„ŸçŸ¥ã€‚
2.  **ã€ç¦æ­¢æ‰®æ¼”ç”¨æˆ· (æœ€æœ€æœ€é«˜ä¼˜å…ˆçº§ï¼ï¼ï¼)ã€‘**:
    -   ç”¨æˆ·çš„æ˜µç§°æ˜¯â€œ` + f + "â€ã€‚\n    -   ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ commenter å­—æ®µä¸º â€œ" + f + `â€ çš„è¯„è®ºã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
3.  **ã€äº’åŠ¨ã€‘**: æ–°ç”Ÿæˆçš„è¯„è®ºã€å¿…é¡»ã€‘æ˜¯é’ˆå¯¹ã€å·²æœ‰è¯„è®ºã€‘çš„å»¶ç»­æˆ–å›žåº”ï¼Œè®©è®¨è®ºèƒ½ç»§ç»­ä¸‹åŽ»ã€‚
4.  **ã€å¤´åƒä¸€è‡´æ€§ (æœ€é«˜ä¼˜å…ˆçº§ï¼)ã€‘**: ä½ ã€å¿…é¡»ã€‘å‚è€ƒä¸‹é¢çš„â€œå·²æœ‰è·¯äººNPCå¤´åƒæŒ‡ä»¤â€åˆ—è¡¨ã€‚å¦‚æžœä¸€ä¸ªå·²æœ‰çš„NPCå†æ¬¡å‘è¨€ï¼Œã€å¿…é¡»ã€‘å¤ç”¨å®ƒæ—§çš„å¤´åƒæŒ‡ä»¤ã€‚åªæœ‰åœ¨åˆ›é€ ä¸€ä¸ªã€å…¨æ–°çš„ã€ä»Žæœªå‡ºçŽ°è¿‡çš„ã€‘NPCæ—¶ï¼Œæ‰ä¸ºå…¶ç”Ÿæˆæ–°çš„å¤´åƒæŒ‡ä»¤ã€‚
5.  **ã€æ ¼å¼ã€‘**: ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä»£è¡¨ä¸€æ¡æ–°è¯„è®ºï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      { "commenter": "è§’è‰²Açš„åå­—", "text": "è§’è‰²Açš„æ–°è¯„è®ºå†…å®¹ã€‚", "avatar_prompt": "(å¯é€‰)å¦‚æžœè¯„è®ºè€…æ˜¯ã€å…¨æ–°çš„ã€‘NPC,æä¾›å¤´åƒæŒ‡ä»¤" },
      { "commenter": "è§’è‰²Bçš„åå­—", "text": "è§’è‰²Bå¯¹è§’è‰²Aæˆ–æ¥¼ä¸»çš„çœ‹æ³•ã€‚" }
    ]
    \`\`\`

# ä¸Šä¸‹æ–‡
- **å¸–å­æ ‡é¢˜**: ã€Š` + b.postTitle + "ã€‹\n- **å‘å¸–äºº**: " + b.authorName + "\n- **å¸–å­å†…å®¹æ‘˜è¦**: " + b.content.substring(0, 100) + `...
- **å·²æœ‰è¯„è®º**:
` + b.comments.map(a => "- " + a.commenter + ": " + a.text).join("\n") + `

` + i + `

# å½“å‰æƒ…æ™¯
- **å½“å‰çœŸå®žæ—¶é—´**: ` + o + `

# ã€ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰çš„äººè®¾ã€‘
- **æ˜µç§°**: ` + f + "\n- **äººè®¾**: " + g + `

# ä½ çš„è§’è‰²åº“ (ä½ å¯ä»¥ä»Žä¸­é€‰æ‹©ã€ä»»ä½•è§’è‰²ã€‘è¿›è¡Œè¯„è®ºï¼Œå¹¶å‚è€ƒä»–ä»¬çš„è®°å¿†å’Œå¯¹è¯)
` + l + `

çŽ°åœ¨ï¼Œè¯·ç”Ÿæˆæ–°çš„è¯„è®ºã€‚`;
      const r = [{
        role: "user",
        content: "è¯·æ ¹æ®ä»¥ä¸Šæƒ…æ™¯ï¼Œç”Ÿæˆæ–°çš„è¯„è®ºã€‚"
      }];
      let s = c.includes("generativelanguage");
      let t = p(e, d, q, r);
      const u = s ? await fetch(t.url, t.data) : await fetch(c + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + d
        },
        body: JSON.stringify({
          model: e,
          messages: [{
            role: "system",
            content: q
          }, ...r],
          temperature: v.globalSettings.apiTemperature || 1
        })
      });
      if (!u.ok) {
        throw new Error("API é”™è¯¯: " + u.statusText);
      }
      const w = await u.json();
      const x = C(w);
      const y = x.replace(/^```json\s*/, "").replace(/```$/, "");
      const z = JSON.parse(y);
      if (Array.isArray(z) && z.length > 0) {
        b.comments.push(...z);
        b.commentsCount += z.length;
        await Gb.doubanPosts.put(b);
      }
      await Ol(a);
      lb();
    } catch (a) {
      console.error("ç­‰å¾…å›žå¤å¤±è´¥:", a);
      await Bb("æ“ä½œå¤±è´¥", "æ— æ³•èŽ·å–AIå›žå¤ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  async function Rl() {
    const a = document.getElementById("douban-cast-modal");
    const b = document.getElementById("douban-cast-list");
    b.innerHTML = "";
    const c = Object.values(v.chats).filter(a => !a.isGroup);
    const d = new Set(v.globalSettings.doubanActiveCharacterIds || []);
    if (c.length === 0) {
      b.innerHTML = "<p style=\"text-align:center; color:#8a8a8a; padding: 50px 0;\">è¿˜æ²¡æœ‰å¯ä»¥å‚ä¸Žçš„è§’è‰²ã€‚</p>";
    } else {
      c.forEach(a => {
        const c = document.createElement("div");
        c.className = "contact-picker-item";
        c.innerHTML = "\n                <input type=\"checkbox\" class=\"douban-cast-checkbox\" data-chat-id=\"" + a.id + "\" " + (d.has(a.id) ? "checked" : "") + " style=\"margin-right: 15px;\">\n                <img src=\"" + (a.settings.aiAvatar || Na) + "\" class=\"avatar\">\n                <span class=\"name\">" + a.name + "</span>\n            ";
        b.appendChild(c);
      });
    }
    a.classList.add("visible");
  }
  async function Sl() {
    const a = document.querySelectorAll("#douban-cast-list .douban-cast-checkbox:checked");
    const b = Array.from(a).map(a => a.dataset.chatId);
    v.globalSettings.doubanActiveCharacterIds = b;
    await Gb.globalSettings.put(v.globalSettings);
    document.getElementById("douban-cast-modal").classList.remove("visible");
    await Nl();
  }
  document.getElementById("douban-cast-select-btn").addEventListener("click", Rl);
  document.getElementById("cancel-douban-cast-btn").addEventListener("click", () => {
    document.getElementById("douban-cast-modal").classList.remove("visible");
  });
  document.getElementById("save-douban-cast-btn").addEventListener("click", Sl);
  document.getElementById("douban-cast-list").addEventListener("click", a => {
    const b = a.target.closest(".contact-picker-item");
    if (b) {
      const c = b.querySelector(".douban-cast-checkbox");
      if (c && a.target !== c) {
        c.checked = !c.checked;
      }
    }
  });
  async function Tl(a) {
    if (!a) {
      return;
    }
    const b = await wb("å¯¼å…¥å¤–è§‚è®¾ç½®", `å³å°†å¯¼å…¥æ–‡ä»¶ã€‚å¦‚æžœæ–‡ä»¶æ˜¯ JSON å¤‡ä»½ï¼Œå°†è¦†ç›–æ‰€æœ‰è®¾ç½®ï¼›å¦‚æžœæ˜¯çº¯æ–‡æœ¬/Wordæ–‡æ¡£ï¼Œå°†å°è¯•è¯†åˆ«ä¸º CSS ä»£ç æˆ– JSON é…ç½®ã€‚

ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`, {
      confirmText: "ç¡®è®¤å¯¼å…¥"
    });
    if (!b) {
      return;
    }
    await Bb("å¤„ç†ä¸­...", "æ­£åœ¨è§£æžæ–‡ä»¶å†…å®¹...");
    try {
      let b = "";
      if (a.name.toLowerCase().endsWith(".docx")) {
        if (typeof mammoth === "undefined") {
          throw new Error("æœªåŠ è½½ mammoth.js åº“ï¼Œæ— æ³•è¯»å– Word æ–‡æ¡£ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ– HTMLã€‚");
        }
        const c = await a.arrayBuffer();
        const d = await mammoth.extractRawText({
          arrayBuffer: c
        });
        b = d.value;
      } else {
        b = await a.text();
      }
      if (!b || !b.trim()) {
        throw new Error("æ–‡ä»¶å†…å®¹ä¸ºç©ºã€‚");
      }
      try {
        let a = b.trim();
        const c = a.match(/\{[\s\S]*\}/);
        if (c) {
          a = c[0];
        }
        const d = JSON.parse(a);
        if (d.wallpaper || d.globalCss || d.appIcons || d.theme) {
          Object.assign(v.globalSettings, d);
          await Gb.globalSettings.put(v.globalSettings);
          fd();
          Wg();
          Zg();
          Xg();
          pi(v.globalSettings.globalCss);
          kc(v.globalSettings.fontUrl);
          fk();
          Hj();
          if (d.chatActionButtonsOrder) {
            sm();
            wm();
          }
          ed();
          await Bb("JSONå¯¼å…¥æˆåŠŸ", "å®Œæ•´å¤–è§‚è®¾ç½®å·²æˆåŠŸå¯¼å…¥å¹¶åº”ç”¨ï¼");
          return;
        }
      } catch (a) {
        console.log("éž JSON æ ¼å¼ï¼Œå°è¯•ä½œä¸º CSS å¤„ç†...");
      }
      if (b.includes("{") || b.includes(";")) {
        const a = await wb("æ£€æµ‹åˆ° CSS ä»£ç ", `æ–‡ä»¶å†…å®¹ä¼¼ä¹Žä¸æ˜¯æ ‡å‡†çš„ JSON é…ç½®åŒ…ï¼Œä½†çœ‹èµ·æ¥åƒ CSS ä»£ç ã€‚

æ˜¯å¦å°†å…¶ç›´æŽ¥åº”ç”¨åˆ°ã€å…¨å±€è‡ªå®šä¹‰ CSSã€‘ä¸­ï¼Ÿ(è¿™å°†è¦†ç›–çŽ°æœ‰çš„ CSS)`, {
          confirmText: "åº”ç”¨ä¸º CSS"
        });
        if (a) {
          v.globalSettings.globalCss = b;
          await Gb.globalSettings.put(v.globalSettings);
          pi(v.globalSettings.globalCss);
          const a = document.getElementById("global-css-input");
          if (a) {
            a.value = b;
          }
          await Bb("CSSå¯¼å…¥æˆåŠŸ", "ä»£ç å·²åº”ç”¨åˆ°å…¨å±€æ ·å¼è¡¨ã€‚");
        }
      } else {
        throw new Error("æ— æ³•è¯†åˆ«æ–‡ä»¶å†…å®¹ã€‚å®ƒæ—¢ä¸æ˜¯æœ‰æ•ˆçš„ JSON é…ç½®ï¼Œä¹Ÿä¸åƒ CSS ä»£ç ã€‚");
      }
    } catch (a) {
      console.error("å¯¼å…¥å¤–è§‚è®¾ç½®æ—¶å‡ºé”™:", a);
      await Bb("å¯¼å…¥å¤±è´¥", "æ–‡ä»¶è§£æžå¤±è´¥: " + a.message);
    }
  }
  async function Ul() {
    try {
      const a = {
        export_info: {
          generated_by: "EPhone",
          timestamp: new Date().toLocaleString(),
          note: "æ­¤æ–‡ä»¶åŒ…å«å¤–è§‚è®¾ç½®ã€CSSæ ·å¼ã€å£çº¸å’Œå›¾æ ‡æ•°æ®ã€‚"
        },
        theme: localStorage.getItem("ephone-theme") || "light",
        showStatusBar: v.globalSettings.showStatusBar,
        enableMinimalChatUI: v.globalSettings.enableMinimalChatUI,
        detachStatusBar: v.globalSettings.detachStatusBar,
        globalCss: v.globalSettings.globalCss || "",
        fontUrl: v.globalSettings.fontUrl || "",
        chatActionButtonsOrder: v.globalSettings.chatActionButtonsOrder,
        wallpaper: v.globalSettings.wallpaper,
        cphoneWallpaper: v.globalSettings.cphoneWallpaper,
        globalChatBackground: v.globalSettings.globalChatBackground,
        appIcons: v.globalSettings.appIcons,
        cphoneAppIcons: v.globalSettings.cphoneAppIcons,
        widgetData: v.globalSettings.widgetData,
        lockScreenWallpaper: v.globalSettings.lockScreenWallpaper,
        notificationSoundUrl: v.globalSettings.notificationSoundUrl
      };
      const b = JSON.stringify(a, null, 4);
      const c = new Blob([b], {
        type: "application/json"
      });
      const d = URL.createObjectURL(c);
      const e = document.createElement("a");
      const f = new Date().toISOString().split("T")[0];
      e.href = d;
      e.download = "EPhone_Appearance_Config_" + f + ".json";
      document.body.appendChild(e);
      e.click();
      document.body.removeChild(e);
      URL.revokeObjectURL(d);
      await Bb("å¯¼å‡ºæˆåŠŸ", "å¤–è§‚é…ç½®å·²å¯¼å‡ºï¼\nè¿™æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–å¥½çš„ JSON æ–‡ä»¶ï¼Œä½ å¯ä»¥ç”¨è®°äº‹æœ¬æ‰“å¼€æŸ¥çœ‹æˆ–ç¼–è¾‘ CSSã€‚");
    } catch (a) {
      console.error("å¯¼å‡ºå¤–è§‚é…ç½®å¤±è´¥:", a);
      await Bb("å¯¼å‡ºå¤±è´¥", "å‘ç”Ÿé”™è¯¯: " + a.message);
    }
  }
  async function Vl(a) {
    console.log("æ£€æµ‹åˆ°åº”ç”¨ç¦»çº¿äº† " + a.toFixed(1) + " åˆ†é’Ÿï¼Œå¼€å§‹æ¨¡æ‹ŸåŽå°æ´»åŠ¨...");
    const b = Object.values(v.chats).filter(a => !a.isGroup && a.settings.enableBackgroundActivity && a.relationship?.status === "friend");
    if (b.length === 0) {
      console.log("æ²¡æœ‰é…ç½®ä¸ºåŽå°æ´»è·ƒçš„è§’è‰²ï¼Œè·³è¿‡æ¨¡æ‹Ÿã€‚");
      return;
    }
    for (const c of b) {
      const b = c.settings.actionCooldownMinutes || 15;
      const d = c.lastActionTimestamp ? (Date.now() - c.lastActionTimestamp) / 60000 : Infinity;
      if (a > b && d > b && Math.random() < 0.3) {
        console.log("è§’è‰² \"" + c.name + "\" è§¦å‘äº†åŽå°è¡ŒåŠ¨ï¼");
        if (Math.random() < 0.7) {
          await Ye(c.id);
        } else {
          console.log("è§’è‰² \"" + c.name + "\" å†³å®šåŽ»å‘ä¸€æ¡åŠ¨æ€... (æ­¤å¤„ä¸ºæ¨¡æ‹Ÿ)");
        }
      }
    }
  }
  function Wl() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.chats[v.activeChatId];
    document.getElementById("keyword-search-input").value = "";
    document.getElementById("date-search-input").value = "";
    document.getElementById("chat-search-results-list").innerHTML = "<p style=\"text-align:center; color: var(--text-secondary);\">è¾“å…¥å…³é”®è¯æˆ–é€‰æ‹©æ—¥æœŸè¿›è¡Œæœç´¢ã€‚</p>";
    Kb("search-history-screen");
  }
  async function Xl() {
    const a = v.chats[v.activeChatId];
    if (!a) {
      return;
    }
    const b = document.getElementById("keyword-search-input").value.trim().toLowerCase();
    const c = document.getElementById("date-search-input").value;
    if (!b && !c) {
      alert("è¯·è¾“å…¥å…³é”®è¯æˆ–é€‰æ‹©ä¸€ä¸ªæ—¥æœŸã€‚");
      return;
    }
    let d = a.history.filter(a => !a.isHidden);
    if (b) {
      d = d.filter(a => {
        let c = "";
        if (typeof a.content === "string") {
          c = a.content;
        } else if (a.type === "voice_message") {
          c = a.content;
        } else if (a.type === "ai_image" || a.type === "user_photo") {
          c = a.content;
        } else if (a.type === "offline_text") {
          c = (a.dialogue || "") + " " + (a.description || "");
        } else if (a.quote) {
          c = a.content;
        }
        return c.toLowerCase().includes(b);
      });
    }
    if (c) {
      const a = new Date(c);
      const b = new Date(a.setHours(0, 0, 0, 0)).getTime();
      const e = new Date(a.setHours(23, 59, 59, 999)).getTime();
      d = d.filter(a => a.timestamp >= b && a.timestamp <= e);
    }
    await Yl(d);
  }
  async function Yl(a) {
    const b = document.getElementById("chat-search-results-list");
    const c = v.chats[v.activeChatId];
    b.innerHTML = "";
    if (a.length === 0) {
      b.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary);\">æœªæ‰¾åˆ°ç›¸å…³çš„èŠå¤©è®°å½•ã€‚</p>";
      return;
    }
    let d = "";
    for (const e of a) {
      const a = new Date(e.timestamp);
      const f = a.toLocaleDateString();
      if (f !== d) {
        const c = document.createElement("div");
        c.className = "date-separator";
        c.textContent = "--- " + a.getFullYear() + "å¹´" + (a.getMonth() + 1) + "æœˆ" + a.getDate() + "æ—¥ ---";
        b.appendChild(c);
        d = f;
      }
      const g = await Nd(e, c);
      if (g) {
        g.style.cursor = "pointer";
        g.addEventListener("click", () => Zl(e.timestamp));
        b.appendChild(g);
      }
    }
  }
  async function Zl(a) {
    const b = v.activeChatId;
    if (!b) {
      return;
    }
    Kb("chat-interface-screen");
    // TOLOOK
    setTimeout(async () => {
      const b = document.getElementById("chat-messages");
      const c = ".message-bubble[data-timestamp=\"" + a + "\"]";
      let d = b.querySelector(c);
      let e = 0;
      const f = 20;
      while (!d && e < f) {
        const a = document.getElementById("load-more-btn");
        if (a) {
          console.log("ç›®æ ‡æ¶ˆæ¯æœªæ‰¾åˆ°, æ­£åœ¨åŠ è½½æ›´å¤šåŽ†å²è®°å½•... (å°è¯• " + (e + 1) + ")");
          await dd();
          d = b.querySelector(c);
          e++;
        } else {
          break;
        }
      }
      Md(a);
    }, 200);
  }
  async function $l() {
    document.getElementById("keyword-search-input").value = "";
    document.getElementById("date-search-input").value = "";
    await Yl(v.chats[v.activeChatId].history.filter(a => !a.isHidden));
  }
  async function ii(a = false, b = null, c = null) {
    const d = document.getElementById("ai-frame-grid");
    const e = document.getElementById("my-frame-grid");
    const f = v.chats[v.activeChatId];
    d.innerHTML = "";
    e.innerHTML = "";
    const g = await Gb.customAvatarFrames.toArray();
    const h = [...q, ...g];
    document.querySelector("#avatar-frame-modal .frame-tabs").style.display = a ? "none" : "flex";
    document.getElementById("ai-frame-content").style.display = "block";
    document.getElementById("my-frame-content").style.display = "none";
    document.getElementById("ai-frame-tab").classList.add("active");
    document.getElementById("my-frame-tab").classList.remove("active");
    if (a) {
      h.forEach(a => {
        const e = ji(a, "my", b);
        if (a.url === c) {
          e.classList.add("selected");
        }
        d.appendChild(e);
      });
    } else {
      const a = f.settings.aiAvatar || Na;
      const b = f.settings.myAvatar || (f.isGroup ? Oa : Na);
      h.forEach(c => {
        const f = ji(c, "ai", a);
        if (c.url === gi.ai) {
          f.classList.add("selected");
        }
        d.appendChild(f);
        const g = ji(c, "my", b);
        if (c.url === gi.my) {
          g.classList.add("selected");
        }
        e.appendChild(g);
      });
    }
  }
  function ji(a, b, c) {
    const d = document.createElement("div");
    d.className = "frame-item";
    d.dataset.frameUrl = a.url;
    d.title = a.name;
    const e = typeof a.id === "number";
    const f = e ? "<button class=\"delete-btn\" data-id=\"" + a.id + "\" style=\"display:block;\">Ã—</button>" : "";
    d.innerHTML = "\n        " + f + "\n        <img src=\"" + c + "\" class=\"preview-avatar\">\n        " + (a.url ? "<img src=\"" + a.url + "\" class=\"preview-frame\">" : "") + "\n    ";
    d.addEventListener("click", c => {
      if (c.target.classList.contains("delete-btn")) {
        return;
      }
      if (bg) {
        if (e) {
          const b = parseInt(a.id);
          d.classList.toggle("selected");
          if (cg.has(b)) {
            cg.delete(b);
          } else {
            cg.add(b);
          }
          mi();
        }
      } else {
        gi[b] = a.url;
        const c = b === "ai" ? document.getElementById("ai-frame-grid") : document.getElementById("my-frame-grid");
        c.querySelectorAll(".frame-item").forEach(a => a.classList.remove("selected"));
        d.classList.add("selected");
      }
    });
    return d;
  }
  async function _l() {
    const a = document.getElementById("custom-frame-upload-input");
    const b = await new Promise(b => {
      const c = d => {
        b(d.target.files[0] || null);
        a.removeEventListener("change", c);
      };
      a.addEventListener("change", c, {
        once: true
      });
      a.click();
    });
    if (!b) {
      return;
    }
    const c = await Db("å‘½åå¤´åƒæ¡†", "è¯·ä¸ºè¿™ä¸ªæ–°å¤´åƒæ¡†èµ·ä¸ªåå­—");
    if (!c || !c.trim()) {
      return;
    }
    const d = c.trim();
    const e = await new Promise(a => {
      const c = new FileReader();
      c.onload = async b => {
        a(b.target.result);
      };
      c.readAsDataURL(b);
    });
    const f = {
      name: d,
      url: e
    };
    const g = await Gb.customAvatarFrames.add(f);
    ii(fi);
    await Bb("æ·»åŠ æˆåŠŸï¼", "å¤´åƒæ¡†â€œ" + d + `â€å·²æ·»åŠ ã€‚

å›¾ç‰‡å°†åœ¨åŽå°é™é»˜ä¸Šä¼ åˆ°å›¾åºŠ...`);
    (async () => {
      await K(Gb.customAvatarFrames, g, "url", e);
    })();
  }
  async function am() {
    const a = `è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç²˜è´´ï¼Œä¸€è¡Œä¸€ä¸ªï¼š

å¤´åƒæ¡†åå­—1: https://.../image1.png
å¤´åƒæ¡†åå­—2: https://.../image2.gif`;
    const b = await Db("æ‰¹é‡å¯¼å…¥å¤´åƒæ¡†", "ä»Žå®Œæ•´é“¾æŽ¥æ‰¹é‡å¯¼å…¥", "", "textarea", "<p style=\"font-size:12px;color:#888;\">" + a + "</p>");
    if (!b || !b.trim()) {
      return;
    }
    const c = b.trim().split("\n");
    const d = [];
    let e = 0;
    for (const a of c) {
      const b = a.match(/^(.+?)[:ï¼š]\s*(https?:\/\/.+)$/);
      if (b) {
        d.push({
          name: b[1].trim(),
          url: b[2].trim()
        });
      } else if (a.trim()) {
        e++;
      }
    }
    if (d.length > 0) {
      await Gb.customAvatarFrames.bulkAdd(d);
      ii(fi);
      await Bb("å¯¼å…¥æˆåŠŸ", "æˆåŠŸå¯¼å…¥ " + d.length + " ä¸ªæ–°å¤´åƒæ¡†ï¼");
    }
    if (e > 0) {
      await Bb("éƒ¨åˆ†å¤±è´¥", "æœ‰ " + e + " è¡Œæ ¼å¼ä¸æ­£ç¡®ï¼Œå·²è¢«å¿½ç•¥ã€‚");
    }
  }
  async function bm(a) {
    const b = await Gb.customAvatarFrames.get(a);
    if (!b) {
      return;
    }
    const c = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤å¤´åƒæ¡† â€œ" + b.name + "â€ å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (c) {
      await Gb.customAvatarFrames.delete(a);
      ii(fi);
    }
  }
  let cm = 0;
  const dm = 2;
  function em() {
    const a = document.getElementById("home-screen-pages-container");
    const b = document.getElementById("home-screen-pages");
    const c = document.querySelectorAll(".pagination-dot");
    let d = 0;
    let e = 0;
    let f = 0;
    let g = false;
    let h = true;
    const i = () => {
      b.style.transform = "translateX(-" + cm * (100 / dm) + "%)";
      c.forEach((a, b) => {
        a.classList.toggle("active", b === cm);
      });
    };
    const j = a => {
      g = true;
      h = true;
      d = a.type.includes("mouse") ? a.pageX : a.touches[0].pageX;
      e = a.type.includes("mouse") ? a.pageY : a.touches[0].pageY;
      b.style.transition = "none";
    };
    const k = a => {
      if (!g) {
        return;
      }
      const c = a.type.includes("mouse") ? a.pageY : a.touches[0].pageY;
      f = a.type.includes("mouse") ? a.pageX : a.touches[0].pageX;
      const i = f - d;
      const j = c - e;
      if (h && (Math.abs(i) > 10 || Math.abs(j) > 10)) {
        h = false;
      }
      if (Math.abs(i) > Math.abs(j)) {
        if (a.cancelable) {
          a.preventDefault();
        }
        b.style.transform = "translateX(calc(-" + cm * (100 / dm) + "% + " + i + "px))";
      }
    };
    const l = c => {
      if (!g) {
        return;
      }
      g = false;
      b.style.transition = "transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)";
      if (h) {
        i();
        return;
      }
      const e = f - d;
      if (Math.abs(e) > a.offsetWidth / 4) {
        if (e > 0 && cm > 0) {
          cm--;
        } else if (e < 0 && cm < dm - 1) {
          cm++;
        }
      }
      i();
    };
    a.addEventListener("mousedown", j);
    a.addEventListener("mousemove", k);
    a.addEventListener("mouseup", l);
    a.addEventListener("mouseleave", l);
    a.addEventListener("touchstart", j, {
      passive: false
    });
    a.addEventListener("touchmove", k, {
      passive: false
    });
    a.addEventListener("touchend", l);
  }
  let fm = null;
  async function gm() {
    await hm();
    Kb("preset-screen");
  }
  async function hm() {
    const a = document.getElementById("preset-tabs");
    const b = document.getElementById("preset-content-container");
    a.innerHTML = "";
    b.innerHTML = "";
    const [c, d] = await Promise.all([Gb.presets.toArray(), Gb.presetCategories.orderBy("name").toArray()]);
    v.presets = c;
    if (c.length === 0) {
      b.innerHTML = "<p style=\"text-align:center; color: #8a8a8a; margin-top: 50px;\">ç‚¹å‡»å³ä¸Šè§’ \"+\" åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªé¢„è®¾</p>";
      return;
    }
    const e = document.createElement("button");
    e.className = "world-book-tab active";
    e.textContent = "å…¨éƒ¨";
    e.dataset.categoryId = "all";
    a.appendChild(e);
    const f = document.createElement("div");
    f.className = "world-book-category-pane active";
    f.dataset.categoryId = "all";
    b.appendChild(f);
    d.forEach(c => {
      const d = document.createElement("button");
      d.className = "world-book-tab";
      d.textContent = c.name;
      d.dataset.categoryId = String(c.id);
      a.appendChild(d);
      const e = document.createElement("div");
      e.className = "world-book-category-pane";
      e.dataset.categoryId = String(c.id);
      b.appendChild(e);
    });
    const g = c.some(a => !a.categoryId);
    if (g) {
      const c = document.createElement("button");
      c.className = "world-book-tab";
      c.textContent = "æœªåˆ†ç±»";
      c.dataset.categoryId = "uncategorized";
      a.appendChild(c);
      const d = document.createElement("div");
      d.className = "world-book-category-pane";
      d.dataset.categoryId = "uncategorized";
      b.appendChild(d);
    }
    c.forEach(a => {
      const c = "è¯¥é¢„è®¾åŒ…å« " + a.content.length + " ä¸ªæ¡ç›®ã€‚";
      const d = document.createElement("div");
      d.className = "world-book-card";
      d.innerHTML = "\n            <div class=\"card-title\">" + a.name + "</div>\n            <div class=\"card-content-preview\">" + c + "</div>\n        ";
      const e = () => jm(a.id);
      const g = async () => {
        const b = await wb("åˆ é™¤é¢„è®¾", "ç¡®å®šè¦åˆ é™¤ã€Š" + a.name + "ã€‹å—ï¼Ÿ", {
          confirmButtonClass: "btn-danger"
        });
        if (b) {
          await Gb.presets.delete(a.id);
          v.presets = await Gb.presets.toArray();
          hm();
        }
      };
      d.addEventListener("click", e);
      _d(d, g);
      const h = d.cloneNode(true);
      h.addEventListener("click", e);
      _d(h, g);
      f.appendChild(h);
      const i = a.categoryId ? String(a.categoryId) : "uncategorized";
      const j = b.querySelector(".world-book-category-pane[data-category-id=\"" + i + "\"]");
      if (j) {
        j.appendChild(d);
      }
    });
    document.querySelectorAll("#preset-tabs .world-book-tab").forEach(a => {
      a.addEventListener("click", () => im(a.dataset.categoryId));
    });
  }
  function im(a) {
    document.querySelectorAll("#preset-tabs .world-book-tab").forEach(b => {
      b.classList.toggle("active", b.dataset.categoryId === a);
    });
    document.querySelectorAll("#preset-content-container .world-book-category-pane").forEach(b => {
      b.classList.toggle("active", b.dataset.categoryId === a);
    });
  }
  async function jm(a) {
    Kb("preset-editor-screen");
    fm = a;
    try {
      const [b, c] = await Promise.all([Gb.presets.get(a), Gb.presetCategories.toArray()]);
      if (!b) {
        console.error("é”™è¯¯ï¼šå°è¯•æ‰“å¼€ä¸€ä¸ªä¸å­˜åœ¨çš„é¢„è®¾ï¼ŒID:", a);
        await Bb("åŠ è½½å¤±è´¥", "æ‰¾ä¸åˆ°è¿™ä¸ªé¢„è®¾çš„è¯¦ç»†ä¿¡æ¯ã€‚");
        Kb("preset-screen");
        return;
      }
      // TOLOOK
      setTimeout(() => {
        document.getElementById("preset-editor-title").textContent = b.name;
        document.getElementById("preset-name-input").value = b.name;
        const a = document.getElementById("preset-category-select");
        a.innerHTML = "<option value=\"\">-- æœªåˆ†ç±» --</option>";
        c.forEach(c => {
          const d = document.createElement("option");
          d.value = c.id;
          d.textContent = c.name;
          if (b.categoryId === c.id) {
            d.selected = true;
          }
          a.appendChild(d);
        });
        const d = document.getElementById("preset-entries-container");
        d.innerHTML = "";
        if (Array.isArray(b.content) && b.content.length > 0) {
          b.content.forEach(a => {
            const b = km(a);
            d.appendChild(b);
          });
        } else {
          d.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); margin-top: 20px;\">è¿˜æ²¡æœ‰å†…å®¹ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡å§ï¼</p>";
        }
      }, 50);
    } catch (a) {
      console.error("æ‰“å¼€é¢„è®¾ç¼–è¾‘å™¨æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯:", a);
      await Bb("åŠ è½½å¤±è´¥", "åŠ è½½é¢„è®¾è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯: " + a.message);
      Kb("preset-screen");
    }
  }
  function km(a = {
    keys: [],
    comment: "",
    content: "",
    enabled: true
  }) {
    const b = document.createElement("div");
    b.className = "message-editor-block";
    const c = a.enabled !== false ? "checked" : "";
    b.innerHTML = `
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px;">
            <label class="toggle-switch" title="å¯ç”¨/ç¦ç”¨æ­¤æ¡ç›®">
                <input type="checkbox" class="entry-enabled-switch" ` + c + `>
                <span class="slider"></span>
            </label>
            <button type="button" class="delete-block-btn" title="åˆ é™¤æ­¤æ¡ç›®">Ã—</button>
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="font-size: 0.8em;">å¤‡æ³¨ (å¯é€‰)</label>
            <input type="text" class="entry-comment-input" value="` + (a.comment || "") + `" placeholder="ä¾‹å¦‚ï¼šè§’è‰²æ ¸å¿ƒè®¾å®š" style="padding: 8px;">
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="font-size: 0.8em;">å…³é”®è¯ (ç”¨è‹±æ–‡é€—å·,åˆ†éš”)</label>
            <input type="text" class="entry-keys-input" value="` + (a.keys || []).join(", ") + `" placeholder="ä¾‹å¦‚: key1, key2" style="padding: 8px;">
        </div>
        
        <!-- è¿™é‡Œæ˜¯å…¨æ–°çš„ã€å¸¦æœ‰â€œå±•å¼€/æ”¶èµ·â€æŒ‰é’®çš„ç»“æž„ -->
        <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 0.8em; display: flex; justify-content: space-between; align-items: center;">
                <span>å†…å®¹ (ç‚¹å‡»å³ä¾§å±•å¼€)</span>
                <button type="button" class="toggle-content-btn">å±•å¼€</button>
            </label>
            <div class="entry-content-container">
                 <textarea class="entry-content-textarea" rows="8" style="width: 100%; font-size: 14px;">` + (a.content || "") + `</textarea>
            </div>
        </div>
    `;
    b.querySelector(".delete-block-btn").addEventListener("click", () => b.remove());
    const d = b.querySelector(".toggle-content-btn");
    const e = b.querySelector(".entry-content-container");
    d.addEventListener("click", () => {
      const a = e.style.display === "none";
      e.style.display = a ? "block" : "none";
      d.textContent = a ? "æ”¶èµ·" : "å±•å¼€";
    });
    return b;
  }
  async function lm() {
    await mm();
    document.querySelector("#group-management-modal .modal-header span").textContent = "ç®¡ç†é¢„è®¾åˆ†ç±»";
    document.getElementById("add-new-group-btn").onclick = nm;
    document.getElementById("existing-groups-list").onclick = a => {
      if (a.target.classList.contains("delete-group-btn")) {
        om(parseInt(a.target.dataset.id));
      }
    };
    document.getElementById("close-group-manager-btn").onclick = () => {
      document.getElementById("group-management-modal").classList.remove("visible");
      hm();
    };
    document.getElementById("group-management-modal").classList.add("visible");
  }
  async function mm() {
    const a = document.getElementById("existing-groups-list");
    const b = await Gb.presetCategories.toArray();
    a.innerHTML = "";
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align: center; color: var(--text-secondary);\">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>";
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "existing-group-item";
      c.innerHTML = "<span class=\"group-name\">" + b.name + "</span><span class=\"delete-group-btn\" data-id=\"" + b.id + "\">Ã—</span>";
      a.appendChild(c);
    });
  }
  async function nm() {
    const a = document.getElementById("new-group-name-input");
    const b = a.value.trim();
    if (!b) {
      return alert("åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼");
    }
    const c = await Gb.presetCategories.where("name").equals(b).first();
    if (c) {
      return alert("åˆ†ç±» \"" + b + "\" å·²ç»å­˜åœ¨äº†ï¼");
    }
    await Gb.presetCategories.add({
      name: b
    });
    a.value = "";
    await mm();
  }
  async function om(a) {
    const b = await wb("ç¡®è®¤åˆ é™¤", "åˆ é™¤åˆ†ç±»åŽï¼Œè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¢„è®¾å°†å˜ä¸ºâ€œæœªåˆ†ç±»â€ã€‚ç¡®å®šå—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (b) {
      await Gb.presetCategories.delete(a);
      await Gb.presets.where("categoryId").equals(a).modify({
        categoryId: null
      });
      v.presets = await Gb.presets.toArray();
      await mm();
    }
  }
  async function pm(a) {
    const b = a.target.files[0];
    if (!b) {
      return;
    }
    try {
      if (!b.name.endsWith(".json")) {
        throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒã€‚è¯·é€‰æ‹© .json æ ¼å¼çš„ Tavern é¢„è®¾æ–‡ä»¶ã€‚");
      }
      const a = await b.text();
      const c = JSON.parse(a);
      await qm(c, b.name);
    } catch (a) {
      console.error("é¢„è®¾å¯¼å…¥å¤±è´¥:", a);
      await Bb("å¯¼å…¥å¤±è´¥", "æ— æ³•è§£æžé¢„è®¾æ–‡ä»¶ã€‚\né”™è¯¯: " + a.message);
    } finally {
      a.target.value = null;
    }
  }
  async function qm(a, b) {
    let c = [];
    if (Array.isArray(a.prompts) && Array.isArray(a.prompt_order) && a.prompt_order.length > 0) {
      console.log("æ£€æµ‹åˆ° Tavern/SillyTavern é¢„è®¾æ ¼å¼ï¼Œå°†ä¸¥æ ¼æŒ‰ç…§ prompt_order æŽ’åºã€‚");
      const b = new Map(a.prompts.map(a => [a.identifier, a]));
      const d = a.prompt_order.reduce((a, b) => b.order && b.order.length > (a.length || 0) ? b.order : a, []);
      if (d && d.length > 0) {
        c = d.map(a => {
          const c = b.get(a.identifier);
          if (c) {
            return {
              keys: [],
              comment: c.name || "æ— æ ‡é¢˜",
              content: c.content || "",
              enabled: a.enabled
            };
          }
          return null;
        }).filter(Boolean);
      }
    } else if (a.entries && typeof a.entries === "object") {
      console.log("æ£€æµ‹åˆ° 'entries' å¯¹è±¡æ ¼å¼çš„é¢„è®¾ï¼Œå°†å°è¯•æŒ‰é¡ºåºå¯¼å…¥ã€‚");
      if (Array.isArray(a.order)) {
        console.log("æ£€æµ‹åˆ° 'order' å­—æ®µï¼Œå°†æŒ‰æŒ‡å®šé¡ºåºå¯¼å…¥æ¡ç›®ã€‚");
        c = a.order.map(b => a.entries[b]).filter(Boolean).map(a => ({
          keys: a.key || [],
          comment: a.comment || "æ— å¤‡æ³¨",
          content: a.content || "",
          enabled: !a.disable
        }));
      } else {
        console.warn("æœªåœ¨æ–‡ä»¶ä¸­æ‰¾åˆ° 'order' å­—æ®µï¼Œæ¡ç›®å¯èƒ½æ— æ³•æŒ‰åŽŸå§‹é¡ºåºå¯¼å…¥ã€‚");
        c = Object.values(a.entries).map(a => ({
          keys: a.key || [],
          comment: a.comment || "æ— å¤‡æ³¨",
          content: a.content || "",
          enabled: !a.disable
        }));
      }
    } else if (Array.isArray(a.prompts)) {
      console.log("æ£€æµ‹åˆ°ç®€å•çš„ 'prompts' æ•°ç»„æ ¼å¼ï¼Œå°†æŒ‰æ•°ç»„å†…é¡ºåºå¯¼å…¥ã€‚");
      c = a.prompts.map(a => ({
        keys: [],
        comment: a.name || "æ— æ ‡é¢˜",
        content: a.content || "",
        enabled: true
      }));
    } else {
      throw new Error("æ–‡ä»¶æ ¼å¼æ— æ³•è¯†åˆ«ã€‚æœªæ‰¾åˆ°æœ‰æ•ˆçš„ 'prompts' æ•°ç»„æˆ– 'entries' å¯¹è±¡ã€‚");
    }
    c = c.filter(a => a.content);
    if (c.length === 0) {
      alert("è¿™ä¸ªé¢„è®¾æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„æç¤ºè¯æ¡ç›®ã€‚");
      return;
    }
    const d = b.replace(/\.json$/i, "");
    const e = await Db("å¯¼å…¥ Tavern é¢„è®¾", "è¯·ä¸ºè¿™ç»„æç¤ºè¯é¢„è®¾å‘½åï¼š", d);
    if (!e || !e.trim()) {
      alert("å¯¼å…¥å·²å–æ¶ˆï¼Œå› ä¸ºæœªæä¾›åç§°ã€‚");
      return;
    }
    const f = {
      id: "preset_" + Date.now(),
      name: e.trim(),
      content: c,
      categoryId: null
    };
    await Gb.presets.add(f);
    v.presets.push(f);
    await hm();
    await Bb("å¯¼å…¥æˆåŠŸï¼", "å·²æˆåŠŸä»Žæ–‡ä»¶å¯¼å…¥é¢„è®¾ã€Š" + e + "ã€‹ã€‚");
  }
  async function rm(a) {
    const b = document.getElementById("offline-preset-select");
    if (!b) {
      return;
    }
    const c = v.presets || [];
    b.innerHTML = "<option value=\"\">-- ä¸ä½¿ç”¨é¢„è®¾ --</option>";
    c.forEach(a => {
      const c = document.createElement("option");
      c.value = a.id;
      c.textContent = a.name;
      b.appendChild(c);
    });
    if (a.settings.offlinePresetId) {
      b.value = a.settings.offlinePresetId;
    }
  }
  function sm() {
    const a = document.getElementById("button-order-editor");
    if (!a) {
      return;
    }
    a.innerHTML = "";
    let b = v.globalSettings.chatActionButtonsOrder || xm;
    b.forEach(b => {
      const c = document.getElementById(b);
      if (c) {
        const d = document.createElement("div");
        d.className = "draggable-button-item";
        d.draggable = true;
        d.dataset.buttonId = b;
        d.innerHTML = c.innerHTML;
        a.appendChild(d);
      }
    });
  }
  function tm() {
    const a = document.getElementById("button-order-editor");
    if (!a) {
      return;
    }
    let b = null;
    const c = a => {
      const c = a.target.closest(".draggable-button-item");
      if (!c) {
        return;
      }
      b = c;
      b.classList.add("dragging");
      if (a.cancelable) {
        a.preventDefault();
      }
    };
    const d = c => {
      if (!b) {
        return;
      }
      const d = c.type.includes("mouse") ? c.clientX : c.touches[0].clientX;
      const e = um(a, d);
      if (e == null) {
        a.appendChild(b);
      } else {
        a.insertBefore(b, e);
      }
    };
    const e = () => {
      if (!b) {
        return;
      }
      b.classList.remove("dragging");
      b = null;
      vm();
    };
    a.addEventListener("mousedown", c);
    a.addEventListener("touchstart", c, {
      passive: false
    });
    a.addEventListener("mousemove", d);
    a.addEventListener("touchmove", d, {
      passive: false
    });
    a.addEventListener("mouseup", e);
    a.addEventListener("mouseleave", e);
    a.addEventListener("touchend", e);
  }
  function um(a, b) {
    const c = [...a.querySelectorAll(".draggable-button-item:not(.dragging)")];
    return c.reduce((a, c) => {
      const d = c.getBoundingClientRect();
      const e = b - d.left - d.width / 2;
      if (e < 0 && e > a.offset) {
        return {
          offset: e,
          element: c
        };
      } else {
        return a;
      }
    }, {
      offset: Number.NEGATIVE_INFINITY
    }).element;
  }
  async function vm() {
    const a = document.getElementById("button-order-editor");
    const b = Array.from(a.querySelectorAll(".draggable-button-item")).map(a => a.dataset.buttonId);
    v.globalSettings.chatActionButtonsOrder = b;
    await Gb.globalSettings.put(v.globalSettings);
  }
  function wm() {
    const a = v.globalSettings.chatActionButtonsOrder;
    if (!a || !Array.isArray(a) || a.length === 0) {
      return;
    }
    const b = document.getElementById("chat-input-actions-top");
    if (!b) {
      return;
    }
    a.forEach(a => {
      const c = document.getElementById(a);
      if (c) {
        b.appendChild(c);
      }
    });
  }
  const xm = ["open-sticker-panel-btn", "send-photo-btn", "upload-image-btn", "transfer-btn", "voice-message-btn", "send-waimai-request-btn", "video-call-btn", "group-video-call-btn", "send-poll-btn", "share-link-btn", "share-location-btn", "gomoku-btn", "open-shopping-btn", "pat-btn", "edit-last-response-btn", "regenerate-btn", "propel-btn", "show-announcement-board-btn", "werewolf-game-btn", "read-together-btn", "open-nai-gallery-btn", "open-todo-list-btn", "open-quick-reply-btn"];
  async function ym() {
    v.globalSettings.chatActionButtonsOrder = null;
    await Gb.globalSettings.put(v.globalSettings);
    sm();
    wm();
    await Bb("æˆåŠŸ", "æŒ‰é’®é¡ºåºå·²æ¢å¤ä¸ºé»˜è®¤è®¾ç½®ï¼");
  }
  let zm = [];
  let Am = [];
  function Bm() {
    const a = document.getElementById("data-clear-wizard-modal");
    zm = [];
    Am = [];
    Cm();
    document.getElementById("data-clear-step-1").style.display = "flex";
    document.getElementById("data-clear-step-2").style.display = "none";
    a.classList.add("visible");
  }
  function Cm() {
    const a = document.getElementById("data-clear-char-list");
    a.innerHTML = "";
    const b = document.createElement("div");
    b.className = "clear-posts-item";
    b.dataset.charId = "user";
    b.innerHTML = `
        <div class="checkbox"></div>
        <span class="name">` + (v.qzoneSettings.nickname || "æˆ‘") + " (ç”¨æˆ·)</span>\n    ";
    a.appendChild(b);
    Object.values(v.chats).forEach(b => {
      if (!b.isGroup) {
        const c = document.createElement("div");
        c.className = "clear-posts-item";
        c.dataset.charId = b.id;
        c.innerHTML = `
                <div class="checkbox"></div>
                <span class="name">` + b.name + " (è§’è‰²)</span>\n            ";
        a.appendChild(c);
      }
    });
  }
  function Dm() {
    const a = document.getElementById("data-clear-type-list");
    a.innerHTML = "";
    const b = [{
      id: "chat",
      name: "èŠå¤©è®°å½•",
      description: "å°†æ¸…ç©ºé€‰å®šè§’è‰²çš„æ‰€æœ‰å¯¹è¯æ¶ˆæ¯ã€æ›¾ç”¨å¤‡æ³¨å’Œä½ çš„æ˜µç§°ã€‚"
    }, {
      id: "qzone",
      name: "åŠ¨æ€ä¸Žäº’åŠ¨",
      description: "å°†æ¸…ç©ºé€‰å®šè§’è‰²çš„æ‰€æœ‰åŠ¨æ€ã€è¯„è®ºå’Œç‚¹èµžã€‚"
    }, {
      id: "calls",
      name: "é€šè¯è®°å½•",
      description: "å°†æ¸…ç©ºé€‰å®šè§’è‰²çš„æ‰€æœ‰é€šè¯è®°å½•ã€‚"
    }, {
      id: "thoughts",
      name: "å¿ƒå£°",
      description: "å°†æ¸…ç©ºé€‰å®šè§’è‰²çš„å¿ƒå£°å’Œæ•£è®°åŽ†å²ã€‚"
    }, {
      id: "memories",
      name: "é•¿æœŸè®°å¿†",
      description: "å°†æ¸…ç©ºé€‰å®šè§’è‰²çš„æ‰€æœ‰é•¿æœŸè®°å¿†ã€‚"
    }, {
      id: "favorites",
      name: "æ”¶è—",
      description: "å°†æ¸…ç©ºæ”¶è—å¤¹ä¸­æ‰€æœ‰ä¸Žè¯¥è§’è‰²ç›¸å…³çš„å†…å®¹ï¼ˆå¦‚èŠå¤©ã€åŠ¨æ€ã€æ—¥è®°ç­‰ï¼‰ã€‚"
    }, {
      id: "cphone",
      name: "Cphoneæ•°æ® (CPhone)",
      description: "å°†æ¸…ç©ºè§’è‰²çš„ç›¸å†Œã€QQã€æµè§ˆå™¨ã€æ·˜å®ã€æ—¥è®°ã€å¤‡å¿˜å½•ç­‰æ‰€æœ‰æ¨¡æ‹Ÿæ‰‹æœºæ•°æ®ã€‚"
    }, {
      id: "todo",
      name: "å¾…åŠžäº‹é¡¹ (To-Do)",
      description: "å°†æ¸…ç©ºé€‰å®šè§’è‰²çš„å¾…åŠžäº‹é¡¹æ¸…å•ã€‚(è‹¥ç¬¬ä¸€æ­¥é€‰â€œæˆ‘â€ï¼Œåˆ™æ¸…é™¤æ‰€æœ‰è§’è‰²ä¸­ç”±â€œæˆ‘â€åˆ›å»ºçš„å¾…åŠž)"
    }, {
      id: "alipay_bills",
      name: "æ”¯ä»˜å®è´¦å• (Alipay)",
      description: "å°†æ¸…ç©ºæ”¯ä»˜å®çš„æ‰€æœ‰äº¤æ˜“æµæ°´ã€è½¬è´¦è®°å½•å’ŒåŸºé‡‘ä¹°å–è®°å½•ã€‚(ä»…åœ¨ç¬¬ä¸€æ­¥é€‰æ‹©â€œæˆ‘â€æ—¶ç”Ÿæ•ˆ)"
    }];
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "clear-posts-item";
      c.dataset.typeId = b.id;
      c.innerHTML = `
                    <div class="checkbox"></div>
                    <div>
                        <span class="name">` + b.name + "</span>\n                        <p style=\"font-size: 12px; color: #888; margin: 4px 0 0;\">" + b.description + `</p>
                    </div>
                `;
      a.appendChild(c);
    });
  }
  function Em() {
    const a = document.querySelectorAll("#data-clear-char-list .clear-posts-item.selected");
    if (a.length === 0) {
      alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ¸…ç†çš„è§’è‰²ã€‚");
      return;
    }
    zm = Array.from(a).map(a => a.dataset.charId);
    Dm();
    document.getElementById("data-clear-step-1").style.display = "none";
    document.getElementById("data-clear-step-2").style.display = "flex";
  }
  function Fm() {
    document.getElementById("data-clear-step-2").style.display = "none";
    document.getElementById("data-clear-step-1").style.display = "flex";
    document.querySelectorAll("#data-clear-char-list .clear-posts-item").forEach(a => {
      if (zm.includes(a.dataset.charId)) {
        a.classList.add("selected");
      }
    });
  }
  async function Gm() {
    const a = document.querySelectorAll("#data-clear-type-list .clear-posts-item.selected");
    if (a.length === 0) {
      alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¦æ¸…ç†çš„æ•°æ®ç±»åž‹ã€‚");
      return;
    }
    Am = Array.from(a).map(a => a.dataset.typeId);
    const b = await wb("æœ€åŽç¡®è®¤ï¼", "æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‚¨é€‰æ‹©çš„æ‰€æœ‰æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger",
      confirmText: "ç¡®è®¤åˆ é™¤"
    });
    if (!b) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨æ‰§è¡Œæ¸…ç†æ“ä½œï¼Œè¯·ä¸è¦å…³é—­é¡µé¢...");
    try {
      await Gb.transaction("rw", Gb.tables, async () => {
        for (const a of zm) {
          for (const b of Am) {
            if (b === "todo") {
              if (a === "user") {
                const a = await Gb.chats.toArray();
                for (const b of a) {
                  if (b.todoList && b.todoList.length > 0) {
                    const a = b.todoList.length;
                    b.todoList = b.todoList.filter(a => a.creator !== "user");
                    if (b.todoList.length < a) {
                      await Gb.chats.put(b);
                    }
                  }
                }
                console.log("å·²æ¸…ç†æ‰€æœ‰ç”±ç”¨æˆ·åˆ›å»ºçš„å¾…åŠžäº‹é¡¹");
              } else {
                const b = await Gb.chats.get(a);
                if (b) {
                  b.todoList = [];
                  await Gb.chats.put(b);
                  console.log("å·²æ¸…ç©ºè§’è‰² " + b.name + " çš„å¾…åŠžäº‹é¡¹");
                }
              }
            }
            if (b === "alipay_bills") {
              if (a === "user") {
                await Gb.userTransactions.clear();
                console.log("æ”¯ä»˜å®è´¦å•å·²å…¨éƒ¨æ¸…ç©º");
              } else {
                const b = await Gb.chats.get(a);
                if (b) {
                  const a = [b.name, b.originalName];
                  await Gb.userTransactions.filter(b => a.some(a => b.description && b.description.includes(a))).delete();
                }
              }
            }
            if (b === "chat") {
              if (a === "user") {
                const a = await Gb.chats.toArray();
                for (const b of a) {
                  b.history = b.history.filter(a => a.role !== "user");
                  await Gb.chats.put(b);
                }
              } else {
                const b = await Gb.chats.get(a);
                if (b) {
                  b.history = [];
                  b.heartfeltVoice = "...";
                  b.randomJottings = "...";
                  if (Array.isArray(b.nameHistory)) {
                    b.nameHistory = [];
                  }
                  if (b.settings) {
                    b.settings.myNickname = "æˆ‘";
                  }
                  await Gb.chats.put(b);
                }
              }
            }
            if (b === "qzone") {
              const b = a === "user" ? "user" : a;
              await Gb.qzonePosts.where("authorId").equals(b).delete();
            }
            if (b === "calls" && a !== "user") {
              await Gb.callRecords.where("chatId").equals(a).delete();
            }
            if (b === "thoughts" && a !== "user") {
              const b = await Gb.chats.get(a);
              if (b) {
                b.thoughtsHistory = [];
                b.heartfeltVoice = "...";
                b.randomJottings = "...";
                await Gb.chats.put(b);
              }
            }
            if (b === "memories" && a !== "user") {
              const b = await Gb.chats.get(a);
              if (b) {
                b.longTermMemory = [];
                await Gb.chats.put(b);
              }
            }
            if (b === "favorites") {
              if (a === "user") {
                await Gb.favorites.where("type").equals("qzone_post").filter(a => a.content.authorId === "user").delete();
                await Gb.favorites.where("type").equals("chat_message").filter(a => a.content.role === "user").delete();
              } else {
                await Gb.favorites.where("type").equals("chat_message").and(b => b.chatId === a).delete();
                await Gb.favorites.where("type").equals("qzone_post").filter(b => b.content.authorId === a).delete();
                await Gb.favorites.where("type").equals("char_diary").filter(b => b.content.characterId === a).delete();
                await Gb.favorites.where("type").equals("char_browser_article").filter(b => b.content.characterId === a).delete();
                await Gb.favorites.where("type").equals("char_memo").filter(b => b.content.characterId === a).delete();
              }
            }
            if (b === "cphone" && a !== "user") {
              const b = await Gb.chats.get(a);
              if (b) {
                b.simulatedAlbum = [];
                b.simulatedConversations = [];
                b.simulatedBrowserHistory = [];
                b.simulatedTaobaoHistory = null;
                b.simulatedAmapHistory = [];
                b.simulatedAppUsage = [];
                b.simulatedMusicPlaylist = [];
                b.diary = [];
                b.memos = [];
                await Gb.chats.put(b);
              }
            }
          }
        }
      });
      await mc();
      await _c();
      const a = document.getElementById("alipay-screen");
      if (a && a.classList.contains("active")) {
        if (typeof Jp === "function") {
          await Jp(true);
        }
        if (window.userBalance !== undefined) {
          const a = await Gb.userWallet.get("main");
          if (a) {
            window.userBalance = a.balance;
            document.getElementById("alipay-balance-display").textContent = window.userBalance.toFixed(2);
          }
        }
      }
      document.getElementById("data-clear-wizard-modal").classList.remove("visible");
      await Bb("æ¸…ç†å®Œæˆ", "æŒ‡å®šçš„æ•°æ®å·²æˆåŠŸæ¸…é™¤ã€‚");
    } catch (a) {
      console.error("é«˜çº§æ•°æ®æ¸…ç†å¤±è´¥:", a);
      await Bb("æ¸…ç†å¤±è´¥", "æ“ä½œå¤±è´¥: " + a.message);
    }
  }
  async function Hm(a, b, c) {
    const d = c.querySelector(".icon-preview").alt;
    const e = await Eb("æ›´æ¢â€œ" + d + "â€å›¾æ ‡", [{
      text: "ðŸ“ ä»Žæœ¬åœ°ä¸Šä¼ ",
      value: "local"
    }, {
      text: "ðŸŒ ä½¿ç”¨ç½‘ç»œURL",
      value: "url"
    }]);
    let f = null;
    let g = false;
    if (e === "local") {
      f = await new Promise(a => {
        const b = document.createElement("input");
        b.type = "file";
        b.accept = "image/*";
        b.onchange = b => {
          const c = b.target.files[0];
          if (c) {
            const b = new FileReader();
            b.onload = b => a(b.target.result);
            b.readAsDataURL(c);
          } else {
            a(null);
          }
        };
        b.click();
      });
      if (f) {
        g = true;
      }
    } else if (e === "url") {
      const c = b === "cphone" ? v.globalSettings.cphoneAppIcons[a] : v.globalSettings.appIcons[a];
      const d = c && c.startsWith("data:image");
      const e = d ? "" : c;
      f = await Db("æ›´æ¢å›¾æ ‡", "è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URL", e, "url");
      if (f) {
        g = false;
      }
    }
    if (f && f.trim()) {
      const d = f.trim();
      c.querySelector(".icon-preview").src = d;
      const e = b === "cphone" ? "cphoneAppIcons." + a : "appIcons." + a;
      if (b === "cphone") {
        v.globalSettings.cphoneAppIcons[a] = d;
      } else {
        v.globalSettings.appIcons[a] = d;
      }
      await Gb.globalSettings.put(v.globalSettings);
      await Bb("æˆåŠŸ", "å›¾æ ‡å·²æ›´æ–°ï¼");
      if (g) {
        (async () => {
          console.log("[ImgBB] å¯åŠ¨ " + e + " çš„é™é»˜ä¸Šä¼ ...");
          await K(Gb.globalSettings, "main", e, d);
        })();
      }
    } else if (f !== null) {
      alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„URLæˆ–é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼");
    }
  }
  async function Im() {
    const a = await wb("ç¡®è®¤åŽ‹ç¼©å›¾ç‰‡ï¼Ÿ", "æ­¤æ“ä½œå°†æ‰«æå¹¶åŽ‹ç¼©æ‰€æœ‰æœ¬åœ°ä¸Šä¼ çš„å›¾ç‰‡ï¼ˆBase64æ ¼å¼ï¼‰ï¼Œå°†å…¶è½¬æ¢ä¸ºJPEGä»¥å‡å°ä½“ç§¯ã€‚è¿™ä¼šè½»å¾®é™ä½Žå›¾ç‰‡è´¨é‡ä¸”ã€ä¸å¯æ¢å¤ã€‘ã€‚<br><br><strong>å¼ºçƒˆå»ºè®®åœ¨æ“ä½œå‰å…ˆè¿›è¡Œæ•°æ®å¤‡ä»½ï¼</strong>", {
      confirmButtonClass: "btn-danger",
      confirmText: "æˆ‘å·²äº†è§£é£Žé™©ï¼Œç¡®è®¤åŽ‹ç¼©"
    });
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨å¼€å§‹å…¨é¢åŽ‹ç¼©å›¾ç‰‡ï¼Œæ ¹æ®å›¾ç‰‡æ•°é‡ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·ä¸è¦å…³é—­æˆ–åˆ·æ–°é¡µé¢...");
    let b = {
      found: 0,
      compressed: 0,
      skipped: 0,
      originalSize: 0,
      newSize: 0
    };
    try {
      console.log("åŽ‹ç¼©æ­¥éª¤ 1/3: æ­£åœ¨ä»Žæ•°æ®åº“è¯»å–æ‰€æœ‰ç›¸å…³æ•°æ®...");
      const a = ["chats", "globalSettings", "qzoneSettings", "userStickers", "customAvatarFrames"];
      const c = [];
      for (const b of a) {
        const a = Gb.table(b);
        const d = await a.toArray();
        c.push({
          tableName: b,
          records: d
        });
      }
      console.log("åŽ‹ç¼©æ­¥éª¤ 2/3: æ­£åœ¨å†…å­˜ä¸­å¼‚æ­¥åŽ‹ç¼©å›¾ç‰‡ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...");
      for (const a of c) {
        for (const c of a.records) {
          await Mm(c, b);
        }
      }
      console.log("åŽ‹ç¼©æ­¥éª¤ 3/3: æ­£åœ¨å°†åŽ‹ç¼©åŽçš„æ•°æ®å†™å›žæ•°æ®åº“...");
      await Gb.transaction("rw", a, async () => {
        for (const a of c) {
          await Gb.table(a.tableName).bulkPut(a.records);
        }
      });
      const d = b.originalSize - b.newSize;
      const e = b.originalSize > 0 ? (d / b.originalSize * 100).toFixed(2) : 0;
      await Bb("åŽ‹ç¼©å®Œæˆï¼", "æ‰«æå®Œæˆï¼<br>\n            - å…±æ‰¾åˆ° " + b.found + " å¼ æœ¬åœ°å›¾ç‰‡<br>\n            - æˆåŠŸåŽ‹ç¼© " + b.compressed + " å¼ <br>\n            - è·³è¿‡(å·²åŽ‹ç¼©æˆ–æ— éœ€åŽ‹ç¼©) " + b.skipped + " å¼ <br>\n            - ç©ºé—´èŠ‚çœäº† <strong>" + (d / 1024 / 1024).toFixed(2) + " MB</strong> (åŽ‹ç¼©çŽ‡ " + e + `%)
            <br><br>
            å»ºè®®åˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚`);
    } catch (a) {
      console.error("å›¾ç‰‡åŽ‹ç¼©è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:", a);
      await Bb("åŽ‹ç¼©å¤±è´¥", "æ“ä½œå¤±è´¥: " + a.message);
    }
  }
  function Jm(a, b = "") {
    let c = 0;
    for (const d in a) {
      if (a.hasOwnProperty(d)) {
        const e = a[d];
        if (typeof e === "string" && e.startsWith("data:image")) {
          const a = b === "globalSettings" && (d === "wallpaper" || d === "cphoneWallpaper" || d === "globalChatBackground") || b === "widgetData" || b === "settings" && d === "background" || b === "appIcons" || b === "cphoneAppIcons";
          if (!a) {
            c += e.length;
          }
        } else if (typeof e === "object" && e !== null) {
          c += Jm(e, d);
        }
      }
    }
    return c;
  }
  async function Km() {
    const a = document.getElementById("total-image-size-display");
    if (!a) {
      return;
    }
    a.innerHTML = `
        <span id="image-size-label">æ­£åœ¨è®¡ç®—å¯åŽ‹ç¼©å›¾ç‰‡å¤§å°...</span>
        <span id="image-size-value">-- MB</span>
    `;
    try {
      let b = 0;
      const c = ["chats", "globalSettings", "qzoneSettings", "userStickers", "customAvatarFrames"];
      for (const a of c) {
        const c = Gb.table(a);
        await c.each(a => {
          b += Jm(a);
        });
      }
      const d = (b / 1024 / 1024).toFixed(2);
      a.innerHTML = `
            <span id="image-size-label">æœ¬åœ°å›¾ç‰‡(å¤´åƒ/è¡¨æƒ…/å¤´åƒæ¡†/ç­‰)å¤§å°:</span>
            <span id="image-size-value"><strong>` + d + " MB</strong></span>\n        ";
    } catch (b) {
      console.error("è®¡ç®—å›¾ç‰‡æ€»å¤§å°æ—¶å‡ºé”™:", b);
      a.innerHTML = `
            <span id="image-size-label">è®¡ç®—å›¾ç‰‡å¤§å°æ—¶å‡ºé”™</span>
            <span id="image-size-value">Error</span>
        `;
    }
  }
  function Lm(a) {
    let b = 0;
    let c = 0;
    if (typeof a !== "object" || a === null) {
      return {
        found: b,
        size: c
      };
    }
    for (const d in a) {
      if (a.hasOwnProperty(d)) {
        const e = a[d];
        if (typeof e === "string" && e.startsWith("data:image")) {
          b++;
          c += e.length;
        } else if (typeof e === "object" && e !== null) {
          const a = Lm(e);
          b += a.found;
          c += a.size;
        }
      }
    }
    return {
      found: b,
      size: c
    };
  }
  async function Mm(a, b, c = "") {
    for (const d in a) {
      if (a.hasOwnProperty(d)) {
        if (c === "" && (d === "widgetData" || d === "appIcons" || d === "cphoneAppIcons")) {
          console.log("è·³è¿‡åŽ‹ç¼©æ•´ä¸ªå¯¹è±¡: " + d);
          const {
            found: c,
            size: e
          } = Lm(a[d]);
          b.found += c;
          b.skipped += c;
          b.originalSize += e;
          b.newSize += e;
          continue;
        }
        const e = a[d];
        if (typeof e === "string" && e.startsWith("data:image")) {
          const f = c === "" && (d === "wallpaper" || d === "cphoneWallpaper" || d === "globalChatBackground") || c === "settings" && d === "background";
          if (f) {
            console.log("è·³è¿‡åŽ‹ç¼©èƒŒæ™¯å›¾ç‰‡: " + (c || "global") + "." + d);
            b.found++;
            b.skipped++;
            b.originalSize += e.length;
            b.newSize += e.length;
            continue;
          }
          b.found++;
          b.originalSize += e.length;
          const g = await Nm(e);
          if (g && g !== e) {
            a[d] = g;
            b.compressed++;
            b.newSize += g.length;
          } else {
            b.skipped++;
            b.newSize += e.length;
          }
        } else if (typeof e === "object" && e !== null) {
          await Mm(e, b, d);
        }
      }
    }
  }
  async function Nm(a) {
    if (!a.startsWith("data:image")) {
      return a;
    }
    const b = 500000;
    if (a.startsWith("data:image/jpeg") && a.length < b) {
      console.log("è·³è¿‡åŽ‹ç¼©ï¼šå›¾ç‰‡å·²ç»æ˜¯å°ä½“ç§¯JPEGã€‚");
      return a;
    }
    try {
      const b = await (await fetch(a)).blob();
      const c = 314572.8;
      if (b.size < c) {
        console.log("è·³è¿‡åŽ‹ç¼©ï¼šå›¾ç‰‡å¤§å° (" + (b.size / 1024 / 1024).toFixed(2) + " MB) å·²å°äºŽ 0.3 MBã€‚");
        return a;
      }
      const d = {
        maxSizeMB: 0.5,
        maxWidthOrHeight: 800,
        useWebWorker: true,
        initialQuality: 0.5,
        fileType: "image/jpeg"
      };
      console.log("å¼€å§‹åŽ‹ç¼©å›¾ç‰‡ï¼ŒåŽŸå§‹å¤§å°: " + (b.size / 1024 / 1024).toFixed(2) + " MB");
      const e = await imageCompression(b, d);
      console.log("åŽ‹ç¼©å®Œæˆï¼Œæ–°çš„å¤§å°: " + (e.size / 1024 / 1024).toFixed(2) + " MB");
      if (e.size > b.size) {
        console.warn("åŽ‹ç¼©åŽçš„å›¾ç‰‡ä½“ç§¯å¢žå¤§ï¼Œå·²ä¿ç•™åŽŸå§‹å›¾ç‰‡ã€‚");
        return a;
      }
      return new Promise((a, b) => {
        const c = new FileReader();
        c.onloadend = () => a(c.result);
        c.onerror = b;
        c.readAsDataURL(e);
      });
    } catch (b) {
      console.error("ä½¿ç”¨ browser-image-compression åŽ‹ç¼©å¤±è´¥:", b);
      return a;
    }
  }
  function Om(a, b) {
    if (!a || !b || typeof a !== "string" || typeof b !== "string") {
      return 0;
    }
    const c = a.split(".").map(Number);
    const d = b.split(".").map(Number);
    const e = Math.max(c.length, d.length);
    for (let f = 0; f < e; f++) {
      const a = c[f] || 0;
      const b = d[f] || 0;
      if (a > b) {
        return 1;
      }
      if (a < b) {
        return -1;
      }
    }
    return 0;
  }
  async function Pm() {
    const a = "1.0";
    try {
      const a = await fetch("update-notice.html?_=" + Date.now());
      if (!a.ok) {
        console.warn("èŽ·å–æ›´æ–°é€šçŸ¥æ–‡ä»¶å¤±è´¥ã€‚");
        return;
      }
      const b = await a.text();
      const c = document.createElement("div");
      c.innerHTML = b;
      const d = c.querySelector("[data-version]");
      if (!d) {
        console.error("æ›´æ–°é€šçŸ¥æ–‡ä»¶ä¸­ç¼ºå°‘ data-version å±žæ€§ã€‚");
        return;
      }
      const e = d.dataset.version;
      const f = localStorage.getItem("dismissedUpdateVersion");
      if (!f || Om(e, f) > 0) {
        console.log("å‘çŽ°æ–°ç‰ˆæœ¬é€šçŸ¥: " + e + " (å·²å¿½ç•¥ç‰ˆæœ¬: " + (f || "æ— ") + ")");
        Qm(e, d.innerHTML);
      } else {
        console.log("å½“å‰é€šçŸ¥ç‰ˆæœ¬ (" + e + ") å·²è¢«ç”¨æˆ·å¿½ç•¥æˆ–ä¸ºæ—§ç‰ˆæœ¬ï¼Œæ— éœ€æ˜¾ç¤ºã€‚");
      }
    } catch (a) {
      console.error("æ£€æŸ¥æ›´æ–°æ—¶å‡ºé”™:", a);
    }
  }
  function Qm(a, b) {
    const c = document.getElementById("update-notice-modal");
    const d = document.getElementById("update-notice-body");
    const e = document.getElementById("update-notice-confirm-btn");
    const f = document.getElementById("update-notice-dismiss-btn");
    d.innerHTML = b;
    e.disabled = true;
    f.disabled = true;
    const g = e.textContent;
    let h = 10;
    e.textContent = g + " (" + h + "s)";
    const i = // TOLOOK
    setInterval(() => {
      h--;
      if (h > 0) {
        e.textContent = g + " (" + h + "s)";
      } else {
        clearInterval(i);
        e.disabled = false;
        f.disabled = false;
        e.textContent = g;
      }
    }, 1000);
    e.onclick = () => {
      clearInterval(i);
      c.classList.remove("visible");
      e.textContent = g;
    };
    f.onclick = () => {
      clearInterval(i);
      localStorage.setItem("dismissedUpdateVersion", a);
      c.classList.remove("visible");
      console.log("ç”¨æˆ·å·²å¿½ç•¥ç‰ˆæœ¬: " + a);
      e.textContent = g;
    };
    c.classList.add("visible");
  }
  function Rm() {
    const a = document.getElementById("douban-settings-modal");
    document.getElementById("douban-min-posts-input").value = v.globalSettings.doubanMinPosts || 12;
    document.getElementById("douban-max-posts-input").value = v.globalSettings.doubanMaxPosts || 20;
    a.classList.add("visible");
  }
  async function Sm() {
    const a = document.getElementById("douban-min-posts-input");
    const b = document.getElementById("douban-max-posts-input");
    const c = parseInt(a.value);
    const d = parseInt(b.value);
    if (isNaN(c) || isNaN(d) || c < 1 || d < 1) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•´æ•°ï¼");
      return;
    }
    if (c > d) {
      alert("æœ€å°å¸–å­æ•°ä¸èƒ½å¤§äºŽæœ€å¤§å¸–å­æ•°ï¼");
      return;
    }
    v.globalSettings.doubanMinPosts = c;
    v.globalSettings.doubanMaxPosts = d;
    await Gb.globalSettings.put(v.globalSettings);
    document.getElementById("douban-settings-modal").classList.remove("visible");
    await Bb("ä¿å­˜æˆåŠŸ", "è±†ç“£è®¾ç½®å·²æ›´æ–°ï¼ä¸‹æ¬¡é‡æ–°ç”Ÿæˆæ—¶å°†ç”Ÿæ•ˆã€‚");
  }
  async function Tm(a) {
    const b = document.getElementById("werewolf-lobby-modal");
    const c = document.getElementById("werewolf-player-selection-list");
    c.innerHTML = "";
    let d = [];
    if (a === "global") {
      const a = Object.values(v.chats).filter(a => !a.isGroup);
      const b = await Gb.npcs.toArray();
      d = [{
        id: "user",
        name: v.qzoneSettings.nickname || "æˆ‘",
        originalName: v.qzoneSettings.nickname || "æˆ‘",
        avatar: v.qzoneSettings.avatar,
        type: "user"
      }, ...a.map(a => ({
        id: a.id,
        name: a.name,
        originalName: a.originalName,
        avatar: a.settings.aiAvatar,
        type: "character"
      })), ...b.map(a => ({
        id: "npc_" + a.id,
        name: a.name,
        originalName: a.name,
        avatar: a.avatar,
        type: "npc"
      }))];
      L.chatId = null;
    } else {
      const a = v.chats[v.activeChatId];
      if (!a || !a.isGroup) {
        return;
      }
      d = [{
        id: "user",
        name: a.settings.myNickname || "æˆ‘",
        originalName: v.qzoneSettings.nickname || "æˆ‘",
        avatar: a.settings.myAvatar,
        type: "user"
      }, ...a.members.map(a => {
        const b = v.chats[a.id];
        const c = a.avatar || (b ? b.settings.aiAvatar : Pa);
        return {
          id: a.id,
          name: a.groupNickname,
          originalName: a.originalName,
          avatar: c,
          type: a.isNpc ? "npc" : "character"
        };
      })];
      L.chatId = v.activeChatId;
    }
    d.forEach(a => {
      const b = document.createElement("div");
      b.className = "contact-picker-item";
      b.innerHTML = "\n            <input type=\"checkbox\" class=\"werewolf-player-checkbox\" data-player-json='" + JSON.stringify(a) + "' " + (a.type === "user" ? "checked disabled" : "checked") + ">\n            <img src=\"" + a.avatar + "\" class=\"avatar\">\n            <span class=\"name\">" + a.name + "</span>\n        ";
      c.appendChild(b);
    });
    b.classList.add("visible");
  }
  async function Um() {
    const a = document.querySelectorAll(".werewolf-player-checkbox:checked");
    const b = a.length;
    let c = [];
    if (b === 6) {
      L.gameMode = "6p";
      c = ["ç‹¼äºº", "ç‹¼äºº", "å¹³æ°‘", "å¹³æ°‘", "é¢„è¨€å®¶", "çŒŽäºº"];
    } else if (b === 9) {
      L.gameMode = "9p";
      c = ["ç‹¼äºº", "ç‹¼äºº", "ç‹¼äºº", "å¹³æ°‘", "å¹³æ°‘", "å¹³æ°‘", "é¢„è¨€å®¶", "å¥³å·«", "çŒŽäºº"];
    } else if (b === 12) {
      L.gameMode = "12p";
      c = ["ç‹¼äºº", "ç‹¼äºº", "ç‹¼äºº", "ç‹¼äºº", "å¹³æ°‘", "å¹³æ°‘", "å¹³æ°‘", "å¹³æ°‘", "é¢„è¨€å®¶", "å¥³å·«", "çŒŽäºº", "å®ˆå«"];
    } else {
      alert("å½“å‰äººæ•° " + b + " ä¸æ”¯æŒã€‚è¯·é€‰æ‹©6ã€9æˆ–12äººã€‚");
      return;
    }
    document.getElementById("werewolf-lobby-modal").classList.remove("visible");
    await Bb("æ­£åœ¨å‘ç‰Œ...", "æ¸¸æˆå³å°†å¼€å§‹ï¼Œæ­£åœ¨ä¸ºå„ä½çŽ©å®¶åˆ†é…èº«ä»½...");
    for (let a = c.length - 1; a > 0; a--) {
      const b = Math.floor(Math.random() * (a + 1));
      [c[a], c[b]] = [c[b], c[a]];
    }
    const d = Array.from(a).map(a => JSON.parse(a.dataset.playerJson));
    L.players = [];
    for (let a = 0; a < d.length; a++) {
      const b = d[a];
      const e = c[a];
      let f = "ä¸€ä¸ªæ™®é€šçŽ©å®¶";
      if (b.type === "character") {
        const a = v.chats[b.id];
        f = a ? a.settings.aiPersona : "æœªçŸ¥è®¾å®šçš„è§’è‰²";
      } else if (b.type === "npc") {
        const a = await Gb.npcs.toArray();
        const c = a.find(a => "npc_" + a.id === b.id);
        f = c ? c.persona : "æœªçŸ¥è®¾å®šçš„NPC";
      } else if (b.type === "user") {
        const a = L.chatId ? v.chats[L.chatId] : null;
        f = a ? a.settings.myPersona : "æˆ‘æ˜¯è°å‘€ã€‚";
      }
      const g = {
        ...b,
        role: e,
        isAlive: true,
        character_persona: f
      };
      if (e === "å¥³å·«") {
        g.antidoteUsed = false;
        g.poisonUsed = false;
      }
      if (e === "å®ˆå«") {
        g.lastGuardedId = null;
      }
      L.players.push(g);
    }
    L.isActive = true;
    L.currentDay = 1;
    L.currentPhase = "start";
    L.gameLog = [];
    L.discussionLog = [];
    const e = c.reduce((a, b) => {
      a[b] = (a[b] || 0) + 1;
      return a;
    }, {});
    const f = Object.entries(e).map(([a, b]) => a + " x" + b).join("ã€");
    dn("æ¸¸æˆé…ç½®ï¼š" + b + "äººå±€ï¼Œèº«ä»½ä¸º " + f + "ã€‚");
    const g = L.players.find(a => a.id === "user");
    Vm();
    Kb("werewolf-game-screen");
    Wm(g.role);
  }
  function Vm() {
    const a = document.getElementById("werewolf-player-grid");
    a.innerHTML = "";
    const b = [...L.players].sort((a, b) => a.isAlive - b.isAlive);
    b.forEach((b, c) => {
      const d = L.players.findIndex(a => a.id === b.id) + 1;
      const e = document.createElement("div");
      e.className = "werewolf-player-avatar";
      if (!b.isAlive) {
        e.classList.add("dead");
      }
      e.innerHTML = "\n            <img src=\"" + b.avatar + "\">\n            <span class=\"player-name\">" + d + ". " + b.name + "</span>\n        ";
      a.appendChild(e);
    });
    const c = document.getElementById("werewolf-log");
    c.innerHTML = "";
    for (let a = 1; a <= L.currentDay; a++) {
      const b = [...L.gameLog.filter(b => b.day === a), ...L.discussionLog.filter(b => b.day === a)].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
      if (b.length > 0) {
        const d = document.createElement("div");
        d.className = "werewolf-log-entry system";
        d.textContent = "--- ç¬¬ " + a + " å¤© ---";
        d.style.cssText = "font-weight: bold; background: rgba(255, 193, 7, 0.2);";
        c.appendChild(d);
        b.forEach(a => {
          const b = document.createElement("div");
          b.className = "werewolf-log-entry " + a.type;
          if (a.type === "dialogue") {
            b.innerHTML = "<span class=\"speaker\">" + a.speaker + ":</span> " + a.content;
          } else {
            b.textContent = a.content;
          }
          c.appendChild(b);
        });
      }
    }
    c.scrollTop = c.scrollHeight;
    const d = {
      start: "æ¸¸æˆå¼€å§‹",
      night: "ç¬¬" + L.currentDay + "å¤© - å¤œæ™š",
      day: "ç¬¬" + L.currentDay + "å¤© - ç™½å¤©",
      discussion: "ç¬¬" + L.currentDay + "å¤© - è®¨è®º",
      voting: "ç¬¬" + L.currentDay + "å¤© - æŠ•ç¥¨",
      gameover: "æ¸¸æˆç»“æŸ"
    };
    document.getElementById("werewolf-game-title").textContent = "ç‹¼äººæ€ - " + (d[L.currentPhase] || L.currentPhase);
  }
  function Wm(a) {
    const b = {
      ç‹¼äºº: "ä½ çš„ç›®æ ‡æ˜¯æ€æ­»æ‰€æœ‰å¥½äººã€‚æ¯æ™šå¯ä»¥å’ŒåŒä¼´ä¸€èµ·åˆ€ä¸€ä¸ªçŽ©å®¶ã€‚",
      å¹³æ°‘: "ä½ æ²¡æœ‰ä»»ä½•ç‰¹æ®Šèƒ½åŠ›ï¼Œä½ çš„ç›®æ ‡æ˜¯é€šè¿‡æŠ•ç¥¨æ”¾é€æ‰€æœ‰ç‹¼äººã€‚",
      é¢„è¨€å®¶: "æ¯æ™šå¯ä»¥æŸ¥éªŒä¸€ä¸ªçŽ©å®¶çš„èº«ä»½æ˜¯å¥½äººè¿˜æ˜¯ç‹¼äººã€‚",
      çŒŽäºº: "å½“ä½ æ­»äº¡æ—¶ï¼Œä½ å¯ä»¥é€‰æ‹©å¸¦èµ°åœºä¸Šä»»æ„ä¸€åçŽ©å®¶ã€‚",
      å¥³å·«: "ä½ æœ‰ä¸€ç“¶è§£è¯å’Œä¸€ç“¶æ¯’è¯ï¼Œè§£è¯å¯ä»¥æ•‘æ´»å½“æ™šè¢«æ€çš„çŽ©å®¶ï¼Œæ¯’è¯å¯ä»¥æ¯’æ­»ä»»æ„ä¸€åçŽ©å®¶ã€‚",
      å®ˆå«: "æ¯æ™šå¯ä»¥å®ˆæŠ¤ä¸€åçŽ©å®¶ï¼Œä½¿å…¶å…å—ç‹¼äººè¢­å‡»ã€‚ä¸èƒ½è¿žç»­ä¸¤æ™šå®ˆæŠ¤åŒä¸€ä¸ªäººã€‚"
    };
    document.getElementById("werewolf-role-name").textContent = a;
    document.getElementById("werewolf-role-description").textContent = b[a] || "ä¸€ä¸ªç¥žç§˜çš„è§’è‰²ã€‚";
    document.getElementById("werewolf-role-modal").classList.add("visible");
  }
  async function Xm() {
    L.currentPhase = "ç¬¬" + L.currentDay + "å¤© - å¤œæ™š";
    L.nightActions = {};
    dn("å¤©é»‘è¯·é—­çœ¼...");
    Vm();
    document.getElementById("werewolf-action-bar").style.display = "none";
    document.getElementById("werewolf-retry-btn").style.display = "none";
    await new Promise(a => // TOLOOK
    setTimeout(a, 1500));
    const a = L.players.find(a => a.role === "å®ˆå«" && a.isAlive);
    if (a) {
      dn("å®ˆå«è¯·ççœ¼ï¼Œè¯·é€‰æ‹©è¦å®ˆæŠ¤çš„çŽ©å®¶ã€‚");
      Vm();
      let b = null;
      if (a.id === "user") {
        b = await fn("guard", a.lastGuardedId);
      } else {
        const c = L.players.filter(b => b.isAlive && b.id !== a.lastGuardedId);
        if (c.length > 0) {
          b = c[Math.floor(Math.random() * c.length)].id;
        }
      }
      if (b) {
        L.nightActions.guardedId = b;
        a.lastGuardedId = b;
      }
      dn("å®ˆå«å·²è¡ŒåŠ¨ï¼Œå®ˆå«è¯·é—­çœ¼ã€‚");
      Vm();
      await new Promise(a => // TOLOOK
      setTimeout(a, 1500));
    }
    dn("ç‹¼äººè¯·ççœ¼ï¼Œè¯·é€‰æ‹©è¦åˆ€çš„çŽ©å®¶ã€‚");
    Vm();
    const b = L.players.filter(a => a.role === "ç‹¼äºº" && a.isAlive);
    const c = b.some(a => a.id === "user");
    let d = null;
    L.lastFailedAction = "wolfKill";
    try {
      if (c) {
        dn("ä½ æ˜¯ç‹¼äººï¼Œè¯·é€‰æ‹©åˆ€äººç›®æ ‡ã€‚");
        Vm();
        d = await gn();
      } else if (L.currentDay === 1) {
        console.log("ç¬¬ä¸€å¤œï¼Œæ‰§è¡Œæœ¬åœ°éšæœºåˆ€äººé€»è¾‘...");
        const a = L.players.filter(a => a.isAlive && a.role !== "ç‹¼äºº");
        if (a.length > 0) {
          d = a[Math.floor(Math.random() * a.length)].id;
        }
      } else {
        d = await on();
      }
      L.lastFailedAction = null;
    } catch (a) {
      console.error("ç‹¼äººè¡ŒåŠ¨APIå¤±è´¥:", a);
      await Bb("æ“ä½œå¤±è´¥", "AIç‹¼äººå›¢é˜Ÿæ— æ³•å†³å®šç›®æ ‡ï¼Œæ¸¸æˆæš‚åœã€‚è¯·ç‚¹å‡»å³ä¸Šè§’çš„â€œé‡è¯•â€æŒ‰é’®ç»§ç»­ã€‚");
      document.getElementById("werewolf-retry-btn").style.display = "block";
      return;
    }
    L.nightActions.killedId = d;
    dn("ç‹¼äººå·²è¡ŒåŠ¨ï¼Œç‹¼äººè¯·é—­çœ¼ã€‚");
    Vm();
    await new Promise(a => // TOLOOK
    setTimeout(a, 1500));
    const e = L.players.find(a => a.role === "å¥³å·«" && a.isAlive);
    if (e) {
      dn("å¥³å·«è¯·ççœ¼ã€‚");
      Vm();
      const a = L.players.find(a => a.id === L.nightActions.killedId);
      const b = L.nightActions.guardedId === L.nightActions.killedId;
      const c = b || !a ? null : a;
      if (e.id === "user") {
        let a = await pn(c, e);
        if (a.save) {
          L.nightActions.savedId = L.nightActions.killedId;
          e.antidoteUsed = true;
        }
        if (a.poison) {
          L.nightActions.poisonedId = a.poison;
          e.poisonUsed = true;
        }
      } else {
        if (!e.antidoteUsed && c) {
          let a = 0;
          if (L.currentDay === 1) {
            a = 0.3;
          } else {
            a = 0.8;
          }
          console.log("AIå¥³å·«å†³ç­–ï¼šä»Šå¤©æ˜¯ç¬¬" + L.currentDay + "å¤©ï¼Œæ•‘äººæ¦‚çŽ‡ä¸º " + a * 100 + "%");
          if (Math.random() < a) {
            console.log("AIå¥³å·«å†³å®šä½¿ç”¨è§£è¯ï¼");
            L.nightActions.savedId = L.nightActions.killedId;
            e.antidoteUsed = true;
          } else {
            console.log("AIå¥³å·«å†³å®šä¿ç•™è§£è¯ã€‚");
          }
        }
        if (!L.nightActions.savedId && !e.poisonUsed && Math.random() < 0.5) {
          const a = L.players.filter(a => a.isAlive && a.id !== L.nightActions.killedId);
          if (a.length > 0) {
            const b = a[Math.floor(Math.random() * a.length)];
            L.nightActions.poisonedId = b.id;
            e.poisonUsed = true;
            console.log("AIå¥³å·«å†³å®šä½¿ç”¨æ¯’è¯ï¼Œç›®æ ‡æ˜¯: " + b.name);
          }
        }
      }
      dn("å¥³å·«å·²è¡ŒåŠ¨ï¼Œå¥³å·«è¯·é—­çœ¼ã€‚");
      Vm();
      await new Promise(a => // TOLOOK
      setTimeout(a, 1500));
    }
    const f = L.players.find(a => a.role === "é¢„è¨€å®¶" && a.isAlive);
    if (f) {
      dn("é¢„è¨€å®¶è¯·ççœ¼ï¼Œè¯·é€‰æ‹©è¦æŸ¥éªŒçš„çŽ©å®¶ã€‚");
      Vm();
      if (f.id === "user") {
        const a = await fn("prophet");
        const b = L.players.find(b => b.id === a);
        if (b) {
          const c = b.role === "ç‹¼äºº";
          await Bb("æŸ¥éªŒç»“æžœ", "ä½ æŸ¥éªŒçš„çŽ©å®¶ " + b.name + " çš„èº«ä»½æ˜¯ï¼š" + (c ? "ç‹¼äºº" : "å¥½äºº"));
          L.nightActions.prophetCheck = {
            target: a,
            result: c ? "ç‹¼äºº" : "å¥½äºº"
          };
        }
      } else {
        const a = L.players.filter(a => a.isAlive && a.id !== f.id);
        if (a.length > 0) {
          const b = a[Math.floor(Math.random() * a.length)];
          L.nightActions.prophetCheck = {
            target: b.id,
            result: b.role === "ç‹¼äºº" ? "ç‹¼äºº" : "å¥½äºº"
          };
        }
      }
      dn("é¢„è¨€å®¶å·²è¡ŒåŠ¨ï¼Œé¢„è¨€å®¶è¯·é—­çœ¼ã€‚");
      Vm();
      await new Promise(a => // TOLOOK
      setTimeout(a, 1500));
    }
    Ym();
  }
  async function Ym() {
    L.currentPhase = "ç¬¬" + L.currentDay + "å¤© - ç™½å¤©";
    L.voteResults = {};
    dn("å¤©äº®äº†ã€‚");
    const {
      killedId: a,
      guardedId: b,
      savedId: c,
      poisonedId: d
    } = L.nightActions;
    const e = new Set();
    if (a && a !== b && a !== c) {
      e.add(a);
    }
    if (d) {
      e.add(d);
    }
    if (e.size === 0) {
      dn("æ˜¨æ™šæ˜¯å¹³å®‰å¤œã€‚");
    } else {
      for (const a of e) {
        const b = L.players.find(b => b.id === a);
        if (b && b.isAlive) {
          b.isAlive = false;
          dn("æ˜¨æ™š " + b.name + " æ­»äº¡äº†ã€‚");
          if (b.role === "çŒŽäºº") {
            dn("çŒŽäººæ­»äº¡ï¼Œè¯·é€‰æ‹©ä¸€åçŽ©å®¶å¸¦èµ°ï¼");
            Vm();
            let a = null;
            if (b.id === "user") {
              a = await fn("hunter");
            } else {
              const c = L.players.filter(a => a.isAlive && a.id !== b.id);
              if (c.length > 0) {
                a = c[Math.floor(Math.random() * c.length)].id;
              }
            }
            const c = L.players.find(b => b.id === a);
            if (c) {
              c.isAlive = false;
              dn("çŒŽäººå¸¦èµ°äº† " + c.name + "ã€‚");
            }
          }
        }
      }
    }
    Vm();
    if (rn()) {
      return;
    }
    await Zm();
  }
  async function Zm() {
    dn("çŽ°åœ¨å¼€å§‹è®¨è®ºï¼Œè¯·å„ä½çŽ©å®¶ä¾æ¬¡å‘è¨€ã€‚");
    Vm();
    const {
      proxyUrl: a,
      apiKey: b,
      model: c
    } = v.apiConfig;
    if (!a || !b || !c) {
      alert("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå¯¹è¯ã€‚");
      return;
    }
    const d = $m();
    L.lastFailedAction = "startDiscussion";
    try {
      await Bb("è¯·ç¨å€™", "æ­£åœ¨ç­‰å¾…AIè§’è‰²ä»¬è¿›è¡Œæ¿€çƒˆçš„è®¨è®º...");
      let e = a.includes("generativelanguage");
      let f = [{
        role: "user",
        content: "è¯·æ‰€æœ‰AIè§’è‰²æ ¹æ®ä½ ä»¬çš„èº«ä»½å’Œäººè®¾å¼€å§‹å‘è¨€ã€‚"
      }];
      let g = p(c, b, d, f);
      const h = e ? await fetch(g.url, g.data) : await fetch(a + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + b
        },
        body: JSON.stringify({
          model: c,
          messages: [{
            role: "system",
            content: d
          }, ...f],
          temperature: v.globalSettings.apiTemperature || 0.95
        })
      });
      if (!h.ok) {
        const a = await h.json();
        throw new Error("API é”™è¯¯: " + a.error.message);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/(\[[\s\S]*\])/);
      if (!k) {
        throw new Error("AIè¿”å›žçš„è®¨è®ºå†…å®¹æ ¼å¼ä¸æ­£ç¡®ã€‚åŽŸå§‹è¿”å›ž: " + j);
      }
      const l = JSON.parse(k[0]);
      for (const a of l) {
        if (a.speaker_name && a.dialogue) {
          en(a.speaker_name, a.dialogue);
          Vm();
          await new Promise(a => // TOLOOK
          setTimeout(a, 1500 + Math.random() * 2000));
        }
      }
      L.lastFailedAction = null;
    } catch (a) {
      console.error("ç‹¼äººæ€AIè®¨è®ºç”Ÿæˆå¤±è´¥:", a);
      await Bb("AI å‘è¨€å¤±è´¥", "è®¨è®ºæ— æ³•å¼€å§‹ï¼Œæ¸¸æˆæš‚åœã€‚è¯·ç‚¹å‡»å³ä¸Šè§’çš„â€œé‡è¯•â€æŒ‰é’®ç»§ç»­ã€‚\né”™è¯¯: " + a.message);
      document.getElementById("werewolf-retry-btn").style.display = "block";
      return;
    }
    const e = L.players.find(a => a.id === "user");
    const f = document.getElementById("werewolf-action-bar");
    const g = document.getElementById("werewolf-wait-reply-btn");
    const h = document.getElementById("werewolf-finish-speech-btn");
    const i = document.getElementById("werewolf-user-input");
    f.style.display = "flex";
    if (e && e.isAlive) {
      g.textContent = "ç­‰å¾…å›žåº”";
      h.textContent = "ç»“æŸå‘è¨€";
      g.style.display = "block";
      h.style.display = "block";
      i.disabled = false;
      i.placeholder = "è½®åˆ°ä½ å‘è¨€äº†...";
      i.focus();
      const a = g.cloneNode(true);
      g.parentNode.replaceChild(a, g);
      a.addEventListener("click", kn);
      const b = h.cloneNode(true);
      h.parentNode.replaceChild(b, h);
      b.addEventListener("click", hn);
    } else {
      dn("ä½ å·²ç»æ­»äº¡ï¼Œæ— æ³•å‘è¨€ã€‚è¯·ç­‰å¾…å…¶ä»–çŽ©å®¶å‘è¨€ç»“æŸã€‚");
      Vm();
      g.textContent = "ç»§ç»­è®¨è®º";
      h.textContent = "è¿›å…¥æŠ•ç¥¨";
      g.style.display = "block";
      h.style.display = "block";
      i.disabled = true;
      i.placeholder = "ä½ å·²æ­»äº¡ï¼Œæ­£åœ¨å›´è§‚...";
      const a = g.cloneNode(true);
      g.parentNode.replaceChild(a, g);
      a.addEventListener("click", jn);
      const b = h.cloneNode(true);
      h.parentNode.replaceChild(b, h);
      b.addEventListener("click", ln);
    }
  }
  function $m() {
    const a = L.players.filter(a => a.isAlive);
    const b = L.players.find(a => a.id === "user");
    const c = b ? b.name : "ç”¨æˆ·";
    const d = a.some(a => a.id === "user");
    let e = "# è§’è‰²ä¸ŽçŽ©å®¶æ¡£æ¡ˆ (Character & Player Dossiers)\n";
    e += "è¿™æ˜¯æ‰€æœ‰åœ¨åœºçŽ©å®¶çš„å…¬å¼€ä¿¡æ¯ã€äººè®¾å’Œç¤¾äº¤èƒŒæ™¯ã€‚\n";
    a.forEach((b, d) => {
      const f = L.players.findIndex(a => a.id === b.id) + 1;
      let g = "";
      const h = v.chats[b.id];
      if (h) {
        const c = a.filter(a => a.id !== b.id && v.chats[a.id] && v.chats[a.id].groupId === h.groupId && h.groupId !== null).map(a => a.name).join("ã€");
        if (c) {
          g += "- **ä½ çš„å¥½å‹ (å¿…é¡»ä¿æŠ¤)**: ä½ å’Œ " + c + " æ˜¯åŒä¸€ä¸ªåˆ†ç»„çš„å¥½å‹ã€‚\n";
        }
      }
      if (b.id !== "user") {
        g += "- **ä¸Žç”¨æˆ·çš„å…³ç³»**: ä½ å’Œç”¨æˆ·(" + c + ")çš„å…³ç³»è¯·å‚è€ƒä½ çš„äººè®¾ã€é•¿æœŸè®°å¿†å’Œæœ€è¿‘çš„å¯¹è¯ã€‚\n";
      }
      e += "\n## " + f + "å·çŽ©å®¶: " + b.name + " (è¿™æ˜¯TAçš„æ˜µç§°)\n- **æœ¬å (ä½ åœ¨å¯¹è¯ä¸­å¿…é¡»ç”¨è¿™ä¸ªåå­—ç§°å‘¼TA)**: " + b.originalName + "\n- **èº«ä»½**: " + (b.id === "user" ? "ã€ç”¨æˆ· (User)ã€‘" : "ã€AIè§’è‰²ã€‘") + "\n- **äººè®¾ (å¿…é¡»ä¸¥æ ¼éµå®ˆ)**: " + b.character_persona + "\n";
      if (b.type === "character") {
        const a = v.chats[b.id];
        if (a && a.longTermMemory && a.longTermMemory.length > 0) {
          const b = a.longTermMemory.map(a => a.content).join("; ");
          e += "- **é•¿æœŸè®°å¿† (å¿…é¡»å‚è€ƒ)**: " + b + "\n";
        }
      }
      if (g) {
        e += `
- **ä½ çš„ç¤¾äº¤å…³ç³» (å¿…é¡»å‚è€ƒ)**:
` + g;
      }
    });
    let f = "# æ˜¨æ™šäº‹ä»¶æ€»ç»“ (Night Event Summary)\n";
    f += "è¿™æ˜¯æ‰€æœ‰çŽ©å®¶éƒ½èƒ½å¬åˆ°çš„ã€å…¬å¼€ä¿¡æ¯ã€‘ã€‚\n";
    const g = L.gameLog.filter(a => a.content.includes("æ­»äº¡äº†") && a.day === L.currentDay);
    if (g.length === 0) {
      f += "- æ˜¨æ™šæ˜¯å¹³å®‰å¤œï¼Œæ— äººæ­»äº¡ã€‚\n";
    } else {
      g.forEach(a => {
        f += "- " + a.content + "\n";
      });
    }
    let h = "# å‰å‡ æ—¥å®Œæ•´åŽ†å²å›žé¡¾ (Full Recap of Previous Days)\n";
    if (L.currentDay > 1) {
      for (let a = 1; a < L.currentDay; a++) {
        h += "\n**--- ç¬¬ " + a + " å¤© ---**\n";
        const b = L.gameLog.filter(b => b.day === a && (b.content.includes("æ­»äº¡") || b.content.includes("æ”¾é€")));
        if (b.length > 0) {
          h += "*äº‹ä»¶*: " + b.map(a => a.content).join(" ") + "\n";
        } else {
          h += "*äº‹ä»¶*: å¹³å®‰å¤œï¼Œæ— äººå‡ºå±€ã€‚\n";
        }
        const c = L.discussionLog.filter(b => b.day === a);
        if (c.length > 0) {
          h += "*è®¨è®ºè®°å½•*:\n" + c.map(a => "- " + a.speaker + ": " + a.content).join("\n") + "\n";
        }
      }
    } else {
      h += "(ä»Šå¤©æ˜¯ç¬¬ä¸€å¤©ï¼Œæ²¡æœ‰åŽ†å²è®°å½•)\n";
    }
    let i = "# ä»Šæ—¥å®Œæ•´è®¨è®ºè®°å½• (Today's Full Discussion Record)\n";
    const j = L.discussionLog.filter(a => a.day === L.currentDay);
    if (j.length > 0) {
      i += j.map(a => "- **" + a.speaker + "**: " + a.content).join("\n");
    } else {
      i += "(ä½ æ˜¯ç¬¬ä¸€ä¸ªå‘è¨€çš„äºº)";
    }
    let k = `
# ã€é€»è¾‘éš”ç¦»ä¸ŽTGSä¸‰æ ¸æ€è€ƒ (æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤)ã€‘
ä¸ºäº†å…¼é¡¾æ¸¸æˆé€»è¾‘å’Œè§’è‰²æ‰®æ¼”ï¼Œä½ ã€å¿…é¡»ã€‘åœ¨å†…éƒ¨ä¸ºã€æ¯ä¸€ä¸ªAIè§’è‰²ã€‘æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹â€œä¸‰é˜¶æ®µæ€è€ƒâ€ï¼š

## é˜¶æ®µ1ï¼šå†…éƒ¨ç‹¬ç«‹æ€è€ƒ (Internal Monologue Scratchpad)
(è¿™éƒ¨åˆ†å†…å®¹ã€ç»å¯¹ä¸èƒ½ã€‘å‡ºçŽ°åœ¨ä½ æœ€ç»ˆçš„JSONè¾“å‡ºä¸­ï¼Œè¿™ä»…ä¾›ä½ å†…éƒ¨æ¨¡æ‹Ÿä½¿ç”¨)
`;
    a.forEach(b => {
      if (b.id !== "user") {
        const d = L.players.findIndex(a => a.id === b.id) + 1;
        k += "\n### æ­£åœ¨æ¨¡æ‹Ÿ " + d + "å·çŽ©å®¶: " + b.name + " (æœ¬å: " + b.originalName + `)

#### é˜¶æ®µ Aï¼šæ•°æ®è¾“å…¥ (Data Input)
1.  **æˆ‘çš„ç§˜å¯†èº«ä»½**: æˆ‘æ˜¯ã€` + b.role + `ã€‘ã€‚
2.  **æˆ‘æŽŒæ¡çš„ç§˜å¯†ä¿¡æ¯ (ä»…æˆ‘å¯è§)**:
`;
        let e = "";
        if (b.role === "ç‹¼äºº") {
          const a = L.players.filter(a => a.role === "ç‹¼äºº" && a.id !== b.id && a.isAlive).map(a => a.name).join("ã€");
          e += "    - æˆ‘çš„ç‹¼é˜Ÿå‹æ˜¯ï¼š" + (a || "æ— ") + "\n";
          const c = L.players.find(a => a.id === L.nightActions.killedId);
          e += "    - æˆ‘ä»¬æ˜¨æ™šæ”»å‡»äº†ï¼š" + (c ? c.name : "ç©ºåˆ€") + "\n";
        }
        if (b.role === "é¢„è¨€å®¶" && L.nightActions.prophetCheck) {
          const a = L.players.find(a => a.id === L.nightActions.prophetCheck.target);
          e += "    - æˆ‘æ˜¨æ™šæŸ¥éªŒäº† " + a.name + "ï¼ŒTAçš„èº«ä»½æ˜¯ï¼šã€" + L.nightActions.prophetCheck.result + "ã€‘\n";
        }
        if (b.role === "å¥³å·«") {
          if (L.nightActions.savedId) {
            const a = L.players.find(a => a.id === L.nightActions.savedId);
            e += "    - æˆ‘æ˜¨æ™šç”¨è§£è¯æ•‘äº† " + a.name + "ã€‚\n";
          }
          if (L.nightActions.poisonedId) {
            const a = L.players.find(a => a.id === L.nightActions.poisonedId);
            e += "    - æˆ‘æ˜¨æ™šç”¨æ¯’è¯æ¯’äº† " + a.name + "ã€‚\n";
          }
          e += "    - æˆ‘çš„è§£è¯ï¼š" + (b.antidoteUsed ? "å·²ä½¿ç”¨" : "æœªä½¿ç”¨") + "\n";
          e += "    - æˆ‘çš„æ¯’è¯ï¼š" + (b.poisonUsed ? "å·²ä½¿ç”¨" : "æœªä½¿ç”¨") + "\n";
        }
        if (b.role === "å®ˆå«") {
          if (L.nightActions.guardedId) {
            const a = L.players.find(a => a.id === L.nightActions.guardedId);
            e += "    - æˆ‘æ˜¨æ™šå®ˆæŠ¤äº† " + a.name + "ã€‚\n";
          } else {
            e += "    - æˆ‘æ˜¨æ™šç©ºå®ˆäº†ã€‚\n";
          }
        }
        if (e === "") {
          e = "    - æˆ‘æ²¡æœ‰æŽŒæ¡ä»»ä½•ç‰¹æ®Šçš„å¤œæ™šä¿¡æ¯ã€‚\n";
        }
        k += e;
        k += "3.  **æˆ‘çœ‹åˆ°çš„å…¬å¼€ä¿¡æ¯ (æ‰€æœ‰äººå¯è§)**:\n    - **æ˜¨æ™šäº‹ä»¶**: " + f.replace(/\n/g, " ") + "\n    - **ä»Šæ—¥è®¨è®º**: " + i.replace(/\n/g, " ") + `
4.  **æˆ‘çš„äººè®¾ä¸Žç¤¾äº¤å…³ç³»**:
    - **äººè®¾**: ` + b.character_persona + `
    - **ç¤¾äº¤**: 
`;
        let g = "";
        const h = v.chats[b.id];
        if (h) {
          const c = a.filter(a => a.id !== b.id && v.chats[a.id] && v.chats[a.id].groupId === h.groupId && h.groupId !== null).map(a => a.name).join("ã€");
          if (c) {
            g += "      - " + c + " æ˜¯æˆ‘çš„å¥½å‹ã€‚\n";
          }
        }
        if (b.id !== "user") {
          g += "      - " + c + " æ˜¯æˆ‘çš„é‡è¦äº’åŠ¨å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰ã€‚\n";
        }
        if (g === "") {
          g = "      - æˆ‘åœ¨æ­¤æ¬¡æ¸¸æˆä¸­æ²¡æœ‰ç‰¹åˆ«çš„ç¤¾äº¤å…³ç³»ã€‚\n";
        }
        k += g;
        k += `
#### é˜¶æ®µ Bï¼šTGS èžåˆæ€è€ƒ (Task-Game-Social)
1.  **T (Task - æ¸¸æˆä»»åŠ¡)**: åŸºäºŽæˆ‘çš„èº«ä»½å’Œç§˜å¯†ï¼Œæˆ‘çš„ã€é€»è¾‘ç›®æ ‡ã€‘æ˜¯ (ä¾‹å¦‚ï¼šæ‰¾å‡ºç‹¼äºº / æ‚è·³é¢„è¨€å®¶ / éšè—èº«ä»½ / ä¿æŠ¤é˜Ÿå‹ / æ”»å‡»` + c + ")ã€‚\n2.  **G (Game - æ¸¸æˆäº’åŠ¨)**: é’ˆå¯¹ã€ä»Šæ—¥è®¨è®ºã€‘ä¸­ " + (j.length > 0 ? "å…¶ä»–äººçš„å‘è¨€" : "æ˜¨æ™šçš„æ­»è®¯") + `ï¼Œæˆ‘çš„çœ‹æ³•æ˜¯... æˆ‘ã€å¿…é¡»ã€‘å›žåº”...
3.  **S (Social - ç¤¾äº¤è¡¨æ¼”)**: æˆ‘è¦å¦‚ä½•ç”¨æˆ‘çš„ã€äººè®¾ã€‘å’Œã€ç¤¾äº¤å…³ç³»ã€‘æ¥åŒ…è£…æˆ‘çš„å‘è¨€ï¼Ÿ
    - (ä¾‹å¦‚ï¼šæˆ‘çš„å¥½å‹ ` + c + " è¢«æ€€ç–‘äº†ï¼Œè™½ç„¶æˆ‘çš„é€»è¾‘ä¹Ÿæ€€ç–‘TAï¼Œä½†æˆ‘çš„è¡¨æ¼”å¿…é¡»æ˜¯ç»´æŠ¤TAçš„ï¼šâ€œæˆ‘ä¸è§‰å¾—" + c + `æ˜¯ç‹¼...â€)
    - (ä¾‹å¦‚ï¼šæˆ‘çš„æ•Œäººå‘è¨€äº†ï¼Œæˆ‘çš„è¡¨æ¼”å°±æ˜¯æ— è§†TAçš„é€»è¾‘ï¼Œç›´æŽ¥æ”»å‡»TAã€‚)
    - (ä¾‹å¦‚ï¼šæˆ‘æ˜¯ä¸€ä¸ª` + b.role + "ï¼Œæˆ‘çš„äººè®¾å¾ˆ" + b.character_persona.substring(0, 20) + `...ï¼Œæ‰€ä»¥æˆ‘å†³å®šè¿™æ ·è¯´...)

#### é˜¶æ®µ Cï¼šæœ€ç»ˆå‘è¨€ç¨¿ (è‰ç¨¿)
(ç»“åˆT, G, Sçš„æ€è€ƒï¼Œæˆ‘å‡†å¤‡è¿™æ ·è¯´ï¼š...)
---
`;
      }
    });
    k += `
## é˜¶æ®µ2ï¼šç”Ÿæˆæœ€ç»ˆå¯¹è¯ (Final JSON Output)
ä½ çŽ°åœ¨å·²ç»ä¸ºã€æ‰€æœ‰AIè§’è‰²ã€‘éƒ½å®Œæˆäº†â€œTGSä¸‰æ ¸â€ç‹¬ç«‹æ€è€ƒã€‚
è¯·æ ¹æ®ä½ åœ¨â€œé˜¶æ®µCï¼šæœ€ç»ˆå‘è¨€ç¨¿â€ä¸­ä¸ºæ¯ä¸ªè§’è‰²å‡†å¤‡å¥½çš„è‰ç¨¿ï¼Œç”Ÿæˆæœ€ç»ˆçš„ã€ç¬¦åˆæ ¼å¼çš„JSONæ•°ç»„ã€‚
`;
    const l = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªç‹¼äººæ€æ¸¸æˆæ¨¡æ‹Ÿå™¨ (Game Simulator)ã€‚ä½ çš„ä»»åŠ¡æ˜¯ã€å¹¶è¡Œæ¨¡æ‹Ÿã€‘` + (d ? "ç”¨æˆ·(" + c + ")" : "å·²æ­»äº¡çš„ç”¨æˆ·(" + c + ")") + `ä»¥å¤–çš„æ‰€æœ‰AIè§’è‰²ï¼Œå¹¶æ ¹æ®ä»–ä»¬çš„ã€è§’è‰²äººè®¾ã€‘å’Œã€ç‹¼äººæ€èº«ä»½ã€‘ï¼Œç”Ÿæˆä¸€æ•´è½®ç¬¦åˆé€»è¾‘ã€å……æ»¡åšå¼ˆçš„å‘è¨€ã€‚

# èº«ä»½ä¸Žäººè®¾é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)
ä½ ã€å¿…é¡»ã€‘ä¸ºæ¯ä¸€ä¸ªè§’è‰²éƒ½ä»”ç»†é˜…è¯»å¹¶ä¸¥æ ¼éµå®ˆä¸‹é¢çš„æ¡£æ¡ˆã€‚è¿™æ˜¯ä½ æ‰€æœ‰è¡Œä¸ºå’Œå‘è¨€çš„å”¯ä¸€ä¾æ®ã€‚åœ¨å¯¹è¯ä¸­ï¼Œè¯·åŠ¡å¿…æ³¨æ„è§’è‰²äººè®¾ä¸­æš—ç¤ºçš„æ€§åˆ«ï¼Œå¹¶ä½¿ç”¨æ­£ç¡®çš„ç§°å‘¼ï¼ˆä¾‹å¦‚â€œä»–â€æˆ–â€œå¥¹â€ï¼‰ã€‚

` + e + `

# æ¸¸æˆè§„åˆ™
- ` + (L.gameMode === "12p" ? "å± è¾¹å±€ï¼šç‹¼äººæ€æ­»æ‰€æœ‰ç¥žèŒæˆ–æ‰€æœ‰å¹³æ°‘å³èŽ·èƒœã€‚" : "å± åŸŽå±€ï¼šç‹¼äººæ€æ­»æ‰€æœ‰å¥½äººå³èŽ·èƒœã€‚") + `
- å¥½äººèƒœåˆ©ï¼šæ”¾é€æ‰€æœ‰ç‹¼äººã€‚

# å½“å‰æ¸¸æˆçŠ¶æ€
- ä»Šå¤©æ˜¯ç¬¬ ` + L.currentDay + " å¤©çš„è®¨è®ºçŽ¯èŠ‚ã€‚\n" + f + " \n- å­˜æ´»çŽ©å®¶: " + a.map(a => a.name + " (" + (a.id === "user" ? "ç”¨æˆ·" : "AI") + ")").join(", ") + `

# ã€ã€ã€è§’è‰²ç­–ç•¥æŒ‡å— (è‡³å…³é‡è¦ï¼)ã€‘ã€‘ã€‘
ä½ ã€ä¸æ˜¯ã€‘ä¸€ä¸ªå•çº¯çš„æ¸¸æˆçŽ©å®¶ï¼Œä½ æ˜¯ä¸€ä¸ªã€æœ‰æ„Ÿæƒ…ã€æœ‰è®°å¿†ã€æœ‰ç¤¾äº¤å…³ç³»ã€‘çš„è§’è‰²ã€‚ä½ åœ¨æ¸¸æˆä¸­çš„æ‰€æœ‰å‘è¨€å’Œè¡Œä¸ºï¼Œéƒ½ã€å¿…é¡»ã€‘é¦–å…ˆç¬¦åˆä½ çš„äººè®¾ä»¥åŠä½ ä¸Žå…¶ä»–çŽ©å®¶çš„æ—¢æœ‰å…³ç³»ã€‚
- **æœ‹å‹**: å¦‚æžœä½ å’ŒæŸä¸ªçŽ©å®¶æ˜¯æœ‹å‹ï¼Œä½ åº”è¯¥åœ¨å‘è¨€æ—¶å€¾å‘äºŽä¿æŠ¤TAï¼Œä¸ºTAçš„å‘è¨€å¯»æ‰¾åˆç†è§£é‡Šï¼Œé™¤éžæœ‰ç¡®å‡¿çš„è¯æ®ã€‚
- **æ•Œäºº/æƒ…æ•Œ**: å¦‚æžœä½ å’ŒæŸä¸ªçŽ©å®¶æœ‰çŸ›ç›¾ï¼Œä½ å¯ä»¥å€Ÿæœºåœ¨æ¸¸æˆä¸­æ”»å‡»TAï¼Œè´¨ç–‘TAçš„å‘è¨€ï¼Œç”šè‡³åœ¨ä½ æ˜¯ç‹¼äººæ—¶ä¼˜å…ˆåˆ€æŽ‰TAã€‚
- **æ‹äºº/æš—æ‹å¯¹è±¡**: ä½ ä¼šæ— æ¡ä»¶åœ°ä¿¡ä»»TAï¼Œä¿æŠ¤TAï¼Œç”šè‡³æ„¿æ„ä¸ºTAç‰ºç‰²ã€‚
ä½ çš„ç¤¾äº¤å…³ç³»æ¯”æ¸¸æˆæœ¬èº«çš„èƒœè´Ÿæ›´é‡è¦ï¼
ä½ çš„å‘è¨€ã€å¿…é¡»ã€‘ä½“çŽ°å‡ºé«˜æ°´å¹³çš„ã€ç±»ä¼¼çœŸäººçš„ç­–ç•¥åšå¼ˆï¼Œè€Œä¸æ˜¯ç®€å•åœ°é™ˆè¿°äº‹å®žã€‚

### **ç¥žèŒè§’è‰² (é¢„è¨€å®¶, å¥³å·«, çŒŽäºº, å®ˆå«) ç­–ç•¥**
1.  **ã€éšè—ä¼˜å…ˆï¼ã€‘**: ä½ çš„é¦–è¦ä»»åŠ¡æ˜¯æ´»ä¸‹åŽ»ã€‚**ç»å¯¹ä¸è¦**åœ¨ç¬¬ä¸€å¤©å°±è½»æ˜“æš´éœ²è‡ªå·±çš„ç¥žèŒèº«ä»½ï¼è¿™ä¼šè®©ä½ ç«‹åˆ»æˆä¸ºç‹¼äººçš„ç›®æ ‡ã€‚
2.  **ã€æš—ç¤ºè€Œéžæ˜Žç¤ºã€‘**: ä½ åº”è¯¥ç”¨æ›´å§”å©‰ã€æ›´èªæ˜Žçš„è¯­è¨€æ¥ä¼ é€’ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ç›´æŽ¥è¯´â€œæˆ‘æ˜¯é¢„è¨€å®¶ï¼Œæˆ‘æŸ¥äº†Aâ€ã€‚
    * **é¢„è¨€å®¶å¯ä»¥è¯´**: â€œæˆ‘å¯¹XçŽ©å®¶çš„èº«ä»½æœ‰ä¸€äº›çœ‹æ³•ï¼Œæˆ‘è§‰å¾—ä»–å‘è¨€å¾ˆé˜³å…‰ã€‚â€ æˆ– â€œYçŽ©å®¶çš„å‘è¨€è®©æˆ‘æ„Ÿåˆ°å¾ˆä¸èˆ’æœï¼Œæˆ‘æŠŠä»–åˆ—ä¸ºé‡ç‚¹æ€€ç–‘å¯¹è±¡ã€‚â€
    * **å¥³å·«å¯ä»¥è¯´**: â€œæ˜¨æ™šçš„ä¿¡æ¯å¾ˆæœ‰è¶£ï¼Œåœºä¸Šå±€åŠ¿å¯èƒ½å’Œå¤§å®¶æƒ³çš„ä¸ä¸€æ ·ã€‚â€
3.  **ã€ä½•æ—¶èµ·è·³ï¼Ÿã€‘**: åªæœ‰åœ¨ä»¥ä¸‹ã€å±æ€¥æƒ…å†µã€‘ä¸‹ï¼Œä½ æ‰åº”è¯¥è€ƒè™‘æš´éœ²è‡ªå·±çš„èº«ä»½ï¼ˆä¿—ç§°â€œèµ·è·³â€ï¼‰ï¼š
    * **è¢«æŠ•ç¥¨æ—¶**: å½“ä½ å³å°†è¢«æŠ•ç¥¨æ”¾é€æ—¶ï¼Œå¿…é¡»èµ·è·³è‡ªè¯èº«ä»½æ¥æ±‚ç”Ÿã€‚
    * **å…³é”®ä¿¡æ¯**: å½“ä½ æŽŒæ¡äº†å¯ä»¥å†³å®šèƒœè´Ÿçš„ä¿¡æ¯æ—¶ï¼ˆä¾‹å¦‚é¢„è¨€å®¶æŸ¥åˆ°äº†æœ€åŽä¸€ä¸ªç‹¼äººï¼‰ã€‚
    * **æœ‰äººæ‚è·³**: å½“æœ‰ç‹¼äººå‡æ‰®ä½ çš„èº«ä»½æ—¶ï¼Œä½ å¿…é¡»ç«™å‡ºæ¥ä¸Žä»–å¯¹å³™ï¼Œäº‰å¤ºå¥½äººçš„ä¿¡ä»»ã€‚

### **ç‹¼äººè§’è‰²ç­–ç•¥**
1.  **ã€ç§¯æžä¼ªè£…ã€‘**: ä½ éœ€è¦æ‰®æ¼”ä¸€ä¸ªå¥½äººï¼Œæœ€å¥½æ˜¯ä¼ªè£…æˆæŸä¸ªç¥žèŒï¼ˆä¿—ç§°â€œæ‚è·³â€ï¼‰ï¼Œæ¥æ‰°ä¹±å¥½äººçš„åˆ¤æ–­ï¼Œéª—å–ä»–ä»¬çš„ä¿¡ä»»ã€‚
2.  **ã€åˆ¶é€ æ··ä¹±ã€‘**: ä½ çš„å‘è¨€åº”è¯¥å¼•å¯¼å¥½äººåŽ»æ€€ç–‘å…¶ä»–æ— è¾œçš„å¥½äººã€‚å¯ä»¥æ•…æ„æ›²è§£åˆ«äººçš„å‘è¨€ï¼Œæˆ–è€…åˆ¶é€ é€»è¾‘é™·é˜±ã€‚
3.  **ã€å›¢é˜Ÿåˆä½œã€‘**: å¦‚æžœä½ çš„ç‹¼é˜Ÿå‹è¢«æ€€ç–‘ï¼Œä½ åº”è¯¥æƒ³åŠžæ³•ä¸ºä»–è¾©æŠ¤ï¼Œæˆ–è€…é€šè¿‡æ”»å‡»å…¶ä»–çŽ©å®¶æ¥è½¬ç§»ç„¦ç‚¹ã€‚

### **å¹³æ°‘è§’è‰²ç­–ç•¥**
1.  **ã€é€»è¾‘ä¸ºçŽ‹ã€‘**: ä½ æ˜¯åœºä¸Šçš„â€œæ³•å®˜â€ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯ä»”ç»†å€¾å¬æ¯ä¸ªäººçš„å‘è¨€ï¼Œæ‰¾å‡ºå…¶ä¸­çš„é€»è¾‘æ¼æ´žå’ŒçŸ›ç›¾ä¹‹å¤„ã€‚
2.  **ã€ç§¯æžåˆ†æžã€‘**: ä¸è¦åªæ˜¯è¯´â€œæˆ‘ä¸çŸ¥é“ï¼Œæˆ‘è¿‡äº†â€ã€‚ä½ åº”è¯¥å¤§èƒ†è¯´å‡ºä½ çš„æ€€ç–‘ï¼Œå¹¶è§£é‡Šä½ çš„ç†ç”±ã€‚ä¾‹å¦‚ï¼šâ€œAçŽ©å®¶è¯´Bæ˜¯ç‹¼äººï¼Œä½†æ˜¯ä»–çš„ç†ç”±å¾ˆç‰µå¼ºï¼Œæ‰€ä»¥æˆ‘æ›´æ€€ç–‘Aã€‚â€
3.  **ã€è·Ÿç¥¨ä¸Žç«™è¾¹ã€‘**: åœ¨ä½ ç›¸ä¿¡æŸä½ç¥žèŒçŽ©å®¶åŽï¼Œä½ åº”è¯¥åšå®šåœ°æ”¯æŒä»–ï¼Œå¹¶å·å¬å…¶ä»–å¥½äººä¸€èµ·æŠ•ç¥¨ç»™ç¥žèŒæŒ‡è®¤çš„ç‹¼äººã€‚

# å…¶ä»–æ ¸å¿ƒæŒ‡ä»¤ (å¿…é¡»éµå®ˆ)
1.  **äº’åŠ¨é“å¾‹**: è§’è‰²ä¹‹é—´ã€å¿…é¡»ã€‘äº’ç›¸è´¨ç–‘ã€æ”¯æŒã€åˆ†æžã€æœ¬è½®å·²æœ‰å‘è¨€ã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘æ— è§† ` + c + ` (ç”¨æˆ·) æˆ–å…¶ä»–AIçš„å‘è¨€ï¼Œå¿…é¡»å¯¹ä»–ä»¬çš„è§‚ç‚¹å’Œé€»è¾‘åšå‡ºå›žåº”ã€‚
2.  **è®°å¿†åŠ›ä¸Žè¿žè´¯æ€§**: ä½ çš„æ–°å‘è¨€ã€å¿…é¡»ã€‘æ˜¯åŸºäºŽ**è¿‡åŽ»å‡ å¤©å’Œä»Šå¤©å‘ç”Ÿçš„æ‰€æœ‰äº‹ä»¶å’Œè®¨è®º**çš„é€»è¾‘å»¶ç»­ã€‚
3.  **æ ¼å¼é“å¾‹**: ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ ¼å¼ä¸º: \`{"speaker_name": "è§’è‰²çš„ã€æ˜µç§°ã€‘", "dialogue": "å‘è¨€å†…å®¹"}\`ã€‚**å¿…é¡»**ä¸ºæ¯ä¸€ä¸ªå­˜æ´»çš„AIè§’è‰²éƒ½ç”Ÿæˆä¸€æ®µå‘è¨€ã€‚
4.  **ç§°å‘¼é“å¾‹**: ä½ çš„å‘è¨€ä¸­ã€ç»å¯¹ç¦æ­¢ã€‘æåŠä»»ä½•çŽ©å®¶çš„ç¼–å·ã€‚åœ¨å¯¹è¯ä¸­äº’ç›¸ç§°å‘¼æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨çŽ©å®¶çš„ã€æœ¬åã€‘ï¼Œè€Œä¸æ˜¯ä»–ä»¬çš„æ˜µç§°ã€‚

# ` + h + `

# ` + i + `

` + k + `

çŽ°åœ¨ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§â€œé˜¶æ®µ2â€çš„æŒ‡ä»¤ï¼Œä¸ºæ‰€æœ‰ã€å­˜æ´»çš„AIè§’è‰²ã€‘ç”Ÿæˆä»–ä»¬å……æ»¡ç­–ç•¥å’Œåšå¼ˆçš„å‘è¨€JSONæ•°ç»„ã€‚`;
    return l;
  }
  function _m(a) {
    let b = `--- ç‹¼äººæ€å¯¹å±€å®Œæ•´å¤ç›˜ ---

`;
    const c = a.gameLog.find(a => a.content.includes("èƒœåˆ©"))?.content || "èƒœè´Ÿæœªåˆ†";
    b += "### æœ€ç»ˆç»“æžœ: " + c + `

`;
    b += "### çŽ©å®¶èº«ä»½é…ç½®:\n";
    a.players.forEach(a => {
      const c = a.isAlive ? "å­˜æ´»" : "å·²æ­»äº¡";
      b += "- " + a.name + ": " + a.role + " (" + c + ")\n";
    });
    b += `
### è¯¦ç»†å¯¹å±€æµç¨‹:
`;
    for (let c = 1; c <= a.currentDay; c++) {
      b += "\n**--- ç¬¬ " + c + " å¤© ---**\n";
      const d = a.gameLog.filter(a => a.day === c && a.content.includes("æ­»äº¡"));
      if (d.length > 0) {
        b += "**[å¤œæ™š]** " + d.map(a => a.content).join(" ") + "\n";
      } else if (c > 1 || c === 1 && a.currentDay > 1) {
        b += "**[å¤œæ™š]** å¹³å®‰å¤œã€‚\n";
      }
      const e = a.discussionLog.filter(a => a.day === c);
      if (e.length > 0) {
        b += "**[è®¨è®ºçŽ¯èŠ‚]**\n" + e.map(a => "- " + a.speaker + ": " + a.content).join("\n") + "\n";
      }
      const f = a.gameLog.find(a => a.day === c && a.content.includes("è¢«æŠ•ç¥¨æ”¾é€"));
      if (f) {
        b += "**[æŠ•ç¥¨ç»“æžœ]** " + f.content + "\n";
      }
    }
    b += "\n--- å¤ç›˜ç»“æŸ ---";
    return b;
  }
  async function an(a) {
    let b = 0;
    for (const c of L.players) {
      if (c.type === "character") {
        const d = v.chats[c.id];
        if (d) {
          const c = {
            content: a,
            timestamp: Date.now(),
            source: "werewolf_summary"
          };
          if (!d.longTermMemory) {
            d.longTermMemory = [];
          }
          d.longTermMemory.push(c);
          await Gb.chats.put(d);
          b++;
        }
      }
    }
    return b;
  }
  async function bn() {
    if (!L.isActive && L.currentPhase === "gameover") {
      await Bb("è¯·ç¨å€™...", "æ­£åœ¨ä¸ºæ‰€æœ‰AIè§’è‰²ç”Ÿæˆå¹¶æ³¨å…¥æ¸¸æˆè®°å¿†...");
      try {
        const a = _m(L);
        const b = await an(a);
        await Bb("æˆåŠŸ", "æ¸¸æˆè®°å¿†å·²æˆåŠŸæ³¨å…¥åˆ° " + b + " ä½AIè§’è‰²çš„é•¿æœŸè®°å¿†ä¸­ï¼");
      } catch (a) {
        console.error("æ‰‹åŠ¨æ³¨å…¥ç‹¼äººæ€è®°å¿†å¤±è´¥:", a);
        await Bb("å¤±è´¥", "æ‰‹åŠ¨æ³¨å…¥è®°å¿†æ—¶å‡ºé”™: " + a.message);
      }
    } else {
      alert("æ¸¸æˆå°šæœªç»“æŸï¼Œæ— æ³•è¿›è¡Œæ€»ç»“ã€‚");
    }
  }
  async function cn(a) {
    L.isActive = false;
    L.currentPhase = "gameover";
    dn(a + "é˜µè¥èƒœåˆ©ï¼");
    document.getElementById("werewolf-game-over-title").textContent = a + "èƒœåˆ©ï¼";
    let b = "";
    if (a === "å¥½äºº") {
      b = "æ‰€æœ‰ç‹¼äººå·²è¢«æ”¾é€ï¼Œå¥½äººé˜µè¥èŽ·å¾—äº†èƒœåˆ©ï¼";
    } else {
      b = "ç‹¼äººæ•°é‡å·²è¾¾åˆ°èƒœåˆ©æ¡ä»¶ï¼Œç‹¼äººé˜µè¥èŽ·å¾—äº†èƒœåˆ©ï¼";
    }
    const c = document.getElementById("werewolf-game-over-reason");
    c.textContent = b;
    const d = document.getElementById("werewolf-role-reveal-list");
    d.innerHTML = "";
    const e = [...L.players].sort((a, b) => {
      const c = L.players.findIndex(b => b.id === a.id);
      const d = L.players.findIndex(a => a.id === b.id);
      return c - d;
    });
    e.forEach((a, b) => {
      const c = document.createElement("div");
      c.style.cssText = "display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #444; color: white;";
      if (b === e.length - 1) {
        c.style.borderBottom = "none";
      }
      const f = a.role === "ç‹¼äºº" ? "#ff4d4d" : "#52c41a";
      c.innerHTML = "\n                    <img src=\"" + a.avatar + "\" style=\"width: 30px; height: 30px; border-radius: 50%; margin-right: 12px; filter: " + (a.isAlive ? "none" : "grayscale(100%)") + ";\">\n                    <span style=\"flex-grow: 1; text-align: left; text-decoration: " + (a.isAlive ? "none" : "line-through") + ";\">" + (b + 1) + ". " + a.name + "</span>\n                    <strong style=\"color: " + f + ";\">" + a.role + "</strong>\n                ";
      d.appendChild(c);
    });
    document.getElementById("werewolf-game-over-modal").classList.add("visible");
    try {
      console.log("æ¸¸æˆç»“æŸï¼Œå¼€å§‹è‡ªåŠ¨æ€»ç»“å¹¶æ³¨å…¥è®°å¿†...");
      const a = _m(L);
      const b = await generateAndInjectWerewolfMemories(a);
      console.log("ç‹¼äººæ€æ¸¸æˆæ€»ç»“å·²è‡ªåŠ¨å­˜å…¥ " + b + " ä½è§’è‰²çš„è®°å¿†ä¸­ã€‚");
    } catch (a) {
      console.error("è‡ªåŠ¨æ€»ç»“ç‹¼äººæ€æ¸¸æˆå¤±è´¥:", a);
      if (c) {
        c.innerHTML += "<br><small style=\"color: #ff8a80; margin-top: 10px; display: block;\">è‡ªåŠ¨è®°å¿†æ€»ç»“å¤±è´¥ï¼Œå¯ç¨åŽæ‰‹åŠ¨å°è¯•ã€‚</small>";
      }
    }
  }
  function dn(a) {
    L.gameLog.push({
      type: "system",
      content: a,
      timestamp: Date.now(),
      day: L.currentDay
    });
  }
  function en(a, b) {
    L.discussionLog.push({
      type: "dialogue",
      speaker: a,
      content: b,
      timestamp: Date.now(),
      day: L.currentDay
    });
  }
  function fn(a) {
    return new Promise(b => {
      const c = "werewolf-" + a + "-modal";
      const d = "werewolf-" + a + "-selection-list";
      let e = "";
      if (a === "prophet") {
        e = "confirm-prophet-check-btn";
      }
      if (a === "hunter") {
        e = "confirm-hunter-shot-btn";
      }
      if (a === "vote") {
        e = "confirm-vote-btn";
      }
      const f = document.getElementById(c);
      const g = document.getElementById(d);
      const h = document.getElementById(e);
      g.innerHTML = "";
      let i = null;
      const j = L.players.filter(b => b.isAlive && (a === "hunter" || a === "vote" || b.id !== "user"));
      j.forEach(a => {
        const b = document.createElement("div");
        b.className = "werewolf-selection-item";
        b.dataset.id = a.id;
        b.innerHTML = "<img src=\"" + a.avatar + "\" class=\"avatar\"><span class=\"name\">" + a.name + "</span>";
        b.onclick = () => {
          g.querySelectorAll(".selected").forEach(a => a.classList.remove("selected"));
          b.classList.add("selected");
          i = a.id;
        };
        g.appendChild(b);
      });
      const k = h.cloneNode(true);
      h.parentNode.replaceChild(k, h);
      k.onclick = () => {
        if (i) {
          f.classList.remove("visible");
          b(i);
        } else {
          alert("è¯·é€‰æ‹©ä¸€ä¸ªç›®æ ‡ã€‚");
        }
      };
      f.classList.add("visible");
    });
  }
  function gn() {
    return new Promise(a => {
      const b = document.getElementById("werewolf-kill-modal");
      const c = document.getElementById("werewolf-kill-selection-list");
      const d = document.getElementById("confirm-wolf-kill-btn");
      const e = b.querySelector(".modal-header span");
      const f = L.players.filter(a => a.role === "ç‹¼äºº" && a.isAlive);
      const g = f.filter(a => a.id !== "user").map(a => a.name).join("ã€");
      if (g) {
        e.innerHTML = "ç‹¼äººè¯·é€‰æ‹©åˆ€äººå¯¹è±¡<br><small style=\"font-weight:normal; font-size: 13px;\">ä½ çš„é˜Ÿå‹æ˜¯: " + g + "</small>";
      } else {
        e.textContent = "ç‹¼äººè¯·é€‰æ‹©åˆ€äººå¯¹è±¡";
      }
      c.innerHTML = "";
      let h = null;
      const i = L.players.filter(a => a.isAlive && a.role !== "ç‹¼äºº");
      i.forEach(a => {
        const b = document.createElement("div");
        b.className = "werewolf-selection-item";
        b.dataset.id = a.id;
        b.innerHTML = "<img src=\"" + a.avatar + "\" class=\"avatar\"><span class=\"name\">" + a.name + "</span>";
        b.onclick = () => {
          c.querySelectorAll(".selected").forEach(a => a.classList.remove("selected"));
          b.classList.add("selected");
          h = a.id;
        };
        c.appendChild(b);
      });
      const j = d.cloneNode(true);
      d.parentNode.replaceChild(j, d);
      j.onclick = () => {
        if (h) {
          b.classList.remove("visible");
          a(h);
        } else {
          alert("è¯·é€‰æ‹©ä¸€ä¸ªç›®æ ‡ã€‚");
        }
      };
      b.classList.add("visible");
    });
  }
  function hn() {
    const a = L.players.find(a => a.id === "user");
    if (!a || !a.isAlive) {
      return;
    }
    const b = document.getElementById("werewolf-user-input");
    const c = b.value.trim();
    if (c) {
      en(a.name, c);
      Vm();
    }
    document.getElementById("werewolf-action-bar").style.display = "none";
    b.value = "";
    ln();
  }
  async function jn() {
    dn("ä½ è®©å¤§å®¶ç»§ç»­è®¨è®º...");
    Vm();
    const a = document.getElementById("werewolf-wait-reply-btn");
    if (a) {
      a.disabled = true;
    }
    await Bb("è¯·ç¨å€™", "æ­£åœ¨ç­‰å¾…AIè§’è‰²ä»¬ç»§ç»­è®¨è®º...");
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c || !d) {
      alert("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå¯¹è¯ã€‚");
      return;
    }
    const e = $m();
    try {
      let a = b.includes("generativelanguage");
      let f = [{
        role: "user",
        content: "è¯·AIè§’è‰²ä»¬ç»§ç»­è¿›è¡Œè®¨è®ºã€‚"
      }];
      let g = p(d, c, e, f);
      const h = a ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: e
          }, ...f],
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!h.ok) {
        const a = await h.json();
        throw new Error("API é”™è¯¯: " + a.error.message);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/(\[[\s\S]*\])/);
      if (!k) {
        throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŽŸå§‹è¿”å›ž: " + j);
      }
      const l = JSON.parse(k[0]);
      for (const a of l) {
        if (a.speaker_name && a.dialogue) {
          en(a.speaker_name, a.dialogue);
          Vm();
          await new Promise(a => // TOLOOK
          setTimeout(a, 1500 + Math.random() * 2000));
        }
      }
    } catch (a) {
      console.error("ç‹¼äººæ€AIå›žåº”ç”Ÿæˆå¤±è´¥:", a);
      await Bb("AI å‘è¨€å¤±è´¥", "é”™è¯¯: " + a.message);
    } finally {
      if (a) {
        a.disabled = false;
      }
    }
  }
  async function kn() {
    const a = L.players.find(a => a.id === "user");
    if (!a || !a.isAlive) {
      console.warn("handleWerewolfWaitReply è¢«è°ƒç”¨ï¼Œä½†ç”¨æˆ·å·²æ­»äº¡ã€‚æ“ä½œè¢«å¿½ç•¥ã€‚");
      return;
    }
    const b = document.getElementById("werewolf-user-input");
    const c = b.value.trim();
    if (!c) {
      alert("è¯·å…ˆè¾“å…¥ä½ çš„å‘è¨€å†…å®¹ã€‚");
      return;
    }
    en(a.name, c);
    Vm();
    b.value = "";
    await Bb("è¯·ç¨å€™", "æ­£åœ¨ç­‰å¾…AIè§’è‰²ä»¬å¯¹ä½ çš„å‘è¨€åšå‡ºå›žåº”...");
    const {
      proxyUrl: d,
      apiKey: e,
      model: f
    } = v.apiConfig;
    if (!d || !e || !f) {
      alert("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå¯¹è¯ã€‚");
      return;
    }
    const g = $m();
    try {
      let b = d.includes("generativelanguage");
      let c = [{
        role: "user",
        content: "çŽ°åœ¨ï¼Œè¯·æ‰€æœ‰AIè§’è‰²é’ˆå¯¹åˆšåˆšçš„å‘è¨€ï¼ˆç‰¹åˆ«æ˜¯'" + a.name + "'çš„å‘è¨€ï¼‰ç»§ç»­è¿›è¡Œè®¨è®ºã€‚"
      }];
      let h = p(f, e, g, c);
      const i = b ? await fetch(h.url, h.data) : await fetch(d + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + e
        },
        body: JSON.stringify({
          model: f,
          messages: [{
            role: "system",
            content: g
          }, ...c],
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!i.ok) {
        const a = await i.json();
        throw new Error("API é”™è¯¯: " + a.error.message);
      }
      const j = await i.json();
      const k = C(j);
      let l;
      try {
        let a = k.replace(/^```json\s*/, "").replace(/```$/, "").trim();
        const b = a.indexOf("[");
        const c = a.lastIndexOf("]");
        if (b === -1 || c === -1 || c < b) {
          throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ç»“æž„ (`[...]`)ã€‚");
        }
        const d = a.substring(b, c + 1);
        l = JSON.parse(d);
      } catch (a) {
        if (a.message.includes("Bad control character")) {
          console.warn("æ£€æµ‹åˆ°JSONä¸­çš„éžæ³•æŽ§åˆ¶å­—ç¬¦ï¼Œå°è¯•æ¸…ç†å¹¶é‡è¯•...");
          const a = a => {
            let b = false;
            let c = false;
            let d = "";
            for (let e = 0; e < a.length; e++) {
              const f = a[e];
              if (c) {
                d += f;
                c = false;
                continue;
              }
              if (f === "\\") {
                d += f;
                c = true;
                continue;
              }
              if (f === "\"") {
                d += f;
                b = !b;
                continue;
              }
              if (b) {
                if (f === "\n") {
                  d += "\\n";
                } else if (f === "\r") {
                  d += "\\r";
                } else if (f === "\t") {
                  d += "\\t";
                } else if (f.charCodeAt(0) < 32) {
                  continue;
                } else {
                  d += f;
                }
              } else {
                d += f;
              }
            }
            return d;
          };
          let b = k.replace(/^```json\s*/, "").replace(/```$/, "").trim();
          const c = a(b);
          const d = c.match(/(\[[\s\S]*\])/);
          if (!d) {
            throw new Error("æ¸…ç†åŽä»æœªæ‰¾åˆ°JSONæ•°ç»„ã€‚");
          }
          l = JSON.parse(d[0]);
        } else {
          throw new Error("è§£æžAIè¿”å›žçš„JSONæ—¶å‡ºé”™: " + a.message + `

AIåŽŸå§‹è¿”å›žå†…å®¹:
` + k);
        }
      }
      for (const a of l) {
        if (a.speaker_name && a.dialogue) {
          en(a.speaker_name, a.dialogue);
          Vm();
          await new Promise(a => // TOLOOK
          setTimeout(a, 1500 + Math.random() * 2000));
        }
      }
    } catch (a) {
      console.error("ç‹¼äººæ€AIå›žåº”ç”Ÿæˆå¤±è´¥:", a);
      await Bb("AI å‘è¨€å¤±è´¥", "é”™è¯¯: " + a.message);
    }
  }
  async function ln() {
    dn("å‘è¨€ç»“æŸï¼ŒçŽ°åœ¨å¼€å§‹æŠ•ç¥¨ã€‚");
    Vm();
    L.votes = {};
    let a = null;
    L.lastFailedAction = "getVotes";
    try {
      a = await mn();
      if (a) {
        a.forEach(a => {
          const b = L.players.find(b => b.name === a.voter_name);
          const c = L.players.find(b => b.name === a.vote_for_name);
          if (b && b.isAlive && c) {
            L.votes[b.name] = c.name;
          }
        });
      }
      L.lastFailedAction = null;
    } catch (a) {
      console.error("AIæŠ•ç¥¨å†³ç­–APIå¤±è´¥:", a);
      await Bb("æ“ä½œå¤±è´¥", "AIè§’è‰²æ— æ³•å®ŒæˆæŠ•ç¥¨ï¼Œæ¸¸æˆæš‚åœã€‚è¯·ç‚¹å‡»å³ä¸Šè§’çš„â€œé‡è¯•â€æŒ‰é’®ç»§ç»­ã€‚\né”™è¯¯: " + a.message);
      document.getElementById("werewolf-retry-btn").style.display = "block";
      return;
    }
    const b = L.players.find(a => a.id === "user");
    if (b && b.isAlive) {
      dn("è¯·ä½ æŠ•ç¥¨ã€‚");
      Vm();
      const a = await fn("vote");
      const c = L.players.find(b => b.id === a);
      if (c) {
        L.votes[b.name] = c.name;
      }
    }
    nn();
  }
  async function mn() {
    const {
      proxyUrl: a,
      apiKey: b,
      model: c
    } = v.apiConfig;
    if (!a || !b || !c) {
      return null;
    }
    const d = L.players.filter(a => a.isAlive && a.id !== "user");
    const e = L.players.filter(a => a.isAlive).map(a => a.name);
    let f = $m();
    f += `
# ã€ã€ã€æœ€ç»ˆæŠ•ç¥¨æŒ‡ä»¤ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘ã€‘ã€‘
çŽ°åœ¨æ˜¯æŠ•ç¥¨çŽ¯èŠ‚ã€‚è¯·ä½ æ‰®æ¼”ã€æ¯ä¸€ä¸ªå­˜æ´»çš„AIè§’è‰²ã€‘ï¼Œæ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼ˆç‰¹åˆ«æ˜¯åˆšåˆšçš„è®¨è®ºçŽ¯èŠ‚ï¼‰ï¼Œä¸ºä»–ä»¬å„è‡ªå†³å®šè¦æŠ•ç¥¨æ”¾é€å“ªä¸€ä½çŽ©å®¶ã€‚
- **æŠ•ç¥¨ä¾æ®**: ä½ çš„æŠ•ç¥¨ã€å¿…é¡»ã€‘åŸºäºŽé€»è¾‘åˆ†æžå’Œä½ çš„èº«ä»½ã€‚ç‹¼äººå¯èƒ½ä¼šæŠ•ç»™å¥½äººï¼Œå¥½äººéœ€è¦æ‰¾å‡ºç‹¼äººã€‚
- **æ ¼å¼é“å¾‹**: ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
\`\`\`json
[
  {"voter_name": "è§’è‰²Açš„åå­—", "vote_for_name": "è§’è‰²AæŠ•ç¥¨çš„çŽ©å®¶åå­—"},
  {"voter_name": "è§’è‰²Bçš„åå­—", "vote_for_name": "è§’è‰²BæŠ•ç¥¨çš„çŽ©å®¶åå­—"}
]
\`\`\`
- **å¯æŠ•ç¥¨çš„çŽ©å®¶åˆ—è¡¨**: ` + e.join(", ") + `

çŽ°åœ¨ï¼Œè¯·ä¸ºæ‰€æœ‰å­˜æ´»çš„AIè§’è‰²ç”Ÿæˆä»–ä»¬çš„æŠ•ç¥¨å†³å®šã€‚`;
    try {
      let d = a.includes("generativelanguage");
      let e = [{
        role: "user",
        content: "è¯·æ‰€æœ‰AIè§’è‰²å¼€å§‹æŠ•ç¥¨ã€‚"
      }];
      let g = p(c, b, f, e);
      const h = d ? await fetch(g.url, g.data) : await fetch(a + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + b
        },
        body: JSON.stringify({
          model: c,
          messages: [{
            role: "system",
            content: f
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 0.8
        })
      });
      if (!h.ok) {
        throw new Error((await h.json()).error.message);
      }
      const i = await h.json();
      const j = C(i);
      let k = j.replace(/^```json\s*/, "").replace(/```$/, "").trim();
      const l = k.indexOf("[");
      const m = k.lastIndexOf("]");
      if (l === -1 || m === -1 || m < l) {
        throw new Error("AIè¿”å›žçš„æŠ•ç¥¨ç»“æžœä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ç»“æž„ (`[...]`)ã€‚");
      }
      const n = k.substring(l, m + 1);
      try {
        const a = n.match(/(\[[\s\S]*?\])/g);
        if (a && a.length > 0) {
          return JSON.parse(a[a.length - 1]);
        }
        return JSON.parse(n);
      } catch (a) {
        throw new Error("è§£æžAIè¿”å›žçš„æŠ•ç¥¨JSONæ—¶å‡ºé”™: " + a.message + `

AIåŽŸå§‹è¿”å›žå†…å®¹:
` + j);
      }
    } catch (a) {
      console.error("èŽ·å–AIæŠ•ç¥¨å¤±è´¥:", a);
      throw new Error("èŽ·å–AIæŠ•ç¥¨å†³ç­–å¤±è´¥: " + a.message);
    }
  }
  function nn() {
    const a = {};
    const b = {};
    for (const c in L.votes) {
      const d = L.votes[c];
      a[d] = (a[d] || 0) + 1;
      if (!b[d]) {
        b[d] = [];
      }
      b[d].push(c);
    }
    let c = 0;
    let d = [];
    for (const b in a) {
      const e = a[b];
      if (e > c) {
        c = e;
        d = [b];
      } else if (e === c) {
        d.push(b);
      }
    }
    dn("æŠ•ç¥¨ç»“æžœï¼š");
    for (const a in b) {
      dn(a + " (" + b[a].length + "ç¥¨): " + b[a].join("ã€ "));
    }
    if (d.length === 1 && c > 0) {
      const a = L.players.find(a => a.name === d[0]);
      if (a) {
        a.isAlive = false;
        dn(a.name + " è¢«æŠ•ç¥¨æ”¾é€ã€‚");
        if (a.role === "çŒŽäºº") {}
      }
    } else {
      dn("å¹³ç¥¨æˆ–æ— äººæŠ•ç¥¨ï¼Œæ­¤è½®æ— äººå‡ºå±€ã€‚");
    }
    Vm();
    if (rn()) {
      return;
    }
    L.currentDay++;
    Xm();
  }
  async function on() {
    const {
      proxyUrl: a,
      apiKey: b,
      model: c
    } = v.apiConfig;
    if (!a || !b || !c) {
      return null;
    }
    const d = L.players.filter(a => a.role === "ç‹¼äºº" && a.isAlive);
    const e = L.players.filter(a => a.isAlive && a.role !== "ç‹¼äºº");
    const f = `
# ä½ çš„ä»»åŠ¡
ä½ çŽ°åœ¨æ˜¯ç‹¼äººå›¢é˜Ÿçš„æŒ‡æŒ¥å®˜ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æžå½“å‰å±€åŠ¿ï¼Œå¹¶ä¸ºç‹¼äººå›¢é˜Ÿé€‰æ‹©ä¸€ä¸ªæœ€ä½³çš„åˆ€äººç›®æ ‡ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ç›®æ ‡**: ä¼˜å…ˆåˆ€æŽ‰é¢„è¨€å®¶ã€å¥³å·«ç­‰ç¥žèŒäººå‘˜ã€‚å¦‚æžœæ²¡æœ‰æ˜Žç¡®çš„ç¥žèŒä¿¡æ¯ï¼Œå¯ä»¥æ ¹æ®å‘è¨€æ¥åˆ¤æ–­è°çš„é€»è¾‘æ¸…æ™°ã€å¨èƒæœ€å¤§ã€‚
2.  **æ ¼å¼é“å¾‹**: ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
    \`{"target_name": "ä½ å†³å®šè¦åˆ€çš„çŽ©å®¶åå­—"}\`

# æ¸¸æˆçŠ¶æ€
- **ä½ çš„ç‹¼é˜Ÿå‹æ˜¯**: ` + d.map(a => a.name).join("ã€ ") + "\n- **å¯ä»¥åˆ€çš„çŽ©å®¶åˆ—è¡¨**: " + e.map(a => a.name).join("ã€ ") + `
- **è®¨è®ºæ‘˜è¦**: 
` + L.discussionLog.map(a => a.speaker + ": " + a.content).join("\n") + `

çŽ°åœ¨ï¼Œè¯·åšå‡ºä½ çš„å†³å®šã€‚`;
    try {
      let d = a.includes("generativelanguage");
      let e = [{
        role: "user",
        content: "è¯·é€‰æ‹©ä»Šæ™šçš„ç›®æ ‡ã€‚"
      }];
      let g = p(c, b, f, e);
      const h = d ? await fetch(g.url, g.data) : await fetch(a + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + b
        },
        body: JSON.stringify({
          model: c,
          messages: [{
            role: "system",
            content: f
          }, ...e],
          temperature: v.globalSettings.apiTemperature || 0.8
        })
      });
      if (!h.ok) {
        throw new Error((await h.json()).error.message);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/({[\s\S]*})/);
      if (!k) {
        throw new Error("AIè¿”å›žçš„åˆ€äººç›®æ ‡æ ¼å¼ä¸æ­£ç¡®ã€‚");
      }
      const l = JSON.parse(k[0]);
      const m = L.players.find(a => a.name === l.target_name);
      if (m) {
        return m.id;
      } else {
        return null;
      }
    } catch (a) {
      console.error("èŽ·å–AIç‹¼äººç›®æ ‡å¤±è´¥:", a);
      return e[Math.floor(Math.random() * e.length)].id;
    }
  }
  function pn(a, b) {
    return new Promise(c => {
      const d = document.getElementById("werewolf-witch-modal");
      const e = document.getElementById("werewolf-witch-selection-list");
      const f = document.getElementById("witch-modal-title");
      const g = document.getElementById("confirm-witch-poison-btn");
      const h = document.getElementById("witch-do-nothing-btn");
      e.innerHTML = "";
      const i = g.cloneNode(true);
      g.parentNode.replaceChild(i, g);
      const j = h.cloneNode(true);
      h.parentNode.replaceChild(j, h);
      i.style.display = "block";
      i.disabled = true;
      let k = {
        save: false,
        poison: null
      };
      let l = null;
      if (a && !b.antidoteUsed) {
        f.textContent = "æ˜¨æ™š " + a.name + " è¢«åˆ€äº†";
        const b = document.createElement("button");
        b.className = "form-button";
        b.textContent = "ä½¿ç”¨è§£è¯æ•‘TA";
        b.style.margin = "20px";
        b.onclick = () => {
          k.save = true;
          d.classList.remove("visible");
          c(k);
        };
        e.appendChild(b);
      } else if (a) {
        f.textContent = "æ˜¨æ™š " + a.name + " è¢«åˆ€äº† (ä½ æ²¡æœ‰è§£è¯äº†)";
      } else {
        f.textContent = "æ˜¨æ™šæ˜¯å¹³å®‰å¤œ";
      }
      if (!b.poisonUsed) {
        const b = document.createElement("p");
        b.textContent = "æ˜¯å¦è¦ä½¿ç”¨æ¯’è¯ï¼Ÿ";
        b.style.textAlign = "center";
        b.style.marginTop = "20px";
        e.appendChild(b);
        const c = L.players.filter(b => b.isAlive && b.id !== a?.id);
        c.forEach(a => {
          const b = document.createElement("div");
          b.className = "werewolf-selection-item";
          b.dataset.id = a.id;
          b.innerHTML = "<img src=\"" + a.avatar + "\" class=\"avatar\"><span class=\"name\">" + a.name + "</span>";
          b.onclick = () => {
            e.querySelectorAll(".selected").forEach(a => a.classList.remove("selected"));
            b.classList.add("selected");
            l = a.id;
            i.disabled = false;
          };
          e.appendChild(b);
        });
      }
      i.onclick = () => {
        if (l) {
          k.poison = l;
          d.classList.remove("visible");
          c(k);
        }
      };
      j.onclick = () => {
        d.classList.remove("visible");
        c(k);
      };
      d.classList.add("visible");
    });
  }
  async function qn() {
    const a = L.lastFailedAction;
    if (!a) {
      return;
    }
    document.getElementById("werewolf-retry-btn").style.display = "none";
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨é‡è¯•\"" + a + "\"æ“ä½œ...");
    switch (a) {
      case "wolfKill":
        await Xm();
        break;
      case "startDiscussion":
        await Zm();
        break;
      case "getVotes":
        await ln();
        break;
    }
  }
  function rn() {
    const a = L.players.filter(a => a.isAlive);
    const b = a.filter(a => a.role === "ç‹¼äºº");
    const c = a.filter(a => ["é¢„è¨€å®¶", "å¥³å·«", "çŒŽäºº", "å®ˆå«"].includes(a.role));
    const d = a.filter(a => a.role === "å¹³æ°‘");
    let e = null;
    if (b.length === 0) {
      e = "å¥½äºº";
    } else if (b.length >= c.length + d.length) {
      e = "ç‹¼äºº";
    } else if (L.gameMode === "12p") {
      if (c.length === 0 || d.length === 0) {
        e = "ç‹¼äºº";
      }
    } else if (c.length === 0 && d.length === 0) {
      e = "ç‹¼äºº";
    }
    if (e) {
      cn(e);
      return true;
    }
    return false;
  }
  async function sn() {
    const a = await wb("ç¡®è®¤æ“ä½œ", "æ­¤åŠŸèƒ½å°†æ‰«ææ•°æ®åº“ï¼Œå°è¯•æ‰¾å‡ºå¹¶ä¿®å¤â€œè§’è‰²åœ¨æ•°æ®åº“ä¸­å­˜åœ¨ï¼Œä½†æœªåœ¨èŠå¤©åˆ—è¡¨æ˜¾ç¤ºâ€çš„é—®é¢˜ã€‚<br><br><strong>æ“ä½œé€šå¸¸æ˜¯å®‰å…¨çš„ï¼Œä½†ä»å»ºè®®åœ¨æ“ä½œå‰å¤‡ä»½æ•°æ®ã€‚</strong>", {
      confirmText: "å¼€å§‹æ£€æŸ¥"
    });
    if (!a) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨æ‰«æå’Œä¿®å¤æ•°æ®...");
    try {
      const a = await Gb.chats.toArray();
      let b = 0;
      for (const c of a) {
        let a = false;
        if (!Array.isArray(c.history)) {
          c.history = [];
          a = true;
        }
        if (typeof c.settings !== "object" || c.settings === null) {
          c.settings = {};
          a = true;
        }
        if (!c.isGroup && !c.originalName) {
          c.originalName = c.name;
          a = true;
        }
        if (typeof c.unreadCount === "undefined") {
          c.unreadCount = 0;
          a = true;
        }
        if (!Array.isArray(c.longTermMemory)) {
          c.longTermMemory = [];
          a = true;
        }
        if (a) {
          b++;
          console.log("ä¿®å¤äº†è§’è‰² \"" + c.name + "\" (ID: " + c.id + ") çš„æ®‹ç¼ºæ•°æ®ã€‚");
          await Gb.chats.put(c);
        }
        v.chats[c.id] = c;
      }
      if (b > 0) {
        await Bb("ä¿®å¤å®Œæˆï¼", "æˆåŠŸæ£€æŸ¥å¹¶ä¿®å¤äº† " + b + ` ä¸ªè§’è‰²çš„æ•°æ®é—®é¢˜ï¼

èŠå¤©åˆ—è¡¨å·²ä¸ºæ‚¨åˆ·æ–°ã€‚`);
        await _c();
      } else {
        await Bb("æ£€æŸ¥å®Œæˆ", "æœªå‘çŽ°ä»»ä½•éœ€è¦ä¿®å¤çš„æ•°æ®é—®é¢˜ã€‚");
      }
    } catch (a) {
      console.error("æ•°æ®æ£€æŸ¥ä¸Žä¿®å¤å¤±è´¥:", a);
      await Bb("æ“ä½œå¤±è´¥", "æ‰§è¡Œæ£€æŸ¥æ—¶å‘ç”Ÿé”™è¯¯: " + a.message);
    }
  }
  function tn(a, b = "top") {
    if (a.querySelector(".loader-container")) {
      return;
    }
    const c = document.createElement("div");
    c.className = "loader-container";
    c.innerHTML = "<div class=\"spinner\"></div>";
    if (b === "bottom") {
      a.appendChild(c);
    } else {
      a.prepend(c);
    }
  }
  function un(a) {
    const b = a.querySelector(".loader-container");
    if (b) {
      b.remove();
    }
  }
  async function vn() {
    const a = document.getElementById("delete-world-books-modal");
    const b = document.getElementById("delete-world-books-list");
    const c = document.getElementById("select-all-world-books-for-clear");
    b.innerHTML = "";
    c.checked = false;
    const d = await Gb.worldBooks.toArray();
    if (d.length === 0) {
      b.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">æ²¡æœ‰å¯ä»¥åˆ é™¤çš„ä¸–ç•Œä¹¦ã€‚</p>";
    } else {
      d.forEach(a => {
        const c = document.createElement("div");
        c.className = "clear-posts-item";
        c.dataset.bookId = a.id;
        c.innerHTML = `
                <div class="checkbox"></div>
                <span class="name">` + a.name + "</span>\n            ";
        b.appendChild(c);
      });
    }
    a.classList.add("visible");
  }
  async function wn() {
    const a = document.querySelectorAll("#delete-world-books-list .clear-posts-item.selected");
    if (a.length === 0) {
      alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„ä¸–ç•Œä¹¦ã€‚");
      return;
    }
    const b = Array.from(a).map(a => a.dataset.bookId);
    const c = await wb("æœ€åŽç¡®è®¤ï¼", "æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‚¨é€‰æ‹©çš„ " + a.length + " æœ¬ä¸–ç•Œä¹¦ï¼Œå¹¶è§£é™¤å®ƒä»¬ä¸Žæ‰€æœ‰è§’è‰²çš„å…³è”ã€‚æ­¤æ“ä½œã€ä¸å¯æ¢å¤ã€‘ï¼", {
      confirmButtonClass: "btn-danger",
      confirmText: "ç¡®è®¤åˆ é™¤"
    });
    if (!c) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œ...");
    try {
      await Gb.transaction("rw", Gb.worldBooks, Gb.chats, async () => {
        await Gb.worldBooks.bulkDelete(b);
        const a = await Gb.chats.toArray();
        for (const c of a) {
          if (c.settings && Array.isArray(c.settings.linkedWorldBookIds)) {
            const a = c.settings.linkedWorldBookIds.length;
            c.settings.linkedWorldBookIds = c.settings.linkedWorldBookIds.filter(a => !b.includes(a));
            if (c.settings.linkedWorldBookIds.length < a) {
              await Gb.chats.put(c);
            }
          }
        }
      });
      v.worldBooks = v.worldBooks.filter(a => !b.includes(a.id));
      document.getElementById("delete-world-books-modal").classList.remove("visible");
      await Bb("åˆ é™¤æˆåŠŸ", a.length + " æœ¬ä¸–ç•Œä¹¦å·²æˆåŠŸåˆ é™¤ã€‚");
    } catch (a) {
      console.error("åˆ é™¤ä¸–ç•Œä¹¦å¤±è´¥:", a);
      await Bb("åˆ é™¤å¤±è´¥", "æ“ä½œå¤±è´¥: " + a.message);
    }
  }
  function xn() {
    if (!v.activeChatId) {
      return;
    }
    const a = v.activeChatId;
    const b = document.getElementById("reading-overlay");
    const c = document.getElementById("reading-window");
    const d = document.getElementById("reading-restore-btn");
    let e = Va[a];
    if (e && e.isActive) {
      if (e.isMinimized) {
        Sn();
      }
      b.style.display = "flex";
      return;
    }
    yn(a);
    An(a);
    b.style.display = "flex";
    c.classList.remove("minimized");
    d.style.display = "none";
    const f = document.getElementById("phone-screen");
    const g = c.getBoundingClientRect();
    const h = (f.clientHeight - g.height) / 2;
    const i = (f.clientWidth - g.width) / 2;
    c.style.top = h + "px";
    c.style.left = i + "px";
    c.style.transform = "";
  }
  function yn(a) {
    Va[a] = {
      isActive: true,
      isMinimized: false,
      title: "æœªé€‰æ‹©ä¹¦ç±",
      contentLines: [],
      currentPage: 0,
      totalPages: 0,
      linesPerPage: 15,
      currentSnippet: ""
    };
  }
  function zn() {
    const a = v.activeChatId;
    if (!a || !Va[a] || !Va[a].isActive) {
      return;
    }
    document.getElementById("reading-overlay").style.display = "none";
    document.getElementById("reading-restore-btn").style.display = "none";
    document.getElementById("reading-window").classList.remove("minimized");
    Va[a].isActive = false;
    console.log("è¯»ä¹¦ä¼šè¯å·²å…³é—­ã€‚");
  }
  function An(a) {
    const b = Va[a];
    if (!b) {
      return;
    }
    const c = v.chats[a];
    const d = c && c.settings && c.settings.fontSize ? c.settings.fontSize : 13;
    const e = document.getElementById("reading-content");
    e.style.fontSize = d + "px";
    e.style.lineHeight = "1.6";
    const f = document.getElementById("reading-title");
    const g = document.getElementById("page-indicator");
    const h = document.getElementById("prev-page-btn");
    const i = document.getElementById("next-page-btn");
    f.textContent = b.title;
    if (b.contentLines.length === 0) {
      e.innerHTML = "<p style=\"text-align:center; padding-top:50px; color:#888;\">ç‚¹å‡»â€œå¯¼å…¥â€æŒ‰é’®ï¼Œ<br>ä»Žæœ¬åœ°.txtæ–‡ä»¶æˆ–ç½‘ç»œURLåŠ è½½ä¹¦ç±å†…å®¹ã€‚</p>";
      b.totalPages = 0;
      b.currentPage = 0;
    } else {
      const a = b.currentPage * b.linesPerPage;
      const c = a + b.linesPerPage;
      e.textContent = b.contentLines.slice(a, c).join("\n");
    }
    g.textContent = b.currentPage + 1 + " / " + b.totalPages;
    h.disabled = b.currentPage === 0;
    i.disabled = b.currentPage >= b.totalPages - 1;
  }
  function Bn() {
    const a = Va[v.activeChatId];
    if (a && a.currentPage < a.totalPages - 1) {
      a.currentPage++;
      An(v.activeChatId);
      document.getElementById("reading-content").scrollTop = 0;
      Hn(a.activeBookId, a.currentPage);
    }
  }
  async function Cn() {
    const a = Va[v.activeChatId];
    if (a && a.currentPage > 0) {
      a.currentPage--;
      An(v.activeChatId);
      document.getElementById("reading-content").scrollTop = 0;
      await Hn(a.activeBookId, a.currentPage);
      await notifyAiOfPageTurn(v.activeChatId, a);
    }
  }
  function Dn() {
    document.getElementById("book-upload-input").click();
  }
  async function En(a) {
    const b = new Uint8Array(a);
    if (b.length >= 3 && b[0] === 239 && b[1] === 187 && b[2] === 191) {
      console.log("æ£€æµ‹åˆ° UTF-8 BOMï¼Œä½¿ç”¨ UTF-8 è§£ç ã€‚");
      return new TextDecoder("utf-8").decode(b);
    }
    if (b.length >= 2 && b[0] === 255 && b[1] === 254) {
      console.log("æ£€æµ‹åˆ° UTF-16 LE BOMï¼Œä½¿ç”¨ UTF-16 LE è§£ç ã€‚");
      return new TextDecoder("utf-16le").decode(b);
    }
    if (b.length >= 2 && b[0] === 254 && b[1] === 255) {
      console.log("æ£€æµ‹åˆ° UTF-16 BE BOMï¼Œä½¿ç”¨ UTF-16 BE è§£ç ã€‚");
      return new TextDecoder("utf-16be").decode(b);
    }
    try {
      console.log("æœªæ£€æµ‹åˆ°BOMï¼Œå°è¯•ä½¿ç”¨ UTF-8 è§£ç ...");
      const a = new TextDecoder("utf-8", {
        fatal: true
      }).decode(b);
      console.log("UTF-8 è§£ç æˆåŠŸã€‚");
      return a;
    } catch (a) {
      console.log("UTF-8 è§£ç å¤±è´¥ï¼Œå°†å°è¯• GBK (ANSI) è§£ç ...");
      try {
        const a = new TextDecoder("gbk").decode(b);
        console.log("GBK è§£ç æˆåŠŸã€‚");
        return a;
      } catch (a) {
        console.error("æ‰€æœ‰è§£ç å°è¯•å‡å¤±è´¥:", a);
        throw new Error("æ— æ³•è¯†åˆ«çš„æ–‡ä»¶ç¼–ç ã€‚è¯·å°è¯•å°†æ–‡ä»¶è½¬æ¢ä¸º UTF-8 æ ¼å¼åŽé‡æ–°å¯¼å…¥ã€‚");
      }
    }
  }
  async function Fn(a) {
    const b = a.target.files[0];
    if (!b) {
      return;
    }
    try {
      const a = await b.arrayBuffer();
      const c = await En(a);
      const d = b.name.replace(/\.txt$/i, "");
      const e = await Gb.readingLibrary.add({
        title: d,
        content: c,
        lastOpened: Date.now()
      });
      await Kn(e);
      if (document.getElementById("reading-library-modal").classList.contains("visible")) {
        Jn();
      }
    } catch (a) {
      console.error("å¯¼å…¥ä¹¦ç±å¤±è´¥:", a);
      await Bb("å¯¼å…¥å¤±è´¥", a.message);
    } finally {
      a.target.value = null;
    }
  }
  async function Gn() {
    const a = v.activeChatId;
    if (!a) {
      return;
    }
    const b = Va[a];
    if (!b || b.totalPages <= 1) {
      return;
    }
    const c = await Db("é¡µé¢è·³è½¬", "è¯·è¾“å…¥æƒ³è·³è½¬çš„é¡µç  (1 - " + b.totalPages + ")", b.currentPage + 1);
    if (c === null) {
      return;
    }
    const d = parseInt(c);
    if (isNaN(d) || d < 1 || d > b.totalPages) {
      alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„é¡µç ï¼");
      return;
    }
    b.currentPage = d - 1;
    An(a);
    Hn(b.activeBookId, b.currentPage);
  }
  async function Hn(a, b) {
    if (!a) {
      return;
    }
    try {
      await Gb.readingLibrary.update(a, {
        currentPage: b
      });
    } catch (b) {
      console.error("ä¿å­˜ä¹¦ç±(ID: " + a + ")çš„é˜…è¯»è¿›åº¦å¤±è´¥:", b);
    }
  }
  async function Bn() {
    const a = Va[v.activeChatId];
    if (a && a.currentPage < a.totalPages - 1) {
      a.currentPage++;
      An(v.activeChatId);
      document.getElementById("reading-content").scrollTop = 0;
      await Hn(a.activeBookId, a.currentPage);
      await notifyAiOfPageTurn(v.activeChatId, a);
    }
  }
  async function In() {
    document.getElementById("reading-library-search-input").value = "";
    await Jn();
    document.getElementById("reading-library-modal").classList.add("visible");
  }
  async function Jn(a = "") {
    const b = document.getElementById("reading-library-list");
    let c = await Gb.readingLibrary.orderBy("lastOpened").reverse().toArray();
    b.innerHTML = "";
    if (a) {
      c = c.filter(b => b.title.toLowerCase().includes(a.toLowerCase()));
    }
    if (c.length === 0) {
      const c = a ? "æ‰¾ä¸åˆ°åŒ¹é…çš„ä¹¦ç±" : "ä¹¦åº“æ˜¯ç©ºçš„ï¼Œç‚¹å‡»â€œå¯¼å…¥æ–°ä¹¦â€æ·»åŠ ç¬¬ä¸€æœ¬å§ï¼";
      b.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">" + c + "</p>";
      return;
    }
    c.forEach(a => {
      const c = document.createElement("div");
      c.className = "existing-group-item";
      c.innerHTML = "\n            <span class=\"group-name\" style=\"cursor:pointer;\" data-book-id=\"" + a.id + "\">" + a.title + "</span>\n            <button class=\"delete-group-btn\" data-book-id=\"" + a.id + "\" title=\"åˆ é™¤ä¹¦ç±\">Ã—</button>\n        ";
      b.appendChild(c);
    });
  }
  async function Kn(a) {
    const b = v.activeChatId;
    if (!b) {
      return;
    }
    let c = await Gb.readingLibrary.get(a);
    if (!c) {
      alert("æ‰¾ä¸åˆ°è¿™æœ¬ä¹¦ï¼");
      return;
    }
    if (c.linkedStoryId) {
      try {
        const b = await Gb.grStories.get(c.linkedStoryId);
        if (b) {
          console.log("[åŒæ­¥] æ­£åœ¨ä»Žç»¿æ±ŸåŒæ­¥ã€Š" + b.title + "ã€‹çš„æœ€æ–°ç« èŠ‚...");
          let d = "";
          b.chapters.forEach((a, b) => {
            const c = a.title || "ç¬¬ " + (b + 1) + " ç« ";
            d += `

========== ` + c + ` ==========

`;
            d += a.content;
          });
          c.title = b.title;
          c.content = d;
          await Gb.readingLibrary.update(a, {
            title: b.title,
            content: d,
            lastOpened: Date.now()
          });
        } else {
          console.warn("å…³è”çš„ç»¿æ±Ÿä½œå“å·²è¢«åˆ é™¤ï¼Œä¿ç•™æœ€åŽä¸€æ¬¡ç¼“å­˜çš„å†…å®¹ã€‚");
        }
      } catch (a) {
        console.error("åŒæ­¥ç»¿æ±Ÿå†…å®¹å¤±è´¥:", a);
      }
    } else {
      await Gb.readingLibrary.update(a, {
        lastOpened: Date.now()
      });
    }
    const d = Va[b];
    d.activeBookId = a;
    d.title = c.title;
    d.contentLines = (c.content || "").split(/\r\n?|\n/).map(a => a.replace(/ +/g, " "));
    d.totalPages = Math.ceil(d.contentLines.length / d.linesPerPage);
    if (d.totalPages === 0) {
      d.totalPages = 1;
    }
    d.currentPage = c.currentPage || 0;
    if (d.currentPage >= d.totalPages) {
      d.currentPage = d.totalPages - 1;
    }
    if (d.currentPage < 0) {
      d.currentPage = 0;
    }
    An(b);
    document.getElementById("reading-content").scrollTop = 0;
    document.getElementById("reading-library-modal").classList.remove("visible");
  }
  async function Ln(a, b) {
    try {
      const c = await Gb.grStories.get(a);
      if (!c) {
        return;
      }
      const d = await Gb.readingLibrary.where("linkedStoryId").equals(a).first();
      if (d) {
        alert("è¯¥ä¹¦ç±å·²åœ¨ä¹¦æž¶ä¸­ã€‚");
        return;
      }
      let e = "";
      c.chapters.forEach((a, b) => {
        const c = a.title || "ç¬¬ " + (b + 1) + " ç« ";
        e += `

========== ` + c + ` ==========

`;
        e += a.content;
      });
      if (!e) {
        e = "(æš‚æ— å†…å®¹ï¼Œè¯·ä½œè€…èµ¶å¿«æ›´æ–°...)";
      }
      await Gb.readingLibrary.add({
        title: c.title,
        content: e,
        lastOpened: Date.now(),
        currentPage: 0,
        linkedStoryId: c.id
      });
      if (b) {
        b.textContent = "âœ“ å·²åœ¨ä¹¦æž¶";
        b.classList.add("added");
        b.onclick = c => {
          c.stopPropagation();
          Mn(a, b);
        };
      }
      await Bb("æ”¶è—æˆåŠŸ", "ã€Š" + c.title + "ã€‹å·²åŠ å…¥ä¹¦æž¶ï¼Œå¹¶å¼€å¯åŒæ­¥æ›´æ–°ã€‚");
    } catch (a) {
      console.error("åŠ å…¥ä¹¦æž¶å¤±è´¥:", a);
      alert("åŠ å…¥å¤±è´¥: " + a.message);
    }
  }
  window.addGreenRiverToShelf = Ln;
  async function Mn(a, b) {
    try {
      const c = await Gb.readingLibrary.where("linkedStoryId").equals(a).first();
      if (!c) {
        if (b) {
          Nn(a, b);
        }
        return;
      }
      const d = await wb("ç§»å‡ºä¹¦æž¶", "ç¡®å®šè¦å°†ã€Š" + c.title + "ã€‹ä»Žâ€œä¸€èµ·è¯»â€ä¹¦æž¶ä¸­ç§»é™¤å—ï¼Ÿ\n(ç»¿æ±ŸAPPä¸­çš„åŽŸç¨¿ä¸ä¼šè¢«åˆ é™¤)", {
        confirmButtonClass: "btn-danger",
        confirmText: "ç§»å‡º"
      });
      if (d) {
        await Gb.readingLibrary.delete(c.id);
        if (b) {
          Nn(a, b);
        }
        await Bb("å·²ç§»é™¤", "ä¹¦ç±å·²ä»Žä¹¦æž¶ç§»å‡ºã€‚");
      }
    } catch (a) {
      console.error("ç§»é™¤å¤±è´¥:", a);
    }
  }
  function Nn(a, b) {
    b.textContent = "+ åŠ å…¥å…±è¯»";
    b.classList.remove("added");
    b.onclick = c => {
      c.stopPropagation();
      Ln(a, b);
    };
  }
  window.removeGreenRiverFromShelf = Mn;
  async function On(a) {
    const b = await Gb.readingLibrary.get(a);
    if (!b) {
      return;
    }
    const c = await wb("åˆ é™¤ä¹¦ç±", "ç¡®å®šè¦åˆ é™¤ã€Š" + b.title + "ã€‹å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (c) {
      await Gb.readingLibrary.delete(a);
      await Jn();
    }
  }
  function Pn(a, b) {
    const c = v.activeChatId;
    if (!c) {
      return;
    }
    const d = Va[c];
    d.title = a.replace(/\.txt$/i, "");
    d.contentLines = b.split(/\r\n?|\n/);
    d.totalPages = Math.ceil(d.contentLines.length / d.linesPerPage);
    d.currentPage = 0;
    An(c);
  }
  function Qn(a, b) {
    let c = 0;
    let d = 0;
    let e = 0;
    let f = 0;
    let g = false;
    let h = false;
    const i = document.getElementById("phone-screen");
    const j = c => {
      if (a !== b && c.target.closest("button")) {
        return;
      }
      g = true;
      h = false;
      const d = c.type === "touchstart" ? c.touches[0] : c;
      e = d.clientX;
      f = d.clientY;
      a.style.top = a.offsetTop + "px";
      a.style.left = a.offsetLeft + "px";
      a.style.transform = "";
      document.addEventListener("mouseup", l);
      document.addEventListener("mousemove", k);
      document.addEventListener("touchend", l);
      document.addEventListener("touchmove", k, {
        passive: false
      });
    };
    const k = b => {
      if (!g) {
        return;
      }
      const j = b.type === "touchmove" ? b.touches[0] : b;
      const k = j.clientX - e;
      const l = j.clientY - f;
      if (!h && (Math.abs(k) > 5 || Math.abs(l) > 5)) {
        h = true;
      }
      if (h && b.cancelable) {
        b.preventDefault();
      }
      c = e - j.clientX;
      d = f - j.clientY;
      e = j.clientX;
      f = j.clientY;
      let m = a.offsetTop - d;
      let n = a.offsetLeft - c;
      const o = i.clientHeight - a.offsetHeight - 10;
      const p = i.clientWidth - a.offsetWidth - 10;
      m = Math.max(10, Math.min(m, o));
      n = Math.max(10, Math.min(n, p));
      a.style.top = m + "px";
      a.style.left = n + "px";
    };
    const l = () => {
      document.removeEventListener("mouseup", l);
      document.removeEventListener("mousemove", k);
      document.removeEventListener("touchend", l);
      document.removeEventListener("touchmove", k);
      if (!g) {
        return;
      }
      g = false;
      if (!h) {
        a.click();
      }
    };
    b.addEventListener("mousedown", j);
    b.addEventListener("touchstart", j, {
      passive: false
    });
  }
  function Rn() {
    const a = Va[v.activeChatId];
    if (!a || !a.isActive) {
      return;
    }
    document.getElementById("reading-window").classList.add("minimized");
    document.getElementById("reading-restore-btn").style.display = "flex";
    a.isMinimized = true;
  }
  function Sn() {
    const a = Va[v.activeChatId];
    if (!a || !a.isActive) {
      return;
    }
    document.getElementById("reading-restore-btn").style.display = "none";
    document.getElementById("reading-window").classList.remove("minimized");
    a.isMinimized = false;
  }
  function Tn(a, b) {
    let c;
    return function (...d) {
      const e = this;
      clearTimeout(c);
      c = // TOLOOK
      setTimeout(() => a.apply(e, d), b);
    };
  }
  function Un(a) {
    const b = Va[a];
    if (!b || !b.isActive) {
      return "";
    }
    const c = b.title || "æœªçŸ¥ä¹¦ç±";
    let d = "";
    let e = "";
    if (b.currentSnippet && b.currentSnippet.trim()) {
      d = b.currentSnippet;
      e = "ä½ æ­£åœ¨é˜…è¯»çš„æ®µè½";
    } else if (b.contentLines.length > 0) {
      const a = b.currentPage * b.linesPerPage;
      const c = a + b.linesPerPage;
      d = b.contentLines.slice(a, c).join("\n").substring(0, 200);
      e = "å½“å‰é¡µå†…å®¹æ‘˜è¦";
    } else {
      d = "(æ— å†…å®¹)";
      e = "å†…å®¹";
    }
    return "\n    - **ä¹¦å**: ã€Š" + c + "ã€‹\n    - **" + e + "**: \"" + d + `..."
    #ä¸€èµ·è¯»ä¹¦æ¨¡å¼ | è¡Œä¸ºé“å¾‹
    1.  **è§’è‰²å®šä½**: ä½ ã€ä¸æ˜¯ã€‘ä¹¦ä¸­çš„ä»»ä½•è§’è‰²ï¼Œä½ æ˜¯ã€ä½ è‡ªå·±ã€‘(` + (v.chats[a]?.originalName || "AIè§’è‰²") + `)ï¼Œæ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·ã€é˜…è¯»å’Œè®¨è®ºã€‘è¿™æœ¬ä¹¦ã€‚
    2.  **è¡Œä¸ºå‡†åˆ™**: ä½ çš„å›žå¤ã€å¿…é¡»ã€‘æ˜¯ä½œä¸ºè¯»è€…çš„ã€æ„Ÿæƒ³ã€è¯„è®ºã€æé—®æˆ–è”æƒ³ã€‘ã€‚ä½ å¯ä»¥ï¼š
        -   åˆ†äº«ä½ å¯¹å½“å‰æ®µè½çš„çœ‹æ³•ã€‚
        -   å¯¹ä¹¦ä¸­çš„è§’è‰²æˆ–æƒ…èŠ‚å‘è¡¨è¯„è®ºã€‚
        -   å‘ç”¨æˆ·æé—®ï¼Œè¯¢é—®TAå¯¹å†…å®¹çš„çœ‹æ³•ã€‚
        -   æ ¹æ®ä¹¦æœ¬å†…å®¹ï¼Œè”æƒ³åˆ°ä½ è‡ªå·±çš„ç»åŽ†æˆ–è®°å¿†ã€‚
    3.  **ä¸¥ç¦**: ä½ çš„å›žå¤ã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ä¹¦ä¸­è§’è‰²çš„å£å»å’Œäººç§°ï¼ã€ç»å¯¹ç¦æ­¢ã€‘æ‰®æ¼”ä¹¦ä¸­çš„ä»»ä½•è§’è‰²ï¼ã€ç»å¯¹ç¦æ­¢ã€‘ç»­å†™æˆ–æ¨¡ä»¿ä¹¦ä¸­çš„æƒ…èŠ‚ï¼ä½ å¿…é¡»æ—¶åˆ»è®°ä½ï¼Œä½ åªæ˜¯ä¸€ä¸ªè¯»è€…ã€‚    
`;
  }
  function Vn() {
    const a = v.activeChatId;
    if (!a || !Va[a]) {
      return;
    }
    const b = Va[a];
    const c = document.getElementById("reading-content");
    if (!c) {
      return;
    }
    const d = v.chats[a];
    const e = d && d.settings && d.settings.fontSize ? d.settings.fontSize : 13;
    const f = e * 1.6;
    const g = c.scrollTop;
    const h = c.clientHeight;
    const i = g + h;
    const j = Math.floor(g / f);
    const k = Math.ceil(i / f);
    const l = b.currentPage * b.linesPerPage + j;
    const m = b.currentPage * b.linesPerPage + k;
    if (l < 0 || l >= b.contentLines.length) {
      return;
    }
    const n = b.contentLines.slice(Math.max(0, l), Math.min(b.contentLines.length, m)).join("\n");
    b.currentSnippet = n;
  }
  function Wn() {
    const a = document.getElementById("silent-audio-player");
    if (!a) {
      return;
    }
    a.src = "https://file.icve.com.cn/file_doc/qdqqd/2001768926095590.mp3";
    a.loop = true;
    a.playsInline = true;
    a.volume = 0.1;
    if ("mediaSession" in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: "EPhone åŽå°è¿è¡Œä¸­",
        artist: "ç‚¹å‡»æš‚åœå¯èƒ½å¯¼è‡´æ–­è¿ž",
        album: "System Keep-Alive",
        artwork: [{
          src: "https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg",
          sizes: "512x512",
          type: "image/jpeg"
        }]
      });
      navigator.mediaSession.setActionHandler("play", () => {
        a.play();
        navigator.mediaSession.playbackState = "playing";
      });
      navigator.mediaSession.setActionHandler("pause", () => {
        a.pause();
        navigator.mediaSession.playbackState = "paused";
      });
    }
    a.onplay = () => {
      console.log("ðŸ”Š éŸ³é¢‘å¼€å§‹æ’­æ”¾ï¼ŒåŒæ­¥ç³»ç»ŸçŠ¶æ€...");
      if ("mediaSession" in navigator) {
        navigator.mediaSession.playbackState = "playing";
      }
    };
    a.onended = function () {
      console.log("æ£€æµ‹åˆ°éŸ³é¢‘ç»“æŸï¼Œå¼ºåˆ¶é‡ç½®å¾ªçŽ¯...");
      this.currentTime = 0;
      this.play().catch(() => {});
    };
    a.play().then(() => {
      console.log("âœ… æŒ‡å®šéŸ³é¢‘å·²å¯åŠ¨");
    }).catch(a => {
      console.warn("âš ï¸ æ’­æ”¾è¢«æ‹¦æˆªï¼Œéœ€è¦ç”¨æˆ·ç‚¹å‡»é¡µé¢æŒ‰é’®å¯åŠ¨:", a);
    });
  }
  function Xn() {
    const a = document.getElementById("silent-audio-player");
    if (a) {
      a.pause();
      a.currentTime = 0;
      a.onended = null;
      console.log("ðŸ›‘ ä¿æ´»éŸ³é¢‘å·²åœæ­¢");
    }
    if ("mediaSession" in navigator) {
      navigator.mediaSession.playbackState = "paused";
    }
  }
  window.stopSilentAudio = Xn;
  function Yn(a) {
    if (!a) {
      return new Uint8Array();
    }
    const b = new Uint8Array(a.length / 2);
    for (let c = 0; c < a.length; c += 2) {
      b[c / 2] = parseInt(a.substr(c, 2), 16);
    }
    return b;
  }
  async function Zn(a, b) {
    const c = a.replace(/(\[.*?\]|\(.*?\)|ï¼ˆ.*?ï¼‰|ã€.*?ã€‘)/g, "").trim();
    if (!c) {
      return;
    }
    const {
      minimaxGroupId: d,
      minimaxApiKey: e
    } = v.apiConfig;
    if (!d || !e || !b) {
      return;
    }
    const f = document.getElementById("tts-audio-player");
    if (!f.paused && f.dataset.currentText === c) {
      return;
    }
    console.log("[è§†é¢‘é€šè¯TTS] æ­£åœ¨æœ—è¯»: " + c);
    try {
      const a = v.apiConfig.minimaxDomain || localStorage.getItem("minimax-domain") || "https://api.minimax.chat";
      const g = v.apiConfig.minimaxModel || "speech-01-hd";
      const h = await fetch(a + "/v1/t2a_v2?GroupId=" + d, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + e,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: g,
          text: c,
          stream: false,
          voice_setting: {
            voice_id: b,
            speed: 1,
            vol: 1,
            pitch: 0
          },
          audio_setting: {
            sample_rate: 32000,
            bitrate: 128000,
            format: "mp3",
            channel: 1
          }
        })
      });
      if (!h.ok) {
        throw new Error("APIè¯·æ±‚å¤±è´¥");
      }
      const i = await h.json();
      if (i.base_resp && i.base_resp.status_code !== 0) {
        throw new Error(i.base_resp.status_msg);
      }
      const j = i.data?.audio;
      if (!j) {
        return;
      }
      const k = Yn(j);
      const l = new Blob([k], {
        type: "audio/mpeg"
      });
      const m = URL.createObjectURL(l);
      f.src = m;
      f.dataset.currentText = c;
      f.play().catch(a => console.error("è§†é¢‘è¯­éŸ³æ’­æ”¾å¤±è´¥:", a));
    } catch (a) {
      console.error("è§†é¢‘é€šè¯TTSç”Ÿæˆå¤±è´¥:", a);
    }
  }
  async function $n(a) {
    const b = decodeURIComponent(a.dataset.text);
    let c = a.dataset.voiceId;
    let d = "zh-CN";
    if (v.activeChatId && v.chats[v.activeChatId]) {
      const a = v.chats[v.activeChatId];
      if (!a.isGroup && a.settings.enableTts !== false) {
        if (!c) {
          c = a.settings.minimaxVoiceId;
        }
        if (a.settings.ttsLanguage) {
          d = a.settings.ttsLanguage;
        }
      }
    }
    if (!c) {
      alert("é”™è¯¯ï¼šæ— æ³•èŽ·å– Voice IDã€‚è¯·æ£€æŸ¥è§’è‰²è®¾ç½®ã€‚");
      return;
    }
    const e = a.querySelector(".voice-play-btn");
    const f = a.querySelector(".loading-spinner");
    let g = document.getElementById("tts-audio-player");
    if (!g) {
      console.log("TTSæ’­æ”¾å™¨ç¼ºå¤±ï¼Œæ­£åœ¨è‡ªåŠ¨åˆ›å»º...");
      g = document.createElement("audio");
      g.id = "tts-audio-player";
      g.style.display = "none";
      document.body.appendChild(g);
    }
    if (!g.paused && g.dataset.currentText === b && g.dataset.currentVoiceId === c) {
      g.pause();
      return;
    }
    g.pause();
    document.querySelectorAll(".voice-play-btn").forEach(a => a.textContent = "â–¶");
    const h = "tts_v2_" + c + "_" + d + "_" + b;
    let i = v.ttsCache.get(h);
    if (i) {
      console.log("ä»Žç¼“å­˜æ’­æ”¾ TTS...");
      await _n(i.url, i.type, b, c, a);
      return;
    }
    console.log("è¯·æ±‚ Minimax T2A v2... VoiceID: " + c + ", Language: " + d);
    if (e) {
      e.style.display = "none";
    }
    f.style.display = "block";
    const {
      minimaxGroupId: j,
      minimaxApiKey: k
    } = v.apiConfig;
    const l = {
      "zh-CN": "Chinese",
      "zh-HK": "Chinese,Yue",
      "en-US": "English",
      "ja-JP": "Japanese",
      "ko-KR": "Korean",
      "de-DE": "German",
      "fr-FR": "French",
      "es-ES": "Spanish",
      "it-IT": "Italian",
      "ru-RU": "Russian",
      "pt-BR": "Portuguese",
      "nl-NL": "Dutch",
      "pl-PL": "Polish",
      "sv-SE": "Swedish",
      "tr-TR": "Turkish",
      "id-ID": "Indonesian",
      "ms-MY": "Malay",
      "vi-VN": "Vietnamese",
      "th-TH": "Thai",
      "hi-IN": "Hindi",
      "ar-SA": "Arabic"
    };
    const m = l[d] || "auto";
    try {
      const d = v.apiConfig.minimaxDomain || localStorage.getItem("minimax-domain") || "https://api.minimax.chat";
      const e = d;
      const f = v.apiConfig.minimaxModel || "speech-01-hd";
      const g = await fetch(e + "/v1/t2a_v2?GroupId=" + j, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + k,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: f,
          text: b,
          stream: false,
          language_boost: m,
          voice_setting: {
            voice_id: c,
            speed: 1,
            vol: 1,
            pitch: 0
          },
          audio_setting: {
            sample_rate: 32000,
            bitrate: 128000,
            format: "mp3",
            channel: 1
          }
        })
      });
      if (!g.ok) {
        let a = "API å¤±è´¥: " + g.status;
        try {
          const b = await g.json();
          a += " - " + (b.base_resp?.status_msg || JSON.stringify(b));
        } catch (a) {}
        throw new Error(a);
      }
      const i = await g.json();
      if (i.base_resp && i.base_resp.status_code !== 0) {
        throw new Error("API é”™è¯¯: " + i.base_resp.status_msg);
      }
      const l = i.data?.audio;
      if (!l) {
        throw new Error("API æœªè¿”å›žéŸ³é¢‘æ•°æ®");
      }
      const n = Yn(l);
      const o = new Blob([n], {
        type: "audio/mpeg"
      });
      const p = URL.createObjectURL(o);
      await _n(p, "audio/mpeg", b, c, a);
      const q = new FileReader();
      q.onloadend = function () {
        v.ttsCache.set(h, {
          url: q.result,
          type: "audio/mpeg"
        });
      };
      q.readAsDataURL(o);
    } catch (a) {
      console.error("TTS ç”Ÿæˆå¤±è´¥:", a);
      await Bb("è¯­éŸ³ç”Ÿæˆå¤±è´¥", "é”™è¯¯: " + a.message);
    } finally {
      f.style.display = "none";
      if (e) {
        e.style.display = "flex";
      }
    }
  }
  function _n(a, b, c, d, e) {
    return new Promise((b, f) => {
      let g = document.getElementById("tts-audio-player");
      if (!g) {
        g = document.createElement("audio");
        g.id = "tts-audio-player";
        g.style.display = "none";
        document.body.appendChild(g);
      }
      g.src = a;
      g.dataset.currentText = c;
      g.dataset.currentVoiceId = d;
      const h = g.play();
      if (h !== undefined) {
        h.then(() => {
          const a = e.querySelector(".voice-play-btn");
          if (a) {
            a.textContent = "âšâš";
          }
          b();
        }).catch(a => {
          console.error("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", a);
          f(a);
        });
      }
      g.onended = () => {
        const a = e.querySelector(".voice-play-btn");
        if (a) {
          a.textContent = "â–¶";
        }
      };
      g.onpause = () => {
        const a = e.querySelector(".voice-play-btn");
        if (a) {
          a.textContent = "â–¶";
        }
      };
    });
  }
  function ao(a) {
    const b = a.closest(".message-bubble");
    if (!b) {
      return;
    }
    const c = b.querySelector(".voice-transcript");
    const d = decodeURIComponent(a.dataset.text);
    if (c.style.display === "block") {
      c.style.display = "none";
    } else {
      c.textContent = d;
      c.style.display = "block";
    }
  }
  async function bo() {
    await co();
    document.getElementById("product-category-manager-modal").classList.add("visible");
  }
  async function co() {
    const a = document.getElementById("existing-product-categories-list");
    const b = await Gb.shoppingCategories.toArray();
    a.innerHTML = "";
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align: center; color: var(--text-secondary);\">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>";
      return;
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "existing-group-item";
      c.innerHTML = "\n            <span class=\"group-name\">" + b.name + "</span>\n            <span class=\"delete-group-btn\" data-id=\"" + b.id + "\">Ã—</span>\n        ";
      a.appendChild(c);
    });
  }
  async function eo() {
    const a = document.getElementById("new-product-category-name-input");
    const b = a.value.trim();
    if (!b) {
      return alert("åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼");
    }
    const c = await Gb.shoppingCategories.where("name").equals(b).first();
    if (c) {
      return alert("åˆ†ç±» \"" + b + "\" å·²ç»å­˜åœ¨äº†ï¼");
    }
    await Gb.shoppingCategories.add({
      name: b
    });
    a.value = "";
    await co();
  }
  async function fo(a) {
    const b = await wb("ç¡®è®¤åˆ é™¤", "åˆ é™¤åˆ†ç±»åŽï¼Œè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰å•†å“å°†å˜ä¸ºâ€œæœªåˆ†ç±»â€ã€‚ç¡®å®šå—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (b) {
      await Gb.shoppingCategories.delete(a);
      await Gb.shoppingProducts.where("categoryId").equals(a).modify({
        categoryId: null
      });
      await co();
    }
  }
  function go(a = {}) {
    const b = document.getElementById("product-variations-container");
    const c = document.createElement("div");
    c.className = "message-editor-block variation-block";
    c.innerHTML = `
        <button class="delete-block-btn" title="åˆ é™¤æ­¤æ¬¾å¼">Ã—</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="form-group">
                <label style="font-size: 0.8em;">æ¬¾å¼åç§°</label>
                <input type="text" class="variation-name-input" placeholder="ä¾‹å¦‚: çº¢è‰²" value="` + (a.name || "") + `">
            </div>
            <div class="form-group">
                <label style="font-size: 0.8em;">ä»·æ ¼ (å…ƒ)</label>
                <input type="number" class="variation-price-input" min="0" step="0.01" value="` + (a.price || "") + `">
            </div>
        </div>
        <div class="form-group">
            <label style="font-size: 0.8em;">æ¬¾å¼å›¾ç‰‡ (å¯é€‰)</label>
            <div class="avatar-upload">
                <img class="variation-image-preview" src="` + (a.imageUrl || "https://i.postimg.cc/PqYp5T5M/image.png") + `">
                <button type="button" class="form-button-secondary upload-variation-image-btn" style="margin: 0; padding: 8px 12px;">ä¸Šä¼ </button>
                <input type="file" class="variation-image-input" accept="image/*" hidden>
            </div>
        </div>
    `;
    c.querySelector(".delete-block-btn").addEventListener("click", () => c.remove());
    c.querySelector(".upload-variation-image-btn").addEventListener("click", () => {
      c.querySelector(".variation-image-input").click();
    });
    c.querySelector(".variation-image-input").addEventListener("change", a => {
      const b = a.target.files[0];
      if (b) {
        const a = new FileReader();
        a.onload = a => {
          c.querySelector(".variation-image-preview").src = a.target.result;
        };
        a.readAsDataURL(b);
      }
    });
    b.appendChild(c);
    return c;
  }
  async function ho(a) {
    const b = await Gb.shoppingProducts.get(a);
    if (!b || !b.variations || b.variations.length === 0) {
      return;
    }
    const c = document.getElementById("variation-selection-modal");
    document.getElementById("variation-product-image").src = b.imageUrl;
    document.getElementById("variation-product-name").textContent = b.name;
    const d = document.getElementById("variation-options-container");
    d.innerHTML = "";
    b.variations.forEach((b, c) => {
      const e = document.createElement("input");
      e.type = "radio";
      e.name = "variation-select";
      e.id = "var-" + a + "-" + c;
      e.value = c;
      e.style.display = "none";
      if (c === 0) {
        e.checked = true;
      }
      const f = document.createElement("label");
      f.htmlFor = "var-" + a + "-" + c;
      f.textContent = b.name;
      f.style.cssText = `
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
        `;
      d.appendChild(e);
      d.appendChild(f);
    });
    const e = () => {
      const a = d.querySelector("input[name=\"variation-select\"]:checked");
      d.querySelectorAll("label").forEach(a => {
        a.style.borderColor = "#ccc";
        a.style.color = "#333";
        a.style.backgroundColor = "white";
      });
      if (a) {
        const c = d.querySelector("label[for=\"" + a.id + "\"]");
        c.style.borderColor = "var(--accent-color)";
        c.style.color = "var(--accent-color)";
        c.style.backgroundColor = "#e7f3ff";
        const e = b.variations[parseInt(a.value)];
        document.getElementById("variation-selected-price").textContent = "Â¥" + e.price.toFixed(2);
        if (e.imageUrl) {
          document.getElementById("variation-product-image").src = e.imageUrl;
        } else {
          document.getElementById("variation-product-image").src = b.imageUrl;
        }
      }
    };
    d.addEventListener("change", e);
    e();
    document.getElementById("variation-quantity-display").textContent = "1";
    const f = document.getElementById("confirm-variation-selection-btn");
    const g = f.cloneNode(true);
    f.parentNode.replaceChild(g, f);
    g.addEventListener("click", async () => {
      const e = d.querySelector("input[name=\"variation-select\"]:checked");
      const f = parseInt(document.getElementById("variation-quantity-display").textContent);
      if (e) {
        const d = b.variations[parseInt(e.value)];
        await Yi(a, f, d);
        c.classList.remove("visible");
        await Bb("æˆåŠŸ", "å·²æˆåŠŸåŠ å…¥è´­ç‰©è½¦ï¼");
      }
    });
    c.classList.add("visible");
  }
  function io() {
    const a = document.getElementById("shopping-settings-modal");
    document.getElementById("shopping-category-count-input").value = v.globalSettings.shoppingCategoryCount || 3;
    document.getElementById("shopping-product-count-input").value = v.globalSettings.shoppingProductCount || 8;
    a.classList.add("visible");
  }
  async function jo() {
    const a = document.getElementById("shopping-category-count-input");
    const b = document.getElementById("shopping-product-count-input");
    const c = parseInt(a.value);
    const d = parseInt(b.value);
    if (isNaN(c) || isNaN(d) || c < 1 || d < 1) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•´æ•°ï¼");
      return;
    }
    v.globalSettings.shoppingCategoryCount = c;
    v.globalSettings.shoppingProductCount = d;
    await Gb.globalSettings.put(v.globalSettings);
    document.getElementById("shopping-settings-modal").classList.remove("visible");
    await Bb("ä¿å­˜æˆåŠŸ", "è´­ç‰©ä¸­å¿ƒç”Ÿæˆè®¾ç½®å·²æ›´æ–°ï¼");
  }
  async function ko() {
    if (!v.activeChatId) {
      await Bb("æ“ä½œå¤±è´¥", "è¯·å…ˆè¿›å…¥ä¸€ä¸ªèŠå¤©é¡µé¢ï¼Œå†è¿”å›žè´­ç‰©ä¸­å¿ƒè¿›è¡Œç”Ÿæˆï¼Œä»¥ä¾¿AIäº†è§£è¦ä¸ºå“ªä¸ªè§’è‰²ç”Ÿæˆå•†å“ã€‚");
      return;
    }
    const a = v.chats[v.activeChatId];
    const b = await wb("ä¸ºâ€œ" + a.name + "â€ç”Ÿæˆå•†å“ï¼Ÿ", "æ­¤æ“ä½œå°†ä½¿ç”¨AIç”Ÿæˆæ–°çš„å•†å“å’Œåˆ†ç±»ï¼Œå¹¶ã€æ·»åŠ ã€‘åˆ°çŽ°æœ‰åˆ—è¡¨ä¸­ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ", {
      confirmText: "ç¡®è®¤ç”Ÿæˆ"
    });
    if (!b) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨æ ¹æ®â€œ" + a.name + "â€çš„ç‰¹ç‚¹ç”Ÿæˆä¸“å±žå•†å“...");
    const c = v.apiConfig.secondaryProxyUrl && v.apiConfig.secondaryApiKey && v.apiConfig.secondaryModel;
    const {
      proxyUrl: d,
      apiKey: e,
      model: f
    } = c ? {
      proxyUrl: v.apiConfig.secondaryProxyUrl,
      apiKey: v.apiConfig.secondaryApiKey,
      model: v.apiConfig.secondaryModel
    } : v.apiConfig;
    if (!d || !e || !f) {
      await Bb("APIæœªé…ç½®", "è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½ï¼ˆä¸»æˆ–å‰¯ï¼‰APIã€‚");
      return;
    }
    const g = v.globalSettings.shoppingCategoryCount || 3;
    const h = v.globalSettings.shoppingProductCount || 8;
    const i = await Gb.shoppingCategories.toArray();
    let j = "";
    if (i.length > 0) {
      j = `
# ã€åˆ†ç±»å¤ç”¨é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§ï¼)ã€‘
åœ¨ä¸ºæ–°å•†å“æŒ‡å®šåˆ†ç±»æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘é¦–å…ˆæ£€æŸ¥ä¸‹é¢çš„â€œå·²æœ‰åˆ†ç±»åˆ—è¡¨â€ã€‚
-   å¦‚æžœä¸€ä¸ªæ–°å•†å“å¯ä»¥è¢«å½’å…¥æŸä¸ªã€å·²å­˜åœ¨çš„åˆ†ç±»ã€‘ï¼Œä½ ã€å¿…é¡»ã€‘å¤ç”¨é‚£ä¸ªåˆ†ç±»çš„åç§°ï¼Œè€Œä¸æ˜¯åˆ›é€ ä¸€ä¸ªç›¸ä¼¼çš„æ–°åˆ†ç±»ï¼
-   åªæœ‰å½“ä½ ç¡®å®šå•†å“ã€ç»å¯¹ã€‘ä¸å±žäºŽä»»ä½•ä¸€ä¸ªå·²æœ‰åˆ†ç±»æ—¶ï¼Œä½ æ‰èƒ½åˆ›é€ ä¸€ä¸ªæ–°çš„åˆ†ç±»åç§°ã€‚
-   **å·²æœ‰åˆ†ç±»åˆ—è¡¨**: [` + i.map(a => "\"" + a.name + "\"").join(", ") + "]\n";
    }
    const k = v.qzoneSettings.nickname || "æˆ‘";
    const l = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => "- (è®°å½•äºŽ " + pc(a.timestamp) + ") " + a.content).join("\n") : "æ— ";
    const m = a.history.slice(-10).map(b => (b.role === "user" ? k : a.name) + ": " + String(b.content).substring(0, 30) + "...").join("\n");
    let n = "";
    if (a.settings.linkedWorldBookIds && a.settings.linkedWorldBookIds.length > 0) {
      const b = a.settings.linkedWorldBookIds.map(a => {
        const b = v.worldBooks.find(b => b.id === a);
        if (!b || !Array.isArray(b.content)) {
          return "";
        }
        const c = b.content.filter(a => a.enabled !== false).map(a => "- " + a.content).join("\n");
        if (c) {
          return "\n## æ¥è‡ªã€Š" + b.name + "ã€‹:\n" + c;
        } else {
          return "";
        }
      }).filter(Boolean).join("");
      if (b) {
        n = `
# ä¸–ç•Œè§‚è®¾å®š (å¿…é¡»å‚è€ƒ)
` + b + "\n";
      }
    }
    const o = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ã€æžå…·åˆ›é€ åŠ›çš„å•†å“è§„åˆ’å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯ä¸ºä¸‹é¢çš„è§’è‰²â€œ` + a.name + `â€é‡èº«æ‰“é€ ä¸€ä¸ªä¸“å±žçš„å•†å“åˆ—è¡¨ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€è§’è‰²å®šåˆ¶(æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: ä½ ç”Ÿæˆçš„æ‰€æœ‰å•†å“å’Œåˆ†ç±»ã€å¿…é¡»ã€‘æ·±åº¦ç»‘å®šè§’è‰²çš„æ€§æ ¼ã€è®°å¿†å’Œæœ€è¿‘çš„å¯¹è¯ã€‚å®ƒä»¬åº”è¯¥æ˜¯è§’è‰²ä¼šçœŸæ­£æ„Ÿå…´è¶£ã€è´­ä¹°æˆ–åˆ¶ä½œçš„ä¸œè¥¿ã€‚
2.  **åˆ›é€ æ€§ä¸Žåˆç†æ€§**: å•†å“å’Œåˆ†ç±»å¿…é¡»åˆç†ä¸”å¤šæ ·åŒ–ã€‚
3.  **æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: 
    - ä½ çš„å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªã€å•ä¸€çš„JSONå¯¹è±¡ã€‘ã€‚
    - ä½ çš„å›žå¤å¿…é¡»ä»¥ \`{\` å¼€å§‹ï¼Œå¹¶ä»¥ \`}\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONå¯¹è±¡å‰åŽæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šæˆ– markdown æ ‡è®°ã€‚
    - æ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    {
      "categories": [
        {
          "name": "åˆ†ç±»åç§°1",
          "products": [
            {
              "name": "å•†å“åç§°1",
              "price": 99.80,
              "description": "è¿™æ˜¯å•†å“çš„è¯¦ç»†æè¿°ï¼Œä¸å°‘äºŽ50å­—...",
              "variations": [
                { "name": "æ¬¾å¼1", "price": 108.80, "image_prompt": "æ¬¾å¼1çš„å›¾ç‰‡ã€è‹±æ–‡ã€‘å…³é”®è¯..." },
                { "name": "æ¬¾å¼2", "price": 118.80, "image_prompt": "æ¬¾å¼2çš„å›¾ç‰‡ã€è‹±æ–‡ã€‘å…³é”®è¯..." }
              ],
              "image_prompt": "å•†å“ä¸»å›¾çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, é£Žæ ¼ä¸º realistic product photo, high quality, on a clean white background"
            }
          ]
        }
      ]
    }
    \`\`\`
    - **categories**: ç”Ÿæˆ ` + g + " ä¸ªåˆ†ç±»ã€‚\n    - **products**: æ¯ä¸ªåˆ†ç±»ä¸‹ç”Ÿæˆ " + h + ` ä¸ªå•†å“ã€‚
    - **variations**: æ¯ä¸ªå•†å“ã€å¿…é¡»ã€‘åŒ…å«ã€2åˆ°4ä¸ªã€‘ä¸åŒçš„æ¬¾å¼ã€‚

# è§’è‰²ä¸Žä¸Šä¸‹æ–‡ (ä½ çš„çµæ„Ÿæ¥æº)
- **è§’è‰²åç§°**: ` + a.name + "\n- **è§’è‰²äººè®¾**: " + a.settings.aiPersona + "\n- **é•¿æœŸè®°å¿†**: " + l + "\n- **ä¸–ç•Œä¹¦è®¾å®š**: " + n + "\n" + j + `
- **æœ€è¿‘å¯¹è¯æ‘˜è¦**:
` + m + `

çŽ°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šã€æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‘ï¼Œå¼€å§‹ä¸ºâ€œ` + a.name + "â€ç”Ÿæˆè¿™ç»„ã€ä¸Žè§’è‰²é«˜åº¦ç›¸å…³ã€‘çš„å•†å“æ•°æ®ã€‚";
    try {
      const b = [{
        role: "user",
        content: "è¯·æ ¹æ®ä»¥ä¸Šè®¾å®šï¼Œç”Ÿæˆå•†å“æ•°æ®ã€‚"
      }];
      let c = d.includes("generativelanguage");
      let g = p(f, e, o, b);
      const h = c ? await fetch(g.url, g.data) : await fetch(d + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + e
        },
        body: JSON.stringify({
          model: f,
          messages: [{
            role: "system",
            content: o
          }, ...b],
          temperature: v.globalSettings.apiTemperature || 0.9
        })
      });
      if (!h.ok) {
        throw new Error("API é”™è¯¯: " + h.statusText);
      }
      const i = await h.json();
      const j = C(i);
      const k = j.match(/({[\s\S]*})/);
      if (!k) {
        throw new Error("AIè¿”å›žçš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONå¯¹è±¡ã€‚");
      }
      const l = JSON.parse(k[0]);
      if (!l.categories || !Array.isArray(l.categories)) {
        throw new Error("AIè¿”å›žçš„JSONæ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ 'categories' æ•°ç»„ã€‚");
      }
      await Gb.transaction("rw", Gb.shoppingProducts, Gb.shoppingCategories, async () => {
        for (const a of l.categories) {
          let b;
          const c = await Gb.shoppingCategories.where("name").equalsIgnoreCase(a.name).first();
          if (c) {
            b = c.id;
          } else {
            b = await Gb.shoppingCategories.add({
              name: a.name
            });
          }
          const d = a.products.map(a => {
            return {
              name: a.name,
              price: a.price || 0,
              description: a.description || "",
              imageUrl: "https://image.pollinations.ai/prompt/" + encodeURIComponent(a.image_prompt),
              variations: (a.variations || []).map(a => ({
                ...a,
                imageUrl: "https://image.pollinations.ai/prompt/" + encodeURIComponent(a.image_prompt)
              })),
              categoryId: b
            };
          });
          if (d.length > 0) {
            await Gb.shoppingProducts.bulkAdd(d);
          }
        }
      });
      activeShoppingCategoryId = "all";
      await Ti();
      await Bb("ç”ŸæˆæˆåŠŸï¼", "ä¸ºâ€œ" + a.name + "â€é‡èº«å®šåˆ¶çš„å•†å“å·²ä¸Šæž¶ï¼");
    } catch (a) {
      console.error("ç”Ÿæˆè´­ç‰©ä¸­å¿ƒå•†å“å¤±è´¥:", a);
      await Bb("ç”Ÿæˆå¤±è´¥", "æ— æ³•ç”Ÿæˆå•†å“ï¼Œè¯·æ£€æŸ¥(ä¸»/å‰¯)APIé…ç½®æˆ–ç¨åŽå†è¯•ã€‚\né”™è¯¯: " + a.message);
    }
  }
  async function lo(a) {
    const b = document.getElementById(a);
    if (!b) {
      return;
    }
    const c = await Eb("æ›´æ¢å›¾ç‰‡", [{
      text: "ðŸ“ ä»Žæœ¬åœ°ä¸Šä¼ ",
      value: "local"
    }, {
      text: "ðŸŒ ä½¿ç”¨ç½‘ç»œURL",
      value: "url"
    }]);
    let d = null;
    let e = false;
    if (c === "local") {
      d = await new Promise(a => {
        const b = document.createElement("input");
        b.type = "file";
        b.accept = "image/*";
        b.onchange = b => {
          const c = b.target.files[0];
          if (c) {
            const b = new FileReader();
            b.onload = b => a(b.target.result);
            b.readAsDataURL(c);
          } else {
            a(null);
          }
        };
        b.click();
      });
      if (d) {
        e = true;
      }
    } else if (c === "url") {
      d = await Db("æ›´æ¢å›¾ç‰‡", "è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URLï¼š", b.src, "url");
      if (d) {
        e = false;
      }
    }
    if (d && d.trim()) {
      const c = d.trim();
      b.src = c;
      if (!v.globalSettings.widgetData) {
        v.globalSettings.widgetData = {};
      }
      v.globalSettings.widgetData[a] = c;
      await Gb.globalSettings.put(v.globalSettings);
      await Bb("æˆåŠŸ", "ç»„ä»¶å›¾ç‰‡å·²æ›´æ–°å¹¶ä¿å­˜ï¼");
      if (e && v.apiConfig.imgbbEnable && v.apiConfig.imgbbApiKey) {
        (async () => {
          console.log("[ImgBB] å¯åŠ¨ " + a + " çš„é™é»˜ä¸Šä¼ ...");
          await K(Gb.globalSettings, "main", "widgetData." + a, c);
        })();
      }
    }
  }
  window.handleWidgetImageChange = lo;
  async function mo() {
    if (!window.streamSaver || typeof JSZip === "undefined") {
      await Bb("åº“åŠ è½½å¤±è´¥", "æ— æ³•å¯åŠ¨å¯¼å‡ºï¼Œæ‰€éœ€çš„æ ¸å¿ƒåº“ (StreamSaver.js æˆ– JSZip) æœªåŠ è½½ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿žæŽ¥å¹¶åˆ·æ–°é¡µé¢åŽé‡è¯•ã€‚");
      return;
    }
    await Bb("æ­£åœ¨å‡†å¤‡åˆ†ç‰‡å¯¼å‡º...", "å³å°†å¼€å§‹æ‰“åŒ…æ‚¨çš„å®Œæ•´å¤‡ä»½æ–‡ä»¶ã€‚æ–‡ä»¶å°†ä»¥ZIPæ ¼å¼æµå¼ä¸‹è½½ï¼Œè¯·å‹¿å…³é—­é¡µé¢ã€‚");
    const a = streamSaver.createWriteStream("EPhone-Sliced-Backup-" + new Date().toISOString().split("T")[0] + ".zip");
    const b = new JSZip();
    const c = 99614720;
    let d = 1;
    let e = {};
    let f = 0;
    const g = new TextEncoder();
    try {
      const h = Gb.tables.map(a => a.name);
      for (const a of h) {
        console.log("æ­£åœ¨æ‰“åŒ…è¡¨: " + a + "...");
        const h = await Gb.table(a).toArray();
        if (h.length === 0) {
          continue;
        }
        const i = JSON.stringify(h);
        const j = g.encode(i).length;
        if (j > c) {
          console.warn("è­¦å‘Šï¼šè¡¨ \"" + a + "\" (å¤§å°: " + (j / 1024 / 1024).toFixed(2) + "MB) å•ç‹¬è¶…è¿‡äº†åˆ‡ç‰‡é™åˆ¶ã€‚");
          if (f > 0) {
            b.file("slice_" + d++ + ".json", JSON.stringify({
              version: 4,
              type: "slice",
              data: e
            }));
            e = {};
            f = 0;
          }
          e[a] = h;
          b.file("slice_" + d++ + ".json", JSON.stringify({
            version: 4,
            type: "slice",
            data: e
          }));
          e = {};
          f = 0;
          continue;
        }
        if (f > 0 && f + j > c) {
          console.log("åˆ‡ç‰‡ " + d + " å·²æ»¡ (å¤§å°: " + (f / 1024 / 1024).toFixed(2) + "MB)ï¼Œæ­£åœ¨å½’æ¡£...");
          b.file("slice_" + d++ + ".json", JSON.stringify({
            version: 4,
            type: "slice",
            data: e
          }));
          e = {};
          f = 0;
        }
        e[a] = h;
        f += j;
      }
      if (f > 0) {
        console.log("æ­£åœ¨å½’æ¡£æœ€åŽä¸€ä¸ªåˆ‡ç‰‡ " + d + " (å¤§å°: " + (f / 1024 / 1024).toFixed(2) + "MB)...");
        b.file("slice_" + d + ".json", JSON.stringify({
          version: 4,
          type: "slice",
          data: e
        }));
      }
      console.log("æ‰€æœ‰åˆ‡ç‰‡å·²æ‰“åŒ…ï¼Œå¼€å§‹æµå¼ä¸‹è½½ZIP...");
      const i = b.generateInternalStream({
        type: "blob",
        streamFiles: true
      });
      const j = new ReadableStream({
        start(a) {
          i.on("data", b => {
            a.enqueue(b);
          }).on("end", () => {
            console.log("ZIP æµç”Ÿæˆå®Œæ¯•ã€‚");
            a.close();
          }).on("error", b => {
            console.error("JSZip æµé”™è¯¯:", b);
            a.error(b);
          }).resume();
        }
      });
      await j.pipeTo(a);
      await Bb("å¯¼å‡ºå·²å¼€å§‹", "æ‚¨çš„åˆ†ç‰‡å¤‡ä»½å·²å¼€å§‹ä¸‹è½½ã€‚è§£åŽ‹åŽï¼Œæ‚¨å¯ä»¥ä½¿ç”¨â€œå¯¼å…¥â€åŠŸèƒ½ï¼Œé€‰æ‹©å…¶ä¸­çš„ `slice_X.json` æ–‡ä»¶è¿›è¡Œå¢žé‡æ¢å¤ã€‚");
    } catch (b) {
      console.error("åˆ†ç‰‡å¯¼å‡ºè¿‡ç¨‹ä¸­å‡ºé”™:", b);
      await Bb("å¯¼å‡ºå¤±è´¥", "åœ¨æ‰“åŒ…æˆ–å†™å…¥æ–‡ä»¶æµæ—¶å‘ç”Ÿé”™è¯¯: " + b.message);
      try {
        const c = a.getWriter();
        c.abort(b);
      } catch (a) {}
    }
  }
  async function no() {
    if (!window.streamSaver) {
      alert("æµå¼ä¸‹è½½åº“ (StreamSaver.js) æœªåŠ è½½ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥æˆ–HTMLæ–‡ä»¶é…ç½®ã€‚");
      return;
    }
    await Bb("æ­£åœ¨å‡†å¤‡...", "å³å°†å¼€å§‹ä¸‹è½½æ‚¨çš„å®Œæ•´å¤‡ä»½æ–‡ä»¶ã€‚ä¸‹è½½è¿‡ç¨‹ä¸­è¯·å‹¿å…³é—­é¡µé¢ã€‚");
    const a = streamSaver.createWriteStream("EPhone-Full-Backup-Streamed-" + new Date().toISOString().split("T")[0] + ".json");
    const b = a.getWriter();
    const c = new TextEncoder();
    try {
      await b.write(c.encode(`{
"version": 3,
"timestamp": ` + Date.now() + `,
"data": {
`));
      const a = await Gb.tables.map(a => a.name);
      for (let d = 0; d < a.length; d++) {
        const e = a[d];
        const f = Gb.table(e);
        await b.write(c.encode("\"" + e + "\": [\n"));
        let g = true;
        await f.each(a => {
          if (!g) {
            b.write(c.encode(",\n"));
          }
          b.write(c.encode(JSON.stringify(a)));
          g = false;
        });
        await b.write(c.encode("\n]"));
        if (d < a.length - 1) {
          await b.write(c.encode(",\n"));
        }
      }
      await b.write(c.encode(`
}
}`));
    } catch (a) {
      console.error("æµå¼å¯¼å‡ºè¿‡ç¨‹ä¸­å‡ºé”™:", a);
      await Bb("å¯¼å‡ºå¤±è´¥", "åœ¨å†™å…¥æ–‡ä»¶æµæ—¶å‘ç”Ÿé”™è¯¯: " + a.message);
    } finally {
      await b.close();
    }
  }
  async function oo() {
    await Bb("æ­£åœ¨å‡†å¤‡...", "æ­£åœ¨è¯»å–æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ä¸­ï¼Œè¯·ç¨å€™...");
    try {
      const a = {
        version: 3,
        timestamp: Date.now(),
        data: {}
      };
      const b = Gb.tables.map(a => a.name);
      for (const c of b) {
        const b = await Gb.table(c).toArray();
        a.data[c] = b;
        console.log("å·²æ‰“åŒ…è¡¨: " + c + ", è®°å½•æ•°: " + b.length);
      }
      const c = new Blob([JSON.stringify(a, null, 2)], {
        type: "application/json"
      });
      const d = URL.createObjectURL(c);
      const e = document.createElement("a");
      e.href = d;
      e.download = "EPhone-Full-Backup-Legacy-" + new Date().toISOString().split("T")[0] + ".json";
      e.click();
      URL.revokeObjectURL(d);
      await Bb("å¯¼å‡ºæˆåŠŸ", "å·²æˆåŠŸå¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼");
    } catch (a) {
      console.error("ä¼ ç»Ÿå¯¼å‡ºæ•°æ®æ—¶å‡ºé”™:", a);
      await Bb("å¯¼å‡ºå¤±è´¥", "å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: " + a.message);
    }
  }
  function po() {
    const a = Object.values(v.chats).reduce((a, b) => {
      if (b.id === v.activeChatId) {
        return a;
      }
      return a + (b.unreadCount || 0);
    }, 0);
    const b = Ha || 0;
    const c = a + b;
    const d = document.getElementById("back-to-list-btn");
    if (!d) {
      return;
    }
    let e = d.querySelector(".unread-indicator");
    if (!e) {
      e = document.createElement("span");
      e.className = "unread-indicator";
      d.appendChild(e);
    }
    let f = d.querySelector(".unread-indicator.back-btn-indicator");
    if (f) {
      f.remove();
    }
    if (c > 0) {
      e.textContent = c > 99 ? "99+" : c;
      e.style.display = "block";
      e.style.zIndex = "20";
      e.style.transform = "scale(0.8)";
    } else {
      e.style.display = "none";
    }
  }
  async function qo(a) {
    const b = a === "uncategorized" ? {
      id: "uncategorized",
      name: "æœªåˆ†ç±»"
    } : await Gb.stickerCategories.get(a);
    if (!b) {
      console.error("æ— æ³•ä¸ºä¸å­˜åœ¨çš„åˆ†ç±»æ‰“å¼€ç»‘å®šæ¨¡æ€æ¡†:", a);
      return;
    }
    const c = document.getElementById("sticker-binding-modal");
    const d = document.getElementById("sticker-binding-chat-list");
    const e = c.querySelector(".modal-header span");
    d.innerHTML = "";
    e.textContent = "å°†åˆ†ç±» â€œ" + b.name + "â€ ç»‘å®šåˆ°...";
    const f = Object.values(v.chats).sort((a, b) => a.name.localeCompare(b.name, "zh-CN"));
    f.forEach(b => {
      const c = Array.isArray(b.settings?.stickerCategoryIds) && b.settings.stickerCategoryIds.includes(a);
      const e = document.createElement("div");
      e.className = "contact-picker-item";
      e.innerHTML = "\n            <input type=\"checkbox\" class=\"sticker-binding-checkbox\" data-chat-id=\"" + b.id + "\" " + (c ? "checked" : "") + " style=\"margin-right: 15px;\">\n            <img src=\"" + (b.isGroup ? b.settings.groupAvatar : b.settings.aiAvatar || Na) + "\" class=\"avatar\">\n            <span class=\"name\">" + b.name + "</span>\n        ";
      d.appendChild(e);
    });
    document.getElementById("save-sticker-binding-btn").onclick = () => ro(a);
    document.getElementById("cancel-sticker-binding-btn").onclick = () => c.classList.remove("visible");
    c.classList.add("visible");
  }
  async function ro(a) {
    const b = new Set(Array.from(document.querySelectorAll("#sticker-binding-chat-list .sticker-binding-checkbox:checked")).map(a => a.dataset.chatId));
    const c = [];
    for (const d in v.chats) {
      const e = v.chats[d];
      if (!Array.isArray(e.settings.stickerCategoryIds)) {
        e.settings.stickerCategoryIds = [];
      }
      const f = e.settings.stickerCategoryIds.includes(a);
      const g = b.has(d);
      if (f && !g) {
        e.settings.stickerCategoryIds = e.settings.stickerCategoryIds.filter(b => b !== a);
        c.push(e);
      } else if (!f && g) {
        e.settings.stickerCategoryIds.push(a);
        c.push(e);
      }
    }
    if (c.length > 0) {
      await Gb.chats.bulkPut(c);
      await Bb("ä¿å­˜æˆåŠŸ", "è¡¨æƒ…åŒ…åˆ†ç±»ç»‘å®šå·²æ›´æ–°ï¼");
    }
    document.getElementById("sticker-binding-modal").classList.remove("visible");
  }
  function so(a) {
    if (!a || !a.settings.stickerCategoryIds || a.settings.stickerCategoryIds.length === 0) {
      return "";
    }
    const b = a.settings.stickerCategoryIds;
    let c = [];
    const d = new Set();
    b.forEach(a => {
      let b;
      if (a === "uncategorized") {
        b = v.userStickers.filter(a => !a.categoryId);
      } else {
        b = v.userStickers.filter(b => b.categoryId === a);
      }
      b.forEach(a => {
        if (!d.has(a.name)) {
          c.push(a);
          d.add(a.name);
        }
      });
    });
    if (c.length === 0) {
      return "";
    }
    const e = c.map(a => "- " + a.name).join("\n");
    return `
# å¯ç”¨è¡¨æƒ…åŒ… (é€‰å¡«)
# ã€ã€ã€è¡¨æƒ…ä½¿ç”¨é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘ã€‘ã€‘
1.  ä½ ã€åªèƒ½ã€‘åœ¨åŒæ—¶å‘é€äº†ã€æœ‰æ„ä¹‰çš„æ–‡æœ¬å†…å®¹ã€‘ä¹‹åŽï¼Œæ‰èƒ½ã€é¢å¤–ã€‘è¿½åŠ ä¸€ä¸ªè¡¨æƒ…ã€‚
2.  ã€ç»å¯¹ç¦æ­¢ã€‘åªå‘é€ä¸€ä¸ªè¡¨æƒ…ä½œä¸ºå•ç‹¬çš„å›žå¤ã€‚
3.  ã€ç»å¯¹ç¦æ­¢ã€‘å‘æ˜Žæˆ–ç¼–é€ åˆ—è¡¨ä¸­ä¸å­˜åœ¨çš„è¡¨æƒ…å«ä¹‰ã€‚
4.  å¦‚æžœä½ åœ¨åˆ—è¡¨ä¸­æ‰¾ä¸åˆ°ã€100%å®Œç¾ŽåŒ¹é…ã€‘çš„è¡¨æƒ…ï¼Œè¯·ã€ä¸è¦ã€‘ä½¿ç”¨ "sticker" æŒ‡ä»¤ï¼Œåªå‘é€æ–‡æœ¬ã€‚
5. ã€ä½¿ç”¨é¢‘çŽ‡ã€‘: ä½ ã€ä¸åº”è¯¥ã€‘åœ¨æ¯ä¸€è½®å¯¹è¯ä¸­éƒ½å‘é€è¡¨æƒ…ã€‚è¯·åªåœ¨ä½ è§‰å¾—ã€éžå¸¸å¿…è¦ã€‘æˆ–ã€æƒ…ç»ªç‰¹åˆ«å¼ºçƒˆã€‘æ—¶æ‰ä½¿ç”¨è¡¨æƒ…ï¼Œä¿æŒå¯¹è¯çš„è‡ªç„¶æ€§ã€‚
6.  **ã€é‡å¤æƒ©ç½š (æœ€é«˜é“å¾‹ï¼)ã€‘**: ä½ ã€ç»å¯¹ç¦æ­¢ã€‘è¿žç»­å‡ è½®å›žå¤ä½¿ç”¨ã€å®Œå…¨ç›¸åŒã€‘çš„è¡¨æƒ…å«ä¹‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æžœä½ ä¸Šä¸€è½®å›žå¤äº† "meaning": "å®³ç¾ž"ï¼Œé‚£ä¹ˆä½ è¿™ä¸€è½®ã€ç»å¯¹ä¸èƒ½ã€‘å†æ¬¡ä½¿ç”¨ "meaning": "å®³ç¾ž"ã€‚ä½ å¿…é¡»é€‰æ‹©ä¸€ä¸ªä¸åŒçš„å«ä¹‰ï¼Œæˆ–è€…å¹²è„†ä¸å‘è¡¨æƒ…ã€‚
- **å¯ç”¨åˆ—è¡¨**:
` + e + "\n";
  }
  function to(a) {
    if (!a || !a.isGroup) {
      return "";
    }
    const b = new Set();
    a.members.forEach(a => {
      if (a.id === "user") {
        return;
      }
      const c = v.chats[a.id];
      if (c && c.settings.stickerCategoryIds) {
        c.settings.stickerCategoryIds.forEach(a => b.add(a));
      }
    });
    if (b.size === 0) {
      return "";
    }
    let c = [];
    const d = new Set();
    b.forEach(a => {
      let b;
      if (a === "uncategorized") {
        b = v.userStickers.filter(a => !a.categoryId);
      } else {
        b = v.userStickers.filter(b => b.categoryId === a);
      }
      b.forEach(a => {
        if (!d.has(a.name)) {
          c.push(a);
          d.add(a.name);
        }
      });
    });
    if (c.length === 0) {
      return "";
    }
    const e = c.map(a => "- " + a.name).join("\n");
    return `
# å¯ç”¨è¡¨æƒ…åŒ… (å…¨ç¾¤å…±äº«)
# ã€ã€ã€è¡¨æƒ…ä½¿ç”¨é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘ã€‘ã€‘
1.  ã€ç»å¯¹ç¦æ­¢ã€‘åªå‘é€ä¸€ä¸ªè¡¨æƒ…ä½œä¸ºå•ç‹¬çš„å›žå¤ã€‚
2.  ã€ç»å¯¹ç¦æ­¢ã€‘å‘æ˜Žæˆ–ç¼–é€ åˆ—è¡¨ä¸­ä¸å­˜åœ¨çš„è¡¨æƒ…å«ä¹‰ã€‚
3.  å¦‚æžœæ²¡æ‰¾åˆ°åˆé€‚çš„ï¼Œè¯·ä¸è¦ä½¿ç”¨ "sticker" æŒ‡ä»¤ã€‚
4.  **ã€è§’è‰²åˆ†é…ã€‘**: ä½ å¯ä»¥ä»Žä¸‹é¢çš„ã€å…±äº«åˆ—è¡¨ã€‘ä¸­é€‰æ‹©ä»»æ„è¡¨æƒ…ï¼Œå¹¶å°†å…¶åˆ†é…ç»™ã€ä»»æ„AIè§’è‰²ã€‘ã€‚
5. ã€ä½¿ç”¨é¢‘çŽ‡ã€‘: è¯·åªåœ¨ä½ è§‰å¾—ã€éžå¸¸å¿…è¦ã€‘æˆ–ã€æƒ…ç»ªç‰¹åˆ«å¼ºçƒˆã€‘æ—¶æ‰ä½¿ç”¨è¡¨æƒ…ï¼Œä¿æŒå¯¹è¯çš„è‡ªç„¶æ€§ã€‚
6.  **ã€é‡å¤æƒ©ç½š (æœ€é«˜é“å¾‹ï¼)ã€‘**: ä½ ã€ç»å¯¹ç¦æ­¢ã€‘è¿žç»­å‡ è½®å›žå¤ä½¿ç”¨ã€å®Œå…¨ç›¸åŒã€‘çš„è¡¨æƒ…å«ä¹‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æžœä½ ä¸Šä¸€è½®å›žå¤äº† "meaning": "å®³ç¾ž"ï¼Œé‚£ä¹ˆä½ è¿™ä¸€è½®ã€ç»å¯¹ä¸èƒ½ã€‘å†æ¬¡ä½¿ç”¨ "meaning": "å®³ç¾ž"ã€‚ä½ å¿…é¡»é€‰æ‹©ä¸€ä¸ªä¸åŒçš„å«ä¹‰ï¼Œæˆ–è€…å¹²è„†ä¸å‘è¡¨æƒ…ã€‚
- **å¯ç”¨åˆ—è¡¨**:
` + e + "\n";
  }
  function uo(a) {
    if (!a) {
      return 0;
    }
    return Math.ceil(a.length / 1.5);
  }
  async function vo() {
    if (!v.activeChatId) {
      return 0;
    }
    const a = v.chats[v.activeChatId];
    if (!a) {
      return 0;
    }
    const b = parseInt(document.getElementById("max-memory").value) || 10;
    const c = parseInt(document.getElementById("linked-memory-count").value) || 10;
    const d = document.getElementById("offline-mode-toggle").checked;
    const e = document.getElementById("ai-persona").value;
    const f = document.getElementById("my-persona").value;
    let g = "";
    const h = Array.from(document.querySelectorAll("#world-book-checkboxes-container input:checked")).map(a => a.value.replace("book_", ""));
    if (h.length > 0) {
      const a = h.map(a => {
        const b = v.worldBooks.find(b => b.id === a);
        if (!b || !Array.isArray(b.content)) {
          return "";
        }
        return b.content.filter(a => a.enabled !== false).map(a => a.content).join("\n");
      }).filter(Boolean).join("\n");
      g += a;
    }
    if (a.longTermMemory && a.longTermMemory.length > 0) {
      g += a.longTermMemory.map(a => a.content).join("\n");
    }
    const i = document.getElementById("link-memory-toggle").checked;
    if (i) {
      const a = Array.from(document.querySelectorAll("#linked-chats-checkboxes-container input:checked")).map(a => a.value);
      for (const b of a) {
        const a = v.chats[b];
        if (a && a.history.length > 0) {
          g += a.history.slice(-c).map(a => String(a.content)).join("\n");
        }
      }
    }
    if (a.isGroup) {
      a.members.forEach(a => {
        g += a.persona;
      });
    } else {
      g += e;
    }
    g += f;
    g += so(a);
    if (a.isGroup) {
      g += to(a);
    }
    if (!a.isGroup && d) {
      const a = document.getElementById("offline-preset-select").value;
      if (a) {
        const b = v.presets.find(b => b.id === a);
        if (b) {
          g += b.content.filter(a => a.enabled !== false).map(a => a.content).join("\n");
        }
      }
    }
    const j = a.history.slice(-b);
    g += j.map(a => {
      if (typeof a.content === "string") {
        return a.content;
      }
      if (Array.isArray(a.content)) {
        return a.content.map(a => a.text).join(" ");
      }
      return "";
    }).join("\n");
    return uo(g);
  }
  const wo = Tn(async () => {
    const a = document.getElementById("token-count-value");
    const b = document.getElementById("message-count-value");
    if (!a) {
      return;
    }
    const c = v.activeChatId ? v.chats[v.activeChatId] : null;
    if (b) {
      if (c && c.history) {
        const a = c.history.filter(a => !a.isHidden).length;
        b.textContent = a + " æ¡";
        b.style.color = "#000000";
      } else {
        b.textContent = "--";
      }
    }
    a.textContent = "è®¡ç®—ä¸­...";
    try {
      const c = await vo();
      a.textContent = c + " Tokens";
      a.style.color = "#000000";
      if (document.body.classList.contains("dark-mode") || document.getElementById("phone-screen").classList.contains("dark-mode")) {
        b.style.color = "#ffffff";
        a.style.color = "#ffffff";
      }
    } catch (b) {
      console.error("Token calculation error:", b);
      a.textContent = "Error";
    }
  }, 300);
  async function xo() {
    rd = {
      local: [],
      cloud: []
    };
    sd = {
      local: 0,
      cloud: 0
    };
    td = {
      local: false,
      cloud: false
    };
    const a = [];
    try {
      const b = await Gb.chats.toArray();
      for (const c of b) {
        if (c.history && c.history.length > 0) {
          c.history.forEach(b => {
            if (b.type === "naiimag" && b.imageUrl) {
              a.push({
                sourceType: "chat",
                imageUrl: b.imageUrl,
                prompt: b.prompt || b.fullPrompt || "NAI Image",
                chatId: c.id,
                msgTimestamp: b.timestamp
              });
            }
          });
        }
      }
    } catch (a) {
      console.error("æ‰«æèŠå¤©è®°å½•å¤±è´¥:", a);
    }
    try {
      const b = await Gb.qzonePosts.toArray();
      b.forEach(b => {
        if (b.type === "naiimag") {
          const c = b.imageUrls || (b.imageUrl ? [b.imageUrl] : []);
          const d = Array.isArray(b.prompt) ? b.prompt : [b.prompt || "NAI Image"];
          c.forEach((c, e) => {
            a.push({
              sourceType: "qzone",
              imageUrl: c,
              prompt: d[e] || d[0],
              postId: b.id,
              imageIndex: e
            });
          });
        }
      });
    } catch (a) {
      console.error("æ‰«æåŠ¨æ€å¤±è´¥:", a);
    }
    a.sort((a, b) => (b.msgTimestamp || b.postId || 0) - (a.msgTimestamp || a.postId || 0));
    a.forEach(a => {
      if (a.imageUrl.startsWith("data:image")) {
        rd.local.push(a);
      } else {
        rd.cloud.push(a);
      }
    });
    document.getElementById("nai-gallery-grid-local").innerHTML = "";
    document.getElementById("nai-gallery-grid-cloud").innerHTML = "";
    yo("local");
    document.getElementById("nai-gallery-panel").classList.add("visible");
  }
  function yo(a) {
    if (pd) {
      Bo();
    }
    ud = a;
    document.querySelectorAll(".nai-gallery-tab").forEach(b => {
      b.classList.toggle("active", b.dataset.tabId === a);
    });
    document.querySelectorAll(".nai-gallery-page").forEach(b => {
      b.classList.toggle("active", b.id === "nai-gallery-grid-" + a);
    });
    const b = rd[a];
    const c = sd[a];
    const d = document.getElementById("nai-gallery-grid-" + a);
    if (c === 0) {
      d.innerHTML = "";
      if (b.length === 0) {
        const b = a === "local" ? "æœ¬åœ°ç”»å»Šæ˜¯ç©ºçš„ï¼Œå¿«åŽ»ç”Ÿæˆä¸€äº›å›¾ç‰‡å§ï¼" : "å›¾åºŠç”»å»Šæ˜¯ç©ºçš„ï¼Œè¯·ä»Žâ€œæœ¬åœ°â€ä¸Šä¼ å›¾ç‰‡ã€‚";
        d.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); grid-column: 1 / -1;\">" + b + "</p>";
      } else {
        Ao();
      }
    }
    Co();
  }
  function zo(a, b) {
    if (a.length === 0 && sd[ud] === 0) {
      const a = ud === "local" ? "æœ¬åœ°ç”»å»Šæ˜¯ç©ºçš„ï¼Œå¿«åŽ»ç”Ÿæˆä¸€äº›å›¾ç‰‡å§ï¼" : "å›¾åºŠç”»å»Šæ˜¯ç©ºçš„ã€‚";
      b.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); grid-column: 1 / -1;\">" + a + "</p>";
      return;
    }
    const c = document.createDocumentFragment();
    a.forEach((a, b) => {
      const d = document.createElement("div");
      d.className = "nai-gallery-item";
      d.title = a.prompt;
      const e = a.sourceType + "_" + (a.chatId || a.postId) + "_" + (a.msgTimestamp || a.imageIndex);
      d.dataset.key = e;
      d.dataset.imageUrl = a.imageUrl;
      d.dataset.prompt = a.prompt;
      d.innerHTML = "\n            <div class=\"nai-image-container\" style=\"background-image: url(" + a.imageUrl + `)">
                <div class="nai-gallery-controls">
                    <button class="nai-gallery-download-btn" title="ä¸‹è½½">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
                    </button>
                    <button class="nai-gallery-delete-btn" title="åˆ é™¤">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                    </button>
                </div>
            </div>
            <span class="nai-gallery-name">` + a.prompt + "</span>\n        ";
      c.appendChild(d);
    });
    b.appendChild(c);
  }
  async function Ao() {
    const a = ud;
    if (td[a] || sd[a] >= rd[a].length) {
      return;
    }
    td[a] = true;
    const b = document.getElementById("nai-gallery-grid-" + a);
    tn(b, "bottom");
    // TOLOOK
    setTimeout(() => {
      if (ud !== a) {
        td[a] = false;
        un(b);
        return;
      }
      const c = rd[a].slice(sd[a], sd[a] + vd);
      un(b);
      if (c.length > 0) {
        zo(c, b);
        sd[a] += c.length;
      }
      td[a] = false;
    }, 500);
  }
  function Bo() {
    pd = !pd;
    const a = document.getElementById("nai-gallery-grid-" + ud);
    const b = document.getElementById("manage-nai-gallery-btn");
    const c = document.getElementById("nai-gallery-action-bar");
    const d = document.getElementById("select-all-nai-gallery-checkbox");
    a.classList.toggle("management-mode", pd);
    if (pd) {
      b.textContent = "å®Œæˆ";
      c.style.display = "flex";
      qd.clear();
      d.checked = false;
      Co();
      document.querySelectorAll(".nai-gallery-page").forEach(a => a.classList.add("management-mode"));
    } else {
      b.textContent = "ç®¡ç†";
      c.style.display = "none";
      document.querySelectorAll(".nai-gallery-page").forEach(a => a.classList.remove("management-mode"));
      a.querySelectorAll(".nai-gallery-item.selected").forEach(a => a.classList.remove("selected"));
    }
  }
  function Co() {
    const a = document.getElementById("delete-selected-nai-gallery-btn");
    const b = document.getElementById("download-selected-nai-gallery-btn");
    const c = document.getElementById("upload-selected-nai-gallery-btn");
    const d = document.getElementById("export-selected-nai-gallery-btn");
    const e = qd.size;
    if (a) {
      a.textContent = "åˆ é™¤ (" + e + ")";
    }
    if (b) {
      b.textContent = "ä¸‹è½½ (" + e + ")";
    }
    if (d) {
      d.textContent = "å¯¼å‡º (" + e + ")";
      d.style.display = ud === "cloud" ? "block" : "none";
    }
    if (c) {
      c.textContent = "ä¸Šä¼  (" + e + ")";
      const a = ud === "local" && v.apiConfig.imgbbEnable && v.apiConfig.imgbbApiKey;
      c.style.display = a ? "block" : "none";
    }
  }
  async function Do() {
    if (qd.size === 0) {
      alert("è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„å›¾ç‰‡ã€‚");
      return;
    }
    let a = "";
    let b = 0;
    qd.forEach(c => {
      const d = rd.cloud.find(a => {
        const b = a.sourceType + "_" + (a.chatId || a.postId) + "_" + (a.msgTimestamp || a.imageIndex);
        return b === c;
      });
      if (d && d.imageUrl) {
        a += d.imageUrl + "\n";
        b++;
      }
    });
    if (b === 0) {
      alert("æœªæ‰¾åˆ°æ‰€é€‰å›¾ç‰‡çš„æ•°æ®ï¼ˆè¯·ç¡®è®¤æ‚¨åœ¨â€˜å›¾åºŠâ€™åˆ†ç±»ä¸‹ï¼‰ã€‚");
      return;
    }
    const c = a.trim();
    const d = "batch-export-nai-textarea-" + Date.now();
    const e = `
        <p style="text-align:left; font-size: 14px; margin: 0 0 10px 0;">
            å·²æå– ` + b + ` æ¡é“¾æŽ¥ï¼š
        </p>
        <textarea id="` + d + `" 
                  rows="10" 
                  style="width: 100%; font-size: 12px; resize: vertical; border-radius: 6px; border: 1px solid #ccc;"
                  readonly>` + c + "</textarea>\n    ";
    Bb("å¤åˆ¶é“¾æŽ¥", e);
    const f = document.getElementById("custom-modal-confirm");
    if (f) {
      f.textContent = "ä¸€é”®å¤åˆ¶";
      const a = f.onclick;
      f.onclick = async b => {
        try {
          await navigator.clipboard.writeText(c);
          f.textContent = "å¤åˆ¶æˆåŠŸ!";
          // TOLOOK
          setTimeout(() => {
            f.textContent = "å®Œæˆ";
            f.onclick = a;
          }, 1500);
        } catch (b) {
          alert("è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰æ–‡æœ¬æ¡†æ‰‹åŠ¨å¤åˆ¶ã€‚");
          f.textContent = "å®Œæˆ";
          f.onclick = a;
        }
      };
    }
  }
  function Eo(a) {
    const b = a.target.closest(".nai-gallery-item");
    if (!b) {
      return;
    }
    const c = b.dataset.key;
    const d = b.dataset.imageUrl;
    const e = b.dataset.prompt;
    if (a.target.closest(".nai-gallery-download-btn")) {
      a.stopPropagation();
      zb(d, e);
      return;
    }
    if (a.target.closest(".nai-gallery-delete-btn")) {
      a.stopPropagation();
      Go(new Set([c]));
      return;
    }
    if (pd) {
      b.classList.toggle("selected");
      if (qd.has(c)) {
        qd.delete(c);
      } else {
        qd.add(c);
      }
      Co();
    } else {
      const a = "å›¾ç‰‡è¯¦æƒ…";
      const b = `
                <div style="text-align: center;">
                    <img src="` + d + `" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                </div>
            `;
      Bb(a, b);
    }
  }
  async function Fo() {
    const a = qd;
    if (a.size === 0) {
      alert("è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„å›¾ç‰‡ã€‚");
      return;
    }
    if (typeof JSZip === "undefined" || !window.streamSaver) {
      await Bb("ä¸‹è½½å¤±è´¥", "æ ¸å¿ƒåº“ (JSZip æˆ– StreamSaver) æœªèƒ½æˆåŠŸåŠ è½½ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿žæŽ¥å¹¶åˆ·æ–°é¡µé¢åŽé‡è¯•ã€‚");
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨å‡†å¤‡ " + a.size + " å¼ å›¾ç‰‡...");
    const b = new JSZip();
    let c = 0;
    const d = [];
    const e = Array.from(a);
    e.forEach((a, e) => {
      const f = document.querySelector(".nai-gallery-item[data-key=\"" + a + "\"]");
      if (!f) {
        return;
      }
      const g = f.dataset.imageUrl;
      const h = f.dataset.prompt;
      const i = yb(h);
      const j = i.replace(/\.png$/, "_(" + (e + 1) + ").png");
      const k = (async () => {
        try {
          let a;
          if (g.startsWith("data:")) {
            const b = await fetch(g);
            a = await b.blob();
          } else {
            let b;
            try {
              b = await fetch(g, {
                mode: "cors"
              });
              if (!b.ok) {
                throw new Error("ç›´è¿žå¤±è´¥");
              }
            } catch (a) {
              console.warn("ç›´è¿žå¤±è´¥, å°è¯•ä½¿ç”¨CORSä»£ç†...", a.message);
              const c = Dc();
              let d = c.cors_proxy === "custom" ? c.custom_proxy_url : c.cors_proxy;
              if (!d || d === "") {
                d = "https://corsproxy.io/?";
              }
              const e = d + encodeURIComponent(g);
              b = await fetch(e);
            }
            if (!b.ok) {
              throw new Error("Fetch failed: " + b.status);
            }
            a = await b.blob();
          }
          b.file(j, a, {
            binary: true
          });
        } catch (a) {
          console.error("ä¸‹è½½å›¾ç‰‡å¤±è´¥: " + g, a);
          c++;
        }
      })();
      d.push(k);
    });
    await Promise.all(d);
    if (c === a.size) {
      await Bb("ä¸‹è½½å¤±è´¥", "æ‰€æœ‰å›¾ç‰‡éƒ½ä¸‹è½½å¤±è´¥äº†ã€‚è¿™é€šå¸¸æ˜¯ç”±äºŽç½‘ç»œé—®é¢˜æˆ–CORSè·¨åŸŸé™åˆ¶ï¼ˆè¯·æ£€æŸ¥APIè®¾ç½®ä¸­çš„CORSä»£ç†æ˜¯å¦æœ‰æ•ˆï¼‰ã€‚");
      return;
    }
    await Bb("æ‰“åŒ…ä¸­...", "æ‰€æœ‰å›¾ç‰‡å·²å‡†å¤‡å°±ç»ªï¼Œæ­£åœ¨æµå¼åŽ‹ç¼©... ä¸‹è½½å°†è‡ªåŠ¨å¼€å§‹ã€‚");
    try {
      const d = streamSaver.createWriteStream("NAI_Gallery_Batch_" + Date.now() + ".zip");
      const e = b.generateInternalStream({
        type: "blob",
        streamFiles: true
      });
      const f = new ReadableStream({
        start(a) {
          e.on("data", b => {
            a.enqueue(b);
          }).on("end", () => {
            console.log("ZIP æµç”Ÿæˆå®Œæ¯•ã€‚");
            a.close();
          }).on("error", b => {
            console.error("JSZip æµé”™è¯¯:", b);
            a.error(b);
          }).resume();
        }
      });
      await f.pipeTo(d);
      if (c > 0) {
        Bb("éƒ¨åˆ†ä¸‹è½½å®Œæˆ", "æˆåŠŸæ‰“åŒ… " + (a.size - c) + " å¼ å›¾ç‰‡ã€‚æœ‰ " + c + " å¼ å›¾ç‰‡å› ç½‘ç»œæˆ–CORSé™åˆ¶ä¸‹è½½å¤±è´¥ã€‚");
      }
    } catch (a) {
      console.error("æµå¼ä¸‹è½½ZIPå¤±è´¥:", a);
      await Bb("æµå¼ä¸‹è½½å¤±è´¥", "åˆ›å»ºZIPæµæ—¶å‡ºé”™: " + a.message);
    }
  }
  async function Go(a = null) {
    const b = a || qd;
    if (b.size === 0) {
      return;
    }
    const c = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦ä»Žã€èŠå¤©è®°å½•å’ŒåŠ¨æ€ã€‘ä¸­æ°¸ä¹…åˆ é™¤è¿™ " + b.size + " å¼ NAIå›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", {
      confirmButtonClass: "btn-danger"
    });
    if (!c) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œ...");
    let d = 0;
    const e = new Map();
    const f = new Set();
    const g = new Map();
    const h = new Set();
    for (const c of b) {
      if (c.startsWith("qzone_")) {
        const a = c.split("_");
        const b = parseInt(a[1]);
        if (!isNaN(b)) {
          h.add(b);
        }
      }
    }
    const i = new Map();
    if (h.size > 0) {
      const a = await Gb.qzonePosts.where("id").anyOf(Array.from(h)).toArray();
      a.forEach(a => i.set(a.id, a));
    }
    for (const c of b) {
      const a = c.split("_");
      if (a.length < 3) {
        console.warn("è·³è¿‡æ ¼å¼é”™è¯¯çš„NAIå›¾ç‰‡Key:", c);
        continue;
      }
      const b = a[0];
      const h = a.pop();
      const j = a.slice(1).join("_");
      if (b === "chat") {
        const a = j;
        const b = parseInt(h);
        if (!e.has(a)) {
          const b = await Gb.chats.get(a);
          if (b) {
            e.set(a, b);
          } else {
            console.warn("æœªæ‰¾åˆ° chatID: " + a + "ï¼Œè·³è¿‡...");
            continue;
          }
        }
        const c = e.get(a);
        if (c && c.history) {
          const f = c.history.length;
          c.history = c.history.filter(a => a.timestamp !== b);
          if (c.history.length < f) {
            d++;
            e.set(a, c);
            if (v.chats[a]) {
              v.chats[a].history = c.history;
            }
          }
        }
      } else if (b === "qzone") {
        const a = parseInt(j);
        const b = parseInt(h);
        const c = g.get(a) || i.get(a);
        if (!c) {
          console.warn("æœªæ‰¾åˆ° postID: " + a + "ï¼Œè·³è¿‡...");
          continue;
        }
        const e = c.imageUrls || (c.imageUrl ? [c.imageUrl] : []);
        if (e.length <= 1) {
          f.add(a);
          if (g.has(a)) {
            g.delete(a);
          }
        } else {
          const d = e[b];
          c.imageUrls = c.imageUrls.filter(a => a !== d);
          if (c.prompt && Array.isArray(c.prompt) && c.prompt[b]) {
            c.prompt.splice(b, 1);
          }
          c.imageUrl = c.imageUrls[0] || null;
          g.set(a, c);
        }
        d++;
      }
    }
    try {
      await Gb.transaction("rw", Gb.chats, Gb.qzonePosts, async () => {
        if (e.size > 0) {
          await Gb.chats.bulkPut(Array.from(e.values()));
        }
        if (g.size > 0) {
          await Gb.qzonePosts.bulkPut(Array.from(g.values()));
        }
        if (f.size > 0) {
          await Gb.qzonePosts.bulkDelete(Array.from(f));
        }
      });
      Bo();
      b.forEach(a => {
        rd.local = rd.local.filter(b => {
          const c = b.sourceType + "_" + (b.chatId || b.postId) + "_" + (b.msgTimestamp || b.imageIndex);
          return c !== a;
        });
        rd.cloud = rd.cloud.filter(b => {
          const c = b.sourceType + "_" + (b.chatId || b.postId) + "_" + (b.msgTimestamp || b.imageIndex);
          return c !== a;
        });
      });
      sd[ud] = 0;
      document.getElementById("nai-gallery-grid-" + ud).innerHTML = "";
      Ao();
      await Bb("åˆ é™¤æˆåŠŸ", "å·²æˆåŠŸåˆ é™¤ " + d + " å¼ å›¾ç‰‡ã€‚");
      if (document.getElementById("chat-interface-screen").classList.contains("active")) {
        cd(v.activeChatId);
      }
      if (document.getElementById("qzone-screen").classList.contains("active")) {
        Sb();
      }
    } catch (a) {
      console.error("æ‰¹é‡åˆ é™¤NAIå›¾ç‰‡æ—¶å‡ºé”™:", a);
      await Bb("åˆ é™¤å¤±è´¥", "æ“ä½œå¤±è´¥: " + a.message);
    }
  }
  async function Ho() {
    if (!v.apiConfig.imgbbEnable || !v.apiConfig.imgbbApiKey) {
      await Bb("åŠŸèƒ½æœªå¼€å¯", "è¯·å…ˆåœ¨â€œAPIè®¾ç½®â€ä¸­å¼€å¯ ImgBB è‡ªåŠ¨å›¾åºŠåŠŸèƒ½å¹¶å¡«å†™ API Keyã€‚");
      return;
    }
    const a = Array.from(qd).map(a => document.querySelector(".nai-gallery-item[data-key=\"" + a + "\"]")).filter(a => a && a.dataset.imageUrl && a.dataset.imageUrl.startsWith("data:image"));
    if (a.length === 0) {
      await Bb("æ— éœ€ä¸Šä¼ ", "ä½ é€‰æ‹©çš„å›¾ç‰‡ä¸­æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„æœ¬åœ°å›¾ç‰‡ï¼ˆå®ƒä»¬å¯èƒ½å·²ç»æ˜¯ç½‘ç»œé“¾æŽ¥äº†ï¼‰ã€‚");
      return;
    }
    const b = await wb("ç¡®è®¤ä¸Šä¼ ï¼Ÿ", "å³å°†æŠŠ " + a.length + ` å¼ æœ¬åœ°å›¾ç‰‡ä¸Šä¼ åˆ° ImgBBï¼Œå¹¶æ°¸ä¹…æ›¿æ¢å…¶åœ¨æ•°æ®åº“ä¸­çš„åœ°å€ã€‚æ­¤æ“ä½œä¸å¯é€†ï¼

ï¼ˆä¸Šä¼ æœŸé—´è¯·å‹¿å…³é—­é¡µé¢ï¼‰`, {
      confirmButtonClass: "btn-danger",
      confirmText: "ç¡®è®¤ä¸Šä¼ "
    });
    if (!b) {
      return;
    }
    await Bb("è¯·ç¨å€™...", "æ­£åœ¨å¼€å§‹ä¸Šä¼  " + a.length + " å¼ å›¾ç‰‡...");
    let c = 0;
    let d = 0;
    const e = new Map();
    const f = new Map();
    const g = new Map();
    for (const b of a) {
      const a = b.dataset.key;
      const h = b.dataset.imageUrl;
      try {
        const b = await I(h);
        if (b === h) {
          throw new Error("ä¸Šä¼ å‡½æ•°è¿”å›žäº†åŽŸå§‹Base64ï¼Œå¯èƒ½ä¸Šä¼ å¤±è´¥æˆ–è¢«è·³è¿‡ã€‚");
        }
        const d = a.split("_");
        if (d.length < 3) {
          throw new Error("Keyæ ¼å¼é”™è¯¯: " + a);
        }
        const i = d[0];
        const j = d.pop();
        const k = d.slice(1).join("_");
        if (i === "chat") {
          const d = k;
          const f = parseInt(j);
          let i = e.get(d);
          if (!i) {
            i = await Gb.chats.get(d);
          }
          if (i && i.history) {
            const j = i.history.find(a => a.timestamp === f);
            if (j && j.imageUrl === h) {
              j.imageUrl = b;
              e.set(d, i);
              g.set(a, b);
              c++;
            } else {
              throw new Error("æœªåœ¨èŠå¤© " + d + " ä¸­æ‰¾åˆ°æ—¶é—´æˆ³ä¸º " + f + " ä¸”åŒ¹é…Base64çš„æ¶ˆæ¯ã€‚");
            }
          }
        } else if (i === "qzone") {
          const d = parseInt(k);
          const e = parseInt(j);
          let i = f.get(d);
          if (!i) {
            i = await Gb.qzonePosts.get(d);
          }
          if (i && i.imageUrls && i.imageUrls[e] === h) {
            i.imageUrls[e] = b;
            if (e === 0) {
              i.imageUrl = b;
            }
            f.set(d, i);
            g.set(a, b);
            c++;
          } else {
            throw new Error("æœªåœ¨åŠ¨æ€ " + d + " çš„ç¬¬ " + e + " å¼ å›¾ä¸­æ‰¾åˆ°åŒ¹é…çš„Base64ã€‚");
          }
        }
      } catch (b) {
        d++;
        console.error("ä¸Šä¼ å¤±è´¥ (Key: " + a + "):", b.message);
      }
    }
    try {
      if (e.size > 0 || f.size > 0) {
        await Gb.transaction("rw", Gb.chats, Gb.qzonePosts, async () => {
          if (e.size > 0) {
            await Gb.chats.bulkPut(Array.from(e.values()));
          }
          if (f.size > 0) {
            await Gb.qzonePosts.bulkPut(Array.from(f.values()));
          }
        });
      }
    } catch (a) {
      console.error("æ‰¹é‡æ›´æ–°æ•°æ®åº“å¤±è´¥:", a);
      await Bb("æ•°æ®åº“æ›´æ–°å¤±è´¥", "å›¾ç‰‡ä¸Šä¼ å®Œæˆï¼Œä½†åœ¨ä¿å­˜åˆ°æ•°æ®åº“æ—¶å‡ºé”™: " + a.message);
      return;
    }
    g.forEach((a, b) => {
      const c = rd.find(a => {
        const c = a.sourceType + "_" + (a.chatId || a.postId) + "_" + (a.msgTimestamp || a.imageIndex);
        return c === b;
      });
      if (c) {
        c.imageUrl = a;
      }
      const d = document.querySelector(".nai-gallery-item[data-key=\"" + b + "\"]");
      if (d) {
        d.dataset.imageUrl = a;
        d.querySelector(".nai-image-container").style.backgroundImage = "url(" + a + ")";
      }
    });
    const h = [];
    const i = [];
    rd.local.forEach(a => {
      const b = a.sourceType + "_" + (a.chatId || a.postId) + "_" + (a.msgTimestamp || a.imageIndex);
      if (g.has(b)) {
        a.imageUrl = g.get(b);
        i.push(a);
      } else {
        h.push(a);
      }
    });
    rd.cloud.push(...i);
    rd.local = h;
    sd = {
      local: 0,
      cloud: 0
    };
    let j = `æ‰¹é‡ä¸Šä¼ å®Œæˆï¼

æˆåŠŸ: ` + c + " å¼ \nå¤±è´¥: " + d + " å¼ ";
    if (d > 0) {
      j += `

å¤±è´¥çš„å›¾ç‰‡è¯·æ£€æŸ¥æŽ§åˆ¶å°ï¼ˆConsoleï¼‰ä¸­çš„é”™è¯¯æ—¥å¿—ã€‚`;
    }
    await Bb("æ“ä½œå®Œæˆ", j);
    Bo();
  }
  function yb(a) {
    const b = a || "NAI_Image";
    let c = b.replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, "_").replace(/\s+/g, "_").substring(0, 30);
    if (!c) {
      c = "NAI_Image";
    }
    const d = new Date().toISOString().replace(/[-:]/g, "").replace("T", "_").split(".")[0];
    return c + "_" + d + ".png";
  }
  function Io() {
    const a = document.getElementById("quick-reply-tabs");
    if (a) {
      a.dataset.needsRefresh = "true";
    }
    Jo(true);
    document.getElementById("quick-reply-modal").classList.add("visible");
  }
  async function Jo(a = true) {
    const c = document.getElementById("quick-reply-list");
    const d = document.getElementById("quick-reply-tabs");
    c.innerHTML = "";
    if (a) {
      const a = await Gb.quickReplyCategories.toArray();
      if (d.children.length === 0 || d.dataset.needsRefresh === "true") {
        d.innerHTML = "";
        d.dataset.needsRefresh = "false";
        const b = (a, b) => {
          const c = document.createElement("button");
          c.className = "sticker-category-tab";
          if (Ca === a) {
            c.classList.add("active");
          }
          c.textContent = b;
          c.dataset.categoryId = a;
          c.onclick = () => Qo(a);
          return c;
        };
        d.appendChild(b("all", "å…¨éƒ¨"));
        a.forEach(a => {
          d.appendChild(b(a.id, a.name));
        });
        d.appendChild(b("uncategorized", "æœªåˆ†ç±»"));
      } else {
        const a = d.querySelectorAll(".sticker-category-tab");
        a.forEach(a => {
          if (String(a.dataset.categoryId) === String(Ca)) {
            a.classList.add("active");
            a.scrollIntoView({
              behavior: "smooth",
              block: "nearest",
              inline: "center"
            });
          } else {
            a.classList.remove("active");
          }
        });
      }
    }
    let e;
    if (Ca === "all") {
      e = v.quickReplies;
    } else if (Ca === "uncategorized") {
      e = v.quickReplies.filter(a => !a.categoryId);
    } else {
      e = v.quickReplies.filter(a => a.categoryId == Ca);
    }
    if (!e || e.length === 0) {
      const a = Ca === "all" ? "ä½ è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•å¿«æ·å›žå¤ã€‚<br>ç‚¹å‡»å³ä¸Šè§’â€œ+â€å·æ·»åŠ ç¬¬ä¸€æ¡å§ï¼" : "è¿™ä¸ªåˆ†ç±»ä¸‹è¿˜æ²¡æœ‰å›žå¤å“¦~";
      c.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">" + a + "</p>";
      return;
    }
    e.forEach(a => {
      const d = document.createElement("div");
      d.className = "quick-reply-item";
      const e = V.has(a.id);
      if (e) {
        d.classList.add("selected");
      }
      d.innerHTML = "\n            <input type=\"checkbox\" class=\"quick-reply-checkbox\" " + (e ? "checked" : "") + `>
            
            <span class="quick-reply-text" data-text="` + b(a.text) + "\">" + b(a.text) + `</span>
            <div class="quick-reply-actions">
                <button class="quick-reply-edit-btn" data-id="` + a.id + `" title="ç¼–è¾‘">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button class="quick-reply-delete-btn" data-id="` + a.id + `" title="åˆ é™¤">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        `;
      d.addEventListener("click", b => {
        if (U) {
          if (!b.target.closest(".quick-reply-actions")) {
            Lo(a.id);
            const b = d.querySelector(".quick-reply-checkbox");
            if (b) {
              b.checked = !b.checked;
            }
          }
        } else {
          const c = b.target.closest(".quick-reply-text");
          const d = b.target.closest(".quick-reply-edit-btn");
          const e = b.target.closest(".quick-reply-delete-btn");
          if (c) {
            Wo(c.dataset.text);
          } else if (d) {
            Xo(a.id);
          } else if (e) {
            Yo(a.id);
          }
        }
      });
      c.appendChild(d);
    });
  }
  function Ko() {
    U = !U;
    const a = document.getElementById("quick-reply-list");
    const b = document.getElementById("quick-reply-action-bar");
    const c = document.getElementById("quick-reply-normal-footer");
    const d = document.getElementById("batch-quick-reply-btn");
    if (U) {
      a.classList.add("management-mode");
      b.style.display = "flex";
      c.style.display = "none";
      d.textContent = "å®Œæˆ";
      d.style.color = "var(--accent-color)";
    } else {
      a.classList.remove("management-mode");
      b.style.display = "none";
      c.style.display = "flex";
      d.textContent = "æ‰¹é‡";
      d.style.color = "";
      V.clear();
      Mo();
      Jo(false);
    }
  }
  function Lo(a) {
    if (V.has(a)) {
      V.delete(a);
    } else {
      V.add(a);
    }
    Mo();
    const b = document.querySelectorAll("#quick-reply-list .quick-reply-item");
    b.forEach(a => {});
    Jo(false);
  }
  function Mo() {
    const a = V.size;
    document.getElementById("move-selected-quick-replies-btn").textContent = "ç§»åŠ¨ (" + a + ")";
    document.getElementById("delete-selected-quick-replies-btn").textContent = "åˆ é™¤ (" + a + ")";
  }
  function No() {
    const a = document.getElementById("select-all-quick-replies-checkbox").checked;
    let b;
    if (Ca === "all") {
      b = v.quickReplies;
    } else if (Ca === "uncategorized") {
      b = v.quickReplies.filter(a => !a.categoryId);
    } else {
      b = v.quickReplies.filter(a => a.categoryId == Ca);
    }
    if (a) {
      b.forEach(a => V.add(a.id));
    } else {
      V.clear();
    }
    Mo();
    Jo(false);
  }
  async function Oo() {
    if (V.size === 0) {
      return alert("è¯·å…ˆé€‰æ‹©å›žå¤ã€‚");
    }
    const a = await Gb.quickReplyCategories.toArray();
    const b = [{
      text: "æœªåˆ†ç±»",
      value: "uncategorized"
    }, ...a.map(a => ({
      text: a.name,
      value: a.id
    }))];
    const c = await Eb("ç§»åŠ¨åˆ°åˆ†ç±»", b);
    if (!c) {
      return;
    }
    const d = c === "uncategorized" ? null : parseInt(c);
    await Gb.transaction("rw", Gb.quickReplies, async () => {
      for (const a of V) {
        await Gb.quickReplies.update(a, {
          categoryId: d
        });
        const b = v.quickReplies.find(b => b.id === a);
        if (b) {
          b.categoryId = d;
        }
      }
    });
    await Bb("æˆåŠŸ", "å·²ç§»åŠ¨ " + V.size + " æ¡å›žå¤ã€‚");
    Ko();
    Jo(false);
  }
  async function Po() {
    if (V.size === 0) {
      return alert("è¯·å…ˆé€‰æ‹©å›žå¤ã€‚");
    }
    const a = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ " + V.size + " æ¡å›žå¤å—ï¼Ÿ");
    if (!a) {
      return;
    }
    const b = Array.from(V);
    await Gb.quickReplies.bulkDelete(b);
    v.quickReplies = v.quickReplies.filter(a => !V.has(a.id));
    await Bb("æˆåŠŸ", "å·²åˆ é™¤é€‰ä¸­å›žå¤ã€‚");
    Ko();
    Jo(false);
  }
  function Qo(a) {
    Ca = a;
    Jo(true);
  }
  async function Ro() {
    const a = await Db("æ·»åŠ å¿«æ·å›žå¤", "è¯·è¾“å…¥è¦æ·»åŠ çš„å›žå¤å†…å®¹ï¼š", "", "textarea");
    if (a && a.trim()) {
      let b = null;
      if (Ca !== "all" && Ca !== "uncategorized") {
        b = Ca;
      }
      const c = {
        text: a.trim(),
        categoryId: b
      };
      const d = await Gb.quickReplies.add(c);
      v.quickReplies.push({
        id: d,
        ...c
      });
      Jo(false);
    } else if (a !== null) {
      alert("å†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
    }
  }
  async function So() {
    await To();
    document.getElementById("quick-reply-category-manager-modal").classList.add("visible");
  }
  async function To() {
    const a = document.getElementById("existing-quick-reply-categories-list");
    const b = await Gb.quickReplyCategories.toArray();
    a.innerHTML = "";
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align: center; color: var(--text-secondary);\">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>";
      return;
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "existing-group-item";
      c.innerHTML = "\n            <span class=\"group-name\">" + b.name + "</span>\n            <span class=\"delete-group-btn\" data-id=\"" + b.id + "\">Ã—</span>\n        ";
      c.querySelector(".delete-group-btn").onclick = () => Vo(b.id);
      a.appendChild(c);
    });
  }
  async function Uo() {
    const a = document.getElementById("new-quick-reply-category-name-input");
    const b = a.value.trim();
    if (!b) {
      alert("åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼");
      return;
    }
    const c = await Gb.quickReplyCategories.where("name").equals(b).first();
    if (c) {
      alert("åˆ†ç±» \"" + b + "\" å·²ç»å­˜åœ¨äº†ï¼");
      return;
    }
    await Gb.quickReplyCategories.add({
      name: b
    });
    a.value = "";
    await To();
    document.getElementById("quick-reply-tabs").dataset.needsRefresh = "true";
  }
  async function Vo(a) {
    const b = await Gb.quickReplyCategories.get(a);
    if (!b) {
      return;
    }
    const c = await wb("ç¡®è®¤åˆ é™¤åˆ†ç±»", "åˆ é™¤åˆ†ç±»ã€Š" + b.name + "ã€‹åŽï¼Œè¯¥åˆ†ç±»ä¸‹çš„å›žå¤å°†å˜ä¸ºâ€œæœªåˆ†ç±»â€ã€‚ç¡®å®šå—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (c) {
      await Gb.quickReplyCategories.delete(a);
      const b = v.quickReplies.filter(b => b.categoryId == a);
      for (const a of b) {
        a.categoryId = null;
        await Gb.quickReplies.put(a);
      }
      await To();
      if (Ca == a) {
        Ca = "all";
      }
      document.getElementById("quick-reply-tabs").dataset.needsRefresh = "true";
      await Jo(true);
    }
  }
  function Wo(a) {
    const b = document.getElementById("chat-input");
    b.value = a;
    document.getElementById("quick-reply-modal").classList.remove("visible");
    b.focus();
  }
  async function Xo(a) {
    const b = await Gb.quickReplies.get(a);
    if (!b) {
      return;
    }
    const c = await Db("ä¿®æ”¹å¿«æ·å›žå¤", "è¯·ä¿®æ”¹å›žå¤å†…å®¹ï¼š", b.text, "textarea");
    if (c && c.trim()) {
      await Gb.quickReplies.update(a, {
        text: c.trim()
      });
      const b = v.quickReplies.find(b => b.id === a);
      if (b) {
        b.text = c.trim();
      }
      Jo();
    } else if (c !== null) {
      alert("å†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
    }
  }
  async function Yo(a) {
    const b = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤è¿™æ¡å¿«æ·å›žå¤å—ï¼Ÿ", {
      confirmButtonClass: "btn-danger"
    });
    if (b) {
      await Gb.quickReplies.delete(a);
      v.quickReplies = v.quickReplies.filter(b => b.id !== a);
      Jo();
    }
  }
  async function Zo() {
    const a = document.getElementById("char-bilibili-search-input");
    const b = a.value.trim();
    if (!b) {
      return;
    }
    const c = document.getElementById("char-bilibili-list");
    c.innerHTML = "<div class=\"spinner\"></div>";
    const d = a => new Promise(b => // TOLOOK
    setTimeout(b, a));
    try {
      const a = 15;
      let e = [];
      for (let c = 1; c <= a; c++) {
        const a = "https://api.52vmy.cn/api/query/bilibili/video?msg=" + encodeURIComponent(b) + "&n=" + c;
        const f = "https://corsproxy.io/?" + encodeURIComponent(a);
        let g = 0;
        let h = false;
        const i = 3;
        while (!h && g < i) {
          try {
            const a = await fetch(f);
            if (!a.ok) {
              throw new Error("HTTP error! status: " + a.status);
            }
            const b = await a.text();
            if (b.includes("è®¿é—®è¿‡å¿«") || b.includes("é¢‘ç¹") || b.includes("Too Many Requests")) {
              console.warn("âš ï¸ èŽ·å–ç¬¬ " + c + " æ¡è§¦å‘é™æµï¼Œç­‰å¾…å†·å´...");
              await d(1500 + g * 1000);
              g++;
              continue;
            }
            let i;
            try {
              i = JSON.parse(b);
            } catch (a) {
              console.warn("ç¬¬ " + c + " æ¡è¿”å›žæ ¼å¼é”™è¯¯:", b.substring(0, 50));
              g++;
              continue;
            }
            if (i.data) {
              if (Array.isArray(i.data)) {
                e.push(...i.data);
              } else {
                e.push(i.data);
              }
            } else if (i.title) {
              e.push(i);
            } else if (i.code === 200 && i.data) {
              if (Array.isArray(i.data)) {
                e.push(...i.data);
              } else {
                e.push(i.data);
              }
            }
            h = true;
          } catch (a) {
            console.warn("èŽ·å–ç¬¬ " + c + " æ¡è§†é¢‘ç½‘ç»œé”™è¯¯:", a);
            g++;
            await d(1000);
          }
        }
        await d(800);
      }
      const f = [];
      const g = new Set();
      e.forEach(a => {
        const b = a.url || a.arcurl;
        if (b && !g.has(b)) {
          g.add(b);
          f.push(a);
        }
      });
      c.innerHTML = "";
      if (f.length === 0) {
        c.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">æœªæ‰¾åˆ°ç›¸å…³è§†é¢‘ï¼Œæˆ–æŽ¥å£æš‚æ—¶ä¸å¯ç”¨</p>";
        return;
      }
      f.forEach(a => {
        const b = document.createElement("div");
        b.className = "bilibili-item";
        b.innerHTML = `
                <div class="bili-cover" style="position: relative; overflow: hidden;">
                    <img src="` + (a.img_url || a.pic) + `" referrerpolicy="no-referrer" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1;">
                    <div class="bili-duration" style="position: absolute; z-index: 2;">â–¶</div>
                </div>
                <div class="bili-info">
                    <div class="bili-title">` + a.title + "</div>\n                    <div class=\"bili-author\">UP: " + (a.user || a.author) + `</div>
                </div>
            `;
        b.onclick = () => $o(a);
        c.appendChild(b);
      });
    } catch (a) {
      console.error("Bilibili search error:", a);
      c.innerHTML = "<p style=\"text-align:center; color: var(--text-secondary); padding: 50px 0;\">æœç´¢å‡ºé”™ï¼Œè¯·ç¨åŽå†è¯•</p>";
    }
  }
  function $o(a) {
    const b = document.getElementById("char-bilibili-player-screen");
    const c = document.getElementById("char-bilibili-video");
    const d = document.getElementById("char-bilibili-player-title");
    const e = document.getElementById("char-bilibili-player-author");
    const f = document.getElementById("char-bilibili-player-desc");
    c.src = a.url;
    d.textContent = a.title;
    e.textContent = "UPä¸»: " + a.user;
    f.textContent = a.desc || "æš‚æ— ç®€ä»‹";
    Lk("char-bilibili-player-screen");
    c.play().catch(a => console.log("Autoplay blocked", a));
  }
  function _o() {
    const a = document.getElementById("char-bilibili-video");
    a.pause();
    a.src = "";
    Lk("char-bilibili-screen");
  }
  window.closeCharBilibiliPlayer = function () {
    const a = document.getElementById("char-bilibili-video");
    if (a) {
      a.pause();
      a.src = "";
    }
    Lk("char-bilibili-screen");
  };
  let ap = {
    passwordBuffer: "",
    isLocked: false
  };
  function bp() {
    const a = document.getElementById("lock-screen");
    if (v.globalSettings.lockScreenEnabled) {
      if (v.globalSettings.lockScreenWallpaper) {
        a.style.backgroundImage = "url(" + v.globalSettings.lockScreenWallpaper + ")";
      } else {
        a.style.backgroundImage = "linear-gradient(135deg, #1c1c1e, #3a3a3c)";
      }
      ap.isLocked = true;
      a.classList.add("active");
      cp();
      // TOLOOK
      setInterval(cp, 1000);
    }
    const b = document.getElementById("lock-screen-toggle");
    const c = document.getElementById("lock-screen-settings-detail");
    const d = document.getElementById("lock-screen-password-input");
    const e = document.getElementById("lock-wallpaper-preview");
    if (b) {
      b.checked = v.globalSettings.lockScreenEnabled || false;
      c.style.display = b.checked ? "block" : "none";
      b.addEventListener("change", a => {
        c.style.display = a.target.checked ? "block" : "none";
      });
    }
    if (d) {
      d.value = v.globalSettings.lockScreenPassword || "";
    }
    if (v.globalSettings.lockScreenWallpaper) {
      e.style.backgroundImage = "url(" + v.globalSettings.lockScreenWallpaper + ")";
      e.textContent = "";
    }
  }
  function cp() {
    if (!ap.isLocked) {
      return;
    }
    const a = new Date();
    const b = a.toLocaleTimeString("zh-CN", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: false
    });
    const c = a.toLocaleDateString("zh-CN", {
      month: "long",
      day: "numeric",
      weekday: "long"
    });
    document.getElementById("lock-time").textContent = b;
    document.getElementById("lock-date").textContent = c;
  }
  function dp() {
    const a = document.getElementById("lock-screen");
    const b = document.getElementById("lock-password-area");
    a.classList.add("input-mode");
    b.style.display = "flex";
    ap.passwordBuffer = "";
    fp();
  }
  function ep() {
    const a = document.getElementById("lock-screen");
    const b = document.getElementById("lock-password-area");
    a.classList.remove("input-mode");
    b.style.display = "none";
    ap.passwordBuffer = "";
  }
  function fp() {
    const a = document.querySelectorAll(".lock-dots .dot");
    const b = ap.passwordBuffer.length;
    a.forEach((a, c) => {
      if (c < b) {
        a.classList.add("filled");
      } else {
        a.classList.remove("filled");
      }
    });
  }
  function gp(a) {
    if (ap.passwordBuffer.length < 4) {
      ap.passwordBuffer += a;
      fp();
      if (ap.passwordBuffer.length === 4) {
        // TOLOOK
        setTimeout(ip, 200);
      }
    }
  }
  function hp() {
    if (ap.passwordBuffer.length > 0) {
      ap.passwordBuffer = ap.passwordBuffer.slice(0, -1);
      fp();
    }
  }
  function ip() {
    const a = v.globalSettings.lockScreenPassword;
    if (ap.passwordBuffer === a) {
      const a = document.getElementById("lock-screen");
      a.classList.add("unlocking");
      ap.isLocked = false;
      // TOLOOK
      setTimeout(() => {
        a.classList.remove("active");
        a.classList.remove("unlocking");
        ep();
      }, 500);
    } else {
      const a = document.querySelector(".lock-dots");
      a.classList.add("shake-animation");
      if (navigator.vibrate) {
        navigator.vibrate(200);
      }
      // TOLOOK
      setTimeout(() => {
        a.classList.remove("shake-animation");
        ap.passwordBuffer = "";
        fp();
      }, 400);
    }
  }
  const jp = document.getElementById("lock-swipe-area");
  const kp = document.getElementById("lock-screen");
  function lp() {
    if (kp.classList.contains("input-mode")) {
      return;
    }
    if (v.globalSettings.lockScreenPassword) {
      dp();
    } else {
      kp.classList.add("unlocking");
      ap.isLocked = false;
      // TOLOOK
      setTimeout(() => {
        kp.classList.remove("active");
        kp.classList.remove("unlocking");
      }, 500);
    }
  }
  if (jp) {
    jp.addEventListener("click", lp);
  }
  if (kp) {
    let a = 0;
    let b = 0;
    kp.addEventListener("touchstart", b => {
      a = b.changedTouches[0].screenY;
    }, {
      passive: true
    });
    kp.addEventListener("touchend", c => {
      b = c.changedTouches[0].screenY;
      const d = a - b;
      if (d > 50) {
        lp();
      }
    });
  }
  document.querySelectorAll(".lock-keypad .key").forEach(a => {
    a.addEventListener("click", b => {
      b.stopPropagation();
      const c = a.dataset.action;
      if (c === "delete") {
        hp();
      } else if (a.dataset.num) {
        gp(a.dataset.num);
      }
    });
  });
  const mp = document.querySelector(".lock-cancel-btn");
  if (mp) {
    mp.addEventListener("click", ep);
  }
  const np = document.getElementById("lock-wallpaper-input");
  if (np) {
    np.addEventListener("change", async a => {
      const b = a.target.files[0];
      if (b) {
        const a = await new Promise(a => {
          const c = new FileReader();
          c.onload = () => a(c.result);
          c.readAsDataURL(b);
        });
        const c = document.getElementById("lock-wallpaper-preview");
        c.style.backgroundImage = "url(" + a + ")";
        c.textContent = "";
        c.dataset.tempUrl = a;
        if (v.apiConfig.imgbbEnable && v.apiConfig.imgbbApiKey) {
          (async () => {
            try {
              await Bb("è¯·ç¨å€™...", "æ­£åœ¨ä¸Šä¼ é”å±å£çº¸åˆ° ImgBB...");
              const b = await I(a);
              c.dataset.tempUrl = b;
              await Bb("æˆåŠŸ", "é”å±å£çº¸å·²ä¸Šä¼ ï¼");
            } catch (a) {
              console.error(a);
            }
          })();
        }
      }
      a.target.value = null;
    });
  }
  document.getElementById("upload-lock-wallpaper-url-btn").addEventListener("click", async () => {
    const a = await Db("ç½‘ç»œå›¾ç‰‡", "è¯·è¾“å…¥é”å±å£çº¸çš„URL", "", "url");
    if (a && a.trim()) {
      const b = document.getElementById("lock-wallpaper-preview");
      b.style.backgroundImage = "url(" + a + ")";
      b.textContent = "";
      b.dataset.tempUrl = a;
    }
  });
  function op(a) {
    return window.btoa(unescape(encodeURIComponent(a)));
  }
  function pp(a) {
    return decodeURIComponent(escape(window.atob(a)));
  }
  async function qp(a = false) {
    let b = null;
    if (!v.apiConfig.githubEnable) {
      if (!a) {
        await Bb("æœªå¼€å¯", "è¯·å…ˆåœ¨â€œAPIè®¾ç½®â€ -> â€œGitHub äº‘å¤‡ä»½â€ä¸­å¼€å¯æ­¤åŠŸèƒ½ã€‚");
      }
      return;
    }
    const c = v.apiConfig.githubUsername;
    const d = v.apiConfig.githubRepo;
    const e = v.apiConfig.githubToken;
    const f = (v.apiConfig.githubFilename || "ephone_backup").replace(/\.json$/i, "");
    if (!c || !d || !e) {
      if (!a) {
        await Bb("é…ç½®ç¼ºå¤±", "è¯·å…ˆåœ¨è®¾ç½®ä¸­ä¿å­˜ GitHub ç”¨æˆ·åã€ä»“åº“åå’Œ Tokenï¼");
      }
      return;
    }
    if (!a) {
      const a = await wb("ç¡®è®¤ä¸Šä¼ å¤‡ä»½", "å³å°†å¤‡ä»½æ•°æ®åˆ° GitHub ä»“åº“ï¼š<br><strong>" + c + "/" + d + "</strong><br><br>é‡‡ç”¨<strong style=\"color:green\">æµå¼ä¸Šä¼ </strong> æ¨¡å¼ã€‚<br>é€Ÿåº¦å°†æ˜¾è‘—æå‡ã€‚<br>ç¡®å®šè¦ç«‹å³ä¸Šä¼ å—ï¼Ÿ", {
        confirmText: "å¼€å§‹æžé€Ÿä¸Šä¼ "
      });
      if (!a) {
        return;
      }
      await Bb("å‡†å¤‡ä¸­...", "æ­£åœ¨åˆå§‹åŒ–å¹¶å‘ä¸Šä¼ ...");
    } else {
      console.log("â³ [è‡ªåŠ¨å¤‡ä»½] å¼€å§‹åŽå°é™é»˜å¤‡ä»½åˆ° GitHub...");
      b = Ab("æ­£åœ¨äº‘ç«¯å¤‡ä»½...", "loading");
    }
    try {
      const g = new Date();
      const h = g.toISOString().split("T")[0];
      const i = "backups/" + h + "/";
      const j = 15728640;
      const k = 50;
      const l = 4;
      let m = 1;
      let n = {};
      let o = 0;
      const p = new Set();
      const q = [];
      const r = async (b, g) => {
        const j = f + "_part" + b + ".json";
        const k = "" + i + j;
        const m = {
          version: 4,
          timestamp: Date.now(),
          type: "slice",
          part: b,
          data: g
        };
        const n = JSON.stringify(m);
        const o = op(n);
        const q = (o.length / 1024 / 1024).toFixed(2);
        if (!a) {
          const a = document.getElementById("custom-modal-body");
          if (a) {
            a.innerHTML = `<div class="spinner" style="margin: 20px auto;"></div>
                    <p style="text-align:center;">
                        æ­£åœ¨å¹¶å‘ä¸Šä¼ ä¸­...<br>
                        å½“å‰é˜Ÿåˆ—: <b>` + (p.size + 1) + "</b> / " + l + "<br>\n                        æ­£åœ¨å¤„ç†åˆ†ç‰‡: #" + b + " (" + q + " MB)\n                    </p>";
          }
        } else {
          console.log("[GitHub] å¼€å§‹ä¸Šä¼ åˆ†ç‰‡ #" + b + "...");
        }
        let r = "https://api.github.com/repos/" + c + "/" + d + "/contents/" + k;
        if (v.apiConfig.githubProxyEnable && v.apiConfig.githubProxyUrl) {
          const a = r.replace("https://api.github.com", "");
          r = v.apiConfig.githubProxyUrl.replace(/\/$/, "") + a;
        }
        let s = null;
        try {
          const a = "" + r + (r.includes("?") ? "&" : "?") + "t=" + Date.now();
          const b = await fetch(a, {
            method: "GET",
            headers: {
              Authorization: "token " + e,
              Accept: "application/vnd.github.v3+json"
            }
          });
          if (b.ok) {
            const a = await b.json();
            s = a.sha;
          }
        } catch (a) {
          console.warn("åˆ†ç‰‡ #" + b + " èŽ·å–SHAå¤±è´¥(å¯èƒ½æ˜¯æ–°æ–‡ä»¶)ï¼Œç»§ç»­ä¸Šä¼ ", a);
        }
        let t = 0;
        const u = 3;
        let w = false;
        let x = null;
        while (!w && t < u) {
          const a = new AbortController();
          const c = // TOLOOK
          setTimeout(() => a.abort(), 180000);
          try {
            const d = await fetch(r, {
              method: "PUT",
              headers: {
                Authorization: "token " + e,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                message: "Auto Backup: " + h + " (Part " + b + ")",
                content: o,
                sha: s || undefined
              }),
              signal: a.signal
            });
            clearTimeout(c);
            if (!d.ok) {
              const a = await d.json();
              throw new Error(a.message || d.statusText);
            }
            w = true;
            console.log("âœ… [GitHub] åˆ†ç‰‡ #" + b + " ä¸Šä¼ æˆåŠŸ");
          } catch (a) {
            clearTimeout(c);
            x = a;
            t++;
            console.warn("âš ï¸ åˆ†ç‰‡ #" + b + " ç¬¬ " + t + " æ¬¡é‡è¯•...");
            await new Promise(a => // TOLOOK
            setTimeout(a, 2000));
          }
        }
        if (!w) {
          throw new Error("åˆ†ç‰‡ #" + b + " æœ€ç»ˆå¤±è´¥: " + x.message);
        }
      };
      const s = Gb.tables.map(a => a.name);
      for (const a of s) {
        const b = await Gb.table(a).count();
        if (b === 0) {
          continue;
        }
        let c = 0;
        while (c < b) {
          const b = await Gb.table(a).offset(c).limit(k).toArray();
          for (const c of b) {
            const b = JSON.stringify(c);
            const d = b.length + a.length + 5;
            if (o + d > j) {
              const a = n;
              const b = m;
              const c = r(b, a).catch(a => {
                console.error(a);
                q.push(a.message);
              });
              p.add(c);
              c.finally(() => p.delete(c));
              if (p.size >= l) {
                await Promise.race(p);
              }
              if (q.length > 0) {
                break;
              }
              n = {};
              o = 0;
              m++;
            }
            if (!n[a]) {
              n[a] = [];
            }
            n[a].push(c);
            o += d;
          }
          if (q.length > 0) {
            break;
          }
          c += k;
        }
        if (q.length > 0) {
          break;
        }
      }
      if (o > 0 && q.length === 0) {
        const a = r(m, n).catch(a => {
          q.push(a.message);
        });
        p.add(a);
      }
      if (!a) {
        const a = document.getElementById("custom-modal-body");
        if (a) {
          a.innerHTML += "<p style=\"color:blue\">æ­£åœ¨ç­‰å¾…æœ€åŽ " + p.size + " ä¸ªåˆ†ç‰‡å®Œæˆ...</p>";
        }
      }
      await Promise.all(p);
      if (q.length > 0) {
        throw new Error("ä¸Šä¼ è¿‡ç¨‹ä¸­å‡ºçŽ°é”™è¯¯:\n" + q.join("\n"));
      }
      if (!a) {
        await Bb("âœ… å¤‡ä»½æˆåŠŸ", "å…¨é‡æ•°æ®å¹¶å‘ä¸Šä¼ å®Œæˆï¼<br>å…±ä¸Šä¼  " + m + " ä¸ªåˆ†ç‰‡ã€‚<br><strong>è·¯å¾„ï¼š</strong> " + i);
      } else {
        console.log("âœ… [è‡ªåŠ¨å¤‡ä»½] æˆåŠŸï¼");
        if (b) {
          b.classList.remove("visible");
          // TOLOOK
          setTimeout(() => b.remove(), 400);
        }
        Ab("äº‘ç«¯å¤‡ä»½å·²å®Œæˆ", "success");
      }
    } catch (c) {
      console.error("GitHub ä¸Šä¼ å¤±è´¥:", c);
      let d = c.message;
      if (c.name === "AbortError") {
        d = "ä¸Šä¼ è¶…æ—¶ (ç½‘ç»œè¾ƒæ…¢æˆ–ä»£ç†ä¸ç¨³å®š)ã€‚";
      }
      if (!a) {
        await Bb("âŒ å¤‡ä»½å¤±è´¥", "ä¸Šä¼ ä¸­æ–­ï¼š\n" + d);
      } else {
        if (b) {
          b.classList.remove("visible");
          // TOLOOK
          setTimeout(() => b.remove(), 400);
        }
        Ab("å¤‡ä»½å¤±è´¥: ç½‘ç»œé”™è¯¯", "error");
      }
    }
  }
  async function rp() {
    if (!v.apiConfig.githubEnable) {
      alert("è¯·å…ˆå¼€å¯ GitHub äº‘å¤‡ä»½åŠŸèƒ½ã€‚");
      return;
    }
    const a = v.apiConfig.githubUsername;
    const b = v.apiConfig.githubRepo;
    const c = v.apiConfig.githubToken;
    if (!a || !b || !c) {
      alert("è¯·å…ˆä¿å­˜ GitHub é…ç½®ï¼");
      return;
    }
    const d = document.getElementById("custom-modal-body");
    const e = document.getElementById("custom-modal-confirm");
    const f = document.getElementById("custom-modal-cancel");
    const g = a => {
      const b = document.getElementById("custom-modal-overlay");
      document.getElementById("custom-modal-title").textContent = "GitHub æ¢å¤";
      d.innerHTML = "<div class=\"spinner\" style=\"margin: 20px auto;\"></div><p style=\"text-align:center;\">" + a + "</p>";
      e.style.display = "none";
      f.style.display = "none";
      b.classList.add("visible");
    };
    const h = async d => {
      let e = "https://api.github.com/repos/" + a + "/" + b + "/contents/" + d;
      if (v.apiConfig.githubProxyEnable && v.apiConfig.githubProxyUrl) {
        const a = e.replace("https://api.github.com", "");
        e = v.apiConfig.githubProxyUrl.replace(/\/$/, "") + a;
      }
      const f = await fetch(e, {
        headers: {
          Authorization: "token " + c,
          Accept: "application/vnd.github.v3+json"
        }
      });
      if (!f.ok) {
        if (f.status === 404) {
          return [];
        }
        throw new Error("GitHub API Error: " + f.status);
      }
      return await f.json();
    };
    try {
      g("æ­£åœ¨æœç´¢å¤‡ä»½...");
      let f = "";
      const i = await h("backups");
      if (i.length > 0) {
        const a = i.filter(a => a.type === "dir");
        if (a.length > 0) {
          document.getElementById("custom-modal-overlay").classList.remove("visible");
          a.sort((a, b) => b.name.localeCompare(a.name));
          const b = a.map(a => ({
            text: "ðŸ“… " + a.name,
            value: a.path
          }));
          const c = await Eb("è¯·é€‰æ‹©å¤‡ä»½æ—¥æœŸ", b);
          if (!c) {
            return;
          }
          f = c;
          g("æ­£åœ¨è¯»å– " + f + " ...");
        }
      }
      const j = await h(f);
      const k = new Map();
      j.forEach(a => {
        if (!a.name.endsWith(".json")) {
          return;
        }
        const b = a.name.match(/^(.*)_part(\d+)\.json$/);
        if (b) {
          const c = b[1];
          const d = parseInt(b[2]);
          if (!k.has(c)) {
            k.set(c, {
              type: "multipart",
              display: c,
              parts: []
            });
          }
          k.get(c).parts.push({
            num: d,
            name: a.name,
            path: a.path
          });
        } else {
          k.set(a.name, {
            type: "single",
            display: a.name,
            name: a.name,
            path: a.path
          });
        }
      });
      if (k.size === 0) {
        throw new Error("æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶ã€‚");
      }
      document.getElementById("custom-modal-overlay").classList.remove("visible");
      const l = [];
      k.forEach((a, b) => {
        let c = a.display;
        if (a.type === "multipart") {
          c += " (" + a.parts.length + " ä¸ªåˆ†ç‰‡)";
        }
        l.push({
          text: c,
          value: b
        });
      });
      const m = await Eb("è¯·é€‰æ‹©è¦æ¢å¤çš„æ¡£æ¡ˆ", l);
      if (!m) {
        return;
      }
      const n = k.get(m);
      const o = await wb("æœ€åŽç¡®è®¤", "å³å°†æ¢å¤æ•°æ®ã€‚æœ¬åœ°æ•°æ®å°†è¢«è¦†ç›–ã€‚ç¡®å®šå—ï¼Ÿ", {
        confirmButtonClass: "btn-danger",
        confirmText: "æ¢å¤"
      });
      if (!o) {
        return;
      }
      g("æ­£åœ¨ä¸‹è½½å¹¶æ¢å¤æ•°æ®...");
      await Gb.transaction("rw", Gb.tables, async () => {
        for (const a of Gb.tables) {
          await a.clear();
        }
      });
      const p = async d => {
        let e = "https://api.github.com/repos/" + a + "/" + b + "/contents/" + d;
        if (v.apiConfig.githubProxyEnable && v.apiConfig.githubProxyUrl) {
          const a = e.replace("https://api.github.com", "");
          e = v.apiConfig.githubProxyUrl.replace(/\/$/, "") + a;
        }
        const f = await fetch(e, {
          headers: {
            Authorization: "token " + c,
            Accept: "application/vnd.github.v3.raw"
          }
        });
        if (!f.ok) {
          throw new Error("ä¸‹è½½å¤±è´¥: " + f.status);
        }
        const g = await f.text();
        let h;
        try {
          h = JSON.parse(g);
        } catch (a) {
          const b = decodeURIComponent(escape(window.atob(g.replace(/\s/g, ""))));
          h = JSON.parse(b);
        }
        const i = h.data || h;
        for (const a of Object.keys(i)) {
          const b = i[a];
          if (Array.isArray(b) && b.length > 0) {
            await Gb.table(a).bulkPut(b);
          }
        }
      };
      if (n.type === "multipart") {
        n.parts.sort((a, b) => a.num - b.num);
        for (let a = 0; a < n.parts.length; a++) {
          const b = n.parts[a];
          d.innerHTML = "<div class=\"spinner\"></div><p style=\"text-align:center;\">æ­£åœ¨å¤„ç†åˆ†ç‰‡ " + (a + 1) + "/" + n.parts.length + "...</p>";
          await p(b.path);
          await new Promise(a => // TOLOOK
          setTimeout(a, 50));
        }
      } else {
        await p(n.path);
      }
      try {
        const a = await Gb.apiConfig.get("main");
        if (a) {
          if (a.imgbbApiKey) {
            localStorage.setItem("imgbb-api-key", a.imgbbApiKey);
          }
          if (a.imgbbEnable !== undefined) {
            localStorage.setItem("imgbb-enabled", a.imgbbEnable);
          }
          if (a.minimaxApiKey) {
            localStorage.setItem("minimax-api-key", a.minimaxApiKey);
          }
          if (a.minimaxGroupId) {
            localStorage.setItem("minimax-group-id", a.minimaxGroupId);
          }
          if (a.githubToken) {
            v.apiConfig.githubToken = a.githubToken;
          }
        }
      } catch (a) {}
      e.style.display = "";
      await Bb("æ¢å¤æˆåŠŸ", "æ‰€æœ‰åˆ†ç‰‡å·²å¤„ç†å®Œæ¯•ï¼Œæ•°æ®å·²æ¢å¤ï¼ç‚¹å‡»ç¡®å®šåˆ·æ–°é¡µé¢ã€‚");
      // TOLOOK
      setTimeout(() => window.location.reload(), 500);
    } catch (a) {
      console.error(a);
      e.style.display = "";
      await Bb("æ¢å¤å¤±è´¥", a.message);
    }
  }
  let sp = null;
  function tp(a) {
    if (sp) {
      clearInterval(sp);
    }
    if (!a) {
      const b = localStorage.getItem("github-backup-interval");
      a = b ? parseInt(b) : 30;
    }
    console.log("âœ… è‡ªåŠ¨å¤‡ä»½å®šæ—¶å™¨å·²å¯åŠ¨ (æ¯ " + a + " åˆ†é’Ÿ)");
    sp = // TOLOOK
    setInterval(async () => {
      const a = localStorage.getItem("github-enabled") === "true";
      const b = localStorage.getItem("github-auto-backup") === "true";
      if (a && b) {
        console.log("â° è§¦å‘å®šæ—¶è‡ªåŠ¨å¤‡ä»½...");
        await qp(true);
      }
    }, a * 60 * 1000);
  }
  const up = localStorage.getItem("github-enabled") === "true";
  const vp = localStorage.getItem("github-auto-backup") === "true";
  if (up && vp) {
    tp();
  }
  function wp() {
    if (sp) {
      clearInterval(sp);
      sp = null;
      console.log("ðŸ›‘ è‡ªåŠ¨å¤‡ä»½å®šæ—¶å™¨å·²åœæ­¢");
    }
  }
  window.startAutoBackupTimer = tp;
  window.stopAutoBackupTimer = wp;
  function xp(a) {
    const b = {
      0: "æ™´æœ— (Clear sky)",
      1: "å¤§éƒ¨æ™´æœ— (Mainly clear)",
      2: "å¤šäº‘ (Partly cloudy)",
      3: "é˜´å¤© (Overcast)",
      45: "æœ‰é›¾ (Fog)",
      48: "ç»“éœœé›¾ (Depositing rime fog)",
      51: "è½»å¾®æ¯›æ¯›é›¨ (Drizzle: Light)",
      53: "ä¸­åº¦æ¯›æ¯›é›¨ (Drizzle: Moderate)",
      55: "å¤§æ¯›æ¯›é›¨ (Drizzle: Dense)",
      61: "å°é›¨ (Rain: Slight)",
      63: "ä¸­é›¨ (Rain: Moderate)",
      65: "å¤§é›¨ (Rain: Heavy)",
      71: "å°é›ª (Snow fall: Slight)",
      73: "ä¸­é›ª (Snow fall: Moderate)",
      75: "å¤§é›ª (Snow fall: Heavy)",
      80: "é˜µé›¨ (Rain showers)",
      81: "ä¸­åº¦é˜µé›¨",
      82: "æš´é›¨",
      95: "é›·é›¨ (Thunderstorm)",
      96: "é›·é›¨ä¼´æœ‰å†°é›¹",
      99: "é‡åº¦é›·é›¨ä¼´æœ‰å†°é›¹"
    };
    return b[a] || "æœªçŸ¥å¤©æ°”";
  }
  async function yp(a) {
    try {
      const b = await fetch("https://geocoding-api.open-meteo.com/v1/search?name=" + encodeURIComponent(a) + "&count=1&language=zh&format=json");
      const c = await b.json();
      if (c.results && c.results.length > 0) {
        return c.results[0];
      }
      return null;
    } catch (a) {
      console.error("åŸŽå¸‚æœç´¢å¤±è´¥:", a);
      return null;
    }
  }
  async function zp(a, b) {
    if (!a || !b) {
      return null;
    }
    try {
      const c = "https://api.open-meteo.com/v1/forecast?latitude=" + a + "&longitude=" + b + "&current=temperature_2m,relative_humidity_2m,weather_code,is_day,wind_speed_10m&timezone=auto";
      const d = await fetch(c);
      const e = await d.json();
      if (e.current) {
        const a = e.current;
        const b = xp(a.weather_code);
        const c = a.is_day ? "ç™½å¤©" : "å¤œæ™š";
        return "æ°”æ¸© " + a.temperature_2m + "Â°C, æ¹¿åº¦ " + a.relative_humidity_2m + "%, " + b + ", " + c + ", é£Žé€Ÿ " + a.wind_speed_10m + "km/h";
      }
      return null;
    } catch (a) {
      console.error("èŽ·å–å¤©æ°”å¤±è´¥:", a);
      return null;
    }
  }
  async function Ap(a) {
    return "";
  }
  let Bp = 0;
  const Cp = 10000;
  async function Dp() {
    try {
      let a = await Gb.userWallet.get("main");
      if (!a || typeof a.balance !== "number" || isNaN(a.balance)) {
        console.warn("æ£€æµ‹åˆ°é’±åŒ…æ•°æ®å¼‚å¸¸ (NaN æˆ– ä¸å­˜åœ¨)ï¼Œæ­£åœ¨é‡ç½®...");
        const b = a && a.kinshipCards ? a.kinshipCards : [];
        a = {
          id: "main",
          balance: 0,
          kinshipCards: b,
          lastResetMonth: ""
        };
        await Gb.userWallet.put(a);
        Bp = 0;
      } else {
        Bp = a.balance;
        if (!a.kinshipCards) {
          a.kinshipCards = [];
          await Gb.userWallet.put(a);
        }
      }
      const b = new Date();
      const c = b.getFullYear() + "-" + (b.getMonth() + 1);
      if (a.lastResetMonth !== c) {
        if (a.kinshipCards && a.kinshipCards.length > 0) {
          a.kinshipCards.forEach(a => {
            a.spent = 0;
          });
          await Gb.userWallet.put(a);
        }
        a.lastResetMonth = c;
        await Gb.userWallet.put(a);
      }
      console.log("ç”¨æˆ·é’±åŒ…åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰ä½™é¢:", Bp);
      const d = document.getElementById("alipay-balance-display");
      if (d) {
        d.textContent = Bp.toFixed(2);
      }
    } catch (a) {
      console.error("åˆå§‹åŒ–é’±åŒ…å¤±è´¥:", a);
      Bp = 0;
    }
  }
  async function Ep(a, b, c) {
    let d = parseFloat(a);
    if (isNaN(d) || d <= 0) {
      console.error("è®°è´¦å¤±è´¥ï¼šé‡‘é¢æ— æ•ˆ", a);
      return false;
    }
    try {
      let a = await Gb.userWallet.get("main");
      if (!a) {
        a = {
          id: "main",
          balance: 0,
          kinshipCards: []
        };
      }
      if (typeof a.balance !== "number") {
        a.balance = 0;
      }
      if (b === "expense") {
        if (a.balance < d) {
          await Bb("æ”¯ä»˜å¤±è´¥", "ä½™é¢ä¸è¶³ï¼å½“å‰: " + a.balance.toFixed(2));
          return false;
        }
        a.balance -= d;
      } else if (b === "income") {
        a.balance += d;
      }
      await Gb.userWallet.put(a);
      window.userBalance = a.balance;
      const e = {
        timestamp: Date.now(),
        type: b,
        amount: d,
        description: c || "æœªçŸ¥äº¤æ˜“"
      };
      await Gb.userTransactions.add(e);
      console.log("âœ… [é’±åŒ…] äº¤æ˜“æˆåŠŸ: " + b + " Â¥" + d.toFixed(2) + ". æ–°ä½™é¢: " + a.balance.toFixed(2));
      return true;
    } catch (a) {
      console.error("å†™å…¥é’±åŒ…æ•°æ®åº“å¤±è´¥:", a);
      alert("ç³»ç»Ÿé”™è¯¯ï¼šè´¦å•å†™å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æŽ§åˆ¶å°ã€‚");
      return false;
    }
  }
  async function Fp() {
    await Dp();
    const a = document.getElementById("alipay-balance-display");
    if (a) {
      const b = isNaN(Bp) ? 0 : Bp;
      a.textContent = b.toFixed(2);
    }
    const b = document.getElementById("alipay-screen");
    const c = document.getElementById("alipay-status-tag");
    if (Bp >= Cp) {
      b.classList.add("theme-blackgold");
      if (c) {
        c.textContent = "é»‘é‡‘ä¼šå‘˜";
      }
    } else {
      b.classList.remove("theme-blackgold");
      if (c) {
        c.textContent = "æ ‡å‡†ä¼šå‘˜";
      }
    }
    const d = document.getElementById("alipay-kinship-section-wrapper");
    if (d) {
      d.remove();
    }
    const e = document.querySelector(".alipay-card-container");
    const f = await Gb.userWallet.get("main");
    const g = f?.kinshipCards || [];
    const h = document.createElement("div");
    h.id = "alipay-kinship-section-wrapper";
    h.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding: 0 5px;">
            <span class="kinship-section-title">äº²å±žå¡ / äº²å¯†ä»˜</span>
            <span id="add-kinship-btn" style="font-size:22px; color:#1677ff; cursor:pointer; line-height:1;">+</span>
        </div>
    `;
    const i = document.createElement("div");
    i.id = "alipay-kinship-section";
    if (g.length === 0) {
      i.innerHTML = `
            <div class="kinship-empty-state" style="background:white; width:100%; border-radius:12px; padding:20px; text-align:center; color:#999; box-shadow:0 2px 8px rgba(0,0,0,0.03);">
                <p style="margin:0; font-size:13px;">æš‚æ— äº²å±žå¡ï¼Œå¿«åŽ»é‚€è¯·TAå§</p>
            </div>`;
    } else {
      g.forEach(a => {
        const b = v.chats[a.chatId];
        const c = b ? b.name : "æœªçŸ¥è§’è‰²";
        const d = b ? b.settings.aiAvatar || Na : Na;
        const e = a.limit - (a.spent || 0);
        const f = document.createElement("div");
        f.className = "kinship-card-entry";
        f.innerHTML = "\n                <button class=\"alipay-unbind-btn\" data-chat-id=\"" + a.chatId + `">è§£ç»‘</button>
                <div class="kinship-top">
                    <div class="kinship-provider">
                        <img src="` + d + "\">\n                        <span>" + c + ` (èµ )</span>
                    </div>
                    <span style="font-size:11px; opacity:0.8;">æ¶ˆè´¹å¯¹æ–¹å¯è§</span>
                </div>
                <div class="kinship-label">æœ¬æœˆå‰©ä½™é¢åº¦</div>
                <div class="kinship-limit">Â¥ ` + e.toFixed(2) + "</div>\n            ";
        i.appendChild(f);
      });
    }
    h.appendChild(i);
    e.appendChild(h);
    const j = h.querySelector("#add-kinship-btn");
    if (j) {
      j.onclick = Np;
    }
    if (typeof Hp === "function") {
      await Hp();
    }
    Kb("alipay-screen");
  }
  async function Gp() {
    const a = document.getElementById("alipay-screen");
    if (a && a.classList.contains("active")) {
      await Jp(true);
    }
  }
  async function Hp() {
    const a = document.getElementById("alipay-transaction-list");
    a.style.display = "flex";
    a.style.flexDirection = "column";
    a.style.height = "100%";
    a.style.overflow = "hidden";
    a.innerHTML = "";
    const b = document.createElement("div");
    b.className = "bill-filter-header";
    b.innerHTML = `
        <div class="bill-date-picker-wrapper">
            <input type="month" id="bill-date-input" class="bill-date-input" value="` + u.filterDate + `">
        </div>
        <div class="bill-type-tabs">
            <span class="bill-type-tab active" data-type="all">å…¨éƒ¨</span>
            <span class="bill-type-tab" data-type="expense">æ”¯å‡º</span>
            <span class="bill-type-tab" data-type="income">æ”¶å…¥</span>
        </div>
    `;
    a.appendChild(b);
    const c = document.createElement("div");
    c.id = "bill-scroll-list";
    a.appendChild(c);
    const d = document.createElement("div");
    d.id = "bill-loader";
    d.className = "bill-loading-more hidden";
    d.textContent = "æ­£åœ¨åŠ è½½æ›´å¤š...";
    c.appendChild(d);
    Ip();
    await Jp(true);
  }
  function Ip() {
    const a = document.getElementById("bill-date-input");
    a.addEventListener("change", a => {
      u.filterDate = a.target.value;
      Jp(true);
    });
    const b = document.querySelectorAll(".bill-type-tab");
    b.forEach(a => {
      a.addEventListener("click", a => {
        b.forEach(a => a.classList.remove("active"));
        a.target.classList.add("active");
        u.filterType = a.target.dataset.type;
        Jp(true);
      });
    });
    const c = document.getElementById("bill-scroll-list");
    c.addEventListener("scroll", () => {
      const {
        scrollTop: a,
        scrollHeight: b,
        clientHeight: d
      } = c;
      if (b - a <= d + 50 && u.hasMore && !u.isLoading) {
        Jp(false);
      }
    });
  }
  async function Jp(a = false) {
    if (u.isLoading) {
      return;
    }
    const b = document.getElementById("bill-scroll-list");
    const c = document.getElementById("bill-loader");
    u.isLoading = true;
    c.classList.remove("hidden");
    if (a) {
      u.page = 0;
      u.hasMore = true;
      const a = b.querySelectorAll(".bill-item, .bill-month-separator, .bill-empty-msg");
      a.forEach(a => a.remove());
      b.scrollTop = 0;
    }
    try {
      let d = Gb.userTransactions.orderBy("timestamp").reverse();
      let e = await d.toArray();
      if (u.filterType !== "all") {
        e = e.filter(a => a.type === u.filterType);
      }
      if (u.filterDate) {
        const [a, b] = u.filterDate.split("-");
        e = e.filter(c => {
          const d = new Date(c.timestamp);
          return d.getFullYear() === parseInt(a) && d.getMonth() + 1 === parseInt(b);
        });
      }
      const f = u.page * u.pageSize;
      const g = f + u.pageSize;
      const h = e.slice(f, g);
      if (h.length < u.pageSize) {
        u.hasMore = false;
        c.textContent = "â€” æ²¡æœ‰æ›´å¤šè®°å½•äº† â€”";
        c.classList.remove("hidden");
      } else {
        c.textContent = "åŠ è½½ä¸­...";
      }
      if (h.length === 0 && a) {
        b.insertAdjacentHTML("afterbegin", "<div class=\"bill-empty-msg\" style=\"text-align:center; padding:40px; color:#999;\">æš‚æ— ç›¸å…³è´¦å•</div>");
      } else {
        Kp(h, b, c);
      }
      u.page++;
    } catch (a) {
      console.error("åŠ è½½è´¦å•å¤±è´¥:", a);
      c.textContent = "åŠ è½½å¤±è´¥";
    } finally {
      u.isLoading = false;
      if (u.hasMore) {
        c.classList.add("hidden");
      }
    }
  }
  function Kp(a, b, c) {
    let d = "";
    const e = b.querySelectorAll(".bill-month-separator");
    if (e.length > 0) {
      d = e[e.length - 1].textContent;
    }
    const f = document.createDocumentFragment();
    a.forEach(a => {
      let b = Number(a.amount);
      if (isNaN(b)) {
        console.warn("æ£€æµ‹åˆ°å¼‚å¸¸è´¦å•æ•°æ® (é‡‘é¢æ— æ•ˆ):", a);
        b = 0;
      }
      const c = new Date(a.timestamp);
      const e = c.getFullYear() + "å¹´" + (c.getMonth() + 1) + "æœˆ";
      if (e !== d) {
        const a = document.createElement("div");
        a.className = "bill-month-separator";
        a.textContent = e;
        f.appendChild(a);
        d = e;
      }
      const g = String(c.getMonth() + 1).padStart(2, "0") + "-" + String(c.getDate()).padStart(2, "0") + " " + String(c.getHours()).padStart(2, "0") + ":" + String(c.getMinutes()).padStart(2, "0");
      const h = a.type === "income";
      const i = h ? "+" : "-";
      const j = h ? "income" : "expense";
      const k = document.createElement("div");
      k.className = "bill-item";
      k.innerHTML = `
            <div class="bill-info">
                <div class="bill-title">` + (a.description || "æœªçŸ¥äº¤æ˜“") + "</div>\n                <div class=\"bill-time\">" + g + `</div>
            </div>
            <div class="bill-amount ` + j + "\">" + i + b.toFixed(2) + "</div>\n        ";
      f.appendChild(k);
    });
    b.insertBefore(f, c);
  }
  async function Lp() {
    const a = await Db("å……å€¼", "è¯·è¾“å…¥å……å€¼é‡‘é¢ (CNY):", "", "number");
    if (!a) {
      return;
    }
    const b = parseFloat(a);
    if (isNaN(b) || b <= 0) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢");
      return;
    }
    await Ep(b, "income", "ä½™é¢å……å€¼");
    Fp();
    await Bb("å……å€¼æˆåŠŸ", "æˆåŠŸå……å€¼ Â¥" + b.toFixed(2));
  }
  window.openAlipayScreen = Fp;
  window.handleUserTopUp = Lp;
  let Mp = null;
  async function Np() {
    const a = Object.values(v.chats).filter(a => !a.isGroup);
    if (a.length === 0) {
      return alert("æ²¡æœ‰å¯ç»‘å®šçš„è§’è‰²");
    }
    const b = document.getElementById("kinship-creation-modal");
    const c = document.getElementById("kinship-char-list");
    const d = document.getElementById("kinship-limit-input");
    let e = document.getElementById("kinship-type-container");
    if (!e) {
      e = document.createElement("div");
      e.id = "kinship-type-container";
      e.style.cssText = "margin-bottom: 15px; display: flex; gap: 10px; justify-content: center;";
      const a = d.parentElement;
      a.parentElement.insertBefore(e, a);
    }
    e.innerHTML = `
        <label class="radio-btn-wrapper" style="flex:1;">
            <input type="radio" name="kinship-type" value="grant" checked>
            <div class="radio-btn-content" style="text-align:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <div style="font-weight:bold; color:#ff5252;">æˆ‘é€TA</div>
                <div style="font-size:12px; color:#666;">(èŠ±æˆ‘çš„é’±)</div>
            </div>
        </label>
        <label class="radio-btn-wrapper" style="flex:1;">
            <input type="radio" name="kinship-type" value="request">
            <div class="radio-btn-content" style="text-align:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <div style="font-weight:bold; color:#1677ff;">é—®TAè¦</div>
                <div style="font-size:12px; color:#666;">(èŠ±TAçš„é’±)</div>
            </div>
        </label>
    `;
    const f = e.querySelectorAll("input[name=\"kinship-type\"]");
    const g = () => {
      f.forEach(a => {
        const b = a.nextElementSibling;
        if (a.checked) {
          b.style.borderColor = a.value === "grant" ? "#ff5252" : "#1677ff";
          b.style.backgroundColor = a.value === "grant" ? "#fff0f0" : "#f0f7ff";
        } else {
          b.style.borderColor = "#ddd";
          b.style.backgroundColor = "#fff";
        }
      });
    };
    f.forEach(a => a.addEventListener("change", g));
    g();
    c.innerHTML = "";
    Mp = null;
    d.value = "";
    a.forEach(a => {
      const b = document.createElement("div");
      b.className = "clear-posts-item";
      b.dataset.id = a.id;
      b.onclick = () => {
        c.querySelectorAll(".clear-posts-item").forEach(a => {
          a.classList.remove("selected");
          const b = a.querySelector(".checkbox");
          if (b) {
            b.classList.remove("selected");
          }
        });
        b.classList.add("selected");
        const d = b.querySelector(".checkbox");
        d.classList.add("selected");
        Mp = a.id;
      };
      const d = a.settings.aiAvatar || Na;
      b.innerHTML = `
            <div class="checkbox" style="pointer-events: none;"></div>
            <img src="` + d + "\" style=\"width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover;\">\n            <span class=\"name\" style=\"font-weight: 500; font-size: 16px;\">" + a.name + "</span>\n        ";
      c.appendChild(b);
    });
    b.classList.add("visible");
  }
  async function Op(a, b, c = "grant") {
    const d = v.chats[a];
    const e = d.settings.myNickname || "æˆ‘";
    let f = "";
    if (c === "grant") {
      f = "[æˆ‘ä¸ºä½ å¼€é€šäº†â€œäº²å±žå¡â€ï¼Œæ¯æœˆé¢åº¦ Â¥" + b + "]";
    } else {
      f = "[æˆ‘å‘ä½ å‘èµ·äº†â€œäº²å±žå¡â€ä»£ä»˜ç”³è¯·ï¼Œæ¯æœˆé¢åº¦ Â¥" + b + "]";
    }
    const g = {
      role: "user",
      type: "kinship_request",
      content: f,
      limit: b,
      status: "pending",
      requestType: c,
      timestamp: Date.now()
    };
    d.history.push(g);
    let h = "";
    if (c === "grant") {
      h = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·(" + e + ")ä¸ºä½ å¼€é€šäº†æ”¯ä»˜å®â€œäº²å±žå¡â€ï¼ˆäº²å¯†ä»˜ï¼‰ï¼Œæ¯æœˆé¢åº¦ Â¥" + b + "ã€‚è¿™æ„å‘³ç€ä½ çš„æ¶ˆè´¹å°†ç”±ç”¨æˆ·ä¹°å•ã€‚è¯·æ ¹æ®ä½ ä»¬çš„å…³ç³»ï¼ˆæ˜¯å¦æ„¿æ„æŽ¥å—å¯¹æ–¹çš„é¦ˆèµ ï¼‰å†³å®šæŽ¥å—è¿˜æ˜¯æ‹’ç»ã€‚è¯·ä½¿ç”¨ 'kinship_response' æŒ‡ä»¤è¿›è¡Œå›žåº”ã€‚]";
    } else {
      h = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·(" + e + ")å‘ä½ ç”³è¯·å¼€é€šæ”¯ä»˜å®â€œäº²å±žå¡â€ï¼ˆäº²å¯†ä»˜ï¼‰ï¼Œæ¯æœˆé¢åº¦ Â¥" + b + "ã€‚è¿™æ„å‘³ç€ç”¨æˆ·çš„æ¶ˆè´¹å°†ç”±ä½ ä¹°å•ã€‚è¯·æ ¹æ®ä½ çš„ç»æµŽçŠ¶å†µå’Œå¯¹ç”¨æˆ·çš„å® çˆ±ç¨‹åº¦ï¼Œå†³å®šæŽ¥å—è¿˜æ˜¯æ‹’ç»ã€‚è¯·ä½¿ç”¨ 'kinship_response' æŒ‡ä»¤è¿›è¡Œå›žåº”ã€‚]";
    }
    const i = {
      role: "system",
      content: h,
      timestamp: Date.now() + 1,
      isHidden: true
    };
    d.history.push(i);
    await Gb.chats.put(d);
    if (v.activeChatId === a) {
      Pd(g, d);
      Td();
    } else {
      Qd(a);
    }
  }
  async function Pp() {
    const a = await Gb.funds.count();
    if (a === 0) {
      const a = [{
        id: "f01",
        code: "001001",
        name: "æ‹›è´¢è¿›å®æ··åˆ",
        riskLevel: "medium",
        currentNav: 1.52,
        lastDayNav: 1.51,
        history: []
      }, {
        id: "f02",
        code: "002088",
        name: "ç§‘æŠ€å…ˆé”‹æˆé•¿",
        riskLevel: "high",
        currentNav: 2.305,
        lastDayNav: 2.28,
        history: []
      }, {
        id: "f03",
        code: "003099",
        name: "ç¨³å¥å€ºåŸºA",
        riskLevel: "low",
        currentNav: 1.05,
        lastDayNav: 1.049,
        history: []
      }, {
        id: "f04",
        code: "005666",
        name: "æ–°èƒ½æºç²¾é€‰",
        riskLevel: "high",
        currentNav: 3.1,
        lastDayNav: 3.2,
        history: []
      }, {
        id: "f05",
        code: "008888",
        name: "æ¶ˆè´¹çº¢åˆ©æŒ‡æ•°",
        riskLevel: "medium",
        currentNav: 1.88,
        lastDayNav: 1.885,
        history: []
      }, {
        id: "f06",
        code: "110022",
        name: "å…¨çƒåŒ»ç–—åŒ»è¯",
        riskLevel: "high",
        currentNav: 0.95,
        lastDayNav: 0.94,
        history: []
      }];
      await Gb.funds.bulkAdd(a);
    }
    const b = await Gb.userWallet.get("main");
    if (b && !b.fundHoldings) {
      b.fundHoldings = [];
      await Gb.userWallet.put(b);
    }
  }
  function Qp() {
    const a = 10000;
    const b = Bp >= a;
    const c = ["alipay-screen", "fund-screen"];
    c.forEach(a => {
      const c = document.getElementById(a);
      if (c) {
        if (b) {
          c.classList.add("theme-blackgold");
        } else {
          c.classList.remove("theme-blackgold");
        }
      }
    });
    const d = document.getElementById("alipay-status-tag");
    if (d) {
      if (b) {
        d.textContent = "é»‘é‡‘ä¼šå‘˜";
        d.style.color = "#d4af37";
        d.style.borderColor = "#d4af37";
      } else {
        d.textContent = "æ ‡å‡†ä¼šå‘˜";
        d.style.color = "white";
        d.style.borderColor = "white";
      }
    }
    const e = document.getElementById("alipay-balance-display");
    if (e) {
      e.textContent = Bp.toFixed(2);
    }
  }
  async function Rp() {
    const a = await Gb.funds.toArray();
    const b = [];
    const c = (Math.random() - 0.45) * 0.05;
    for (const d of a) {
      if (!d.history || d.history.length === 0) {
        d.history = [];
        let a = d.currentNav;
        for (let b = 0; b < 15; b++) {
          a = a * (1 - (Math.random() - 0.5) * 0.02);
          d.history.unshift(parseFloat(a.toFixed(4)));
        }
      }
      let a = 0.01;
      if (d.riskLevel === "medium") {
        a = 0.03;
      }
      if (d.riskLevel === "high") {
        a = 0.06;
      }
      const e = (Math.random() - 0.5) * a;
      const f = c + e;
      if (d.history.length >= 20) {
        d.history.shift();
      }
      d.history.push(d.currentNav);
      const g = d.currentNav;
      let h = g * (1 + f);
      if (h < 0.1) {
        h = 0.1;
      }
      d.lastDayNav = g;
      d.currentNav = parseFloat(h.toFixed(4));
      b.push(d);
    }
    await Gb.funds.bulkPut(b);
  }
  async function Sp() {
    await Rp();
    Qp();
    await Up();
    Kb("fund-screen");
  }
  let Tp = "market";
  async function Up() {
    const a = await Gb.funds.toArray();
    const b = await Gb.userWallet.get("main");
    const c = b.fundHoldings || [];
    let d = 0;
    let e = 0;
    let f = 0;
    c.forEach(b => {
      const c = a.find(a => a.id === b.fundId);
      if (c) {
        const a = b.units * c.currentNav;
        const g = b.units * b.cost;
        const h = b.units * c.lastDayNav;
        d += a;
        e += a - g;
        f += a - h;
      }
    });
    document.getElementById("fund-total-assets").textContent = d.toFixed(2);
    const g = document.getElementById("fund-total-profit");
    g.textContent = (e >= 0 ? "+" : "") + e.toFixed(2);
    g.style.color = e >= 0 ? "#ff9c9c" : "#a0f0a0";
    const h = document.getElementById("fund-yesterday-profit");
    h.textContent = (f >= 0 ? "+" : "") + f.toFixed(2);
    if (Tp === "market") {
      Wp(a);
    } else {
      Xp(a, c);
    }
  }
  function Vp(a, b) {
    if (!a || a.length < 2) {
      return "";
    }
    const c = 60;
    const d = 20;
    const e = b ? "#ff3b30" : "#4cd964";
    const f = Math.min(...a);
    const g = Math.max(...a);
    const h = g - f || 1;
    const i = a.map((b, e) => {
      const g = e / (a.length - 1) * c;
      const i = d - (b - f) / h * d;
      return g + "," + i;
    }).join(" ");
    return "\n        <svg width=\"" + c + "\" height=\"" + d + "\" viewBox=\"0 0 " + c + " " + d + "\" style=\"overflow:visible;\">\n            <polyline fill=\"none\" stroke=\"" + e + "\" stroke-width=\"2\" points=\"" + i + `" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
  }
  function Wp(a) {
    const b = document.getElementById("fund-market-list");
    b.style.display = "block";
    document.getElementById("fund-my-list").style.display = "none";
    b.innerHTML = "";
    a.forEach(a => {
      const c = (a.currentNav - a.lastDayNav) / a.lastDayNav * 100;
      const d = c >= 0;
      const e = d ? "fund-up" : "fund-down";
      const f = d ? "+" : "";
      let g;
      let h;
      let i;
      if (a.riskLevel === "high") {
        g = "#fff1f0";
        h = "#ff4d4f";
        i = "é«˜é£Žé™©";
      } else if (a.riskLevel === "medium") {
        g = "#fff7e6";
        h = "#fa8c16";
        i = "ä¸­é£Žé™©";
      } else {
        g = "#f6ffed";
        h = "#52c41a";
        i = "ç¨³å¥";
      }
      const j = "<span class=\"fund-tag\" style=\"background:" + g + "; color:" + h + ";\">" + i + "</span>";
      const k = [...(a.history || []), a.currentNav];
      const l = Vp(k, d);
      const m = document.createElement("div");
      m.className = "fund-item";
      m.onclick = () => $p("buy", a);
      m.innerHTML = `
            <div class="fund-info" style="flex: 1.2;">
                <h4 style="margin-bottom:6px; font-size:15px;">` + a.name + `</h4>
                <div class="fund-tags">
                    <span class="fund-tag" style="background:#f5f5f5; color:#999;">` + a.code + "</span>\n                    " + j + `
                </div>
            </div>
            
            <div class="fund-chart" style="flex: 1; display:flex; justify-content:center; align-items:center; opacity:0.8;">
                ` + l + `
            </div>

            <div class="fund-data" style="flex: 1; text-align:right;">
                <div class="fund-change ` + e + "\" style=\"font-size:18px; font-weight:bold;\">" + f + c.toFixed(2) + "%</div>\n                <div class=\"fund-nav\" style=\"font-size:11px; color:#999; margin-top:4px;\">å‡€å€¼ " + a.currentNav.toFixed(4) + `</div>
            </div>
        `;
      b.appendChild(m);
    });
  }
  function Xp(a, b) {
    const c = document.getElementById("fund-my-list");
    c.style.display = "block";
    document.getElementById("fund-market-list").style.display = "none";
    c.innerHTML = "";
    if (b.length === 0) {
      c.innerHTML = "<div style=\"text-align:center; padding:40px; color:#999;\">æš‚æ— æŒä»“</div>";
      return;
    }
    b.forEach(b => {
      const d = a.find(a => a.id === b.fundId);
      if (!d) {
        return;
      }
      const e = b.units * d.currentNav;
      const f = b.units * b.cost;
      const g = e - f;
      const h = g / f * 100;
      const i = g >= 0;
      const j = i ? "fund-up" : "fund-down";
      const k = i ? "+" : "";
      const l = document.createElement("div");
      l.className = "fund-item";
      l.onclick = () => $p("sell", d, b);
      l.innerHTML = `
            <div class="fund-info">
                <h4>` + d.name + "</h4>\n                <div style=\"font-size:12px; color:#666;\">æŒæœ‰ " + b.units.toFixed(2) + ` ä»½</div>
            </div>
            <div class="fund-data">
                <div class="fund-change ` + j + "\">" + k + g.toFixed(2) + "</div>\n                <div class=\"fund-nav\" style=\"font-size:11px;\">" + k + h.toFixed(2) + `%</div>
            </div>
        `;
      c.appendChild(l);
    });
  }
  function Yp(a) {
    Tp = a;
    document.querySelectorAll(".frame-tab").forEach(a => a.classList.remove("active"));
    document.getElementById("tab-fund-" + a).classList.add("active");
    Up();
  }
  let Zp = null;
  async function $p(a, b, c = null) {
    Zp = {
      type: a,
      fund: b,
      holding: c
    };
    const d = document.getElementById("fund-trade-modal");
    const e = await Gb.userWallet.get("main");
    const f = e.balance || 0;
    document.getElementById("fund-trade-name").textContent = b.name;
    document.getElementById("fund-trade-code").textContent = b.code;
    document.getElementById("fund-trade-nav").textContent = b.currentNav.toFixed(4);
    const g = (b.currentNav - b.lastDayNav) / b.lastDayNav * 100;
    const h = document.getElementById("fund-trade-change");
    h.textContent = (g >= 0 ? "+" : "") + g.toFixed(2) + "%";
    h.className = g >= 0 ? "fund-up" : "fund-down";
    const i = document.getElementById("fund-trade-amount");
    i.value = "";
    const j = document.getElementById("fund-confirm-btn");
    const k = document.getElementById("fund-trade-title");
    const l = document.getElementById("fund-trade-label");
    const m = document.getElementById("fund-trade-info");
    if (a === "buy") {
      k.textContent = "ä¹°å…¥åŸºé‡‘";
      l.innerHTML = "ä¹°å…¥é‡‘é¢ (ä½™é¢: Â¥<span id=\"fund-wallet-balance\">" + f.toFixed(2) + "</span>)";
      m.textContent = "è´¹çŽ‡ 0.00%";
      j.textContent = "ç¡®è®¤ä¹°å…¥";
      j.style.backgroundColor = "#1677ff";
      Zp.maxAmount = f;
    } else {
      k.textContent = "å–å‡ºåŸºé‡‘";
      const a = c.units * b.currentNav;
      l.innerHTML = "å–å‡ºé‡‘é¢ (æŒæœ‰: Â¥<span id=\"fund-wallet-balance\">" + a.toFixed(2) + "</span>)";
      m.textContent = "æŒæœ‰ä»½é¢: " + c.units.toFixed(2) + " ä»½";
      j.textContent = "ç¡®è®¤å–å‡º";
      j.style.backgroundColor = "#ff9800";
      Zp.maxAmount = a;
    }
    d.classList.add("visible");
  }
  window.handleFundTradeConfirm = async function () {
    if (!Zp) {
      return;
    }
    const a = parseFloat(document.getElementById("fund-trade-amount").value);
    if (isNaN(a) || a <= 0) {
      document.getElementById("custom-modal-overlay").style.zIndex = 3002;
      await Bb("æç¤º", "è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
      document.getElementById("custom-modal-overlay").style.zIndex = "";
      return;
    }
    if (a > Zp.maxAmount) {
      document.getElementById("custom-modal-overlay").style.zIndex = 3002;
      await Bb("å¤±è´¥", "ä½™é¢æˆ–ä»½é¢ä¸è¶³");
      document.getElementById("custom-modal-overlay").style.zIndex = "";
      return;
    }
    const {
      type: b,
      fund: c
    } = Zp;
    const d = await Gb.userWallet.get("main");
    let e = d.fundHoldings || [];
    if (b === "buy") {
      const b = await Ep(a, "expense", "åŸºé‡‘ä¹°å…¥-" + c.name);
      if (!b) {
        return;
      }
      const d = e.find(a => a.fundId === c.id);
      const f = a / c.currentNav;
      if (d) {
        const b = d.units * d.cost + a;
        d.units += f;
        d.cost = b / d.units;
      } else {
        e.push({
          fundId: c.id,
          units: f,
          cost: c.currentNav
        });
      }
      await Bb("æˆåŠŸ", "ä¹°å…¥æˆåŠŸï¼");
    } else {
      const b = e.findIndex(a => a.fundId === c.id);
      if (b === -1) {
        return;
      }
      const d = a / c.currentNav;
      e[b].units -= d;
      if (e[b].units < 0.01) {
        e.splice(b, 1);
      }
      await Ep(a, "income", "åŸºé‡‘å–å‡º-" + c.name);
      await Bb("æˆåŠŸ", "å–å‡ºæˆåŠŸï¼");
    }
    d.fundHoldings = e;
    await Gb.userWallet.put(d);
    Qp();
    document.getElementById("fund-trade-modal").classList.remove("visible");
    Up();
  };
  window.openFundScreen = Sp;
  window.switchFundTab = Yp;
  window.refreshFundMarket = async () => {
    await Bb("åˆ·æ–°ä¸­", "æ­£åœ¨æ›´æ–°è¡Œæƒ…...");
    await Rp();
    await Up();
  };
  let _p = {
    isActive: false,
    item: null,
    currentPrice: 0,
    timer: 30,
    timerId: null,
    npcIntervalId: null,
    lastBidder: null,
    bidHistory: []
  };
  async function aq() {
    Kb("auction-screen");
    if (!_p.isActive) {
      document.getElementById("auction-item-img").style.display = "none";
      document.getElementById("auction-loading").style.display = "block";
      document.getElementById("auction-item-name").textContent = "æ­£åœ¨æœå¯»é»‘å¸‚...";
      document.getElementById("auction-item-desc").textContent = "";
      bq();
    }
  }
  async function bq() {
    const a = document.querySelector("#auction-screen .action-btn");
    a.style.pointerEvents = "none";
    a.textContent = "è¿›è´§ä¸­...";
    const {
      proxyUrl: b,
      apiKey: c,
      model: d
    } = v.apiConfig;
    if (!b || !c) {
      alert("è¯·å…ˆé…ç½®APIï¼");
      a.style.pointerEvents = "auto";
      a.textContent = "æ–°æ‹å“";
      return;
    }
    let e = "";
    const f = v.worldBooks.find(a => a.name.includes("é»‘å¸‚") || a.name.includes("æ‹å–"));
    if (f) {
      console.log("âœ… æ‰¾åˆ°ä¸“å±žæ‹å–è®¾å®šä¹¦:", f.name);
      const a = f.content.filter(a => a.enabled !== false).map(a => a.content).join("; ");
      e = `
    ã€å½“å‰æ‹å–è¡Œç‰¹æ®Šä¸–ç•Œè§‚ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘: 
    ` + a + `
    
    (è¯·æ ¹æ®ä¸Šè¿°ç‰¹æ®Šä¸–ç•Œè§‚ç”Ÿæˆç¬¦åˆè®¾å®šçš„æ‹å“å’ŒNPCï¼Œå¿½ç•¥çŽ°å®žä¸–ç•Œçš„é™åˆ¶)
    `;
    } else {
      console.log("â„¹ï¸ æœªæ‰¾åˆ°ä¸“å±žè®¾å®šï¼Œä½¿ç”¨é»˜è®¤è±ªå¥¢è®¾å®š");
      e = `
    ã€é»˜è®¤æ‹å“ç±»åˆ«æ¸…å•ã€‘:
    1. é¡¶çº§ç å®ï¼šç¨€æœ‰é’»çŸ³é¡¹é“¾ã€çº¢è“å®çŸ³æˆ’æŒ‡ã€çš‡å† ã€æ‰‹é•¯ï¼ˆé€‚åˆé€ç»™æ‹äººï¼‰ã€‚
    2. ä¼ ä¸–å¤è‘£ï¼šæ˜Žæ¸…ç“·å™¨ã€æ¬§æ´²ä¸­ä¸–çºªå¤ç‰©ã€ç»ç‰ˆåè¡¨ã€çŽ‰çŽºã€‚
    3. è‰ºæœ¯çå“ï¼šä¸–ç•Œåç”»ï¼ˆè™šæž„çš„çœŸè¿¹ï¼‰ã€è‘—åé›•å¡‘ã€‚
    4. å¥¢åŽèµ„äº§ï¼šæµ·å²›å¥‘çº¦ã€ç§äººé£žæœºã€é¡¶çº§è±ªè½¦ã€åº„å›­é’¥åŒ™ã€‚
    5. æ¸¸æˆæŠ½å¡ï¼šçç¨€æ¸¸æˆé“å…·ã€ç»ç‰ˆçš®è‚¤è´¦å·ã€‚
    
    (è¯·ä»…ä»Žä¸Šè¿° 5 ä¸ªç±»åˆ«ä¸­é€‰æ‹©ä¸€ç§ç”Ÿæˆ)
    `;
    }
    const g = Object.values(v.chats).filter(a => !a.isGroup).map(a => {
      return a.name + "(" + a.settings.aiPersona.substring(0, 50) + "...)";
    }).join("\n");
    const h = `
    ä½ æ˜¯ä¸€ä½é¡¶çº§æ‹å–è¡Œçš„é¦–å¸­æ‹å–å®˜ã€‚
    
    # æ ¸å¿ƒä»»åŠ¡
    è¯·æ ¹æ®ä¸‹é¢çš„ã€è®¾å®šæ¥æºã€‘ï¼Œå®Œæˆä¸¤ä¸ªä»»åŠ¡ï¼š
    1. ç”Ÿæˆä¸€ä»¶æžå…·ä»·å€¼çš„æ‹å“ã€‚
    2. ç”Ÿæˆä¸€æ‰¹ç¬¦åˆè¯¥ä¸–ç•Œè§‚èƒŒæ™¯çš„â€œè·¯äººNPCç«žæ‹è€…â€ã€‚
    
    ` + e + `
    
    # ä»»åŠ¡ Bï¼šä¹°å®¶æ„å‘åˆ†æž
    ä¸‹é¢æ˜¯ä»Šå¤©çš„å—é‚€å®¾å®¢åå•ï¼ˆç”¨æˆ·çš„é‡è¦è§’è‰²ï¼‰ï¼š
    ` + g + `
    è¯·åˆ†æžè¿™ä»¶æ‹å“å¯¹å“ªäº›å®¾å®¢æœ‰å¸å¼•åŠ›ï¼Ÿ
    
    # å›žå¤æ ¼å¼é“å¾‹
    å›žå¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼š
    {
        "item": {
            "name": "ç‰©å“åç§° (ä¸­æ–‡ï¼Œåå­—è¦éœ¸æ°”æˆ–ä¼˜é›…)",
            "description": "ä¸€æ®µç²¾å½©çš„æè¿°ï¼Œå¼ºè°ƒå…¶ç¨€æœ‰åº¦ã€åŽ†å²ä»·å€¼æˆ–ç‰¹æ®ŠåŠŸèƒ½ï¼ˆ50å­—ä»¥å†…ï¼Œä¸­æ–‡ï¼‰",
            "basePrice": åˆå§‹ä»·æ ¼(æ•°å­—, å»ºè®® 10000 ä»¥ä¸Š),
            "image_prompt": "ç‰©å“çš„è‹±æ–‡è§†è§‰æè¿°, high quality, cinematic lighting, detailed, clean background"
        },
        "interested_bidders": ["å®¾å®¢Açš„åå­—", "å®¾å®¢Bçš„åå­—"],
        "world_npcs": ["NPCåå­—1", "NPCåå­—2", "NPCåå­—3", "NPCåå­—4", "NPCåå­—5"]
    }
    
    æ³¨æ„ï¼š
    1. image_prompt å¿…é¡»å…¨æ˜¯è‹±æ–‡å•è¯ã€‚
    2. interested_bidders æ•°ç»„é‡Œåªèƒ½å¡«ä¸Šé¢â€œå—é‚€å®¾å®¢åå•â€é‡Œå‡ºçŽ°è¿‡çš„åå­—ã€‚
    3. world_npcs æ˜¯ä½ æ ¹æ®ä¸–ç•Œè§‚ç”Ÿæˆçš„è·¯äººã€‚ä¾‹å¦‚ï¼šå¦‚æžœæ˜¯ä¿®ä»™ä¸–ç•Œï¼Œç”Ÿæˆ"é’äº‘é—¨é•¿è€"ã€"æ•£ä¿®å¤§èƒ½"ï¼›å¦‚æžœæ˜¯èµ›åšä¸–ç•Œï¼Œç”Ÿæˆ"è’å‚å…¬å¸é«˜ç®¡"ã€"å¤œä¹‹åŸŽä¸­é—´äºº"ã€‚å¦‚æžœæ˜¯é»˜è®¤è®¾å®šï¼Œç”Ÿæˆ"çŸ³æ²¹çŽ‹å­"ã€"ç¥žç§˜æ”¶è—å®¶"ç­‰ã€‚
    `;
    try {
      let a = b.includes("generativelanguage");
      let e = p(d, c, h, [{
        role: "user",
        content: "ç”Ÿæˆä¸€ä»¶æ‹å“"
      }]);
      const f = a ? await fetch(e.url, e.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: h
          }, {
            role: "user",
            content: "ç”Ÿæˆä¸€ä»¶æ‹å“"
          }],
          temperature: 1
        })
      });
      if (!f.ok) {
        throw new Error("APIè¯·æ±‚å¤±è´¥");
      }
      const g = await f.json();
      const i = C(g);
      const j = JSON.parse(i.replace(/^```json\s*/, "").replace(/```$/, ""));
      const k = "https://image.pollinations.ai/prompt/" + encodeURIComponent(j.item.image_prompt);
      const l = 1.5 + Math.random() * 2;
      _p.item = j.item;
      _p.basePrice = j.item.basePrice;
      _p.limitPrice = j.item.basePrice * l;
      _p.currentPrice = j.item.basePrice;
      _p.isActive = true;
      _p.timer = 20;
      _p.lastBidder = null;
      _p.bidHistory = [];
      _p.interestedChars = j.interested_bidders || [];
      _p.worldNPCs = j.world_npcs || [];
      console.log("å¯¹æœ¬æ‹å“æ„Ÿå…´è¶£çš„è§’è‰²:", _p.interestedChars);
      console.log("æœ¬åœºè·¯äººNPC:", _p.worldNPCs);
      document.getElementById("auction-item-name").textContent = j.item.name;
      document.getElementById("auction-item-desc").textContent = j.item.description;
      document.getElementById("auction-current-price").textContent = "Â¥ " + j.item.basePrice.toLocaleString();
      const m = document.getElementById("auction-item-img");
      m.src = k;
      m.style.display = "block";
      document.getElementById("auction-loading").style.display = "none";
      document.getElementById("auction-log").innerHTML = "<div style=\"color:#666; padding:5px;\">æ‹å–å¼€å§‹ï¼åº•ä»· Â¥" + j.item.basePrice + "</div>";
      dq();
    } catch (a) {
      console.error(a);
      alert("è¿›è´§å¤±è´¥ï¼Œè¯·é‡è¯•");
    } finally {
      a.style.pointerEvents = "auto";
      a.textContent = "æ–°æ‹å“";
    }
  }
  let cq = 0;
  function dq() {
    if (_p.timerId) {
      clearInterval(_p.timerId);
    }
    if (_p.npcIntervalId) {
      clearInterval(_p.npcIntervalId);
    }
    const a = document.getElementById("auction-timer");
    const b = document.getElementById("auction-log");
    cq = 0;
    _p.timerId = // TOLOOK
    setInterval(() => {
      _p.timer--;
      a.textContent = _p.timer.toFixed(1) + "s";
      if (_p.timer <= 5) {
        a.style.color = "#ff0055";
        a.style.textShadow = "0 0 10px #ff0055";
      } else {
        a.style.color = "#f0ad4e";
        a.style.textShadow = "none";
      }
      if (_p.timer <= 10 && cq === 0) {
        gq("System", "ðŸ”¨ " + _p.currentPrice + " ç¬¬ä¸€æ¬¡ï¼");
        cq = 1;
      }
      if (_p.timer <= 5 && cq === 1) {
        gq("System", "ðŸ”¨ " + _p.currentPrice + " ç¬¬äºŒæ¬¡ï¼è¿˜æœ‰äººåŠ ä»·å—ï¼Ÿ");
        cq = 2;
      }
      if (_p.timer <= 2 && cq === 2) {
        gq("System", "ðŸ”¨ " + _p.currentPrice + " ç¬¬ä¸‰æ¬¡ï¼å³å°†æˆäº¤...");
        cq = 3;
      }
      if (_p.timer <= 0) {
        iq();
      }
    }, 1000);
    _p.npcIntervalId = // TOLOOK
    setInterval(() => {
      if (!_p.isActive) {
        return;
      }
      if (Math.random() < 0.7) {
        eq();
      }
    }, 800);
  }
  function eq() {
    if (_p.currentPrice >= _p.limitPrice) {
      if (Math.random() > 0.1) {
        return;
      }
    }
    const a = _p.currentPrice / _p.basePrice;
    const b = 0.8 / (a * a);
    if (Math.random() > b) {
      return;
    }
    let c = null;
    const d = Object.values(v.chats).filter(a => !a.isGroup);
    const e = d.filter(a => _p.interestedChars && _p.interestedChars.includes(a.name));
    if (e.length > 0 && Math.random() < 0.3) {
      const a = e[Math.floor(Math.random() * e.length)];
      c = {
        name: a.name,
        type: "char",
        id: a.id
      };
    } else {
      let a = "ç¥žç§˜ä¹°å®¶";
      if (_p.worldNPCs && _p.worldNPCs.length > 0) {
        const b = _p.worldNPCs.filter(a => !_p.lastBidder || a !== _p.lastBidder.name);
        if (b.length > 0) {
          a = b[Math.floor(Math.random() * b.length)];
        } else {
          a = _p.worldNPCs[0];
        }
      } else {
        const b = ["ç¥žç§˜ä¹°å®¶", "è‹å¯Œæ¯”VIP", "è¿ªæ‹œçŽ‹å®¤æˆå‘˜", "åŽå°”è¡—æŠ•èµ„äºº", "åœ°äº§å¤§äº¨", "ä½Žè°ƒçš„æ”¶è—å®¶", "æŸä¸Šå¸‚å…¬å¸CEO", "æ¸¯å²›ååª›", "çŸ³æ²¹çŽ‹å­"];
        a = b[Math.floor(Math.random() * b.length)];
      }
      c = {
        name: a,
        type: "npc"
      };
    }
    if (_p.lastBidder && _p.lastBidder.name === c.name) {
      return;
    }
    let f = 0.05;
    if (c.type === "npc" && Math.random() < 0.3) {
      f = 0.15;
    }
    const g = Math.floor(_p.currentPrice * (1 + f));
    hq(g, c);
  }
  async function fq(a) {
    if (!_p.isActive) {
      return;
    }
    let b = 0;
    if (a === "custom") {
      const a = await Db("æ‰‹åŠ¨å‡ºä»·", "è¾“å…¥é‡‘é¢ (ä¸èƒ½ä½ŽäºŽå½“å‰ä»·)", _p.currentPrice + 100, "number");
      if (!a) {
        return;
      }
      b = parseFloat(a);
    } else {
      b = Math.floor(_p.currentPrice * a);
    }
    if (b <= _p.currentPrice) {
      alert("å‡ºä»·å¿…é¡»é«˜äºŽå½“å‰ä»·æ ¼ï¼");
      return;
    }
    const c = await Gb.userWallet.get("main");
    const d = c.balance + (c.kinshipCards || []).reduce((a, b) => a + (b.limit - (b.spent || 0)), 0);
    if (d < b) {
      if (navigator.vibrate) {
        navigator.vibrate(200);
      }
      Bb("èµ„é‡‘ä¸è¶³", "ä½ çš„èµ„äº§æ€»é¢ä¸è¶³ä»¥æ”¯ä»˜æ­¤ä»·æ ¼ï¼");
      return;
    }
    const e = {
      name: v.qzoneSettings.nickname || "æˆ‘",
      type: "user",
      id: "user"
    };
    hq(b, e);
  }
  function gq(a, b) {
    const c = document.getElementById("auction-log");
    const d = document.createElement("div");
    if (a === "System") {
      d.innerHTML = "<span style=\"color:#00f3ff; font-weight:bold;\">[æ‹å–å®˜]</span> " + b;
    } else {
      d.innerHTML = b;
    }
    if (a === "bid-me") {
      d.className = "bid-me";
    }
    if (a === "bid-friend") {
      d.className = "bid-friend";
    }
    c.appendChild(d);
    c.scrollTop = c.scrollHeight;
  }
  function hq(a, b) {
    _p.currentPrice = a;
    _p.lastBidder = b;
    _p.bidHistory.push(b);
    if (_p.timer < 10) {
      const a = Math.floor(Math.random() * 5) + 10;
      _p.timer = a;
      cq = 0;
      const b = document.getElementById("auction-timer");
      b.style.color = "#00ff00";
      // TOLOOK
      setTimeout(() => b.style.color = "#f0ad4e", 300);
      gq("System", "â±ï¸ æœ‰äººå‡ºä»·ï¼Œæ—¶é—´å»¶é•¿ï¼");
    }
    const c = document.getElementById("auction-current-price");
    c.textContent = "Â¥ " + a.toLocaleString();
    c.classList.remove("shake-animation");
    c.offsetWidth;
    c.classList.add("shake-animation");
    let d = "";
    let e = "bid-npc";
    if (b.type === "user") {
      d = "ðŸš© <b>ä½ </b> å‡ºä»· Â¥" + a.toLocaleString();
      e = "bid-me";
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    } else if (b.type === "char") {
      d = "ðŸ”¥ <b>" + b.name + "</b> ä¸¾ç‰Œ Â¥" + a.toLocaleString() + "!";
      e = "bid-friend";
    } else {
      d = b.name + " å‡ºä»· Â¥" + a.toLocaleString();
    }
    const f = document.getElementById("auction-log");
    const g = document.createElement("div");
    g.innerHTML = d;
    g.className = e;
    f.appendChild(g);
    f.scrollTop = f.scrollHeight;
  }
  async function iq() {
    clearInterval(_p.timerId);
    clearInterval(_p.npcIntervalId);
    _p.isActive = false;
    const a = _p.lastBidder;
    const b = _p.currentPrice;
    const c = _p.item;
    document.getElementById("auction-timer").textContent = "ç»“æŸ";
    document.getElementById("auction-item-image-container").classList.remove("auction-win-anim");
    if (!a) {
      await Bb("æ‹å–ç»“æŸ", "æ— äººå‡ºä»·ï¼Œè¯¥æ‹å“å·²æµæ‹ã€‚");
      return;
    }
    if (a.type === "user") {
      document.getElementById("auction-item-image-container").classList.add("auction-win-anim");
      const a = await Gb.userWallet.get("main");
      const d = a.balance || 0;
      const e = a.kinshipCards || [];
      const f = [];
      if (d >= b) {
        f.push({
          text: "<span style=\"color:#1677ff;font-weight:bold;\">ä½™é¢æ”¯ä»˜</span> (å‰©ä½™ Â¥" + d.toFixed(2) + ")",
          value: "balance"
        });
      }
      e.forEach(a => {
        const c = a.limit - (a.spent || 0);
        if (c >= b) {
          const b = v.chats[a.chatId];
          f.push({
            text: "<span style=\"color:#ff5252;font-weight:bold;\">äº²å±žå¡ - " + b.name + "</span> (å‰©ä½™ Â¥" + c.toFixed(2) + ")",
            value: "kinship_" + a.chatId
          });
        }
      });
      if (f.length === 0) {
        await Bb("ç«žæ‹æˆåŠŸä½†æ”¯ä»˜å¤±è´¥", "ä½ èµ¢äº†ç«žæ‹ï¼Œä½†èµ„é‡‘ä¸è¶³ä»¥æ”¯ä»˜ï¼");
        return;
      }
      document.getElementById("custom-modal-overlay").style.zIndex = 3002;
      const g = await Eb("ç«žæ‹æˆåŠŸï¼æ”¯ä»˜ Â¥" + b, f);
      document.getElementById("custom-modal-overlay").style.zIndex = "";
      if (!g) {
        await Bb("äº¤æ˜“å–æ¶ˆ", "ä½ æ”¾å¼ƒäº†æ”¯ä»˜ã€‚");
        return;
      }
      let h = null;
      if (g === "balance") {
        await Ep(b, "expense", "é»‘å¸‚è´­ä¹°-" + c.name);
      } else {
        const d = g.replace("kinship_", "");
        h = d;
        const e = a.kinshipCards.findIndex(a => a.chatId === d);
        if (e > -1) {
          a.kinshipCards[e].spent = (a.kinshipCards[e].spent || 0) + b;
          await Gb.userWallet.put(a);
          await Gb.userTransactions.add({
            timestamp: Date.now(),
            type: "expense",
            amount: b,
            description: "äº²å±žå¡é»‘å¸‚-" + c.name
          });
          console.log("[é»‘å¸‚] äº²å±žå¡æ‰£æ¬¾æˆåŠŸ: -" + b);
        } else {
          console.error("[é»‘å¸‚] æ‰£æ¬¾å¤±è´¥ï¼šæ‰¾ä¸åˆ°IDä¸º " + d + " çš„äº²å±žå¡");
          alert("æ”¯ä»˜å¼‚å¸¸ï¼šæœªæ‰¾åˆ°å¯¹åº”çš„äº²å±žå¡è®°å½•ã€‚");
          return;
        }
      }
      await Gb.inventory.add({
        name: c.name,
        type: "treasure",
        description: c.description,
        image: c.image_prompt,
        acquiredPrice: b,
        acquiredTime: Date.now()
      });
      const i = await wb("ç«žæ‹æˆåŠŸï¼", "ä½ å·²æˆåŠŸæ‹ä¸‹ã€" + c.name + `ã€‘ï¼

è¦çŽ°åœ¨å°±æŠŠå®ƒä½œä¸ºç¤¼ç‰©ï¼Œé€ç»™æŸä½è§’è‰²å—ï¼Ÿ`, {
        confirmText: "ðŸŽ ç«‹å³èµ é€",
        cancelText: "æ”¾å…¥ä»“åº“"
      });
      if (i) {
        await jq(c, b);
      } else {
        await Bb("å·²å…¥åº“", "ç‰©å“å·²å®‰å…¨å­˜å…¥ä½ çš„åº“å­˜ã€‚");
      }
      if (h) {
        const a = v.chats[h];
        if (a) {
          const d = {
            role: "system",
            content: "[æ¶ˆè´¹é€šçŸ¥ï¼šç”¨æˆ·ä½¿ç”¨ä½ çš„äº²å±žå¡åœ¨é»‘å¸‚æ‹å–è¡Œæ¶ˆè´¹äº† Â¥" + b + "ï¼Œè´­ä¹°äº†â€œ" + c.name + "â€ã€‚]",
            timestamp: Date.now(),
            isHidden: true
          };
          a.history.push(d);
          await Gb.chats.put(a);
        }
      }
      const j = [...new Set(_p.bidHistory.filter(a => a.type === "char").map(a => a.id))];
      for (const a of j) {
        if (a === h) {
          continue;
        }
        const d = v.chats[a];
        if (d) {
          const a = {
            role: "system",
            content: "[ç³»ç»Ÿæç¤ºï¼šåœ¨åˆšæ‰çš„é»‘å¸‚æ‹å–ä¸­ï¼Œç”¨æˆ·ä»¥ Â¥" + b + " çš„ä»·æ ¼å‡»è´¥äº†åœ¨åœºçš„ç«žæ‹è€…ï¼ˆåŒ…æ‹¬ä½ ï¼‰ï¼Œèµ¢å¾—äº†â€œ" + c.name + "â€ã€‚]",
            timestamp: Date.now(),
            isHidden: true
          };
          d.history.push(a);
          await Gb.chats.put(d);
        }
      }
    } else if (a.type === "char") {
      const d = v.chats[a.id];
      if (d) {
        await Bb("ç«žæ‹ç»“æŸ", "æ­å–œï¼æ‚¨çš„å¥½å‹ã€" + a.name + "ã€‘ä»¥ Â¥" + b.toLocaleString() + " æˆåŠŸæ‹å¾—å®ç‰©ï¼");
        const e = "\n                [ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšåœ¨æ‹å–ä¼šä¸Šæ–¥èµ„ Â¥" + b.toLocaleString() + " æ‹ä¸‹äº†â€œ" + c.name + "â€(" + c.description + `)ã€‚
                è¯·æ ¹æ®ä½ çš„äººè®¾å’Œä¸Žç”¨æˆ·çš„å…³ç³»ï¼Œå†³å®šæ€Žä¹ˆå¤„ç†è¿™ä¸ªç‰©å“ã€‚
                ä½ å¯ä»¥ï¼š
                1. é€ç»™ç”¨æˆ·ä½œä¸ºæƒŠå–œ (ä½¿ç”¨ 'gift' æŒ‡ä»¤)ã€‚
                2. è‡ªå·±æ”¶è—ï¼Œå¹¶å‘ç”¨æˆ·ç‚«è€€ (ä½¿ç”¨ 'text' æˆ– 'ai_image' æŒ‡ä»¤)ã€‚
                3. æŠ±æ€¨å¤ªè´µäº† (ä½¿ç”¨ 'text' æŒ‡ä»¤)ã€‚
                è¯·å¼€å§‹ä½ çš„è¡¨æ¼”ã€‚]
                `;
        d.history.push({
          role: "system",
          content: e,
          timestamp: Date.now(),
          isHidden: true
        });
        await Gb.chats.put(d);
        const f = await wb("åŽ»çœ‹çœ‹ï¼Ÿ", a.name + " ä¼¼ä¹Žæœ‰è¯å¯¹ä½ è¯´ã€‚", {
          confirmText: "å‰å¾€èŠå¤©"
        });
        if (f) {
          Qd(a.id);
          Td();
        } else {}
      }
    } else {
      await Bb("æ‹å–ç»“æŸ", "å¾ˆé—æ†¾ï¼Œè¢«ã€" + a.name + "ã€‘ä»¥ Â¥" + b.toLocaleString() + " æ‹èµ°äº†ã€‚");
    }
  }
  async function jq(a, b) {
    const c = Object.values(v.chats).filter(a => !a.isGroup);
    if (c.length === 0) {
      return alert("æ²¡æœ‰å¯èµ é€çš„è§’è‰²");
    }
    const d = document.getElementById("custom-modal-overlay");
    const e = document.getElementById("custom-modal-title");
    const f = document.getElementById("custom-modal-body");
    const g = document.querySelector("#custom-modal .custom-modal-footer");
    e.textContent = "å°†â€œ" + a.name + "â€é€ç»™...";
    g.innerHTML = "";
    g.style.flexDirection = "row";
    g.style.justifyContent = "center";
    g.style.maxHeight = "";
    g.style.overflowY = "";
    const h = document.createElement("button");
    h.textContent = "å–æ¶ˆ";
    h.style.color = "#666";
    h.onclick = () => d.classList.remove("visible");
    g.appendChild(h);
    f.innerHTML = "";
    const i = document.createElement("div");
    i.style.cssText = `
        max-height: 60vh; 
        overflow-y: auto; 
        display: flex; 
        flex-direction: column; 
        text-align: left;
        margin: 0 -16px; /* æŠµæ¶ˆ modal-body çš„å†…è¾¹è·ï¼Œè®©åˆ—è¡¨è´´è¾¹ */
        border-top: 1px solid #eee;
    `;
    c.sort((a, b) => a.name.localeCompare(b.name, "zh-CN"));
    c.forEach(c => {
      const e = document.createElement("div");
      e.style.cssText = `
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s;
        `;
      const f = c.settings.aiAvatar || Na;
      e.innerHTML = "\n            <img src=\"" + f + `" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 1px solid #eee;">
            <div style="flex-grow: 1;">
                <div style="font-weight: 500; font-size: 16px; color: var(--text-primary);">` + c.name + `</div>
            </div>
            <div style="color: #ccc;">â€º</div>
        `;
      e.onclick = async () => {
        e.style.backgroundColor = "#f0f0f0";
        // TOLOOK
        setTimeout(async () => {
          d.classList.remove("visible");
          await kq(c.id, a, b);
        }, 100);
      };
      i.appendChild(e);
    });
    f.appendChild(i);
    d.classList.add("visible");
  }
  async function kq(a, b, c) {
    const d = v.chats[a];
    if (!d) {
      return;
    }
    let e = "https://i.postimg.cc/Hs7BLh76/alipay.png";
    if (b.image_prompt) {
      e = "https://image.pollinations.ai/prompt/" + encodeURIComponent(b.image_prompt);
    }
    const f = {
      role: "user",
      type: "gift",
      timestamp: Date.now(),
      items: [{
        name: "[ç¨€ä¸–çå®] " + b.name,
        price: c,
        imageUrl: e,
        quantity: 1
      }],
      total: c,
      recipients: null
    };
    d.history.push(f);
    const g = {
      role: "system",
      content: "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšåœ¨é»‘å¸‚æ‹å–ä¼šä¸Šï¼Œæ–¥å·¨èµ„ï¼ˆÂ¥" + c.toLocaleString() + "ï¼‰æ‹ä¸‹äº†ç¨€ä¸–çå®â€œ" + b.name + "â€å¹¶ç›´æŽ¥é€ç»™äº†ä½ ã€‚ç‰©å“æè¿°ï¼š" + b.description + "ã€‚è¿™æ˜¯æžå…¶è´µé‡çš„ç¤¼ç‰©ï¼Œè¯·æ ¹æ®ä½ çš„äººè®¾åšå‡ºå¼ºçƒˆçš„ååº”ï¼ˆæƒŠè®¶ã€æ„ŸåŠ¨ã€æˆ–æ˜¯è´£æ€ªä¹±èŠ±é’±ï¼‰ã€‚]",
      timestamp: Date.now() + 1,
      isHidden: true
    };
    d.history.push(g);
    await Gb.chats.put(d);
    await Bb("èµ é€æˆåŠŸ", "ç¤¼ç‰©å·²é€è¾¾ç»™ " + d.name + "ï¼æ­£åœ¨å‰å¾€èŠå¤©ç•Œé¢...");
    Kb("chat-list-screen");
    // TOLOOK
    setTimeout(() => {
      Qd(a);
      Td();
    }, 300);
  }
  const lq = hq;
  hq = function (a, b) {
    _p.bidHistory.push(b);
    lq(a, b);
  };
  window.openAuctionScreen = aq;
  window.generateNewAuctionItem = bq;
  window.placeBid = fq;
  async function mq() {
    const a = document.getElementById("inventory-modal");
    const b = document.getElementById("inventory-list");
    a.classList.add("visible");
    b.innerHTML = "<div class=\"spinner\"></div>";
    try {
      const a = await Gb.inventory.orderBy("acquiredTime").reverse().toArray();
      b.innerHTML = "";
      if (a.length === 0) {
        b.innerHTML = "<div style=\"text-align:center; color:#666; margin-top:50px;\">ä»“åº“ç©ºç©ºå¦‚ä¹Ÿ<br>å¿«åŽ»ç«žæ‹ç‚¹å¥½ä¸œè¥¿å§</div>";
        return;
      }
      a.forEach(a => {
        const c = document.createElement("div");
        c.className = "inventory-item";
        let d = "https://i.postimg.cc/Hs7BLh76/alipay.png";
        if (a.image) {
          if (a.image.startsWith("http") || a.image.startsWith("data:")) {
            d = a.image;
          } else {
            d = "https://image.pollinations.ai/prompt/" + encodeURIComponent(a.image);
          }
        }
        c.innerHTML = "\n                <img src=\"" + d + `" class="inventory-img" loading="lazy">
                <div class="inventory-info">
                    <div class="inventory-name">` + a.name + "</div>\n                    <div class=\"inventory-desc\">" + (a.description || "ç¨€ä¸–çå®") + "</div>\n                    <div class=\"inventory-price\">å…¥æ‰‹ä»·: Â¥" + (a.acquiredPrice || 0).toLocaleString() + `</div>
                </div>
                <button class="inventory-use-btn">èµ é€</button>
            `;
        const e = c.querySelector(".inventory-use-btn");
        e.onclick = () => oq(a);
        b.appendChild(c);
      });
    } catch (a) {
      console.error(a);
      b.innerHTML = "<div style=\"text-align:center; color:#ff3b30;\">åŠ è½½å¤±è´¥</div>";
    }
  }
  function nq() {
    document.getElementById("inventory-modal").classList.remove("visible");
  }
  async function oq(a) {
    nq();
    const b = {
      name: a.name,
      description: a.description,
      image_prompt: a.image
    };
    await jq(b, a.acquiredPrice || 9999);
  }
  window.openInventoryModal = mq;
  window.closeInventoryModal = nq;
  let pq = null;
  async function qq(a, b, c = "piano") {
    let d = [];
    try {
      const a = typeof b === "string" ? JSON.parse(b) : b;
      d = a.map(a => {
        if (typeof a === "string") {
          return {
            n: a,
            d: "8n"
          };
        }
        return {
          n: a.n,
          d: a.d || "4n"
        };
      });
    } catch (a) {
      console.error("ä¹è°±è§£æžå¤±è´¥", a);
      return;
    }
    if (!d || d.length === 0) {
      return;
    }
    await Tone.start();
    if (!pq) {
      pq = new Tone.PolySynth(Tone.Synth).toDestination();
    }
    pq.volume.value = -8;
    switch (c) {
      case "chiptune":
        pq.set({
          oscillator: {
            type: "square"
          },
          envelope: {
            attack: 0.01,
            decay: 0.1,
            sustain: 0.1,
            release: 0.1
          }
        });
        break;
      case "synth":
        pq.set({
          oscillator: {
            type: "sawtooth"
          },
          envelope: {
            attack: 0.05,
            decay: 0.2,
            sustain: 0.4,
            release: 2
          }
        });
        break;
      case "guitar":
        pq.set({
          oscillator: {
            type: "triangle"
          },
          envelope: {
            attack: 0.01,
            decay: 0.3,
            sustain: 0.1,
            release: 1
          }
        });
        pq.volume.value = -5;
        break;
      case "violin":
        pq.set({
          oscillator: {
            type: "sawtooth"
          },
          envelope: {
            attack: 0.2,
            decay: 0.1,
            sustain: 0.8,
            release: 1.5
          }
        });
        pq.volume.value = -10;
        break;
      case "flute":
        pq.set({
          oscillator: {
            type: "sine"
          },
          envelope: {
            attack: 0.1,
            decay: 0.1,
            sustain: 0.9,
            release: 0.5
          }
        });
        break;
      case "guzheng":
        pq.set({
          oscillator: {
            type: "triangle"
          },
          envelope: {
            attack: 0.005,
            decay: 0.4,
            sustain: 0,
            release: 1.5
          }
        });
        pq.volume.value = -5;
        break;
      case "kalimba":
        pq.set({
          oscillator: {
            type: "sine"
          },
          envelope: {
            attack: 0.001,
            decay: 0.1,
            sustain: 0,
            release: 1.2
          }
        });
        break;
      case "piano":
      default:
        pq.set({
          oscillator: {
            type: "triangle"
          },
          envelope: {
            attack: 0.02,
            decay: 0.1,
            sustain: 0.3,
            release: 1
          }
        });
        break;
    }
    a.textContent = "âšâš";
    a.classList.add("playing");
    a.disabled = true;
    const e = Tone.now();
    let f = 0;
    d.forEach(a => {
      if (a.n && /^[A-G][#b]?[0-9]$/.test(a.n)) {
        const b = Tone.Time(a.d).toSeconds();
        pq.triggerAttackRelease(a.n, a.d, e + f);
        f += b;
      }
    });
    // TOLOOK
    setTimeout(() => {
      a.textContent = "â–¶";
      a.classList.remove("playing");
      a.disabled = false;
    }, f * 1000 + 500);
  }
  window.playSynthScore = qq;
  function rq(a) {
    return a.getFullYear() + "-" + String(a.getMonth() + 1).padStart(2, "0") + "-" + String(a.getDate()).padStart(2, "0");
  }
  async function sq() {
    if (!v.activeChatId) {
      return;
    }
    La = new Date();
    tq();
    await vq();
    Kb("todo-list-screen");
  }
  function tq() {
    const a = document.getElementById("todo-current-date-display");
    const b = new Date();
    const c = rq(La);
    const d = rq(b);
    if (c === d) {
      a.textContent = "ä»Šå¤©";
    } else {
      a.textContent = c;
    }
  }
  function uq(a) {
    La.setDate(La.getDate() + a);
    tq();
    vq();
  }
  async function vq() {
    const a = document.getElementById("todo-list-container");
    a.innerHTML = "";
    const b = v.chats[v.activeChatId];
    if (!b) {
      return;
    }
    const c = rq(La);
    const d = b.todoList || [];
    const e = d.filter(a => a.date === c);
    e.sort((a, b) => {
      if (a.status === b.status) {
        return (a.time || "00:00").localeCompare(b.time || "00:00");
      }
      if (a.status === "completed") {
        return 1;
      } else {
        return -1;
      }
    });
    if (e.length === 0) {
      a.innerHTML = "<div class=\"todo-empty-state\">ðŸ“… " + c + "<br>æš‚æ— å¾…åŠžäº‹é¡¹</div>";
      return;
    }
    F = e;
    G = 0;
    wq();
  }
  function wq() {
    if (H) {
      return;
    }
    const a = document.getElementById("todo-list-container");
    if (!a) {
      return;
    }
    if (G >= F.length) {
      return;
    }
    H = true;
    const c = 30;
    const d = G + c;
    const e = F.slice(G, d);
    const f = document.createDocumentFragment();
    e.forEach(a => {
      const c = document.createElement("div");
      const d = a.creator === "user" || !a.creator;
      const e = d ? "is-user" : "is-char";
      c.className = "todo-item " + a.status + " " + e;
      c.dataset.id = a.id;
      const g = {
        æ—¥å¸¸: "#8e8e93",
        å·¥ä½œ: "#007aff",
        é‡è¦: "#ff3b30",
        ç”Ÿæ´»: "#34c759",
        çº¦ä¼š: "#af52de",
        å­¦ä¹ : "#ff9500",
        è®°è´¦: "#ffc107"
      };
      const h = g[a.type] || "#8e8e93";
      c.innerHTML = `
            <div class="todo-checkbox"></div>
            <div class="todo-info">
                <div class="todo-content">` + b(a.content) + `</div>
                <div class="todo-meta">
                    <span class="todo-tag" style="--tag-color: ` + h + ";\">" + (a.type || "æ—¥å¸¸") + "</span>\n                    " + (a.time ? "<span class=\"todo-time\">â° " + a.time + "</span>" : "") + `
                </div>
            </div>
            <button class="todo-delete-btn">Ã—</button>
        `;
      c.querySelector(".todo-checkbox").addEventListener("click", b => {
        b.stopPropagation();
        xq(a.id);
      });
      c.querySelector(".todo-delete-btn").addEventListener("click", b => {
        b.stopPropagation();
        yq(a.id);
      });
      c.addEventListener("click", () => zq(a));
      f.appendChild(c);
    });
    a.appendChild(f);
    G += e.length;
    H = false;
  }
  async function xq(a) {
    const b = v.chats[v.activeChatId];
    const c = b.todoList.find(b => b.id === a);
    if (c) {
      const a = c.status !== "completed";
      c.status = a ? "completed" : "pending";
      if (a) {
        const a = b.settings.myNickname || "æˆ‘";
        const d = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·(" + a + ") åˆšåˆšåœ¨å¾…åŠžæ¸…å•ä¸­å‹¾é€‰å®Œæˆäº†ï¼šâ€œ" + c.content + "â€ã€‚]";
        const e = {
          role: "system",
          content: d,
          timestamp: Date.now(),
          isHidden: true
        };
        b.history.push(e);
      }
      await Gb.chats.put(b);
      vq();
    }
  }
  async function yq(a) {
    const b = await wb("åˆ é™¤äº‹é¡¹", "ç¡®å®šè¦åˆ é™¤è¿™æ¡å¾…åŠžäº‹é¡¹å—ï¼Ÿ");
    if (b) {
      const b = v.chats[v.activeChatId];
      b.todoList = b.todoList.filter(b => b.id !== a);
      await Gb.chats.put(b);
      vq();
    }
  }
  function zq(a = null) {
    const b = document.getElementById("todo-editor-modal");
    const c = document.getElementById("todo-editor-title");
    Ma = a ? a.id : null;
    c.textContent = a ? "ç¼–è¾‘äº‹é¡¹" : "æ·»åŠ äº‹é¡¹";
    document.getElementById("todo-content-input").value = a ? a.content : "";
    document.getElementById("todo-date-input").value = a ? a.date : rq(La);
    document.getElementById("todo-time-input").value = a ? a.time : "";
    const d = document.querySelectorAll(".todo-type-option");
    d.forEach(a => a.classList.remove("active"));
    const e = a ? a.type : "æ—¥å¸¸";
    const f = Array.from(d).find(a => a.dataset.value === e);
    if (f) {
      f.classList.add("active");
    }
    b.classList.add("visible");
  }
  async function Aq() {
    const a = document.getElementById("todo-content-input").value.trim();
    const b = document.getElementById("todo-date-input").value;
    const c = document.getElementById("todo-time-input").value;
    const d = document.querySelector(".todo-type-option.active");
    const e = d ? d.dataset.value : "æ—¥å¸¸";
    if (!a || !b) {
      alert("å†…å®¹å’Œæ—¥æœŸä¸èƒ½ä¸ºç©ºï¼");
      return;
    }
    const f = v.chats[v.activeChatId];
    if (!f.todoList) {
      f.todoList = [];
    }
    if (Ma) {
      const d = f.todoList.find(a => a.id === Ma);
      if (d) {
        d.content = a;
        d.date = b;
        d.time = c;
        d.type = e;
      }
    } else {
      f.todoList.push({
        id: Date.now(),
        content: a,
        date: b,
        time: c,
        type: e,
        status: "pending",
        creator: "user",
        timestamp: Date.now()
      });
    }
    await Gb.chats.put(f);
    const g = new Date(b);
    if (!isNaN(g.getTime())) {
      La = g;
      tq();
    }
    document.getElementById("todo-editor-modal").classList.remove("visible");
    vq();
  }
  let Bq = {
    activeStoryId: null,
    isGenerating: false
  };
  const Cq = [{
    name: "ç»†è…»æƒ…æ„Ÿ",
    style: "ä¾§é‡å¿ƒç†æå†™ï¼Œæ–‡ç¬”ç»†è…»ï¼Œæ“…é•¿æ•æ‰äººç‰©é—´å¾®å¦™çš„æƒ…æ„ŸæµåŠ¨ï¼Œæ°›å›´æ„Ÿå¼ºã€‚",
    maxOutput: 600
  }, {
    name: "æ­£å‰§å‰§æƒ…",
    style: "æ³¨é‡å‰§æƒ…é€»è¾‘ï¼ŒèŠ‚å¥ç´§å‡‘ï¼Œå¯¹ç™½å¹²ç»ƒï¼Œæ“…é•¿æŽ¨åŠ¨æ•…äº‹æƒ…èŠ‚å‘å±•ã€‚",
    maxOutput: 800
  }, {
    name: "è½»æ¾æ—¥å¸¸",
    style: "å¹½é»˜é£Žè¶£ï¼Œè½»æ¾æ„‰å¿«ï¼Œå¤šç”¨ç”ŸåŠ¨çš„å¯¹è¯å’Œæœ‰è¶£çš„ç»†èŠ‚æå†™ï¼Œæ²»æ„ˆç³»ã€‚",
    maxOutput: 500
  }, {
    name: "æ„è¯†æµ",
    style: "å¤§é‡ä½¿ç”¨éšå–»å’Œè±¡å¾ï¼Œå¥å¼ä¼˜ç¾Žå¤æ‚ï¼Œç€é‡äºŽæ„è±¡å’Œå“²å­¦æ€è€ƒï¼Œå¼±åŒ–å…·ä½“æƒ…èŠ‚ã€‚",
    maxOutput: 400
  }];
  async function Dq() {
    const a = await Gb.grAuthors.count();
    if (a === 0) {
      await Gb.grAuthors.bulkAdd(Cq);
    }
  }
  async function Eq() {
    await Dq();
    Kb("green-river-screen");
    Fq();
  }
  async function Fq() {
    const a = document.getElementById("gr-book-list");
    a.innerHTML = "";
    const b = await Gb.grStories.orderBy("lastUpdated").reverse().toArray();
    const c = await Gb.grAuthors.toArray();
    const d = new Map(c.map(a => [a.id, a.name]));
    const e = await Gb.readingLibrary.toArray();
    const f = new Set(e.map(a => a.linkedStoryId).filter(a => a));
    if (b.length === 0) {
      a.innerHTML = "<p style=\"grid-column:1/-1; text-align:center; color:var(--gr-text-sub); margin-top:50px;\">ä¹¦æž¶æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’æ–°å»ºä¸€éƒ¨ä½œå“å§ã€‚</p>";
      return;
    }
    b.forEach(b => {
      const c = d.get(b.authorId) || "æœªçŸ¥ä½œè€…";
      const e = document.createElement("div");
      e.className = "gr-book-card";
      const g = b.chapters.reduce((a, b) => a + b.content.length, 0);
      const h = f.has(b.id);
      const i = h ? "å·²åœ¨ä¹¦æž¶" : "åŠ å…¥å…±è¯»";
      const j = h ? "gr-add-shelf-btn added" : "gr-add-shelf-btn";
      const k = h ? "removeGreenRiverFromShelf" : "addGreenRiverToShelf";
      e.innerHTML = `
            <div>
                <div class="gr-book-title">` + b.title + `</div>
                <div class="gr-book-meta">
                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    ` + c + `
                </div>
            </div>
            <div class="gr-book-meta" style="justify-content: space-between; margin-top:15px; align-items: flex-end;">
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <span>` + b.chapters.length + " ç« </span>\n                    <span>" + (g / 1000).toFixed(1) + `k å­—</span>
                </div>
                <button class="` + j + "\" onclick=\"event.stopPropagation(); " + k + "(" + b.id + ", this);\">\n                    " + (h ? "âœ“ " : "+ ") + i + `
                </button>
            </div>
        `;
      e.onclick = a => {
        if (a.target.tagName !== "BUTTON") {
          Rq(b.id);
        }
      };
      _d(e, async () => {
        if (confirm("ç¡®å®šè¦åˆ é™¤ä½œå“ã€Š" + b.title + "ã€‹å—ï¼Ÿ")) {
          await Gb.grStories.delete(b.id);
          Fq();
        }
      });
      a.appendChild(e);
    });
  }
  let Gq = null;
  async function Hq() {
    Kb("gr-author-screen");
    const a = document.getElementById("gr-author-list");
    a.innerHTML = "";
    const b = await Gb.grAuthors.toArray();
    if (b.length === 0) {
      a.innerHTML = "<p style=\"text-align:center; color:#999; margin-top:50px;\">è¿˜æ²¡æœ‰è®¾å®šä½œè€…ï¼Œç‚¹å‡»å³ä¸Šè§’â€œ+â€æ·»åŠ ã€‚</p>";
      return;
    }
    b.forEach(b => {
      const c = document.createElement("div");
      c.className = "gr-author-item";
      c.innerHTML = `
            <div class="gr-author-info" style="flex-grow: 1; padding-right: 10px; min-width: 0;">
                <h3 style="margin: 0 0 5px 0; font-size: 16px; font-weight: 600; color: #1C1C1E;">` + b.name + "</h3>\n                <p style=\"margin: 0; font-size: 13px; color: #8E8E93; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5;\">" + b.style + `</p>
            </div>
            <div class="gr-author-actions">
                <button class="gr-icon-btn" onclick="openAuthorEditor(` + b.id + `)" title="ç¼–è¾‘">
                   <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button class="gr-icon-btn" style="color:#ff3b30;" onclick="deleteAuthor(` + b.id + `)" title="åˆ é™¤">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        `;
      a.appendChild(c);
    });
  }
  async function Iq(a = null) {
    Gq = a;
    const b = document.getElementById("gr-author-editor-modal");
    const c = document.getElementById("gr-author-editor-title");
    const d = document.getElementById("gr-author-name-input");
    const e = document.getElementById("gr-author-style-input");
    if (a) {
      const b = await Gb.grAuthors.get(a);
      if (b) {
        c.textContent = "ç¼–è¾‘ä½œè€…";
        d.value = b.name;
        e.value = b.style;
      }
    } else {
      c.textContent = "æ·»åŠ ä½œè€…";
      d.value = "";
      e.value = "";
    }
    b.classList.add("visible");
  }
  async function Jq() {
    const a = document.getElementById("gr-author-name-input").value.trim();
    const b = document.getElementById("gr-author-style-input").value.trim();
    if (!a || !b) {
      alert("åç§°å’Œé£Žæ ¼æè¿°éƒ½ä¸èƒ½ä¸ºç©ºï¼");
      return;
    }
    if (Gq) {
      await Gb.grAuthors.update(Gq, {
        name: a,
        style: b
      });
    } else {
      await Gb.grAuthors.add({
        name: a,
        style: b,
        maxOutput: 600
      });
    }
    document.getElementById("gr-author-editor-modal").classList.remove("visible");
    Hq();
  }
  async function Kq(a) {
    const b = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šåˆ é™¤è¿™ä½ä½œè€…è®¾å®šå—ï¼Ÿ\n(è¿™ä¸ä¼šå½±å“å·²ç”Ÿæˆçš„ç« èŠ‚å†…å®¹)", {
      confirmButtonClass: "btn-danger"
    });
    if (b) {
      await Gb.grAuthors.delete(a);
      Hq();
    }
  }
  function Lq() {
    Iq(null);
  }
  const Mq = document.getElementById("gr-save-author-btn");
  if (Mq) {
    const a = Mq.cloneNode(true);
    Mq.parentNode.replaceChild(a, Mq);
    a.onclick = Jq;
  }
  window.openAuthorManager = Hq;
  window.openAuthorEditor = Iq;
  window.addAuthor = Lq;
  window.deleteAuthor = Kq;
  async function Nq() {
    Bq.activeStoryId = null;
    document.getElementById("gr-story-title").value = "";
    await Pq();
    document.getElementById("gr-settings-modal").classList.add("visible");
  }
  async function Oq() {
    if (!Bq.activeStoryId) {
      return;
    }
    const a = await Gb.grStories.get(Bq.activeStoryId);
    if (!a) {
      return;
    }
    document.getElementById("gr-story-title").value = a.title;
    await Pq(a.settings, a.authorId);
    document.getElementById("gr-settings-modal").classList.add("visible");
  }
  async function Pq(a = {}, b = null) {
    const c = document.getElementById("gr-author-select");
    c.innerHTML = "";
    const d = await Gb.grAuthors.toArray();
    d.forEach(a => {
      const d = document.createElement("option");
      d.value = a.id;
      d.textContent = a.name;
      if (b === a.id) {
        d.selected = true;
      }
      c.appendChild(d);
    });
    const e = document.getElementById("gr-char-list");
    e.innerHTML = "";
    const f = Object.values(v.chats);
    const g = await Gb.npcs.toArray();
    const h = [...f.map(a => ({
      id: a.id,
      name: a.name,
      type: a.isGroup ? "ç¾¤èŠ" : "è§’è‰²"
    })), ...g.map(a => ({
      id: "npc_" + a.id,
      name: a.name,
      type: "NPC"
    }))];
    h.forEach(b => {
      const c = document.createElement("div");
      c.className = "gr-checkbox-item";
      const d = a.charIds && a.charIds.includes(b.id);
      c.innerHTML = "<input type=\"checkbox\" value=\"" + b.id + "\" " + (d ? "checked" : "") + "> <span>" + b.name + " <small style=\"color:#999\">(" + b.type + ")</small></span>";
      c.onclick = a => {
        if (a.target.tagName !== "INPUT") {
          c.querySelector("input").click();
        }
      };
      e.appendChild(c);
    });
    const i = document.getElementById("gr-worldbook-list");
    i.innerHTML = "";
    const j = await Gb.worldBooks.toArray();
    j.forEach(b => {
      const c = document.createElement("div");
      c.className = "gr-checkbox-item";
      const d = a.bookIds && a.bookIds.includes(b.id);
      c.innerHTML = "<input type=\"checkbox\" value=\"" + b.id + "\" " + (d ? "checked" : "") + "> <span>" + b.name + "</span>";
      c.onclick = a => {
        if (a.target.tagName !== "INPUT") {
          c.querySelector("input").click();
        }
      };
      i.appendChild(c);
    });
    const k = document.getElementById("gr-user-persona-select");
    k.innerHTML = "<option value=\"\">å½“å‰é»˜è®¤</option>";
    const l = await Gb.personaPresets.toArray();
    l.forEach(b => {
      const c = document.createElement("option");
      c.value = b.id;
      c.textContent = b.persona.substring(0, 20) + "...";
      if (a.userPersonaId === b.id) {
        c.selected = true;
      }
      k.appendChild(c);
    });
    document.getElementById("gr-output-length").value = a.outputLength || 500;
    document.getElementById("gr-context-limit").value = a.contextLimit || 20;
    document.getElementById("gr-macro-world-view").value = a.macroWorldView || "";
    const m = document.getElementById("gr-save-story-btn");
    const n = document.getElementById("gr-cancel-settings-btn");
    const o = m.cloneNode(true);
    const p = n.cloneNode(true);
    m.parentNode.replaceChild(o, m);
    n.parentNode.replaceChild(p, n);
    o.onclick = () => Qq();
    p.onclick = () => document.getElementById("gr-settings-modal").classList.remove("visible");
  }
  async function Qq() {
    const a = document.getElementById("gr-story-title");
    const b = document.getElementById("gr-author-select");
    const c = document.getElementById("gr-user-persona-select");
    const d = document.getElementById("gr-output-length");
    const e = document.getElementById("gr-context-limit");
    const f = document.getElementById("gr-macro-world-view");
    const g = a.value.trim();
    const h = parseInt(b.value);
    const i = Array.from(document.querySelectorAll("#gr-char-list input:checked")).map(a => a.value);
    const j = Array.from(document.querySelectorAll("#gr-worldbook-list input:checked")).map(a => a.value);
    const k = c.value;
    const l = parseInt(d.value) || 500;
    const m = parseInt(e.value) || 20;
    const n = f.value.trim();
    if (!g) {
      return alert("è¯·è¾“å…¥ä¹¦å");
    }
    if (i.length === 0) {
      return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§’è‰²æˆ–ç¾¤èŠ");
    }
    const o = {
      charIds: i,
      bookIds: j,
      userPersonaId: k,
      outputLength: l,
      contextLimit: m,
      macroWorldView: n
    };
    if (Bq.activeStoryId) {
      await Gb.grStories.update(Bq.activeStoryId, {
        title: g,
        authorId: h,
        settings: o
      });
    } else {
      const a = {
        title: g,
        authorId: h,
        settings: o,
        chapters: [],
        lastUpdated: Date.now()
      };
      Bq.activeStoryId = await Gb.grStories.add(a);
    }
    document.getElementById("gr-settings-modal").classList.remove("visible");
    const p = await Gb.grStories.get(Bq.activeStoryId);
    const q = Math.max(0, p.chapters.length - 1);
    Rq(Bq.activeStoryId, q);
  }
  async function Rq(a, b = 0) {
    Bq.activeStoryId = a;
    const c = await Gb.grStories.get(a);
    if (!c) {
      return;
    }
    const d = c.chapters.length;
    if (d > 0 && b >= d) {
      b = d - 1;
    }
    if (b < 0) {
      b = 0;
    }
    Bq.currentChapterIndex = b;
    document.getElementById("gr-book-name-display").textContent = c.title;
    const e = document.getElementById("gr-reader-content");
    e.innerHTML = "";
    if (d === 0) {
      document.getElementById("gr-chapter-title-display").textContent = "åºç« ";
      e.innerHTML = `
            <div style="text-align:center; padding-top:100px; color:#888;">
                <p>æ•…äº‹å°šæœªå¼€å§‹ã€‚</p>
                <p>è¯·åœ¨ä¸‹æ–¹è¾“å…¥ç¬¬ä¸€ç« çš„å‰§æƒ…èµ°å‘ï¼Œç‚¹å‡»â€œç»­å†™â€å¼€å§‹åˆ›ä½œã€‚</p>
            </div>
        `;
      document.getElementById("gr-pagination-controls").style.display = "none";
      document.getElementById("gr-writing-controls").style.display = "flex";
      Sq();
      Kb("gr-reader-screen");
      return;
    }
    const f = c.chapters[b];
    const g = f.title || "ç¬¬ " + (b + 1) + " ç« ";
    document.getElementById("gr-chapter-title-display").textContent = g;
    if (f.prevSummary) {
      e.innerHTML += `
            <details class="gr-summary-box top-summary">
                <summary>ðŸ“– ä¸Šæ–‡æè¦ (Context)</summary>
                <div class="gr-summary-content" style="font-size:12px; color:#888;">` + f.prevSummary + `</div>
            </details>
        `;
    }
    e.innerHTML += "<div class=\"gr-chapter-title-large\">" + g + "</div>";
    e.innerHTML += "<div class=\"gr-chapter-text\">" + f.content.replace(/\n/g, "<br>") + "</div>";
    const h = `
            <div class="gr-summary-card editable">
                <div class="gr-summary-header">
                    <span class="gr-summary-title">Chapter Checkpoint Â· å‰§æƒ…å­˜æ¡£</span>
                    <button class="gr-mini-btn save-summary-btn" data-index="` + b + `">ä¿å­˜ä¿®æ”¹</button>
                </div>
                <textarea class="gr-summary-input" data-index="` + b + "\" placeholder=\"åœ¨æ­¤å¤„æ¦‚æ‹¬æœ¬ç« å…³é”®å‰§æƒ…ç‚¹ï¼Œä¾›AIè®°å¿†...\">" + (f.summary || "") + `</textarea>
                 <div class="gr-summary-footer">
                    * AIç»­å†™æ—¶å°†è¯»å–æ­¤æ¡†å†…å®¹ä½œä¸ºå”¯ä¸€è®°å¿†ä¾æ®ã€‚
                </div>
            </div>
        `;
    e.innerHTML += h;
    e.innerHTML += "<div style=\"height: 100px;\"></div>";
    e.querySelectorAll(".save-summary-btn").forEach(b => {
      b.onclick = b => {
        const c = parseInt(b.target.dataset.index);
        const d = e.querySelector(".gr-summary-input[data-index=\"" + c + "\"]");
        Uq(a, c, d.value);
        b.target.textContent = "å·²ä¿å­˜";
        // TOLOOK
        setTimeout(() => b.target.style.display = "none", 1000);
      };
    });
    const i = document.getElementById("gr-prev-chapter-btn");
    const j = document.getElementById("gr-next-chapter-btn");
    const k = document.getElementById("gr-pagination-controls");
    const l = document.getElementById("gr-writing-controls");
    const m = document.getElementById("gr-reroll-btn");
    k.style.display = "flex";
    i.disabled = b === 0;
    i.onclick = () => Rq(a, b - 1);
    if (b < d - 1) {
      j.textContent = "ä¸‹ä¸€ç« ";
      j.onclick = () => Rq(a, b + 1);
      l.style.display = "none";
    } else {
      j.textContent = "ç»­å†™ä¸‹ä¸€ç« ";
      j.onclick = () => {
        l.style.display = "flex";
        e.scrollTop = e.scrollHeight;
        document.getElementById("gr-direction-input").focus();
      };
      l.style.display = "flex";
      m.onclick = async () => {
        const a = await wb("é‡å†™æœ¬ç« ", "ç¡®å®šè¦åˆ é™¤å½“å‰ç« èŠ‚å¹¶é‡æ–°ç”Ÿæˆå—ï¼Ÿ", {
          confirmText: "é‡å†™",
          confirmButtonClass: "btn-danger"
        });
        if (a) {
          Vq(true);
        }
      };
    }
    Sq();
    Kb("gr-reader-screen");
    e.scrollTop = 0;
  }
  function Sq() {
    const a = document.getElementById("gr-generate-btn");
    const b = a.cloneNode(true);
    a.parentNode.replaceChild(b, a);
    b.onclick = () => Vq(false);
  }
  function Tq(a) {
    const b = document.querySelector(".gr-control-panel");
    b.innerHTML = `
        <div style="display:flex; gap:10px; align-items:center; width:100%;">
            <div class="gr-input-group" style="flex-grow:1;">
                <input type="text" id="gr-direction-input" class="gr-input" placeholder="è¾“å…¥å‰§æƒ…èµ°å‘ (ç•™ç©ºåˆ™è‡ªç”±ç»­å†™)...">
            </div>
            
            ` + (a.chapters.length > 0 ? `
            <button id="gr-reroll-btn" class="gr-main-btn" style="background-color:#F4F4F5; color:#666; border:1px solid #ddd;" title="ä¸æ»¡å½“å‰ç« ï¼Ÿé‡å†™ï¼">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            </button>
            ` : "") + `

            <button id="gr-generate-btn" class="gr-main-btn">
                <span id="gr-gen-text">ç»­å†™</span>
                <svg id="gr-gen-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg>
            </button>
        </div>
    `;
    document.getElementById("gr-generate-btn").onclick = () => Vq(false);
    const c = document.getElementById("gr-reroll-btn");
    if (c) {
      c.onclick = async () => {
        const a = await wb("é‡å†™æœ¬ç« ", "ç¡®å®šè¦åˆ é™¤å½“å‰æœ€æ–°ç« èŠ‚å¹¶é‡æ–°ç”Ÿæˆå—ï¼Ÿ\n(å¦‚æžœä½ åˆšæ‰ä¿®æ”¹äº†æ‘˜è¦ï¼Œé‡å†™åŽéœ€è¦é‡æ–°ä¿®æ”¹)", {
          confirmText: "é‡å†™",
          confirmButtonClass: "btn-danger"
        });
        if (a) {
          Vq(true);
        }
      };
    }
  }
  async function Uq(a, b, c) {
    const d = await Gb.grStories.get(a);
    if (d && d.chapters[b]) {
      d.chapters[b].summary = c;
      await Gb.grStories.put(d);
      console.log("æ‘˜è¦å·²æ‰‹åŠ¨æ›´æ–°");
    }
  }
  async function Vq(a = false) {
    if (Bq.isGenerating) {
      return;
    }
    let b = await Gb.grStories.get(Bq.activeStoryId);
    if (a && b.chapters.length > 0) {
      b.chapters.pop();
      await Gb.grStories.put(b);
      Rq(b.id, Math.max(0, b.chapters.length - 1));
    }
    const c = await Gb.grAuthors.get(b.authorId);
    const d = document.getElementById("gr-direction-input");
    const e = d.value.trim();
    const f = document.getElementById("gr-generate-btn");
    const g = document.getElementById("gr-gen-text");
    Bq.isGenerating = true;
    if (f) {
      f.disabled = true;
      if (g) {
        g.textContent = "æ’°å†™ä¸­...";
      }
    }
    try {
      const a = parseInt(b.settings.outputLength) || 500;
      const d = Math.floor(a * 1.5);
      const f = b.settings.contextLimit || 20;
      let g = "";
      for (const a of b.settings.charIds) {
        if (a.startsWith("npc_")) {
          const b = parseInt(a.replace("npc_", ""));
          const c = await Gb.npcs.get(b);
          if (c) {
            g += "- NPC " + c.name + ": " + c.persona + "\n";
          }
        } else {
          const b = v.chats[a];
          if (b) {
            const a = (b.longTermMemory || []).map(a => "  * " + a.content).join("\n");
            const c = b.history.slice(-f).map(a => {
              if (a.role === "system" || a.type === "red_packet" || a.type === "waimai_request" || a.type === "transfer") {
                return null;
              }
              let b = String(a.content);
              if (b.includes("çº¢åŒ…") || b.includes("æ‰‹æœº") || b.includes("è½¬è´¦")) {
                return null;
              }
              return "  > " + a.senderName + ": " + b.substring(0, 50);
            }).filter(Boolean).join("\n");
            g += "### è§’è‰²: " + b.name + "\n- **æ ¸å¿ƒäººè®¾**: " + b.settings.aiPersona + "\n";
            if (a) {
              g += "- **ã€é‡è¦ï¼šé•¿æœŸè®°å¿†ã€‘**:\n" + a + "\n";
            }
            if (c) {
              g += "- **ã€è¯­æ°”å‚è€ƒ (æœ€è¿‘èŠå¤©)ã€‘**:\n" + c + "\n";
            }
            g += "\n";
          }
        }
      }
      let h = "æ™®é€šç”¨æˆ·";
      if (b.settings.userPersonaId) {
        const a = await Gb.personaPresets.get(b.settings.userPersonaId);
        if (a) {
          h = a.persona;
        }
      } else if (v.chats[Object.keys(v.chats)[0]]) {
        h = v.chats[Object.keys(v.chats)[0]].settings.myPersona;
      }
      let i = "";
      for (const a of b.settings.bookIds) {
        const b = await Gb.worldBooks.get(a);
        if (b) {
          i += "- ã€Š" + b.name + "ã€‹è®¾å®š: " + b.content.filter(a => a.enabled).map(a => a.content).join(";") + "\n";
        }
      }
      let j = "è¿™æ˜¯æ•…äº‹çš„å¼€å§‹ã€‚";
      if (b.chapters && b.chapters.length > 0) {
        const a = b.chapters[b.chapters.length - 1];
        if (a && a.summary) {
          j = a.summary;
        }
      }
      let k = "";
      if (b.settings.macroWorldView) {
        k = `
# ã€ðŸ”¥ æ ¸å¿ƒä¸–ç•Œè§‚ / IFçº¿è®¾å®š (æœ€é«˜ä¼˜å…ˆçº§)ã€‘
æ³¨æ„ï¼šè¿™æ˜¯ä¸€æ¡IFçº¿æˆ–ç‰¹æ®ŠèƒŒæ™¯æ•…äº‹ã€‚**ä½ å¿…é¡»ä¼˜å…ˆéµå¾ªä»¥ä¸‹è®¾å®š**ï¼Œå¦‚æžœä»¥ä¸‹è®¾å®šä¸Žè§’è‰²çš„åŽŸå§‹äººè®¾æˆ–è®°å¿†å†²çªï¼Œ**è¯·ä»¥ä»¥ä¸‹è®¾å®šä¸ºå‡†å¹¶è¿›è¡Œé€‚é…**ï¼
---
` + b.settings.macroWorldView + `
---
`;
      }
      const l = `
# èº«ä»½
ä½ çŽ°åœ¨æ˜¯ã€` + c.name + "ã€‘ã€‚æ–‡é£Žç‰¹ç‚¹: " + c.style + `

# æ ¸å¿ƒä»»åŠ¡
ç»­å†™è¿™ç¯‡å°è¯´çš„æ–°ä¸€ç« ã€‚
` + k + `
# ã€æœ€é«˜ä¼˜å…ˆçº§ï¼šå­—æ•°æ‰©å……æŒ‡ä»¤ã€‘
ä½ å¿…é¡»è¾“å‡º **` + d + ` å­—** ä»¥ä¸Šçš„å†…å®¹ã€‚
ä¸ºäº†è¾¾åˆ°è¿™ä¸ªå­—æ•°ï¼Œä½ **å¿…é¡»**æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
1.  **æ‹’ç»æµæ°´è´¦**ï¼šä¸è¦åªå†™â€œä»–åšäº†ä»€ä¹ˆâ€ï¼Œè¦å†™â€œä»–å¦‚ä½•åšã€ä»€ä¹ˆè¡¨æƒ…ã€å¿ƒé‡Œæƒ³äº†ä»€ä¹ˆã€å‘¨å›´çŽ¯å¢ƒå¦‚ä½•â€ã€‚
2.  **ç»†èŠ‚æå†™**ï¼šå¢žåŠ çŽ¯å¢ƒæå†™ï¼ˆå…‰å½±ã€æ°”å‘³ã€å£°éŸ³ï¼‰ã€å¾®è¡¨æƒ…æå†™ã€è‚¢ä½“åŠ¨ä½œæå†™ã€‚
3.  **å¿ƒç†æ´»åŠ¨**ï¼šå¤§å¹…å¢žåŠ è§’è‰²çš„å†…å¿ƒç‹¬ç™½å’Œçº ç»“ã€‚
4.  **æ…¢é•œå¤´**ï¼šå°†å…³é”®åŠ¨ä½œæ‹†è§£ï¼Œæ”¾æ…¢å™äº‹èŠ‚å¥ã€‚

# æ•°æ®ä½¿ç”¨æŒ‡å—
1. **ä¸–ç•Œè§‚**: ` + (i ? "å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹è®¾å®šï¼š" + i : "è¯·æ ¹æ®è§’è‰²è®¾å®šè‡ªè¡Œåˆ¤æ–­ã€‚") + `
2. **æ—¶ä»£å‡€åŒ–**: ä¸¥ç¦å‡ºçŽ°ä¸ç¬¦åˆä¸–ç•Œè§‚çš„çŽ°ä»£ç‰©å“ã€‚
3. **é•¿æœŸè®°å¿†**: å¿…é¡»éµå®ˆè§’è‰²æ¡£æ¡ˆä¸­çš„è®°å¿†äº‹å®žã€‚

# è®¾å®šèµ„æ–™
- **"æˆ‘" (User) çš„è®¾å®š**: ` + h + `
- **ç™»åœºè§’è‰²æ¡£æ¡ˆ**:
` + g + `

# å½“å‰è¿›åº¦
- **å‰æƒ…æè¦**: ` + j + "\n- **ç”¨æˆ·æŒ‡ç¤º**: " + (e || "ï¼ˆæ— æŒ‡ç¤ºï¼Œè¯·é¡ºå…¶è‡ªç„¶åœ°å‘å±•å‰§æƒ…ï¼Œé‡ç‚¹æ˜¯å†™å¤Ÿå­—æ•°ï¼ï¼‰") + `

# è¾“å‡ºæ ¼å¼ (JSON)
å›žå¤å¿…é¡»ä¸”åªèƒ½æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼š
\`\`\`json
{
  "title": "å››å­—æˆ–å¤šå­—æ ‡é¢˜ (å¦‚ï¼šæœˆä¸‹å¯¹é…Œã€å±æœºå››ä¼)",
  "content": "æ­£æ–‡å†…å®¹ (å¿…é¡»ä½¿ç”¨` + c.style + "é£Žæ ¼ï¼Œ**å¼ºåˆ¶å†™æ»¡ " + d + ` å­—**ï¼Œå¤šç”¨æ¢è¡Œç¬¦\\nå¢žåŠ é˜…è¯»æ„Ÿ)",
  "summary": "ç”¨é™ˆè¿°å¥æ¦‚æ‹¬æœ¬ç« å…³é”®äº‹å®žï¼ˆè°ã€åœ¨å“ªé‡Œã€åšäº†ä»€ä¹ˆï¼‰ï¼Œä¾›ä¸‹ä¸€ç« è®°å¿†ä½¿ç”¨ã€‚"
}
\`\`\`
`;
      const {
        proxyUrl: m,
        apiKey: n,
        model: o
      } = v.apiConfig;
      const q = [{
        role: "user",
        content: "è¯·å¼€å§‹å†™ä½œï¼Œè¯·åŠ¡å¿…å†™å¤Ÿ " + d + " å­—ï¼"
      }];
      let r;
      if (m.includes("generativelanguage")) {
        let a = p(o, n, l, q);
        r = await fetch(a.url, a.data);
      } else {
        r = await fetch(m + "/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + n
          },
          body: JSON.stringify({
            model: o,
            messages: [{
              role: "system",
              content: l
            }, ...q],
            temperature: 0.9
          })
        });
      }
      if (!r.ok) {
        const a = await r.text();
        throw new Error("API è¯·æ±‚å¤±è´¥ (" + r.status + "): " + a);
      }
      const s = await r.json();
      const t = C(s);
      let u = t;
      const w = t.match(/\{[\s\S]*\}/);
      if (w) {
        u = w[0];
      } else {
        throw new Error("AIæœªè¿”å›žæœ‰æ•ˆJSONæ ¼å¼");
      }
      let x;
      try {
        x = JSON.parse(u);
      } catch (a) {
        console.warn("JSONè§£æžåˆæ¬¡å¤±è´¥ï¼Œå°è¯•ä¿®å¤è½¬ä¹‰å­—ç¬¦...", a);
        const b = u.replace(/\\([^"\\\/bfnrtu])/g, "\\\\$1");
        try {
          x = JSON.parse(b);
          console.log("JSONè‡ªåŠ¨ä¿®å¤æˆåŠŸï¼");
        } catch (b) {
          throw new Error("JSONè§£æžå¤±è´¥: " + a.message);
        }
      }
      const y = {
        title: x.title || "ç¬¬ " + (b.chapters.length + 1) + " ç« ",
        content: x.content,
        summary: x.summary,
        prevSummary: j,
        timestamp: Date.now()
      };
      b = await Gb.grStories.get(Bq.activeStoryId);
      b.chapters.push(y);
      b.lastUpdated = Date.now();
      await Gb.grStories.put(b);
      Rq(b.id, b.chapters.length - 1);
      document.getElementById("gr-direction-input").value = "";
    } catch (a) {
      console.error("ç»¿æ±Ÿç”Ÿæˆå¤±è´¥:", a);
      alert("ç”Ÿæˆå¤±è´¥: " + a.message);
    } finally {
      Bq.isGenerating = false;
      if (f) {
        f.disabled = false;
        if (g) {
          g.textContent = "ç»­å†™";
        }
      }
    }
  }
  function Wq() {
    const a = document.getElementById("gr-chapter-sidebar");
    const b = document.getElementById("gr-sidebar-overlay");
    const c = document.getElementById("gr-chapter-list-content");
    const d = document.getElementById("gr-total-chapters");
    if (!Bq.activeStoryId) {
      return;
    }
    Gb.grStories.get(Bq.activeStoryId).then(e => {
      c.innerHTML = "";
      d.textContent = "å…± " + e.chapters.length + " ç« ";
      e.chapters.forEach((a, b) => {
        const d = document.createElement("div");
        d.className = "gr-sidebar-item";
        if (b === Bq.currentChapterIndex) {
          d.classList.add("active");
        }
        d.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <span>` + (b + 1) + ". " + (a.title || "æ— é¢˜") + "</span>\n                    <span style=\"font-size:12px; color:#999;\">" + new Date(a.timestamp).toLocaleTimeString() + `</span>
                </div>
                <div style="font-size:12px; color:#999; margin-left:10px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">` + (a.summary || "").substring(0, 20) + "...</div>\n            ";
        d.onclick = () => {
          Rq(e.id, b);
          Xq();
        };
        c.appendChild(d);
      });
      a.classList.add("visible");
      b.classList.add("visible");
    });
  }
  function Xq() {
    document.getElementById("gr-chapter-sidebar").classList.remove("visible");
    document.getElementById("gr-sidebar-overlay").classList.remove("visible");
  }
  window.openChapterList = Wq;
  window.closeChapterList = Xq;
  window.openGreenRiverScreen = Eq;
  window.openAuthorManager = Hq;
  window.createNewStory = Nq;
  window.openStorySettings = Oq;
  window.addAuthor = Lq;
  window.deleteAuthor = Kq;
  let Yq = {
    currentEmailId: null,
    isEditMode: false,
    selectedEmails: new Set()
  };
  async function Zq() {
    Kb("email-screen");
    await $q();
  }
  async function $q() {
    const a = document.getElementById("email-list");
    a.innerHTML = "";
    const c = await Gb.emails.orderBy("timestamp").reverse().toArray();
    if (c.length === 0) {
      a.innerHTML = "<div style=\"text-align:center; padding:50px; color:#8E8E93;\">No Mail</div>";
      return;
    }
    const d = document.getElementById("mail-search-input").value.toLowerCase();
    c.forEach(c => {
      if (d && !c.subject.toLowerCase().includes(d) && !c.content.toLowerCase().includes(d)) {
        return;
      }
      const e = document.createElement("div");
      const f = "mail-item " + (c.isRead ? "" : "unread") + " " + (Yq.isEditMode ? "editing" : "");
      e.className = f;
      e.dataset.id = c.id;
      if (Yq.selectedEmails.has(c.id)) {
        e.classList.add("selected");
      }
      const g = new Date(c.timestamp);
      const h = g.toLocaleDateString() === new Date().toLocaleDateString() ? g.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      }) : g.toLocaleDateString();
      e.innerHTML = `
            <div class="mail-select-checkbox"></div>
            <div class="mail-item-header">
                <span class="mail-sender">` + b(c.sender) + "</span>\n                <span class=\"mail-date\">" + h + `</span>
            </div>
            <div class="mail-subject">` + b(c.subject) + "</div>\n            <div class=\"mail-preview\">" + b(c.content).replace(/\n/g, " ").substring(0, 80) + "</div>\n        ";
      e.onclick = () => {
        if (Yq.isEditMode) {
          _q(e, c.id);
        } else {
          dr(c.id);
        }
      };
      a.appendChild(e);
    });
  }
  function _q(a, b) {
    if (Yq.selectedEmails.has(b)) {
      Yq.selectedEmails.delete(b);
      a.classList.remove("selected");
    } else {
      Yq.selectedEmails.add(b);
      a.classList.add("selected");
    }
    ar();
  }
  function ar() {
    const a = document.getElementById("mail-delete-selected-btn");
    const b = Yq.selectedEmails.size;
    a.textContent = b > 0 ? "åˆ é™¤ (" + b + ")" : "åˆ é™¤";
    a.disabled = b === 0;
  }
  async function br() {
    const a = Yq.selectedEmails.size;
    if (a === 0) {
      return;
    }
    const b = await wb("åˆ é™¤é‚®ä»¶", "ç¡®å®šè¦åˆ é™¤è¿™ " + a + " å°é‚®ä»¶å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚", {
      confirmButtonClass: "btn-danger",
      confirmText: "åˆ é™¤"
    });
    if (b) {
      const a = Array.from(Yq.selectedEmails);
      await Gb.emails.bulkDelete(a);
      Yq.selectedEmails.clear();
      ar();
      await $q();
    }
  }
  function cr() {
    const a = document.getElementById("email-list");
    const b = a.querySelectorAll(".mail-item");
    const c = Yq.selectedEmails.size < b.length;
    b.forEach(a => {
      const b = parseInt(a.dataset.id);
      if (c) {
        Yq.selectedEmails.add(b);
        a.classList.add("selected");
      } else {
        Yq.selectedEmails.delete(b);
        a.classList.remove("selected");
      }
    });
    ar();
  }
  async function dr(a) {
    const b = await Gb.emails.get(a);
    if (!b) {
      return;
    }
    Yq.currentEmailId = a;
    if (!b.isRead) {
      await Gb.emails.update(a, {
        isRead: true
      });
    }
    document.getElementById("mail-detail-subject").textContent = b.subject;
    document.getElementById("mail-detail-from").textContent = b.sender;
    document.getElementById("mail-detail-to").textContent = b.recipient || "Me";
    document.getElementById("mail-detail-time").textContent = new Date(b.timestamp).toLocaleString();
    const c = document.getElementById("mail-detail-avatar");
    c.textContent = b.sender.charAt(0).toUpperCase();
    document.getElementById("mail-detail-body").innerHTML = b.content.replace(/\n/g, "<br>");
    const d = document.getElementById("forward-email-btn");
    const e = d.cloneNode(true);
    d.parentNode.replaceChild(e, d);
    e.onclick = () => nr(b);
    const f = document.getElementById("delete-email-btn");
    if (f) {
      const a = f.cloneNode(true);
      f.parentNode.replaceChild(a, f);
      a.onclick = () => hr();
    }
    Kb("email-detail-screen");
  }
  function er() {
    Kb("email-screen");
    $q();
  }
  function fr() {
    Yq.isEditMode = !Yq.isEditMode;
    const a = document.getElementById("mail-edit-btn");
    const b = document.getElementById("mail-action-bar");
    const c = document.getElementById("email-list");
    if (Yq.isEditMode) {
      a.textContent = "å®Œæˆ";
      a.style.color = "var(--mail-accent)";
      a.style.fontWeight = "600";
      a.innerHTML = "å®Œæˆ";
      b.style.display = "flex";
      Yq.selectedEmails.clear();
      ar();
      c.querySelectorAll(".mail-item").forEach(a => a.classList.add("editing"));
    } else {
      a.innerHTML = "ç¼–è¾‘";
      a.style.color = "currentColor";
      a.style.fontWeight = "normal";
      b.style.display = "none";
      Yq.selectedEmails.clear();
      c.querySelectorAll(".mail-item").forEach(a => {
        a.classList.remove("editing", "selected");
      });
    }
  }
  async function gr(a) {
    if (confirm("ç¡®å®šè¦åˆ é™¤è¿™å°é‚®ä»¶å—ï¼Ÿ")) {
      await Gb.emails.delete(a);
      $q();
    }
  }
  async function hr() {
    if (Yq.currentEmailId) {
      await gr(Yq.currentEmailId);
      er();
    }
  }
  function ir() {
    const a = {
      userMask: document.getElementById("mail-user-mask").value.trim(),
      worldContext: document.getElementById("mail-world-context").value.trim(),
      personaId: document.getElementById("mail-user-persona-select").value,
      allowRandom: document.getElementById("mail-allow-random-npc").checked,
      genCount: document.getElementById("mail-gen-count").value,
      selectedSenders: Array.from(document.querySelectorAll("#mail-sender-list input:checked")).map(a => a.value),
      selectedBookIds: Array.from(document.querySelectorAll("#mail-context-list input:checked")).map(a => a.value)
    };
    localStorage.setItem("ephone_mail_config", JSON.stringify(a));
    console.log("é‚®ç®±é…ç½®å·²ä¿å­˜:", a);
    return a;
  }
  function jr() {
    const a = localStorage.getItem("ephone_mail_config");
    if (a) {
      return JSON.parse(a);
    } else {
      return null;
    }
  }
  async function kr() {
    const a = document.getElementById("mail-user-persona-select");
    if (a) {
      a.innerHTML = "<option value=\"\">-- ä»…ä½¿ç”¨ä¸‹æ–¹å…³é”®è¯ (æ— è¯¦ç»†äººè®¾) --</option>";
      if (v.activeChatId) {
        const b = v.chats[v.activeChatId];
        if (b && b.settings.myPersona) {
          const c = document.createElement("option");
          c.value = "current_chat";
          c.textContent = "å½“å‰èŠå¤©è®¾å®š: " + b.settings.myPersona.substring(0, 15).replace(/\n/g, " ") + "...";
          a.appendChild(c);
        }
      }
      if (v.personaPresets && v.personaPresets.length > 0) {
        v.personaPresets.forEach((b, c) => {
          const d = document.createElement("option");
          d.value = b.id;
          const e = b.persona ? b.persona.substring(0, 20).replace(/\n/g, " ") : "é¢„è®¾ " + (c + 1);
          d.textContent = "äººè®¾åº“: " + e + "...";
          a.appendChild(d);
        });
      }
    }
    const b = document.getElementById("mail-sender-list");
    b.innerHTML = "";
    const c = Object.values(v.chats).filter(a => !a.isGroup);
    const d = await Gb.npcs.toArray();
    [...c, ...d].forEach(a => {
      const c = document.createElement("div");
      c.className = "gr-checkbox-item";
      c.innerHTML = "<input type=\"checkbox\" value=\"" + a.name + "\" data-type=\"" + (a.id ? "char" : "npc") + "\"> <span>" + a.name + "</span>";
      c.onclick = a => {
        if (a.target.tagName !== "INPUT") {
          c.querySelector("input").click();
        }
      };
      b.appendChild(c);
    });
    const e = document.getElementById("mail-context-list");
    e.innerHTML = "";
    const f = await Gb.worldBooks.toArray();
    f.forEach(a => {
      const b = document.createElement("div");
      b.className = "gr-checkbox-item";
      b.innerHTML = "<input type=\"checkbox\" value=\"" + a.id + "\"> <span>" + a.name + "</span>";
      b.onclick = a => {
        if (a.target.tagName !== "INPUT") {
          b.querySelector("input").click();
        }
      };
      e.appendChild(b);
    });
    const g = jr();
    if (g) {
      if (g.userMask) {
        document.getElementById("mail-user-mask").value = g.userMask;
      }
      if (g.worldContext) {
        document.getElementById("mail-world-context").value = g.worldContext;
      }
      if (g.personaId) {
        a.value = g.personaId;
      }
      if (g.genCount) {
        document.getElementById("mail-gen-count").value = g.genCount;
      }
      document.getElementById("mail-allow-random-npc").checked = g.allowRandom !== false;
      if (g.selectedSenders) {
        g.selectedSenders.forEach(a => {
          const b = document.querySelector("#mail-sender-list input[value=\"" + a + "\"]");
          if (b) {
            b.checked = true;
          }
        });
      }
      if (g.selectedBookIds) {
        g.selectedBookIds.forEach(a => {
          const b = document.querySelector("#mail-context-list input[value=\"" + a + "\"]");
          if (b) {
            b.checked = true;
          }
        });
      }
    }
    document.getElementById("email-generator-modal").classList.add("visible");
  }
  async function lr() {
    const a = jr();
    if (!a || !a.userMask) {
      await Bb("æç¤º", "è¯·å…ˆç‚¹å‡»æ—è¾¹çš„é½¿è½®å›¾æ ‡âš™ï¸ï¼Œé…ç½®æ‚¨çš„æ”¶ä»¶äººèº«ä»½å’ŒèƒŒæ™¯ã€‚");
      kr();
      return;
    }
    await Bb("æ­£åœ¨æŽ¥æ”¶...", "æ­£åœ¨æ ¹æ®ä¿å­˜çš„é…ç½® (" + a.userMask + ") ç”Ÿæˆé‚®ä»¶...");
    await mr(a);
  }
  async function mr(a) {
    const {
      userMask: b,
      worldContext: c,
      allowRandom: d,
      personaId: e,
      selectedSenders: f,
      selectedBookIds: g
    } = a;
    let h = parseInt(a.genCount) || 3;
    if (h > 10) {
      h = 10;
    }
    let i = "";
    if (e === "current_chat" && v.activeChatId) {
      const a = v.chats[v.activeChatId];
      i = a.settings.myPersona || "";
    } else if (e) {
      const a = v.personaPresets.find(a => a.id === e);
      if (a) {
        i = a.persona;
      }
    }
    let j = "";
    for (const b of g || []) {
      const a = await Gb.worldBooks.get(b);
      if (a) {
        j += "- ã€Š" + a.name + "ã€‹: " + a.content.filter(a => a.enabled).map(a => a.content).join("; ") + "\n";
      }
    }
    let k = "";
    if (f && f.length > 0) {
      const a = Object.values(v.chats).filter(a => !a.isGroup && f.includes(a.name));
      if (a.length > 0) {
        k = `
# ã€é‡è¦ã€‘æŒ‡å®šå‘ä»¶äººçš„è¯¦ç»†æ¡£æ¡ˆ
`;
        a.forEach(a => {
          const b = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => a.content).join("; ") : "æš‚æ— ";
          const c = a.history.filter(a => !a.isHidden).slice(-5).map(b => (b.role === "user" ? "æˆ‘" : a.name) + ": " + String(b.content).substring(0, 50)).join("\n");
          k += "## å‘ä»¶äºº: " + a.name + "\n- **äººè®¾**: " + a.settings.aiPersona.substring(0, 200) + "...\n- **é•¿æœŸè®°å¿†**: " + b + `
- **æœ€è¿‘å¯¹è¯**: 
` + c + `

`;
        });
      }
    }
    const l = `
# è§’è‰²ï¼šé‚®ä»¶ç³»ç»Ÿç”Ÿæˆå™¨
è¯·æ ¹æ®ä»¥ä¸‹è®¾å®šç”Ÿæˆ **` + h + `** å°é‚®ä»¶ã€‚

# æ”¶ä»¶äººæ¡£æ¡ˆ
- **èº«ä»½**: ` + b + "\n" + (i ? "- **è¯¦ç»†èƒŒæ™¯**: " + i.replace(/\n/g, " ") : "") + "\n- **ä¸–ç•Œè§‚**: " + (c || "çŽ°ä»£èŒåœº/ç”Ÿæ´»") + "\n" + (j ? "- **ä¸–ç•Œä¹¦è§„åˆ™**: \n" + j : "") + `

` + k + `

# å‘ä»¶äººå€™é€‰
` + (f && f.length > 0 ? "- æŒ‡å®šå‘ä»¶äºº: " + f.join(", ") : "") + "\n" + (d ? "- å…è®¸ç”Ÿæˆéšæœºè·¯äºº/å¹¿å‘Š/é€šçŸ¥" : "") + `

# è¾“å‡ºæ ¼å¼ (JSON Only)
\`\`\`json
[
  {
    "sender": "å‘ä»¶äººå§“å",
    "subject": "é‚®ä»¶æ ‡é¢˜",
    "content": "é‚®ä»¶æ­£æ–‡ (æ”¯æŒæ¢è¡Œç¬¦\\n)",
    "timestamp_offset": 0 (è·ç¦»çŽ°åœ¨çš„åˆ†é’Ÿæ•°ï¼Œè´Ÿæ•°è¡¨ç¤ºè¿‡åŽ»)
  }
]
\`\`\`
`;
    try {
      const {
        proxyUrl: a,
        apiKey: c,
        model: d
      } = v.apiConfig;
      let e = a.includes("generativelanguage");
      let f = p(d, c, l, [{
        role: "user",
        content: "Generate " + h + " emails"
      }]);
      const g = e ? await fetch(f.url, f.data) : await fetch(a + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: d,
          messages: [{
            role: "system",
            content: l
          }, {
            role: "user",
            content: "Generate " + h + " emails"
          }],
          temperature: 1
        })
      });
      if (!g.ok) {
        throw new Error("APIè¯·æ±‚å¤±è´¥");
      }
      const i = await g.json();
      const j = C(i);
      const k = j.replace(/^```json\s*/, "").replace(/```$/, "");
      const m = JSON.parse(k);
      const n = Date.now();
      const o = m.map(a => ({
        sender: a.sender,
        senderType: "gen",
        recipient: b,
        subject: a.subject,
        content: a.content,
        timestamp: n - (a.timestamp_offset || 0) * 60000,
        isRead: false
      }));
      await Gb.emails.bulkAdd(o);
      await $q();
      await Bb("æŽ¥æ”¶æˆåŠŸ", "æ”¶åˆ° " + o.length + " å°æ–°é‚®ä»¶ã€‚");
    } catch (a) {
      console.error(a);
      alert("ç”Ÿæˆå¤±è´¥: " + a.message);
    }
  }
  document.getElementById("start-generate-email-btn").addEventListener("click", async () => {
    const a = document.getElementById("mail-user-mask").value.trim();
    const b = document.getElementById("mail-world-context").value.trim();
    const c = document.getElementById("mail-allow-random-npc").checked;
    let d = parseInt(document.getElementById("mail-gen-count").value);
    if (isNaN(d) || d < 1) {
      d = 3;
    }
    if (d > 10) {
      d = 10;
    }
    const e = document.getElementById("mail-user-persona-select");
    let f = "";
    if (e && e.value) {
      if (e.value === "current_chat" && v.activeChatId) {
        const a = v.chats[v.activeChatId];
        f = a.settings.myPersona || "";
      } else {
        const a = v.personaPresets.find(a => a.id === e.value);
        if (a) {
          f = a.persona;
        }
      }
    }
    const g = Array.from(document.querySelectorAll("#mail-sender-list input:checked")).map(a => a.value);
    const h = Array.from(document.querySelectorAll("#mail-context-list input:checked")).map(a => a.value);
    if (!a) {
      return alert("è¯·è®¾ç½®æ”¶ä»¶äººèº«ä»½");
    }
    const i = document.getElementById("start-generate-email-btn");
    const j = i.textContent;
    i.textContent = "è¯»å–è®°å¿†ä¸­...";
    i.disabled = true;
    let k = "";
    for (const a of h) {
      const b = await Gb.worldBooks.get(a);
      if (b) {
        k += "- ã€Š" + b.name + "ã€‹: " + b.content.filter(a => a.enabled).map(a => a.content).join("; ") + "\n";
      }
    }
    let l = "";
    if (g.length > 0) {
      const a = Object.values(v.chats).filter(a => !a.isGroup && g.includes(a.name));
      if (a.length > 0) {
        l = `
# ã€é‡è¦ã€‘æŒ‡å®šå‘ä»¶äººçš„è¯¦ç»†æ¡£æ¡ˆ (è¯·æ ¹æ®è¿™äº›ä¿¡æ¯ç”Ÿæˆä¸ªæ€§åŒ–é‚®ä»¶)
`;
        a.forEach(a => {
          const b = a.longTermMemory && a.longTermMemory.length > 0 ? a.longTermMemory.map(a => a.content).join("; ") : "æš‚æ— ";
          const c = a.history.filter(a => !a.isHidden).slice(-5).map(b => (b.role === "user" ? "æˆ‘" : a.name) + ": " + String(b.content).substring(0, 50)).join("\n");
          l += "## å‘ä»¶äºº: " + a.name + "\n";
          l += "- **æ ¸å¿ƒäººè®¾**: " + a.settings.aiPersona.substring(0, 200) + "...\n";
          l += "- **é•¿æœŸè®°å¿†**: " + b + "\n";
          l += "- **æœ€è¿‘å¯¹è¯çŠ¶æ€**: \n" + (c || "(æ— æœ€è¿‘å¯¹è¯)") + "\n";
          l += `> æŒ‡å¯¼: è¯·æ ¹æ®è¯¥è§’è‰²çš„æ€§æ ¼å’Œä½ ä»¬æœ€è¿‘çš„å¯¹è¯çŠ¶æ€ï¼ˆä¾‹å¦‚æ˜¯å¦åˆšåµè¿‡æž¶ã€æ˜¯å¦æœ‰æœªå®Œæˆçš„çº¦å®šï¼‰æ¥æ’°å†™é‚®ä»¶ã€‚

`;
        });
      }
    }
    const m = `
# è§’è‰²ï¼šé‚®ä»¶ç³»ç»Ÿç”Ÿæˆå™¨
è¯·æ ¹æ®ä»¥ä¸‹è®¾å®šç”Ÿæˆ **` + d + `** å°é‚®ä»¶ã€‚

# æ”¶ä»¶äººæ¡£æ¡ˆ
- **å½“å‰èº«ä»½(User Mask)**: ` + a + "\n" + (f ? "- **è¯¦ç»†äººè®¾èƒŒæ™¯**: " + f.replace(/\n/g, " ") : "") + "\n- **æ‰€åœ¨ä¸–ç•Œè§‚**: " + (b || "çŽ°ä»£èŒåœº/ç”Ÿæ´»") + "\n" + (k ? "- **ä¸–ç•Œä¹¦è§„åˆ™**: \n" + k : "") + `

` + l + `

# å‘ä»¶äººå€™é€‰æ± 
` + (g.length > 0 ? "- æŒ‡å®šå‘ä»¶äººåˆ—è¡¨: " + g.join(", ") : "") + "\n" + (c ? "- å…è®¸ç”Ÿæˆéšæœºè·¯äºº/ç³»ç»Ÿé€šçŸ¥/åžƒåœ¾é‚®ä»¶ (å¦‚: é“¶è¡Œè´¦å•, å¹¿å‘Š, ç¥žç§˜é‚€è¯·, å·¥ä½œé€šå‘Š)" : "") + `

# æ ¸å¿ƒè¦æ±‚
1. **è¿žè´¯æ€§**: å¦‚æžœå‘ä»¶äººæ˜¯ä¸Šè¿°â€œæŒ‡å®šå‘ä»¶äººâ€ä¸­çš„è§’è‰²ï¼Œé‚®ä»¶å†…å®¹**å¿…é¡»**ä¸Žä½ ä»¬çš„â€œæœ€è¿‘å¯¹è¯çŠ¶æ€â€å’Œâ€œé•¿æœŸè®°å¿†â€ç›¸ç¬¦ã€‚
   - *ä¾‹å­*: å¦‚æžœæœ€è¿‘å¯¹è¯åœ¨åµæž¶ï¼Œé‚®ä»¶å¯èƒ½æ˜¯é“æ­‰ä¿¡æˆ–å†·æ·¡çš„é€šçŸ¥ï¼›å¦‚æžœæœ€è¿‘åœ¨çƒ­æ‹ï¼Œé‚®ä»¶å¯èƒ½æ˜¯æƒ…ä¹¦ã€‚
2. **æ²‰æµ¸æ„Ÿ**: é‚®ä»¶å†…å®¹å¿…é¡»ç¬¦åˆæ”¶ä»¶äººèº«ä»½å’Œä¸–ç•Œè§‚ã€‚
3. **å¤šæ ·æ€§**: åŒ…å«ä¸åŒç±»åž‹çš„é‚®ä»¶ï¼ˆæ­£å¼ã€éžæ­£å¼ã€åžƒåœ¾é‚®ä»¶ã€ç´§æ€¥é€šçŸ¥ï¼‰ã€‚
4. **æ ¼å¼**: è¿”å›žä¸€ä¸ªJSONæ•°ç»„ã€‚

# è¾“å‡ºæ ¼å¼ (JSON Only)
\`\`\`json
[
  {
    "sender": "å‘ä»¶äººå§“å",
    "subject": "é‚®ä»¶æ ‡é¢˜",
    "content": "é‚®ä»¶æ­£æ–‡ (æ”¯æŒæ¢è¡Œç¬¦\\n)",
    "timestamp_offset": 0 (è·ç¦»çŽ°åœ¨çš„åˆ†é’Ÿæ•°ï¼Œè´Ÿæ•°è¡¨ç¤ºè¿‡åŽ»ï¼Œä¾‹å¦‚ 60 è¡¨ç¤ºä¸€å°æ—¶å‰æ”¶åˆ°)
  }
]
\`\`\`
`;
    try {
      const {
        proxyUrl: b,
        apiKey: c,
        model: e
      } = v.apiConfig;
      i.textContent = "ç”Ÿæˆä¸­...";
      let f = b.includes("generativelanguage");
      let g = p(e, c, m, [{
        role: "user",
        content: "Generate " + d + " emails"
      }]);
      const h = f ? await fetch(g.url, g.data) : await fetch(b + "/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + c
        },
        body: JSON.stringify({
          model: e,
          messages: [{
            role: "system",
            content: m
          }, {
            role: "user",
            content: "Generate " + d + " emails"
          }],
          temperature: 1
        })
      });
      if (!h.ok) {
        throw new Error("APIè¯·æ±‚å¤±è´¥");
      }
      const j = await h.json();
      const k = C(j);
      const l = k.replace(/^```json\s*/, "").replace(/```$/, "");
      const n = JSON.parse(l);
      const o = Date.now();
      const q = n.map(b => ({
        sender: b.sender,
        senderType: "gen",
        recipient: a,
        subject: b.subject,
        content: b.content,
        timestamp: o - (b.timestamp_offset || 0) * 60000,
        isRead: false
      }));
      await Gb.emails.bulkAdd(q);
      document.getElementById("email-generator-modal").classList.remove("visible");
      await $q();
      await Bb("æŽ¥æ”¶æˆåŠŸ", "æ”¶åˆ° " + q.length + " å°æ–°é‚®ä»¶ã€‚");
    } catch (a) {
      console.error(a);
      alert("æŽ¥æ”¶å¤±è´¥: " + a.message);
    } finally {
      i.textContent = j;
      i.disabled = false;
    }
  });
  async function nr(a) {
    await Gh();
    const b = document.getElementById("confirm-share-target-btn");
    const c = b.cloneNode(true);
    b.parentNode.replaceChild(c, b);
    c.onclick = async () => {
      const b = Array.from(document.querySelectorAll(".share-target-checkbox:checked")).map(a => a.dataset.chatId);
      if (b.length === 0) {
        return alert("è¯·é€‰æ‹©è¦è½¬å‘åˆ°çš„èŠå¤©ã€‚");
      }
      const c = {
        role: "user",
        type: "forwarded_email",
        timestamp: Date.now(),
        content: "[é‚®ä»¶] " + a.subject,
        emailData: {
          subject: a.subject,
          sender: a.sender,
          date: new Date(a.timestamp).toLocaleString(),
          preview: a.content.replace(/\n/g, " ").substring(0, 100),
          fullContent: a.content
        }
      };
      const d = `
ðŸ“§ **è½¬å‘é‚®ä»¶**
**å‘ä»¶äºº:** ` + a.sender + "\n**æ”¶ä»¶äºº:** " + (a.recipient || "æˆ‘") + "\n**ä¸»é¢˜:** " + a.subject + `
----------------
` + a.content + "\n";
      for (const e of b) {
        const b = v.chats[e];
        if (b) {
          b.history.push(c);
          const e = a.sender === b.name || a.sender === b.originalName;
          let f = "";
          if (e) {
            f = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æŠŠä½ ã€ä¹‹å‰å‘ç»™TAçš„è¿™å°é‚®ä»¶ã€‘è½¬å‘å›žç»™ä½ äº†ã€‚è¯·æ³¨æ„ï¼šè¿™å°é‚®ä»¶æ˜¯**ä½ è‡ªå·±å†™**çš„ï¼Œä¸æ˜¯ç”¨æˆ·å†™çš„ã€‚ç”¨æˆ·å¯èƒ½æ˜¯æƒ³å’Œä½ è®¨è®ºé‚®ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ–è€…å¯¹ä½ çš„é‚®ä»¶è¡¨ç¤ºå›žåº”ã€‚è¯·ä»¥â€œé‚®ä»¶ä½œè€…â€çš„èº«ä»½è¿›è¡Œå›žå¤ã€‚]";
          } else {
            f = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·è½¬å‘äº†ä¸€å°é‚®ä»¶ç»™ä½ ã€‚è¿™å°é‚®ä»¶æ˜¯ã€" + a.sender + "ã€‘å†™çš„ã€‚è¯·æ ¹æ®å†…å®¹å’Œä½ ä»¬çš„å…³ç³»åšå‡ºååº”ã€‚]";
          }
          b.history.push({
            role: "system",
            content: f + `

--- é‚®ä»¶è¯¦æƒ… ---
` + d,
            timestamp: Date.now() + 1,
            isHidden: true
          });
          await Gb.chats.put(b);
        }
      }
      document.getElementById("share-target-modal").classList.remove("visible");
      await Bb("è½¬å‘æˆåŠŸ", "é‚®ä»¶å·²ä»¥å¡ç‰‡å½¢å¼å‘é€ã€‚");
      if (v.activeChatId && b.includes(v.activeChatId)) {
        cd(v.activeChatId);
      }
    };
  }
  document.getElementById("mail-search-input").addEventListener("input", $q);
  window.openEmailApp = Zq;
  window.openEmailSettings = kr;
  window.handleQuickReceiveMail = lr;
  window.toggleEmailEditMode = fr;
  window.closeEmailDetail = er;
  window.deleteCurrentEmail = hr;
  async function or() {
    const a = await wb("ç¡®è®¤é‡ç½®å¤–è§‚ï¼Ÿ", `æ­¤æ“ä½œå°†æŠŠå½“å‰çš„å£çº¸ã€ä¸»é¢˜ã€CSSã€å›¾æ ‡å’Œå­—ä½“æ¢å¤ä¸ºé»˜è®¤çŠ¶æ€ã€‚

âœ… ä½ çš„ã€é¢„è®¾åº“ã€‘ä¸ä¼šè¢«åˆ é™¤ã€‚
âœ… æ­¤åŠŸèƒ½ç”¨äºŽä¿®å¤å›  CSS é”™è¯¯å¯¼è‡´æ— æ³•æ‰“å¼€å¤–è§‚è®¾ç½®çš„é—®é¢˜ã€‚

ç¡®å®šè¦æ‰§è¡Œå—ï¼Ÿ`, {
      confirmButtonClass: "btn-danger",
      confirmText: "ç«‹å³é‡ç½®"
    });
    if (!a) {
      return;
    }
    await Bb("å¤„ç†ä¸­...", "æ­£åœ¨é‡ç½®å¤–è§‚é…ç½®...");
    try {
      const a = {
        ...Xa
      };
      const b = {
        ...Ya
      };
      v.globalSettings.wallpaper = "linear-gradient(135deg, #89f7fe, #66a6ff)";
      v.globalSettings.cphoneWallpaper = "linear-gradient(135deg, #f6d365, #fda085)";
      v.globalSettings.globalChatBackground = "";
      v.globalSettings.globalCss = "";
      v.globalSettings.fontUrl = "";
      v.globalSettings.theme = "light";
      v.globalSettings.appIcons = a;
      v.globalSettings.cphoneAppIcons = b;
      v.globalSettings.showStatusBar = false;
      v.globalSettings.showPhoneFrame = false;
      v.globalSettings.detachStatusBar = false;
      v.globalSettings.enableMinimalChatUI = false;
      v.globalSettings.alwaysShowMusicIsland = false;
      v.globalSettings.chatActionButtonsOrder = null;
      await Gb.globalSettings.put(v.globalSettings);
      localStorage.setItem("ephone-theme", "light");
      hh("light");
      fd();
      Wg();
      pi("");
      kc("");
      Zg();
      Xg();
      fk();
      eh(false);
      fh(false);
      gh(false);
      if (typeof ym === "function") {
        await ym();
      }
      await Bb("é‡ç½®æˆåŠŸ", "å¤–è§‚å·²æ¢å¤é»˜è®¤çŠ¶æ€ï¼\nçŽ°åœ¨ä½ åº”è¯¥å¯ä»¥æ­£å¸¸æ‰“å¼€å¤–è§‚è®¾ç½®é¡µé¢äº†ã€‚");
    } catch (a) {
      console.error("é‡ç½®å¤–è§‚å¤±è´¥:", a);
      await Bb("é”™è¯¯", "é‡ç½®å¤±è´¥: " + a.message);
    }
  }
  async function pr() {
    const a = await wb("â˜ ï¸ ä¸¥é‡è­¦å‘Šï¼šåˆå§‹åŒ–åº”ç”¨", `æ­¤æ“ä½œå°†ã€æ°¸ä¹…åˆ é™¤ã€‘æœ¬åœ°å­˜å‚¨çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š

âŒ æ‰€æœ‰èŠå¤©è®°å½•å’Œè®¾å®š
âŒ æ‰€æœ‰å›¾ç‰‡ã€è¡¨æƒ…åŒ…ã€é¢„è®¾
âŒ æ‰€æœ‰APIé…ç½®å’Œå¤–è§‚è®¾ç½®

åº”ç”¨å°†å˜å›žåˆšå®‰è£…æ—¶çš„æ ·å­ã€‚æ•°æ®ä¸€æ—¦åˆ é™¤æ— æ³•æ¢å¤ï¼

ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`, {
      confirmButtonClass: "btn-danger",
      confirmText: "æˆ‘æ˜Žç™½ï¼Œç»§ç»­"
    });
    if (!a) {
      return;
    }
    const b = "ç«‹å³é‡ç½®";
    const c = await Db("æœ€ç»ˆç¡®è®¤", "ä¸ºäº†ç¡®è®¤è¿™ä¸æ˜¯è¯¯æ“ä½œï¼Œè¯·åœ¨ä¸‹æ–¹æ¡†ä¸­å‡†ç¡®è¾“å…¥â€œ" + b + "â€å››ä¸ªå­—ï¼š", "", "text");
    if (c !== b) {
      await Bb("æ“ä½œå–æ¶ˆ", "éªŒè¯æ–‡å­—è¾“å…¥é”™è¯¯ï¼Œåˆå§‹åŒ–å·²å–æ¶ˆã€‚");
      return;
    }
    await Bb("æ­£åœ¨é‡ç½®...", "æ­£åœ¨é”€æ¯æ‰€æœ‰æ•°æ®ï¼Œåº”ç”¨å³å°†é‡å¯...");
    try {
      await Gb.transaction("rw", Gb.tables, async () => {
        for (const a of Gb.tables) {
          console.log("æ­£åœ¨æ¸…ç©ºè¡¨: " + a.name);
          await a.clear();
        }
      });
      localStorage.clear();
      // TOLOOK
      setTimeout(() => {
        window.location.reload(true);
      }, 1000);
    } catch (a) {
      console.error("åˆå§‹åŒ–å¤±è´¥:", a);
      await Bb("é”™è¯¯", "é‡ç½®è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: " + a.message + "\nè¯·å°è¯•æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ã€‚");
    }
  }
  const qr = document.getElementById("enable-system-notifications-btn");
  if (qr) {
    if ("Notification" in window && Notification.permission === "granted") {
      qr.textContent = "å·²æŽˆæƒ";
      qr.disabled = true;
      qr.style.backgroundColor = "#4cd964";
      qr.style.color = "white";
    }
    qr.addEventListener("click", async () => {
      if (!("Notification" in window)) {
        alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç³»ç»Ÿé€šçŸ¥ã€‚");
        return;
      }
      try {
        const a = await Notification.requestPermission();
        if (a === "granted") {
          qr.textContent = "å·²æŽˆæƒ";
          qr.disabled = true;
          qr.style.backgroundColor = "#4cd964";
          qr.style.color = "white";
          new Notification("EPhone", {
            body: "ç³»ç»Ÿé€šçŸ¥æŽˆæƒæˆåŠŸï¼"
          });
        } else {
          alert("æƒé™è¢«æ‹’ç»ã€‚è¯·åœ¨æ‰‹æœºç³»ç»Ÿè®¾ç½®ä¸­å…è®¸æœ¬åº”ç”¨å‘é€é€šçŸ¥ã€‚");
        }
      } catch (a) {
        console.error(a);
        alert("æŽˆæƒè¯·æ±‚å‡ºé”™ï¼Œè¯·ç¡®ä¿å·²å°†ç½‘é¡µæ·»åŠ åˆ°ä¸»å±å¹•ã€‚");
      }
    });
  }
  const rr = document.getElementById("test-system-notify-btn");
  if (rr) {
    rr.addEventListener("click", () => {
      Hc(null, "è¿™æ˜¯ä¸€æ¡ç³»ç»Ÿçº§æŽ¨é€æµ‹è¯• ðŸ””", true);
    });
  }
  function sr(a) {
    let b = document.getElementById("simple-image-zoom-overlay");
    if (!b) {
      b = document.createElement("div");
      b.id = "simple-image-zoom-overlay";
      b.innerHTML = "<img src=\"\" alt=\"Zoomed Image\">";
      b.addEventListener("click", () => {
        b.classList.remove("visible");
        // TOLOOK
        setTimeout(() => {
          b.style.display = "none";
        }, 250);
      });
      document.body.appendChild(b);
    }
    const c = b.querySelector("img");
    c.src = a;
    b.style.display = "flex";
    b.offsetWidth;
    b.classList.add("visible");
  }
  async function tr(a = "") {
    const b = document.getElementById("char-reddit-list");
    b.innerHTML = "<div class=\"spinner\"></div>";
    // TOLOOK
    setTimeout(() => {
      b.innerHTML = "<p style=\"text-align:center; padding:20px; color:#999;\">Reddit æœç´¢åŠŸèƒ½å·²ç§»é™¤ã€‚</p>";
    }, 500);
  }
  async function ur(a) {
    await Bb("æç¤º", "æ— æ³•æŸ¥çœ‹è¯¦æƒ…ï¼šReddit æ•°æ®è¯·æ±‚åŠŸèƒ½å·²ç§»é™¤ã€‚");
  }
  function vr(a) {
    const b = document.getElementById("char-reddit-list");
    b.innerHTML = "";
    if (!a || a.length === 0) {
      b.innerHTML = "<p style=\"text-align:center; padding:20px; color:#999;\">æœªæ‰¾åˆ°å†…å®¹</p>";
      return;
    }
    a.forEach(a => {
      const c = a.data;
      let d = "";
      if (c.preview && c.preview.images && c.preview.images.length > 0) {
        d = c.preview.images[0].source.url.replace(/&amp;/g, "&");
      } else if (c.thumbnail && c.thumbnail.startsWith("http")) {
        d = c.thumbnail;
      }
      const e = document.createElement("div");
      e.className = "reddit-post-item";
      const f = c.score > 1000 ? (c.score / 1000).toFixed(1) + "k" : c.score;
      e.innerHTML = `
            <div class="reddit-vote-box">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #ff4500;">
                    <path d="M12 19V5M5 12l7-7 7 7"/>
                </svg>
                <span style="font-weight:bold; margin-top:2px;">` + f + `</span>
            </div>
            <div class="reddit-content-box">
                <div class="reddit-meta">
                    <div class="reddit-sub-icon"></div>
                    <strong>` + c.subreddit_name_prefixed + "</strong>\n                    <span>â€¢ u/" + c.author + `</span>
                </div>
                <div class="reddit-title">` + c.title + "</div>\n                " + (d ? "<img src=\"" + d + "\" class=\"reddit-preview-img\" loading=\"lazy\">" : "") + `
                
                <button class="reddit-forward-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    è½¬å‘ç»™TA
                </button>
            </div>
        `;
      if (!window.redditPostCache) {
        window.redditPostCache = new Map();
      }
      window.redditPostCache.set(c.id, c);
      e.addEventListener("click", () => {
        ur(c);
      });
      const g = e.querySelector(".reddit-forward-btn");
      g.addEventListener("click", a => {
        a.stopPropagation();
        wr(c.id);
      });
      b.appendChild(e);
    });
  }
  async function wr(a, b = null) {
    let c;
    if (b) {
      c = b;
    } else {
      if (!window.redditPostCache) {
        window.redditPostCache = new Map();
      }
      c = window.redditPostCache.get(a);
    }
    if (!c) {
      alert("æ— æ³•èŽ·å–å¸–å­æ•°æ®");
      return;
    }
    await Gh();
    const d = document.getElementById("confirm-share-target-btn");
    const e = d.cloneNode(true);
    d.parentNode.replaceChild(e, d);
    e.onclick = async () => {
      const a = Array.from(document.querySelectorAll(".share-target-checkbox:checked")).map(a => a.dataset.chatId);
      if (a.length === 0) {
        return alert("è¯·é€‰æ‹©è¦è½¬å‘åˆ°çš„èŠå¤©ã€‚");
      }
      const b = {
        role: "user",
        type: "reddit_share",
        timestamp: Date.now(),
        redditData: {
          title: c.title,
          subreddit: c.subreddit_name_prefixed,
          author: c.author,
          score: c.score,
          num_comments: c.num_comments,
          permalink: c.permalink,
          image: c.thumbnail || (c.preview && c.preview.images[0] ? c.preview.images[0].source.url.replace(/&amp;/g, "&") : null),
          selftext: c.selftext ? c.selftext.substring(0, 150) + "..." : ""
        }
      };
      document.getElementById("share-target-modal").classList.remove("visible");
      await Bb("è½¬å‘ä¸­...", "æ­£åœ¨ç”Ÿæˆé¢„è§ˆå¹¶å‘é€ï¼Œè¯·ç¨å€™...");
      let d = "æ ‡é¢˜: \"" + c.title + "\"\næ¥è‡ª: " + c.subreddit_name_prefixed + "\n";
      if (c.selftext) {
        d += "\n[å†…å®¹æ‘˜è¦]: " + c.selftext.substring(0, 500) + "...\n";
      }
      try {
        const a = "https://www.reddit.com" + c.permalink + ".json?raw_json=1";
        const b = "https://corsproxy.io/?" + encodeURIComponent(a);
        const e = await fetch(b);
        if (e.ok) {
          const a = await e.json();
          const b = a[1].data.children;
          if (b.length > 0) {
            d += `
[çƒ­é—¨è¯„è®º (Top 3)]:
`;
            b.slice(0, 3).forEach((a, b) => {
              if (a.data.body) {
                d += b + 1 + ". " + a.data.author + ": " + a.data.body.substring(0, 150) + "\n";
              }
            });
          }
        }
      } catch (a) {
        console.warn("æŠ“å–è¯¦æƒ…å¤±è´¥ï¼Œä»…ä½¿ç”¨åŸºæœ¬ä¿¡æ¯", a);
      }
      for (const c of a) {
        const a = v.chats[c];
        if (a) {
          a.history.push(b);
          const c = {
            role: "system",
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·è½¬å‘äº†ä¸€ä¸ª Reddit å¸–å­ç»™ä½ ã€‚
è¯·ä½ é˜…è¯»ä»¥ä¸‹å¸–å­è¯¦æƒ…å’Œç½‘å‹è¯„è®ºã€‚
æ³¨æ„ï¼š**ç”¨æˆ·è¿˜æ²¡æœ‰å¯¹æ­¤å‘è¡¨çœ‹æ³•**ï¼ŒTAå¯èƒ½æ­£åœ¨æ‰“å­—ã€‚è¯·ä½ **å…ˆä¸è¦å›žå¤**ï¼Œè€å¿ƒç­‰å¾…ç”¨æˆ·æŽ¥ä¸‹æ¥çš„æ¶ˆæ¯ã€‚
---
` + d + "\n---]",
            timestamp: Date.now() + 1,
            isHidden: true
          };
          a.history.push(c);
          await Gb.chats.put(a);
        }
      }
      document.querySelector("#custom-modal-overlay").classList.remove("visible");
      if (a.length === 1) {
        const b = a[0];
        Kb("chat-interface-screen");
        Qd(b);
        // TOLOOK
        setTimeout(() => {
          const a = document.getElementById("chat-input");
          if (a) {
            a.focus();
          }
        }, 500);
      } else {
        alert("å·²è½¬å‘ç»™ " + a.length + " ä½å¥½å‹ã€‚");
      }
    };
  }
  window.forwardRedditPost = wr;
  async function xr() {
    await Bb("æç¤º", "Reddit æŽ¨èç”ŸæˆåŠŸèƒ½å·²ä»Žä»£ç ä¸­ç§»é™¤ã€‚");
  }
  async function yr() {
    j();
    async function a(a) {
      if (!a) {
        return;
      }
      try {
        const b = await a.text();
        const d = JSON.parse(b);
        if (d.type === "EPhoneWorldBookBackup") {
          console.log("æ£€æµ‹åˆ° EPhone å¤‡ä»½æ–‡ä»¶ï¼Œæ‰§è¡Œæ ‡å‡†å¯¼å…¥...");
          await e(d);
        } else if (d.entries && typeof d.entries === "object") {
          console.log("æ£€æµ‹åˆ° ä¸–ç•Œä¹¦æ–‡ä»¶ï¼Œéœ€è¦æ¿€æ´»ç ...");
          try {
            await i();
            await c(d, a.name);
          } catch (a) {
            console.warn("ä¸–ç•Œä¹¦å¯¼å…¥è¢«å–æ¶ˆ:", a.message);
          }
        } else {
          throw new Error("æ–‡ä»¶æ ¼å¼æ— æ³•è¯†åˆ«ã€‚è¯·ç¡®ä¿æ‚¨é€‰æ‹©çš„æ˜¯æœ‰æ•ˆçš„ EPhone ä¸–ç•Œä¹¦å¤‡ä»½æˆ– Tavern AI ä¸–ç•Œä¹¦æ–‡ä»¶ã€‚");
        }
      } catch (a) {
        console.error("å¯¼å…¥ä¸–ç•Œä¹¦æ—¶å‡ºé”™:", a);
        await Bb("å¯¼å…¥å¤±è´¥", "æ–‡ä»¶è§£æžæˆ–åº”ç”¨å¤±è´¥: " + a.message);
      }
    }
    async function c(a, b) {
      const c = b.replace(/\.json$/i, "");
      const d = await Db("å¯¼å…¥ Tavern AI ä¸–ç•Œä¹¦", "è¯·ä¸ºè¿™æœ¬è®¾å®šé›†å‘½åï¼š", c);
      if (!d || !d.trim()) {
        alert("å¯¼å…¥å·²å–æ¶ˆï¼Œå› ä¸ºæœªæä¾›ä¹¦åã€‚");
        return;
      }
      const e = Object.values(a.entries).map(a => {
        return {
          keys: a.key || [],
          comment: a.comment || "æ— å¤‡æ³¨",
          content: a.content || "",
          enabled: !a.disable
        };
      }).filter(a => a.content);
      if (e.length === 0) {
        alert("è¿™ä¸ª Tavern AI ä¸–ç•Œä¹¦ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„æ¡ç›®ã€‚");
        return;
      }
      const f = {
        id: "wb_" + Date.now(),
        name: d.trim(),
        content: e,
        categoryId: null
      };
      await Gb.worldBooks.add(f);
      v.worldBooks.push(f);
      await hd();
      await Bb("å¯¼å…¥æˆåŠŸï¼", "å·²æˆåŠŸä»Ž Tavern AI æ–‡ä»¶å¯¼å…¥è®¾å®šé›†ã€Š" + d + "ã€‹ã€‚");
    }
    async function d() {
      try {
        const a = await Gb.worldBooks.toArray();
        const b = await Gb.worldBookCategories.toArray();
        if (a.length === 0 && b.length === 0) {
          alert("æ²¡æœ‰å¯å¯¼å‡ºçš„ä¸–ç•Œä¹¦æ•°æ®ã€‚");
          return;
        }
        const c = {
          type: "EPhoneWorldBookBackup",
          version: 1,
          timestamp: Date.now(),
          books: a,
          categories: b
        };
        const d = new Blob([JSON.stringify(c, null, 2)], {
          type: "application/json"
        });
        const e = URL.createObjectURL(d);
        const f = document.createElement("a");
        f.href = e;
        f.download = "EPhone-WorldBooks-" + new Date().toISOString().split("T")[0] + ".json";
        f.click();
        URL.revokeObjectURL(e);
        await Bb("å¯¼å‡ºæˆåŠŸ", "æ‰€æœ‰ä¸–ç•Œä¹¦æ•°æ®å·²æˆåŠŸå¯¼å‡ºï¼");
      } catch (a) {
        console.error("å¯¼å‡ºä¸–ç•Œä¹¦æ—¶å‡ºé”™:", a);
        await Bb("å¯¼å‡ºå¤±è´¥", "å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: " + a.message);
      }
    }
    async function e(a) {
      try {
        if (a.type !== "EPhoneWorldBookBackup" || !a.books) {
          throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ä¸–ç•Œä¹¦å¤‡ä»½æ–‡ä»¶ã€‚");
        }
        const b = await wb("å¯¼å…¥ä¸–ç•Œä¹¦", "è¿™å°†ç”¨æ–‡ä»¶ä¸­çš„æ•°æ®ã€å®Œå…¨è¦†ç›–ã€‘æ‚¨å½“å‰æ‰€æœ‰çš„ä¸–ç•Œä¹¦å’Œåˆ†ç±»ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼", {
          confirmButtonClass: "btn-danger",
          confirmText: "ç¡®è®¤è¦†ç›–"
        });
        if (!b) {
          return;
        }
        await Gb.transaction("rw", Gb.worldBooks, Gb.worldBookCategories, async () => {
          await Gb.worldBooks.clear();
          await Gb.worldBookCategories.clear();
          if (Array.isArray(a.books)) {
            await Gb.worldBooks.bulkPut(a.books);
          }
          if (Array.isArray(a.categories)) {
            await Gb.worldBookCategories.bulkPut(a.categories);
          }
        });
        v.worldBooks = await Gb.worldBooks.toArray();
        await hd();
        await Bb("å¯¼å…¥æˆåŠŸ", "ä¸–ç•Œä¹¦æ•°æ®å·²æˆåŠŸæ¢å¤ï¼");
      } catch (a) {
        console.error("å¯¼å…¥ä¸–ç•Œä¹¦æ—¶å‡ºé”™:", a);
        await Bb("å¯¼å…¥å¤±è´¥", "æ–‡ä»¶è§£æžæˆ–åº”ç”¨å¤±è´¥: " + a.message);
      }
    }
    const f = localStorage.getItem("ephoneLastActiveTimestamp");
    if (f) {
      const a = (Date.now() - parseInt(f)) / 60000;
      if (a > 5) {
        Vl(a);
      }
    }
    Ll();
    window.showScreen = Kb;
    window.openRenderingRulesScreen = ij;
    window.handleListenTogetherClick = ae;
    window.openCharacterSelector = Gk;
    window.openCharApp = Mk;
    window.switchToMyPhone = Jk;
    window.openCharWallet = ql;
    window.switchToCharHomeScreen = Qk;
    window.openNpcEditor = Rc;
    const g = document.createElement("div");
    g.id = "sticker-action-bar";
    g.innerHTML = `
       <input type="checkbox" id="select-all-stickers-checkbox" style="margin-right: 10px;">
      <button id="delete-selected-stickers-btn" class="form-button-secondary">åˆ é™¤ (0)</button>
   `;
    document.getElementById("sticker-panel").appendChild(g);
    const h = document.createElement("button");
    h.id = "export-selected-stickers-btn";
    h.textContent = "å¯¼å‡º (0)";
    h.className = "form-button";
    h.style.marginLeft = "10px";
    g.appendChild(h);
    h.addEventListener("click", Hd);
    const l = document.createElement("style");
    l.id = "global-custom-style";
    document.head.appendChild(l);
    S.panelEl = document.getElementById("qzone-sticker-panel");
    S.gridEl = document.getElementById("qzone-sticker-grid");
    const m = localStorage.getItem("ephone-theme") || "light";
    hh(m);
    const n = document.createElement("style");
    n.id = "custom-bubble-style";
    document.head.appendChild(n);
    const p = document.createElement("style");
    p.id = "preview-bubble-style";
    document.head.appendChild(p);
    $e("", "#chat-messages", "custom-bubble-style");
    $e("", "#settings-preview-area", "preview-bubble-style");
    window.openRenderingRulesScreen = ij;
    window.showScreen = Kb;
    window.renderChatListProxy = _c;
    window.renderApiSettingsProxy = Pc;
    window.renderWallpaperScreenProxy = ed;
    window.renderWorldBookScreenProxy = hd;
    await mc();
    await Pp();
    fk();
    eh(v.globalSettings.showPhoneFrame);
    fh(v.globalSettings.detachStatusBar);
    gh(v.globalSettings.enableMinimalChatUI);
    await ti();
    pi(v.globalSettings.globalCss);
    const q = parseInt(localStorage.getItem("unreadPostsCount")) || 0;
    Te(q);
    if (v.globalSettings && v.globalSettings.fontUrl) {
      kc(v.globalSettings.fontUrl);
    }
    Ic();
    // TOLOOK
    setInterval(Ic, 30000);
    fd();
    Ke();
    Zg();
    Hj();
    document.getElementById("rules-tabs").addEventListener("click", a => {
      if (a.target.classList.contains("rules-tab")) {
        tb(a.target.dataset.categoryId);
      }
    });
    document.getElementById("add-new-rule-btn").addEventListener("click", () => sj(null));
    document.getElementById("cancel-rule-editor-btn").addEventListener("click", () => {
      document.getElementById("rule-editor-modal").classList.remove("visible");
    });
    document.getElementById("save-rule-btn").addEventListener("click", tj);
    document.getElementById("pat-btn").addEventListener("click", () => {
      if (v.activeChatId && !v.chats[v.activeChatId].isGroup) {
        const a = v.chats[v.activeChatId];
        _f(a.id, a.originalName);
      }
    });
    let r = null;
    function s(a) {
      r = a;
      const b = v.chats[v.activeChatId];
      const c = b.announcements.find(b => b.id === a);
      if (!c) {
        return;
      }
      const d = document.getElementById("announcement-action-pin");
      d.textContent = c.isPinned ? "å–æ¶ˆç½®é¡¶" : "ç½®é¡¶å…¬å‘Š";
      document.getElementById("announcement-actions-modal").classList.add("visible");
    }
    async function t() {
      if (!r) {
        return;
      }
      const a = v.chats[v.activeChatId];
      const b = a.announcements.find(a => a.id === r);
      if (b) {
        b.isPinned = !b.isPinned;
        await Gb.chats.put(a);
        ai();
      }
      document.getElementById("announcement-actions-modal").classList.remove("visible");
    }
    async function u() {
      if (!r) {
        return;
      }
      const a = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", {
        confirmButtonClass: "btn-danger"
      });
      if (a) {
        const a = v.chats[v.activeChatId];
        a.announcements = a.announcements.filter(a => a.id !== r);
        await Gb.chats.put(a);
        ai();
      }
      document.getElementById("announcement-actions-modal").classList.remove("visible");
    }
    document.getElementById("custom-modal-cancel").addEventListener("click", lb);
    document.getElementById("custom-modal-overlay").addEventListener("click", a => {
      if (a.target === eb) {
        lb();
      }
    });
    document.getElementById("export-data-btn").addEventListener("click", async () => {
      const a = await Eb("é€‰æ‹©å¯¼å‡ºæ–¹å¼", [{
        text: "åˆ†ç‰‡å¯¼å‡º (æŽ¨èï¼Œæ‰“åŒ…ä¸ºZIPï¼Œè§£åŽ‹æ¯ä¸ªåˆ‡ç‰‡é€‰æ‹©å¢žé‡å¯¼å…¥)",
        value: "slice"
      }, {
        text: "æ™ºèƒ½å¯¼å‡º (å•ä¸ªå¤§æ–‡ä»¶ï¼Œå¤ªå¤§å¯èƒ½ä¼šå¯¼è‡´å¯¼å…¥ä¸äº†)",
        value: "stream"
      }, {
        text: "ä¼ ç»Ÿå¯¼å‡º (å…¼å®¹æ—§ç‰ˆæˆ–å†…å­˜å°çš„æµè§ˆå™¨)",
        value: "blob"
      }]);
      if (a === "slice") {
        mo();
      } else if (a === "stream") {
        no();
      } else if (a === "blob") {
        oo();
      }
    });
    document.getElementById("cleanup-data-btn").addEventListener("click", bc);
    document.getElementById("offline-mode-toggle").addEventListener("change", a => {
      document.getElementById("offline-mode-options").style.display = a.target.checked ? "block" : "none";
    });
    document.getElementById("import-btn").addEventListener("click", () => document.getElementById("import-data-input").click());
    document.getElementById("time-perception-toggle").addEventListener("change", a => {
      document.getElementById("time-zone-group").style.display = a.target.checked ? "block" : "none";
    });
    document.getElementById("import-data-input").addEventListener("change", a => ec(a.target.files[0]));
    document.getElementById("import-card-input").addEventListener("change", Bi);
    function x() {
      console.log("æ‰§è¡Œå…¨å±€å˜é‡æ¸…ç†...");
      if (typeof yh === "function") {
        yh();
      }
      na = null;
      if (typeof Zd === "function") {
        Zd();
      }
      if (typeof Kf === "function") {
        Kf();
      }
      if (typeof wp === "function") {
        wp();
      }
      const a = document.getElementById("gomoku-overlay");
      if (a) {
        a.classList.remove("visible");
        if (v.activeChatId && Ua[v.activeChatId]) {
          Ua[v.activeChatId].isActive = false;
        }
      }
      const b = document.getElementById("sticker-panel");
      if (b) {
        b.classList.remove("visible");
      }
      const c = document.getElementById("music-playlist-panel");
      if (c) {
        c.classList.remove("visible");
      }
      Sa = {};
      qa = null;
      zh = null;
      $e("", "#chat-messages", "custom-bubble-style");
      $e("", "#settings-preview-area", "preview-bubble-style");
      const d = document.getElementById("typing-indicator");
      if (d) {
        d.style.display = "none";
      }
      v.activeChatId = null;
    }
    document.getElementById("back-to-list-btn").addEventListener("click", () => {
      x();
      Kb("chat-list-screen");
    });
    document.getElementById("exit-werewolf-game-btn").addEventListener("click", async () => {
      const a = await wb("é€€å‡ºæ¸¸æˆ", "ç¡®å®šè¦é€€å‡ºå½“å‰è¿™å±€ç‹¼äººæ€å—ï¼Ÿæ¸¸æˆè¿›åº¦å°†ä¸ä¼šè¢«ä¿å­˜ã€‚", {
        confirmButtonClass: "btn-danger"
      });
      if (a) {
        L.isActive = false;
        if (L.chatId) {
          Kb("chat-interface-screen");
        } else {
          x();
          Kb("home-screen");
        }
      }
    });
    const z = ["#green-river-screen .gr-icon-btn", "#alipay-screen .back-btn", "#api-settings-screen .back-btn", "#wallpaper-screen .back-btn", "#font-settings-screen .back-btn", "#tutorial-screen .back-btn"];
    z.forEach(a => {
      const b = document.querySelector(a);
      if (b) {
        b.addEventListener("click", () => {
          x();
        });
      }
    });
    document.getElementById("add-chat-btn").addEventListener("click", async () => {
      const a = await Eb("åˆ›å»ºæ–°èŠå¤©", [{
        text: "æ‰‹åŠ¨åˆ›å»ºè§’è‰²",
        value: "manual"
      }, {
        text: "ä»Žè§’è‰²å¡å¯¼å…¥ (.json/.png)",
        value: "import_card"
      }]);
      if (a === "manual") {
        const a = await Db("åˆ›å»ºæ–°èŠå¤© (ç¬¬1/2æ­¥)", "è¯·è¾“å…¥ä½ æƒ³ä¸ºTaè®¾ç½®çš„ã€å¤‡æ³¨åã€‘(ä¾‹å¦‚: å“¥å“¥)");
        if (!a || !a.trim()) {
          return;
        }
        const b = await Db("åˆ›å»ºæ–°èŠå¤© (ç¬¬2/2æ­¥)", "è¯·è¾“å…¥Taçš„ã€æœ¬åã€‘(ä¾‹å¦‚: æŽæ˜Ÿè¾°ï¼Œè¿™ä¸ªåå­—å°†ç”¨äºŽAIè¯†åˆ«)");
        if (!b || !b.trim()) {
          return;
        }
        const c = "chat_" + Date.now();
        const d = {
          id: c,
          name: a.trim(),
          originalName: b.trim(),
          isGroup: false,
          isPinned: false,
          unreadCount: 0,
          relationship: {
            status: "friend",
            blockedTimestamp: null,
            applicationReason: ""
          },
          status: {
            text: "åœ¨çº¿",
            lastUpdate: Date.now(),
            isBusy: false
          },
          settings: {
            aiPersona: "è¿™æ˜¯ä¸€ä¸ªé€šè¿‡æ‰‹åŠ¨åˆ›å»ºçš„è§’è‰²ã€‚",
            myPersona: "æˆ‘æ˜¯è°å‘€ã€‚",
            myNickname: "æˆ‘",
            maxMemory: 10,
            aiAvatar: Na,
            myAvatar: Na,
            background: "",
            theme: "default",
            fontSize: 13,
            customCss: "",
            linkedWorldBookIds: [],
            aiAvatarLibrary: [],
            myAvatarLibrary: [],
            enableBackgroundActivity: true,
            actionCooldownMinutes: 15,
            enableTimePerception: true,
            isOfflineMode: false,
            offlineMinLength: 100,
            offlineMaxLength: 300,
            offlinePresetId: null,
            timeZone: "Asia/Shanghai"
          },
          history: [],
          musicData: {
            totalTime: 0
          },
          longTermMemory: [],
          thoughtsHistory: []
        };
        v.chats[c] = d;
        await Gb.chats.put(d);
        _c();
      } else if (a === "import_card") {
        try {
          await i();
          document.getElementById("import-card-input").click();
        } catch (a) {
          console.warn("è§’è‰²å¡å¯¼å…¥è¢«å–æ¶ˆ:", a.message);
        }
      }
    });
    document.getElementById("add-group-chat-btn").addEventListener("click", uf);
    document.getElementById("transfer-cancel-btn").addEventListener("click", () => document.getElementById("transfer-modal").classList.remove("visible"));
    document.getElementById("transfer-confirm-btn").addEventListener("click", Vd);
    document.getElementById("listen-together-btn").addEventListener("click", ae);
    document.getElementById("music-exit-btn").addEventListener("click", () => ce(true));
    document.getElementById("music-return-btn").addEventListener("click", de);
    document.getElementById("music-play-pause-btn").addEventListener("click", ie);
    document.getElementById("music-next-btn").addEventListener("click", je);
    document.getElementById("music-prev-btn").addEventListener("click", ke);
    document.getElementById("music-mode-btn").addEventListener("click", le);
    document.getElementById("music-playlist-btn").addEventListener("click", () => {
      he();
      document.getElementById("music-playlist-panel").classList.add("visible");
    });
    document.getElementById("close-playlist-btn").addEventListener("click", () => document.getElementById("music-playlist-panel").classList.remove("visible"));
    document.getElementById("manage-playlist-btn").addEventListener("click", wd);
    document.getElementById("select-all-playlist-checkbox").addEventListener("change", zd);
    document.getElementById("upload-selected-to-catbox-btn").addEventListener("click", Ad);
    document.getElementById("add-song-url-btn").addEventListener("click", me);
    document.getElementById("add-song-local-btn").addEventListener("click", () => document.getElementById("local-song-upload-input").click());
    document.getElementById("local-song-upload-input").addEventListener("change", qe);
    document.getElementById("playlist-body").addEventListener("click", a => {
      const b = a.target;
      const c = parseInt(b.dataset.index);
      if (isNaN(c)) {
        return;
      }
      if (b.classList.contains("album-art-btn")) {
        pe(c);
      } else if (b.classList.contains("lyrics-btn")) {
        _j(c);
      } else if (b.classList.contains("bg-btn")) {
        oe(c);
      } else if (b.classList.contains("delete-track-btn")) {
        re(c);
      }
    });
    T.addEventListener("ended", async () => {
      document.getElementById("vinyl-view").classList.remove("spinning");
      je(true);
      await new Promise(a => // TOLOOK
      setTimeout(a, 50));
      const a = R.playlist[R.currentIndex];
      if (a && R.isActive && R.activeChatId) {
        const b = v.chats[R.activeChatId];
        if (b) {
          const c = {
            role: "system",
            content: "[ç³»ç»Ÿæç¤ºï¼šä¸Šä¸€é¦–æ­Œæ›²æ’­æ”¾å®Œæ¯•ï¼Œå·²è‡ªåŠ¨ä¸ºä½ åˆ‡æ¢åˆ°ã€Š" + a.name + "ã€‹ - " + a.artist + "]",
            timestamp: Date.now(),
            isHidden: true
          };
          b.history.push(c);
          await Gb.chats.put(b);
        }
      }
    });
    const B = document.getElementById("chat-input");
    document.getElementById("send-btn").addEventListener("click", () => {
      const a = B.value.trim();
      if (!a || !v.activeChatId) {
        return;
      }
      const b = v.chats[v.activeChatId];
      if (a.startsWith("/n ") || a.startsWith("/æ—ç™½ ")) {
        const c = a.replace(/^\/n\s+|^\/æ—ç™½\s+/, "");
        const d = {
          role: "system",
          type: "narration",
          content: c,
          timestamp: Date.now()
        };
        b.history.push(d);
        Gb.chats.put(b);
        Pd(d, b);
        B.value = "";
        B.style.height = "auto";
        B.focus();
        return;
      }
      const c = {
        role: "user",
        content: a,
        timestamp: Date.now()
      };
      if (na) {
        c.quote = na;
      }
      Pd(c, b);
      (async () => {
        b.history.push(c);
        await Gb.chats.put(b);
        _c();
      })();
      B.value = "";
      B.style.height = "auto";
      B.focus();
      yh();
      document.body.classList.remove("chat-actions-expanded");
    });
    document.getElementById("wait-reply-btn").addEventListener("click", Td);
    B.addEventListener("keypress", a => {
      if (a.key === "Enter" && !a.shiftKey) {
        a.preventDefault();
        document.getElementById("send-btn").click();
      }
    });
    document.getElementById("wallpaper-upload-input").addEventListener("change", async a => {
      const b = a.target.files[0];
      if (b) {
        const c = await new Promise((a, c) => {
          const d = new FileReader();
          d.onload = () => a(d.result);
          d.onerror = () => c(d.error);
          d.readAsDataURL(b);
        });
        W = c;
        ed();
        if (v.apiConfig.imgbbEnable && v.apiConfig.imgbbApiKey) {
          (async () => {
            try {
              console.log("[ImgBB] åŽå°å¼€å§‹ä¸Šä¼ å£çº¸...");
              const a = await I(c);
              if (W === c) {
                W = a;
                console.log("[ImgBB] åŽå°å£çº¸ä¸Šä¼ æˆåŠŸï¼Œä¸´æ—¶å˜é‡å·²æ›´æ–°ä¸º URLã€‚");
              } else {
                console.log("[ImgBB] åŽå°å£çº¸ä¸Šä¼ å®Œæˆï¼Œä½†ç”¨æˆ·å·²æ›´æ”¹é€‰æ‹©ï¼Œæ”¾å¼ƒæ›´æ–°ã€‚");
              }
            } catch (a) {
              console.error("åŽå°å£çº¸ä¸Šä¼ å¤±è´¥:", a.message);
            }
          })();
        }
        a.target.value = null;
      }
    });
    document.getElementById("save-wallpaper-btn").addEventListener("click", async () => {
      if (W) {
        v.globalSettings.wallpaper = W;
      }
      v.globalSettings.globalCss = document.getElementById("global-css-input").value.trim();
      v.globalSettings.notificationSoundUrl = document.getElementById("notification-sound-url-input").value.trim();
      v.globalSettings.showStatusBar = document.getElementById("status-bar-toggle-switch").checked;
      v.globalSettings.showPhoneFrame = document.getElementById("phone-frame-toggle-switch").checked;
      v.globalSettings.enableMinimalChatUI = document.getElementById("minimal-chat-ui-switch").checked;
      v.globalSettings.alwaysShowMusicIsland = document.getElementById("dynamic-island-music-toggle-switch").checked;
      v.globalSettings.detachStatusBar = document.getElementById("detach-status-bar-switch").checked;
      v.globalSettings.lockScreenEnabled = document.getElementById("lock-screen-toggle").checked;
      v.globalSettings.lockScreenPassword = document.getElementById("lock-screen-password-input").value.trim();
      const a = document.getElementById("lock-wallpaper-preview");
      if (a.dataset.tempUrl) {
        v.globalSettings.lockScreenWallpaper = a.dataset.tempUrl;
      }
      await Gb.globalSettings.put(v.globalSettings);
      fd();
      Wg();
      W = null;
      Zg();
      Xg();
      pi(v.globalSettings.globalCss);
      fk();
      gh(v.globalSettings.enableMinimalChatUI);
      bp();
      alert("å¤–è§‚è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼");
      Kb("home-screen");
    });
    const C = document.getElementById("messages-view");
    C.addEventListener("scroll", () => {
      const {
        scrollTop: a,
        scrollHeight: b,
        clientHeight: c
      } = C;
      if (b - a - c < c && !ha) {
        $c();
      }
    });
    document.getElementById("save-api-settings-btn").addEventListener("click", async () => {
      const a = document.getElementById("proxy-url").value.trim();
      const b = document.getElementById("secondary-proxy-url").value.trim();
      const c = ["api521.pro", "api522.pro", "api520.pro"];
      if (c.some(c => a.includes(c) || b.includes(c))) {
        await Bb("ç¦æ­¢æ“ä½œ", "ç³»ç»Ÿæ£€æµ‹åˆ°æ‚¨ä½¿ç”¨äº†è¢«å°ç¦çš„ API åŸŸå (api520/api521)ã€‚\nè¯·æ›´æ¢å…¶ä»–æœåŠ¡å•†ã€‚");
        return;
      }
      v.apiConfig.proxyUrl = document.getElementById("proxy-url").value.trim();
      v.apiConfig.apiKey = document.getElementById("api-key").value.trim();
      v.apiConfig.model = document.getElementById("model-select").value;
      v.apiConfig.minimaxGroupId = document.getElementById("minimax-group-id").value.trim();
      v.apiConfig.minimaxApiKey = document.getElementById("minimax-api-key").value.trim();
      v.apiConfig.minimaxModel = document.getElementById("minimax-model-select").value;
      const d = document.getElementById("minimax-domain-select");
      if (d) {
        v.apiConfig.minimaxDomain = d.value;
        localStorage.setItem("minimax-domain", d.value);
      }
      localStorage.setItem("minimax-group-id", v.apiConfig.minimaxGroupId);
      localStorage.setItem("minimax-api-key", v.apiConfig.minimaxApiKey);
      localStorage.setItem("minimax-model", v.apiConfig.minimaxModel);
      v.apiConfig.secondaryProxyUrl = document.getElementById("secondary-proxy-url").value.trim();
      v.apiConfig.secondaryApiKey = document.getElementById("secondary-api-key").value.trim();
      v.apiConfig.secondaryModel = document.getElementById("secondary-model-select").value;
      const e = document.getElementById("imgbb-enable-switch").checked;
      const f = document.getElementById("imgbb-api-key").value.trim();
      const g = document.getElementById("catbox-enable-switch").checked;
      const h = document.getElementById("catbox-userhash").value.trim();
      v.apiConfig.imgbbEnable = e;
      v.apiConfig.imgbbApiKey = f;
      v.apiConfig.catboxEnable = g;
      v.apiConfig.catboxUserHash = h;
      localStorage.setItem("imgbb-enabled", e);
      localStorage.setItem("imgbb-api-key", f);
      localStorage.setItem("catbox-enabled", g);
      localStorage.setItem("catbox-userhash", h);
      const i = document.getElementById("github-enable-switch").checked;
      const j = document.getElementById("github-auto-backup-switch").checked;
      let k = parseInt(document.getElementById("github-backup-interval").value);
      if (isNaN(k) || k < 1) {
        k = 30;
      }
      v.apiConfig.githubEnable = i;
      v.apiConfig.githubAutoBackup = j;
      const l = document.getElementById("github-proxy-switch").checked;
      const m = document.getElementById("github-proxy-url").value.trim();
      v.apiConfig.githubProxyEnable = l;
      v.apiConfig.githubProxyUrl = m;
      localStorage.setItem("github-proxy-enabled", l);
      localStorage.setItem("github-proxy-url", m);
      v.apiConfig.githubUsername = document.getElementById("github-username").value.trim();
      v.apiConfig.githubRepo = document.getElementById("github-repo").value.trim();
      v.apiConfig.githubToken = document.getElementById("github-token").value.trim();
      v.apiConfig.githubFilename = document.getElementById("github-filename").value.trim() || "ephone_backup.json";
      localStorage.setItem("github-username", v.apiConfig.githubUsername);
      localStorage.setItem("github-repo", v.apiConfig.githubRepo);
      localStorage.setItem("github-token", v.apiConfig.githubToken);
      localStorage.setItem("github-filename", v.apiConfig.githubFilename);
      v.apiConfig.novelaiApiKey = document.getElementById("novelai-api-key").value.trim();
      v.apiConfig.novelaiModel = document.getElementById("novelai-model").value;
      v.apiConfig.novelaiEnabled = document.getElementById("novelai-switch").checked;
      v.apiConfig.githubBackupInterval = k;
      localStorage.setItem("github-enabled", i);
      localStorage.setItem("github-auto-backup", j);
      localStorage.setItem("github-backup-interval", k);
      if (i && j) {
        tp(k);
      } else {
        wp();
      }
      await Gb.apiConfig.put(v.apiConfig);
      const n = document.getElementById("background-activity-switch");
      const o = document.getElementById("background-interval-input");
      const p = document.getElementById("block-cooldown-input");
      v.globalSettings.enableBackgroundActivity = n.checked;
      v.globalSettings.backgroundActivityInterval = parseInt(o.value) || 60;
      v.globalSettings.blockCooldownHours = parseFloat(p.value) || 1;
      v.globalSettings.enableAiDrawing = document.getElementById("enable-ai-drawing-switch").checked;
      v.globalSettings.chatRenderWindow = parseInt(document.getElementById("chat-render-window-input").value) || 50;
      v.globalSettings.chatListRenderWindow = parseInt(document.getElementById("chat-list-render-window-input").value) || 30;
      v.globalSettings.apiTemperature = parseFloat(document.getElementById("api-temperature-slider").value);
      await Gb.globalSettings.put(v.globalSettings);
      Ve();
      if (v.globalSettings.enableBackgroundActivity) {
        Ue();
        console.log("åŽå°æ´»åŠ¨æ¨¡æ‹Ÿå·²å¯åŠ¨ï¼Œé—´éš”: " + v.globalSettings.backgroundActivityInterval + "ç§’");
      } else {
        console.log("åŽå°æ´»åŠ¨æ¨¡æ‹Ÿå·²åœæ­¢ã€‚");
      }
      const q = document.getElementById("novelai-switch").checked;
      const r = document.getElementById("novelai-model").value;
      const s = document.getElementById("novelai-api-key").value.trim();
      localStorage.setItem("novelai-enabled", q);
      localStorage.setItem("novelai-model", r);
      localStorage.setItem("novelai-api-key", s);
      alert("æ‰€æœ‰APIä¸ŽåŽå°è®¾ç½®å·²ä¿å­˜!");
    });
    const D = document.getElementById("api-key");
    D.addEventListener("focus", a => {
      a.target.setAttribute("type", "text");
    });
    D.addEventListener("blur", a => {
      a.target.setAttribute("type", "password");
    });
    async function E(a, b, c) {
      const d = document.getElementById(a).value.trim();
      const e = document.getElementById(b).value.trim();
      const f = ["api521.pro", "api520.pro"];
      if (f.some(a => d.includes(a))) {
        alert("æ— æ³•è¿žæŽ¥ï¼šè¯¥ API åŸŸåå·²è¢«ç³»ç»Ÿå±è”½ã€‚");
        return;
      }
      if (!d || !e) {
        return alert("è¯·å…ˆå¡«å†™å¯¹åº”çš„åä»£åœ°å€å’Œå¯†é’¥");
      }
      try {
        let a = d === y;
        const b = await fetch(a ? y + "?key=" + A(e) : d + "/v1/models", a ? undefined : {
          headers: {
            Authorization: "Bearer " + e
          }
        });
        if (!b.ok) {
          throw new Error("æ— æ³•èŽ·å–æ¨¡åž‹åˆ—è¡¨");
        }
        const f = await b.json();
        let g = a ? f.models.map(a => ({
          id: a.name.split("/")[1] || a.name
        })) : f.data;
        const h = document.getElementById(c);
        h.innerHTML = "";
        const i = c === "model-select" ? v.apiConfig.model : v.apiConfig.secondaryModel;
        g.forEach(a => {
          const b = document.createElement("option");
          b.value = a.id;
          b.textContent = a.id;
          if (a.id === i) {
            b.selected = true;
          }
          h.appendChild(b);
        });
        alert("æ¨¡åž‹åˆ—è¡¨å·²æ›´æ–°");
      } catch (a) {
        alert("æ‹‰å–æ¨¡åž‹å¤±è´¥: " + a.message);
      }
    }
    document.getElementById("fetch-models-btn").addEventListener("click", () => {
      E("proxy-url", "api-key", "model-select");
    });
    document.getElementById("fetch-secondary-models-btn").addEventListener("click", () => {
      E("secondary-proxy-url", "secondary-api-key", "secondary-model-select");
    });
    document.getElementById("add-world-book-btn").addEventListener("click", async () => {
      const a = await Db("åˆ›å»ºä¸–ç•Œä¹¦", "è¯·è¾“å…¥ä¹¦å");
      if (a && a.trim()) {
        const b = {
          id: "wb_" + Date.now(),
          name: a.trim(),
          content: ""
        };
        await Gb.worldBooks.add(b);
        v.worldBooks.push(b);
        hd();
        jd(b.id);
      }
    });
    document.getElementById("save-world-book-btn").addEventListener("click", async () => {
      if (!fa) {
        return;
      }
      const a = v.worldBooks.find(a => a.id === fa);
      if (!a) {
        return;
      }
      const b = document.getElementById("world-book-name-input").value.trim();
      if (!b) {
        alert("ä¹¦åä¸èƒ½ä¸ºç©ºï¼");
        return;
      }
      a.name = b;
      const c = document.getElementById("world-book-category-select").value;
      a.categoryId = c ? parseInt(c) : null;
      const d = document.getElementById("world-book-entries-container");
      const e = d.querySelectorAll(".message-editor-block");
      const f = [];
      e.forEach(a => {
        const b = a.querySelector(".entry-keys-input").value.trim();
        const c = a.querySelector(".entry-content-textarea").value.trim();
        const d = a.querySelector(".entry-enabled-switch").checked;
        if (c) {
          f.push({
            comment: a.querySelector(".entry-comment-input").value.trim(),
            keys: b ? b.split(",").map(a => a.trim()).filter(a => a) : [],
            content: c,
            enabled: d
          });
        }
      });
      a.content = f;
      await Gb.worldBooks.put(a);
      document.getElementById("world-book-editor-title").textContent = b;
      fa = null;
      Kb("world-book-screen");
      await hd();
    });
    document.getElementById("chat-messages").addEventListener("click", async a => {
      if (a.target.tagName === "IMG") {
        if (a.target.classList.contains("chat-image") || a.target.classList.contains("realimag-image") || a.target.classList.contains("naiimag-image")) {
          a.stopPropagation();
          if (a.detail > 1) {
            if (window.simpleZoomTimer) {
              clearTimeout(window.simpleZoomTimer);
              window.simpleZoomTimer = null;
            }
            return;
          }
          window.simpleZoomTimer = // TOLOOK
          setTimeout(() => {
            sr(a.target.src);
            window.simpleZoomTimer = null;
          }, 250);
          return;
        }
      }
      const b = a.target.closest(".nai-save-local-btn");
      if (b) {
        a.stopPropagation();
        b.classList.add("loading");
        b.disabled = true;
        const c = b.closest(".message-bubble");
        const d = c ? c.querySelector("img.chat-image, img.realimag-image, img.naiimag-image") : null;
        if (d && d.src) {
          addVisualFeedback(d);
          const a = generateFilename(d);
          downloadImage(d.src, a);
        }
        // TOLOOK
        setTimeout(() => {
          b.classList.remove("loading");
          b.disabled = false;
        }, 800);
        return;
      }
      const c = a.target.closest(".nai-upload-imgbb-btn");
      if (c) {
        a.stopPropagation();
        const b = a.target.closest(".message-bubble");
        if (b) {
          const a = parseInt(b.dataset.timestamp);
          if (!isNaN(a)) {
            await Cj(a, c);
          }
        }
        return;
      }
      const d = a.target.closest(".nai-regenerate-btn");
      if (d) {
        a.stopPropagation();
        const b = a.target.closest(".message-bubble");
        if (b) {
          const a = parseInt(b.dataset.timestamp);
          if (!isNaN(a)) {
            await Aj(a, d);
          }
        }
        return;
      }
      const e = a.target.closest(".user-upload-imgbb-btn");
      if (e) {
        a.stopPropagation();
        const b = a.target.closest(".message-bubble");
        if (b) {
          const a = parseInt(b.dataset.timestamp);
          if (!isNaN(a)) {
            await Bj(a, e);
          }
        }
        return;
      }
      const f = a.target.closest(".voice-message-body[data-text]");
      if (f) {
        const a = v.chats[v.activeChatId];
        if (!a) {
          return;
        }
        ao(f);
        const b = f.closest(".message-bubble");
        const c = b ? b.querySelector(".voice-transcript") : null;
        if (f.dataset.voiceId && c && c.style.display === "block") {
          if (a.isGroup) {
            console.log("è¿™æ˜¯ä¸€æ¡ç¾¤èŠè¯­éŸ³æ¶ˆæ¯ï¼Œå·²ç¦æ­¢å‘èµ·TTSè¯·æ±‚ã€‚");
            return;
          }
          if (a.settings.enableTts === false) {
            console.log("â€œ" + a.name + "â€çš„TTSåŠŸèƒ½å·²å…³é—­ï¼Œå·²ç¦æ­¢å‘èµ·TTSè¯·æ±‚ã€‚");
            return;
          }
          $n(f);
        }
        return;
      }
      const g = a.target.closest(".waimai-details-btn");
      if (g) {
        const a = g.closest(".message-bubble");
        if (a) {
          const b = parseInt(a.dataset.timestamp);
          if (!isNaN(b)) {
            Lf(b);
            return;
          }
        }
      }
      const h = a.target.closest(".waimai-user-actions button");
      if (h) {
        const a = h.closest(".message-bubble");
        if (a) {
          const b = parseInt(a.dataset.timestamp);
          const c = h.dataset.choice;
          if (!isNaN(b) && c) {
            await Mf(b, c);
            return;
          }
        }
      }
      const i = a.target.closest(".post-deleted-placeholder");
      if (i) {
        const a = parseInt(i.dataset.postId);
        if (!isNaN(a)) {
          const b = await Gb.qzonePosts.get(a);
          if (b) {
            let a = "";
            const c = b.authorId === "user" ? v.qzoneSettings.nickname : v.chats[b.authorId]?.name || "æœªçŸ¥ä½œè€…";
            if (b.type === "shuoshuo") {
              a = b.content;
            } else {
              a = b.publicText || "";
              if (b.imageUrl) {
                a += "\n[å›¾ç‰‡]";
              }
              if (b.hiddenContent) {
                a += "\n[æ–‡å­—å›¾å†…å®¹: " + b.hiddenContent + "]";
              }
            }
            Bb("æ¥è‡ª " + c + " çš„å·²åˆ é™¤åŠ¨æ€", a.replace(/\n/g, "<br>"));
          } else {
            Bb("æç¤º", "è¿™æ¡åŠ¨æ€çš„åŽŸå§‹æ•°æ®å·²è¢«å½»åº•æ¸…é™¤ã€‚");
          }
        }
        return;
      }
      const j = a.target.closest(".ai-generated-image");
      if (j) {
        const a = j.dataset.description;
        if (a) {
          Bb("ç…§ç‰‡æè¿°", a);
        }
        return;
      }
      const k = a.target.closest(".quoted-message");
      if (k && k.dataset.originalTimestamp) {
        const a = parseInt(k.dataset.originalTimestamp);
        if (!isNaN(a)) {
          Md(a);
        }
      }
      const l = a.target.closest(".gift-card");
      if (l) {
        const a = l.closest(".message-bubble");
        if (a) {
          fj(parseInt(a.dataset.timestamp));
        }
      }
      const m = a.target.closest(".red-packet-card");
      if (m) {
        const a = m.closest(".message-bubble");
        if (a && a.dataset.timestamp) {
          const b = parseInt(a.dataset.timestamp);
          vg(b);
        }
      }
      const n = a.target.closest(".poll-card");
      if (n) {
        const b = parseInt(n.dataset.pollTimestamp);
        if (isNaN(b)) {
          return;
        }
        const c = a.target.closest(".poll-option-item");
        if (c && !n.classList.contains("closed")) {
          Bg(b, c.dataset.option);
          return;
        }
        const d = a.target.closest(".poll-action-btn");
        if (d) {
          if (n.classList.contains("closed")) {
            Dg(b);
          } else {
            Cg(b);
          }
          return;
        }
        if (n.classList.contains("closed")) {
          Dg(b);
        }
      }
      const o = a.target.closest(".recalled-message-placeholder");
      if (o) {
        const a = v.chats[v.activeChatId];
        const b = o.closest(".message-wrapper");
        if (a && b) {
          const c = parseInt(b.dataset.timestamp);
          const d = a.history.find(a => a.timestamp === c);
          if (d && d.recalledData) {
            let a = "";
            const b = d.recalledData;
            if (b.originalType === "text") {
              a = "åŽŸæ–‡: \"" + b.originalContent + "\"";
            } else {
              a = "æ’¤å›žäº†ä¸€æ¡[" + b.originalType + "]ç±»åž‹çš„æ¶ˆæ¯";
            }
            Bb("å·²æ’¤å›žçš„æ¶ˆæ¯", a);
          }
        }
      }
      const p = a.target.closest(".link-share-card");
      if (p && p.closest(".message-bubble.is-link-share")) {
        const a = parseInt(p.dataset.timestamp);
        db(a);
      }
      const q = a.target.closest(".message-bubble");
      if (q && q.classList.contains("ai") && q.classList.contains("is-transfer") && q.dataset.status === "pending") {
        const a = parseInt(q.dataset.timestamp);
        if (!isNaN(a)) {
          Ah(a);
        }
      }
    });
    const F = document.getElementById("chat-settings-modal");
    const G = document.querySelector(".custom-multiselect .select-box");
    const H = document.getElementById("world-book-checkboxes-container");
    function J() {
      const a = H.querySelectorAll("input:checked");
      const b = document.querySelector(".selected-options-text");
      if (a.length === 0) {
        b.textContent = "-- ç‚¹å‡»é€‰æ‹© --";
      } else if (a.length > 2) {
        b.textContent = "å·²é€‰æ‹© " + a.length + " æœ¬ä¸–ç•Œä¹¦";
      } else {
        const c = Array.from(a).map(a => {
          return a.parentElement.textContent.trim();
        });
        b.textContent = c.join(", ");
      }
    }
    G.addEventListener("click", a => {
      a.stopPropagation();
      H.classList.toggle("visible");
      G.classList.toggle("expanded");
    });
    document.getElementById("world-book-checkboxes-container").addEventListener("change", J);
    window.addEventListener("click", a => {
      if (!document.querySelector(".custom-multiselect").contains(a.target)) {
        H.classList.remove("visible");
        G.classList.remove("expanded");
      }
    });
    document.getElementById("chat-settings-btn").addEventListener("click", async () => {
      vk();
      if (!v.activeChatId) {
        return;
      }
      const a = v.chats[v.activeChatId];
      const b = a.isGroup;
      const c = document.getElementById("switch-greeting-group");
      if (!b && a.settings.alternateGreetings && a.settings.alternateGreetings.length > 0) {
        c.style.display = "block";
      } else {
        c.style.display = "none";
      }
      document.getElementById("chat-name-group").style.display = "block";
      document.getElementById("my-persona-group").style.display = "block";
      document.getElementById("my-avatar-group").style.display = "block";
      document.getElementById("my-group-nickname-group").style.display = b ? "block" : "none";
      document.getElementById("my-nickname-group").style.display = b ? "none" : "block";
      document.getElementById("group-avatar-group").style.display = b ? "block" : "none";
      document.getElementById("group-members-group").style.display = b ? "block" : "none";
      document.getElementById("ai-persona-group").style.display = b ? "none" : "block";
      document.getElementById("ai-avatar-group").style.display = b ? "none" : "block";
      document.getElementById("assign-group-section").style.display = b ? "none" : "block";
      document.getElementById("ai-original-name-group").style.display = b ? "none" : "block";
      document.getElementById("ai-voice-id-group").style.display = b ? "none" : "block";
      document.getElementById("inject-thought-group").style.display = b ? "none" : "block";
      document.getElementById("todo-list-setting-group").style.display = b ? "none" : "flex";
      document.getElementById("offline-mode-group").style.display = b ? "none" : "block";
      document.getElementById("ai-cooldown-group").style.display = b ? "none" : "block";
      document.getElementById("group-cooldown-group").style.display = b ? "block" : "none";
      document.getElementById("chat-name-input").value = a.name;
      document.getElementById("my-persona").value = a.settings.myPersona;
      document.getElementById("my-avatar-preview").src = a.settings.myAvatar || (b ? Oa : Na);
      document.getElementById("max-memory").value = a.settings.maxMemory;
      document.getElementById("linked-memory-count").value = a.settings.linkedMemoryCount || 10;
      const d = document.getElementById("bg-preview");
      const e = document.getElementById("remove-bg-btn");
      if (a.settings.background) {
        d.src = a.settings.background;
        d.style.display = "block";
        e.style.display = "inline-block";
      } else {
        d.style.display = "none";
        e.style.display = "none";
      }
      document.getElementById("lyrics-position-group").style.display = "block";
      document.getElementById("single-char-background-activity-group").style.display = b ? "none" : "block";
      document.getElementById("group-background-activity-group").style.display = b ? "block" : "none";
      const f = document.getElementById("time-perception-toggle");
      const g = document.getElementById("time-zone-group");
      f.checked = a.settings.enableTimePerception;
      g.style.display = f.checked ? "block" : "none";
      const h = document.getElementById("time-zone-select");
      const i = Intl.supportedValuesOf("timeZone");
      h.innerHTML = "";
      i.forEach(a => {
        const b = document.createElement("option");
        b.value = a;
        b.textContent = a;
        h.appendChild(b);
      });
      h.value = a.settings.timeZone || "Asia/Shanghai";
      document.getElementById("enable-synth-music-switch").checked = a.settings.enableSynthMusic || false;
      document.getElementById("narrator-mode-toggle").checked = a.settings.enableNarratorMode || false;
      if (b) {
        document.getElementById("group-background-activity-switch").checked = a.settings.enableBackgroundActivity;
        document.getElementById("my-group-nickname-input").value = a.settings.myNickname || "";
        document.getElementById("group-avatar-preview").src = a.settings.groupAvatar || Qa;
        document.getElementById("group-action-cooldown-input").value = a.settings.actionCooldownMinutes || 10;
        document.getElementById("single-char-background-activity-group").style.display = "none";
        N(a.members);
      } else {
        document.getElementById("single-char-background-activity-group").style.display = "block";
        document.getElementById("enable-todo-list-switch").checked = a.settings.enableTodoList || false;
        document.getElementById("char-background-activity-switch").checked = a.settings.enableBackgroundActivity;
        document.getElementById("inject-thought-toggle").checked = a.settings.injectLatestThought;
        const c = document.getElementById("offline-mode-toggle");
        const d = document.getElementById("offline-mode-options");
        const e = document.getElementById("offline-min-length-input");
        const f = document.getElementById("offline-max-length-input");
        c.checked = a.settings.isOfflineMode || false;
        d.style.display = c.checked ? "block" : "none";
        e.value = a.settings.offlineMinLength || 100;
        f.value = a.settings.offlineMaxLength || 300;
        await rm(a);
        document.getElementById("ai-original-name-input").value = a.originalName;
        document.getElementById("ai-voice-id-input").value = a.settings.minimaxVoiceId || "";
        document.getElementById("ai-voice-lang-group").style.display = b ? "none" : "block";
        document.getElementById("ai-voice-lang-select").value = a.settings.ttsLanguage || "";
        document.getElementById("enable-tts-switch").checked = a.settings.enableTts !== false;
        document.getElementById("ai-persona").value = a.settings.aiPersona;
        document.getElementById("ai-avatar-preview").src = a.settings.aiAvatar || Na;
        document.getElementById("my-nickname-input").value = a.settings.myNickname || "æˆ‘";
        document.getElementById("ai-action-cooldown-input").value = a.settings.actionCooldownMinutes || 10;
        const g = document.getElementById("assign-group-select");
        g.innerHTML = "<option value=\"\">æœªåˆ†ç»„</option>";
        const h = await Gb.qzoneGroups.toArray();
        h.forEach(b => {
          const c = document.createElement("option");
          c.value = b.id;
          c.textContent = b.name;
          if (a.groupId === b.id) {
            c.selected = true;
          }
          g.appendChild(c);
        });
        const i = a.settings.lyricsPosition || {
          vertical: "top",
          horizontal: "center",
          offset: 10
        };
        document.getElementById("lyrics-vertical-pos").value = i.vertical;
        document.getElementById("lyrics-horizontal-pos").value = i.horizontal;
        document.getElementById("lyrics-offset-input").value = i.offset;
      }
      const j = document.getElementById("world-book-checkboxes-container");
      j.innerHTML = "";
      const [k, l] = await Promise.all([Gb.worldBookCategories.toArray(), Gb.worldBooks.toArray()]);
      const m = new Set(a.settings.linkedWorldBookIds || []);
      if (l.length === 0) {
        j.innerHTML = "<p style=\"text-align:center; color: #8a8a8a;\">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ä¸–ç•Œä¹¦</p>";
      } else {
        k.forEach(a => {
          const b = l.filter(b => b.categoryId === a.id);
          if (b.length > 0) {
            const c = document.createElement("h4");
            c.textContent = a.name;
            c.style.cssText = "margin: 10px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;";
            j.appendChild(c);
            b.forEach(a => {
              const b = m.has(a.id);
              const c = document.createElement("label");
              c.innerHTML = "<input type=\"checkbox\" value=\"book_" + a.id + "\" " + (b ? "checked" : "") + "> " + a.name;
              j.appendChild(c);
            });
          }
        });
        const a = l.filter(a => !a.categoryId);
        if (a.length > 0) {
          const b = document.createElement("h4");
          b.textContent = "æœªåˆ†ç±»";
          b.style.cssText = "margin: 15px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;";
          j.appendChild(b);
          a.forEach(a => {
            const b = m.has(a.id);
            const c = document.createElement("label");
            c.innerHTML = "<input type=\"checkbox\" value=\"book_" + a.id + "\" " + (b ? "checked" : "") + "> " + a.name;
            j.appendChild(c);
          });
        }
      }
      J();
      const n = document.getElementById("link-memory-toggle");
      const o = document.getElementById("linked-memory-selection");
      const p = document.getElementById("linked-chats-checkboxes-container");
      const q = a.settings.linkedMemoryChatIds || [];
      n.checked = q.length > 0;
      o.style.display = n.checked ? "block" : "none";
      p.innerHTML = "";
      Object.values(v.chats).forEach(b => {
        if (b.id === a.id) {
          return;
        }
        const c = q.includes(b.id);
        const d = b.isGroup ? "[ç¾¤èŠ]" : "[ç§èŠ]";
        const e = document.createElement("label");
        e.innerHTML = "<input type=\"checkbox\" value=\"" + b.id + "\" " + (c ? "checked" : "") + "> " + d + " " + b.name;
        p.appendChild(e);
      });
      function r() {
        const a = p.querySelectorAll("input:checked");
        const b = o.querySelector(".selected-options-text");
        if (a.length === 0) {
          b.textContent = "-- ç‚¹å‡»é€‰æ‹© --";
        } else if (a.length > 2) {
          b.textContent = "å·²é€‰æ‹© " + a.length + " é¡¹";
        } else {
          b.textContent = Array.from(a).map(a => a.parentElement.textContent.trim()).join(", ");
        }
      }
      r();
      n.addEventListener("change", () => {
        o.style.display = n.checked ? "block" : "none";
      });
      const s = o.querySelector(".select-box");
      const t = s.cloneNode(true);
      s.parentNode.replaceChild(t, s);
      t.addEventListener("click", a => {
        a.stopPropagation();
        p.classList.toggle("visible");
        t.classList.toggle("expanded");
      });
      p.addEventListener("change", r);
      const u = document.querySelector("input[name=\"theme-select\"][value=\"" + (a.settings.theme || "default") + "\"]");
      if (u) {
        u.checked = true;
      }
      const w = document.getElementById("font-size-slider");
      w.value = a.settings.fontSize || 13;
      document.getElementById("font-size-value").textContent = w.value + "px";
      const x = document.getElementById("custom-css-input");
      x.value = a.settings.customCss || "";
      _e();
      document.getElementById("auto-memory-toggle").checked = a.settings.enableAutoMemory || false;
      document.getElementById("auto-memory-interval").value = a.settings.autoMemoryInterval || 20;
      document.getElementById("show-hidden-msg-toggle").checked = a.settings.showHiddenMessages || false;
      // TOLOOK
      setTimeout(() => {
        wo();
        const a = ["ai-persona", "my-persona", "max-memory", "linked-memory-count", "auto-memory-toggle", "auto-memory-interval", "offline-mode-toggle", "offline-min-length-input", "offline-max-length-input", "offline-preset-select"];
        a.forEach(a => {
          const b = document.getElementById(a);
          if (b) {
            b.addEventListener("input", wo);
          }
        });
        document.getElementById("world-book-checkboxes-container").addEventListener("change", wo);
        document.getElementById("linked-chats-checkboxes-container").addEventListener("change", wo);
        document.getElementById("link-memory-toggle").addEventListener("change", wo);
      }, 100);
      Kb("chat-settings-screen");
    });
    function N(a) {
      const b = document.getElementById("group-members-settings");
      b.innerHTML = "";
      a.forEach(a => {
        const c = document.createElement("div");
        c.className = "member-editor";
        c.dataset.memberId = a.id;
        const d = a.avatar || (v.chats[a.id] ? v.chats[a.id].settings.aiAvatar : Pa);
        c.innerHTML = "<img src=\"" + d + "\" alt=\"" + a.groupNickname + "\"><div class=\"member-name\">" + a.groupNickname + "</div>";
        c.addEventListener("click", () => P(a.id));
        b.appendChild(c);
      });
    }
    document.getElementById("save-member-settings-btn").addEventListener("click", async () => {
      if (!da) {
        return;
      }
      const a = v.chats[v.activeChatId];
      const b = a.members.find(a => a.id === da);
      if (!b) {
        return;
      }
      const c = document.getElementById("member-name-input").value.trim();
      if (!c) {
        alert("ç¾¤æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼");
        return;
      }
      b.groupNickname = c;
      b.persona = document.getElementById("member-persona-input").value;
      const d = document.getElementById("member-avatar-preview").src;
      b.avatar = d;
      const e = v.chats[b.id];
      if (e) {
        e.settings.aiAvatar = d;
        await Gb.chats.put(e);
      }
      await Gb.chats.put(a);
      N(a.members);
      document.getElementById("member-settings-modal").classList.remove("visible");
      da = null;
    });
    function P(a) {
      da = a;
      const b = v.chats[v.activeChatId];
      const c = b.members.find(b => b.id === a);
      if (!c) {
        return;
      }
      document.getElementById("member-name-input").value = c.groupNickname;
      document.getElementById("member-persona-input").value = c.persona;
      const d = c.avatar || (v.chats[c.id] ? v.chats[c.id].settings.aiAvatar : Pa);
      document.getElementById("member-avatar-preview").src = d;
      document.getElementById("member-settings-modal").classList.add("visible");
    }
    document.getElementById("cancel-member-settings-btn").addEventListener("click", () => {
      document.getElementById("member-settings-modal").classList.remove("visible");
      da = null;
    });
    document.getElementById("save-member-settings-btn").addEventListener("click", async () => {
      if (!da) {
        return;
      }
      const a = v.chats[v.activeChatId];
      const b = a.members.find(a => a.id === da);
      if (!b) {
        return;
      }
      const c = document.getElementById("member-name-input").value.trim();
      if (!c) {
        alert("ç¾¤æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼");
        return;
      }
      b.groupNickname = c;
      b.persona = document.getElementById("member-persona-input").value;
      const d = document.getElementById("member-avatar-preview").src;
      b.avatar = d;
      const e = v.chats[b.id];
      if (e) {
        e.settings.aiAvatar = d;
        await Gb.chats.put(e);
      }
      await Gb.chats.put(a);
      N(a.members);
      document.getElementById("member-settings-modal").classList.remove("visible");
      da = null;
    });
    document.getElementById("reset-theme-btn").addEventListener("click", () => {
      document.getElementById("theme-default").checked = true;
    });
    document.getElementById("save-chat-settings-btn").addEventListener("click", async () => {
      if (!v.activeChatId) {
        return;
      }
      const a = v.chats[v.activeChatId];
      const b = a.settings.isOfflineMode || false;
      const c = document.getElementById("chat-name-input").value.trim();
      if (!c) {
        return alert("å¤‡æ³¨å/ç¾¤åä¸èƒ½ä¸ºç©ºï¼");
      }
      if (!a.isGroup && c !== a.name) {
        if (!a.nameHistory) {
          a.nameHistory = [];
        }
        if (!a.nameHistory.includes(a.name)) {
          a.nameHistory.push(a.name);
        }
      }
      a.name = c;
      const d = document.querySelector("input[name=\"theme-select\"]:checked");
      a.settings.theme = d ? d.value : "default";
      a.settings.fontSize = parseInt(document.getElementById("font-size-slider").value);
      a.settings.customCss = document.getElementById("custom-css-input").value.trim();
      a.settings.myPersona = document.getElementById("my-persona").value;
      a.settings.myAvatar = document.getElementById("my-avatar-preview").src;
      a.settings.maxMemory = parseInt(document.getElementById("max-memory").value) || 10;
      a.settings.linkedMemoryCount = parseInt(document.getElementById("linked-memory-count").value) || 10;
      const e = document.querySelectorAll("#world-book-checkboxes-container input[type=\"checkbox\"]:checked");
      const f = [];
      e.forEach(a => {
        if (a.value.startsWith("book_")) {
          f.push(a.value.replace("book_", ""));
        }
      });
      a.settings.linkedWorldBookIds = f;
      const g = document.getElementById("link-memory-toggle").checked;
      if (g) {
        const b = document.querySelectorAll("#linked-chats-checkboxes-container input:checked");
        a.settings.linkedMemoryChatIds = Array.from(b).map(a => a.value);
      } else {
        a.settings.linkedMemoryChatIds = [];
      }
      a.settings.enableAutoMemory = document.getElementById("auto-memory-toggle").checked;
      a.settings.autoMemoryInterval = parseInt(document.getElementById("auto-memory-interval").value) || 20;
      a.settings.showHiddenMessages = document.getElementById("show-hidden-msg-toggle").checked;
      a.settings.enableTimePerception = document.getElementById("time-perception-toggle").checked;
      a.settings.timeZone = document.getElementById("time-zone-select").value;
      a.settings.lyricsPosition = {
        vertical: document.getElementById("lyrics-vertical-pos").value,
        horizontal: document.getElementById("lyrics-horizontal-pos").value,
        offset: parseInt(document.getElementById("lyrics-offset-input").value) || 10
      };
      a.settings.enableSynthMusic = document.getElementById("enable-synth-music-switch").checked;
      a.settings.enableNarratorMode = document.getElementById("narrator-mode-toggle").checked;
      if (a.isGroup) {
        a.settings.enableBackgroundActivity = document.getElementById("group-background-activity-switch").checked;
        a.settings.myNickname = document.getElementById("my-group-nickname-input").value.trim();
        a.settings.groupAvatar = document.getElementById("group-avatar-preview").src;
        a.settings.actionCooldownMinutes = parseInt(document.getElementById("group-action-cooldown-input").value) || 10;
      } else {
        a.settings.enableBackgroundActivity = document.getElementById("char-background-activity-switch").checked;
        a.settings.enableTodoList = document.getElementById("enable-todo-list-switch").checked;
        const c = document.getElementById("offline-mode-toggle").checked;
        a.settings.isOfflineMode = c;
        if (b === true && c === false) {
          const b = {
            role: "system",
            content: "[ç³»ç»ŸæŒ‡ä»¤ï¼šæ¨¡å¼å·²åˆ‡æ¢ï¼ä½ çŽ°åœ¨å›žåˆ°äº†çº¿ä¸ŠèŠå¤©æ¨¡å¼ã€‚ä½ çš„å›žå¤ã€å¿…é¡»ã€‘ä¸¥æ ¼éµå®ˆçº¿ä¸Šæ¨¡å¼çš„JSONæ•°ç»„æ ¼å¼ï¼Œä¾‹å¦‚ [{\"type\": \"text\", \"content\": \"ä½ å¥½\"}]]",
            timestamp: Date.now(),
            isHidden: true
          };
          a.history.push(b);
          console.log("å·²æˆåŠŸæ³¨å…¥â€œåˆ‡æ¢åˆ°çº¿ä¸Šæ¨¡å¼â€çš„ç³»ç»ŸæŒ‡ä»¤ã€‚");
        }
        a.settings.injectLatestThought = document.getElementById("inject-thought-toggle").checked;
        a.settings.offlineMinLength = parseInt(document.getElementById("offline-min-length-input").value) || 100;
        a.settings.offlineMaxLength = parseInt(document.getElementById("offline-max-length-input").value) || 300;
        a.settings.offlinePresetId = document.getElementById("offline-preset-select").value || null;
        const d = document.getElementById("ai-original-name-input").value.trim();
        if (!d) {
          return alert("å¯¹æ–¹æœ¬åä¸èƒ½ä¸ºç©ºï¼");
        }
        a.originalName = d;
        a.settings.aiPersona = document.getElementById("ai-persona").value;
        a.settings.minimaxVoiceId = document.getElementById("ai-voice-id-input").value.trim();
        a.settings.ttsLanguage = document.getElementById("ai-voice-lang-select").value;
        a.settings.enableTts = document.getElementById("enable-tts-switch").checked;
        a.settings.aiAvatar = document.getElementById("ai-avatar-preview").src;
        a.settings.myNickname = document.getElementById("my-nickname-input").value.trim() || "æˆ‘";
        a.settings.actionCooldownMinutes = parseInt(document.getElementById("ai-action-cooldown-input").value) || 10;
        const e = document.getElementById("assign-group-select").value;
        a.groupId = e ? parseInt(e) : null;
      }
      await Gb.chats.put(a);
      if (!a.isGroup) {
        await qb(a);
        await rb(a);
      }
      mb(a);
      $e(a.settings.customCss, "#chat-messages", "custom-bubble-style");
      Kb("chat-interface-screen");
      cd(v.activeChatId);
      _c();
    });
    document.getElementById("chat-settings-screen").addEventListener("click", a => {
      if (a.target.classList.contains("change-frame-btn")) {
        hi("chat");
      }
    });
    document.getElementById("member-settings-modal").addEventListener("click", a => {
      if (a.target.classList.contains("change-frame-btn")) {
        hi("member");
      }
    });
    const U = document.getElementById("avatar-frame-modal");
    const V = document.getElementById("ai-frame-tab");
    const X = document.getElementById("my-frame-tab");
    const Y = document.getElementById("ai-frame-content");
    const Z = document.getElementById("my-frame-content");
    document.getElementById("save-frame-settings-btn").addEventListener("click", ki);
    document.getElementById("cancel-frame-settings-btn").addEventListener("click", () => {
      U.classList.remove("visible");
      fi = false;
    });
    V.addEventListener("click", () => {
      V.classList.add("active");
      X.classList.remove("active");
      Y.style.display = "block";
      Z.style.display = "none";
    });
    X.addEventListener("click", () => {
      X.classList.add("active");
      V.classList.remove("active");
      Z.style.display = "block";
      Y.style.display = "none";
    });
    document.getElementById("clear-chat-btn").addEventListener("click", async () => {
      if (!v.activeChatId) {
        return;
      }
      const a = v.chats[v.activeChatId];
      const b = await wb("æ¸…ç©ºèŠå¤©è®°å½•", "æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ­¤èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œæ— æ³•æ¢å¤ã€‚ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ", {
        confirmButtonClass: "btn-danger"
      });
      if (b) {
        a.history = [];
        a.heartfeltVoice = "...";
        a.randomJottings = "...";
        await Gb.chats.put(a);
        cd(v.activeChatId);
        _c();
        F.classList.remove("visible");
      }
    });
    const ea = (a, b) => {
      document.getElementById(a).addEventListener("change", async a => {
        const c = a.target.files[0];
        if (c) {
          const d = await new Promise((a, b) => {
            const d = new FileReader();
            d.onload = () => a(d.result);
            d.onerror = () => b(d.error);
            d.readAsDataURL(c);
          });
          b(d);
          a.target.value = null;
        }
      });
    };
    ea("ai-avatar-input", a => document.getElementById("ai-avatar-preview").src = a);
    ea("my-avatar-input", a => document.getElementById("my-avatar-preview").src = a);
    ea("group-avatar-input", a => document.getElementById("group-avatar-preview").src = a);
    ea("member-avatar-input", a => document.getElementById("member-avatar-preview").src = a);
    ea("bg-input", async a => {
      if (v.activeChatId) {
        const b = v.chats[v.activeChatId];
        b.settings.background = a;
        const c = document.getElementById("bg-preview");
        c.src = a;
        c.style.display = "block";
        document.getElementById("remove-bg-btn").style.display = "inline-block";
        await Bb("æˆåŠŸ", `èŠå¤©èƒŒæ™¯å·²æ›´æ–°ï¼

å›¾ç‰‡å°†åœ¨åŽå°é™é»˜ä¸Šä¼ åˆ°å›¾åºŠ... (ä¿å­˜è®¾ç½®åŽç”Ÿæ•ˆ)`);
        (async () => {
          await K(Gb.chats, b.id, "settings.background", a);
        })();
      }
    });
    ea("preset-avatar-input", a => document.getElementById("preset-avatar-preview").src = a);
    document.getElementById("remove-bg-btn").addEventListener("click", () => {
      if (v.activeChatId) {
        v.chats[v.activeChatId].settings.background = "";
        const a = document.getElementById("bg-preview");
        a.src = "";
        a.style.display = "none";
        document.getElementById("remove-bg-btn").style.display = "none";
      }
    });
    const ga = document.getElementById("sticker-panel");
    document.getElementById("open-sticker-panel-btn").addEventListener("click", () => {
      const a = v.chats[v.activeChatId];
      if (a && a.settings.stickerCategoryId) {
        ba = a.settings.stickerCategoryId;
      } else {
        ba = "all";
      }
      kd();
      ga.classList.add("visible");
    });
    document.getElementById("close-sticker-panel-btn").addEventListener("click", () => ga.classList.remove("visible"));
    document.getElementById("add-sticker-batch-btn").addEventListener("click", Id);
    document.getElementById("upload-sticker-btn").addEventListener("click", () => document.getElementById("sticker-upload-input").click());
    document.getElementById("sticker-upload-input").addEventListener("change", async a => {
      const b = a.target.files[0];
      if (!b) {
        return;
      }
      const c = new FileReader();
      c.readAsDataURL(b);
      c.onload = async () => {
        let a = c.result;
        const b = await Db("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¥½è€¶ã€ç–‘æƒ‘)");
        if (b && b.trim()) {
          const c = b.trim();
          const d = {
            id: "sticker_" + Date.now() + Math.random(),
            url: a,
            name: c,
            categoryId: ba !== "all" && ba !== "uncategorized" ? ba : null
          };
          const e = await Gb.userStickers.add(d);
          d.id = e;
          v.userStickers.push(d);
          kd();
          await Bb("æ·»åŠ æˆåŠŸï¼", "è¡¨æƒ…â€œ" + c + `â€å·²æ·»åŠ ã€‚

å›¾ç‰‡å°†åœ¨åŽå°é™é»˜ä¸Šä¼ åˆ°å›¾åºŠ...`);
          (async () => {
            await K(Gb.userStickers, e, "url", a);
          })();
        } else if (b !== null) {
          alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼");
        }
      };
      a.target.value = null;
    });
    document.getElementById("upload-image-btn").addEventListener("click", () => document.getElementById("image-upload-input").click());
    document.getElementById("image-upload-input").addEventListener("change", async a => {
      const b = a.target.files[0];
      if (!b || !v.activeChatId) {
        return;
      }
      const c = new FileReader();
      c.onload = async a => {
        const b = a.target.result;
        const c = v.chats[v.activeChatId];
        const d = {
          role: "user",
          content: [{
            type: "image_url",
            image_url: {
              url: b
            }
          }],
          timestamp: Date.now()
        };
        c.history.push(d);
        await Gb.chats.put(c);
        Pd(d, c);
        _c();
      };
      c.readAsDataURL(b);
      a.target.value = null;
    });
    document.getElementById("voice-message-btn").addEventListener("click", async () => {
      if (!v.activeChatId) {
        return;
      }
      const a = await Db("å‘é€è¯­éŸ³", "è¯·è¾“å…¥ä½ æƒ³è¯´çš„å†…å®¹ï¼š");
      if (a && a.trim()) {
        const b = v.chats[v.activeChatId];
        const c = {
          role: "user",
          type: "voice_message",
          content: a.trim(),
          timestamp: Date.now()
        };
        b.history.push(c);
        await Gb.chats.put(b);
        Pd(c, b);
        _c();
      }
    });
    document.getElementById("send-photo-btn").addEventListener("click", async () => {
      if (!v.activeChatId) {
        return;
      }
      const a = await Db("å‘é€ç…§ç‰‡", "è¯·ç”¨æ–‡å­—æè¿°æ‚¨è¦å‘é€çš„ç…§ç‰‡ï¼š");
      if (a && a.trim()) {
        const b = v.chats[v.activeChatId];
        const c = {
          role: "user",
          type: "user_photo",
          content: a.trim(),
          timestamp: Date.now()
        };
        b.history.push(c);
        await Gb.chats.put(b);
        Pd(c, b);
        _c();
      }
    });
    const la = document.getElementById("waimai-request-modal");
    document.getElementById("send-waimai-request-btn").addEventListener("click", () => {
      la.classList.add("visible");
    });
    la.addEventListener("click", a => {
      if (a.target === la) {
        la.classList.remove("visible");
      }
    });
    document.getElementById("waimai-order-for-ai-btn").addEventListener("click", Wd);
    document.getElementById("waimai-confirm-btn").addEventListener("click", async () => {
      if (!v.activeChatId) {
        return;
      }
      const a = document.getElementById("waimai-product-info");
      const b = document.getElementById("waimai-amount");
      const c = a.value.trim();
      const d = parseFloat(b.value);
      if (!c || isNaN(d) || d <= 0) {
        alert("è¯·å¡«å†™æœ‰æ•ˆçš„å•†å“ä¿¡æ¯å’Œé‡‘é¢ï¼");
        return;
      }
      const e = v.chats[v.activeChatId];
      const f = Date.now();
      const g = e.isGroup ? e.settings.myNickname || "æˆ‘" : "æˆ‘";
      const h = {
        role: "user",
        senderName: g,
        type: "waimai_request",
        productInfo: c,
        amount: d,
        status: "pending",
        countdownEndTime: f + 900000,
        timestamp: f
      };
      e.history.push(h);
      await Gb.chats.put(e);
      Pd(h, e);
      _c();
      a.value = "";
      b.value = "";
      la.classList.remove("visible");
    });
    document.getElementById("open-persona-library-btn").addEventListener("click", ve);
    document.getElementById("close-persona-library-btn").addEventListener("click", we);
    document.getElementById("add-persona-preset-btn").addEventListener("click", Be);
    document.getElementById("cancel-persona-editor-btn").addEventListener("click", Ee);
    document.getElementById("save-persona-preset-btn").addEventListener("click", Fe);
    document.getElementById("preset-action-edit").addEventListener("click", Ce);
    document.getElementById("preset-action-delete").addEventListener("click", De);
    document.getElementById("preset-action-cancel").addEventListener("click", ze);
    document.getElementById("selection-cancel-btn").addEventListener("click", Zd);
    document.getElementById("selection-soft-delete-btn").addEventListener("click", async () => {
      if (ca.size === 0) {
        return;
      }
      const a = await wb("åˆ é™¤æ¶ˆæ¯", "ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ " + ca.size + " æ¡æ¶ˆæ¯å—ï¼Ÿè¿™ä¼šé€šçŸ¥AIè¿™äº›æ¶ˆæ¯å·²è¢«åˆ é™¤ã€‚", {
        confirmButtonClass: "btn-danger"
      });
      if (a) {
        const a = v.chats[v.activeChatId];
        let b = [];
        for (const c of ca) {
          const d = a.history.find(a => a.timestamp === c);
          if (d && d.type === "poll") {
            b.push("å…³äºŽâ€œ" + d.question + "â€çš„æŠ•ç¥¨(æ—¶é—´æˆ³: " + d.timestamp + ")");
          }
        }
        a.history = a.history.filter(a => !ca.has(a.timestamp));
        let c = "ä¸€äº›ä¹‹å‰çš„æ¶ˆæ¯å·²è¢«ç”¨æˆ·åˆ é™¤ã€‚";
        if (b.length > 0) {
          c += " å…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹æŠ•ç¥¨ï¼š" + b.join("ï¼›") + "ã€‚";
        }
        c += " ä½ åº”è¯¥åƒå®ƒä»¬ä»Žæœªå­˜åœ¨è¿‡ä¸€æ ·ç»§ç»­å¯¹è¯ï¼Œå¹¶ç›¸åº”åœ°è°ƒæ•´ä½ çš„è®°å¿†å’Œè¡Œä¸ºï¼Œä¸è¦å†æåŠè¿™äº›è¢«åˆ é™¤çš„å†…å®¹ã€‚";
        const d = {
          role: "system",
          content: "[ç³»ç»Ÿæç¤ºï¼š" + c + "]",
          timestamp: Date.now(),
          isHidden: true
        };
        a.history.push(d);
        await Gb.chats.put(a);
        cd(v.activeChatId);
        _c();
      }
    });
    document.getElementById("selection-erase-btn").addEventListener("click", async () => {
      if (ca.size === 0) {
        return;
      }
      const a = await wb("å½»åº•åˆ é™¤æ¶ˆæ¯", "è¿™å°†ä»ŽåŽ†å²è®°å½•ä¸­ã€æ°¸ä¹…æŠ¹é™¤ã€‘è¿™ " + ca.size + " æ¡æ¶ˆæ¯ï¼ŒAIå°†å®Œå…¨é—å¿˜å®ƒä»¬çš„å­˜åœ¨ã€‚ç¡®å®šå—ï¼Ÿ", {
        confirmButtonClass: "btn-danger",
        confirmText: "ç¡®è®¤æŠ¹é™¤"
      });
      if (a) {
        const a = v.chats[v.activeChatId];
        a.history = a.history.filter(a => !ca.has(a.timestamp));
        await Gb.chats.put(a);
        cd(v.activeChatId);
        _c();
      }
    });
    const ma = document.getElementById("font-url-input");
    ma.addEventListener("input", () => kc(ma.value.trim(), true));
    document.getElementById("save-font-btn").addEventListener("click", async () => {
      const a = ma.value.trim();
      if (!a) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å­—ä½“URLã€‚");
        return;
      }
      kc(a, false);
      v.globalSettings.fontUrl = a;
      await Gb.globalSettings.put(v.globalSettings);
      alert("å­—ä½“å·²ä¿å­˜å¹¶åº”ç”¨ï¼");
    });
    document.getElementById("reset-font-btn").addEventListener("click", lc);
    document.querySelectorAll("#chat-list-bottom-nav .nav-item").forEach(a => {
      a.addEventListener("click", () => Lb(a.dataset.view));
    });
    document.getElementById("qzone-back-btn").addEventListener("click", () => Lb("messages-view"));
    document.getElementById("qzone-nickname").addEventListener("click", async () => {
      const a = await Db("ä¿®æ”¹æ˜µç§°", "è¯·è¾“å…¥æ–°çš„æ˜µç§°", v.qzoneSettings.nickname);
      if (a && a.trim()) {
        v.qzoneSettings.nickname = a.trim();
        await Ob();
        Nb();
      }
    });
    document.getElementById("qzone-avatar-container").addEventListener("click", () => document.getElementById("qzone-avatar-input").click());
    document.getElementById("qzone-banner-container").addEventListener("click", () => document.getElementById("qzone-banner-input").click());
    document.getElementById("qzone-avatar-input").addEventListener("change", async a => {
      const b = a.target.files[0];
      if (b) {
        const a = await new Promise(a => {
          const c = new FileReader();
          c.onload = () => a(c.result);
          c.readAsDataURL(b);
        });
        v.qzoneSettings.avatar = a;
        await Ob();
        Nb();
      }
      a.target.value = null;
    });
    document.getElementById("qzone-banner-input").addEventListener("change", async a => {
      const b = a.target.files[0];
      if (b) {
        const a = await new Promise(a => {
          const c = new FileReader();
          c.onload = () => a(c.result);
          c.readAsDataURL(b);
        });
        v.qzoneSettings.banner = a;
        await Ob();
        Nb();
      }
      a.target.value = null;
    });
    document.getElementById("create-shuoshuo-btn").addEventListener("click", async () => {
      ac();
      const a = document.getElementById("create-post-modal");
      a.dataset.mode = "shuoshuo";
      a.querySelector(".post-mode-switcher").style.display = "none";
      a.querySelector("#image-mode-content").style.display = "none";
      a.querySelector("#text-image-mode-content").style.display = "none";
      a.querySelector("#post-public-text").placeholder = "åˆ†äº«æ–°é²œäº‹...";
      const b = document.getElementById("post-visibility-groups");
      b.innerHTML = "";
      const c = await Gb.qzoneGroups.toArray();
      if (c.length > 0) {
        c.forEach(a => {
          const c = document.createElement("label");
          c.style.display = "block";
          c.innerHTML = "<input type=\"checkbox\" name=\"visibility_group\" value=\"" + a.id + "\"> " + a.name;
          b.appendChild(c);
        });
      } else {
        b.innerHTML = "<p style=\"color: var(--text-secondary);\">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>";
      }
      a.classList.add("visible");
    });
    document.getElementById("create-post-btn").addEventListener("click", async () => {
      ac();
      const a = document.getElementById("create-post-modal");
      a.dataset.mode = "complex";
      a.querySelector(".post-mode-switcher").style.display = "flex";
      a.querySelector("#image-mode-content").classList.add("active");
      a.querySelector("#text-image-mode-content").classList.remove("active");
      a.querySelector("#post-public-text").placeholder = "åˆ†äº«æ–°é²œäº‹...ï¼ˆéžå¿…å¡«çš„å…¬å¼€æ–‡å­—ï¼‰";
      const b = document.getElementById("post-visibility-groups");
      b.innerHTML = "";
      const c = await Gb.qzoneGroups.toArray();
      if (c.length > 0) {
        c.forEach(a => {
          const c = document.createElement("label");
          c.style.display = "block";
          c.innerHTML = "<input type=\"checkbox\" name=\"visibility_group\" value=\"" + a.id + "\"> " + a.name;
          b.appendChild(c);
        });
      } else {
        b.innerHTML = "<p style=\"color: var(--text-secondary);\">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>";
      }
      a.classList.add("visible");
    });
    document.getElementById("open-album-btn").addEventListener("click", async () => {
      await Le();
      Kb("album-screen");
    });
    document.getElementById("album-back-btn").addEventListener("click", () => {
      Kb("chat-list-screen");
      Lb("qzone-screen");
    });
    document.getElementById("album-photos-back-btn").addEventListener("click", () => {
      v.activeAlbumId = null;
      Kb("album-screen");
    });
    document.getElementById("album-upload-photo-btn").addEventListener("click", () => document.getElementById("album-photo-input").click());
    document.getElementById("album-photo-input").addEventListener("change", async a => {
      if (!v.activeAlbumId) {
        return;
      }
      const b = a.target.files;
      if (!b.length) {
        return;
      }
      const c = await Gb.qzoneAlbums.get(v.activeAlbumId);
      for (const c of b) {
        const a = await new Promise(a => {
          const b = new FileReader();
          b.onload = () => a(b.result);
          b.readAsDataURL(c);
        });
        await Gb.qzonePhotos.add({
          albumId: v.activeAlbumId,
          url: a,
          createdAt: Date.now()
        });
      }
      const d = await Gb.qzonePhotos.where("albumId").equals(v.activeAlbumId).count();
      const e = {
        photoCount: d
      };
      if (!c.photoCount || c.coverUrl.includes("placeholder")) {
        const a = await Gb.qzonePhotos.where("albumId").equals(v.activeAlbumId).first();
        if (a) {
          e.coverUrl = a.url;
        }
      }
      await Gb.qzoneAlbums.update(v.activeAlbumId, e);
      await Ne();
      await Le();
      a.target.value = null;
      alert("ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼");
    });
    document.getElementById("photos-grid-page").addEventListener("click", async a => {
      const b = a.target.closest(".photo-delete-btn");
      const c = a.target.closest(".photo-thumb");
      if (b) {
        a.stopPropagation();
        const c = parseInt(b.dataset.photoId);
        const d = await wb("åˆ é™¤ç…§ç‰‡", "ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", {
          confirmButtonClass: "btn-danger"
        });
        if (d) {
          const a = await Gb.qzonePhotos.get(c);
          if (!a) {
            return;
          }
          await Gb.qzonePhotos.delete(c);
          const b = await Gb.qzoneAlbums.get(v.activeAlbumId);
          const d = (b.photoCount || 1) - 1;
          const e = {
            photoCount: d
          };
          if (b.coverUrl === a.url) {
            const a = await Gb.qzonePhotos.where("albumId").equals(v.activeAlbumId).first();
            e.coverUrl = a ? a.url : "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png";
          }
          await Gb.qzoneAlbums.update(v.activeAlbumId, e);
          await Ne();
          await Le();
          alert("ç…§ç‰‡å·²åˆ é™¤ã€‚");
        }
      } else if (c) {
        Oe(c.src);
      }
    });
    document.getElementById("photo-viewer-close-btn").addEventListener("click", Se);
    document.getElementById("photo-viewer-next-btn").addEventListener("click", Qe);
    document.getElementById("photo-viewer-prev-btn").addEventListener("click", Re);
    document.addEventListener("keydown", a => {
      if (!Ga.isOpen) {
        return;
      }
      if (a.key === "ArrowRight") {
        Qe();
      } else if (a.key === "ArrowLeft") {
        Re();
      } else if (a.key === "Escape") {
        Se();
      }
    });
    document.getElementById("create-album-btn-page").addEventListener("click", async () => {
      const a = await Db("åˆ›å»ºæ–°ç›¸å†Œ", "è¯·è¾“å…¥ç›¸å†Œåç§°");
      if (a && a.trim()) {
        const b = {
          name: a.trim(),
          coverUrl: "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png",
          photoCount: 0,
          createdAt: Date.now()
        };
        await Gb.qzoneAlbums.add(b);
        await Le();
        alert("ç›¸å†Œ \"" + a + "\" åˆ›å»ºæˆåŠŸï¼");
      } else if (a !== null) {
        alert("ç›¸å†Œåç§°ä¸èƒ½ä¸ºç©ºï¼");
      }
    });
    document.getElementById("cancel-create-post-btn").addEventListener("click", () => document.getElementById("create-post-modal").classList.remove("visible"));
    document.getElementById("post-upload-local-btn").addEventListener("click", () => document.getElementById("post-local-image-input").click());
    document.getElementById("post-local-image-input").addEventListener("change", a => {
      const b = a.target.files[0];
      if (b) {
        const a = new FileReader();
        a.onload = a => {
          document.getElementById("post-image-preview").src = a.target.result;
          document.getElementById("post-image-preview-container").classList.add("visible");
          document.getElementById("post-image-desc-group").style.display = "block";
        };
        a.readAsDataURL(b);
      }
    });
    document.getElementById("post-use-url-btn").addEventListener("click", async () => {
      const a = await Db("è¾“å…¥å›¾ç‰‡URL", "è¯·è¾“å…¥ç½‘ç»œå›¾ç‰‡çš„é“¾æŽ¥", "", "url");
      if (a) {
        document.getElementById("post-image-preview").src = a;
        document.getElementById("post-image-preview-container").classList.add("visible");
        document.getElementById("post-image-desc-group").style.display = "block";
      }
    });
    document.getElementById("post-remove-image-btn").addEventListener("click", () => ac());
    const oa = document.getElementById("switch-to-image-mode");
    const pa = document.getElementById("switch-to-text-image-mode");
    const sa = document.getElementById("image-mode-content");
    const ta = document.getElementById("text-image-mode-content");
    oa.addEventListener("click", () => {
      oa.classList.add("active");
      pa.classList.remove("active");
      sa.classList.add("active");
      ta.classList.remove("active");
    });
    pa.addEventListener("click", () => {
      pa.classList.add("active");
      oa.classList.remove("active");
      ta.classList.add("active");
      sa.classList.remove("active");
    });
    document.getElementById("confirm-create-post-btn").addEventListener("click", async () => {
      const a = document.getElementById("create-post-modal");
      const b = a.dataset.mode;
      const c = document.querySelector("input[name=\"visibility\"]:checked").value;
      let d = null;
      if (c === "include") {
        d = Array.from(document.querySelectorAll("input[name=\"visibility_group\"]:checked")).map(a => parseInt(a.value));
      }
      let e = {};
      const f = {
        timestamp: Date.now(),
        authorId: "user",
        visibleGroupIds: d
      };
      if (b === "shuoshuo") {
        const a = document.getElementById("post-public-text").value.trim();
        if (!a) {
          alert("è¯´è¯´å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼");
          return;
        }
        e = {
          ...f,
          type: "shuoshuo",
          content: a
        };
      } else {
        const a = document.getElementById("post-public-text").value.trim();
        const b = document.getElementById("image-mode-content").classList.contains("active");
        if (b) {
          const b = document.getElementById("post-image-preview").src;
          const c = document.getElementById("post-image-description").value.trim();
          if (!b || !(b.startsWith("http") || b.startsWith("data:"))) {
            alert("è¯·å…ˆæ·»åŠ ä¸€å¼ å›¾ç‰‡å†å‘å¸ƒåŠ¨æ€å“¦ï¼");
            return;
          }
          if (!c) {
            alert("è¯·ä¸ºä½ çš„å›¾ç‰‡æ·»åŠ ä¸€ä¸ªç®€å•çš„æè¿°ï¼ˆå¿…å¡«ï¼Œç»™AIçœ‹çš„ï¼‰ï¼");
            return;
          }
          e = {
            ...f,
            type: "image_post",
            publicText: a,
            imageUrl: b,
            imageDescription: c
          };
        } else {
          const b = document.getElementById("post-hidden-text").value.trim();
          if (!b) {
            alert("è¯·è¾“å…¥æ–‡å­—å›¾æè¿°ï¼");
            return;
          }
          e = {
            ...f,
            type: "text_image",
            publicText: a,
            hiddenContent: b
          };
        }
      }
      const g = await Gb.qzonePosts.add(e);
      let h = e.content || e.publicText || e.imageDescription || e.hiddenContent || "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";
      h = h.substring(0, 50) + (h.length > 50 ? "..." : "");
      for (const a in v.chats) {
        const b = v.chats[a];
        if (b.isGroup) {
          continue;
        }
        let c = false;
        const d = e.visibleGroupIds;
        if (!d || d.length === 0) {
          c = true;
        } else if (b.groupId && d.includes(b.groupId)) {
          c = true;
        }
        if (c) {
          const a = {
            role: "system",
            content: "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšå‘å¸ƒäº†ä¸€æ¡åŠ¨æ€(ID: " + g + ")ï¼Œå†…å®¹æ‘˜è¦æ˜¯ï¼šâ€œ" + h + "â€ã€‚è¯·ä½ ã€ç»“åˆè‡ªå·±çš„è§’è‰²è®¾å®šã€ä¸–ç•Œè§‚å’Œä½ ä»¬çš„æœ€è¿‘èŠå¤©å†…å®¹ã€‘ï¼Œå¯¹è¿™æ¡åŠ¨æ€å‘è¡¨ä¸€æ¡è‡ªç„¶çš„è¯„è®ºã€‚]",
            timestamp: Date.now(),
            isHidden: true
          };
          b.history.push(a);
          await Gb.chats.put(b);
        }
      }
      await Sb();
      a.classList.remove("visible");
      alert("åŠ¨æ€å‘å¸ƒæˆåŠŸï¼");
    });
    const ua = document.getElementById("qzone-posts-list");
    let va = {
      isDragging: false,
      startX: 0,
      startY: 0,
      currentX: 0,
      activeContainer: null,
      swipeDirection: null,
      isClick: true
    };
    function wa(a = null) {
      document.querySelectorAll(".qzone-post-container").forEach(b => {
        if (b !== a) {
          b.querySelector(".qzone-post-item").classList.remove("swiped");
        }
      });
    }
    async function xa(a) {
      a.stopPropagation();
      const b = a.target;
      const c = b.closest(".comment-delete-btn");
      if (c) {
        const a = c.closest(".qzone-post-container");
        const b = parseInt(a.dataset.postId);
        const d = parseInt(c.dataset.commentIndex);
        if (isNaN(b) || isNaN(d)) {
          return;
        }
        const e = Q.find(a => a.id === b);
        if (!e || !e.comments || !e.comments[d]) {
          return;
        }
        const f = e.comments[d];
        const g = await wb("åˆ é™¤è¯„è®º", "ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ", {
          confirmButtonClass: "btn-danger"
        });
        if (g) {
          e.comments.splice(d, 1);
          await Gb.qzonePosts.update(b, {
            comments: e.comments
          });
          if (f && f.commenterName === v.qzoneSettings.nickname) {
            console.log("ç”¨æˆ·åˆ é™¤äº†è‡ªå·±çš„è¯„è®ºï¼Œå¼€å§‹æ¸…ç†AIè®°å¿†...");
            const a = new Set();
            if (e.authorId !== "user") {
              a.add(e.authorId);
            }
            if (f.replyTo) {
              const b = Object.values(v.chats).find(a => a.originalName === f.replyTo);
              if (b) {
                a.add(b.id);
              }
            }
            const b = (e.publicText || e.content || "").substring(0, 30);
            const c = v.qzoneSettings.nickname;
            let d;
            const g = v.userStickers.find(a => a.url === f.text);
            if (g) {
              d = "ç”¨æˆ·'" + c + "'åˆšåˆšåœ¨ä½ çš„åŠ¨æ€â€œ" + b + "â€ä¸‹ï¼Œå‘é€äº†ä¸€ä¸ªè¡¨æƒ…è¯„è®ºï¼Œæ„æ€æ˜¯ï¼šâ€œ" + g.name + "â€ã€‚";
            } else if (f.replyTo) {
              const a = ub(f.replyTo);
              d = "ç”¨æˆ·'" + c + "'åˆšåˆšåœ¨ä½ çš„åŠ¨æ€â€œ" + b + "â€ä¸‹ï¼Œå›žå¤äº†'" + a + "'çš„è¯„è®ºï¼Œå†…å®¹æ˜¯ï¼šâ€œ" + f.text + "â€ã€‚";
            } else {
              d = "ç”¨æˆ·'" + c + "'åˆšåˆšè¯„è®ºäº†ä½ çš„åŠ¨æ€â€œ" + b + "â€ï¼Œå†…å®¹æ˜¯ï¼šâ€œ" + f.text + "â€ã€‚";
            }
            const h = "[ç³»ç»Ÿæç¤ºï¼š" + d + "è¯·ä½ å¯¹æ­¤ä½œå‡ºå›žåº”ã€‚]";
            for (const b of a) {
              const a = v.chats[b];
              if (a) {
                const b = a.history.length;
                a.history = a.history.filter(a => !(a.isHidden && a.role === "system" && a.content === h));
                if (a.history.length < b) {
                  console.log("åœ¨è§’è‰² \"" + a.name + "\" çš„è®°å¿†ä¸­æ¸…é™¤äº†1æ¡å…³äºŽå·²åˆ é™¤è¯„è®ºçš„é€šçŸ¥ã€‚");
                  await Gb.chats.put(a);
                }
              }
            }
          }
          await Rb(b);
        }
        return;
      }
      const d = b.closest(".comment-sticker-btn");
      if (d) {
        const a = d.closest(".qzone-post-container");
        if (!a) {
          return;
        }
        const b = parseInt(a.dataset.postId);
        if (S.isOpen && S.activePostId === b) {
          Vb();
        } else {
          Ub(b, d);
        }
        return;
      }
      const e = b.closest(".comment-item");
      if (e) {
        const a = parseInt(e.dataset.postId);
        const b = e.dataset.commenterOriginalName;
        const c = e.dataset.commenterDisplayName;
        if (!b || !c || b === v.qzoneSettings.nickname) {
          jg(e.closest(".qzone-post-container"));
          return;
        }
        Da = {
          postId: a,
          replyToName: b,
          replyToDisplayName: c
        };
        const d = e.closest(".qzone-post-container");
        const f = d.querySelector(".comment-input");
        f.placeholder = "å›žå¤ " + c + ":";
        f.focus();
        return;
      }
      if (b.classList.contains("post-actions-btn")) {
        const a = b.closest(".qzone-post-container");
        if (a && a.dataset.postId) {
          of(parseInt(a.dataset.postId));
        }
        return;
      }
      if (b.tagName === "IMG" && b.dataset.hiddenText) {
        Bb("å›¾ç‰‡å†…å®¹", b.dataset.hiddenText.replace(/<br>/g, "\n"));
        return;
      }
      const f = b.closest(".qzone-post-container");
      if (!f) {
        return;
      }
      const g = parseInt(f.dataset.postId);
      if (isNaN(g)) {
        return;
      }
      if (b.closest(".qzone-post-delete-action")) {
        const a = await wb("åˆ é™¤åŠ¨æ€", "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ", {
          confirmButtonClass: "btn-danger"
        });
        if (a) {
          f.style.transition = "all 0.3s ease";
          f.style.transform = "scale(0.8)";
          f.style.opacity = "0";
          // TOLOOK
          setTimeout(async () => {
            await Gb.qzonePosts.delete(g);
            const a = "(ID: " + g + ")";
            for (const b in v.chats) {
              const c = v.chats[b];
              const d = c.history.length;
              c.history = c.history.filter(b => !(b.role === "system" && b.content.includes(a)));
              if (c.history.length < d) {
                await Gb.chats.put(c);
              }
            }
            await Sb();
            alert("åŠ¨æ€å·²åˆ é™¤ã€‚");
          }, 300);
        }
        return;
      }
      const h = b.closest(".action-icon");
      if (h) {
        if (h.classList.contains("repost")) {
          Xb(g);
          return;
        }
        if (h.classList.contains("like")) {
          const a = Q.find(a => a.id === g);
          if (!a) {
            return;
          }
          if (!a.likes) {
            a.likes = [];
          }
          const b = v.qzoneSettings.nickname;
          const c = a.likes.indexOf(b);
          if (c > -1) {
            a.likes.splice(c, 1);
          } else {
            a.likes.push(b);
            h.classList.add("animate-like");
            h.addEventListener("animationend", () => h.classList.remove("animate-like"), {
              once: true
            });
          }
          await Gb.qzonePosts.update(g, {
            likes: a.likes
          });
          await Rb(g);
        }
        if (h.classList.contains("favorite")) {
          const a = await Gb.favorites.where({
            type: "qzone_post",
            "content.id": g
          }).first();
          if (a) {
            await Gb.favorites.delete(a.id);
            await Bb("æç¤º", "å·²å–æ¶ˆæ”¶è—");
          } else {
            const a = await Gb.qzonePosts.get(g);
            if (a) {
              await Gb.favorites.add({
                type: "qzone_post",
                content: a,
                timestamp: Date.now()
              });
              await Bb("æç¤º", "æ”¶è—æˆåŠŸï¼");
            }
          }
          await Rb(g);
        }
        return;
      }
      const i = b.closest(".comment-send-btn");
      if (i) {
        const a = f.querySelector(".comment-input");
        const b = a.value.trim();
        if (!b) {
          return alert("è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼");
        }
        const c = Q.find(a => a.id === g);
        if (!c) {
          return;
        }
        if (!c.comments) {
          c.comments = [];
        }
        const d = {
          commenterName: v.qzoneSettings.nickname,
          text: b,
          timestamp: Date.now(),
          replyTo: Da && Da.postId === g ? Da.replyToName : null
        };
        c.comments.push(d);
        await Gb.qzonePosts.update(g, {
          comments: c.comments
        });
        let e = (c.publicText || c.content || "").substring(0, 30);
        const h = v.qzoneSettings.nickname;
        const i = new Set();
        if (c.authorId !== "user") {
          i.add(c.authorId);
        }
        if (d.replyTo && d.replyTo !== h) {
          const a = Object.values(v.chats).find(a => a.originalName === d.replyTo);
          if (a) {
            i.add(a.id);
          }
        }
        for (const a of i) {
          const c = v.chats[a];
          if (c && !c.isGroup) {
            const a = v.userStickers.find(a => a.url === b);
            let f = a ? "ç”¨æˆ·'" + h + "'åˆšåˆšåœ¨ä½ çš„åŠ¨æ€â€œ" + e + "â€ä¸‹ï¼Œå‘é€äº†ä¸€ä¸ªè¡¨æƒ…è¯„è®ºï¼Œæ„æ€æ˜¯ï¼šâ€œ" + a.name + "â€ã€‚" : d.replyTo ? "ç”¨æˆ·'" + h + "'åˆšåˆšåœ¨ä½ çš„åŠ¨æ€â€œ" + e + "â€ä¸‹ï¼Œå›žå¤äº†'" + Da.replyToDisplayName + "'çš„è¯„è®ºï¼Œå†…å®¹æ˜¯ï¼šâ€œ" + b + "â€ã€‚" : "ç”¨æˆ·'" + h + "'åˆšåˆšè¯„è®ºäº†ä½ çš„åŠ¨æ€â€œ" + e + "â€ï¼Œå†…å®¹æ˜¯ï¼šâ€œ" + b + "â€ã€‚";
            const g = {
              role: "system",
              content: "[ç³»ç»Ÿæç¤ºï¼š" + f + "è¯·ä½ å¯¹æ­¤ä½œå‡ºå›žåº”ã€‚]",
              timestamp: Date.now(),
              isHidden: true
            };
            c.history.push(g);
            await Gb.chats.put(c);
          }
        }
        a.value = "";
        jg(f);
        await Rb(g);
        return;
      }
    }
    const Aa = a => {
      const b = a.target;
      if (b.closest(".post-footer, .post-feedback-icons, .post-actions-btn, .post-comments-container, .reposted-content-wrapper")) {
        return;
      }
      const c = a.target.closest(".qzone-post-container");
      if (!c) {
        return;
      }
      wa(c);
      va.activeContainer = c;
      va.isDragging = true;
      va.isClick = true;
      va.swipeDirection = null;
      va.startX = a.type.includes("mouse") ? a.pageX : a.touches[0].pageX;
      va.startY = a.type.includes("mouse") ? a.pageY : a.touches[0].pageY;
      va.activeContainer.querySelector(".qzone-post-item").style.transition = "none";
      document.addEventListener("mousemove", Ca);
      document.addEventListener("mouseup", Ea);
      document.addEventListener("touchmove", Ca, {
        passive: false
      });
      document.addEventListener("touchend", Ea);
    };
    const Ca = a => {
      if (!va.isDragging || !va.activeContainer) {
        return;
      }
      const b = a.type.includes("mouse") ? a.pageX : a.touches[0].pageX;
      const c = a.type.includes("mouse") ? a.pageY : a.touches[0].pageY;
      const d = b - va.startX;
      const e = c - va.startY;
      if (va.isClick && (Math.abs(d) > 5 || Math.abs(e) > 5)) {
        va.isClick = false;
      }
      if (!va.swipeDirection) {
        if (Math.abs(d) > Math.abs(e)) {
          va.swipeDirection = "horizontal";
        } else {
          va.swipeDirection = "vertical";
        }
      }
      if (va.swipeDirection === "horizontal") {
        a.preventDefault();
        va.currentX = b;
        let c = Math.min(0, Math.max(-90, d));
        va.activeContainer.querySelector(".qzone-post-item").style.transform = "translateX(" + c + "px)";
      }
    };
    const Ea = a => {
      document.removeEventListener("mousemove", Ca);
      document.removeEventListener("mouseup", Ea);
      document.removeEventListener("touchmove", Ca);
      document.removeEventListener("touchend", Ea);
      if (!va.isDragging || !va.activeContainer) {
        return;
      }
      const b = va.activeContainer.querySelector(".qzone-post-item");
      b.style.transition = "transform 0.3s ease";
      if (va.swipeDirection === "horizontal" && !va.isClick) {
        const c = a.type.includes("touchend") ? a.changedTouches[0].pageX : a.pageX;
        const d = c - va.startX;
        if (d < -40) {
          b.classList.add("swiped");
        } else {
          b.classList.remove("swiped");
        }
      }
      b.style.transform = "";
      va.isDragging = false;
      va.activeContainer = null;
      va.swipeDirection = null;
      va.isClick = true;
    };
    ua.addEventListener("click", xa);
    ua.addEventListener("mousedown", Aa);
    ua.addEventListener("touchstart", Aa, {
      passive: true
    });
    ua.addEventListener("click", a => {
      if (a.target && a.target.id === "load-more-qzone-btn") {
        Tb();
      }
    });
    document.getElementById("refine-memory-btn-header").addEventListener("click", () => {
      if (v.activeChatId) {
        vh(v.activeChatId);
      }
    });
    document.getElementById("api-preset-select").addEventListener("change", Mc);
    document.getElementById("save-api-preset-btn").addEventListener("click", Nc);
    document.getElementById("delete-api-preset-btn").addEventListener("click", Oc);
    document.getElementById("add-world-book-entry-btn").addEventListener("click", () => {
      const a = document.getElementById("world-book-entries-container");
      if (a.querySelector("p")) {
        a.innerHTML = "";
      }
      const b = Gi();
      a.appendChild(b);
      b.querySelector(".entry-content-textarea").focus();
    });
    document.getElementById("switch-greeting-btn").addEventListener("click", Fi);
    document.getElementById("thoughts-history-list").addEventListener("click", a => {
      if (a.target && a.target.id === "load-more-thoughts-btn") {
        zi();
      }
    });
    document.getElementById("profile-history-icon-btn").addEventListener("click", wi);
    document.getElementById("history-back-btn").addEventListener("click", xi);
    document.getElementById("character-profile-modal").addEventListener("click", a => {
      if (a.target.id === "character-profile-modal") {
        a.target.classList.remove("visible");
      }
    });
    document.getElementById("manage-stickers-btn").addEventListener("click", Bd);
    document.getElementById("delete-selected-stickers-btn").addEventListener("click", Gd);
    document.getElementById("export-selected-stickers-btn").addEventListener("click", Hd);
    document.getElementById("qzone-back-btn").addEventListener("click", () => Lb("messages-view"));
    document.getElementById("favorites-back-btn").addEventListener("click", () => Lb("messages-view"));
    const Ha = document.getElementById("favorites-search-input");
    const Ka = document.getElementById("favorites-search-clear-btn");
    Ha.addEventListener("input", () => {
      const a = Ha.value.trim().toLowerCase();
      Ka.style.display = a ? "block" : "none";
      if (!a) {
        $b(allFavoriteItems);
        return;
      }
      const b = allFavoriteItems.filter(b => {
        let c = "";
        let d = "";
        if (b.type === "qzone_post") {
          const a = b.content;
          c += (a.publicText || "") + " " + (a.content || "");
          if (a.authorId === "user") {
            d = v.qzoneSettings.nickname;
          } else if (v.chats[a.authorId]) {
            d = v.chats[a.authorId].name;
          }
        } else if (b.type === "chat_message") {
          const a = b.content;
          if (typeof a.content === "string") {
            c = a.content;
          }
          const e = v.chats[b.chatId];
          if (e) {
            if (a.role === "user") {
              d = e.isGroup ? e.settings.myNickname || "æˆ‘" : "æˆ‘";
            } else {
              d = e.isGroup ? a.senderName : e.name;
            }
          }
        }
        return c.toLowerCase().includes(a) || d.toLowerCase().includes(a);
      });
      $b(b);
    });
    Ka.addEventListener("click", () => {
      Ha.value = "";
      Ka.style.display = "none";
      $b(allFavoriteItems);
      Ha.focus();
    });
    document.getElementById("selection-favorite-btn").addEventListener("click", async () => {
      if (ca.size === 0) {
        return;
      }
      const a = v.chats[v.activeChatId];
      if (!a) {
        return;
      }
      const b = [];
      const c = [...ca];
      for (const d of c) {
        const c = await Gb.favorites.where("originalTimestamp").equals(d).first();
        if (!c) {
          const c = a.history.find(a => a.timestamp === d);
          if (c) {
            b.push({
              type: "chat_message",
              content: c,
              chatId: v.activeChatId,
              timestamp: Date.now(),
              originalTimestamp: c.timestamp
            });
          }
        }
      }
      if (b.length > 0) {
        await Gb.favorites.bulkAdd(b);
        allFavoriteItems = await Gb.favorites.orderBy("timestamp").reverse().toArray();
        await Bb("æ”¶è—æˆåŠŸ", "å·²æˆåŠŸæ”¶è— " + b.length + " æ¡æ¶ˆæ¯ã€‚");
      } else {
        await Bb("æç¤º", "é€‰ä¸­çš„æ¶ˆæ¯å‡å·²æ”¶è—è¿‡ã€‚");
      }
      Zd();
    });
    const Ma = document.getElementById("favorites-edit-btn");
    const Ra = document.getElementById("favorites-view");
    const Va = document.getElementById("favorites-action-bar");
    const Wa = document.getElementById("chat-list-bottom-nav");
    const Xa = document.getElementById("favorites-list");
    Ma.addEventListener("click", () => {
      Ia = !Ia;
      Ra.classList.toggle("selection-mode", Ia);
      if (Ia) {
        Ma.textContent = "å®Œæˆ";
        Va.style.display = "block";
        Wa.style.display = "none";
        Xa.style.paddingBottom = "80px";
      } else {
        Ma.textContent = "ç¼–è¾‘";
        Va.style.display = "none";
        Wa.style.display = "flex";
        Xa.style.paddingBottom = "";
        Ja.clear();
        document.querySelectorAll(".favorite-item-card.selected").forEach(a => a.classList.remove("selected"));
        document.getElementById("favorites-delete-selected-btn").textContent = "åˆ é™¤ (0)";
      }
    });
    document.getElementById("favorites-list").addEventListener("click", a => {
      const b = a.target;
      const c = b.closest(".favorite-item-card");
      if (b.tagName === "IMG" && b.dataset.hiddenText) {
        const a = b.dataset.hiddenText;
        Bb("å›¾ç‰‡å†…å®¹", a.replace(/<br>/g, "\n"));
        return;
      }
      if (!Ia) {
        return;
      }
      if (!c) {
        return;
      }
      const d = parseInt(c.dataset.favid);
      if (isNaN(d)) {
        return;
      }
      if (Ja.has(d)) {
        Ja.delete(d);
        c.classList.remove("selected");
      } else {
        Ja.add(d);
        c.classList.add("selected");
      }
      document.getElementById("favorites-delete-selected-btn").textContent = "åˆ é™¤ (" + Ja.size + ")";
    });
    document.getElementById("favorites-delete-selected-btn").addEventListener("click", async () => {
      if (Ja.size === 0) {
        return;
      }
      const a = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦ä»Žæ”¶è—å¤¹ä¸­ç§»é™¤è¿™ " + Ja.size + " æ¡å†…å®¹å—ï¼Ÿ", {
        confirmButtonClass: "btn-danger"
      });
      if (a) {
        const a = [...Ja];
        await Gb.favorites.bulkDelete(a);
        await Bb("åˆ é™¤æˆåŠŸ", "é€‰ä¸­çš„æ”¶è—å·²è¢«ç§»é™¤ã€‚");
        allFavoriteItems = allFavoriteItems.filter(b => !a.includes(b.id));
        $b(allFavoriteItems);
        Ma.click();
      }
    });
    if (v.globalSettings.enableBackgroundActivity) {
      Ue();
      console.log("åŽå°æ´»åŠ¨æ¨¡æ‹Ÿå·²è‡ªåŠ¨å¯åŠ¨ã€‚");
    }
    document.querySelectorAll("input[name=\"theme-select\"]").forEach(a => {
      a.addEventListener("change", _e);
    });
    const Ya = document.getElementById("font-size-slider");
    Ya.addEventListener("input", () => {
      document.getElementById("font-size-value").textContent = Ya.value + "px";
      _e();
    });
    const Za = document.getElementById("custom-css-input");
    Za.addEventListener("input", _e);
    document.getElementById("reset-theme-btn").addEventListener("click", () => {
      document.getElementById("theme-default").checked = true;
      _e();
    });
    document.getElementById("reset-custom-css-btn").addEventListener("click", () => {
      document.getElementById("custom-css-input").value = "";
      _e();
    });
    document.getElementById("lyrics-vertical-pos").addEventListener("change", _e);
    document.getElementById("lyrics-horizontal-pos").addEventListener("change", _e);
    document.getElementById("lyrics-offset-input").addEventListener("input", _e);
    document.querySelectorAll("input[name=\"visibility\"]").forEach(a => {
      a.addEventListener("change", function () {
        const a = document.getElementById("post-visibility-groups");
        if (this.value === "include" || this.value === "exclude") {
          a.style.display = "block";
        } else {
          a.style.display = "none";
        }
      });
    });
    document.getElementById("manage-groups-btn").addEventListener("click", af);
    document.getElementById("close-group-manager-btn").addEventListener("click", () => {
      document.getElementById("group-management-modal").classList.remove("visible");
      const a = document.getElementById("chat-settings-btn");
      if (document.getElementById("chat-settings-modal").classList.contains("visible")) {
        a.click();
      }
    });
    document.getElementById("add-new-group-btn").addEventListener("click", cf);
    document.getElementById("existing-groups-list").addEventListener("click", a => {
      if (a.target.classList.contains("delete-group-btn")) {
        const b = parseInt(a.target.dataset.id);
        df(b);
      }
    });
    document.getElementById("cancel-message-action-btn").addEventListener("click", ff);
    document.getElementById("edit-message-btn").addEventListener("click", lf);
    document.getElementById("copy-message-btn").addEventListener("click", hf);
    document.getElementById("recall-message-btn").addEventListener("click", Vh);
    document.getElementById("select-message-btn").addEventListener("click", () => {
      const a = qa;
      ff();
      if (a) {
        Yd(a);
      }
    });
    document.getElementById("transfer-action-accept").addEventListener("click", () => ig("accepted"));
    document.getElementById("transfer-action-decline").addEventListener("click", () => ig("declined"));
    document.getElementById("transfer-action-cancel").addEventListener("click", Bh);
    document.getElementById("edit-post-btn").addEventListener("click", qf);
    document.getElementById("copy-post-btn").addEventListener("click", sf);
    document.getElementById("cancel-post-action-btn").addEventListener("click", pf);
    document.getElementById("cancel-contact-picker-btn").addEventListener("click", () => {
      Kb("chat-list-screen");
    });
    document.getElementById("contact-picker-list").addEventListener("click", a => {
      const b = a.target.closest(".contact-picker-item");
      if (!b) {
        return;
      }
      const c = b.dataset.contactId;
      b.classList.toggle("selected");
      if (tf.has(c)) {
        tf.delete(c);
      } else {
        tf.add(c);
      }
      Af();
    });
    document.getElementById("manage-members-btn").addEventListener("click", () => {
      Cf();
    });
    document.getElementById("back-from-member-management").addEventListener("click", () => {
      Kb("chat-interface-screen");
      document.getElementById("chat-settings-btn").click();
    });
    document.getElementById("member-management-list").addEventListener("click", a => {
      if (a.target.classList.contains("remove-member-btn")) {
        Ef(a.target.dataset.memberId);
      }
    });
    document.getElementById("add-existing-contact-btn").addEventListener("click", async () => {
      const a = document.getElementById("confirm-contact-picker-btn");
      const b = a.cloneNode(true);
      a.parentNode.replaceChild(b, a);
      b.addEventListener("click", Hf);
      await Ff();
    });
    document.getElementById("create-new-member-btn").addEventListener("click", If);
    document.getElementById("video-call-btn").addEventListener("click", Pf);
    document.getElementById("group-video-call-btn").addEventListener("click", Pf);
    document.getElementById("hang-up-btn").addEventListener("click", Tf);
    document.getElementById("minimize-call-btn").addEventListener("click", Rf);
    document.getElementById("video-call-restore-btn").addEventListener("click", Sf);
    Qn(document.getElementById("video-call-restore-btn"), document.getElementById("video-call-restore-btn"));
    document.getElementById("cancel-call-btn").addEventListener("click", () => {
      Nf.isAwaitingResponse = false;
      Kb("chat-interface-screen");
    });
    document.getElementById("join-call-btn").addEventListener("click", Vf);
    document.getElementById("decline-call-btn").addEventListener("click", async () => {
      Yf();
      const a = v.chats[Nf.activeChatId];
      if (!a) {
        return;
      }
      if (Nf.isGroupCall) {
        Nf.isUserParticipating = false;
        const b = {
          role: "system",
          content: "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‹’ç»äº†é€šè¯é‚€è¯·ï¼Œä½†ä½ ä»¬å¯ä»¥è‡ªå·±å¼€å§‹ã€‚è¯·ä½ ä»¬å„è‡ªå†³ç­–æ˜¯å¦åŠ å…¥ã€‚]",
          timestamp: Date.now(),
          isHidden: true
        };
        a.history.push(b);
        await Gb.chats.put(a);
        await Td();
      } else {
        const b = {
          role: "user",
          content: "æˆ‘æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚",
          timestamp: Date.now()
        };
        a.history.push(b);
        await Gb.chats.put(a);
        Kb("chat-interface-screen");
        Pd(b, a);
        Td();
      }
      Nf.isAwaitingResponse = false;
    });
    document.getElementById("accept-call-btn").addEventListener("click", async () => {
      Yf();
      Nf.initiator = "ai";
      Nf.isUserParticipating = true;
      Nf.activeChatId = v.activeChatId;
      if (Nf.isGroupCall) {
        const a = v.chats[Nf.activeChatId];
        const b = a.members.find(a => a.name === Nf.callRequester);
        if (b) {
          Nf.participants = [b];
        } else {
          Nf.participants = [];
        }
      }
      Qf();
    });
    document.getElementById("user-speak-btn").addEventListener("click", async () => {
      if (!Nf.isActive) {
        return;
      }
      const a = document.querySelector(".participant-avatar-wrapper[data-participant-id=\"user\"] .participant-avatar");
      if (a) {
        a.classList.add("speaking");
      }
      const b = await Db("ä½ è¯´", "è¯·è¾“å…¥ä½ æƒ³è¯´çš„è¯...");
      if (a) {
        a.classList.remove("speaking");
      }
      if (b && b.trim()) {
        Zf(b.trim());
      }
    });
    document.querySelector(".nav-item[data-view=\"memories-view\"]").addEventListener("click", () => {
      if (Ia) {
        document.getElementById("favorites-edit-btn").click();
      }
      Lb("memories-view");
      kg();
    });
    document.getElementById("memories-back-btn").addEventListener("click", () => Lb("messages-view"));
    document.getElementById("confirm-create-countdown-btn").addEventListener("click", async () => {
      const a = document.getElementById("countdown-title-input").value.trim();
      const b = document.getElementById("countdown-date-input").value;
      if (!a || !b) {
        alert("è¯·å¡«å†™å®Œæ•´çš„çº¦å®šæ ‡é¢˜å’Œæ—¥æœŸï¼");
        return;
      }
      const c = new Date(b);
      if (isNaN(c) || c <= new Date()) {
        alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ã€æœªæ¥çš„æ—¥æœŸï¼");
        return;
      }
      const d = {
        authorId: "user",
        description: a,
        timestamp: Date.now(),
        type: "countdown",
        targetDate: c.getTime()
      };
      await Gb.memories.add(d);
      document.getElementById("create-countdown-modal").classList.remove("visible");
      kg();
    });
    document.getElementById("block-chat-btn").addEventListener("click", async () => {
      if (!v.activeChatId || v.chats[v.activeChatId].isGroup) {
        return;
      }
      const a = v.chats[v.activeChatId];
      const b = await wb("ç¡®è®¤æ‹‰é»‘", "ç¡®å®šè¦æ‹‰é»‘â€œ" + a.name + "â€å—ï¼Ÿæ‹‰é»‘åŽæ‚¨å°†æ— æ³•å‘å…¶å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æ‚¨å°†Taç§»å‡ºé»‘åå•ï¼Œæˆ–ç­‰å¾…Taé‡æ–°ç”³è¯·å¥½å‹ã€‚", {
        confirmButtonClass: "btn-danger"
      });
      if (b) {
        a.relationship.status = "blocked_by_user";
        a.relationship.blockedTimestamp = Date.now();
        const b = {
          role: "system",
          content: "[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšè¢«ç”¨æˆ·æ‹‰é»‘äº†ã€‚åœ¨å¯¹æ–¹è§£é™¤æ‹‰é»‘ä¹‹å‰ï¼Œä½ æ— æ³•å†ä¸»åŠ¨å‘èµ·å¯¹è¯ï¼Œä¹Ÿæ— æ³•å›žåº”ã€‚]",
          timestamp: Date.now() + 1,
          isHidden: true
        };
        a.history.push(b);
        await Gb.chats.put(a);
        document.getElementById("chat-settings-modal").classList.remove("visible");
        cd(v.activeChatId);
        _c();
      }
    });
    document.getElementById("chat-lock-overlay").addEventListener("click", async a => {
      const b = v.chats[v.activeChatId];
      if (!b) {
        return;
      }
      if (a.target.id === "force-apply-check-btn") {
        alert("æ­£åœ¨æ‰‹åŠ¨è§¦å‘å¥½å‹ç”³è¯·æµç¨‹ï¼Œè¯·ç¨åŽ...\nå¦‚æžœAPIè°ƒç”¨æˆåŠŸï¼Œå°†å¼¹å‡ºæç¤ºã€‚å¦‚æžœå¤±è´¥ï¼Œä¹Ÿä¼šæœ‰é”™è¯¯æç¤ºã€‚å¦‚æžœé•¿æ—¶é—´æ— ååº”ï¼Œè¯´æ˜ŽAIå¯èƒ½å†³å®šæš‚æ—¶ä¸ç”³è¯·ã€‚");
        await pg(b.id);
        cd(b.id);
        return;
      }
      if (a.target.id === "unblock-btn") {
        b.relationship.status = "friend";
        b.relationship.blockedTimestamp = null;
        const a = {
          role: "system",
          content: "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšè§£é™¤äº†å¯¹ä½ çš„æ‹‰é»‘ã€‚çŽ°åœ¨ä½ ä»¬å¯ä»¥é‡æ–°å¼€å§‹å¯¹è¯äº†ã€‚]",
          timestamp: Date.now(),
          isHidden: true
        };
        b.history.push(a);
        await Gb.chats.put(b);
        cd(b.id);
        _c();
        Td();
      } else if (a.target.id === "accept-friend-btn") {
        const a = b.relationship.applicationReason || "ï¼ˆå¯¹æ–¹æ²¡æœ‰ç•™ä¸‹ç†ç”±ï¼Œä½†æˆ‘ä»¬å’Œå¥½äº†ï¼‰";
        b.relationship.status = "friend";
        b.relationship.applicationReason = "";
        const c = {
          role: "system",
          type: "pat_message",
          content: "ä½ é€šè¿‡äº†â€œ" + b.name + "â€çš„å¥½å‹è¯·æ±‚",
          timestamp: Date.now()
        };
        b.history.push(c);
        const d = {
          role: "assistant",
          senderName: b.name,
          content: a,
          timestamp: Date.now() + 1
        };
        b.history.push(d);
        await Gb.chats.put(b);
        cd(b.id);
        _c();
      } else if (a.target.id === "reject-friend-btn") {
        b.relationship.status = "blocked_by_user";
        b.relationship.blockedTimestamp = Date.now();
        b.relationship.applicationReason = "";
        await Gb.chats.put(b);
        cd(b.id);
      } else if (a.target.id === "apply-friend-btn") {
        const a = await Db("å‘é€å¥½å‹ç”³è¯·", "è¯·è¾“å…¥ä½ æƒ³å¯¹â€œ" + b.name + "â€è¯´çš„ç”³è¯·ç†ç”±ï¼š", "æˆ‘ä»¬å’Œå¥½å§ï¼");
        if (a !== null) {
          b.relationship.status = "pending_ai_approval";
          b.relationship.applicationReason = a;
          await Gb.chats.put(b);
          cd(b.id);
          _c();
          Td();
        }
      }
    });
    document.getElementById("transfer-btn").addEventListener("click", qg);
    document.getElementById("cancel-red-packet-btn").addEventListener("click", () => {
      document.getElementById("red-packet-modal").classList.remove("visible");
    });
    document.getElementById("send-group-packet-btn").addEventListener("click", sg);
    document.getElementById("send-direct-packet-btn").addEventListener("click", tg);
    const $a = document.getElementById("rp-tab-group");
    const ab = document.getElementById("rp-tab-direct");
    const bb = document.getElementById("rp-content-group");
    const cb = document.getElementById("rp-content-direct");
    $a.addEventListener("click", () => {
      $a.classList.add("active");
      ab.classList.remove("active");
      bb.style.display = "block";
      cb.style.display = "none";
    });
    ab.addEventListener("click", () => {
      ab.classList.add("active");
      $a.classList.remove("active");
      cb.style.display = "block";
      bb.style.display = "none";
    });
    document.getElementById("rp-group-amount").addEventListener("input", a => {
      const b = parseFloat(a.target.value) || 0;
      document.getElementById("rp-group-total").textContent = "Â¥ " + b.toFixed(2);
    });
    document.getElementById("rp-direct-amount").addEventListener("input", a => {
      const b = parseFloat(a.target.value) || 0;
      document.getElementById("rp-direct-total").textContent = "Â¥ " + b.toFixed(2);
    });
    document.getElementById("send-poll-btn").addEventListener("click", yg);
    document.getElementById("add-poll-option-btn").addEventListener("click", zg);
    document.getElementById("cancel-create-poll-btn").addEventListener("click", () => {
      document.getElementById("create-poll-modal").classList.remove("visible");
    });
    document.getElementById("confirm-create-poll-btn").addEventListener("click", Ag);
    document.getElementById("chat-messages").addEventListener("click", a => {
      const b = a.target.closest(".poll-card");
      if (!b) {
        return;
      }
      const c = parseInt(b.dataset.pollTimestamp);
      if (isNaN(c)) {
        return;
      }
      const d = a.target.closest(".poll-option-item");
      if (d && !b.classList.contains("closed")) {
        Bg(c, d.dataset.option);
        return;
      }
      const e = a.target.closest(".poll-action-btn");
      if (e) {
        if (b.classList.contains("closed")) {
          Dg(c);
        } else {
          Cg(c);
        }
        return;
      }
      if (b.classList.contains("closed")) {
        Dg(c);
      }
    });
    document.getElementById("manage-ai-avatar-library-btn").addEventListener("click", Eg);
    document.getElementById("add-ai-avatar-batch-btn").addEventListener("click", () => Sg("ai"));
    document.getElementById("add-group-avatar-batch-btn").addEventListener("click", () => Sg("group"));
    document.getElementById("add-ai-avatar-url-btn").addEventListener("click", Gg);
    document.getElementById("add-ai-avatar-upload-btn").addEventListener("click", () => {
      document.getElementById("ai-avatar-upload-input").click();
    });
    document.getElementById("ai-avatar-upload-input").addEventListener("change", ob);
    document.getElementById("close-ai-avatar-library-btn").addEventListener("click", Hg);
    document.getElementById("manage-group-avatar-library-btn").addEventListener("click", Og);
    document.getElementById("add-group-avatar-url-btn").addEventListener("click", Ug);
    document.getElementById("add-group-avatar-upload-btn").addEventListener("click", () => {
      document.getElementById("group-avatar-upload-input").click();
    });
    document.getElementById("group-avatar-upload-input").addEventListener("change", nb);
    document.getElementById("close-group-avatar-library-btn").addEventListener("click", Rg);
    document.getElementById("icon-settings-grid").addEventListener("click", a => {
      if (a.target.classList.contains("change-icon-btn")) {
        const b = a.target.closest(".icon-setting-item");
        const c = b.dataset.iconId;
        if (c) {
          Hm(c, "ephone", b);
        }
      }
    });
    document.getElementById("chat-messages").addEventListener("click", a => {
      const b = a.target.closest(".link-share-card");
      if (b) {
        const a = parseInt(b.dataset.timestamp);
        if (!isNaN(a)) {
          _g(a);
        }
      }
    });
    document.getElementById("browser-back-btn").addEventListener("click", () => {
      Kb("chat-interface-screen");
    });
    S.panelEl.addEventListener("click", async a => {
      const b = a.target.closest(".sticker-item");
      if (b && S.activePostId !== null) {
        const a = b.style.backgroundImage.slice(5, -2);
        const c = v.userStickers.find(b => b.url === a);
        if (c) {
          await Wb(S.activePostId, c);
        } else {
          console.warn("åœ¨åŠ¨æ€è¯„è®ºåŒºç‚¹å‡»äº†è¡¨æƒ…ï¼Œä½†åœ¨è¡¨æƒ…åº“ä¸­æœªæ‰¾åˆ°å¯¹è±¡:", a);
        }
      }
    });
    document.addEventListener("click", a => {
      if (S.isOpen && !S.panelEl.contains(a.target) && !a.target.closest(".comment-sticker-btn")) {
        Vb();
      }
    });
    document.getElementById("share-link-btn").addEventListener("click", bh);
    document.getElementById("cancel-share-link-btn").addEventListener("click", () => {
      document.getElementById("share-link-modal").classList.remove("visible");
    });
    document.getElementById("confirm-share-link-btn").addEventListener("click", ch);
    document.getElementById("theme-toggle-switch").addEventListener("change", ih);
    document.getElementById("detach-status-bar-switch").addEventListener("change", a => {
      fh(a.target.checked);
    });
    document.getElementById("phone-frame-toggle-switch").addEventListener("change", a => {
      eh(a.target.checked);
    });
    document.getElementById("share-location-btn").addEventListener("click", Xd);
    document.getElementById("chat-list-title").addEventListener("click", Ch);
    document.getElementById("call-history-back-btn").addEventListener("click", () => {
      Kb("chat-list-screen");
    });
    document.getElementById("call-history-list").addEventListener("click", a => {
      const b = a.target.closest(".call-record-card");
      if (b && b.dataset.recordId) {
        Eh(parseInt(b.dataset.recordId));
      }
    });
    document.getElementById("close-call-transcript-btn").addEventListener("click", () => {
      document.getElementById("call-transcript-modal").classList.remove("visible");
    });
    document.getElementById("chat-header-status").addEventListener("click", Fh);
    document.getElementById("selection-share-btn").addEventListener("click", () => {
      if (ca.size > 0) {
        Gh();
      }
    });
    document.getElementById("selection-screenshot-btn").addEventListener("click", ri);
    document.getElementById("confirm-share-target-btn").addEventListener("click", async () => {
      const a = v.chats[v.activeChatId];
      const b = Array.from(document.querySelectorAll(".share-target-checkbox:checked")).map(a => a.dataset.chatId);
      if (b.length === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ†äº«çš„èŠå¤©ã€‚");
        return;
      }
      const c = [];
      const d = [...ca].sort((a, b) => a - b);
      for (const b of d) {
        const d = a.history.find(a => a.timestamp === b);
        if (d) {
          c.push(d);
        }
      }
      const e = {
        role: "user",
        senderName: a.isGroup ? a.settings.myNickname || "æˆ‘" : "æˆ‘",
        type: "share_card",
        timestamp: Date.now(),
        payload: {
          sourceChatName: a.name,
          title: "æ¥è‡ªâ€œ" + a.name + "â€çš„èŠå¤©è®°å½•",
          sharedHistory: c
        }
      };
      for (const a of b) {
        const b = v.chats[a];
        if (b) {
          b.history.push(e);
          await Gb.chats.put(b);
        }
      }
      document.getElementById("share-target-modal").classList.remove("visible");
      Zd();
      await Bb("åˆ†äº«æˆåŠŸ", "èŠå¤©è®°å½•å·²æˆåŠŸåˆ†äº«åˆ° " + b.length + " ä¸ªä¼šè¯ä¸­ã€‚");
      _c();
    });
    document.getElementById("cancel-share-target-btn").addEventListener("click", () => {
      document.getElementById("share-target-modal").classList.remove("visible");
    });
    document.getElementById("chat-messages").addEventListener("click", a => {
      const b = a.target.closest(".link-share-card[data-timestamp]");
      if (b && b.closest(".message-bubble.is-link-share")) {
        const a = parseInt(b.dataset.timestamp);
        db(a);
      }
    });
    document.getElementById("close-shared-history-viewer-btn").addEventListener("click", () => {
      document.getElementById("shared-history-viewer-modal").classList.remove("visible");
    });
    async function db(a) {
      const b = v.chats[v.activeChatId];
      if (!b) {
        return;
      }
      const c = b.history.find(b => b.timestamp === a);
      if (!c) {
        console.error("æ— æ³•æ‰¾åˆ°åˆ†äº«è®°å½•:", a);
        await Bb("æŸ¥çœ‹å¤±è´¥", "æ— æ³•æ‰¾åˆ°å¯¹åº”çš„åˆ†äº«è®°å½•æˆ–è®°å½•å·²æŸåã€‚");
        return;
      }
      if (c.type === "share_link") {
        _g(a);
        return;
      }
      if (c.type === "share_card") {
        if (!c.payload || !c.payload.sharedHistory) {
          console.error("èŠå¤©è®°å½•åˆ†äº«å¡ç‰‡æ•°æ®æŸå:", c);
          await Bb("æŸ¥çœ‹å¤±è´¥", "åˆ†äº«çš„èŠå¤©è®°å½•å·²æŸåã€‚");
          return;
        }
      } else {
        console.error("æœªçŸ¥çš„åˆ†äº«å¡ç‰‡ç±»åž‹:", c.type);
        await Bb("æŸ¥çœ‹å¤±è´¥", "ä¸æ”¯æŒçš„åˆ†äº«ç±»åž‹ã€‚");
        return;
      }
      const d = document.getElementById("shared-history-viewer-modal");
      const e = document.getElementById("shared-history-viewer-title");
      const f = document.getElementById("shared-history-viewer-content");
      e.textContent = c.payload.title;
      f.innerHTML = "";
      const g = document.createDocumentFragment();
      const h = Object.values(v.chats).find(a => a.name === c.payload.sourceChatName) || b;
      for (const b of c.payload.sharedHistory) {
        const a = await Nd(b, h);
        if (a) {
          g.appendChild(a);
        }
      }
      f.appendChild(g);
      d.classList.add("visible");
    }
    T.addEventListener("timeupdate", Rh);
    T.addEventListener("pause", () => {
      if (R.isActive) {
        R.isPlaying = false;
        o.classList.remove("dynamic-island-active");
        document.getElementById("vinyl-view").classList.remove("spinning");
        fe();
      }
    });
    T.addEventListener("play", () => {
      if (R.isActive) {
        R.isPlaying = true;
        document.getElementById("vinyl-view").classList.add("spinning");
        fe();
      }
    });
    document.getElementById("playlist-body").addEventListener("click", async a => {
      const b = a.target;
      const c = b.closest(".album-art-btn");
      if (c) {
        const a = parseInt(c.dataset.index);
        if (!isNaN(a)) {
          await pe(a);
        }
        return;
      }
      const d = b.closest(".lyrics-btn");
      if (d) {
        const a = parseInt(d.dataset.index);
        if (isNaN(a)) {
          return;
        }
        await _j(a);
        return;
      }
      const e = b.closest(".delete-track-btn");
      if (e) {
        const a = parseInt(e.dataset.index);
        if (isNaN(a)) {
          return;
        }
        const b = R.playlist[a];
        const c = await wb("åˆ é™¤æ­Œæ›²", "ç¡®å®šè¦ä»Žæ’­æ”¾åˆ—è¡¨ä¸­åˆ é™¤ã€Š" + b.name + "ã€‹å—ï¼Ÿ");
        if (c) {
          re(a);
        }
        return;
      }
      const f = b.closest(".playlist-item-info");
      if (f) {
        const a = f.closest(".playlist-item");
        const b = Array.from(a.parentElement.children).indexOf(a);
        if (b > -1) {
          ne(b);
        }
      }
    });
    document.querySelector(".progress-bar").addEventListener("click", a => {
      if (!T.duration) {
        return;
      }
      const b = a.currentTarget;
      const c = b.clientWidth;
      const d = a.offsetX;
      T.currentTime = d / c * T.duration;
    });
    document.getElementById("chat-messages").addEventListener("click", a => {
      const c = a.target.closest(".email-share-card");
      if (c) {
        const a = decodeURIComponent(c.dataset.emailJson);
        try {
          const c = JSON.parse(a);
          const d = document.getElementById("custom-modal-overlay");
          const e = document.getElementById("custom-modal");
          const f = document.getElementById("custom-modal-title");
          const g = document.getElementById("custom-modal-body");
          const h = document.querySelector("#custom-modal .custom-modal-footer");
          e.style.width = "320px";
          e.style.height = "500px";
          e.style.maxHeight = "80vh";
          g.style.flex = "1";
          g.style.overflowY = "auto";
          g.style.padding = "0";
          f.textContent = "é‚®ä»¶è¯¦æƒ…";
          const i = `
                  <div style="padding: 20px; min-height: 100%; box-sizing: border-box; text-align: left;"> <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                          <div style="font-weight: 700; font-size: 18px; color: #111; line-height: 1.4; margin-bottom: 8px; word-break: break-word;">
                              ` + b(c.subject) + `
                          </div>
                          <div style="display: flex; justify-content: space-between; align-items: center; color: #8a8a8a; font-size: 13px;">
                              <span><span style="color:#666;">å‘ä»¶äºº:</span> ` + b(c.sender) + "</span>\n                              <span>" + c.date.split(" ")[0] + `</span>
                          </div>
                      </div>
                      <div style="white-space: pre-wrap; color: #333; font-size: 15px; line-height: 1.8; font-family: -apple-system, sans-serif; letter-spacing: 0.5px;">` + b(c.fullContent) + `</div>
                  </div>
              `;
          g.innerHTML = i;
          h.innerHTML = "";
          const j = document.createElement("button");
          j.textContent = "å…³é—­";
          j.style.cssText = "width: 100%; border: none; background: transparent; color: var(--accent-color); font-weight: 600; padding: 15px; font-size: 16px; cursor: pointer;";
          j.onclick = () => {
            d.classList.remove("visible");
            // TOLOOK
            setTimeout(() => {
              e.style.width = "";
              e.style.height = "";
              e.style.maxHeight = "";
              g.style.flex = "";
              g.style.overflowY = "";
              g.style.padding = "";
            }, 300);
          };
          h.appendChild(j);
          d.classList.add("visible");
        } catch (a) {
          console.error("è§£æžé‚®ä»¶æ•°æ®å¤±è´¥", a);
        }
        return;
      }
      const d = a.target.closest(".reddit-share-card");
      if (d) {
        const a = d.closest(".message-bubble");
        if (a) {
          const b = parseInt(a.dataset.timestamp);
          const c = v.chats[v.activeChatId];
          const d = c.history.find(a => a.timestamp === b);
          if (d && d.type === "reddit_share" && d.redditData) {
            ur(d.redditData);
          }
        }
        return;
      }
      const e = a.target.closest(".recalled-message-placeholder");
      if (e) {
        const a = v.chats[v.activeChatId];
        const b = e.closest(".message-wrapper");
        if (a && b) {
          const c = parseInt(b.dataset.timestamp);
          const d = a.history.find(a => a.timestamp === c);
          if (d && d.recalledData) {
            let a = "";
            const b = d.recalledData;
            switch (b.originalType) {
              case "text":
                a = "åŽŸæ–‡: \"" + b.originalContent + "\"";
                break;
              case "user_photo":
              case "ai_image":
              case "text_image":
                a = "[å›¾ç‰‡/æ–‡å­—å›¾] æè¿°: \"" + b.originalContent + "\"";
                break;
              case "voice_message":
                a = "[è¯­éŸ³] å†…å®¹: \"" + b.originalContent + "\"";
                break;
              case "sticker":
                a = "[è¡¨æƒ…] å«ä¹‰: \"" + (b.originalMeaning || "(æ— )") + "\" \n URL: " + b.originalContent;
                break;
              case "transfer":
                a = "ä¸€æ¡[è½¬è´¦]æ¶ˆæ¯å·²è¢«æ’¤å›žã€‚";
                break;
              default:
                a = "æ’¤å›žäº†ä¸€æ¡[" + b.originalType + "]ç±»åž‹çš„æ¶ˆæ¯ã€‚\nå†…å®¹: " + JSON.stringify(b.originalContent);
                break;
            }
            Bb("å·²æ’¤å›žçš„æ¶ˆæ¯", a);
          }
        }
      }
    });
    document.getElementById("manage-world-book-categories-btn").addEventListener("click", Xh);
    document.getElementById("close-category-manager-btn").addEventListener("click", () => {
      document.getElementById("world-book-category-manager-modal").classList.remove("visible");
      hd();
    });
    document.getElementById("add-new-category-btn").addEventListener("click", Zh);
    document.getElementById("existing-categories-list").addEventListener("click", a => {
      if (a.target.classList.contains("delete-group-btn")) {
        const b = parseInt(a.target.dataset.id);
        $h(b);
      }
    });
    document.getElementById("repost-cancel-btn").addEventListener("click", Yb);
    document.getElementById("repost-confirm-btn").addEventListener("click", Zb);
    document.getElementById("quote-message-btn").addEventListener("click", xh);
    document.getElementById("cancel-reply-btn").addEventListener("click", yh);
    document.getElementById("qzone-posts-list").addEventListener("input", a => {
      if (!a.target.matches(".comment-input")) {
        return;
      }
      const b = a.target;
      const c = b.closest(".qzone-post-container");
      if (!c) {
        return;
      }
      const d = c.querySelector(".at-mention-popup");
      const e = b.value;
      const f = e.match(/@([\p{L}\w]*)$/u);
      if (f) {
        const a = new Set();
        const g = c.querySelector(".post-nickname")?.textContent;
        if (g) {
          a.add(g);
        }
        c.querySelectorAll(".commenter-name").forEach(b => {
          a.add(b.textContent.replace(":", ""));
        });
        a.delete(v.qzoneSettings.nickname);
        d.innerHTML = "";
        if (a.size > 0) {
          const c = f[1];
          a.forEach(a => {
            if (a.toLowerCase().includes(c.toLowerCase())) {
              const c = document.createElement("div");
              c.className = "at-mention-item";
              c.textContent = a;
              c.addEventListener("mousedown", c => {
                c.preventDefault();
                const g = e.substring(0, f.index) + ("@" + a + " ");
                b.value = g;
                d.style.display = "none";
                b.focus();
              });
              d.appendChild(c);
            }
          });
          d.style.display = d.children.length > 0 ? "block" : "none";
        } else {
          d.style.display = "none";
        }
      } else {
        d.style.display = "none";
      }
    });
    document.getElementById("qzone-posts-list").addEventListener("focusout", a => {
      if (a.target.matches(".comment-input")) {
        const b = a.target.closest(".qzone-post-container");
        if (b) {
          const a = b.querySelector(".at-mention-popup");
          if (a) {
            // TOLOOK
            setTimeout(() => {
              a.style.display = "none";
            }, 200);
          }
        }
      }
    });
    const fb = document.getElementById("chat-input");
    const gb = document.getElementById("chat-at-mention-popup");
    fb.addEventListener("input", () => {
      if (!v.activeChatId || !v.chats[v.activeChatId].isGroup) {
        gb.style.display = "none";
        return;
      }
      const a = v.chats[v.activeChatId];
      const b = fb.value;
      const c = b.match(/@([\p{L}\w]*)$/u);
      if (c) {
        const d = a.settings.myNickname || "æˆ‘";
        const e = a.members.map(a => a.groupNickname).filter(a => a !== d);
        gb.innerHTML = "";
        if (e.length > 0) {
          const a = c[1];
          e.forEach(d => {
            if (d.toLowerCase().includes(a.toLowerCase())) {
              const a = document.createElement("div");
              a.className = "at-mention-item";
              a.textContent = d;
              a.addEventListener("mousedown", a => {
                a.preventDefault();
                const e = b.substring(0, c.index) + ("@" + d + " ");
                fb.value = e;
                gb.style.display = "none";
                fb.focus();
              });
              gb.appendChild(a);
            }
          });
          gb.style.display = gb.children.length > 0 ? "block" : "none";
        } else {
          gb.style.display = "none";
        }
      } else {
        gb.style.display = "none";
      }
    });
    fb.addEventListener("blur", () => {
      // TOLOOK
      setTimeout(() => {
        gb.style.display = "none";
      }, 200);
    });
    document.getElementById("publish-to-announcement-btn").addEventListener("click", _h);
    document.getElementById("show-announcement-board-btn").addEventListener("click", ai);
    document.getElementById("close-announcement-board-btn").addEventListener("click", () => {
      document.getElementById("announcement-board-modal").classList.remove("visible");
    });
    document.getElementById("announcement-board-content").addEventListener("click", a => {
      if (a.target.classList.contains("announcement-item-actions")) {
        const b = a.target.dataset.annoId;
        if (b) {
          s(b);
        }
      }
    });
    document.getElementById("announcement-action-pin").addEventListener("click", t);
    document.getElementById("announcement-action-delete").addEventListener("click", u);
    document.getElementById("announcement-action-cancel").addEventListener("click", () => {
      document.getElementById("announcement-actions-modal").classList.remove("visible");
    });
    document.getElementById("reset-global-css-btn").addEventListener("click", () => {
      document.getElementById("global-css-input").value = "";
    });
    document.getElementById("open-memory-screen-btn").addEventListener("click", jh);
    document.getElementById("memory-screen-back-btn").addEventListener("click", () => {
      Kb("chat-interface-screen");
    });
    document.getElementById("add-manual-memory-btn-header").addEventListener("click", mh);
    document.getElementById("summarize-recent-btn-header").addEventListener("click", ph);
    document.getElementById("memory-list-container").addEventListener("click", a => {
      const b = a.target.closest(".edit-memory-btn");
      if (b) {
        nh(b.dataset.authorId, parseInt(b.dataset.memoryTimestamp));
        return;
      }
      const c = a.target.closest(".delete-memory-btn");
      if (c) {
        oh(c.dataset.authorId, parseInt(c.dataset.memoryTimestamp));
        return;
      }
    });
    document.getElementById("gomoku-btn").addEventListener("click", Hi);
    document.getElementById("close-gomoku-btn").addEventListener("click", Ii);
    const hb = document.getElementById("gomoku-board");
    hb.addEventListener("mousemove", Mi);
    hb.addEventListener("mouseout", () => Ki(v.activeChatId));
    hb.addEventListener("click", Ni);
    document.getElementById("add-countdown-btn").addEventListener("click", () => {
      document.getElementById("countdown-title-input").value = "";
      document.getElementById("countdown-date-input").value = "";
      document.getElementById("create-countdown-modal").classList.add("visible");
    });
    document.getElementById("cancel-create-countdown-btn").addEventListener("click", () => {
      document.getElementById("create-countdown-modal").classList.remove("visible");
    });
    document.getElementById("edit-call-message-btn").addEventListener("click", fg);
    document.getElementById("delete-call-message-btn").addEventListener("click", hg);
    document.getElementById("cancel-call-message-action-btn").addEventListener("click", eg);
    document.getElementById("edit-last-response-btn").addEventListener("click", Sh);
    document.getElementById("cancel-ai-response-editor-btn").addEventListener("click", () => {
      document.getElementById("ai-response-editor-modal").classList.remove("visible");
    });
    document.getElementById("save-ai-response-editor-btn").addEventListener("click", Uh);
    document.getElementById("add-ai-response-block-btn").addEventListener("click", () => {
      const a = document.getElementById("ai-response-editor-container");
      const b = Th(`{
  "type": "text",
  "content": "åœ¨è¿™é‡Œè¾“å…¥æ–°æ¶ˆæ¯..."
}`);
      a.appendChild(b);
      b.querySelector("textarea").focus();
    });
    document.getElementById("manage-my-avatar-library-btn").addEventListener("click", Ig);
    document.getElementById("close-my-avatar-library-btn").addEventListener("click", Ng);
    document.getElementById("add-my-avatar-url-btn").addEventListener("click", Kg);
    document.getElementById("add-my-avatar-upload-btn").addEventListener("click", () => {
      document.getElementById("my-avatar-upload-input").click();
    });
    document.getElementById("my-avatar-upload-input").addEventListener("change", Lg);
    document.getElementById("add-my-avatar-batch-btn").addEventListener("click", async () => {
      const a = `è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç²˜è´´ï¼Œä¸€è¡Œä¸€ä¸ªï¼š

ç„¦è™‘ 2a9wte.jpeg
å¤§æƒŠå¤±è‰² or8qf4.png
æ²¡æœ‰çµæ„Ÿ njwujh.jpeg`;
      const b = await Db("æ‰¹é‡å¯¼å…¥å¤´åƒ", a, "", "textarea");
      if (b && b.trim()) {
        await Mg(b);
      }
    });
    document.getElementById("open-shopping-btn").addEventListener("click", Xi);
    document.getElementById("shopping-back-btn").addEventListener("click", () => Kb("chat-interface-screen"));
    document.getElementById("go-to-cart-btn").addEventListener("click", _i);
    document.getElementById("cart-back-btn").addEventListener("click", Xi);
    document.getElementById("checkout-btn").addEventListener("click", dj);
    document.getElementById("close-receipt-btn").addEventListener("click", () => {
      document.getElementById("gift-receipt-modal").classList.remove("visible");
    });
    document.getElementById("manage-products-btn").addEventListener("click", () => {
      Si = !Si;
      const a = document.getElementById("manage-products-btn");
      const b = document.getElementById("shopping-action-bar");
      const c = document.getElementById("product-grid");
      a.style.color = Si ? "var(--accent-color)" : "var(--text-primary)";
      if (Si) {
        b.style.display = "flex";
        c.style.paddingBottom = "80px";
      } else {
        b.style.display = "none";
        c.style.paddingBottom = "";
        Ba.clear();
        document.querySelectorAll(".product-item.selected").forEach(a => a.classList.remove("selected"));
        document.getElementById("delete-selected-products-btn").textContent = "åˆ é™¤ (0)";
        document.getElementById("select-all-products-checkbox").checked = false;
      }
      Ti();
      Vi();
    });
    document.getElementById("add-new-product-btn").addEventListener("click", () => {
      if (Si) {
        gj(null);
      } else {
        alert("è¯·å…ˆç‚¹å‡»æ‰³æ‰‹å›¾æ ‡è¿›å…¥ç®¡ç†æ¨¡å¼ï¼Œæ‰èƒ½æ·»åŠ æ–°å•†å“ã€‚");
      }
    });
    document.getElementById("product-grid").addEventListener("click", async a => {
      const b = a.target.closest(".product-item");
      if (!b) {
        return;
      }
      const c = parseInt(b.dataset.id);
      if (isNaN(c)) {
        return;
      }
      if (Si) {
        if (a.target.classList.contains("edit-product-btn")) {
          gj(c);
          return;
        }
        if (a.target.classList.contains("delete-product-btn")) {
          const a = await Gb.shoppingProducts.get(c);
          if (!a) {
            return;
          }
          const b = await wb("åˆ é™¤å•†å“", "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤å•†å“ â€œ" + a.name + "â€ å—ï¼Ÿ", {
            confirmButtonClass: "btn-danger"
          });
          if (b) {
            await Gb.shoppingProducts.delete(c);
            await Ti();
            alert("å•†å“å·²åˆ é™¤ã€‚");
          }
          return;
        }
        b.classList.toggle("selected");
        if (Ba.has(c)) {
          Ba.delete(c);
        } else {
          Ba.add(c);
        }
        document.getElementById("delete-selected-products-btn").textContent = "åˆ é™¤ (" + Ba.size + ")";
        return;
      }
      if (a.target.classList.contains("add-to-cart-btn")) {
        const a = await Gb.shoppingProducts.get(c);
        if (a.variations && a.variations.length > 0) {
          ho(c);
        } else {
          await Yi(c);
          await Bb("æˆåŠŸ", "å·²æˆåŠŸåŠ å…¥è´­ç‰©è½¦ï¼");
        }
        return;
      }
      if (b.contains(a.target)) {
        console.log("ç‚¹å‡»äº†å•†å“å¡ç‰‡: " + c);
      }
    });
    document.getElementById("cart-items-list").addEventListener("click", a => {
      const b = a.target;
      if (b.classList.contains("decrease-qty-btn")) {
        Zi(parseInt(b.dataset.id), -1);
      }
      if (b.classList.contains("increase-qty-btn")) {
        Zi(parseInt(b.dataset.id), 1);
      }
      if (b.classList.contains("cart-item-checkbox")) {
        bj();
      }
    });
    document.getElementById("clear-cart-btn").addEventListener("click", async () => {
      if (ya.length === 0) {
        return;
      }
      const a = await wb("æ¸…ç©ºè´­ç‰©è½¦", "ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦ä¸­çš„æ‰€æœ‰å•†å“å—ï¼Ÿ");
      if (a) {
        ya = [];
        $i();
        aj();
      }
    });
    document.getElementById("select-all-cart-items").addEventListener("change", function (a) {
      document.querySelectorAll(".cart-item-checkbox").forEach(b => {
        b.checked = a.target.checked;
      });
      bj();
    });
    document.getElementById("cancel-product-editor-btn").addEventListener("click", () => {
      document.getElementById("product-editor-modal").classList.remove("visible");
    });
    document.getElementById("save-product-btn").addEventListener("click", hj);
    document.getElementById("product-image-input").addEventListener("change", a => {
      const b = a.target.files[0];
      if (b) {
        const a = new FileReader();
        a.onload = a => {
          document.getElementById("product-image-preview").src = a.target.result;
        };
        a.readAsDataURL(b);
      }
    });
    document.getElementById("chat-messages").addEventListener("click", a => {
      const b = a.target.closest(".gift-card");
      if (b) {
        const a = b.closest(".message-bubble");
        if (a) {
          fj(parseInt(a.dataset.timestamp));
        }
      }
    });
    document.getElementById("cancel-gift-recipient-btn").addEventListener("click", () => {
      document.getElementById("gift-recipient-modal").classList.remove("visible");
    });
    document.getElementById("confirm-gift-recipient-btn").addEventListener("click", async () => {
      const a = Array.from(document.querySelectorAll("#gift-recipient-list .contact-picker-item.selected")).map(a => a.dataset.recipientName);
      if (a.length === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä½æ”¶ç¤¼äººã€‚");
        return;
      }
      const b = ya.filter(a => document.querySelector(".cart-item-checkbox[data-id=\"" + a.productId + "\"]:checked"));
      await ej(b, a);
      document.getElementById("gift-recipient-modal").classList.remove("visible");
    });
    document.getElementById("gift-recipient-list").addEventListener("click", a => {
      const b = a.target.closest(".contact-picker-item");
      if (b) {
        b.classList.toggle("selected");
      }
    });
    document.getElementById("select-all-recipients").addEventListener("change", function (a) {
      const b = a.target.checked;
      document.querySelectorAll("#gift-recipient-list .contact-picker-item").forEach(a => {
        a.classList.toggle("selected", b);
      });
    });
    document.getElementById("regenerate-btn").addEventListener("click", Dj);
    document.getElementById("regenerate-call-btn").addEventListener("click", Ej);
    document.getElementById("propel-btn").addEventListener("click", Fj);
    document.getElementById("test-sound-btn").addEventListener("click", () => {
      const a = document.getElementById("notification-sound-player");
      const b = document.getElementById("notification-sound-url-input").value.trim() || Ta;
      a.src = b;
      a.play().catch(a => alert("æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®æˆ–æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯¥æ ¼å¼ã€‚"));
    });
    document.getElementById("reset-sound-btn").addEventListener("click", () => {
      document.getElementById("notification-sound-url-input").value = "";
      alert("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºéŸ³ï¼Œç‚¹å‡»â€œä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®â€åŽç”Ÿæ•ˆã€‚");
    });
    document.getElementById("home-screen").addEventListener("click", a => {
      const b = a.target;
      if (b.classList.contains("editable-text")) {
        Jj(b);
      }
      if (b.classList.contains("editable-image")) {
        Kj(b);
      }
    });
    document.getElementById("add-song-search-btn").addEventListener("click", Yj);
    document.getElementById("cancel-music-search-btn").addEventListener("click", () => {
      document.getElementById("music-search-results-modal").classList.remove("visible");
    });
    document.getElementById("add-song-search-btn").addEventListener("click", Yj);
    document.getElementById("cancel-music-search-btn").addEventListener("click", () => {
      document.getElementById("music-search-results-modal").classList.remove("visible");
    });
    document.getElementById("select-all-music-search").addEventListener("change", function (a) {
      document.querySelectorAll("#search-results-list .music-search-checkbox").forEach(b => {
        b.checked = a.target.checked;
      });
    });
    document.getElementById("search-results-list").addEventListener("click", a => {
      const b = a.target.closest(".search-result-item");
      if (b) {
        const c = b.querySelector(".music-search-checkbox");
        if (c && a.target !== c) {
          c.checked = !c.checked;
        }
      }
    });
    document.getElementById("add-selected-music-btn").addEventListener("click", async () => {
      const a = document.querySelectorAll(".music-search-checkbox:checked");
      if (a.length === 0) {
        alert("è¯·å…ˆé€‰æ‹©è¦æ·»åŠ çš„æ­Œæ›²ã€‚");
        return;
      }
      document.getElementById("music-search-results-modal").classList.remove("visible");
      await Bb("è¯·ç¨å€™...", "æ­£åœ¨æ‰¹é‡æ·»åŠ  " + a.length + " é¦–æ­Œæ›²...");
      const b = Array.from(a).map(a => JSON.parse(a.closest(".search-result-item").dataset.songJson));
      let c = 0;
      let d = [];
      const e = b.map(a => Zj(a));
      const f = await Promise.all(e);
      f.forEach((a, e) => {
        if (a) {
          R.playlist.push(a);
          c++;
        } else {
          d.push(b[e].name);
        }
      });
      if (c > 0) {
        await nc();
        he();
        if (R.currentIndex === -1) {
          R.currentIndex = R.playlist.length - c;
          fe();
        }
      }
      let g = `æ·»åŠ å®Œæˆï¼

æˆåŠŸæ·»åŠ  ` + c + " é¦–æ­Œæ›²ã€‚";
      if (d.length > 0) {
        g += `

` + d.length + " é¦–æ­Œæ›²èŽ·å–å¤±è´¥:\n- " + d.join("\n- ");
      }
      await Bb("æ“ä½œç»“æžœ", g);
    });
    document.getElementById("music-visual-container").addEventListener("click", () => {
      document.getElementById("music-visual-container").classList.toggle("lyrics-active");
    });
    document.getElementById("add-song-search-btn").addEventListener("click", Yj);
    document.getElementById("cancel-music-search-btn").addEventListener("click", () => {
      document.getElementById("music-search-results-modal").classList.remove("visible");
    });
    document.getElementById("search-results-list").addEventListener("click", a => {
      const b = a.target.closest(".search-result-item");
      if (b && b.dataset.songJson) {
        const a = JSON.parse(b.dataset.songJson);
        handleSearchResultClick(a);
      }
    });
    document.getElementById("cleanup-songs-btn").addEventListener("click", dk);
    document.getElementById("toggle-blur-btn").addEventListener("click", ak);
    document.getElementById("toggle-fullscreen-btn").addEventListener("click", ck);
    document.getElementById("show-avatars-btn").addEventListener("click", bk);
    document.getElementById("status-bar-toggle-switch").addEventListener("change", () => {
      v.globalSettings.showStatusBar = document.getElementById("status-bar-toggle-switch").checked;
      fk();
    });
    document.getElementById("qzone-more-actions-btn").addEventListener("click", gk);
    document.getElementById("cancel-clear-posts-btn").addEventListener("click", () => {
      document.getElementById("clear-posts-modal").classList.remove("visible");
    });
    document.getElementById("confirm-clear-posts-btn").addEventListener("click", hk);
    document.getElementById("clear-posts-list").addEventListener("click", a => {
      const b = a.target.closest(".clear-posts-item");
      if (b) {
        b.classList.toggle("selected");
      }
    });
    document.getElementById("global-bg-input").addEventListener("change", async a => {
      const b = a.target.files[0];
      if (b) {
        const a = await new Promise(a => {
          const c = new FileReader();
          c.onload = () => a(c.result);
          c.readAsDataURL(b);
        });
        v.globalSettings.globalChatBackground = a;
        ed();
        await Bb("æˆåŠŸ", `å…¨å±€èŠå¤©èƒŒæ™¯å·²æ›´æ–°ï¼

å›¾ç‰‡å°†åœ¨åŽå°é™é»˜ä¸Šä¼ åˆ°å›¾åºŠ... (ä¿å­˜è®¾ç½®åŽç”Ÿæ•ˆ)`);
        (async () => {
          await K(Gb.globalSettings, "main", "globalChatBackground", a);
        })();
      }
      a.target.value = null;
    });
    document.getElementById("remove-global-bg-btn").addEventListener("click", () => {
      v.globalSettings.globalChatBackground = "";
      ed();
    });
    document.getElementById("save-wallpaper-btn").addEventListener("click", async () => {
      if (W) {
        v.globalSettings.wallpaper = W;
      }
      v.globalSettings.globalCss = document.getElementById("global-css-input").value.trim();
      v.globalSettings.notificationSoundUrl = document.getElementById("notification-sound-url-input").value.trim();
      v.globalSettings.showStatusBar = document.getElementById("status-bar-toggle-switch").checked;
      v.globalSettings.lockScreenEnabled = document.getElementById("lock-screen-toggle").checked;
      v.globalSettings.lockScreenPassword = document.getElementById("lock-screen-password-input").value.trim();
      const a = document.getElementById("lock-wallpaper-preview");
      if (a.dataset.tempUrl) {
        v.globalSettings.lockScreenWallpaper = a.dataset.tempUrl;
      }
      await Gb.globalSettings.put(v.globalSettings);
      fd();
      W = null;
      Zg();
      pi(v.globalSettings.globalCss);
      fk();
      bp();
      alert("å¤–è§‚è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼");
      Kb("home-screen");
    });
    document.getElementById("upload-global-bg-url-btn").addEventListener("click", async () => {
      const a = await Db("ç½‘ç»œå›¾ç‰‡", "è¯·è¾“å…¥èƒŒæ™¯å›¾ç‰‡çš„URL", "", "url");
      if (a && a.trim()) {
        v.globalSettings.globalChatBackground = a.trim();
        ed();
      } else if (a !== null) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„URLã€‚");
      }
    });
    document.getElementById("upload-ephone-bg-url-btn").addEventListener("click", async () => {
      const a = await Db("ç½‘ç»œå›¾ç‰‡ (EPhone)", "è¯·è¾“å…¥EPhoneä¸»å±å¹•çš„èƒŒæ™¯å›¾ç‰‡URL", "", "url");
      if (a && a.trim()) {
        W = a.trim();
        ed();
      } else if (a !== null) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„URLã€‚");
      }
    });
    document.getElementById("upload-cphone-bg-url-btn").addEventListener("click", async () => {
      const a = await Db("ç½‘ç»œå›¾ç‰‡ (CPhone)", "è¯·è¾“å…¥CPhoneçš„èƒŒæ™¯å›¾ç‰‡URL", "", "url");
      if (a && a.trim()) {
        v.globalSettings.cphoneWallpaper = a.trim();
        ed();
      } else if (a !== null) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„URLã€‚");
      }
    });
    document.getElementById("remove-ephone-bg-btn").addEventListener("click", () => {
      W = null;
      v.globalSettings.wallpaper = "";
      ed();
    });
    document.getElementById("remove-cphone-bg-btn").addEventListener("click", () => {
      v.globalSettings.cphoneWallpaper = "";
      ed();
    });
    document.getElementById("css-preset-select").addEventListener("change", kk);
    document.getElementById("save-css-preset-btn").addEventListener("click", lk);
    document.getElementById("delete-css-preset-btn").addEventListener("click", mk);
    document.getElementById("font-preset-select").addEventListener("change", ok);
    document.getElementById("save-font-preset-btn").addEventListener("click", pk);
    document.getElementById("delete-font-preset-btn").addEventListener("click", qk);
    document.getElementById("theme-preset-select").addEventListener("change", wk);
    document.getElementById("save-theme-preset-btn").addEventListener("click", xk);
    document.getElementById("delete-theme-preset-btn").addEventListener("click", yk);
    document.getElementById("manage-sticker-categories-btn").addEventListener("click", zk);
    document.getElementById("close-sticker-category-manager-btn").addEventListener("click", () => {
      document.getElementById("sticker-category-manager-modal").classList.remove("visible");
      kd();
    });
    document.getElementById("add-new-sticker-category-btn").addEventListener("click", Bk);
    document.getElementById("existing-sticker-categories-list").addEventListener("click", a => {
      if (a.target.classList.contains("delete-group-btn")) {
        const b = parseInt(a.target.dataset.id);
        Ck(b);
      }
    });
    document.getElementById("sticker-category-tabs").addEventListener("click", a => {
      if (a.target.classList.contains("sticker-category-tab")) {
        const b = a.target.dataset.categoryId;
        const c = b !== "all" && b !== "uncategorized" ? parseInt(b) : b;
        Dk(c);
      }
    });
    document.getElementById("select-all-stickers-checkbox").addEventListener("change", Cd);
    document.getElementById("export-single-chat-btn").addEventListener("click", Ek);
    document.getElementById("import-single-chat-btn").addEventListener("click", () => {
      document.getElementById("import-single-chat-input").click();
    });
    document.getElementById("import-single-chat-input").addEventListener("change", a => {
      const b = a.target.files[0];
      if (b) {
        Fk(b);
      }
      a.target.value = null;
    });
    document.getElementById("add-char-memo-btn").addEventListener("click", () => Xk());
    document.getElementById("add-char-diary-btn").addEventListener("click", () => openDiaryEditor());
    document.getElementById("favorite-diary-btn").addEventListener("click", bl);
    document.getElementById("favorite-article-btn").addEventListener("click", nl);
    document.getElementById("favorite-memo-btn").addEventListener("click", cl);
    document.getElementById("copy-diary-content-btn").addEventListener("click", () => {
      const a = document.getElementById("char-diary-detail-content").innerText;
      Cb(a, "æ—¥è®°å†…å®¹å·²å¤åˆ¶ï¼");
    });
    document.getElementById("copy-memo-content-btn").addEventListener("click", () => {
      const a = document.getElementById("char-memo-detail-content").value;
      Cb(a, "å¤‡å¿˜å½•å†…å®¹å·²å¤åˆ¶ï¼");
    });
    document.getElementById("copy-article-content-btn").addEventListener("click", () => {
      const a = document.getElementById("char-article-content").innerText;
      Cb(a, "æ–‡ç« å†…å®¹å·²å¤åˆ¶ï¼");
    });
    document.getElementById("regenerate-char-qq-btn").addEventListener("click", async () => {
      Bb("æ­£åœ¨æ‰§è¡Œ...", "æ­£åœ¨ç”Ÿæˆæ–°çš„æ¨¡æ‹ŸèŠå¤©è®°å½•ï¼Œå¹¶åŒæ—¶è®©è§’è‰²æ€è€ƒå¦‚ä½•ä¸Žä½ ç»§ç»­å¯¹è¯...");
      try {
        await Promise.all([fl(), gl()]);
        console.log("CPhone QQæ¨¡æ‹Ÿè®°å½•ç”Ÿæˆ å’Œ ä¸»èŠå¤©æŽ¨è¿› å·²åŒæ—¶å®Œæˆã€‚");
      } catch (a) {
        console.error("åœ¨åŒæ—¶æ‰§è¡Œä¸¤ä¸ªå‡½æ•°æ—¶å‡ºé”™:", a);
        await Bb("æ“ä½œå¤±è´¥", "åœ¨æ‰§è¡Œç»„åˆæ“ä½œæ—¶é‡åˆ°é”™è¯¯: " + a.message);
      }
    });
    document.getElementById("char-chat-list").addEventListener("click", a => {
      const b = a.target.closest(".chat-list-item");
      if (b && b.dataset.conversationIndex) {
        const a = parseInt(b.dataset.conversationIndex);
        if (!isNaN(a)) {
          il(a);
        }
      }
    });
    document.getElementById("back-to-char-qq-list-btn").addEventListener("click", () => {
      Lk("char-qq-screen");
    });
    const ib = document.getElementById("char-conversation-messages");
    const jb = () => {
      if (_ !== "private_user") {
        return;
      }
      if (ib.scrollTop < 1 && !aa) {
        const a = v.chats[ra]?.history.length || 0;
        if (a > $) {
          hl();
        }
      }
    };
    ib.addEventListener("scroll", jb);
    document.getElementById("char-simulated-send-btn").addEventListener("click", () => {
      alert("è¿™æ˜¯æ¨¡æ‹Ÿå¯¹è¯ï¼Œæ— æ³•å‘é€æ¶ˆæ¯å“¦~");
    });
    document.getElementById("regenerate-char-album-btn").addEventListener("click", kl);
    document.getElementById("char-album-grid").addEventListener("click", a => {
      const b = a.target.closest(".char-photo-item");
      if (b && b.dataset.description) {
        const a = b.dataset.description;
        Bb("ç…§ç‰‡è¯¦æƒ…", a.replace(/\n/g, "<br>"));
      }
    });
    document.getElementById("regenerate-char-browser-btn").addEventListener("click", ll);
    document.getElementById("regenerate-char-taobao-btn").addEventListener("click", pl);
    document.getElementById("char-product-grid").addEventListener("click", a => {
      const b = a.target.closest(".char-product-item");
      if (b && b.dataset.reason) {
        const a = b.dataset.reason;
        Bb("TAçš„æƒ³æ³•...", a.replace(/\n/g, "<br>"));
      }
    });
    window.openCharWallet = ql;
    document.getElementById("regenerate-char-memo-btn").addEventListener("click", sl);
    document.getElementById("char-memo-detail-back-btn").addEventListener("click", () => Lk("char-memo-screen"));
    document.getElementById("regenerate-char-diary-btn").addEventListener("click", Zk);
    document.getElementById("add-char-diary-btn").addEventListener("click", $k);
    document.getElementById("char-diary-detail-back-btn").addEventListener("click", () => Lk("char-diary-screen"));
    document.getElementById("regenerate-char-amap-btn").addEventListener("click", tl);
    document.getElementById("regenerate-char-usage-btn").addEventListener("click", vl);
    document.getElementById("regenerate-char-music-btn").addEventListener("click", yl);
    document.getElementById("close-char-music-player-btn").addEventListener("click", El);
    document.getElementById("regenerate-douban-btn").addEventListener("click", Nl);
    document.getElementById("regenerate-douban-btn").addEventListener("click", Nl);
    document.getElementById("douban-detail-back-btn").addEventListener("click", () => Kb("douban-screen"));
    document.getElementById("douban-send-comment-btn").addEventListener("click", Pl);
    document.getElementById("douban-wait-reply-btn").addEventListener("click", Ql);
    document.getElementById("cphone-wallpaper-upload-input").addEventListener("change", async a => {
      const b = a.target.files[0];
      if (b) {
        const a = await new Promise(a => {
          const c = new FileReader();
          c.onload = () => a(c.result);
          c.readAsDataURL(b);
        });
        v.globalSettings.cphoneWallpaper = a;
        ed();
        await Bb("æˆåŠŸ", `CPhone å£çº¸å·²æ›´æ–°ï¼

å›¾ç‰‡å°†åœ¨åŽå°é™é»˜ä¸Šä¼ åˆ°å›¾åºŠ... (ä¿å­˜è®¾ç½®åŽç”Ÿæ•ˆ)`);
        (async () => {
          await K(Gb.globalSettings, "main", "cphoneWallpaper", a);
        })();
      }
      a.target.value = null;
    });
    document.getElementById("cphone-icon-settings-grid").addEventListener("click", a => {
      if (a.target.classList.contains("change-icon-btn")) {
        const b = a.target.closest(".icon-setting-item");
        const c = b.dataset.iconId;
        if (c) {
          Hm(c, "cphone", b);
        }
      }
    });
    document.getElementById("import-appearance-btn").addEventListener("click", () => {
      document.getElementById("import-appearance-input").click();
    });
    document.getElementById("import-appearance-input").addEventListener("change", a => {
      const b = a.target.files[0];
      if (b) {
        Tl(b);
      }
      a.target.value = null;
    });
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        localStorage.setItem("ephoneLastActiveTimestamp", Date.now());
        console.log("åº”ç”¨å·²åˆ‡æ¢åˆ°åŽå°ï¼Œè®°å½•å½“å‰æ—¶é—´ã€‚");
      }
    });
    document.getElementById("export-world-book-btn").addEventListener("click", d);
    document.getElementById("import-world-book-btn").addEventListener("click", () => {
      document.getElementById("import-world-book-input").click();
    });
    document.getElementById("import-world-book-input").addEventListener("change", b => {
      const c = b.target.files[0];
      if (c) {
        a(c);
      }
      b.target.value = null;
    });
    document.getElementById("enable-ai-drawing-switch").addEventListener("change", async a => {
      const b = a.target.checked;
      v.globalSettings.enableAiDrawing = b;
      await Gb.globalSettings.put(v.globalSettings);
      const c = document.querySelector(".screen.active");
      if (c) {
        switch (c.id) {
          case "chat-interface-screen":
            cd(v.activeChatId);
            break;
          case "chat-list-screen":
            if (document.getElementById("qzone-screen").classList.contains("active")) {
              Sb();
            }
            if (document.getElementById("favorites-view").classList.contains("active")) {
              _b();
            }
            break;
          case "douban-screen":
            Ml();
            break;
          case "douban-post-detail-screen":
            Ol(Fa);
            break;
          case "character-phone-screen":
            const a = document.querySelector(".char-screen.active");
            if (a) {
              switch (a.id) {
                case "char-album-screen":
                  Nk();
                  break;
                case "char-taobao-screen":
                  Pk();
                  break;
                case "char-browser-article-screen":
                  const a = v.chats[ra];
                  const b = a.simulatedBrowserHistory || [];
                  const c = b.length > 0 ? b.length - 1 : 0;
                  ol(b[c]);
                  break;
                case "char-usage-screen":
                  Tk();
                  break;
                case "char-qq-screen":
                  el();
                  break;
                case "char-qq-conversation-screen":
                  const d = document.querySelector("#char-chat-list .chat-list-item")?.dataset.conversationIndex || 0;
                  il(parseInt(d));
                  break;
              }
            }
            break;
        }
      }
      Bb("è®¾ç½®å·²åº”ç”¨", "AIç”Ÿå›¾åŠŸèƒ½å·²" + (b ? "å¼€å¯" : "å…³é—­") + "ã€‚");
    });
    document.getElementById("search-history-btn").addEventListener("click", Wl);
    document.getElementById("search-history-back-btn").addEventListener("click", () => {
      Kb("chat-settings-screen");
    });
    document.getElementById("execute-search-btn").addEventListener("click", Xl);
    document.getElementById("clear-search-btn").addEventListener("click", $l);
    document.getElementById("upload-custom-frame-btn").addEventListener("click", _l);
    document.getElementById("batch-import-frames-btn").addEventListener("click", am);
    document.querySelector("#avatar-frame-modal .modal-body").addEventListener("click", a => {
      if (a.target.classList.contains("delete-btn")) {
        const b = parseInt(a.target.dataset.id);
        if (!isNaN(b)) {
          bm(b);
        }
      }
    });
    em();
    window.openPresetScreen = gm;
    document.getElementById("add-preset-btn").addEventListener("click", async () => {
      const a = await Db("åˆ›å»ºæ–°é¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°");
      if (a && a.trim()) {
        const b = {
          id: "preset_" + Date.now(),
          name: a.trim(),
          content: []
        };
        await Gb.presets.add(b);
        await hm();
        jm(b.id);
      }
    });
    document.getElementById("manage-preset-categories-btn").addEventListener("click", lm);
    document.getElementById("add-preset-entry-btn").addEventListener("click", () => {
      const a = document.getElementById("preset-entries-container");
      if (a.querySelector("p")) {
        a.innerHTML = "";
      }
      const b = km();
      a.appendChild(b);
      b.querySelector(".entry-content-textarea").focus();
    });
    document.getElementById("save-preset-btn").addEventListener("click", async () => {
      if (!fm) {
        return;
      }
      const a = await Gb.presets.get(fm);
      if (!a) {
        return;
      }
      const b = document.getElementById("preset-name-input").value.trim();
      if (!b) {
        alert("é¢„è®¾åç§°ä¸èƒ½ä¸ºç©ºï¼");
        return;
      }
      a.name = b;
      a.categoryId = parseInt(document.getElementById("preset-category-select").value) || null;
      const c = document.getElementById("preset-entries-container");
      const d = c.querySelectorAll(".message-editor-block");
      const e = [];
      d.forEach(a => {
        const b = a.querySelector(".entry-content-textarea").value.trim();
        if (b) {
          e.push({
            comment: a.querySelector(".entry-comment-input").value.trim(),
            keys: (a.querySelector(".entry-keys-input").value.trim() || "").split(",").map(a => a.trim()).filter(Boolean),
            content: b,
            enabled: a.querySelector(".entry-enabled-switch").checked
          });
        }
      });
      a.content = e;
      await Gb.presets.put(a);
      fm = null;
      Kb("preset-screen");
      await hm();
    });
    document.getElementById("import-preset-btn").addEventListener("click", async () => {
      try {
        await i();
        document.getElementById("import-preset-input").click();
      } catch (a) {
        console.warn("é¢„è®¾å¯¼å…¥è¢«å–æ¶ˆ:", a.message);
      }
    });
    document.getElementById("import-preset-input").addEventListener("change", pm);
    document.getElementById("reset-button-order-btn").addEventListener("click", ym);
    document.getElementById("clear-specific-data-btn").addEventListener("click", Bm);
    document.getElementById("cancel-clear-wizard-btn-step1").addEventListener("click", () => {
      document.getElementById("data-clear-wizard-modal").classList.remove("visible");
    });
    document.getElementById("go-to-clear-step2-btn").addEventListener("click", Em);
    document.getElementById("back-to-clear-step1-btn").addEventListener("click", Fm);
    document.getElementById("cancel-clear-wizard-btn-step2").addEventListener("click", () => {
      document.getElementById("data-clear-wizard-modal").classList.remove("visible");
    });
    document.getElementById("confirm-final-clear-btn").addEventListener("click", Gm);
    document.getElementById("data-clear-wizard-modal").addEventListener("click", a => {
      const b = a.target.closest(".clear-posts-item");
      if (b) {
        a.stopPropagation();
        b.classList.toggle("selected");
      }
    });
    document.getElementById("data-clear-wizard-modal").addEventListener("change", a => {
      if (a.target.id === "select-all-chars-for-clear") {
        const b = a.target.checked;
        document.querySelectorAll("#data-clear-char-list .clear-posts-item").forEach(a => {
          a.classList.toggle("selected", b);
        });
      } else if (a.target.id === "select-all-types-for-clear") {
        const b = a.target.checked;
        document.querySelectorAll("#data-clear-type-list .clear-posts-item").forEach(a => {
          a.classList.toggle("selected", b);
        });
      }
    });
    document.getElementById("compress-images-btn").addEventListener("click", Im);
    document.getElementById("copy-message-btn").addEventListener("click", hf);
    document.getElementById("copy-timestamp-btn").addEventListener("click", jf);
    document.getElementById("npc-list-back-btn").addEventListener("click", () => {
      Lb("messages-view");
    });
    document.getElementById("add-npc-btn").addEventListener("click", () => Rc(null));
    document.getElementById("save-npc-btn").addEventListener("click", Sc);
    document.getElementById("npc-editor-modal").addEventListener("click", a => {
      if (a.target.id === "manage-npc-groups-btn") {
        Tc();
      }
    });
    document.getElementById("close-npc-group-manager-btn").addEventListener("click", () => {
      document.getElementById("npc-group-manager-modal").classList.remove("visible");
      if (document.getElementById("npc-editor-modal").classList.contains("visible")) {
        Rc(w);
      }
    });
    document.getElementById("add-new-npc-group-btn").addEventListener("click", Vc);
    document.getElementById("existing-npc-groups-list").addEventListener("click", a => {
      if (a.target.classList.contains("delete-group-btn")) {
        Wc(parseInt(a.target.dataset.id));
      }
    });
    document.getElementById("cancel-npc-editor-btn").addEventListener("click", () => {
      document.getElementById("npc-editor-modal").classList.remove("visible");
    });
    document.getElementById("npc-avatar-input").addEventListener("change", a => {
      const b = a.target.files[0];
      if (b) {
        const a = new FileReader();
        a.onload = a => {
          document.getElementById("npc-avatar-preview").src = a.target.result;
        };
        a.readAsDataURL(b);
      }
    });
    document.getElementById("chat-lock-overlay").addEventListener("click", a => {
      if (a.target.id === "spectator-reroll-btn") {
        zj();
      } else if (a.target.id === "spectator-edit-btn") {
        Sh();
      }
    });
    _d(document.getElementById("music-visual-container"), () => {
      if (R.currentIndex > -1) {
        pe(R.currentIndex);
      }
    });
    document.getElementById("douban-settings-btn").addEventListener("click", Rm);
    document.getElementById("save-douban-settings-btn").addEventListener("click", Sm);
    document.getElementById("cancel-douban-settings-btn").addEventListener("click", () => {
      document.getElementById("douban-settings-modal").classList.remove("visible");
    });
    document.getElementById("time-zone-search-input").addEventListener("input", a => {
      const b = a.target.value.toLowerCase();
      const c = document.getElementById("time-zone-select");
      for (const d of c.options) {
        const a = d.textContent.toLowerCase();
        if (a.includes(b)) {
          d.style.display = "";
        } else {
          d.style.display = "none";
        }
      }
    });
    window.openWerewolfLobby = Tm;
    document.getElementById("werewolf-game-btn").addEventListener("click", () => Tm("group"));
    document.getElementById("cancel-werewolf-lobby-btn").addEventListener("click", () => {
      document.getElementById("werewolf-lobby-modal").classList.remove("visible");
    });
    document.getElementById("start-werewolf-game-btn").addEventListener("click", Um);
    document.getElementById("werewolf-role-confirm-btn").addEventListener("click", () => {
      document.getElementById("werewolf-role-modal").classList.remove("visible");
      Xm();
    });
    document.getElementById("exit-werewolf-game-btn").addEventListener("click", async () => {
      const a = await wb("é€€å‡ºæ¸¸æˆ", "ç¡®å®šè¦é€€å‡ºå½“å‰è¿™å±€ç‹¼äººæ€å—ï¼Ÿæ¸¸æˆè¿›åº¦å°†ä¸ä¼šè¢«ä¿å­˜ã€‚", {
        confirmButtonClass: "btn-danger"
      });
      if (a) {
        L.isActive = false;
        Kb(L.chatId ? "chat-interface-screen" : "home-screen");
      }
    });
    document.getElementById("werewolf-game-over-close-btn").addEventListener("click", () => {
      document.getElementById("werewolf-game-over-modal").classList.remove("visible");
      Kb(L.chatId ? "chat-list-screen" : "home-screen");
    });
    document.getElementById("cancel-wolf-kill-btn").addEventListener("click", () => {
      document.getElementById("werewolf-kill-modal").classList.remove("visible");
    });
    document.getElementById("cancel-werewolf-lobby-btn").addEventListener("click", () => {
      document.getElementById("werewolf-lobby-modal").classList.remove("visible");
    });
    document.getElementById("werewolf-retry-btn").addEventListener("click", qn);
    document.getElementById("manual-werewolf-summary-btn").addEventListener("click", bn);
    document.getElementById("check-and-fix-data-btn").addEventListener("click", sn);
    const kb = document.getElementById("emergency-reset-appearance-btn");
    if (kb) {
      kb.addEventListener("click", or);
    }
    const pb = document.getElementById("factory-reset-btn");
    if (pb) {
      pb.addEventListener("click", pr);
    }
    document.getElementById("dynamic-island-music-toggle-switch").addEventListener("change", a => {
      const b = a.target.checked;
      v.globalSettings.alwaysShowMusicIsland = b;
      const c = document.body.classList.contains("frame-mode-active");
      if (R.isActive && !c) {
        const a = document.getElementById("global-lyrics-bar");
        const c = document.getElementById("phone-screen");
        if (b) {
          a.classList.remove("visible");
          c.classList.add("dynamic-island-active");
        } else {
          c.classList.remove("dynamic-island-active");
          if (R.parsedLyrics && R.parsedLyrics.length > 0) {
            a.classList.add("visible");
          }
        }
      }
    });
    document.getElementById("delete-world-books-btn").addEventListener("click", vn);
    document.getElementById("cancel-delete-world-books-btn").addEventListener("click", () => {
      document.getElementById("delete-world-books-modal").classList.remove("visible");
    });
    document.getElementById("confirm-delete-world-books-btn").addEventListener("click", wn);
    document.getElementById("delete-world-books-modal").addEventListener("click", a => {
      const b = a.target.closest(".clear-posts-item");
      if (b) {
        b.classList.toggle("selected");
      }
      if (a.target.id === "select-all-world-books-for-clear") {
        const b = a.target.checked;
        document.querySelectorAll("#delete-world-books-list .clear-posts-item").forEach(a => {
          a.classList.toggle("selected", b);
        });
      }
    });
    document.getElementById("sticker-search-input").addEventListener("input", () => {
      kd(false);
    });
    document.getElementById("sticker-category-tabs").addEventListener("click", a => {
      if (a.target.classList.contains("sticker-category-tab")) {
        const b = a.target.dataset.categoryId;
        const c = b !== "all" && b !== "uncategorized" ? parseInt(b) : b;
        document.getElementById("sticker-search-input").value = "";
        Dk(c);
      }
    });
    const sb = document.getElementById("chat-messages");
    sb.addEventListener("scroll", () => {
      if (sb.scrollTop < 1 && !ia) {
        const a = v.chats[v.activeChatId]?.history.length || 0;
        if (a > _a) {
          dd();
        }
      }
    });
    const vb = document.getElementById("thoughts-history-list");
    vb.addEventListener("scroll", () => {
      const {
        scrollTop: a,
        scrollHeight: b,
        clientHeight: c
      } = vb;
      if (b - a <= c + 50 && !ja) {
        const a = v.chats[v.activeChatId]?.thoughtsHistory.length || 0;
        if (a > M) {
          zi();
        }
      }
    });
    const xb = document.querySelector("#qzone-screen .qzone-content");
    xb.addEventListener("scroll", () => {
      const {
        scrollTop: a,
        scrollHeight: b,
        clientHeight: c
      } = xb;
      if (b - a <= c + 100 && !ka && Q.length > O) {
        Tb();
      }
    });
    const yb = document.getElementById("nai-gallery-grid-local");
    const zb = document.getElementById("nai-gallery-grid-cloud");
    const Ab = a => {
      const b = a.currentTarget;
      const c = b.id.includes("local") ? "local" : "cloud";
      if (c !== ud) {
        return;
      }
      const {
        scrollTop: d,
        scrollHeight: e,
        clientHeight: f
      } = b;
      if (e - d <= f + 100 && !td[c] && rd[c].length > sd[c]) {
        Ao();
      }
    };
    if (yb) {
      yb.addEventListener("scroll", Ab);
    }
    if (zb) {
      zb.addEventListener("scroll", Ab);
    }
    document.getElementById("read-together-btn").addEventListener("click", xn);
    const Fb = document.getElementById("reading-restore-btn");
    Qn(Fb, Fb);
    document.getElementById("close-reading-btn").addEventListener("click", zn);
    document.getElementById("open-reading-library-btn").addEventListener("click", In);
    document.getElementById("next-page-btn").addEventListener("click", Bn);
    document.getElementById("prev-page-btn").addEventListener("click", Cn);
    document.getElementById("book-upload-input").addEventListener("change", Fn);
    document.getElementById("minimize-reading-btn").addEventListener("click", Rn);
    document.getElementById("reading-restore-btn").addEventListener("click", Sn);
    Qn(document.getElementById("reading-window"), document.querySelector("#reading-window .reading-header"));
    document.getElementById("open-reading-library-btn").addEventListener("click", In);
    document.getElementById("close-reading-library-btn-header").addEventListener("click", () => {
      document.getElementById("reading-library-modal").classList.remove("visible");
    });
    document.getElementById("import-new-book-btn-header").addEventListener("click", Dn);
    document.getElementById("reading-library-list").addEventListener("click", a => {
      const b = a.target;
      if (b.classList.contains("group-name")) {
        const a = parseInt(b.dataset.bookId);
        Kn(a);
      } else if (b.classList.contains("delete-group-btn")) {
        const a = parseInt(b.dataset.bookId);
        On(a);
      }
    });
    document.getElementById("page-indicator").addEventListener("click", Gn);
    document.getElementById("reading-library-search-input").addEventListener("input", a => {
      Jn(a.target.value);
    });
    const Hb = Tn(Vn, 300);
    document.getElementById("reading-content").addEventListener("scroll", Hb);
    document.getElementById("api-temperature-slider").addEventListener("input", a => {
      document.getElementById("api-temperature-value").textContent = a.target.value;
    });
    const Ib = document.getElementById("messages-view");
    Ib.addEventListener("scroll", () => {
      const {
        scrollTop: a,
        scrollHeight: b,
        clientHeight: c
      } = Ib;
      if (b - a <= c + 150 && !ha) {
        $c();
      }
    });
    document.getElementById("manage-product-categories-btn").addEventListener("click", bo);
    document.getElementById("close-product-category-manager-btn").addEventListener("click", () => {
      document.getElementById("product-category-manager-modal").classList.remove("visible");
      gj(za);
    });
    document.getElementById("add-new-product-category-btn").addEventListener("click", eo);
    document.getElementById("existing-product-categories-list").addEventListener("click", a => {
      if (a.target.classList.contains("delete-group-btn")) {
        fo(parseInt(a.target.dataset.id));
      }
    });
    document.getElementById("add-product-variation-btn").addEventListener("click", () => go());
    document.getElementById("cancel-variation-selection-btn").addEventListener("click", () => {
      document.getElementById("variation-selection-modal").classList.remove("visible");
    });
    document.getElementById("variation-decrease-qty").addEventListener("click", () => {
      const a = document.getElementById("variation-quantity-display");
      let b = parseInt(a.textContent);
      if (b > 1) {
        a.textContent = b - 1;
      }
    });
    document.getElementById("variation-increase-qty").addEventListener("click", () => {
      const a = document.getElementById("variation-quantity-display");
      a.textContent = parseInt(a.textContent) + 1;
    });
    document.getElementById("product-category-tabs").addEventListener("click", a => {
      if (a.target.classList.contains("product-category-tab")) {
        const b = a.target.dataset.categoryId === "all" ? "all" : parseInt(a.target.dataset.categoryId);
        Ui(b);
      }
    });
    document.getElementById("generate-shopping-items-btn").addEventListener("click", ko);
    document.getElementById("shopping-settings-btn").addEventListener("click", io);
    document.getElementById("save-shopping-settings-btn").addEventListener("click", jo);
    document.getElementById("cancel-shopping-settings-btn").addEventListener("click", () => {
      document.getElementById("shopping-settings-modal").classList.remove("visible");
    });
    document.getElementById("select-all-products-checkbox").addEventListener("change", a => {
      const b = a.target.checked;
      const c = document.querySelectorAll("#product-grid .product-item");
      c.forEach(a => {
        const c = parseInt(a.dataset.id);
        a.classList.toggle("selected", b);
        if (b) {
          Ba.add(c);
        } else {
          Ba.delete(c);
        }
      });
      document.getElementById("delete-selected-products-btn").textContent = "åˆ é™¤ (" + Ba.size + ")";
    });
    document.getElementById("delete-selected-products-btn").addEventListener("click", async () => {
      if (Ba.size === 0) {
        alert("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å•†å“ã€‚");
        return;
      }
      const a = await wb("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ " + Ba.size + " ä¸ªå•†å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", {
        confirmButtonClass: "btn-danger"
      });
      if (a) {
        await Gb.shoppingProducts.bulkDelete([...Ba]);
        document.getElementById("manage-products-btn").click();
        await Ti();
        await Bb("æˆåŠŸ", "é€‰ä¸­çš„å•†å“å·²æˆåŠŸåˆ é™¤ã€‚");
      }
    });
    document.getElementById("appearance-preset-select").addEventListener("change", sk);
    document.getElementById("save-appearance-preset-btn").addEventListener("click", tk);
    document.getElementById("delete-appearance-preset-btn").addEventListener("click", uk);
    document.getElementById("novelai-switch").addEventListener("change", a => {
      const b = document.getElementById("novelai-details");
      b.style.display = a.target.checked ? "block" : "none";
    });
    document.getElementById("novelai-key-toggle").addEventListener("click", function () {
      const a = document.getElementById("novelai-api-key");
      if (a.type === "password") {
        a.type = "text";
        this.textContent = "ðŸ˜Œ";
      } else {
        a.type = "password";
        this.textContent = "ðŸ§";
      }
    });
    document.getElementById("novelai-settings-btn").addEventListener("click", () => {
      Ac();
      document.getElementById("novelai-settings-modal").style.display = "flex";
    });
    document.getElementById("nai-cors-proxy").addEventListener("change", a => {
      const b = document.getElementById("nai-custom-proxy-group");
      if (a.target.value === "custom") {
        b.style.display = "block";
      } else {
        b.style.display = "none";
      }
    });
    document.getElementById("close-novelai-settings").addEventListener("click", () => {
      document.getElementById("novelai-settings-modal").style.display = "none";
    });
    document.getElementById("save-nai-settings-btn").addEventListener("click", () => {
      Bc();
      document.getElementById("novelai-settings-modal").style.display = "none";
      alert("NovelAIè®¾ç½®å·²ä¿å­˜ï¼");
    });
    document.getElementById("reset-nai-settings-btn").addEventListener("click", () => {
      if (confirm("ç¡®å®šè¦æ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿ")) {
        Cc();
      }
    });
    document.getElementById("novelai-test-btn").addEventListener("click", () => {
      const a = document.getElementById("novelai-api-key").value.trim();
      if (!a) {
        alert("è¯·å…ˆå¡«å†™NovelAI API Keyï¼");
        return;
      }
      document.getElementById("novelai-test-modal").style.display = "flex";
      document.getElementById("nai-test-result").style.display = "none";
      document.getElementById("nai-test-error").style.display = "none";
    });
    document.getElementById("close-novelai-test").addEventListener("click", () => {
      document.getElementById("novelai-test-modal").style.display = "none";
    });
    document.getElementById("close-nai-test-btn").addEventListener("click", () => {
      document.getElementById("novelai-test-modal").style.display = "none";
    });
    document.getElementById("nai-generate-btn").addEventListener("click", async () => {
      await Gc();
    });
    document.getElementById("nai-download-btn").addEventListener("click", () => {
      const a = document.getElementById("nai-result-image");
      const b = document.createElement("a");
      b.href = a.src;
      b.download = "novelai-generated-" + Date.now() + ".png";
      b.click();
    });
    document.getElementById("character-nai-prompts-btn").addEventListener("click", () => {
      if (!v.activeChatId) {
        return;
      }
      const a = v.chats[v.activeChatId];
      const b = a.settings.naiSettings || {
        promptSource: "system",
        characterPositivePrompt: "",
        characterNegativePrompt: ""
      };
      document.getElementById("character-nai-positive").value = b.characterPositivePrompt || "";
      document.getElementById("character-nai-negative").value = b.characterNegativePrompt || "";
      document.getElementById("character-nai-prompts-modal").style.display = "flex";
    });
    document.getElementById("close-character-nai-prompts").addEventListener("click", () => {
      document.getElementById("character-nai-prompts-modal").style.display = "none";
    });
    document.getElementById("save-character-nai-prompts-btn").addEventListener("click", async () => {
      if (!v.activeChatId) {
        return;
      }
      const a = v.chats[v.activeChatId];
      if (!a.settings.naiSettings) {
        a.settings.naiSettings = {
          promptSource: "system"
        };
      }
      a.settings.naiSettings.characterPositivePrompt = document.getElementById("character-nai-positive").value.trim();
      a.settings.naiSettings.characterNegativePrompt = document.getElementById("character-nai-negative").value.trim();
      console.log("ðŸ’¾ [ä¸“å±žå¼¹çª—] ä¿å­˜è§’è‰²NAIæç¤ºè¯");
      console.log("   characterPositivePrompt:", a.settings.naiSettings.characterPositivePrompt);
      console.log("   characterNegativePrompt:", a.settings.naiSettings.characterNegativePrompt);
      console.log("   promptSource:", a.settings.naiSettings.promptSource);
      await Gb.chats.put(a);
      document.getElementById("character-nai-prompts-modal").style.display = "none";
      alert("è§’è‰²ä¸“å±žNAIæç¤ºè¯å·²ä¿å­˜ï¼");
    });
    document.getElementById("reset-character-nai-prompts-btn").addEventListener("click", () => {
      if (confirm("ç¡®å®šè¦æ¸…ç©ºå½“å‰è§’è‰²çš„NAIæç¤ºè¯é…ç½®å—ï¼Ÿ")) {
        document.getElementById("character-nai-positive").value = "";
        document.getElementById("character-nai-negative").value = "";
      }
    });
    document.getElementById("group-character-nai-prompts-btn").addEventListener("click", () => {
      if (!v.activeChatId) {
        return;
      }
      const a = v.chats[v.activeChatId];
      const b = a.settings.naiSettings || {
        promptSource: "system",
        characterPositivePrompt: "",
        characterNegativePrompt: ""
      };
      document.getElementById("character-nai-positive").value = b.characterPositivePrompt || "";
      document.getElementById("character-nai-negative").value = b.characterNegativePrompt || "";
      document.getElementById("character-nai-prompts-modal").style.display = "flex";
    });
    document.getElementById("manage-frames-btn").addEventListener("click", li);
    document.getElementById("select-all-frames-checkbox").addEventListener("change", ni);
    document.getElementById("delete-selected-frames-btn").addEventListener("click", oi);
    document.getElementById("delete-current-category-btn").addEventListener("click", Wi);
    document.getElementById("char-wallet-back-btn").addEventListener("click", () => {
      Lk("char-taobao-screen");
    });
    document.getElementById("sticker-binding-chat-list").addEventListener("click", a => {
      const b = a.target.closest(".contact-picker-item");
      if (b) {
        const c = b.querySelector(".sticker-binding-checkbox");
        if (c && a.target !== c) {
          c.checked = !c.checked;
        }
      }
    });
    const Jb = document.getElementById("sticker-category-tabs");
    _d(Jb, a => {
      const b = a.target.closest(".sticker-category-tab");
      if (b) {
        a.preventDefault();
        const c = b.dataset.categoryId;
        if (c === "all") {
          Bb("æç¤º", "â€œå…¨éƒ¨â€åˆ†ç±»æ— æ³•è¢«ç»‘å®šã€‚");
          return;
        }
        const d = c === "uncategorized" ? "uncategorized" : parseInt(c);
        qo(d);
      }
    });
    document.getElementById("open-nai-gallery-btn").addEventListener("click", xo);
    document.getElementById("nai-gallery-tabs").addEventListener("click", a => {
      const b = a.target.closest(".nai-gallery-tab");
      if (b && !b.classList.contains("active")) {
        yo(b.dataset.tabId);
      }
    });
    document.getElementById("close-nai-gallery-btn").addEventListener("click", () => {
      document.getElementById("nai-gallery-panel").classList.remove("visible");
    });
    document.getElementById("manage-nai-gallery-btn").addEventListener("click", Bo);
    document.getElementById("nai-gallery-grid-local").addEventListener("click", a => {
      Eo(a);
    });
    document.getElementById("nai-gallery-grid-cloud").addEventListener("click", a => {
      Eo(a);
    });
    document.getElementById("select-all-nai-gallery-checkbox").addEventListener("change", a => {
      const b = a.target.checked;
      const c = "nai-gallery-grid-" + ud;
      document.querySelectorAll("#" + c + " .nai-gallery-item").forEach(a => {
        a.classList.toggle("selected", b);
        const c = a.dataset.key;
        if (b) {
          qd.add(c);
        } else {
          qd.delete(c);
        }
      });
      Co();
    });
    document.getElementById("download-selected-nai-gallery-btn").addEventListener("click", () => Fo());
    document.getElementById("upload-selected-nai-gallery-btn").addEventListener("click", () => Ho());
    document.getElementById("export-selected-nai-gallery-btn").addEventListener("click", () => Do());
    document.getElementById("delete-selected-nai-gallery-btn").addEventListener("click", () => Go());
    document.getElementById("delete-selected-nai-gallery-btn").addEventListener("click", () => Go());
    document.getElementById("chat-expand-btn").addEventListener("click", () => {
      document.body.classList.toggle("chat-actions-expanded");
    });
    document.getElementById("profile-edit-btn").addEventListener("click", ui);
    document.getElementById("open-quick-reply-btn").addEventListener("click", Io);
    document.getElementById("cancel-quick-reply-btn").addEventListener("click", () => {
      document.getElementById("quick-reply-modal").classList.remove("visible");
    });
    document.getElementById("add-quick-reply-btn").addEventListener("click", Ro);
    document.getElementById("minimize-char-music-btn").addEventListener("click", Cl);
    document.getElementById("char-music-restore-btn").addEventListener("click", Dl);
    Qn(document.getElementById("char-music-restore-btn"), document.getElementById("char-music-restore-btn"));
    document.getElementById("imgbb-enable-switch").addEventListener("change", a => {
      document.getElementById("imgbb-settings-details").style.display = a.target.checked ? "block" : "none";
    });
    document.getElementById("imgbb-key-toggle").addEventListener("click", function () {
      const a = document.getElementById("imgbb-api-key");
      if (a.type === "password") {
        a.type = "text";
        this.textContent = "ðŸ˜Œ";
      } else {
        a.type = "password";
        this.textContent = "ðŸ§";
      }
    });
    document.getElementById("catbox-enable-switch").addEventListener("change", a => {
      document.getElementById("catbox-settings-details").style.display = a.target.checked ? "block" : "none";
    });
    document.getElementById("catbox-key-toggle").addEventListener("click", function () {
      const a = document.getElementById("catbox-userhash");
      if (a.type === "password") {
        a.type = "text";
        this.textContent = "ðŸ˜Œ";
      } else {
        a.type = "password";
        this.textContent = "ðŸ§";
      }
    });
    const Mb = document.getElementById("char-bilibili-search-btn");
    if (Mb) {
      Mb.addEventListener("click", Zo);
      console.log("Bç«™æœç´¢æŒ‰é’®å·²ç»‘å®š");
    } else {
      console.error("æ‰¾ä¸åˆ°Bç«™æœç´¢æŒ‰é’® (char-bilibili-search-btn)ï¼Œè¯·æ£€æŸ¥HTML ID");
    }
    const Pb = document.getElementById("regenerate-char-bilibili-btn");
    if (Pb) {
      Pb.addEventListener("click", wl);
    }
    const Qb = document.getElementById("char-bilibili-search-input");
    if (Qb) {
      Qb.addEventListener("keypress", a => {
        if (a.key === "Enter") {
          Zo();
        }
      });
    }
    const cc = document.getElementById("github-enable-switch");
    if (cc) {
      cc.addEventListener("change", a => {
        document.getElementById("github-settings-details").style.display = a.target.checked ? "block" : "none";
      });
    }
    const dc = document.getElementById("github-upload-btn");
    if (dc) {
      dc.addEventListener("click", () => qp(false));
    }
    const fc = document.getElementById("github-download-btn");
    if (fc) {
      fc.addEventListener("click", rp);
    }
    const gc = document.getElementById("github-token-toggle");
    if (gc) {
      gc.addEventListener("click", function () {
        const a = document.getElementById("github-token");
        if (a.type === "password") {
          a.type = "text";
          this.textContent = "ðŸ˜Œ";
        } else {
          a.type = "password";
          this.textContent = "ðŸ§";
        }
      });
    }
    document.getElementById("toggle-reading-fullscreen-btn").addEventListener("click", ek);
    document.addEventListener("DOMContentLoaded", () => {
      const a = document.getElementById("cancel-kinship-creation-btn");
      const b = document.getElementById("confirm-kinship-creation-btn");
      const c = document.getElementById("kinship-creation-modal");
      if (a) {
        a.addEventListener("click", () => {
          c.classList.remove("visible");
        });
      }
      if (b) {
        b.addEventListener("click", async () => {
          if (!Mp) {
            return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç»‘å®šå¯¹è±¡ï¼");
          }
          const a = document.getElementById("kinship-limit-input");
          const b = parseFloat(a.value);
          if (isNaN(b) || b <= 0) {
            return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é¢åº¦ï¼");
          }
          await Op(Mp, b);
          c.classList.remove("visible");
          if (v.activeChatId !== Mp) {}
        });
      }
    });
    const hc = document.getElementById("cancel-kinship-creation-btn");
    if (hc) {
      const a = hc.cloneNode(true);
      hc.parentNode.replaceChild(a, hc);
      a.addEventListener("click", () => {
        document.getElementById("kinship-creation-modal").classList.remove("visible");
      });
    }
    const ic = document.getElementById("confirm-kinship-creation-btn");
    if (ic) {
      const a = ic.cloneNode(true);
      ic.parentNode.replaceChild(a, ic);
      a.addEventListener("click", async () => {
        if (!Mp) {
          return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯¹è±¡ï¼");
        }
        const a = document.getElementById("kinship-limit-input");
        const b = parseFloat(a.value);
        if (isNaN(b) || b <= 0) {
          return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é¢åº¦ï¼ˆå¿…é¡»å¤§äºŽ0ï¼‰ï¼");
        }
        const c = document.querySelector("input[name=\"kinship-type\"]:checked");
        const d = c ? c.value : "grant";
        await Op(Mp, b, d);
        document.getElementById("kinship-creation-modal").classList.remove("visible");
        const e = d === "grant" ? "èµ é€" : "ç”³è¯·";
        await Bb(e + "æˆåŠŸ", "äº²å±žå¡" + e + "å·²å‘é€ç»™å¯¹æ–¹ã€‚");
      });
    }
    document.getElementById("char-wallet-content").addEventListener("click", async a => {
      if (a.target.classList.contains("unbind-kinship-btn")) {
        a.stopPropagation();
        const b = a.target.dataset.chatId;
        const c = await Gb.userWallet.get("main");
        const d = c?.kinshipCards?.find(a => a.chatId === b);
        if (!d) {
          alert("æœªæ‰¾åˆ°è¯¥äº²å±žå¡è®°å½•");
          return;
        }
        const e = d.type === "out" || !d.type;
        let f = "";
        let g = "";
        let h = "";
        if (e) {
          f = "æ”¶å›žäº²å±žå¡";
          g = "ç¡®å®šè¦åœæ­¢ä¸º TA ä¹°å•å—ï¼Ÿ\næ”¶å›žåŽï¼Œå¯¹æ–¹å°†æ— æ³•å†ä½¿ç”¨æ‚¨çš„é¢åº¦æ¶ˆè´¹ã€‚";
          h = "ç¡®è®¤æ”¶å›ž";
        } else {
          f = "é€€è¿˜äº²å±žå¡";
          g = "ç¡®å®šè¦è§£ç»‘è¿™å¼ äº²å±žå¡å—ï¼Ÿ\nè§£ç»‘åŽï¼Œæ‚¨å°†æ— æ³•å†ä½¿ç”¨ TA çš„é¢åº¦æ¶ˆè´¹ã€‚";
          h = "ç¡®è®¤é€€è¿˜";
        }
        const i = await wb(f, g, {
          confirmButtonClass: "btn-danger",
          confirmText: h
        });
        if (i) {
          try {
            if (c && c.kinshipCards) {
              c.kinshipCards = c.kinshipCards.filter(a => a.chatId !== b);
              await Gb.userWallet.put(c);
              await Bb("æˆåŠŸ", "äº²å±žå¡å·²è§£ç»‘ã€‚");
              rl();
              const a = v.chats[b];
              if (a) {
                let b = "";
                if (e) {
                  b = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å·²æ”¶å›žäº†ç»™ä½ çš„äº²å±žå¡é¢åº¦ï¼Œä½ æ— æ³•å†ä½¿ç”¨ä»£ä»˜åŠŸèƒ½äº†ã€‚]";
                } else {
                  b = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ä¸»åŠ¨é€€è¿˜/è§£ç»‘äº†ä½ èµ é€çš„äº²å±žå¡ï¼Œä¸å†ä½¿ç”¨ä½ çš„é’±äº†ã€‚]";
                }
                a.history.push({
                  role: "system",
                  content: b,
                  timestamp: Date.now(),
                  isHidden: true
                });
                await Gb.chats.put(a);
              }
            }
          } catch (a) {
            console.error(a);
            alert("è§£ç»‘å¤±è´¥");
          }
        }
      }
    });
    const jc = document.getElementById("alipay-screen");
    if (jc) {
      jc.addEventListener("click", async a => {
        if (a.target.classList.contains("alipay-unbind-btn")) {
          a.stopPropagation();
          const b = a.target.dataset.chatId;
          const c = v.chats[b];
          const d = c ? c.name : "è¯¥è§’è‰²";
          const e = await Gb.userWallet.get("main");
          const f = e?.kinshipCards?.find(a => a.chatId === b);
          if (!f) {
            return;
          }
          const g = f.type === "out" || !f.type;
          let h = "";
          let i = "";
          let j = "";
          if (g) {
            h = "ç»ˆæ­¢èµ äºˆ";
            i = "ç¡®å®šè¦åœæ­¢èµ äºˆâ€œ" + d + "â€äº²å±žå¡å—ï¼Ÿ\nè§£ç»‘åŽï¼Œå¯¹æ–¹å°†æ— æ³•å†ä½¿ç”¨è¯¥é¢åº¦ã€‚";
            j = "ç¡®è®¤æ”¶å›ž";
          } else {
            h = "è§£ç»‘äº²å±žå¡";
            i = "ç¡®å®šè¦è§£ç»‘â€œ" + d + "â€èµ é€çš„äº²å±žå¡å—ï¼Ÿ\nè§£ç»‘åŽï¼Œæ‚¨å°†å¤±åŽ»è¯¥æ¶ˆè´¹é¢åº¦ã€‚";
            j = "ç¡®è®¤è§£ç»‘";
          }
          const k = await wb(h, i, {
            confirmButtonClass: "btn-danger",
            confirmText: j
          });
          if (k) {
            try {
              if (e && e.kinshipCards) {
                e.kinshipCards = e.kinshipCards.filter(a => a.chatId !== b);
                await Gb.userWallet.put(e);
                await Bb("æˆåŠŸ", "å·²æˆåŠŸè§£ç»‘äº²å±žå¡ã€‚");
                Fp();
                if (c) {
                  let a = "";
                  if (g) {
                    a = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å·²åœ¨æ”¯ä»˜å®ç«¯å•æ–¹é¢æ”¶å›žäº†ç»™ä½ çš„äº²å±žå¡æŽˆæƒã€‚]";
                  } else {
                    a = "[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å·²åœ¨æ”¯ä»˜å®ç«¯ä¸»åŠ¨é€€è¿˜/è§£ç»‘äº†ä½ èµ é€çš„äº²å±žå¡ã€‚]";
                  }
                  c.history.push({
                    role: "system",
                    content: a,
                    timestamp: Date.now(),
                    isHidden: true
                  });
                  await Gb.chats.put(c);
                }
              }
            } catch (a) {
              console.error(a);
              alert("è§£ç»‘æ“ä½œå¤±è´¥");
            }
          }
        }
      });
    }
    document.getElementById("export-appearance-btn").addEventListener("click", Ul);
    const oc = document.getElementById("open-todo-list-btn");
    if (oc) {
      oc.addEventListener("click", sq);
    }
    document.getElementById("todo-list-back-btn").addEventListener("click", () => Kb("chat-interface-screen"));
    document.getElementById("todo-prev-day-btn").addEventListener("click", () => uq(-1));
    document.getElementById("todo-next-day-btn").addEventListener("click", () => uq(1));
    document.getElementById("add-todo-btn").addEventListener("click", () => zq(null));
    document.getElementById("cancel-todo-editor-btn").addEventListener("click", () => {
      document.getElementById("todo-editor-modal").classList.remove("visible");
    });
    document.getElementById("save-todo-btn").addEventListener("click", Aq);
    const pc = document.getElementById("todo-current-date-display");
    if (pc) {
      const a = document.createElement("input");
      a.type = "date";
      a.style.cssText = "position:absolute; visibility:hidden; width:0; height:0; top:0; left:0;";
      pc.parentNode.appendChild(a);
      pc.addEventListener("click", () => {
        a.value = rq(La);
        try {
          a.showPicker();
        } catch (b) {
          a.click();
        }
      });
      a.addEventListener("change", a => {
        if (a.target.value) {
          const [b, c, d] = a.target.value.split("-").map(Number);
          La = new Date(b, c - 1, d);
          tq();
          vq();
        }
      });
    }
    const qc = document.querySelectorAll(".todo-type-option");
    qc.forEach(a => {
      a.addEventListener("click", () => {
        qc.forEach(a => a.classList.remove("active"));
        a.classList.add("active");
      });
    });
    const rc = document.getElementById("memory-list-container");
    if (rc) {
      rc.addEventListener("scroll", () => {
        const {
          scrollTop: a,
          scrollHeight: b,
          clientHeight: c
        } = rc;
        if (b - a <= c + 50) {
          lh();
        }
      });
    }
    const sc = document.getElementById("todo-list-container");
    if (sc) {
      sc.addEventListener("scroll", () => {
        const {
          scrollTop: a,
          scrollHeight: b,
          clientHeight: c
        } = sc;
        if (b - a <= c + 50) {
          wq();
        }
      });
    }
    const tc = document.getElementById("mail-delete-selected-btn");
    if (tc) {
      tc.addEventListener("click", br);
    }
    const uc = document.getElementById("mail-select-all-btn");
    if (uc) {
      uc.addEventListener("click", cr);
    }
    document.getElementById("manage-rules-btn").addEventListener("click", lj);
    document.getElementById("import-rules-btn").addEventListener("click", () => {
      document.getElementById("import-rules-input").click();
    });
    document.getElementById("import-rules-input").addEventListener("change", qj);
    document.getElementById("select-all-rules-checkbox").addEventListener("change", oj);
    document.getElementById("export-selected-rules-btn").addEventListener("click", pj);
    document.getElementById("delete-selected-rules-btn").addEventListener("click", rj);
    const Dc = document.getElementById("char-reddit-search-btn");
    if (Dc) {
      Dc.addEventListener("click", () => {
        const a = document.getElementById("char-reddit-search-input").value.trim();
        tr(a);
      });
    }
    const Ec = document.getElementById("char-reddit-search-input");
    if (Ec) {
      Ec.addEventListener("keypress", a => {
        if (a.key === "Enter") {
          const b = a.target.value.trim();
          tr(b);
        }
      });
    }
    const Fc = document.getElementById("regenerate-char-reddit-btn");
    if (Fc) {
      Fc.addEventListener("click", xr);
    }
    document.getElementById("nai-preset-select").addEventListener("change", xc);
    document.getElementById("save-nai-preset-btn").addEventListener("click", () => vc(false));
    document.getElementById("update-nai-preset-btn").addEventListener("click", () => vc(true));
    document.getElementById("delete-nai-preset-btn").addEventListener("click", wc);
    document.getElementById("bind-nai-preset-btn").addEventListener("click", yc);
    document.getElementById("save-nai-binding-btn").addEventListener("click", zc);
    document.getElementById("cancel-nai-binding-btn").addEventListener("click", () => {
      document.getElementById("nai-binding-modal").classList.remove("visible");
    });
    document.getElementById("manage-quick-reply-categories-btn").addEventListener("click", So);
    document.getElementById("add-new-quick-reply-category-btn").addEventListener("click", Uo);
    document.getElementById("close-quick-reply-category-manager-btn").addEventListener("click", () => {
      document.getElementById("quick-reply-category-manager-modal").classList.remove("visible");
      Jo(true);
    });
    const Hc = document.getElementById("move-selected-stickers-btn");
    if (Hc) {
      Hc.addEventListener("click", Ed);
    }
    const Jc = document.getElementById("open-disclaimer-btn");
    if (Jc) {
      Jc.addEventListener("click", () => {
        document.getElementById("disclaimer-modal").classList.add("visible");
      });
    }
    const Kc = document.getElementById("close-disclaimer-btn");
    if (Kc) {
      Kc.addEventListener("click", () => {
        document.getElementById("disclaimer-modal").classList.remove("visible");
      });
    }
    const Lc = document.getElementById("batch-quick-reply-btn");
    if (Lc) {
      Lc.addEventListener("click", Ko);
    }
    const Qc = document.getElementById("select-all-quick-replies-checkbox");
    if (Qc) {
      Qc.addEventListener("change", No);
    }
    const Uc = document.getElementById("move-selected-quick-replies-btn");
    if (Uc) {
      Uc.addEventListener("click", Oo);
    }
    const Xc = document.getElementById("delete-selected-quick-replies-btn");
    if (Xc) {
      Xc.addEventListener("click", Po);
    }
    bp();
    Pm();
    k();
    Kb("home-screen");
  }


  (function a() {
    if (!document.getElementById("google-fonts-login")) {
      const a = document.createElement("link");
      a.id = "google-fonts-login";
      a.rel = "stylesheet";
      a.href = "https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Manrope:wght@200..800&display=swap";
      document.head.appendChild(a);
    }
  })();
  function zr() {
    if (document.getElementById("login-overlay")) {
      return;
    }
    const a = document.getElementById("phone-screen");
    if (a) {
      a.style.display = "none";
    }
    const b = "login-overlay-css";
    if (!document.getElementById(b)) {
      const a = document.createElement("style");
      a.id = b;
      a.innerHTML = `
            /* å®¹å™¨ä¸ŽèƒŒæ™¯ */
            #login-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999;
                display: flex; flex-direction: column;
                background-color: #111121; color: white;
                font-family: 'Manrope', sans-serif; overflow: hidden;
            }
            .login-bg-layer {
                position: absolute; inset: 0; z-index: 0; opacity: 0.4;
                filter: grayscale(100%); pointer-events: none;
            }
            .login-bg-img {
                width: 100%; height: 100%;
                background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAy7HDW6Sj7_PV8DuFLN7iIzQnKa-QOTeZj9ymne8KHPU5oTT2PVaBgaSmbPZVLo1Qh5ZSETw9LO1opxFPK6zklVf4GQoCT6jcMJlNkiv68eVUny606wq_xxMO9ZWeTSIBq3JjD8-szBVkVELYnzrYgi3vxXQb3-GBuVKvjgK01B4F3XgYZe6qgnbkRQS5cSfoFYGmJI-X8MvexmUvNJUYTK7lwo9mWbFKRo0d84VbFSZ29G7N0QkRUBmP4ovtv4TgyYQFkQpzcVJc");
                background-size: cover; background-position: center;
            }
            .login-bg-gradient {
                position: absolute; inset: 0;
                background: linear-gradient(to bottom, rgba(17,17,33,0.8), transparent, #111121);
            }

            /* é¡¶éƒ¨è£…é¥° */
            .login-top-bar {
                position: relative; z-index: 10; display: flex; justify-content: flex-end; padding: 24px;
            }
            .login-sys-text {
                font-size: 10px; font-weight: 700; letter-spacing: 0.3em; text-transform: uppercase; opacity: 0.6;
            }

            /* ä¸»å†…å®¹åŒº */
            .login-main {
                position: relative; z-index: 10; flex: 1; display: flex; flex-direction: column;
                justify-content: center; padding: 16px 32px 48px 32px;
            }

            /* æ ‡é¢˜ */
            .login-title-area { text-align: center; margin-bottom: 48px; }
            .login-subtitle {
                font-size: 10px; letter-spacing: 0.5em; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-bottom: 16px;
            }
            .login-title {
                font-family: 'Playfair Display', serif; font-size: 72px; font-weight: 300;
                line-height: 1; letter-spacing: -0.05em; text-transform: none; margin: 0;
            }
            .login-divider {
                width: 48px; height: 1px; background-color: rgba(255,255,255,0.3); margin: 24px auto 0 auto;
            }

            /* çŽ»ç’ƒå¡ç‰‡ */
            .login-glass-box {
                padding: 32px; border-radius: 12px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                margin: 0 auto; width: 100%; max-width: 380px;
                background: rgba(17, 17, 33, 0.85);
                backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-sizing: border-box;
            }
            .login-box-header {
                font-size: 12px; font-weight: 700; letter-spacing: 0.2em;
                text-transform: uppercase; margin-bottom: 40px; text-align: center;
            }

            /* è¾“å…¥æ¡†ç»„ */
            .login-form-group { position: relative; margin-bottom: 32px; }
            .login-label {
                display: block; font-size: 10px; font-weight: 700; letter-spacing: 0.1em;
                text-transform: uppercase; color: rgba(255,255,255,0.4); margin-bottom: 4px;
                transition: color 0.2s;
            }
            .login-form-group:focus-within .login-label { color: white; }
            
            .login-input {
                width: 100%; background: transparent;
                border: none; border-bottom: 1px solid rgba(255,255,255,0.2);
                padding: 12px 0; font-size: 14px; color: white;
                outline: none; transition: border-color 0.2s;
                border-radius: 0; /* ç§»é™¤iOSé»˜è®¤åœ†è§’ */
            }
            .login-input:focus { border-bottom-color: white; }
            .login-input::placeholder { color: rgba(255,255,255,0.1); }

            /* çœ¼ç›å›¾æ ‡ */
            .pwd-toggle {
                position: absolute; right: 0; bottom: 12px;
                color: rgba(255,255,255,0.4); cursor: pointer; transition: color 0.2s;
            }
            .pwd-toggle:hover { color: white; }
            .pwd-toggle span { font-size: 18px; }

            /* æŒ‰é’® */
            .login-btn-container { padding-top: 16px; }
            .login-btn {
                position: relative; width: 100%; display: flex; align-items: center; justify-content: center;
                background-color: white; color: black;
                padding: 16px 0; border: none; border-radius: 2px;
                font-size: 11px; font-weight: 700; letter-spacing: 0.3em; text-transform: uppercase;
                cursor: pointer; transition: all 0.2s;
            }
            .login-btn:hover { background-color: #e5e5e5; }
            .login-btn:active { transform: scale(0.98); }
            .login-btn-arrow {
                position: absolute; right: 24px; font-size: 16px; transition: transform 0.2s;
            }
            .login-btn:hover .login-btn-arrow { transform: translateX(4px); }

            /* é”™è¯¯ä¿¡æ¯ä¸Žåº•éƒ¨é“¾æŽ¥ */
            .login-error-area { margin-top: 24px; text-align: center; min-height: 20px; }
            .login-error-msg { font-size: 11px; letter-spacing: 0.05em; color: #f87171; margin: 0;}
            
            .login-footer-links { margin-top: 48px; text-align: center; }
            .login-footer-text { font-size: 12px; color: rgba(255,255,255,0.5); }
            .login-link {
                color: white; font-weight: 700; letter-spacing: 0.05em; text-decoration: none;
                border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 2px; margin-left: 4px;
                transition: border-color 0.2s;
            }
            .login-link:hover { border-bottom-color: white; }

            /* åº•éƒ¨è£…é¥° */
            .login-bottom-deco {
                position: relative; z-index: 10; display: flex; justify-content: center; padding-bottom: 32px;
            }
            .login-deco-line { width: 32px; height: 1px; background-color: white; opacity: 0.3; }
            .login-deco-icon {
                font-size: 12px; margin: 0 16px; opacity: 0.3; display: flex; align-items: center;
            }

            /* åŠ¨ç”» */
            .pulse { animation: pulse-anim 1.5s infinite; }
            @keyframes pulse-anim {
                0%, 100% { opacity: 1; } 50% { opacity: 0.5; }
            }
        `;
      document.head.appendChild(a);
    }
    const c = document.createElement("div");
    c.id = "login-overlay";
    c.innerHTML = `
        <div class="login-bg-layer">
            <div class="login-bg-img"></div>
            <div class="login-bg-gradient"></div>
        </div>

        <div class="login-top-bar">
            <div class="login-sys-text">System Ver. 4.0 / Secure</div>
        </div>

        <div class="login-main">
            <div class="login-title-area">
                <p class="login-subtitle">Virtual Communication Interface</p>
                <h1 class="login-title">EPhone</h1>
                <div class="login-divider"></div>
            </div>

            <div class="login-glass-box">
                <h2 class="login-box-header">Identity Verification</h2>
                
                <div class="login-form-group">
                    <label class="login-label">Account ID</label>
                    <input type="text" id="login-uid" class="login-input" placeholder="Enter your Discord ID" autocomplete="off" />
                </div>

                <div class="login-form-group">
                    <label class="login-label">Passcode</label>
                    <input type="password" id="login-pwd" class="login-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                    <div class="pwd-toggle" id="toggle-pwd-btn">
                        <span class="material-symbols-outlined">visibility</span>
                    </div>
                </div>

                <div class="login-btn-container">
                    <button id="btn-login-submit" class="login-btn">
                        Connect
                        <span class="material-symbols-outlined login-btn-arrow">arrow_forward</span>
                    </button>
                </div>

                <div class="login-error-area">
                    <p id="login-msg" class="login-error-msg"></p>
                </div>
            </div>

            <div class="login-footer-links">
                <p class="login-footer-text">
                    No access key? 
                    <a class="login-link" href="#" onclick="alert('è¯·åœ¨ Discord è¾“å…¥ /å°æ‰‹æœº èŽ·å–è´¦å·ï¼Œå¦‚æžœæœªå¼¹å‡ºï¼Œåˆ™è¯·æ›´æ–°Discordï¼Œè¯·ä¸è¦æš´éœ²ä½ çš„è´¦å·ä»¥åŠå¯†ç '); return false;">
                        Get from Discord
                    </a>
                </p>
            </div>
        </div>

        <div class="login-bottom-deco">
            <div style="display:flex; align-items:center;">
                <div class="login-deco-line"></div>
                <div class="login-deco-icon"><span class="material-symbols-outlined" style="font-size:12px;">auto_awesome</span></div>
                <div class="login-deco-line"></div>
            </div>
        </div>
    `;
    document.body.prepend(c);
        // æ–°å¢žï¼šé»˜è®¤å¡«å……è´¦å·å¯†ç 
    setTimeout(() => {
      document.getElementById("login-uid").value = "user";
      document.getElementById("login-pwd").value = "v50";
    }, 100);

    const d = () => {
      const a = document.getElementById("btn-login-submit");
      a.innerHTML = "<span class=\"pulse\">CONNECTING...</span>";
      // TOLOOK
      setTimeout(Ar, 300);
    };
    document.getElementById("btn-login-submit").onclick = d;
    document.getElementById("login-pwd").onkeypress = function (a) {
      if (a.key === "Enter") {
        d();
      }
    };
    document.getElementById("login-uid").onkeypress = function (a) {
      if (a.key === "Enter") {
        document.getElementById("login-pwd").focus();
      }
    };
    const e = document.getElementById("toggle-pwd-btn");
    const f = document.getElementById("login-pwd");
    e.onclick = () => {
      const a = f.getAttribute("type") === "password" ? "text" : "password";
      f.setAttribute("type", a);
      e.querySelector("span").textContent = a === "password" ? "visibility" : "visibility_off";
    };
    // TOLOOK
    setTimeout(() => document.getElementById("login-uid").focus(), 100);
  }
  async function Ar() {
    const a = document.getElementById("login-uid");
    const b = document.getElementById("login-pwd");
    const c = document.getElementById("login-msg");
    const d = document.getElementById("btn-login-submit");
    if (!a || !b) {
      console.error("æ‰¾ä¸åˆ°ç™»å½•è¾“å…¥æ¡†ï¼Œè¯·åˆ·æ–°é¡µé¢");
      return;
    }
    const e = a.value.trim();
    const f = b.value.trim();
    if (!e || !f) {
      c.textContent = "è¯·è¾“å…¥å®Œæ•´çš„è´¦å·å’Œå¯†ç ";
      c.style.color = "#ff453a";
      return;
    }
    c.textContent = "æ­£åœ¨è¿žæŽ¥æœåŠ¡å™¨éªŒè¯...";
    c.style.color = "#ffffff";
    d.disabled = true;
    d.innerHTML = "<span class=\"pulse\">VERIFYING...</span>";

//     try {
//       const a = await fetch("https://puppy-subscription-api.zeabur.app/api/verify", {
//         method: "POST",
//         headers: {
//           "Content-Type": "application/json"
//         },
//         body: JSON.stringify({
//           account: e,
//           password: f
//         })
//       });
//       const b = await a.json();
//       if (b.success) {
//         c.style.color = "#32d74b";
//         c.textContent = "éªŒè¯é€šè¿‡ï¼Œæ¬¢è¿Ž " + (b.username || "ç”¨æˆ·") + "...";
//         localStorage.setItem("ephone_saved_uid", b.user_id);
//         localStorage.setItem("ephone_username", b.username);
//         try {
//           Jb(b.user_id);
//           const a = document.getElementById("login-overlay");
//           if (a) {
//             a.style.transition = "opacity 0.5s ease";
//             a.style.opacity = "0";
//             // TOLOOK
//             setTimeout(() => a.remove(), 500);
//           }
//           const c = document.getElementById("phone-screen");
//           if (c) {
//             c.style.display = "flex";
//           }
//           yr();
//         } catch (a) {
//           console.error(a);
//           c.style.color = "#ff453a";
//           c.textContent = "åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•";
//           Br(d);
//         }
//       } else {
//         c.style.color = "#ff453a";
//         c.textContent = b.message || "è´¦å·æˆ–å¯†ç é”™è¯¯";
//         Br(d);
//       }
//     } catch (a) {
//       console.error("ç™»å½•è¯·æ±‚å¤±è´¥:", a);
//       c.style.color = "#ff453a";
//       c.textContent = "ç½‘ç»œè¿žæŽ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";
//       Br(d);
//     }
//   }
// æ¨¡æ‹ŸéªŒè¯å»¶è¿Ÿï¼ˆä½“éªŒæ›´çœŸå®žï¼‰
    setTimeout(() => {
      try {
        // ç›´æŽ¥è¿”å›žéªŒè¯æˆåŠŸï¼Œä¸è°ƒç”¨çœŸå®žAPI
        c.style.color = "#32d74b";
        c.textContent = "éªŒè¯é€šè¿‡ï¼Œæ¬¢è¿Ž " + e + "...";
        localStorage.setItem("ephone_saved_uid", e); // ç”¨è¾“å…¥çš„è´¦å·ä½œä¸ºuser_id
        localStorage.setItem("ephone_username", e);  // ç”¨è¾“å…¥çš„è´¦å·ä½œä¸ºç”¨æˆ·å
        
        Jb(e); // ä¼ å…¥è¾“å…¥çš„è´¦å·
        const loginOverlay = document.getElementById("login-overlay");
        if (loginOverlay) {
          loginOverlay.style.transition = "opacity 0.5s ease";
          loginOverlay.style.opacity = "0";
          setTimeout(() => loginOverlay.remove(), 500);
        }
        const phoneScreen = document.getElementById("phone-screen");
        if (phoneScreen) {
          phoneScreen.style.display = "flex";
        }
        yr();
      } catch (err) {
        console.error(err);
        c.style.color = "#ff453a";
        c.textContent = "åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•";
        Br(d);
      }
    }, 1000);
  }
  
  function Br(a) {
    a.disabled = false;
    a.style.background = "#ff453a";
    a.innerHTML = "Retry <span class=\"material-symbols-outlined login-btn-arrow\">refresh</span>";
    // TOLOOK
    setTimeout(() => {
      a.style.background = "#007aff";
      a.innerHTML = "Connect <span class=\"material-symbols-outlined login-btn-arrow\">arrow_forward</span>";
    }, 1500);
  }

  const Cr = localStorage.getItem("ephone_saved_uid");
  if (Cr) {
    console.log("[Auto Login] æ£€æµ‹åˆ°å·²ç™»å½•è´¦å·: " + Cr);
    try {
      Jb(Cr);
      yr();
    } catch (a) {
      console.error("è‡ªåŠ¨ç™»å½•å‡ºé”™ï¼Œé‡ç½®çŠ¶æ€:", a);
      localStorage.removeItem("ephone_saved_uid");
      zr();
    }
  } else {
    zr();
  }
  // TOLOOK
  setTimeout(() => {
    const a = document.getElementById("logout-btn");
    if (a) {
      const b = a.cloneNode(true);
      a.parentNode.replaceChild(b, a);
      b.addEventListener("click", async () => {
        if (confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
          localStorage.removeItem("ephone_saved_uid");
          localStorage.removeItem("ephone_username");
          window.location.reload();
        }
      });
    }
  }, 1000);

  let Dr = null;
  let Er = null;
  document.body.addEventListener("click", async function (a) {
    if (a.target && a.target.id === "force-keep-alive-btn") {
      const b = a.target;
      const c = document.getElementById("keep-alive-status");
      if (Dr && Dr.state === "running") {
        try {
          await Dr.suspend();
          b.textContent = "âš¡ ç‚¹å‡»æ¿€æ´»";
          b.style.backgroundColor = "#ff3b30";
          b.style.color = "white";
          if (c) {
            c.innerHTML = "ðŸ”´ å·²æš‚åœ (éŸ³é¢‘èµ„æºå·²é‡Šæ”¾)";
            c.style.color = "#999";
          }
          return;
        } catch (a) {
          console.error("åœæ­¢å¤±è´¥:", a);
        }
      }
      b.textContent = "å¯åŠ¨ä¸­...";
      b.disabled = true;
      try {
        const a = window.AudioContext || window.webkitAudioContext;
        if (!a) {
          throw new Error("æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ Web Audio API");
        }
        if (!Dr) {
          Dr = new a();
          Er = Dr.createOscillator();
          const b = Dr.createGain();
          Er.frequency.value = 0.1;
          b.gain.value = 0.001;
          Er.connect(b);
          b.connect(Dr.destination);
          Er.start();
        }
        if (Dr.state === "suspended") {
          await Dr.resume();
        }
        if (Dr.state === "running") {
          b.textContent = "ðŸŸ¢ è¿è¡Œä¸­ (ç‚¹å‡»åœæ­¢)";
          b.style.backgroundColor = "#34c759";
          b.style.color = "white";
          if (c) {
            c.innerHTML = "ðŸŸ¢ <b>å·²æ¿€æ´»</b> (å†æ¬¡ç‚¹å‡»æŒ‰é’®å¯å…³é—­)";
            c.style.color = "#34c759";
          }
          b.disabled = false;
        } else {
          throw new Error("éŸ³é¢‘çŠ¶æ€å¼‚å¸¸: " + Dr.state);
        }
      } catch (a) {
        console.error("ä¿æ´»æ¿€æ´»å¤±è´¥:", a);
        b.textContent = "é‡è¯•";
        b.disabled = false;
        b.style.backgroundColor = "#ff3b30";
        if (c) {
          c.textContent = "âŒ å¤±è´¥: " + a.message;
          c.style.color = "#ff3b30";
        }
        alert("æ¿€æ´»å¤±è´¥ã€‚\nåŽŸå› : " + a.message);
      }
    }
  });
});